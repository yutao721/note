import{_ as s,c as a,a as e,o as p}from"./app-CD1YpnS1.js";const t={};function l(i,n){return p(),a("div",null,[...n[0]||(n[0]=[e(`<h2 id="_1-创建项目" tabindex="-1"><a class="header-anchor" href="#_1-创建项目"><span>1. 创建项目</span></a></h2><ul><li>monoRepo 是将所有的模块统一的放在一个主干分支之中管理</li><li>multiRepo 将项目分化成为多个模块，并针对每一个模块单独的开辟一个Repo来进行管理</li></ul><p><img src="https://img.zhufengpeixun.com/1278ae09f1de08186e9e70fe3bb1c4d1" alt="1278ae09f1de08186e9e70fe3bb1c4d1"></p><h3 id="_1-1-lerna" tabindex="-1"><a class="header-anchor" href="#_1-1-lerna"><span>1.1 Lerna</span></a></h3><ul><li>Lerna是一个管理多个 npm 模块的工具,优化维护多包的工作流，解决多个包互相依赖，且发布需要手动维护多个包的问题</li></ul><h4 id="_1-1-1-安装" tabindex="-1"><a class="header-anchor" href="#_1-1-1-安装"><span>1.1.1 安装</span></a></h4><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text"><pre><code class="language-text"><span class="line">npm i lerna -g</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><h4 id="_1-1-2-初始化" tabindex="-1"><a class="header-anchor" href="#_1-1-2-初始化"><span>1.1.2 初始化</span></a></h4><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text"><pre><code class="language-text"><span class="line">lerna init</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><table><thead><tr><th style="text-align:left;">命令</th><th style="text-align:left;">功能</th></tr></thead><tbody><tr><td style="text-align:left;">lerna bootstrap</td><td style="text-align:left;">安装依赖</td></tr><tr><td style="text-align:left;">lerna clean</td><td style="text-align:left;">删除各个包下的node_modules</td></tr><tr><td style="text-align:left;">lerna init</td><td style="text-align:left;">创建新的lerna库</td></tr><tr><td style="text-align:left;">lerna list</td><td style="text-align:left;">查看本地包列表</td></tr><tr><td style="text-align:left;">lerna changed</td><td style="text-align:left;">显示自上次release tag以来有修改的包， 选项通 list</td></tr><tr><td style="text-align:left;">lerna diff</td><td style="text-align:left;">显示自上次release tag以来有修改的包的差异， 执行 git diff</td></tr><tr><td style="text-align:left;">lerna exec</td><td style="text-align:left;">在每个包目录下执行任意命令</td></tr><tr><td style="text-align:left;">lerna run</td><td style="text-align:left;">执行每个包package.json中的脚本命令</td></tr><tr><td style="text-align:left;">lerna add</td><td style="text-align:left;">添加一个包的版本为各个包的依赖</td></tr><tr><td style="text-align:left;">lerna import</td><td style="text-align:left;">引入package</td></tr><tr><td style="text-align:left;">lerna link</td><td style="text-align:left;">链接互相引用的库</td></tr><tr><td style="text-align:left;">lerna create</td><td style="text-align:left;">新建package</td></tr><tr><td style="text-align:left;">lerna publish</td><td style="text-align:left;">发布</td></tr></tbody></table><h4 id="_1-1-3-文件" tabindex="-1"><a class="header-anchor" href="#_1-1-3-文件"><span>1.1.3 文件</span></a></h4><h5 id="_1-1-3-1-package-json" tabindex="-1"><a class="header-anchor" href="#_1-1-3-1-package-json"><span>1.1.3.1 package.json</span></a></h5><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code class="language-javascript"><span class="line"><span class="token punctuation">{</span></span>
<span class="line">  <span class="token string-property property">&quot;name&quot;</span><span class="token operator">:</span> <span class="token string">&quot;root&quot;</span><span class="token punctuation">,</span></span>
<span class="line">  <span class="token string-property property">&quot;private&quot;</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span></span>
<span class="line">  <span class="token string-property property">&quot;devDependencies&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token string-property property">&quot;lerna&quot;</span><span class="token operator">:</span> <span class="token string">&quot;^4.0.0&quot;</span></span>
<span class="line">  <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h5 id="_1-1-3-2-lerna-json" tabindex="-1"><a class="header-anchor" href="#_1-1-3-2-lerna-json"><span>1.1.3.2 lerna.json</span></a></h5><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code class="language-javascript"><span class="line"><span class="token punctuation">{</span></span>
<span class="line">  <span class="token string-property property">&quot;packages&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span></span>
<span class="line">    <span class="token string">&quot;packages/*&quot;</span></span>
<span class="line">  <span class="token punctuation">]</span><span class="token punctuation">,</span></span>
<span class="line">  <span class="token string-property property">&quot;version&quot;</span><span class="token operator">:</span> <span class="token string">&quot;0.0.0&quot;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h5 id="_1-1-3-3-gitignore" tabindex="-1"><a class="header-anchor" href="#_1-1-3-3-gitignore"><span>1.1.3.3 .gitignore</span></a></h5><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code class="language-javascript"><span class="line">node_modules</span>
<span class="line"><span class="token punctuation">.</span>DS_Store</span>
<span class="line">design</span>
<span class="line"><span class="token operator">*</span><span class="token punctuation">.</span>log</span>
<span class="line">packages<span class="token operator">/</span>test</span>
<span class="line">dist</span>
<span class="line">temp</span>
<span class="line"><span class="token punctuation">.</span>vuerc</span>
<span class="line"><span class="token punctuation">.</span>version</span>
<span class="line"><span class="token punctuation">.</span>versions</span>
<span class="line"><span class="token punctuation">.</span>changelog</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_1-1-4-yarn-workspace" tabindex="-1"><a class="header-anchor" href="#_1-1-4-yarn-workspace"><span>1.1.4 yarn workspace</span></a></h4><ul><li>yarn workspace允许我们使用 monorepo 的形式来管理项目</li><li>在安装 node_modules 的时候它不会安装到每个子项目的 node_modules 里面，而是直接安装到根目录下面，这样每个子项目都可以读取到根目录的 node_modules</li><li>整个项目只有根目录下面会有一份 yarn.lock 文件。子项目也会被 link 到 node_modules 里面，这样就允许我们就可以直接用 import 导入对应的项目</li><li>yarn.lock文件是自动生成的,也完全Yarn来处理.yarn.lock锁定你安装的每个依赖项的版本，这可以确保你不会意外获得不良依赖</li></ul><h6 id="_1-1-4-1-package-json" tabindex="-1"><a class="header-anchor" href="#_1-1-4-1-package-json"><span>1.1.4.1 package.json</span></a></h6><p>package.json</p><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text"><pre><code class="language-text"><span class="line">{</span>
<span class="line">  &quot;name&quot;: &quot;root&quot;,</span>
<span class="line">  &quot;private&quot;: true,</span>
<span class="line">+  &quot;workspaces&quot;: [</span>
<span class="line">+    &quot;packages/*&quot;</span>
<span class="line">+  ],</span>
<span class="line">  &quot;devDependencies&quot;: {</span>
<span class="line">    &quot;lerna&quot;: &quot;^4.0.0&quot;</span>
<span class="line">  }</span>
<span class="line">}</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h6 id="_1-1-4-2-lerna-json" tabindex="-1"><a class="header-anchor" href="#_1-1-4-2-lerna-json"><span>1.1.4.2 lerna.json</span></a></h6><p>lerna.json</p><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text"><pre><code class="language-text"><span class="line">{</span>
<span class="line">  &quot;packages&quot;: [</span>
<span class="line">    &quot;packages/*&quot;</span>
<span class="line">  ],</span>
<span class="line">  &quot;version&quot;: &quot;1.0.0&quot;,</span>
<span class="line">+ &quot;useWorkspaces&quot;: true,</span>
<span class="line">+ &quot;npmClient&quot;: &quot;yarn&quot;</span>
<span class="line">}</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h6 id="_1-1-4-3-添加依赖" tabindex="-1"><a class="header-anchor" href="#_1-1-4-3-添加依赖"><span>1.1.4.3 添加依赖</span></a></h6><ul><li><a href="https://classic.yarnpkg.com/en/docs/cli" target="_blank" rel="noopener noreferrer">yarnpkg</a></li><li>[lerna](https://github.com/lerna/lerna</li></ul><p>设置加速镜像</p><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code class="language-javascript"><span class="line">yarn config <span class="token keyword">set</span> registry http<span class="token operator">:</span><span class="token operator">/</span><span class="token operator">/</span>registry<span class="token punctuation">.</span>npm<span class="token punctuation">.</span>taobao<span class="token punctuation">.</span>org</span>
<span class="line"> npm config <span class="token keyword">set</span> registry https<span class="token operator">:</span><span class="token operator">/</span><span class="token operator">/</span>registry<span class="token punctuation">.</span>npm<span class="token punctuation">.</span>taobao<span class="token punctuation">.</span>org</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div></div></div><table><thead><tr><th style="text-align:left;">作用</th><th style="text-align:left;">命令</th></tr></thead><tbody><tr><td style="text-align:left;">查看工作空间信息</td><td style="text-align:left;">yarn workspaces info</td></tr><tr><td style="text-align:left;">给根空间添加依赖</td><td style="text-align:left;">yarn add chalk cross-spawn fs-extra --ignore-workspace-root-check</td></tr><tr><td style="text-align:left;">给某个项目添加依赖</td><td style="text-align:left;">yarn workspace create-react-app3 add commander</td></tr><tr><td style="text-align:left;">删除所有的 node_modules</td><td style="text-align:left;">lerna clean 等于 yarn workspaces run clean</td></tr><tr><td style="text-align:left;">安装和link</td><td style="text-align:left;">yarn install 等于 lerna bootstrap --npm-client yarn --use-workspaces</td></tr><tr><td style="text-align:left;">重新获取所有的 node_modules</td><td style="text-align:left;">yarn install --force</td></tr><tr><td style="text-align:left;">查看缓存目录</td><td style="text-align:left;">yarn cache dir</td></tr><tr><td style="text-align:left;">清除本地缓存</td><td style="text-align:left;">yarn cache clean</td></tr></tbody></table><h4 id="_1-1-5-创建子项目" tabindex="-1"><a class="header-anchor" href="#_1-1-5-创建子项目"><span>1.1.5 创建子项目</span></a></h4><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text"><pre><code class="language-text"><span class="line">lerna create vite-cli</span>
<span class="line">lerna create  vite-project</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div></div></div><h5 id="_1-1-5-1-vite-cli" tabindex="-1"><a class="header-anchor" href="#_1-1-5-1-vite-cli"><span>1.1.5.1 vite-cli</span></a></h5><h6 id="_1-1-5-1-1-package-json" tabindex="-1"><a class="header-anchor" href="#_1-1-5-1-1-package-json"><span>1.1.5.1.1 package.json</span></a></h6><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code class="language-javascript"><span class="line"><span class="token punctuation">{</span></span>
<span class="line">  <span class="token string-property property">&quot;name&quot;</span><span class="token operator">:</span> <span class="token string">&quot;vite-cli&quot;</span><span class="token punctuation">,</span></span>
<span class="line">  <span class="token string-property property">&quot;version&quot;</span><span class="token operator">:</span> <span class="token string">&quot;0.0.0&quot;</span><span class="token punctuation">,</span></span>
<span class="line">  <span class="token string-property property">&quot;bin&quot;</span><span class="token operator">:</span><span class="token punctuation">{</span></span>
<span class="line">    <span class="token string-property property">&quot;vite-cli&quot;</span><span class="token operator">:</span><span class="token string">&quot;./bin/vite.js&quot;</span></span>
<span class="line">  <span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">  <span class="token string-property property">&quot;scripts&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h6 id="_1-1-5-1-2-vite-js" tabindex="-1"><a class="header-anchor" href="#_1-1-5-1-2-vite-js"><span>1.1.5.1.2 vite.js</span></a></h6><p>packages\\vite-cli\\bin\\vite.js</p><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code class="language-javascript"><span class="line"> </span>
<span class="line"><span class="token keyword">function</span> <span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&#39;../lib/cli&#39;</span><span class="token punctuation">)</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h6 id="_1-1-5-1-3-cli-js" tabindex="-1"><a class="header-anchor" href="#_1-1-5-1-3-cli-js"><span>1.1.5.1.3 cli.js</span></a></h6><p>packages\\vite-cli\\lib\\cli.js</p><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code class="language-javascript"><span class="line">console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&#39;vite&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><h5 id="_1-1-5-2-vite-project" tabindex="-1"><a class="header-anchor" href="#_1-1-5-2-vite-project"><span>1.1.5.2 vite-project</span></a></h5><h6 id="_1-1-5-2-1-package-json" tabindex="-1"><a class="header-anchor" href="#_1-1-5-2-1-package-json"><span>1.1.5.2.1 package.json</span></a></h6><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code class="language-javascript"><span class="line"><span class="token punctuation">{</span></span>
<span class="line">  <span class="token string-property property">&quot;name&quot;</span><span class="token operator">:</span> <span class="token string">&quot;vite-project&quot;</span><span class="token punctuation">,</span></span>
<span class="line">  <span class="token string-property property">&quot;version&quot;</span><span class="token operator">:</span> <span class="token string">&quot;0.0.0&quot;</span><span class="token punctuation">,</span></span>
<span class="line">  <span class="token string-property property">&quot;scripts&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_1-1-6-创建软链接" tabindex="-1"><a class="header-anchor" href="#_1-1-6-创建软链接"><span>1.1.6 创建软链接</span></a></h4><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code class="language-javascript"><span class="line">yarn</span>
<span class="line">cd packages<span class="token operator">/</span>vite<span class="token operator">-</span>cli</span>
<span class="line">npm link</span>
<span class="line">npm root <span class="token operator">-</span>g</span>
<span class="line">vite<span class="token operator">-</span>cli</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_1-2-安装依赖" tabindex="-1"><a class="header-anchor" href="#_1-2-安装依赖"><span>1.2 安装依赖</span></a></h3><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code class="language-javascript"><span class="line">cd packages<span class="token operator">/</span>vite<span class="token operator">-</span>project</span>
<span class="line">yarn workspace vite<span class="token operator">-</span>project add vite</span>
<span class="line"></span>
<span class="line">cd packages<span class="token operator">/</span>vite<span class="token operator">-</span>cli</span>
<span class="line">yarn workspace vite<span class="token operator">-</span>cli add   es<span class="token operator">-</span>module<span class="token operator">-</span>lexer koa koa<span class="token operator">-</span><span class="token keyword">static</span> magic<span class="token operator">-</span>string chalk dedent hash<span class="token operator">-</span>sum</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="_2-启动并调试" tabindex="-1"><a class="header-anchor" href="#_2-启动并调试"><span>2. 启动并调试</span></a></h2><h3 id="_2-1-package-json" tabindex="-1"><a class="header-anchor" href="#_2-1-package-json"><span>2.1 package.json</span></a></h3><p>packages\\vite-project\\package.json</p><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text"><pre><code class="language-text"><span class="line">{</span>
<span class="line">  &quot;name&quot;: &quot;vite-project&quot;,</span>
<span class="line">  &quot;version&quot;: &quot;0.0.0&quot;,</span>
<span class="line">+ &quot;scripts&quot;: {</span>
<span class="line">+   &quot;dev&quot;:&quot;vite&quot;</span>
<span class="line">+ },</span>
<span class="line">  &quot;dependencies&quot;: {</span>
<span class="line">    &quot;vite&quot;: &quot;^2.4.1&quot;</span>
<span class="line">  }</span>
<span class="line">}</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_2-2-index-html" tabindex="-1"><a class="header-anchor" href="#_2-2-index-html"><span>2.2 index.html</span></a></h3><p>packages\\vite-project\\index.html</p><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code class="language-javascript"><span class="line"><span class="token operator">&lt;</span><span class="token operator">!</span><span class="token constant">DOCTYPE</span> html<span class="token operator">&gt;</span></span>
<span class="line"><span class="token operator">&lt;</span>html lang<span class="token operator">=</span><span class="token string">&quot;en&quot;</span><span class="token operator">&gt;</span></span>
<span class="line">  <span class="token operator">&lt;</span>head<span class="token operator">&gt;</span></span>
<span class="line">    <span class="token operator">&lt;</span>meta charset<span class="token operator">=</span><span class="token string">&quot;UTF-8&quot;</span> <span class="token operator">/</span><span class="token operator">&gt;</span></span>
<span class="line">    <span class="token operator">&lt;</span>meta name<span class="token operator">=</span><span class="token string">&quot;viewport&quot;</span> content<span class="token operator">=</span><span class="token string">&quot;width=device-width, initial-scale=1.0&quot;</span> <span class="token operator">/</span><span class="token operator">&gt;</span></span>
<span class="line">    <span class="token operator">&lt;</span>title<span class="token operator">&gt;</span>Vite App<span class="token operator">&lt;</span><span class="token operator">/</span>title<span class="token operator">&gt;</span></span>
<span class="line">  <span class="token operator">&lt;</span><span class="token operator">/</span>head<span class="token operator">&gt;</span></span>
<span class="line">  <span class="token operator">&lt;</span>body<span class="token operator">&gt;</span></span>
<span class="line">    <span class="token operator">&lt;</span>div id<span class="token operator">=</span><span class="token string">&quot;app&quot;</span><span class="token operator">&gt;</span><span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">&gt;</span></span>
<span class="line">    <span class="token operator">&lt;</span>script type<span class="token operator">=</span><span class="token string">&quot;module&quot;</span> src<span class="token operator">=</span><span class="token string">&quot;/src/main.js&quot;</span><span class="token operator">&gt;</span><span class="token operator">&lt;</span><span class="token operator">/</span>script<span class="token operator">&gt;</span></span>
<span class="line">  <span class="token operator">&lt;</span><span class="token operator">/</span>body<span class="token operator">&gt;</span></span>
<span class="line"><span class="token operator">&lt;</span><span class="token operator">/</span>html<span class="token operator">&gt;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_2-3-src-main-js" tabindex="-1"><a class="header-anchor" href="#_2-3-src-main-js"><span>2.3 src\\main.js</span></a></h3><p>packages\\vite-project\\src\\main.js</p><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code class="language-javascript"><span class="line">console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&#39;main.js&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><h3 id="_2-4-launch-json" tabindex="-1"><a class="header-anchor" href="#_2-4-launch-json"><span>2.4 launch.json</span></a></h3><p>.vscode\\launch.json</p><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code class="language-javascript"><span class="line"><span class="token punctuation">{</span></span>
<span class="line">    <span class="token string-property property">&quot;version&quot;</span><span class="token operator">:</span> <span class="token string">&quot;0.2.0&quot;</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token string-property property">&quot;configurations&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span></span>
<span class="line">        <span class="token punctuation">{</span></span>
<span class="line">            <span class="token string-property property">&quot;type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;node&quot;</span><span class="token punctuation">,</span></span>
<span class="line">            <span class="token string-property property">&quot;request&quot;</span><span class="token operator">:</span> <span class="token string">&quot;launch&quot;</span><span class="token punctuation">,</span></span>
<span class="line">            <span class="token string-property property">&quot;name&quot;</span><span class="token operator">:</span> <span class="token string">&quot;vue-cli&quot;</span><span class="token punctuation">,</span></span>
<span class="line">            <span class="token string-property property">&quot;cwd&quot;</span><span class="token operator">:</span><span class="token string">&quot;\${workspaceFolder}/packages/vite-project&quot;</span><span class="token punctuation">,</span></span>
<span class="line">            <span class="token string-property property">&quot;runtimeExecutable&quot;</span><span class="token operator">:</span> <span class="token string">&quot;npm&quot;</span><span class="token punctuation">,</span></span>
<span class="line">            <span class="token string-property property">&quot;runtimeArgs&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span></span>
<span class="line">                <span class="token string">&quot;run&quot;</span><span class="token punctuation">,</span></span>
<span class="line">                <span class="token string">&quot;dev&quot;</span></span>
<span class="line">            <span class="token punctuation">]</span><span class="token punctuation">,</span></span>
<span class="line">            <span class="token string-property property">&quot;port&quot;</span><span class="token operator">:</span><span class="token number">9229</span><span class="token punctuation">,</span></span>
<span class="line">            <span class="token string-property property">&quot;autoAttachChildProcesses&quot;</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span></span>
<span class="line">            <span class="token string-property property">&quot;stopOnEntry&quot;</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span></span>
<span class="line">            <span class="token string-property property">&quot;skipFiles&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span></span>
<span class="line">                <span class="token string">&quot;&lt;node_internals&gt;/**&quot;</span></span>
<span class="line">            <span class="token punctuation">]</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">    <span class="token punctuation">]</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="_3-实现静态服务" tabindex="-1"><a class="header-anchor" href="#_3-实现静态服务"><span>3. 实现静态服务</span></a></h2><p><img src="https://upload-markdown-images.oss-cn-beijing.aliyuncs.com/viteflow_1632199501337.png" alt="viteflow"></p><h3 id="_3-1-serverpluginservestatic-js" tabindex="-1"><a class="header-anchor" href="#_3-1-serverpluginservestatic-js"><span>3.1 serverPluginServeStatic.js</span></a></h3><p>packages\\vite-cli\\lib\\serveStaticPlugin.js</p><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code class="language-javascript"><span class="line"><span class="token keyword">const</span> path <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&#39;path&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">const</span> <span class="token keyword">static</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&#39;koa-static&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token comment">//这个插件相当于给应用添加了一个静态文件中间件，以前的命令选择目录为根目录</span></span>
<span class="line"><span class="token keyword">function</span> <span class="token function">serveStaticPlugin</span><span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span>app<span class="token punctuation">,</span>projectRoot<span class="token punctuation">}</span></span><span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line">   app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token keyword">static</span><span class="token punctuation">(</span>projectRoot<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line">module<span class="token punctuation">.</span>exports <span class="token operator">=</span> serveStaticPlugin<span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_3-2-cli-js" tabindex="-1"><a class="header-anchor" href="#_3-2-cli-js"><span>3.2 cli.js</span></a></h3><p>packages\\vite-cli\\lib\\cli.js</p><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code class="language-javascript"><span class="line"><span class="token keyword">const</span> Koa <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&#39;koa&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">const</span> serveStaticPlugin <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&#39;./serveStaticPlugin&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">function</span> <span class="token function">createServer</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">const</span> app <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Koa</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">const</span> root <span class="token operator">=</span> process<span class="token punctuation">.</span><span class="token function">cwd</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token comment">// 构建上下文对象</span></span>
<span class="line">    <span class="token keyword">const</span> context <span class="token operator">=</span> <span class="token punctuation">{</span></span>
<span class="line">        app<span class="token punctuation">,</span></span>
<span class="line">        root</span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">ctx<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token comment">// 扩展ctx属性</span></span>
<span class="line">        Object<span class="token punctuation">.</span><span class="token function">assign</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> context<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">return</span> <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">const</span> resolvedPlugins <span class="token operator">=</span> <span class="token punctuation">[</span></span>
<span class="line">        serveStaticPlugin</span>
<span class="line">    <span class="token punctuation">]</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token comment">// 依次注册所有插件</span></span>
<span class="line">    resolvedPlugins<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">plugin</span> <span class="token operator">=&gt;</span> <span class="token function">plugin</span><span class="token punctuation">(</span>context<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">return</span> app<span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"><span class="token function">createServer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span><span class="token number">4000</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="_4-重写导入路径" tabindex="-1"><a class="header-anchor" href="#_4-重写导入路径"><span>4.重写导入路径</span></a></h2><ul><li>Vue单文件组件(SFC)规范 vue文件用于表示一个单一组件，其内使用类html语法，顶级标签有template,script,style和自定义的标签</li></ul><h3 id="_4-1-安装" tabindex="-1"><a class="header-anchor" href="#_4-1-安装"><span>4.1 安装</span></a></h3><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code class="language-javascript"><span class="line">yarn workspace vite<span class="token operator">-</span>project add  vue@<span class="token number">3</span>  @vitejs<span class="token operator">/</span>plugin<span class="token operator">-</span>vue @vue<span class="token operator">/</span>compiler<span class="token operator">-</span>sfc</span>
<span class="line">node <span class="token punctuation">.</span><span class="token operator">/</span>node_modules<span class="token operator">/</span>esbuild<span class="token operator">/</span>install<span class="token punctuation">.</span>js</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_4-2-nodemon-json" tabindex="-1"><a class="header-anchor" href="#_4-2-nodemon-json"><span>4.2 nodemon.json</span></a></h3><p>packages\\vite-project\\nodemon.json</p><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code class="language-javascript"><span class="line"><span class="token punctuation">{</span></span>
<span class="line">    <span class="token string-property property">&quot;watch&quot;</span><span class="token operator">:</span><span class="token punctuation">[</span><span class="token string">&quot;../vite-cli&quot;</span><span class="token punctuation">]</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>启动服务</p><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text"><pre><code class="language-text"><span class="line">nodemon ../vite-cli/bin/vite.js</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><h3 id="_4-3-vite-config-js" tabindex="-1"><a class="header-anchor" href="#_4-3-vite-config-js"><span>4.3 vite.config.js</span></a></h3><p>packages\\vite-project\\vite.config.js</p><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code class="language-javascript"><span class="line"><span class="token keyword">import</span> <span class="token punctuation">{</span> defineConfig <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;vite&quot;</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">import</span> vue <span class="token keyword">from</span> <span class="token string">&quot;@vitejs/plugin-vue&quot;</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token function">defineConfig</span><span class="token punctuation">(</span><span class="token punctuation">{</span></span>
<span class="line">  <span class="token literal-property property">plugins</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token function">vue</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">,</span></span>
<span class="line"><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_4-4-main-js" tabindex="-1"><a class="header-anchor" href="#_4-4-main-js"><span>4.4 main.js</span></a></h3><p>packages\\vite-project\\src\\main.js</p><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text"><pre><code class="language-text"><span class="line">+import {createApp} from &#39;vue&#39;;</span>
<span class="line">+console.log(createApp);</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_4-5-cli-js" tabindex="-1"><a class="header-anchor" href="#_4-5-cli-js"><span>4.5 cli.js</span></a></h3><p>packages\\vite-cli\\lib\\cli.js</p><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text"><pre><code class="language-text"><span class="line">const Koa = require(&#39;koa&#39;);</span>
<span class="line">const dedent = require(&#39;dedent&#39;);</span>
<span class="line">const serveStaticPlugin = require(&#39;./serveStaticPlugin&#39;);</span>
<span class="line">+const moduleRewritePlugin = require(&#39;./moduleRewritePlugin&#39;);</span>
<span class="line">function createServer() {</span>
<span class="line">  //koa的实例</span>
<span class="line">  const app = new Koa();</span>
<span class="line">  //当前命令所在的根目录</span>
<span class="line">  const root = process.cwd();</span>
<span class="line">  //上下文</span>
<span class="line">  const context = {</span>
<span class="line">    app,</span>
<span class="line">    root</span>
<span class="line">  }</span>
<span class="line">  app.use((ctx, next) =&gt; {</span>
<span class="line">    Object.assign(ctx, context);</span>
<span class="line">    return next();</span>
<span class="line">  });</span>
<span class="line">  const resolvedPlugins = [</span>
<span class="line">+   moduleRewritePlugin,</span>
<span class="line">    serveStaticPlugin</span>
<span class="line">  ]</span>
<span class="line">  resolvedPlugins.forEach(plugin =&gt; plugin(context));</span>
<span class="line">  return app;</span>
<span class="line">}</span>
<span class="line">createServer().listen(4000, async () =&gt; {</span>
<span class="line">  const chalk = await import(&#39;chalk&#39;);</span>
<span class="line">  console.log(</span>
<span class="line">    dedent\`\${chalk.default.green(\`vite-cli dev server running at:\`)}</span>
<span class="line">           &gt; Local: http://localhost:4000/</span>
<span class="line">    \`</span>
<span class="line">  );</span>
<span class="line">});</span>
<span class="line"></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_4-6-serverpluginmodulerewrite-js" tabindex="-1"><a class="header-anchor" href="#_4-6-serverpluginmodulerewrite-js"><span>4.6 serverPluginModuleRewrite.js</span></a></h3><p>packages\\vite-cli\\lib\\serverPluginModuleRewrite.js</p><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code class="language-javascript"><span class="line"><span class="token keyword">let</span> <span class="token punctuation">{</span> readBody <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&#39;./utils&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">let</span> MagicString <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&#39;magic-string&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">let</span> <span class="token punctuation">{</span> parse <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&#39;es-module-lexer&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">let</span> path <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&#39;path&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">rewriteImports</span><span class="token punctuation">(</span><span class="token parameter">content</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">  <span class="token keyword">var</span> magicString <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MagicString</span><span class="token punctuation">(</span>content<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">  <span class="token keyword">let</span> imports <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">parse</span><span class="token punctuation">(</span>content<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">  <span class="token keyword">if</span> <span class="token punctuation">(</span>imports <span class="token operator">&amp;&amp;</span> imports<span class="token punctuation">.</span>length <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> imports<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">      <span class="token keyword">const</span> <span class="token punctuation">{</span> n<span class="token punctuation">,</span> s<span class="token punctuation">,</span> e <span class="token punctuation">}</span> <span class="token operator">=</span> imports<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span></span>
<span class="line">      <span class="token comment">//如果开头既不是/也不是.的话才会需要替换</span></span>
<span class="line">      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">^[^\\/\\.]</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">.</span><span class="token function">test</span><span class="token punctuation">(</span>n<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">const</span> rewriteModuleId <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">\`</span><span class="token string">/node_modules/.vite/</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">\${</span>n<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">.js</span><span class="token template-punctuation string">\`</span></span><span class="token punctuation">;</span></span>
<span class="line">        magicString<span class="token punctuation">.</span><span class="token function">overwrite</span><span class="token punctuation">(</span>s<span class="token punctuation">,</span> e<span class="token punctuation">,</span> rewriteModuleId<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">      <span class="token punctuation">}</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">  <span class="token punctuation">}</span></span>
<span class="line">  <span class="token keyword">return</span> magicString<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"><span class="token keyword">function</span> <span class="token function">moduleRewritePlugin</span><span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> root<span class="token punctuation">,</span> app <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">  app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">ctx<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">await</span> <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//一上来就next了 next之前神马都没有</span></span>
<span class="line">    <span class="token comment">//如果有响应体，并且此响应体的内容类型是js  mime-type=application/javascript</span></span>
<span class="line">    <span class="token keyword">if</span> <span class="token punctuation">(</span>ctx<span class="token punctuation">.</span>body <span class="token operator">&amp;&amp;</span> ctx<span class="token punctuation">.</span>response<span class="token punctuation">.</span><span class="token function">is</span><span class="token punctuation">(</span><span class="token string">&#39;js&#39;</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">      <span class="token keyword">const</span> content <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">readBody</span><span class="token punctuation">(</span>ctx<span class="token punctuation">.</span>body<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">      <span class="token keyword">const</span> result <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">rewriteImports</span><span class="token punctuation">(</span>content<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">      ctx<span class="token punctuation">.</span>body <span class="token operator">=</span> result<span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line">module<span class="token punctuation">.</span>exports <span class="token operator">=</span> moduleRewritePlugin<span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_4-7-utils-js" tabindex="-1"><a class="header-anchor" href="#_4-7-utils-js"><span>4.7 utils.js</span></a></h3><p>packages\\vite-cli\\lib\\utils.js</p><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code class="language-javascript"><span class="line"><span class="token keyword">const</span> <span class="token punctuation">{</span> Readable <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&#39;stream&#39;</span><span class="token punctuation">)</span></span>
<span class="line"><span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">readBody</span><span class="token punctuation">(</span><span class="token parameter">stream</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">  <span class="token keyword">if</span> <span class="token punctuation">(</span>stream <span class="token keyword">instanceof</span> <span class="token class-name">Readable</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></span>
<span class="line">      <span class="token keyword">let</span> buffers <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span></span>
<span class="line">      stream</span>
<span class="line">        <span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">&#39;data&#39;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">chunk</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> buffers<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>chunk<span class="token punctuation">)</span><span class="token punctuation">)</span></span>
<span class="line">        <span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">&#39;end&#39;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token function">resolve</span><span class="token punctuation">(</span>Buffer<span class="token punctuation">.</span><span class="token function">concat</span><span class="token punctuation">(</span>buffers<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span><span class="token punctuation">)</span></span>
<span class="line">  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">return</span> stream<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">  <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line">exports<span class="token punctuation">.</span>readBody <span class="token operator">=</span> readBody</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="_5-解析vue文件" tabindex="-1"><a class="header-anchor" href="#_5-解析vue文件"><span>5.解析vue文件</span></a></h2><h3 id="_5-1-moduleresolveplugin-js" tabindex="-1"><a class="header-anchor" href="#_5-1-moduleresolveplugin-js"><span>5.1 moduleResolvePlugin.js</span></a></h3><p>packages\\vite-cli\\lib\\moduleResolvePlugin.js</p><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code class="language-javascript"><span class="line"><span class="token keyword">const</span> fs <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&#39;fs&#39;</span><span class="token punctuation">)</span><span class="token punctuation">.</span>promises<span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">const</span> node_modulesRegexp <span class="token operator">=</span> <span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">^\\/node_modules\\/\\.vite\\/(.+?)\\.js</span><span class="token regex-delimiter">/</span></span></span>
<span class="line"><span class="token keyword">const</span> <span class="token punctuation">{</span> resolveVue <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&#39;./utils&#39;</span><span class="token punctuation">)</span></span>
<span class="line"><span class="token keyword">function</span> <span class="token function">moduleResolvePlugin</span><span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> app<span class="token punctuation">,</span> root <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">  <span class="token keyword">const</span> vueResolved <span class="token operator">=</span> <span class="token function">resolveVue</span><span class="token punctuation">(</span>root<span class="token punctuation">)</span></span>
<span class="line">  app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">ctx<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>node_modulesRegexp<span class="token punctuation">.</span><span class="token function">test</span><span class="token punctuation">(</span>ctx<span class="token punctuation">.</span>path<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">      <span class="token keyword">return</span> <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    <span class="token keyword">const</span> id <span class="token operator">=</span> ctx<span class="token punctuation">.</span>path<span class="token punctuation">.</span><span class="token function">match</span><span class="token punctuation">(</span>node_modulesRegexp<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">const</span> modulePath <span class="token operator">=</span> vueResolved<span class="token punctuation">[</span>moduleId<span class="token punctuation">]</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token comment">//如果vite预构建</span></span>
<span class="line">    <span class="token comment">//const modulePath = path.join(root, ctx.path)</span></span>
<span class="line">    <span class="token keyword">const</span> content <span class="token operator">=</span> <span class="token keyword">await</span> fs<span class="token punctuation">.</span><span class="token function">readFile</span><span class="token punctuation">(</span>modulePath<span class="token punctuation">,</span> <span class="token string">&#39;utf8&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    ctx<span class="token punctuation">.</span>type <span class="token operator">=</span> <span class="token string">&#39;js&#39;</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">    ctx<span class="token punctuation">.</span>body <span class="token operator">=</span> content</span>
<span class="line">  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line">module<span class="token punctuation">.</span>exports <span class="token operator">=</span> moduleResolvePlugin<span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_5-2-injectprocessplugin-js" tabindex="-1"><a class="header-anchor" href="#_5-2-injectprocessplugin-js"><span>5.2 injectProcessPlugin.js</span></a></h3><p>packages\\vite-cli\\lib\\injectProcessPlugin.js</p><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code class="language-javascript"><span class="line"><span class="token keyword">const</span> <span class="token punctuation">{</span> readBody <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;./utils&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">function</span> <span class="token function">injectProcessPlugin</span><span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> root<span class="token punctuation">,</span> app <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">  <span class="token keyword">const</span> devInjection <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">\`</span><span class="token string"></span>
<span class="line">    &lt;script&gt;</span>
<span class="line">        window.process = {env:{NODE_ENV:&#39;development&#39;}}</span>
<span class="line">    &lt;/script&gt;</span>
<span class="line">    </span><span class="token template-punctuation string">\`</span></span></span>
<span class="line">  app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">ctx<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">await</span> <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">if</span> <span class="token punctuation">(</span>ctx<span class="token punctuation">.</span>response<span class="token punctuation">.</span><span class="token function">is</span><span class="token punctuation">(</span><span class="token string">&#39;html&#39;</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">      <span class="token keyword">const</span> html <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">readBody</span><span class="token punctuation">(</span>ctx<span class="token punctuation">.</span>body<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">      ctx<span class="token punctuation">.</span>body <span class="token operator">=</span> html<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">&lt;head&gt;</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">,</span> <span class="token template-string"><span class="token template-punctuation string">\`</span><span class="token string">$&amp;</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">\${</span>devInjection<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">\`</span></span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">  <span class="token punctuation">}</span><span class="token punctuation">)</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line">module<span class="token punctuation">.</span>exports <span class="token operator">=</span> injectProcessPlugin</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_5-3-utils-js" tabindex="-1"><a class="header-anchor" href="#_5-3-utils-js"><span>5.3 utils.js</span></a></h3><p>packages\\vite-cli\\lib\\utils.js</p><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text"><pre><code class="language-text"><span class="line">const { Readable } = require(&#39;stream&#39;);</span>
<span class="line">const Module = require(&#39;module&#39;)</span>
<span class="line">async function readBody(stream) {</span>
<span class="line">    if(stream instanceof Readable){</span>
<span class="line">        return new Promise((resolve) =&gt; {</span>
<span class="line">            let buffers = [];</span>
<span class="line">            //当我们从流中读取到数据后</span>
<span class="line">            stream</span>
<span class="line">            .on(&#39;data&#39;,chunk=&gt;buffers.push(chunk))</span>
<span class="line">            .on(&#39;end&#39;,()=&gt;resolve(Buffer.concat(buffers).toString(&#39;utf8&#39;)))</span>
<span class="line">        });</span>
<span class="line">    }else{</span>
<span class="line">        return Promise.resolve(stream.toString(&#39;utf8&#39;));</span>
<span class="line">    }</span>
<span class="line">}</span>
<span class="line">exports.readBody = readBody;</span>
<span class="line"></span>
<span class="line">+function resolveVue(root) {</span>
<span class="line">+  let require = Module.createRequire(root);</span>
<span class="line">+  const resolvePath = (moduleName) =&gt; require.resolve(\`@vue/\${moduleName}/dist/\${moduleName}.esm-bundler.+js\`);</span>
<span class="line">+  return {</span>
<span class="line">+    &#39;@vue/shared&#39;: resolvePath(&#39;shared&#39;),</span>
<span class="line">+    &#39;@vue/reactivity&#39;: resolvePath(&#39;reactivity&#39;),</span>
<span class="line">+    &#39;@vue/runtime-core&#39;: resolvePath(&#39;runtime-core&#39;),</span>
<span class="line">+    &#39;vue&#39;: resolvePath(&#39;runtime-dom&#39;),</span>
<span class="line">+  }</span>
<span class="line">+}</span>
<span class="line">+exports.resolveVue = resolveVue;</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_5-4-cli-js" tabindex="-1"><a class="header-anchor" href="#_5-4-cli-js"><span>5.4 cli.js</span></a></h3><p>packages\\vite-cli\\lib\\cli.js</p><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text"><pre><code class="language-text"><span class="line">const Koa = require(&#39;koa&#39;);</span>
<span class="line">const dedent = require(&#39;dedent&#39;);</span>
<span class="line">const serveStaticPlugin = require(&#39;./serveStaticPlugin&#39;);</span>
<span class="line">const moduleRewritePlugin = require(&#39;./moduleRewritePlugin&#39;);</span>
<span class="line">+const moduleResolvePlugin = require(&#39;./moduleResolvePlugin&#39;);</span>
<span class="line">+const injectProcessPlugin = require(&#39;./injectProcessPlugin&#39;);</span>
<span class="line">function createServer() {</span>
<span class="line">  //koa的实例</span>
<span class="line">  const app = new Koa();</span>
<span class="line">  //当前命令所在的根目录</span>
<span class="line">  const root = process.cwd();</span>
<span class="line">  //上下文</span>
<span class="line">  const context = {</span>
<span class="line">    app,</span>
<span class="line">    root</span>
<span class="line">  }</span>
<span class="line">  app.use((ctx, next) =&gt; {</span>
<span class="line">    Object.assign(ctx, context);</span>
<span class="line">    return next();</span>
<span class="line">  });</span>
<span class="line">  const resolvedPlugins = [</span>
<span class="line">+   injectProcessPlugin,</span>
<span class="line">    moduleRewritePlugin,</span>
<span class="line">+   moduleResolvePlugin,</span>
<span class="line">    serveStaticPlugin</span>
<span class="line">  ]</span>
<span class="line">  resolvedPlugins.forEach(plugin =&gt; plugin(context));</span>
<span class="line">  return app;</span>
<span class="line">}</span>
<span class="line">createServer().listen(4000, async () =&gt; {</span>
<span class="line">  const chalk = await import(&#39;chalk&#39;);</span>
<span class="line">  console.log(</span>
<span class="line">    dedent\`\${chalk.default.green(\`vite-cli dev server running at:\`)}</span>
<span class="line">           &gt; Local: http://localhost:4000/</span>
<span class="line">    \`</span>
<span class="line">  );</span>
<span class="line">});</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="_6-编译vue模板" tabindex="-1"><a class="header-anchor" href="#_6-编译vue模板"><span>6.编译vue模板</span></a></h2><h3 id="_6-1-main-js" tabindex="-1"><a class="header-anchor" href="#_6-1-main-js"><span>6.1 main.js</span></a></h3><p>packages\\vite-project\\src\\main.js</p><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text"><pre><code class="language-text"><span class="line">import {createApp} from &#39;vue&#39;;</span>
<span class="line">+import App from &#39;./App.vue&#39;;</span>
<span class="line"> +createApp(App).mount(&quot;</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_6-2-app-vue" tabindex="-1"><a class="header-anchor" href="#_6-2-app-vue"><span>6.2 App.vue</span></a></h3><p>packages\\vite-project\\src\\App.vue</p><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text"><pre><code class="language-text"><span class="line">&lt;template&gt;</span>
<span class="line">    &lt;h1&gt;App&lt;/h1&gt;</span>
<span class="line">&lt;/template&gt;</span>
<span class="line">&lt;script&gt;</span>
<span class="line">export default {</span>
<span class="line">    name:&#39;App&#39;</span>
<span class="line">}</span>
<span class="line">&lt;/script&gt;</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_6-3-vueplugin-js" tabindex="-1"><a class="header-anchor" href="#_6-3-vueplugin-js"><span>6.3 vuePlugin.js</span></a></h3><p>packages\\vite-cli\\lib\\vuePlugin.js</p><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code class="language-javascript"><span class="line"><span class="token keyword">const</span> fs <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&#39;fs&#39;</span><span class="token punctuation">)</span><span class="token punctuation">.</span>promises<span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">const</span> path <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&#39;path&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">const</span> hash <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&#39;hash-sum&#39;</span><span class="token punctuation">)</span></span>
<span class="line"><span class="token keyword">const</span> <span class="token punctuation">{</span> parse<span class="token punctuation">,</span> compileScript<span class="token punctuation">,</span> compileTemplate<span class="token punctuation">,</span> rewriteDefault <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&#39;@vue/compiler-sfc&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">var</span> cache <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Map</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">function</span> <span class="token function">vuePlugin</span><span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> root<span class="token punctuation">,</span> app <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">  app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">ctx<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>ctx<span class="token punctuation">.</span>path<span class="token punctuation">.</span><span class="token function">endsWith</span><span class="token punctuation">(</span><span class="token string">&#39;.vue&#39;</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">      <span class="token keyword">return</span> <span class="token keyword">await</span> <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    <span class="token keyword">const</span> filePath <span class="token operator">=</span> path<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span>root<span class="token punctuation">,</span> ctx<span class="token punctuation">.</span>path<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">const</span> descriptor <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">getDescriptor</span><span class="token punctuation">(</span>filePath<span class="token punctuation">,</span> root<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">let</span> targetCode <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">\`</span><span class="token template-punctuation string">\`</span></span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token comment">//js</span></span>
<span class="line">    <span class="token keyword">if</span> <span class="token punctuation">(</span>descriptor<span class="token punctuation">.</span>script<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">      <span class="token keyword">let</span> script <span class="token operator">=</span> <span class="token function">compileScript</span><span class="token punctuation">(</span>descriptor<span class="token punctuation">,</span> <span class="token punctuation">{</span> <span class="token literal-property property">reactivityTransform</span><span class="token operator">:</span> <span class="token boolean">false</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">      scriptCode <span class="token operator">=</span> <span class="token function">rewriteDefault</span><span class="token punctuation">(</span>script<span class="token punctuation">.</span>content<span class="token punctuation">,</span> <span class="token string">&#39;_sfc_main&#39;</span><span class="token punctuation">)</span></span>
<span class="line">      targetCode <span class="token operator">+=</span> scriptCode<span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    <span class="token comment">//template</span></span>
<span class="line">    <span class="token keyword">if</span> <span class="token punctuation">(</span>descriptor<span class="token punctuation">.</span>template<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">      <span class="token keyword">let</span> templateContent <span class="token operator">=</span> descriptor<span class="token punctuation">.</span>template<span class="token punctuation">.</span>content<span class="token punctuation">;</span></span>
<span class="line">      <span class="token keyword">const</span> <span class="token punctuation">{</span> <span class="token literal-property property">code</span><span class="token operator">:</span> templateCode <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">compileTemplate</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token literal-property property">source</span><span class="token operator">:</span> templateContent <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">      targetCode <span class="token operator">+=</span> templateCode<span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    targetCode <span class="token operator">+=</span> <span class="token template-string"><span class="token template-punctuation string">\`</span><span class="token string">\\n_sfc_main.render=render</span><span class="token template-punctuation string">\`</span></span><span class="token punctuation">;</span></span>
<span class="line">    targetCode <span class="token operator">+=</span> <span class="token template-string"><span class="token template-punctuation string">\`</span><span class="token string">\\nexport default _sfc_main</span><span class="token template-punctuation string">\`</span></span><span class="token punctuation">;</span></span>
<span class="line">    ctx<span class="token punctuation">.</span>type <span class="token operator">=</span> <span class="token string">&#39;js&#39;</span><span class="token punctuation">;</span></span>
<span class="line">    ctx<span class="token punctuation">.</span>body <span class="token operator">=</span> targetCode<span class="token punctuation">;</span></span>
<span class="line">  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"><span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">getDescriptor</span><span class="token punctuation">(</span><span class="token parameter">filePath</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">  <span class="token keyword">if</span> <span class="token punctuation">(</span>descriptorCache<span class="token punctuation">.</span><span class="token function">has</span><span class="token punctuation">(</span>filePath<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">return</span> descriptorCache<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>filePath<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">  <span class="token punctuation">}</span></span>
<span class="line">  <span class="token keyword">const</span> content <span class="token operator">=</span> <span class="token keyword">await</span> fs<span class="token punctuation">.</span><span class="token function">readFile</span><span class="token punctuation">(</span>filePath<span class="token punctuation">,</span> <span class="token string">&#39;utf8&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">  <span class="token keyword">const</span> <span class="token punctuation">{</span> descriptor <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">parse</span><span class="token punctuation">(</span>content<span class="token punctuation">,</span> <span class="token punctuation">{</span> <span class="token literal-property property">filename</span><span class="token operator">:</span> filePath <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">  descriptorCache<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>filePath<span class="token punctuation">,</span> descriptor<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">  <span class="token keyword">return</span> descriptor<span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line">module<span class="token punctuation">.</span>exports <span class="token operator">=</span> vuePlugin<span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code class="language-javascript"><span class="line"><span class="token keyword">const</span> <span class="token punctuation">{</span> parse<span class="token punctuation">,</span> compileScript<span class="token punctuation">,</span> compileTemplate<span class="token punctuation">,</span> rewriteDefault <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&#39;@vue/compiler-sfc&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">const</span> dedent <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&#39;dedent&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//indent dedent</span></span>
<span class="line"><span class="token keyword">const</span> App <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">\`</span><span class="token string"></span>
<span class="line">&lt;template&gt;</span>
<span class="line">  &lt;h1&gt;App&lt;/h1&gt;</span>
<span class="line">&lt;/template&gt;</span>
<span class="line">&lt;script &gt;</span>
<span class="line">export default {</span>
<span class="line">  name: &#39;App&#39;</span>
<span class="line">}</span>
<span class="line">&lt;/script&gt;</span>
<span class="line">&lt;style&gt;</span>
<span class="line">h1 {</span>
<span class="line">  color: red;</span>
<span class="line">}</span>
<span class="line">&lt;/style&gt;</span>
<span class="line">&lt;style&gt;</span>
<span class="line">h1 {</span>
<span class="line">  background-color: green;</span>
<span class="line">}</span>
<span class="line">&lt;/style&gt;</span>
<span class="line"></span><span class="token template-punctuation string">\`</span></span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">let</span> <span class="token punctuation">{</span> descriptor <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">parse</span><span class="token punctuation">(</span>App<span class="token punctuation">,</span> <span class="token punctuation">{</span> <span class="token literal-property property">filename</span><span class="token operator">:</span> <span class="token string">&#39;App.vue&#39;</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">let</span> targetCode <span class="token operator">=</span> <span class="token string">&#39;&#39;</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token comment">//console.log(descriptor);</span></span>
<span class="line"><span class="token comment">//import &quot;/src/App.vue?t=1647142419693&amp;vue&amp;type=style&amp;index=0&amp;lang.css&quot;</span></span>
<span class="line"><span class="token keyword">if</span> <span class="token punctuation">(</span>descriptor<span class="token punctuation">.</span>styles<span class="token punctuation">.</span>length <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">  <span class="token keyword">let</span> styleCodes <span class="token operator">=</span> <span class="token string">&#39;&#39;</span><span class="token punctuation">;</span></span>
<span class="line">  descriptor<span class="token punctuation">.</span>styles<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">style<span class="token punctuation">,</span> index</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">const</span> query <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">\`</span><span class="token string">?t=</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">\${</span>Date<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&amp;vue&amp;type=style&amp;index=</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">\${</span>index<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&amp;lang.css</span><span class="token template-punctuation string">\`</span></span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">const</span> id <span class="token operator">=</span> <span class="token string">&#39;/src/App.vue&#39;</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">const</span> styleRequest <span class="token operator">=</span> id <span class="token operator">+</span> query<span class="token punctuation">;</span></span>
<span class="line">    styleCodes <span class="token operator">+=</span> <span class="token template-string"><span class="token template-punctuation string">\`</span><span class="token string">\\nimport </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">\${</span><span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>styleRequest<span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">\`</span></span></span>
<span class="line">  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">  targetCode <span class="token operator">+=</span> styleCodes<span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">if</span> <span class="token punctuation">(</span>descriptor<span class="token punctuation">.</span>script<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">  <span class="token keyword">let</span> scriptCode <span class="token operator">=</span> <span class="token function">compileScript</span><span class="token punctuation">(</span>descriptor<span class="token punctuation">,</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token literal-property property">reactivityTransform</span></span>
<span class="line">      <span class="token operator">:</span> <span class="token boolean">false</span></span>
<span class="line">  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">  scriptCode <span class="token operator">=</span> <span class="token function">rewriteDefault</span><span class="token punctuation">(</span>scriptCode<span class="token punctuation">.</span>content<span class="token punctuation">,</span> <span class="token string">&#39;_sfc_main&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">  targetCode <span class="token operator">+=</span> scriptCode<span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"><span class="token keyword">if</span> <span class="token punctuation">(</span>descriptor<span class="token punctuation">.</span>template<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">  <span class="token keyword">const</span> templateContent <span class="token operator">=</span> descriptor<span class="token punctuation">.</span>template<span class="token punctuation">.</span>content<span class="token punctuation">;</span></span>
<span class="line">  <span class="token keyword">let</span> <span class="token punctuation">{</span> code <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">compileTemplate</span><span class="token punctuation">(</span><span class="token punctuation">{</span></span>
<span class="line">    <span class="token literal-property property">source</span><span class="token operator">:</span> templateContent</span>
<span class="line">  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">  code <span class="token operator">=</span> code<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">export function render</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">,</span> <span class="token string">&#39;function _sfc_render&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">  targetCode <span class="token operator">+=</span> code<span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line">targetCode <span class="token operator">+=</span> <span class="token template-string"><span class="token template-punctuation string">\`</span><span class="token string"></span>
<span class="line">\\n_sfc_main.render = _sfc_render;</span>
<span class="line">\\nexport default _sfc_main;</span>
<span class="line"></span><span class="token template-punctuation string">\`</span></span><span class="token punctuation">;</span></span>
<span class="line">console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>targetCode<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_6-4-cli-js" tabindex="-1"><a class="header-anchor" href="#_6-4-cli-js"><span>6.4 cli.js</span></a></h3><p>packages\\vite-cli\\lib\\cli.js</p><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text"><pre><code class="language-text"><span class="line">const Koa = require(&#39;koa&#39;);</span>
<span class="line">const dedent = require(&#39;dedent&#39;);</span>
<span class="line">const serveStaticPlugin = require(&#39;./serveStaticPlugin&#39;);</span>
<span class="line">const moduleRewritePlugin = require(&#39;./moduleRewritePlugin&#39;);</span>
<span class="line">const moduleResolvePlugin = require(&#39;./moduleResolvePlugin&#39;);</span>
<span class="line">const injectProcessPlugin = require(&#39;./injectProcessPlugin&#39;);</span>
<span class="line">+const vuePlugin = require(&#39;./vuePlugin&#39;)</span>
<span class="line">function createServer() {</span>
<span class="line">  //koa的实例</span>
<span class="line">  const app = new Koa();</span>
<span class="line">  //当前命令所在的根目录</span>
<span class="line">  const root = process.cwd();</span>
<span class="line">  //上下文</span>
<span class="line">  const context = {</span>
<span class="line">    app,</span>
<span class="line">    root</span>
<span class="line">  }</span>
<span class="line">  app.use((ctx, next) =&gt; {</span>
<span class="line">    Object.assign(ctx, context);</span>
<span class="line">    return next();</span>
<span class="line">  });</span>
<span class="line">  const resolvedPlugins = [</span>
<span class="line">    injectProcessPlugin,</span>
<span class="line">    moduleRewritePlugin,</span>
<span class="line">    moduleResolvePlugin,</span>
<span class="line">+   vuePlugin,</span>
<span class="line">    serveStaticPlugin</span>
<span class="line">  ]</span>
<span class="line">  resolvedPlugins.forEach(plugin =&gt; plugin(context));</span>
<span class="line">  return app;</span>
<span class="line">}</span>
<span class="line">createServer().listen(4000, async () =&gt; {</span>
<span class="line">  const chalk = await import(&#39;chalk&#39;);</span>
<span class="line">  console.log(</span>
<span class="line">    dedent\`\${chalk.default.green(\`vite-cli dev server running at:\`)}</span>
<span class="line">           &gt; Local: http://localhost:4000/</span>
<span class="line">    \`</span>
<span class="line">  );</span>
<span class="line">});</span>
<span class="line"></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="_7-支持样式" tabindex="-1"><a class="header-anchor" href="#_7-支持样式"><span>7.支持样式</span></a></h2><h3 id="_7-1-vueplugin-js" tabindex="-1"><a class="header-anchor" href="#_7-1-vueplugin-js"><span>7.1 vuePlugin.js</span></a></h3><p>packages\\vite-cli\\lib\\vuePlugin.js</p><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code class="language-javascript"><span class="line"><span class="token keyword">const</span> fs <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&#39;fs&#39;</span><span class="token punctuation">)</span><span class="token punctuation">.</span>promises<span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">const</span> path <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&#39;path&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">const</span> hash <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&#39;hash-sum&#39;</span><span class="token punctuation">)</span></span>
<span class="line"><span class="token keyword">const</span> <span class="token punctuation">{</span> parse<span class="token punctuation">,</span> compileScript<span class="token punctuation">,</span> compileTemplate<span class="token punctuation">,</span> rewriteDefault<span class="token punctuation">,</span> compileStyleAsync <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&#39;@vue/compiler-sfc&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">var</span> descriptorCache <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Map</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">function</span> <span class="token function">vuePlugin</span><span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> root<span class="token punctuation">,</span> app <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">  app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">ctx<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>ctx<span class="token punctuation">.</span>path<span class="token punctuation">.</span><span class="token function">endsWith</span><span class="token punctuation">(</span><span class="token string">&#39;.vue&#39;</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">      <span class="token keyword">return</span> <span class="token keyword">await</span> <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    <span class="token keyword">const</span> filePath <span class="token operator">=</span> path<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span>root<span class="token punctuation">,</span> ctx<span class="token punctuation">.</span>path<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">const</span> descriptor <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">getDescriptor</span><span class="token punctuation">(</span>filePath<span class="token punctuation">,</span> root<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">if</span> <span class="token punctuation">(</span>ctx<span class="token punctuation">.</span>query<span class="token punctuation">.</span>type <span class="token operator">===</span> <span class="token string">&#39;style&#39;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">      <span class="token keyword">const</span> block <span class="token operator">=</span> descriptor<span class="token punctuation">.</span>styles<span class="token punctuation">[</span><span class="token function">Number</span><span class="token punctuation">(</span>ctx<span class="token punctuation">.</span>query<span class="token punctuation">.</span>index<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">;</span></span>
<span class="line">      <span class="token keyword">let</span> result <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">transformStyle</span><span class="token punctuation">(</span>block<span class="token punctuation">.</span>content<span class="token punctuation">,</span> descriptor<span class="token punctuation">,</span> ctx<span class="token punctuation">.</span>query<span class="token punctuation">.</span>index<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">      ctx<span class="token punctuation">.</span>type <span class="token operator">=</span> <span class="token string">&#39;js&#39;</span><span class="token punctuation">;</span></span>
<span class="line">      ctx<span class="token punctuation">.</span>body <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">\`</span><span class="token string"></span>
<span class="line">        let style = document.createElement(&#39;style&#39;);</span>
<span class="line">        style.innerHTML = </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">\${</span><span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>result<span class="token punctuation">.</span>code<span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">;</span>
<span class="line">        document.head.appendChild(style);</span>
<span class="line">      </span><span class="token template-punctuation string">\`</span></span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span></span>
<span class="line">      <span class="token keyword">let</span> targetCode <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">\`</span><span class="token template-punctuation string">\`</span></span><span class="token punctuation">;</span></span>
<span class="line">      <span class="token keyword">if</span> <span class="token punctuation">(</span>descriptor<span class="token punctuation">.</span>styles<span class="token punctuation">.</span>length<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">let</span> stylesCode <span class="token operator">=</span> <span class="token string">&#39;&#39;</span><span class="token punctuation">;</span></span>
<span class="line">        descriptor<span class="token punctuation">.</span>styles<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">style<span class="token punctuation">,</span> index</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></span>
<span class="line">          <span class="token keyword">const</span> query <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">\`</span><span class="token string">?vue&amp;type=style&amp;index=</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">\${</span>index<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&amp;lang.css</span><span class="token template-punctuation string">\`</span></span></span>
<span class="line">          <span class="token keyword">const</span> id <span class="token operator">=</span>ctx<span class="token punctuation">.</span>path<span class="token punctuation">;</span></span>
<span class="line">          <span class="token keyword">const</span> styleRequest <span class="token operator">=</span> <span class="token punctuation">(</span>id <span class="token operator">+</span> query<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">\\\\</span><span class="token regex-delimiter">/</span><span class="token regex-flags">g</span></span><span class="token punctuation">,</span> <span class="token string">&#39;/&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">          stylesCode <span class="token operator">+=</span> <span class="token template-string"><span class="token template-punctuation string">\`</span><span class="token string">\\nimport </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">\${</span><span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>styleRequest<span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">\`</span></span></span>
<span class="line">        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        targetCode <span class="token operator">+=</span> stylesCode<span class="token punctuation">;</span></span>
<span class="line">      <span class="token punctuation">}</span></span>
<span class="line">      <span class="token comment">//js</span></span>
<span class="line">      <span class="token keyword">if</span> <span class="token punctuation">(</span>descriptor<span class="token punctuation">.</span>script<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">let</span> script <span class="token operator">=</span> <span class="token function">compileScript</span><span class="token punctuation">(</span>descriptor<span class="token punctuation">,</span> <span class="token punctuation">{</span> <span class="token literal-property property">id</span><span class="token operator">:</span> filePath<span class="token punctuation">,</span> <span class="token literal-property property">reactivityTransform</span><span class="token operator">:</span> <span class="token boolean">false</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        scriptCode <span class="token operator">=</span> <span class="token function">rewriteDefault</span><span class="token punctuation">(</span>script<span class="token punctuation">.</span>content<span class="token punctuation">,</span> <span class="token string">&#39;_sfc_main&#39;</span><span class="token punctuation">)</span></span>
<span class="line">        targetCode <span class="token operator">+=</span> scriptCode<span class="token punctuation">;</span></span>
<span class="line">      <span class="token punctuation">}</span></span>
<span class="line">      <span class="token comment">//template</span></span>
<span class="line">      <span class="token keyword">if</span> <span class="token punctuation">(</span>descriptor<span class="token punctuation">.</span>template<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">let</span> templateContent <span class="token operator">=</span> descriptor<span class="token punctuation">.</span>template<span class="token punctuation">.</span>content<span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">let</span> <span class="token punctuation">{</span> code <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">compileTemplate</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token literal-property property">id</span><span class="token operator">:</span> filePath<span class="token punctuation">,</span> <span class="token literal-property property">source</span><span class="token operator">:</span> templateContent <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        code <span class="token operator">=</span> code<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">export function render</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">,</span> <span class="token string">&#39;function _sfc_render&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        targetCode <span class="token operator">+=</span> code<span class="token punctuation">;</span></span>
<span class="line">      <span class="token punctuation">}</span></span>
<span class="line">      targetCode <span class="token operator">+=</span> <span class="token template-string"><span class="token template-punctuation string">\`</span><span class="token string">\\n_sfc_main.render=_sfc_render</span><span class="token template-punctuation string">\`</span></span><span class="token punctuation">;</span></span>
<span class="line">      targetCode <span class="token operator">+=</span> <span class="token template-string"><span class="token template-punctuation string">\`</span><span class="token string">\\nexport default _sfc_main</span><span class="token template-punctuation string">\`</span></span><span class="token punctuation">;</span></span>
<span class="line">      ctx<span class="token punctuation">.</span>type <span class="token operator">=</span> <span class="token string">&#39;js&#39;</span><span class="token punctuation">;</span></span>
<span class="line">      ctx<span class="token punctuation">.</span>body <span class="token operator">=</span> targetCode<span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"><span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">transformStyle</span><span class="token punctuation">(</span><span class="token parameter">code<span class="token punctuation">,</span> descriptor<span class="token punctuation">,</span> index</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">  <span class="token keyword">const</span> block <span class="token operator">=</span> descriptor<span class="token punctuation">.</span>styles<span class="token punctuation">[</span>index<span class="token punctuation">]</span><span class="token punctuation">;</span></span>
<span class="line">  <span class="token keyword">const</span> result <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">compileStyleAsync</span><span class="token punctuation">(</span><span class="token punctuation">{</span></span>
<span class="line">    <span class="token literal-property property">filename</span><span class="token operator">:</span> descriptor<span class="token punctuation">.</span>filename<span class="token punctuation">,</span></span>
<span class="line">    <span class="token literal-property property">source</span><span class="token operator">:</span> code<span class="token punctuation">,</span></span>
<span class="line">    <span class="token literal-property property">id</span><span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">\`</span><span class="token string">data-v-</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">\${</span>descriptor<span class="token punctuation">.</span>id<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">\`</span></span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token literal-property property">scoped</span><span class="token operator">:</span> block<span class="token punctuation">.</span>scoped</span>
<span class="line">  <span class="token punctuation">}</span><span class="token punctuation">)</span></span>
<span class="line">  <span class="token keyword">return</span> result<span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"><span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">getDescriptor</span><span class="token punctuation">(</span><span class="token parameter">filePath</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">  <span class="token keyword">if</span> <span class="token punctuation">(</span>descriptorCache<span class="token punctuation">.</span><span class="token function">has</span><span class="token punctuation">(</span>filePath<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">return</span> descriptorCache<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>filePath<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">  <span class="token punctuation">}</span></span>
<span class="line">  <span class="token keyword">const</span> content <span class="token operator">=</span> <span class="token keyword">await</span> fs<span class="token punctuation">.</span><span class="token function">readFile</span><span class="token punctuation">(</span>filePath<span class="token punctuation">,</span> <span class="token string">&#39;utf8&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">  <span class="token keyword">const</span> <span class="token punctuation">{</span> descriptor <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">parse</span><span class="token punctuation">(</span>content<span class="token punctuation">,</span> <span class="token punctuation">{</span> <span class="token literal-property property">filename</span><span class="token operator">:</span> filePath <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">  descriptorCache<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>filePath<span class="token punctuation">,</span> descriptor<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">  <span class="token keyword">return</span> descriptor<span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line">module<span class="token punctuation">.</span>exports <span class="token operator">=</span> vuePlugin<span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div>`,124)])])}const o=s(t,[["render",l]]),u=JSON.parse('{"path":"/strong/103.16.vite.source.html","title":"","lang":"en-US","frontmatter":{},"git":{"updatedTime":1681290319000,"contributors":[{"name":"yutao","username":"yutao","email":"642231346@qq.com","commits":1,"url":"https://github.com/yutao"}],"changelog":[{"hash":"f5ab8c9d34991ec274f7f652439afe5b2afb6147","time":1681290319000,"email":"642231346@qq.com","author":"yutao","message":"modify"}]},"filePathRelative":"strong/103.16.vite.source.md"}');export{o as comp,u as data};
