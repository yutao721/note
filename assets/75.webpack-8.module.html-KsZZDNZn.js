import{_ as s,c as a,a as e,o as p}from"./app-CD1YpnS1.js";const t={};function c(l,n){return p(),a("div",null,[...n[0]||(n[0]=[e(`<h2 id="_1-module" tabindex="-1"><a class="header-anchor" href="#_1-module"><span>1.module</span></a></h2><ul><li>对于<code>webpack</code>来说每个文件都是一个<code>module</code></li><li>webpack会从配置中<code>entry</code>定义开始，找到全部的文件，并转化为 <code>module</code></li></ul><h2 id="_2-build流程" tabindex="-1"><a class="header-anchor" href="#_2-build流程"><span>2.build流程</span></a></h2><p><img src="http://img.zhufengpeixun.cn/modulebuild3.jpg" alt="modulebuild3"></p><h2 id="_3-编译队列控制" tabindex="-1"><a class="header-anchor" href="#_3-编译队列控制"><span>3.编译队列控制</span></a></h2><p><img src="http://img.zhufengpeixun.cn/semaphore.jpg" alt="semaphore"></p><h2 id="_4-entry配置" tabindex="-1"><a class="header-anchor" href="#_4-entry配置"><span>4.entry配置</span></a></h2><h3 id="_4-1-字符串" tabindex="-1"><a class="header-anchor" href="#_4-1-字符串"><span>4.1 字符串</span></a></h3><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code class="language-javascript"><span class="line"><span class="token literal-property property">entry</span><span class="token operator">:</span> <span class="token string">&#39;./index.js&#39;</span><span class="token punctuation">,</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><h3 id="_4-2-字符串数组" tabindex="-1"><a class="header-anchor" href="#_4-2-字符串数组"><span>4.2 字符串数组</span></a></h3><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code class="language-javascript"><span class="line"><span class="token literal-property property">entry</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">&#39;./index1.js&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;./index2.js&#39;</span><span class="token punctuation">]</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><h3 id="_4-3-对象" tabindex="-1"><a class="header-anchor" href="#_4-3-对象"><span>4.3 对象</span></a></h3><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code class="language-javascript"><span class="line"> <span class="token literal-property property">entry</span><span class="token operator">:</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token literal-property property">main</span><span class="token operator">:</span> <span class="token string">&#39;./main.js&#39;</span></span>
<span class="line"> <span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_4-4-函数" tabindex="-1"><a class="header-anchor" href="#_4-4-函数"><span>4.4 函数</span></a></h3><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code class="language-javascript"><span class="line"><span class="token function-variable function">entry</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token string">&#39;./index.js&#39;</span></span>
<span class="line"><span class="token function-variable function">entry</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token string">&#39;./index.js&#39;</span><span class="token punctuation">)</span><span class="token punctuation">)</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="_5-singleentryplugin" tabindex="-1"><a class="header-anchor" href="#_5-singleentryplugin"><span>5.SingleEntryPlugin</span></a></h2><ul><li>[entryOption](https://github.com/webpack/webpack/blob/v4.43.0/lib/WebpackOptionsApply.js</li><li><a href="https://github.com/webpack/webpack/blob/v4.43.0/lib/SingleEntryPlugin.js" target="_blank" rel="noopener noreferrer">SingleEntryPlugin.js</a></li></ul><p><img src="http://img.zhufengpeixun.cn/EntryOptionPlugin.jpg" alt="EntryOptionPlugin"></p><h3 id="_5-1-注册模块工厂" tabindex="-1"><a class="header-anchor" href="#_5-1-注册模块工厂"><span>5.1 注册模块工厂</span></a></h3><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code class="language-javascript"><span class="line">compiler<span class="token punctuation">.</span>hooks<span class="token punctuation">.</span>compilation<span class="token punctuation">.</span><span class="token function">tap</span><span class="token punctuation">(</span><span class="token string">&quot;SingleEntryPlugin&quot;</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token punctuation">(</span><span class="token parameter">compilation<span class="token punctuation">,</span> <span class="token punctuation">{</span> normalModuleFactory <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></span>
<span class="line">        compilation<span class="token punctuation">.</span>dependencyFactories<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>SingleEntryDependency<span class="token punctuation">,</span>normalModuleFactory<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_5-2-make" tabindex="-1"><a class="header-anchor" href="#_5-2-make"><span>5.2 make</span></a></h3><ul><li>注册了<code>make</code>事件回调，在<code>make</code>阶段的时候调用<code>addEntry</code>方法，然后进入<code>_addModuleChain</code>进入正式的编译阶段</li><li>[compile](https://github.com/webpack/webpack/blob/c9d4ff7b054fc581c96ce0e53432d44f9dd8ca72/lib/Compiler.js</li><li>[newCompilationParams](https://github.com/webpack/webpack/blob/c9d4ff7b054fc581c96ce0e53432d44f9dd8ca72/lib/Compiler.js</li><li>[this.hooks.compilation.call](https://github.com/webpack/webpack/blob/v4.43.0/lib/Compiler.js</li><li>[this.dependencyFactories.get(Dep)](https://github.com/webpack/webpack/blob/c9d4ff7b054fc581c96ce0e53432d44f9dd8ca72/lib/Compilation.js</li></ul><h2 id="_6-dependency" tabindex="-1"><a class="header-anchor" href="#_6-dependency"><span>6.dependency</span></a></h2><ul><li><a href="https://github.com/webpack/webpack/tree/c9d4ff7b054fc581c96ce0e53432d44f9dd8ca72/lib/dependencies" target="_blank" rel="noopener noreferrer">dependencies</a></li><li>生成<code>chunk</code>时会依靠<code>dependency</code>来得到依赖关系图</li><li>生成最终文件时会依赖<code>dependency</code>中方法和保存的信息将源文件中的<code>import</code>等语句替换成最终输出的可执行的JS语句</li></ul><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code class="language-javascript"><span class="line"><span class="token literal-property property">module</span><span class="token operator">:</span> <span class="token punctuation">{</span></span>
<span class="line">  <span class="token literal-property property">dependencies</span><span class="token operator">:</span> <span class="token punctuation">[</span></span>
<span class="line">    <span class="token literal-property property">dependency</span><span class="token operator">:</span> <span class="token punctuation">{</span></span>
<span class="line">      module</span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">  <span class="token punctuation">]</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="_7-文件转-module" tabindex="-1"><a class="header-anchor" href="#_7-文件转-module"><span>7.文件转 module</span></a></h2><ul><li>create 创建 module 实例</li><li>add module保存到 Compilation 实例上</li><li>build 分析文件内容,并分析依赖项</li><li>processDep 处理依赖，并添加到编译链条中</li></ul><h3 id="_7-1-create" tabindex="-1"><a class="header-anchor" href="#_7-1-create"><span>7.1 create</span></a></h3><ul><li>[NormalModuleFactory.create](https://github.com/webpack/webpack/blob/c9d4ff7b054fc581c96ce0e53432d44f9dd8ca72/lib/NormalModuleFactory.js</li></ul><p><img src="http://img.zhufengpeixun.cn/NormalModuleFactorycreate.jpg" alt="NormalModuleFactory.create"></p><h3 id="_7-2-addmodule" tabindex="-1"><a class="header-anchor" href="#_7-2-addmodule"><span>7.2 addModule</span></a></h3><ul><li><p>add 阶段是将 module 的所有信息保存到 Compilation 中，以便于在最后打包成 chunk 的时候使用</p><ul><li>保存到全局的 <code>Compilation.modules</code> 数组中</li><li>保存到<code>Compilation._modules</code> 对象</li><li>添加 <code>reason</code></li><li>添加<code>Compilation.entries</code></li></ul></li><li><p>[moduleFactory.create.callback](https://github.com/webpack/webpack/blob/c9d4ff7b054fc581c96ce0e53432d44f9dd8ca72/lib/Compilation.js</p></li></ul><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code class="language-javascript"><span class="line"><span class="token function">addModule</span><span class="token punctuation">(</span><span class="token parameter">module</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">  <span class="token keyword">const</span> identifier <span class="token operator">=</span> module<span class="token punctuation">.</span><span class="token function">identifier</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">  <span class="token keyword">this</span><span class="token punctuation">.</span>_modules<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>identifier<span class="token punctuation">,</span> module<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">  <span class="token keyword">this</span><span class="token punctuation">.</span>modules<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>module<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">  <span class="token keyword">this</span><span class="token punctuation">.</span>entries<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>module<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">  module<span class="token punctuation">.</span>reasons<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ModuleReason</span><span class="token punctuation">(</span>module<span class="token punctuation">,</span> dependency<span class="token punctuation">,</span> explanation<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_7-3-buildmodule" tabindex="-1"><a class="header-anchor" href="#_7-3-buildmodule"><span>7.3 buildModule</span></a></h3><ul><li>[buildModule](https://github.com/webpack/webpack/blob/c9d4ff7b054fc581c96ce0e53432d44f9dd8ca72/lib/NormalModule.js</li></ul><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code class="language-javascript"><span class="line"><span class="token function">build</span><span class="token punctuation">(</span><span class="token parameter">options<span class="token punctuation">,</span> compilation<span class="token punctuation">,</span> resolver<span class="token punctuation">,</span> fs<span class="token punctuation">,</span> callback</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">  <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">doBuild</span><span class="token punctuation">(</span>options<span class="token punctuation">,</span> compilation<span class="token punctuation">,</span> resolver<span class="token punctuation">,</span> fs<span class="token punctuation">,</span> <span class="token parameter">err</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token comment">// 处理 source 这里会将 source 转为 AST，分析出所有的依赖</span></span>
<span class="line">        <span class="token keyword">const</span> result <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>parser<span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>_ast <span class="token operator">||</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_source<span class="token punctuation">.</span><span class="token function">source</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token function">handleParseResult</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">  <span class="token punctuation">}</span><span class="token punctuation">)</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">//获取 source</span></span>
<span class="line"><span class="token function">doBuild</span><span class="token punctuation">(</span><span class="token parameter">options<span class="token punctuation">,</span> compilation<span class="token punctuation">,</span> resolver<span class="token punctuation">,</span> fs<span class="token punctuation">,</span> callback</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token function">runLoaders</span><span class="token punctuation">(</span></span>
<span class="line">        <span class="token punctuation">{</span></span>
<span class="line">            <span class="token literal-property property">resource</span><span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>resource<span class="token punctuation">,</span></span>
<span class="line">            <span class="token literal-property property">loaders</span><span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>loaders<span class="token punctuation">,</span></span>
<span class="line">            <span class="token literal-property property">context</span><span class="token operator">:</span> loaderContext<span class="token punctuation">,</span></span>
<span class="line">            <span class="token literal-property property">readResource</span><span class="token operator">:</span> fs<span class="token punctuation">.</span><span class="token function">readFile</span><span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span>fs<span class="token punctuation">)</span></span>
<span class="line">        <span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">        <span class="token punctuation">(</span><span class="token parameter">err<span class="token punctuation">,</span> result</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token comment">// createSource 会将 runLoader 得到的结果转为字符串以便后续处理</span></span>
<span class="line">            <span class="token keyword">this</span><span class="token punctuation">.</span>_source <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">createSource</span><span class="token punctuation">(</span></span>
<span class="line">                <span class="token keyword">this</span><span class="token punctuation">.</span>binary <span class="token operator">?</span> <span class="token function">asBuffer</span><span class="token punctuation">(</span>source<span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token function">asString</span><span class="token punctuation">(</span>source<span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line">                resourceBuffer<span class="token punctuation">,</span></span>
<span class="line">                sourceMap</span>
<span class="line">            <span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">              <span class="token keyword">return</span> <span class="token function">callback</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">    <span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_7-4-parse" tabindex="-1"><a class="header-anchor" href="#_7-4-parse"><span>7.4 parse</span></a></h3><ul><li><p><a href="https://astexplorer.net/" target="_blank" rel="noopener noreferrer">astexplorer</a></p></li><li><p>将 source 转为 AST(如果 source 是字符串类型)</p></li><li><p>遍历 AST，遇到 import 语句就增加相关依赖</p><ul><li>树的遍历 program事件 -&gt; detectStrictMode -&gt; preWalkStatements -&gt; walkStatements</li><li>遍历过程中会给<code>module</code>增加<code>dependency</code>实例,每个 <code>dependency</code> 类都会有一个 <code>template</code> 方法，并且保存了原来代码中的字符位置 <code>range</code>,在最后生成打包后的文件时，会用 <code>template</code> 的结果替换 <code>range</code> 部分的内容</li><li>最终得到的 <code>dependency</code> 不仅包含了文件中所有的依赖信息，还被用于最终生成打包代码时对原始内容的修改和替换</li></ul></li><li><p>[parse](https://github.com/webpack/webpack/blob/c9d4ff7b054fc581c96ce0e53432d44f9dd8ca72/lib/Parser.js</p></li><li><p><a href="https://github.com/webpack/webpack/blob/c9d4ff7b054fc581c96ce0e53432d44f9dd8ca72/lib/dependencies/HarmonyImportDependencyParserPlugin.js" target="_blank" rel="noopener noreferrer">HarmonyImportDependencyParserPlugin</a></p></li><li><p>得到的依赖</p><ul><li><a href="https://github.com/webpack/webpack/blob/c9d4ff7b054fc581c96ce0e53432d44f9dd8ca72/lib/dependencies/HarmonyCompatibilityDependency.js" target="_blank" rel="noopener noreferrer">HarmonyCompatibilityDependency</a> 添加<code>__webpack_require__.r(__webpack_exports__)</code>[RuntimeTemplate](https://github.com/webpack/webpack/blob/c9d4ff7b054fc581c96ce0e53432d44f9dd8ca72/lib/RuntimeTemplate.js</li><li><a href="https://github.com/webpack/webpack/blob/c9d4ff7b054fc581c96ce0e53432d44f9dd8ca72/lib/dependencies/HarmonyInitDependency.js" target="_blank" rel="noopener noreferrer">HarmonyInitDependency</a><code>var _title_js__WEBPACK_IMPORTED_MODULE_0__</code></li><li><a href="https://github.com/webpack/webpack/blob/c9d4ff7b054fc581c96ce0e53432d44f9dd8ca72/lib/dependencies/ConstDependency.js" target="_blank" rel="noopener noreferrer">ConstDependency</a> 放置一个占位符,在最后生成打包文件的时候将其再转为 <code>use strict</code></li><li><a href="https://github.com/webpack/webpack/blob/c9d4ff7b054fc581c96ce0e53432d44f9dd8ca72/lib/dependencies/HarmonyImportSideEffectDependency.js" target="_blank" rel="noopener noreferrer">HarmonyImportSideEffectDependency</a><code>var _title_js__WEBPACK_IMPORTED_MODULE_0__ = __webpack_require__(/*! ./title.js */ &quot;./src/title.js&quot;);</code></li><li><a href="https://github.com/webpack/webpack/blob/c9d4ff7b054fc581c96ce0e53432d44f9dd8ca72/lib/dependencies/HarmonyImportSpecifierDependency.js" target="_blank" rel="noopener noreferrer">HarmonyImportSpecifierDependency</a><code>console.log(_title_js__WEBPACK_IMPORTED_MODULE_0__[&quot;message&quot;]);</code></li></ul></li></ul><p>title.js</p><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code class="language-javascript"><span class="line"><span class="token keyword">export</span> <span class="token keyword">const</span> message <span class="token operator">=</span> <span class="token string">&#39;zhufeng&#39;</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p>lazy.js</p><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code class="language-javascript"><span class="line"><span class="token keyword">export</span> <span class="token keyword">const</span> message <span class="token operator">=</span> <span class="token string">&#39;zhufeng&#39;</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p>index.js</p><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code class="language-javascript"><span class="line"><span class="token keyword">import</span> <span class="token punctuation">{</span> message <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&#39;./title.js&#39;</span><span class="token punctuation">;</span></span>
<span class="line">console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>message<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">import</span><span class="token punctuation">(</span><span class="token string">&#39;./lazy.js&#39;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">result</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></span>
<span class="line">    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span><span class="token punctuation">)</span></span>
<span class="line">console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>__resourceQuery<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code class="language-javascript"><span class="line"><span class="token function">prewalkStatements</span><span class="token punctuation">(</span><span class="token parameter">statements</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> index <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> len <span class="token operator">=</span> statements<span class="token punctuation">.</span>length<span class="token punctuation">;</span> index <span class="token operator">&lt;</span> len<span class="token punctuation">;</span> index<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">const</span> statement <span class="token operator">=</span> statements<span class="token punctuation">[</span>index<span class="token punctuation">]</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">prewalkStatement</span><span class="token punctuation">(</span>statement<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"><span class="token function">prewalkImportDeclaration</span><span class="token punctuation">(</span><span class="token parameter">statement</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">const</span> source <span class="token operator">=</span> statement<span class="token punctuation">.</span>source<span class="token punctuation">.</span>value<span class="token punctuation">;</span><span class="token comment">//./title.js</span></span>
<span class="line">        <span class="token keyword">this</span><span class="token punctuation">.</span>hooks<span class="token punctuation">.</span><span class="token function">import</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>statement<span class="token punctuation">,</span> source<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> specifier <span class="token keyword">of</span> statement<span class="token punctuation">.</span>specifiers<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token keyword">const</span> name <span class="token operator">=</span> specifier<span class="token punctuation">.</span>local<span class="token punctuation">.</span>name<span class="token punctuation">;</span><span class="token comment">//name</span></span>
<span class="line">            <span class="token keyword">this</span><span class="token punctuation">.</span>scope<span class="token punctuation">.</span>renames<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">            <span class="token keyword">this</span><span class="token punctuation">.</span>scope<span class="token punctuation">.</span>definitions<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">            <span class="token keyword">switch</span> <span class="token punctuation">(</span>specifier<span class="token punctuation">.</span>type<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">                <span class="token keyword">case</span> <span class="token string">&quot;ImportDefaultSpecifier&quot;</span><span class="token operator">:</span></span>
<span class="line">                    <span class="token keyword">this</span><span class="token punctuation">.</span>hooks<span class="token punctuation">.</span><span class="token function">importSpecifier</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>statement<span class="token punctuation">,</span> source<span class="token punctuation">,</span> <span class="token string">&quot;default&quot;</span><span class="token punctuation">,</span> name<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">                    <span class="token keyword">break</span><span class="token punctuation">;</span></span>
<span class="line">                <span class="token keyword">case</span> <span class="token string">&quot;ImportSpecifier&quot;</span><span class="token operator">:</span></span>
<span class="line">                    <span class="token keyword">this</span><span class="token punctuation">.</span>hooks<span class="token punctuation">.</span><span class="token function">importSpecifier</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span></span>
<span class="line">                        statement<span class="token punctuation">,</span></span>
<span class="line">                        source<span class="token punctuation">,</span></span>
<span class="line">                        specifier<span class="token punctuation">.</span>imported<span class="token punctuation">.</span>name<span class="token punctuation">,</span></span>
<span class="line">                        name</span>
<span class="line">                    <span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">                    <span class="token keyword">break</span><span class="token punctuation">;</span></span>
<span class="line">            <span class="token punctuation">}</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>HarmonyImportDependencyParserPlugin</p><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code class="language-javascript"><span class="line"><span class="token keyword">const</span> sideEffectDep <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HarmonyImportSideEffectDependency</span><span class="token punctuation">(</span></span>
<span class="line">    source<span class="token punctuation">,</span></span>
<span class="line">    parser<span class="token punctuation">.</span>state<span class="token punctuation">.</span>module<span class="token punctuation">,</span></span>
<span class="line">    parser<span class="token punctuation">.</span>state<span class="token punctuation">.</span>lastHarmonyImportOrder<span class="token punctuation">,</span></span>
<span class="line">    parser<span class="token punctuation">.</span>state<span class="token punctuation">.</span>harmonyParserScope</span>
<span class="line"><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">sideEffectDep<span class="token punctuation">.</span>loc <span class="token operator">=</span> statement<span class="token punctuation">.</span>loc<span class="token punctuation">;</span></span>
<span class="line">parser<span class="token punctuation">.</span>state<span class="token punctuation">.</span>module<span class="token punctuation">.</span><span class="token function">addDependency</span><span class="token punctuation">(</span>sideEffectDep<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_7-5-依赖处理" tabindex="-1"><a class="header-anchor" href="#_7-5-依赖处理"><span>7.5 依赖处理</span></a></h3><ul><li>对 <code>dependencies</code> 按照代码在文件中出现的先后顺序排序</li><li>[Compilation.js](https://github.com/webpack/webpack/blob/c9d4ff7b054fc581c96ce0e53432d44f9dd8ca72/lib/Compilation.js</li></ul><p><img src="http://img.zhufengpeixun.cn/_preparedEntrypoints.jpg" alt="_preparedEntrypoints"></p><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code class="language-javascript"><span class="line"><span class="token keyword">const</span> <span class="token function-variable function">afterBuild</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">if</span> <span class="token punctuation">(</span>addModuleResult<span class="token punctuation">.</span>dependencies<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">processModuleDependencies</span><span class="token punctuation">(</span>module<span class="token punctuation">,</span> <span class="token parameter">err</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token keyword">if</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token function">callback</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">            <span class="token function">callback</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> module<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">return</span> <span class="token function">callback</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> module<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code class="language-javascript"><span class="line">dependencies<span class="token operator">=</span><span class="token punctuation">{</span></span>
<span class="line">    <span class="token literal-property property">NormalModuleFactory</span><span class="token operator">:</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token string-property property">&quot;module./title.js&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span></span>
<span class="line">       HarmonyImportSideEffectDependency<span class="token punctuation">,</span></span>
<span class="line">       HarmonyImportSpecifierDependency</span>
<span class="line">    <span class="token punctuation">]</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token string-property property">&quot;module./lazy.js&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span></span>
<span class="line">       HarmonyImportSideEffectDependency<span class="token punctuation">,</span></span>
<span class="line">       HarmonyImportSpecifierDependency</span>
<span class="line">    <span class="token punctuation">]</span></span>
<span class="line">  <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text"><pre><code class="language-text"><span class="line">sortedDependencies = [</span>
<span class="line">  {</span>
<span class="line">    factory: NormalModuleFactory,</span>
<span class="line">    dependencies: [</span>
<span class="line">      HarmonyImportSideEffectDependency,</span>
<span class="line">      HarmonyImportSpecifierDependency</span>
<span class="line">    ]</span>
<span class="line">  },</span>
<span class="line">   {</span>
<span class="line">    factory: NormalModuleFactory,</span>
<span class="line">    dependencies: [</span>
<span class="line">      HarmonyImportSideEffectDependency,</span>
<span class="line">      HarmonyImportSpecifierDependency</span>
<span class="line">    ]</span>
<span class="line">  }</span>
<span class="line">]</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code class="language-javascript"><span class="line"><span class="token function">addModuleDependencies</span><span class="token punctuation">(</span></span>
<span class="line">  <span class="token parameter">module<span class="token punctuation">,</span></span>
<span class="line">  dependencies<span class="token punctuation">,</span></span>
<span class="line">  bail<span class="token punctuation">,</span></span>
<span class="line">  cacheGroup<span class="token punctuation">,</span></span>
<span class="line">  recursive<span class="token punctuation">,</span></span>
<span class="line">  callback</span></span>
<span class="line"><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">  asyncLib<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span></span>
<span class="line">    dependencies<span class="token punctuation">,</span></span>
<span class="line">    <span class="token punctuation">(</span><span class="token parameter">item<span class="token punctuation">,</span> callback</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></span>
<span class="line">      <span class="token comment">//获取依赖</span></span>
<span class="line">      <span class="token keyword">const</span> dependencies <span class="token operator">=</span> item<span class="token punctuation">.</span>dependencies<span class="token punctuation">;</span></span>
<span class="line">      <span class="token comment">//获取工厂</span></span>
<span class="line">       <span class="token keyword">const</span> factory <span class="token operator">=</span> item<span class="token punctuation">.</span>factory<span class="token punctuation">;</span></span>
<span class="line">      <span class="token comment">//创建模块 </span></span>
<span class="line">      factory<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span></span>
<span class="line">          <span class="token punctuation">(</span><span class="token parameter">err<span class="token punctuation">,</span> dependentModule</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token keyword">const</span> addModuleResult <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">addModule</span><span class="token punctuation">(</span>dependentModule<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">            dependentModule <span class="token operator">=</span> addModuleResult<span class="token punctuation">.</span>module<span class="token punctuation">;</span></span>
<span class="line">            <span class="token comment">// 将 module 信息写入依赖中</span></span>
<span class="line">            <span class="token function">iterationDependencies</span><span class="token punctuation">(</span>dependencies<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">            <span class="token comment">// build 阶段</span></span>
<span class="line">            <span class="token keyword">const</span> <span class="token function-variable function">afterBuild</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></span>
<span class="line">              <span class="token comment">// build 阶段结束后有依赖的话继续处理依赖</span></span>
<span class="line">              <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">processModuleDependencies</span><span class="token punctuation">(</span>dependentModule<span class="token punctuation">,</span> callback<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">            <span class="token punctuation">}</span><span class="token punctuation">;</span></span>
<span class="line">            <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">buildModule</span><span class="token punctuation">(</span>afterBuild<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">          <span class="token punctuation">}</span></span>
<span class="line">        <span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">  <span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code class="language-javascript"><span class="line">dependencies<span class="token punctuation">{</span></span>
<span class="line">    <span class="token function">HarmonyImportSideEffectDependency</span><span class="token punctuation">(</span>request<span class="token operator">:</span><span class="token string">&quot;./title.js&quot;</span><span class="token punctuation">)</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line">blocks<span class="token punctuation">{</span></span>
<span class="line">    <span class="token function">ImportDependenciesBlock</span><span class="token punctuation">(</span>request<span class="token operator">:</span><span class="token string">&quot;./lazy.js&quot;</span><span class="token punctuation">)</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_7-6-流程" tabindex="-1"><a class="header-anchor" href="#_7-6-流程"><span>7.6 流程</span></a></h3><p><img src="http://img.zhufengpeixun.cn/moduleflow.jpg" alt="moduleflow"></p>`,57)])])}const o=s(t,[["render",c]]),u=JSON.parse('{"path":"/strong/75.webpack-8.module.html","title":"","lang":"en-US","frontmatter":{},"git":{"updatedTime":1681290319000,"contributors":[{"name":"yutao","username":"yutao","email":"642231346@qq.com","commits":1,"url":"https://github.com/yutao"}],"changelog":[{"hash":"f5ab8c9d34991ec274f7f652439afe5b2afb6147","time":1681290319000,"email":"642231346@qq.com","author":"yutao","message":"modify"}]},"filePathRelative":"strong/75.webpack-8.module.md"}');export{o as comp,u as data};
