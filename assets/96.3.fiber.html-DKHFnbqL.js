import{_ as s,c as a,a as p,o as t}from"./app-CD1YpnS1.js";const e={};function o(c,n){return t(),a("div",null,[...n[0]||(n[0]=[p(`<h2 id="_1-实现虚拟dom" tabindex="-1"><a class="header-anchor" href="#_1-实现虚拟dom"><span>1.实现虚拟DOM</span></a></h2><h3 id="_1-1-src-index-js" tabindex="-1"><a class="header-anchor" href="#_1-1-src-index-js"><span>1.1 src\\index.js</span></a></h3><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code class="language-javascript"><span class="line"><span class="token keyword">import</span> React <span class="token keyword">from</span> <span class="token string">&#39;./react&#39;</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token comment">//import ReactDOM from &#39;react-dom&#39;;</span></span>
<span class="line"><span class="token keyword">let</span> element <span class="token operator">=</span> <span class="token punctuation">(</span></span>
<span class="line">  <span class="token operator">&lt;</span>div id<span class="token operator">=</span><span class="token string">&quot;A1&quot;</span><span class="token operator">&gt;</span></span>
<span class="line">    <span class="token operator">&lt;</span>div id<span class="token operator">=</span><span class="token string">&quot;B1&quot;</span><span class="token operator">&gt;</span></span>
<span class="line">      <span class="token operator">&lt;</span>div id<span class="token operator">=</span><span class="token string">&quot;C1&quot;</span><span class="token operator">&gt;</span><span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">&gt;</span></span>
<span class="line">      <span class="token operator">&lt;</span>div id<span class="token operator">=</span><span class="token string">&quot;C2&quot;</span><span class="token operator">&gt;</span><span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">&gt;</span></span>
<span class="line">    <span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">&gt;</span></span>
<span class="line">    <span class="token operator">&lt;</span>div id<span class="token operator">=</span><span class="token string">&quot;B2&quot;</span><span class="token operator">&gt;</span><span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">&gt;</span></span>
<span class="line">  <span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">&gt;</span></span>
<span class="line"><span class="token punctuation">)</span></span>
<span class="line">console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>element<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token comment">/* ReactDOM.render(</span>
<span class="line">  element,</span>
<span class="line">  document.getElementById(&#39;root&#39;)</span>
<span class="line">);</span>
<span class="line">*/</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_1-2-src-react-js" tabindex="-1"><a class="header-anchor" href="#_1-2-src-react-js"><span>1.2 src\\react.js</span></a></h3><p>src\\react.js</p><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code class="language-javascript"><span class="line"><span class="token keyword">import</span> <span class="token punctuation">{</span> <span class="token constant">ELEMENT_TEXT</span> <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&#39;./constants&#39;</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">function</span> <span class="token function">createElement</span><span class="token punctuation">(</span><span class="token parameter">type<span class="token punctuation">,</span> config<span class="token punctuation">,</span> <span class="token operator">...</span>children</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">delete</span> config<span class="token punctuation">.</span>__self<span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">delete</span> config<span class="token punctuation">.</span>__source<span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">return</span> <span class="token punctuation">{</span></span>
<span class="line">        type<span class="token punctuation">,</span></span>
<span class="line">        <span class="token literal-property property">props</span><span class="token operator">:</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token operator">...</span>config<span class="token punctuation">,</span></span>
<span class="line">            <span class="token literal-property property">children</span><span class="token operator">:</span> children<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span></span>
<span class="line">                <span class="token parameter">child</span> <span class="token operator">=&gt;</span> <span class="token keyword">typeof</span> child <span class="token operator">===</span> <span class="token string">&quot;object&quot;</span> <span class="token operator">?</span></span>
<span class="line">                    <span class="token literal-property property">child</span> <span class="token operator">:</span></span>
<span class="line">                    <span class="token punctuation">{</span> <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token constant">ELEMENT_TEXT</span><span class="token punctuation">,</span> <span class="token literal-property property">props</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token literal-property property">text</span><span class="token operator">:</span> child<span class="token punctuation">,</span> <span class="token literal-property property">children</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token punctuation">}</span> <span class="token punctuation">}</span><span class="token punctuation">)</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">let</span> React <span class="token operator">=</span> <span class="token punctuation">{</span></span>
<span class="line">    createElement</span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"><span class="token keyword">export</span> <span class="token keyword">default</span> React<span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="_2-实现初次渲染" tabindex="-1"><a class="header-anchor" href="#_2-实现初次渲染"><span>2.实现初次渲染</span></a></h2><p><img src="http://img.zhufengpeixun.cn/collecting2.jpg" alt="collecting2"></p><p><img src="http://img.zhufengpeixun.cn/fibereffectlistabc.png" alt="fibereffectlistabc"></p><p><img src="http://img.zhufengpeixun.cn/fibereffectlistwithchild3.jpg" alt="fibereffectlistwithchild3"></p><h3 id="_2-1-index-js" tabindex="-1"><a class="header-anchor" href="#_2-1-index-js"><span>2.1 index.js</span></a></h3><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text"><pre><code class="language-text"><span class="line">import React from &#39;./react&#39;;</span>
<span class="line">import ReactDOM from &#39;./react-dom&#39;;</span>
<span class="line">+let style = { border: &#39;3px solid red&#39;, margin: &#39;5px&#39; };</span>
<span class="line">+let element = (</span>
<span class="line">+  &lt;div  id=&quot;A1&quot; style={style}&gt;</span>
<span class="line">+    A1</span>
<span class="line">+    &lt;div  id=&quot;B1&quot; style={style}&gt;</span>
<span class="line">+      B1</span>
<span class="line">+        &lt;div  id=&quot;C1&quot; style={style}&gt;C1&lt;/div&gt;</span>
<span class="line">+      &lt;div  id=&quot;C2&quot; style={style}&gt;C2&lt;/div&gt;</span>
<span class="line">+    &lt;/div&gt;</span>
<span class="line">+    &lt;div  id=&quot;B2&quot; style={style}&gt;B2&lt;/div&gt;</span>
<span class="line">+  &lt;/div&gt;</span>
<span class="line">+)</span>
<span class="line">ReactDOM.render(</span>
<span class="line">  element,</span>
<span class="line">  document.getElementById(&#39;root&#39;)</span>
<span class="line">);</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_2-2-constants-js" tabindex="-1"><a class="header-anchor" href="#_2-2-constants-js"><span>2.2 constants.js</span></a></h3><p>src\\constants.js</p><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text"><pre><code class="language-text"><span class="line">+export const ELEMENT_TEXT = Symbol.for(&#39;ELEMENT_TEXT&#39;);</span>
<span class="line">+export const TAG_ROOT = Symbol.for(&#39;TAG_ROOT&#39;);</span>
<span class="line">+export const TAG_HOST = Symbol.for(&#39;TAG_HOST&#39;);</span>
<span class="line">+export const TAG_TEXT = Symbol.for(&#39;TAG_TEXT&#39;);</span>
<span class="line">+export const PLACEMENT = Symbol.for(&#39;PLACEMENT&#39;);</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_2-3-utils-js" tabindex="-1"><a class="header-anchor" href="#_2-3-utils-js"><span>2.3 utils.js</span></a></h3><p>src\\utils.js</p><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code class="language-javascript"><span class="line"><span class="token keyword">function</span> <span class="token function">setProp</span><span class="token punctuation">(</span><span class="token parameter">dom<span class="token punctuation">,</span> key<span class="token punctuation">,</span> value</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">^on</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">.</span><span class="token function">test</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        dom<span class="token punctuation">[</span>key<span class="token punctuation">.</span><span class="token function">toLowerCase</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">=</span> value<span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>key <span class="token operator">===</span> <span class="token string">&#39;style&#39;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">if</span> <span class="token punctuation">(</span>value<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> styleName <span class="token keyword">in</span> value<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">                <span class="token keyword">if</span> <span class="token punctuation">(</span>value<span class="token punctuation">.</span><span class="token function">hasOwnProperty</span><span class="token punctuation">(</span>styleName<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">                    dom<span class="token punctuation">.</span>style<span class="token punctuation">[</span>styleName<span class="token punctuation">]</span> <span class="token operator">=</span> value<span class="token punctuation">[</span>styleName<span class="token punctuation">]</span><span class="token punctuation">;</span></span>
<span class="line">                <span class="token punctuation">}</span></span>
<span class="line">            <span class="token punctuation">}</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span></span>
<span class="line">        dom<span class="token punctuation">.</span><span class="token function">setAttribute</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    <span class="token keyword">return</span> dom<span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"><span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">setProps</span><span class="token punctuation">(</span><span class="token parameter">elem<span class="token punctuation">,</span> oldProps<span class="token punctuation">,</span> newProps</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> key <span class="token keyword">in</span> oldProps<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">if</span> <span class="token punctuation">(</span>key <span class="token operator">!==</span> <span class="token string">&#39;children&#39;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token keyword">if</span> <span class="token punctuation">(</span>newProps<span class="token punctuation">.</span><span class="token function">hasOwnProperty</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">                <span class="token function">setProp</span><span class="token punctuation">(</span>elem<span class="token punctuation">,</span> key<span class="token punctuation">,</span> newProps<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span></span>
<span class="line">                elem<span class="token punctuation">.</span><span class="token function">removeAttribute</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">            <span class="token punctuation">}</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> key <span class="token keyword">in</span> newProps<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">if</span> <span class="token punctuation">(</span>key <span class="token operator">!==</span> <span class="token string">&#39;children&#39;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token function">setProp</span><span class="token punctuation">(</span>elem<span class="token punctuation">,</span> key<span class="token punctuation">,</span> newProps<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">)</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_2-4-react-dom-js" tabindex="-1"><a class="header-anchor" href="#_2-4-react-dom-js"><span>2.4 react-dom.js</span></a></h3><p>src\\react-dom.js</p><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code class="language-javascript"><span class="line"><span class="token keyword">import</span> <span class="token punctuation">{</span> <span class="token constant">TAG_ROOT</span> <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&#39;./constants&#39;</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">import</span> <span class="token punctuation">{</span> scheduleRoot <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&#39;./scheduler&#39;</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">function</span> <span class="token function">render</span><span class="token punctuation">(</span><span class="token parameter">element<span class="token punctuation">,</span> container</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">let</span> rootFiber <span class="token operator">=</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token literal-property property">tag</span><span class="token operator">:</span> <span class="token constant">TAG_ROOT</span><span class="token punctuation">,</span><span class="token comment">//这是根Fiber</span></span>
<span class="line">        <span class="token literal-property property">stateNode</span><span class="token operator">:</span> container<span class="token punctuation">,</span><span class="token comment">//此Fiber对应的DOM节点</span></span>
<span class="line">        <span class="token literal-property property">props</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token literal-property property">children</span><span class="token operator">:</span> <span class="token punctuation">[</span>element<span class="token punctuation">]</span> <span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token comment">//子元素就是要渲染的element</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    <span class="token function">scheduleRoot</span><span class="token punctuation">(</span>rootFiber<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token punctuation">{</span></span>
<span class="line">    render</span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_2-4-scheduler-js" tabindex="-1"><a class="header-anchor" href="#_2-4-scheduler-js"><span>2.4 scheduler.js</span></a></h3><p>src\\scheduler.js</p><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code class="language-javascript"><span class="line"><span class="token keyword">import</span> <span class="token punctuation">{</span> setProps <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&#39;./utils&#39;</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">import</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token constant">ELEMENT_TEXT</span><span class="token punctuation">,</span> <span class="token constant">TAG_ROOT</span><span class="token punctuation">,</span> <span class="token constant">TAG_HOST</span><span class="token punctuation">,</span> <span class="token constant">TAG_TEXT</span><span class="token punctuation">,</span> <span class="token constant">PLACEMENT</span></span>
<span class="line"><span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&#39;./constants&#39;</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">let</span> workInProgressRoot <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span><span class="token comment">//正在渲染中的根Fiber</span></span>
<span class="line"><span class="token keyword">let</span> nextUnitOfWork <span class="token operator">=</span> <span class="token keyword">null</span><span class="token comment">//下一个工作单元</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">scheduleRoot</span><span class="token punctuation">(</span><span class="token parameter">rootFiber</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token comment">//把当前树设置为nextUnitOfWork开始进行调度</span></span>
<span class="line">    workInProgressRoot <span class="token operator">=</span> rootFiber<span class="token punctuation">;</span></span>
<span class="line">    nextUnitOfWork <span class="token operator">=</span> workInProgressRoot<span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">function</span> <span class="token function">commitRoot</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">let</span> currentFiber <span class="token operator">=</span> workInProgressRoot<span class="token punctuation">.</span>firstEffect<span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">while</span> <span class="token punctuation">(</span>currentFiber<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token function">commitWork</span><span class="token punctuation">(</span>currentFiber<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        currentFiber <span class="token operator">=</span> currentFiber<span class="token punctuation">.</span>nextEffect<span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    workInProgressRoot <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"><span class="token keyword">function</span> <span class="token function">commitWork</span><span class="token punctuation">(</span><span class="token parameter">currentFiber</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>currentFiber<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">return</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    <span class="token keyword">let</span> returnFiber <span class="token operator">=</span> currentFiber<span class="token punctuation">.</span>return<span class="token punctuation">;</span><span class="token comment">//先获取父Fiber</span></span>
<span class="line">    <span class="token keyword">const</span> domReturn <span class="token operator">=</span> returnFiber<span class="token punctuation">.</span>stateNode<span class="token punctuation">;</span><span class="token comment">//获取父的DOM节点</span></span>
<span class="line">    <span class="token keyword">if</span> <span class="token punctuation">(</span>currentFiber<span class="token punctuation">.</span>effectTag <span class="token operator">===</span> <span class="token constant">PLACEMENT</span> <span class="token operator">&amp;&amp;</span> currentFiber<span class="token punctuation">.</span>stateNode <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token comment">//如果是新增DOM节点</span></span>
<span class="line">        <span class="token keyword">let</span> nextFiber <span class="token operator">=</span> currentFiber<span class="token punctuation">;</span></span>
<span class="line">        domReturn<span class="token punctuation">.</span><span class="token function">appendChild</span><span class="token punctuation">(</span>nextFiber<span class="token punctuation">.</span>stateNode<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    currentFiber<span class="token punctuation">.</span>effectTag <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">function</span> <span class="token function">performUnitOfWork</span><span class="token punctuation">(</span><span class="token parameter">currentFiber</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token function">beginWork</span><span class="token punctuation">(</span>currentFiber<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//开始渲染前的Fiber,就是把子元素变成子fiber</span></span>
<span class="line"></span>
<span class="line">    <span class="token keyword">if</span> <span class="token punctuation">(</span>currentFiber<span class="token punctuation">.</span>child<span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token comment">//如果子节点就返回第一个子节点</span></span>
<span class="line">        <span class="token keyword">return</span> currentFiber<span class="token punctuation">.</span>child<span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">    <span class="token keyword">while</span> <span class="token punctuation">(</span>currentFiber<span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token comment">//如果没有子节点说明当前节点已经完成了渲染工作</span></span>
<span class="line">        <span class="token function">completeUnitOfWork</span><span class="token punctuation">(</span>currentFiber<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//可以结束此fiber的渲染了 </span></span>
<span class="line">        <span class="token keyword">if</span> <span class="token punctuation">(</span>currentFiber<span class="token punctuation">.</span>sibling<span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token comment">//如果它有弟弟就返回弟弟</span></span>
<span class="line">            <span class="token keyword">return</span> currentFiber<span class="token punctuation">.</span>sibling<span class="token punctuation">;</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">        currentFiber <span class="token operator">=</span> currentFiber<span class="token punctuation">.</span>return<span class="token punctuation">;</span><span class="token comment">//如果没有弟弟让爸爸完成，然后找叔叔</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">function</span> <span class="token function">beginWork</span><span class="token punctuation">(</span><span class="token parameter">currentFiber</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">if</span> <span class="token punctuation">(</span>currentFiber<span class="token punctuation">.</span>tag <span class="token operator">===</span> <span class="token constant">TAG_ROOT</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token comment">//如果是根节点</span></span>
<span class="line">        <span class="token function">updateHostRoot</span><span class="token punctuation">(</span>currentFiber<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>currentFiber<span class="token punctuation">.</span>tag <span class="token operator">===</span> <span class="token constant">TAG_TEXT</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token comment">//如果是原生文本节点</span></span>
<span class="line">        <span class="token function">updateHostText</span><span class="token punctuation">(</span>currentFiber<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>currentFiber<span class="token punctuation">.</span>tag <span class="token operator">===</span> <span class="token constant">TAG_HOST</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token comment">//如果是原生DOM节点</span></span>
<span class="line">        <span class="token function">updateHostComponent</span><span class="token punctuation">(</span>currentFiber<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">function</span> <span class="token function">updateHostRoot</span><span class="token punctuation">(</span><span class="token parameter">currentFiber</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token comment">//如果是根节点</span></span>
<span class="line">    <span class="token keyword">const</span> newChildren <span class="token operator">=</span> currentFiber<span class="token punctuation">.</span>props<span class="token punctuation">.</span>children<span class="token punctuation">;</span><span class="token comment">//直接渲染子节点</span></span>
<span class="line">    <span class="token function">reconcileChildren</span><span class="token punctuation">(</span>currentFiber<span class="token punctuation">,</span> newChildren<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"><span class="token keyword">function</span> <span class="token function">updateHostText</span><span class="token punctuation">(</span><span class="token parameter">currentFiber</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>currentFiber<span class="token punctuation">.</span>stateNode<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        currentFiber<span class="token punctuation">.</span>stateNode <span class="token operator">=</span> <span class="token function">createDOM</span><span class="token punctuation">(</span>currentFiber<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//先创建真实的DOM节点</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"><span class="token keyword">function</span> <span class="token function">updateHostComponent</span><span class="token punctuation">(</span><span class="token parameter">currentFiber</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token comment">//如果是原生DOM节点</span></span>
<span class="line">    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>currentFiber<span class="token punctuation">.</span>stateNode<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        currentFiber<span class="token punctuation">.</span>stateNode <span class="token operator">=</span> <span class="token function">createDOM</span><span class="token punctuation">(</span>currentFiber<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//先创建真实的DOM节点</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    <span class="token keyword">const</span> newChildren <span class="token operator">=</span> currentFiber<span class="token punctuation">.</span>props<span class="token punctuation">.</span>children<span class="token punctuation">;</span></span>
<span class="line">    <span class="token function">reconcileChildren</span><span class="token punctuation">(</span>currentFiber<span class="token punctuation">,</span> newChildren<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"><span class="token keyword">function</span> <span class="token function">createDOM</span><span class="token punctuation">(</span><span class="token parameter">currentFiber</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">if</span> <span class="token punctuation">(</span>currentFiber<span class="token punctuation">.</span>type <span class="token operator">===</span> <span class="token constant">ELEMENT_TEXT</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">return</span> document<span class="token punctuation">.</span><span class="token function">createTextNode</span><span class="token punctuation">(</span>currentFiber<span class="token punctuation">.</span>props<span class="token punctuation">.</span>text<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    <span class="token keyword">const</span> stateNode <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span>currentFiber<span class="token punctuation">.</span>type<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token function">updateDOM</span><span class="token punctuation">(</span>stateNode<span class="token punctuation">,</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> currentFiber<span class="token punctuation">.</span>props<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">return</span> stateNode<span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">function</span> <span class="token function">reconcileChildren</span><span class="token punctuation">(</span><span class="token parameter">currentFiber<span class="token punctuation">,</span> newChildren</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">let</span> newChildIndex <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token comment">//新虚拟DOM数组中的索引</span></span>
<span class="line">    <span class="token keyword">let</span> prevSibling<span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">while</span> <span class="token punctuation">(</span>newChildIndex <span class="token operator">&lt;</span> newChildren<span class="token punctuation">.</span>length<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">const</span> newChild <span class="token operator">=</span> newChildren<span class="token punctuation">[</span>newChildIndex<span class="token punctuation">]</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">let</span> tag<span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">if</span> <span class="token punctuation">(</span>newChild <span class="token operator">&amp;&amp;</span> newChild<span class="token punctuation">.</span>type <span class="token operator">===</span> <span class="token constant">ELEMENT_TEXT</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">            tag <span class="token operator">=</span> <span class="token constant">TAG_TEXT</span><span class="token punctuation">;</span><span class="token comment">//文本</span></span>
<span class="line">        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>newChild <span class="token operator">&amp;&amp;</span> <span class="token keyword">typeof</span> newChild<span class="token punctuation">.</span>type <span class="token operator">===</span> <span class="token string">&#39;string&#39;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">            tag <span class="token operator">=</span> <span class="token constant">TAG_HOST</span><span class="token punctuation">;</span><span class="token comment">//原生DOM组件</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">        <span class="token keyword">let</span> newFiber <span class="token operator">=</span> <span class="token punctuation">{</span></span>
<span class="line">            tag<span class="token punctuation">,</span><span class="token comment">//原生DOM组件</span></span>
<span class="line">            <span class="token literal-property property">type</span><span class="token operator">:</span> newChild<span class="token punctuation">.</span>type<span class="token punctuation">,</span><span class="token comment">//具体的元素类型</span></span>
<span class="line">            <span class="token literal-property property">props</span><span class="token operator">:</span> newChild<span class="token punctuation">.</span>props<span class="token punctuation">,</span><span class="token comment">//新的属性对象</span></span>
<span class="line">            <span class="token literal-property property">stateNode</span><span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span><span class="token comment">//stateNode肯定是空的</span></span>
<span class="line">            <span class="token keyword">return</span><span class="token operator">:</span> currentFiber<span class="token punctuation">,</span><span class="token comment">//父Fiber</span></span>
<span class="line">            <span class="token literal-property property">effectTag</span><span class="token operator">:</span> <span class="token constant">PLACEMENT</span><span class="token punctuation">,</span><span class="token comment">//副作用标识</span></span>
<span class="line">            <span class="token literal-property property">nextEffect</span><span class="token operator">:</span> <span class="token keyword">null</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">        <span class="token keyword">if</span> <span class="token punctuation">(</span>newFiber<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token keyword">if</span> <span class="token punctuation">(</span>newChildIndex <span class="token operator">===</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">                currentFiber<span class="token punctuation">.</span>child <span class="token operator">=</span> newFiber<span class="token punctuation">;</span><span class="token comment">//第一个子节点挂到父节点的child属性上</span></span>
<span class="line">            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span></span>
<span class="line">                prevSibling<span class="token punctuation">.</span>sibling <span class="token operator">=</span> newFiber<span class="token punctuation">;</span></span>
<span class="line">            <span class="token punctuation">}</span></span>
<span class="line">            prevSibling <span class="token operator">=</span> newFiber<span class="token punctuation">;</span><span class="token comment">//然后newFiber变成了上一个哥哥了</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">        prevSibling <span class="token operator">=</span> newFiber<span class="token punctuation">;</span><span class="token comment">//然后newFiber变成了上一个哥哥了</span></span>
<span class="line">        newChildIndex<span class="token operator">++</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">function</span> <span class="token function">updateDOM</span><span class="token punctuation">(</span><span class="token parameter">stateNode<span class="token punctuation">,</span> oldProps<span class="token punctuation">,</span> newProps</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token function">setProps</span><span class="token punctuation">(</span>stateNode<span class="token punctuation">,</span> oldProps<span class="token punctuation">,</span> newProps<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"><span class="token keyword">function</span> <span class="token function">completeUnitOfWork</span><span class="token punctuation">(</span><span class="token parameter">currentFiber</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">const</span> returnFiber <span class="token operator">=</span> currentFiber<span class="token punctuation">.</span>return<span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">if</span> <span class="token punctuation">(</span>returnFiber<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>returnFiber<span class="token punctuation">.</span>firstEffect<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">            returnFiber<span class="token punctuation">.</span>firstEffect <span class="token operator">=</span> currentFiber<span class="token punctuation">.</span>firstEffect<span class="token punctuation">;</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token operator">!</span>currentFiber<span class="token punctuation">.</span>lastEffect<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token operator">!</span>returnFiber<span class="token punctuation">.</span>lastEffect<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">                returnFiber<span class="token punctuation">.</span>lastEffect<span class="token punctuation">.</span>nextEffect <span class="token operator">=</span> currentFiber<span class="token punctuation">.</span>firstEffect<span class="token punctuation">;</span></span>
<span class="line">            <span class="token punctuation">}</span></span>
<span class="line">            returnFiber<span class="token punctuation">.</span>lastEffect <span class="token operator">=</span> currentFiber<span class="token punctuation">.</span>lastEffect<span class="token punctuation">;</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">        <span class="token keyword">const</span> effectTag <span class="token operator">=</span> currentFiber<span class="token punctuation">.</span>effectTag<span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">if</span> <span class="token punctuation">(</span>effectTag<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token operator">!</span>returnFiber<span class="token punctuation">.</span>lastEffect<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">                returnFiber<span class="token punctuation">.</span>lastEffect<span class="token punctuation">.</span>nextEffect <span class="token operator">=</span> currentFiber<span class="token punctuation">;</span></span>
<span class="line">            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span></span>
<span class="line">                returnFiber<span class="token punctuation">.</span>firstEffect <span class="token operator">=</span> currentFiber<span class="token punctuation">;</span></span>
<span class="line">            <span class="token punctuation">}</span></span>
<span class="line">            returnFiber<span class="token punctuation">.</span>lastEffect <span class="token operator">=</span> currentFiber<span class="token punctuation">;</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">function</span> <span class="token function">workLoop</span><span class="token punctuation">(</span><span class="token parameter">deadline</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">let</span> shouldYield <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">while</span> <span class="token punctuation">(</span>nextUnitOfWork <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>shouldYield<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        nextUnitOfWork <span class="token operator">=</span> <span class="token function">performUnitOfWork</span><span class="token punctuation">(</span>nextUnitOfWork<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//执行一个任务并返回下一个任务</span></span>
<span class="line">        shouldYield <span class="token operator">=</span> deadline<span class="token punctuation">.</span><span class="token function">timeRemaining</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">1</span><span class="token punctuation">;</span><span class="token comment">//如果剩余时间小于1毫秒就说明没有时间了，需要把控制权让给浏览器</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    <span class="token comment">//如果没有下一个执行单元了，并且当前渲染树存在，则进行提交阶段</span></span>
<span class="line">    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>nextUnitOfWork <span class="token operator">&amp;&amp;</span> workInProgressRoot<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token function">commitRoot</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    <span class="token function">requestIdleCallback</span><span class="token punctuation">(</span>workLoop<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"><span class="token comment">//开始在空闲时间执行workLoop</span></span>
<span class="line"><span class="token function">requestIdleCallback</span><span class="token punctuation">(</span>workLoop<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="_3-实现元素的更新" tabindex="-1"><a class="header-anchor" href="#_3-实现元素的更新"><span>3.实现元素的更新</span></a></h2><p><img src="http://img.zhufengpeixun.cn/updatecomponent.jpg" alt="updatecomponent"></p><p><img src="http://img.zhufengpeixun.cn/alternate2.jpg" alt="alternate2"></p><h3 id="_3-1-public-index-html" tabindex="-1"><a class="header-anchor" href="#_3-1-public-index-html"><span>3.1 public\\index.html</span></a></h3><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code class="language-javascript"><span class="line"><span class="token operator">&lt;</span>body<span class="token operator">&gt;</span></span>
<span class="line">  <span class="token operator">&lt;</span>div id<span class="token operator">=</span><span class="token string">&quot;root&quot;</span><span class="token operator">&gt;</span><span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">&gt;</span></span>
<span class="line">  <span class="token operator">&lt;</span>button id<span class="token operator">=</span><span class="token string">&quot;reRender1&quot;</span><span class="token operator">&gt;</span>reRender1<span class="token operator">&lt;</span><span class="token operator">/</span>button<span class="token operator">&gt;</span></span>
<span class="line">  <span class="token operator">&lt;</span>button id<span class="token operator">=</span><span class="token string">&quot;reRender2&quot;</span><span class="token operator">&gt;</span>reRender2<span class="token operator">&lt;</span><span class="token operator">/</span>button<span class="token operator">&gt;</span></span>
<span class="line"><span class="token operator">&lt;</span><span class="token operator">/</span>body<span class="token operator">&gt;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_3-2-src-index-js" tabindex="-1"><a class="header-anchor" href="#_3-2-src-index-js"><span>3.2 src\\index.js</span></a></h3><p>src\\index.js</p><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text"><pre><code class="language-text"><span class="line">import React from &#39;./react&#39;;</span>
<span class="line">import ReactDOM from &#39;./react-dom&#39;;</span>
<span class="line">let style = { border: &#39;3px solid red&#39;, margin: &#39;5px&#39; };</span>
<span class="line">let element = (</span>
<span class="line">  &lt;div id=&quot;A1&quot; style={style}&gt;</span>
<span class="line">    A1</span>
<span class="line">    &lt;div id=&quot;B1&quot; style={style}&gt;</span>
<span class="line">      B1</span>
<span class="line">      &lt;div id=&quot;C1&quot; style={style}&gt;C1&lt;/div&gt;</span>
<span class="line">      &lt;div id=&quot;C2&quot; style={style}&gt;C2&lt;/div&gt;</span>
<span class="line">    &lt;/div&gt;</span>
<span class="line">    &lt;div id=&quot;B2&quot; style={style}&gt;B2&lt;/div&gt;</span>
<span class="line">  &lt;/div&gt;</span>
<span class="line">)</span>
<span class="line">console.log(element);</span>
<span class="line">ReactDOM.render(</span>
<span class="line">  element,</span>
<span class="line">  document.getElementById(&#39;root&#39;)</span>
<span class="line">);</span>
<span class="line"></span>
<span class="line">+let reRender2 = document.getElementById(&#39;reRender2&#39;);</span>
<span class="line">+reRender2.addEventListener(&#39;click&#39;, () =&gt; {</span>
<span class="line">+  let element2 = (</span>
<span class="line">+    &lt;div id=&quot;A1-new&quot; style={style}&gt;</span>
<span class="line">+      A1-new</span>
<span class="line">+      &lt;div id=&quot;B1-new&quot; style={style}&gt;</span>
<span class="line">+        B1-new</span>
<span class="line">+        &lt;div id=&quot;C1-new&quot; style={style}&gt;C1-new&lt;/div&gt;</span>
<span class="line">+        &lt;div id=&quot;C2-new&quot; style={style}&gt;C2-new&lt;/div&gt;</span>
<span class="line">+      &lt;/div&gt;</span>
<span class="line">+      &lt;div id=&quot;B2&quot; style={style}&gt;B2&lt;/div&gt;</span>
<span class="line">+      &lt;div id=&quot;B3&quot; style={style}&gt;B3&lt;/div&gt;</span>
<span class="line">+    &lt;/div&gt;</span>
<span class="line">+  )</span>
<span class="line">+  ReactDOM.render(</span>
<span class="line">+    element2,</span>
<span class="line">+    document.getElementById(&#39;root&#39;)</span>
<span class="line">+  );</span>
<span class="line">+});</span>
<span class="line">+</span>
<span class="line">+let reRender3 = document.getElementById(&#39;reRender3&#39;);</span>
<span class="line">+reRender3.addEventListener(&#39;click&#39;, () =&gt; {</span>
<span class="line">+  let element3 = (</span>
<span class="line">+    &lt;div id=&quot;A1-new2&quot; style={style}&gt;</span>
<span class="line">+      A1-new2</span>
<span class="line">+      &lt;div id=&quot;B1-new2&quot; style={style}&gt;</span>
<span class="line">+        B1-new2</span>
<span class="line">+        &lt;div id=&quot;C1-new2&quot; style={style}&gt;C1-new2&lt;/div&gt;</span>
<span class="line">+        &lt;div id=&quot;C2-new2&quot; style={style}&gt;C2-new2&lt;/div&gt;</span>
<span class="line">+      &lt;/div&gt;</span>
<span class="line">+      &lt;div id=&quot;B2&quot; style={style}&gt;B2&lt;/div&gt;</span>
<span class="line">+    &lt;/div&gt;</span>
<span class="line">+  )</span>
<span class="line">+  ReactDOM.render(</span>
<span class="line">+    element3,</span>
<span class="line">+    document.getElementById(&#39;root&#39;)</span>
<span class="line">+  );</span>
<span class="line">+});</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_3-3-src-constants-js" tabindex="-1"><a class="header-anchor" href="#_3-3-src-constants-js"><span>3.3 src\\constants.js</span></a></h3><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text"><pre><code class="language-text"><span class="line">export const ELEMENT_TEXT = Symbol.for(&#39;ELEMENT_TEXT&#39;);</span>
<span class="line"></span>
<span class="line">export const TAG_ROOT = Symbol.for(&#39;TAG_ROOT&#39;);</span>
<span class="line">export const TAG_HOST = Symbol.for(&#39;TAG_HOST&#39;);</span>
<span class="line">export const TAG_TEXT = Symbol.for(&#39;TAG_TEXT&#39;);</span>
<span class="line"></span>
<span class="line">export const PLACEMENT = Symbol.for(&#39;PLACEMENT&#39;);</span>
<span class="line">+export const UPDATE = Symbol.for(&#39;UPDATE&#39;);</span>
<span class="line">+export const DELETION = Symbol.for(&#39;DELETION&#39;);</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_3-4-scheduler-js" tabindex="-1"><a class="header-anchor" href="#_3-4-scheduler-js"><span>3.4 scheduler.js</span></a></h3><p>src\\scheduler.js</p><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code class="language-javascript"><span class="line"><span class="token keyword">import</span> <span class="token punctuation">{</span> setProps <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&#39;./utils&#39;</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">import</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token constant">ELEMENT_TEXT</span><span class="token punctuation">,</span> <span class="token constant">TAG_ROOT</span><span class="token punctuation">,</span> <span class="token constant">TAG_HOST</span><span class="token punctuation">,</span> <span class="token constant">TAG_TEXT</span><span class="token punctuation">,</span> <span class="token constant">PLACEMENT</span><span class="token punctuation">,</span> <span class="token constant">DELETION</span><span class="token punctuation">,</span> <span class="token constant">UPDATE</span></span>
<span class="line"><span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&#39;./constants&#39;</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token operator">+</span><span class="token keyword">let</span> currentRoot <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span><span class="token comment">//当前的根Fiber</span></span>
<span class="line"><span class="token keyword">let</span> workInProgressRoot <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span><span class="token comment">//正在渲染中的根Fiber</span></span>
<span class="line"><span class="token keyword">let</span> nextUnitOfWork <span class="token operator">=</span> <span class="token keyword">null</span><span class="token comment">//下一个工作单元</span></span>
<span class="line"><span class="token operator">+</span><span class="token keyword">let</span> deletions <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token comment">//要删除的fiber节点</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">scheduleRoot</span><span class="token punctuation">(</span><span class="token parameter">rootFiber</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token comment">//{tag:TAG_ROOT,stateNode:container,props: { children: [element] }}</span></span>
<span class="line"><span class="token operator">+</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>currentRoot <span class="token operator">&amp;&amp;</span> currentRoot<span class="token punctuation">.</span>alternate<span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token comment">//偶数次更新</span></span>
<span class="line"><span class="token operator">+</span>        workInProgressRoot <span class="token operator">=</span> currentRoot<span class="token punctuation">.</span>alternate<span class="token punctuation">;</span></span>
<span class="line"><span class="token operator">+</span>        workInProgressRoot<span class="token punctuation">.</span>firstEffect <span class="token operator">=</span> workInProgressRoot<span class="token punctuation">.</span>lastEffect <span class="token operator">=</span> workInProgressRoot<span class="token punctuation">.</span>nextEffect <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token operator">+</span>        workInProgressRoot<span class="token punctuation">.</span>props <span class="token operator">=</span> rootFiber<span class="token punctuation">.</span>props<span class="token punctuation">;</span></span>
<span class="line"><span class="token operator">+</span>        workInProgressRoot<span class="token punctuation">.</span>alternate <span class="token operator">=</span> currentRoot<span class="token punctuation">;</span></span>
<span class="line"><span class="token operator">+</span>    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>currentRoot<span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token comment">//奇数次更新</span></span>
<span class="line"><span class="token operator">+</span>        rootFiber<span class="token punctuation">.</span>alternate <span class="token operator">=</span> currentRoot<span class="token punctuation">;</span></span>
<span class="line"><span class="token operator">+</span>        workInProgressRoot <span class="token operator">=</span> rootFiber<span class="token punctuation">;</span></span>
<span class="line"><span class="token operator">+</span>    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span></span>
<span class="line"><span class="token operator">+</span>        workInProgressRoot <span class="token operator">=</span> rootFiber<span class="token punctuation">;</span><span class="token comment">//第一次渲染</span></span>
<span class="line"><span class="token operator">+</span>    <span class="token punctuation">}</span></span>
<span class="line">    nextUnitOfWork <span class="token operator">=</span> workInProgressRoot<span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">function</span> <span class="token function">commitRoot</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line"><span class="token operator">+</span>    deletions<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span>commitWork<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">let</span> currentFiber <span class="token operator">=</span> workInProgressRoot<span class="token punctuation">.</span>firstEffect<span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">while</span> <span class="token punctuation">(</span>currentFiber<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token function">commitWork</span><span class="token punctuation">(</span>currentFiber<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        currentFiber <span class="token operator">=</span> currentFiber<span class="token punctuation">.</span>nextEffect<span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"><span class="token operator">+</span>    deletions<span class="token punctuation">.</span>length <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token comment">//先把要删除的节点清空掉</span></span>
<span class="line"><span class="token operator">+</span>    currentRoot <span class="token operator">=</span> workInProgressRoot<span class="token punctuation">;</span></span>
<span class="line">    workInProgressRoot <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"><span class="token keyword">function</span> <span class="token function">commitWork</span><span class="token punctuation">(</span><span class="token parameter">currentFiber</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>currentFiber<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">return</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    <span class="token keyword">let</span> returnFiber <span class="token operator">=</span> currentFiber<span class="token punctuation">.</span>return<span class="token punctuation">;</span><span class="token comment">//先获取父Fiber</span></span>
<span class="line">    <span class="token keyword">const</span> domReturn <span class="token operator">=</span> returnFiber<span class="token punctuation">.</span>stateNode<span class="token punctuation">;</span><span class="token comment">//获取父的DOM节点</span></span>
<span class="line">    <span class="token keyword">if</span> <span class="token punctuation">(</span>currentFiber<span class="token punctuation">.</span>effectTag <span class="token operator">===</span> <span class="token constant">PLACEMENT</span> <span class="token operator">&amp;&amp;</span> currentFiber<span class="token punctuation">.</span>stateNode <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token comment">//如果是新增DOM节点</span></span>
<span class="line">        <span class="token keyword">let</span> nextFiber <span class="token operator">=</span> currentFiber<span class="token punctuation">;</span></span>
<span class="line">        domReturn<span class="token punctuation">.</span><span class="token function">appendChild</span><span class="token punctuation">(</span>nextFiber<span class="token punctuation">.</span>stateNode<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token operator">+</span>    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>currentFiber<span class="token punctuation">.</span>effectTag <span class="token operator">===</span> <span class="token constant">DELETION</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token comment">//如果是删除则删除并返回</span></span>
<span class="line"><span class="token operator">+</span>        domReturn<span class="token punctuation">.</span><span class="token function">removeChild</span><span class="token punctuation">(</span>currentFiber<span class="token punctuation">.</span>stateNode<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token operator">+</span>    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>currentFiber<span class="token punctuation">.</span>effectTag <span class="token operator">===</span> <span class="token constant">UPDATE</span> <span class="token operator">&amp;&amp;</span> currentFiber<span class="token punctuation">.</span>stateNode <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token comment">//如果是更新</span></span>
<span class="line"><span class="token operator">+</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>currentFiber<span class="token punctuation">.</span>type <span class="token operator">===</span> <span class="token constant">ELEMENT_TEXT</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line"><span class="token operator">+</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span>currentFiber<span class="token punctuation">.</span>alternate<span class="token punctuation">.</span>props<span class="token punctuation">.</span>text <span class="token operator">!=</span> currentFiber<span class="token punctuation">.</span>props<span class="token punctuation">.</span>text<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line"><span class="token operator">+</span>                currentFiber<span class="token punctuation">.</span>stateNode<span class="token punctuation">.</span>textContent <span class="token operator">=</span> currentFiber<span class="token punctuation">.</span>props<span class="token punctuation">.</span>text<span class="token punctuation">;</span></span>
<span class="line"><span class="token operator">+</span>            <span class="token punctuation">}</span></span>
<span class="line"><span class="token operator">+</span>        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span></span>
<span class="line"><span class="token operator">+</span>            <span class="token function">updateDOM</span><span class="token punctuation">(</span>currentFiber<span class="token punctuation">.</span>stateNode<span class="token punctuation">,</span> currentFiber<span class="token punctuation">.</span>alternate<span class="token punctuation">.</span>props<span class="token punctuation">,</span> currentFiber<span class="token punctuation">.</span>props<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token operator">+</span>        <span class="token punctuation">}</span></span>
<span class="line"><span class="token operator">+</span>    <span class="token punctuation">}</span></span>
<span class="line">    currentFiber<span class="token punctuation">.</span>effectTag <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">function</span> <span class="token function">performUnitOfWork</span><span class="token punctuation">(</span><span class="token parameter">currentFiber</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token function">beginWork</span><span class="token punctuation">(</span>currentFiber<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//开始渲染前的Fiber,就是把子元素变成子fiber</span></span>
<span class="line"></span>
<span class="line">    <span class="token keyword">if</span> <span class="token punctuation">(</span>currentFiber<span class="token punctuation">.</span>child<span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token comment">//如果子节点就返回第一个子节点</span></span>
<span class="line">        <span class="token keyword">return</span> currentFiber<span class="token punctuation">.</span>child<span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">    <span class="token keyword">while</span> <span class="token punctuation">(</span>currentFiber<span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token comment">//如果没有子节点说明当前节点已经完成了渲染工作</span></span>
<span class="line">        <span class="token function">completeUnitOfWork</span><span class="token punctuation">(</span>currentFiber<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//可以结束此fiber的渲染了 </span></span>
<span class="line">        <span class="token keyword">if</span> <span class="token punctuation">(</span>currentFiber<span class="token punctuation">.</span>sibling<span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token comment">//如果它有弟弟就返回弟弟</span></span>
<span class="line">            <span class="token keyword">return</span> currentFiber<span class="token punctuation">.</span>sibling<span class="token punctuation">;</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">        currentFiber <span class="token operator">=</span> currentFiber<span class="token punctuation">.</span>return<span class="token punctuation">;</span><span class="token comment">//如果没有弟弟让爸爸完成，然后找叔叔</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">function</span> <span class="token function">beginWork</span><span class="token punctuation">(</span><span class="token parameter">currentFiber</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">if</span> <span class="token punctuation">(</span>currentFiber<span class="token punctuation">.</span>tag <span class="token operator">===</span> <span class="token constant">TAG_ROOT</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token comment">//如果是根节点</span></span>
<span class="line">        <span class="token function">updateHostRoot</span><span class="token punctuation">(</span>currentFiber<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>currentFiber<span class="token punctuation">.</span>tag <span class="token operator">===</span> <span class="token constant">TAG_TEXT</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token comment">//如果是原生文本节点</span></span>
<span class="line">        <span class="token function">updateHostText</span><span class="token punctuation">(</span>currentFiber<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>currentFiber<span class="token punctuation">.</span>tag <span class="token operator">===</span> <span class="token constant">TAG_HOST</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token comment">//如果是原生DOM节点</span></span>
<span class="line">        <span class="token function">updateHostComponent</span><span class="token punctuation">(</span>currentFiber<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"><span class="token keyword">function</span> <span class="token function">updateHostRoot</span><span class="token punctuation">(</span><span class="token parameter">currentFiber</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token comment">//如果是根节点</span></span>
<span class="line">    <span class="token keyword">const</span> newChildren <span class="token operator">=</span> currentFiber<span class="token punctuation">.</span>props<span class="token punctuation">.</span>children<span class="token punctuation">;</span><span class="token comment">//直接渲染子节点</span></span>
<span class="line">    <span class="token function">reconcileChildren</span><span class="token punctuation">(</span>currentFiber<span class="token punctuation">,</span> newChildren<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"><span class="token keyword">function</span> <span class="token function">updateHostText</span><span class="token punctuation">(</span><span class="token parameter">currentFiber</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>currentFiber<span class="token punctuation">.</span>stateNode<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        currentFiber<span class="token punctuation">.</span>stateNode <span class="token operator">=</span> <span class="token function">createDOM</span><span class="token punctuation">(</span>currentFiber<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//先创建真实的DOM节点</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"><span class="token keyword">function</span> <span class="token function">updateHostComponent</span><span class="token punctuation">(</span><span class="token parameter">currentFiber</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token comment">//如果是原生DOM节点</span></span>
<span class="line">    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>currentFiber<span class="token punctuation">.</span>stateNode<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        currentFiber<span class="token punctuation">.</span>stateNode <span class="token operator">=</span> <span class="token function">createDOM</span><span class="token punctuation">(</span>currentFiber<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//先创建真实的DOM节点</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    <span class="token keyword">const</span> newChildren <span class="token operator">=</span> currentFiber<span class="token punctuation">.</span>props<span class="token punctuation">.</span>children<span class="token punctuation">;</span></span>
<span class="line">    <span class="token function">reconcileChildren</span><span class="token punctuation">(</span>currentFiber<span class="token punctuation">,</span> newChildren<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"><span class="token keyword">function</span> <span class="token function">createDOM</span><span class="token punctuation">(</span><span class="token parameter">currentFiber</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">if</span> <span class="token punctuation">(</span>currentFiber<span class="token punctuation">.</span>type <span class="token operator">===</span> <span class="token constant">ELEMENT_TEXT</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">return</span> document<span class="token punctuation">.</span><span class="token function">createTextNode</span><span class="token punctuation">(</span>currentFiber<span class="token punctuation">.</span>props<span class="token punctuation">.</span>text<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    <span class="token keyword">const</span> stateNode <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span>currentFiber<span class="token punctuation">.</span>type<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token function">updateDOM</span><span class="token punctuation">(</span>stateNode<span class="token punctuation">,</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> currentFiber<span class="token punctuation">.</span>props<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">return</span> stateNode<span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">function</span> <span class="token function">reconcileChildren</span><span class="token punctuation">(</span><span class="token parameter">currentFiber<span class="token punctuation">,</span> newChildren</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">let</span> newChildIndex <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token comment">//新虚拟DOM数组中的索引</span></span>
<span class="line"><span class="token operator">+</span>    <span class="token keyword">let</span> oldFiber <span class="token operator">=</span> currentFiber<span class="token punctuation">.</span>alternate <span class="token operator">&amp;&amp;</span> currentFiber<span class="token punctuation">.</span>alternate<span class="token punctuation">.</span>child<span class="token punctuation">;</span><span class="token comment">//父Fiber中的第一个子Fiber</span></span>
<span class="line"><span class="token operator">+</span>    <span class="token keyword">let</span> prevSibling<span class="token punctuation">;</span></span>
<span class="line"><span class="token operator">+</span>    <span class="token keyword">while</span> <span class="token punctuation">(</span>newChildIndex <span class="token operator">&lt;</span> newChildren<span class="token punctuation">.</span>length <span class="token operator">||</span> oldFiber<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line"><span class="token operator">+</span>        <span class="token keyword">const</span> newChild <span class="token operator">=</span> newChildren<span class="token punctuation">[</span>newChildIndex<span class="token punctuation">]</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token operator">+</span>        <span class="token keyword">let</span> newFiber<span class="token punctuation">;</span></span>
<span class="line"><span class="token operator">+</span>        <span class="token keyword">const</span> sameType <span class="token operator">=</span> oldFiber <span class="token operator">&amp;&amp;</span> newChild <span class="token operator">&amp;&amp;</span> newChild<span class="token punctuation">.</span>type <span class="token operator">===</span> oldFiber<span class="token punctuation">.</span>type<span class="token punctuation">;</span><span class="token comment">//新旧都有，并且元素类型一样</span></span>
<span class="line"><span class="token operator">+</span>        <span class="token keyword">let</span> tag<span class="token punctuation">;</span></span>
<span class="line"><span class="token operator">+</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>newChild <span class="token operator">&amp;&amp;</span> newChild<span class="token punctuation">.</span>type <span class="token operator">===</span> <span class="token constant">ELEMENT_TEXT</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line"><span class="token operator">+</span>            tag <span class="token operator">=</span> <span class="token constant">TAG_TEXT</span><span class="token punctuation">;</span><span class="token comment">//文本</span></span>
<span class="line"><span class="token operator">+</span>        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>newChild <span class="token operator">&amp;&amp;</span> <span class="token keyword">typeof</span> newChild<span class="token punctuation">.</span>type <span class="token operator">===</span> <span class="token string">&#39;string&#39;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line"><span class="token operator">+</span>            tag <span class="token operator">=</span> <span class="token constant">TAG_HOST</span><span class="token punctuation">;</span><span class="token comment">//原生DOM组件</span></span>
<span class="line"><span class="token operator">+</span>        <span class="token punctuation">}</span></span>
<span class="line"><span class="token operator">+</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>sameType<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line"><span class="token operator">+</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span>oldFiber<span class="token punctuation">.</span>alternate<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line"><span class="token operator">+</span>                newFiber <span class="token operator">=</span> oldFiber<span class="token punctuation">.</span>alternate<span class="token punctuation">;</span></span>
<span class="line"><span class="token operator">+</span>                newFiber<span class="token punctuation">.</span>props <span class="token operator">=</span> newChild<span class="token punctuation">.</span>props<span class="token punctuation">;</span></span>
<span class="line"><span class="token operator">+</span>                newFiber<span class="token punctuation">.</span>alternate <span class="token operator">=</span> oldFiber<span class="token punctuation">;</span></span>
<span class="line"><span class="token operator">+</span>                newFiber<span class="token punctuation">.</span>effectTag <span class="token operator">=</span> <span class="token constant">UPDATE</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token operator">+</span>                newFiber<span class="token punctuation">.</span>nextEffect <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token operator">+</span>            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span></span>
<span class="line"><span class="token operator">+</span>                newFiber <span class="token operator">=</span> <span class="token punctuation">{</span></span>
<span class="line"><span class="token operator">+</span>                    tag<span class="token operator">:</span>oldFiber<span class="token punctuation">.</span>tag<span class="token punctuation">,</span><span class="token comment">//标记Fiber类型，例如是函数组件或者原生组件</span></span>
<span class="line"><span class="token operator">+</span>                    type<span class="token operator">:</span> oldFiber<span class="token punctuation">.</span>type<span class="token punctuation">,</span><span class="token comment">//具体的元素类型</span></span>
<span class="line"><span class="token operator">+</span>                    props<span class="token operator">:</span> newChild<span class="token punctuation">.</span>props<span class="token punctuation">,</span><span class="token comment">//新的属性对象</span></span>
<span class="line"><span class="token operator">+</span>                    stateNode<span class="token operator">:</span> oldFiber<span class="token punctuation">.</span>stateNode<span class="token punctuation">,</span><span class="token comment">//原生组件的话就存放DOM节点，类组件的话是类组件实例，函数组件的话为空，因为没有实例</span></span>
<span class="line"><span class="token operator">+</span>                    <span class="token keyword">return</span><span class="token operator">:</span> currentFiber<span class="token punctuation">,</span><span class="token comment">//父Fiber</span></span>
<span class="line"><span class="token operator">+</span>                    alternate<span class="token operator">:</span> oldFiber<span class="token punctuation">,</span><span class="token comment">//上一个Fiber 指向旧树中的节点</span></span>
<span class="line"><span class="token operator">+</span>                    effectTag<span class="token operator">:</span> <span class="token constant">UPDATE</span><span class="token punctuation">,</span><span class="token comment">//副作用标识</span></span>
<span class="line"><span class="token operator">+</span>                    nextEffect<span class="token operator">:</span> <span class="token keyword">null</span> <span class="token comment">//React 同样使用链表来将所有有副作用的Fiber连接起来</span></span>
<span class="line"><span class="token operator">+</span>                <span class="token punctuation">}</span></span>
<span class="line"><span class="token operator">+</span>            <span class="token punctuation">}</span></span>
<span class="line"><span class="token operator">+</span>        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span></span>
<span class="line"><span class="token operator">+</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span>newChild<span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token comment">//类型不一样，创建新的Fiber,旧的不复用了</span></span>
<span class="line"><span class="token operator">+</span>                newFiber <span class="token operator">=</span> <span class="token punctuation">{</span></span>
<span class="line"><span class="token operator">+</span>                    tag<span class="token punctuation">,</span><span class="token comment">//原生DOM组件</span></span>
<span class="line"><span class="token operator">+</span>                    type<span class="token operator">:</span> newChild<span class="token punctuation">.</span>type<span class="token punctuation">,</span><span class="token comment">//具体的元素类型</span></span>
<span class="line"><span class="token operator">+</span>                    props<span class="token operator">:</span> newChild<span class="token punctuation">.</span>props<span class="token punctuation">,</span><span class="token comment">//新的属性对象</span></span>
<span class="line"><span class="token operator">+</span>                    stateNode<span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span><span class="token comment">//stateNode肯定是空的</span></span>
<span class="line"><span class="token operator">+</span>                    <span class="token keyword">return</span><span class="token operator">:</span> currentFiber<span class="token punctuation">,</span><span class="token comment">//父Fiber</span></span>
<span class="line"><span class="token operator">+</span>                    effectTag<span class="token operator">:</span> <span class="token constant">PLACEMENT</span><span class="token comment">//副作用标识</span></span>
<span class="line"><span class="token operator">+</span>                <span class="token punctuation">}</span></span>
<span class="line"><span class="token operator">+</span>            <span class="token punctuation">}</span></span>
<span class="line"><span class="token operator">+</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span>oldFiber<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line"><span class="token operator">+</span>                oldFiber<span class="token punctuation">.</span>effectTag <span class="token operator">=</span> <span class="token constant">DELETION</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token operator">+</span>                deletions<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>oldFiber<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token operator">+</span>            <span class="token punctuation">}</span></span>
<span class="line"><span class="token operator">+</span>        <span class="token punctuation">}</span></span>
<span class="line"><span class="token operator">+</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>oldFiber<span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token comment">//比较完一个元素了，老Fiber向后移动1位</span></span>
<span class="line"><span class="token operator">+</span>            oldFiber <span class="token operator">=</span> oldFiber<span class="token punctuation">.</span>sibling<span class="token punctuation">;</span></span>
<span class="line"><span class="token operator">+</span>        <span class="token punctuation">}</span></span>
<span class="line">       <span class="token keyword">if</span> <span class="token punctuation">(</span>newFiber<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token keyword">if</span> <span class="token punctuation">(</span>newChildIndex <span class="token operator">===</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">                currentFiber<span class="token punctuation">.</span>child <span class="token operator">=</span> newFiber<span class="token punctuation">;</span><span class="token comment">//第一个子节点挂到父节点的child属性上</span></span>
<span class="line">            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span></span>
<span class="line">                prevSibling<span class="token punctuation">.</span>sibling <span class="token operator">=</span> newFiber<span class="token punctuation">;</span></span>
<span class="line">            <span class="token punctuation">}</span></span>
<span class="line">            prevSibling <span class="token operator">=</span> newFiber<span class="token punctuation">;</span><span class="token comment">//然后newFiber变成了上一个哥哥了</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">        prevSibling <span class="token operator">=</span> newFiber<span class="token punctuation">;</span><span class="token comment">//然后newFiber变成了上一个哥哥了</span></span>
<span class="line">        newChildIndex<span class="token operator">++</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">function</span> <span class="token function">updateDOM</span><span class="token punctuation">(</span><span class="token parameter">stateNode<span class="token punctuation">,</span> oldProps<span class="token punctuation">,</span> newProps</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token function">setProps</span><span class="token punctuation">(</span>stateNode<span class="token punctuation">,</span> oldProps<span class="token punctuation">,</span> newProps<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"><span class="token keyword">function</span> <span class="token function">completeUnitOfWork</span><span class="token punctuation">(</span><span class="token parameter">currentFiber</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">const</span> returnFiber <span class="token operator">=</span> currentFiber<span class="token punctuation">.</span>return<span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">if</span> <span class="token punctuation">(</span>returnFiber<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>returnFiber<span class="token punctuation">.</span>firstEffect<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">            returnFiber<span class="token punctuation">.</span>firstEffect <span class="token operator">=</span> currentFiber<span class="token punctuation">.</span>firstEffect<span class="token punctuation">;</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token operator">!</span>currentFiber<span class="token punctuation">.</span>lastEffect<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token operator">!</span>returnFiber<span class="token punctuation">.</span>lastEffect<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">                returnFiber<span class="token punctuation">.</span>lastEffect<span class="token punctuation">.</span>nextEffect <span class="token operator">=</span> currentFiber<span class="token punctuation">.</span>firstEffect<span class="token punctuation">;</span></span>
<span class="line">            <span class="token punctuation">}</span></span>
<span class="line">            returnFiber<span class="token punctuation">.</span>lastEffect <span class="token operator">=</span> currentFiber<span class="token punctuation">.</span>lastEffect<span class="token punctuation">;</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">        <span class="token keyword">const</span> effectTag <span class="token operator">=</span> currentFiber<span class="token punctuation">.</span>effectTag<span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">if</span> <span class="token punctuation">(</span>effectTag<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token operator">!</span>returnFiber<span class="token punctuation">.</span>lastEffect<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">                returnFiber<span class="token punctuation">.</span>lastEffect<span class="token punctuation">.</span>nextEffect <span class="token operator">=</span> currentFiber<span class="token punctuation">;</span></span>
<span class="line">            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span></span>
<span class="line">                returnFiber<span class="token punctuation">.</span>firstEffect <span class="token operator">=</span> currentFiber<span class="token punctuation">;</span></span>
<span class="line">            <span class="token punctuation">}</span></span>
<span class="line">            returnFiber<span class="token punctuation">.</span>lastEffect <span class="token operator">=</span> currentFiber<span class="token punctuation">;</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">function</span> <span class="token function">workLoop</span><span class="token punctuation">(</span><span class="token parameter">deadline</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">let</span> shouldYield <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">while</span> <span class="token punctuation">(</span>nextUnitOfWork <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>shouldYield<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        nextUnitOfWork <span class="token operator">=</span> <span class="token function">performUnitOfWork</span><span class="token punctuation">(</span>nextUnitOfWork<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//执行一个任务并返回下一个任务</span></span>
<span class="line">        shouldYield <span class="token operator">=</span> deadline<span class="token punctuation">.</span><span class="token function">timeRemaining</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">1</span><span class="token punctuation">;</span><span class="token comment">//如果剩余时间小于1毫秒就说明没有时间了，需要把控制权让给浏览器</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    <span class="token comment">//如果没有下一个执行单元了，并且当前渲染树存在，则进行提交阶段</span></span>
<span class="line">    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>nextUnitOfWork <span class="token operator">&amp;&amp;</span> workInProgressRoot<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token function">commitRoot</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    <span class="token function">requestIdleCallback</span><span class="token punctuation">(</span>workLoop<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"><span class="token comment">//开始在空闲时间执行workLoop</span></span>
<span class="line"><span class="token function">requestIdleCallback</span><span class="token punctuation">(</span>workLoop<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="_4-实现类组件" tabindex="-1"><a class="header-anchor" href="#_4-实现类组件"><span>4.实现类组件</span></a></h2><p><img src="http://img.zhufengpeixun.cn/singlelink2.jpg" alt="singlelink2"></p><p><img src="http://img.zhufengpeixun.cn/fiberdoublebuffer.jpg" alt="fiberdoublebuffer"></p><h3 id="_4-1-src-index-js" tabindex="-1"><a class="header-anchor" href="#_4-1-src-index-js"><span>4.1 src\\index.js</span></a></h3><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text"><pre><code class="language-text"><span class="line">import React from &#39;./react&#39;;</span>
<span class="line">import ReactDOM from &#39;./react-dom&#39;;</span>
<span class="line">+class ClassCounter extends React.Component {</span>
<span class="line">+  constructor(props) {</span>
<span class="line">+    super(props);</span>
<span class="line">+    this.state = { number: 0 };</span>
<span class="line">+  }</span>
<span class="line">+  onClick = () =&gt; {</span>
<span class="line">+    this.setState(state =&gt; ({ number: state.number + 1 }));</span>
<span class="line">+  }</span>
<span class="line">+  render() {</span>
<span class="line">+    return (</span>
<span class="line">+      &lt;div id=&quot;counter&quot;&gt;</span>
<span class="line">+        &lt;span&gt;{this.state.number}&lt;/span&gt;</span>
<span class="line">+        &lt;button onClick={this.onClick}&gt;加1&lt;/button&gt;</span>
<span class="line">+      &lt;/div &gt;</span>
<span class="line">+    )</span>
<span class="line">+  }</span>
<span class="line">+}</span>
<span class="line">ReactDOM.render(</span>
<span class="line">+  &lt;ClassCounter /&gt;,</span>
<span class="line">  document.getElementById(&#39;root&#39;)</span>
<span class="line">);</span>
<span class="line"></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_4-2-src-react-js" tabindex="-1"><a class="header-anchor" href="#_4-2-src-react-js"><span>4.2 src\\react.js</span></a></h3><p>src\\react.js</p><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code class="language-javascript"><span class="line"><span class="token keyword">import</span> <span class="token punctuation">{</span> <span class="token constant">ELEMENT_TEXT</span> <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&#39;./constants&#39;</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token operator">+</span><span class="token keyword">import</span> <span class="token punctuation">{</span> Update<span class="token punctuation">,</span> UpdateQueue <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&#39;./updateQueue&#39;</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token operator">+</span><span class="token keyword">import</span> <span class="token punctuation">{</span> scheduleRoot <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&#39;./scheduler&#39;</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">function</span> <span class="token function">createElement</span><span class="token punctuation">(</span><span class="token parameter">type<span class="token punctuation">,</span> config<span class="token punctuation">,</span> <span class="token operator">...</span>children</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">delete</span> config<span class="token punctuation">.</span>__self<span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">delete</span> config<span class="token punctuation">.</span>__source<span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">return</span> <span class="token punctuation">{</span></span>
<span class="line">        type<span class="token punctuation">,</span></span>
<span class="line">        <span class="token literal-property property">props</span><span class="token operator">:</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token operator">...</span>config<span class="token punctuation">,</span></span>
<span class="line">            <span class="token literal-property property">children</span><span class="token operator">:</span> children<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span></span>
<span class="line">                <span class="token parameter">child</span> <span class="token operator">=&gt;</span> <span class="token keyword">typeof</span> child <span class="token operator">===</span> <span class="token string">&quot;object&quot;</span> <span class="token operator">?</span></span>
<span class="line">                    <span class="token literal-property property">child</span> <span class="token operator">:</span></span>
<span class="line">                    <span class="token punctuation">{</span> <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token constant">ELEMENT_TEXT</span><span class="token punctuation">,</span> <span class="token literal-property property">props</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token literal-property property">text</span><span class="token operator">:</span> child<span class="token punctuation">,</span> <span class="token literal-property property">children</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token punctuation">}</span> <span class="token punctuation">}</span><span class="token punctuation">)</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"><span class="token operator">+</span><span class="token keyword">class</span> <span class="token class-name">Component</span> <span class="token punctuation">{</span></span>
<span class="line"><span class="token operator">+</span>    <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter">props</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line"><span class="token operator">+</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>props <span class="token operator">=</span> props<span class="token punctuation">;</span></span>
<span class="line"><span class="token operator">+</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>updateQueue <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">UpdateQueue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token operator">+</span>    <span class="token punctuation">}</span></span>
<span class="line"><span class="token operator">+</span>    <span class="token function">setState</span><span class="token punctuation">(</span><span class="token parameter">payload</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line"><span class="token operator">+</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>internalFiber<span class="token punctuation">.</span>updateQueue<span class="token punctuation">.</span><span class="token function">enqueueUpdate</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Update</span><span class="token punctuation">(</span>payload<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token operator">+</span>        <span class="token function">scheduleRoot</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token operator">+</span>    <span class="token punctuation">}</span></span>
<span class="line"><span class="token operator">+</span><span class="token punctuation">}</span></span>
<span class="line"><span class="token operator">+</span><span class="token class-name">Component</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span>isReactComponent <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">let</span> React <span class="token operator">=</span> <span class="token punctuation">{</span></span>
<span class="line">    createElement<span class="token punctuation">,</span></span>
<span class="line"><span class="token operator">+</span>    Component</span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"><span class="token keyword">export</span> <span class="token keyword">default</span> React<span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_4-3-constants-js" tabindex="-1"><a class="header-anchor" href="#_4-3-constants-js"><span>4.3 constants.js</span></a></h3><p>src\\constants.js</p><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text"><pre><code class="language-text"><span class="line">export const ELEMENT_TEXT = Symbol.for(&#39;ELEMENT_TEXT&#39;);</span>
<span class="line"></span>
<span class="line">export const TAG_ROOT = Symbol.for(&#39;TAG_ROOT&#39;);</span>
<span class="line">export const TAG_HOST = Symbol.for(&#39;TAG_HOST&#39;);</span>
<span class="line">export const TAG_TEXT = Symbol.for(&#39;TAG_TEXT&#39;);</span>
<span class="line">+export const TAG_CLASS = Symbol.for(&#39;TAG_CLASS&#39;);</span>
<span class="line"></span>
<span class="line">export const UPDATE = Symbol.for(&#39;UPDATE&#39;);</span>
<span class="line">export const PLACEMENT = Symbol.for(&#39;PLACEMENT&#39;);</span>
<span class="line">export const DELETION = Symbol.for(&#39;DELETION&#39;);</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_4-4-updatequeue-js" tabindex="-1"><a class="header-anchor" href="#_4-4-updatequeue-js"><span>4.4 updateQueue.js</span></a></h3><p>src\\updateQueue.js</p><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code class="language-javascript"><span class="line"><span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">Update</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter">payload</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">this</span><span class="token punctuation">.</span>payload <span class="token operator">=</span> payload<span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"><span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">UpdateQueue</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">this</span><span class="token punctuation">.</span>firstUpdate <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">this</span><span class="token punctuation">.</span>lastUpdate <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    <span class="token function">enqueueUpdate</span><span class="token punctuation">(</span><span class="token parameter">update</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>lastUpdate <span class="token operator">===</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token keyword">this</span><span class="token punctuation">.</span>firstUpdate <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>lastUpdate <span class="token operator">=</span> update<span class="token punctuation">;</span></span>
<span class="line">        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token keyword">this</span><span class="token punctuation">.</span>lastUpdate<span class="token punctuation">.</span>nextUpdate <span class="token operator">=</span> update<span class="token punctuation">;</span></span>
<span class="line">            <span class="token keyword">this</span><span class="token punctuation">.</span>lastUpdate <span class="token operator">=</span> update<span class="token punctuation">;</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    <span class="token function">forceUpdate</span><span class="token punctuation">(</span><span class="token parameter">state</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">let</span> currentUpdate <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>firstUpdate<span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">while</span> <span class="token punctuation">(</span>currentUpdate<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">            state <span class="token operator">=</span> <span class="token keyword">typeof</span> currentUpdate<span class="token punctuation">.</span>payload <span class="token operator">==</span> <span class="token string">&#39;function&#39;</span> <span class="token operator">?</span> currentUpdate<span class="token punctuation">.</span><span class="token function">payload</span><span class="token punctuation">(</span>state<span class="token punctuation">)</span> <span class="token operator">:</span> currentUpdate<span class="token punctuation">.</span>payload<span class="token punctuation">;</span></span>
<span class="line">            currentUpdate <span class="token operator">=</span> currentUpdate<span class="token punctuation">.</span>nextUpdate<span class="token punctuation">;</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">        <span class="token keyword">this</span><span class="token punctuation">.</span>firstUpdate <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>lastUpdate <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">return</span> state<span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_4-5-utils-js" tabindex="-1"><a class="header-anchor" href="#_4-5-utils-js"><span>4.5 utils.js</span></a></h3><p>src\\utils.js</p><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code class="language-javascript"><span class="line"><span class="token keyword">function</span> <span class="token function">setProp</span><span class="token punctuation">(</span><span class="token parameter">dom<span class="token punctuation">,</span> key<span class="token punctuation">,</span> value</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">^on</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">.</span><span class="token function">test</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        dom<span class="token punctuation">[</span>key<span class="token punctuation">.</span><span class="token function">toLowerCase</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">=</span> value<span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>key <span class="token operator">===</span> <span class="token string">&#39;style&#39;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">if</span> <span class="token punctuation">(</span>value<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> styleName <span class="token keyword">in</span> value<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">                <span class="token keyword">if</span> <span class="token punctuation">(</span>value<span class="token punctuation">.</span><span class="token function">hasOwnProperty</span><span class="token punctuation">(</span>styleName<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">                    dom<span class="token punctuation">.</span>style<span class="token punctuation">[</span>styleName<span class="token punctuation">]</span> <span class="token operator">=</span> value<span class="token punctuation">[</span>styleName<span class="token punctuation">]</span><span class="token punctuation">;</span></span>
<span class="line">                <span class="token punctuation">}</span></span>
<span class="line">            <span class="token punctuation">}</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span></span>
<span class="line">        dom<span class="token punctuation">.</span><span class="token function">setAttribute</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    <span class="token keyword">return</span> dom<span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"><span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">setProps</span><span class="token punctuation">(</span><span class="token parameter">elem<span class="token punctuation">,</span> oldProps<span class="token punctuation">,</span> newProps</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> key <span class="token keyword">in</span> oldProps<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">if</span> <span class="token punctuation">(</span>key <span class="token operator">!==</span> <span class="token string">&#39;children&#39;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token keyword">if</span> <span class="token punctuation">(</span>newProps<span class="token punctuation">.</span><span class="token function">hasOwnProperty</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">                <span class="token function">setProp</span><span class="token punctuation">(</span>elem<span class="token punctuation">,</span> key<span class="token punctuation">,</span> newProps<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span></span>
<span class="line">                elem<span class="token punctuation">.</span><span class="token function">removeAttribute</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">            <span class="token punctuation">}</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> key <span class="token keyword">in</span> newProps<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">if</span> <span class="token punctuation">(</span>key <span class="token operator">!==</span> <span class="token string">&#39;children&#39;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token function">setProp</span><span class="token punctuation">(</span>elem<span class="token punctuation">,</span> key<span class="token punctuation">,</span> newProps<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">)</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token operator">+</span><span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">deepEquals</span><span class="token punctuation">(</span><span class="token parameter">obj1<span class="token punctuation">,</span> obj2</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line"><span class="token operator">+</span>    <span class="token keyword">let</span> <span class="token punctuation">{</span> <span class="token literal-property property">children</span><span class="token operator">:</span> oldChildren<span class="token punctuation">,</span> <span class="token operator">...</span>oldProps <span class="token punctuation">}</span> <span class="token operator">=</span> obj1<span class="token punctuation">;</span></span>
<span class="line"><span class="token operator">+</span>    <span class="token keyword">let</span> <span class="token punctuation">{</span> <span class="token literal-property property">children</span><span class="token operator">:</span> newChildren<span class="token punctuation">,</span> <span class="token operator">...</span>newProps <span class="token punctuation">}</span> <span class="token operator">=</span> obj2<span class="token punctuation">;</span></span>
<span class="line"><span class="token operator">+</span>    <span class="token keyword">return</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>oldProps<span class="token punctuation">)</span> <span class="token operator">===</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>newProps<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token operator">+</span><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_4-6-scheduler-js" tabindex="-1"><a class="header-anchor" href="#_4-6-scheduler-js"><span>4.6 scheduler.js</span></a></h3><p>src\\scheduler.js</p><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code class="language-javascript"><span class="line"><span class="token keyword">import</span> <span class="token punctuation">{</span> setProps<span class="token punctuation">,</span>deepEquals <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&#39;./utils&#39;</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token operator">+</span><span class="token keyword">import</span> <span class="token punctuation">{</span> UpdateQueue <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&#39;./updateQueue&#39;</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token operator">+</span><span class="token keyword">import</span> _ <span class="token keyword">from</span> <span class="token string">&#39;lodash&#39;</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">import</span> <span class="token punctuation">{</span></span>
<span class="line"><span class="token operator">+</span>    <span class="token constant">ELEMENT_TEXT</span><span class="token punctuation">,</span> <span class="token constant">TAG_ROOT</span><span class="token punctuation">,</span> <span class="token constant">TAG_HOST</span><span class="token punctuation">,</span> <span class="token constant">TAG_TEXT</span><span class="token punctuation">,</span> <span class="token constant">TAG_CLASS</span><span class="token punctuation">,</span> <span class="token constant">PLACEMENT</span><span class="token punctuation">,</span> <span class="token constant">DELETION</span><span class="token punctuation">,</span> <span class="token constant">UPDATE</span></span>
<span class="line"><span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&#39;./constants&#39;</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">let</span> currentRoot <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>        <span class="token comment">//当前的根Fiber</span></span>
<span class="line"><span class="token keyword">let</span> workInProgressRoot <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span> <span class="token comment">//正在渲染中的根Fiber</span></span>
<span class="line"><span class="token keyword">let</span> nextUnitOfWork <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>     <span class="token comment">//下一个工作单元</span></span>
<span class="line"><span class="token keyword">let</span> deletions <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>            <span class="token comment">//要删除的fiber节点</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">scheduleRoot</span><span class="token punctuation">(</span><span class="token parameter">rootFiber</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line"><span class="token operator">+</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>currentRoot <span class="token operator">&amp;&amp;</span> currentRoot<span class="token punctuation">.</span>alternate<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line"><span class="token operator">+</span>        workInProgressRoot <span class="token operator">=</span> currentRoot<span class="token punctuation">.</span>alternate<span class="token punctuation">;</span></span>
<span class="line"><span class="token operator">+</span>        workInProgressRoot<span class="token punctuation">.</span>alternate <span class="token operator">=</span> currentRoot<span class="token punctuation">;</span></span>
<span class="line"><span class="token operator">+</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>rootFiber<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line"><span class="token operator">+</span>            workInProgressRoot<span class="token punctuation">.</span>props <span class="token operator">=</span> rootFiber<span class="token punctuation">.</span>props<span class="token punctuation">;</span></span>
<span class="line"><span class="token operator">+</span>        <span class="token punctuation">}</span></span>
<span class="line"><span class="token operator">+</span>    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>currentRoot<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line"><span class="token operator">+</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>rootFiber<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line"><span class="token operator">+</span>            rootFiber<span class="token punctuation">.</span>alternate <span class="token operator">=</span> currentRoot<span class="token punctuation">;</span></span>
<span class="line"><span class="token operator">+</span>            workInProgressRoot <span class="token operator">=</span> rootFiber<span class="token punctuation">;</span></span>
<span class="line"><span class="token operator">+</span>        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span></span>
<span class="line"><span class="token operator">+</span>            workInProgressRoot <span class="token operator">=</span> <span class="token punctuation">{</span></span>
<span class="line"><span class="token operator">+</span>                <span class="token operator">...</span>currentRoot<span class="token punctuation">,</span></span>
<span class="line"><span class="token operator">+</span>                alternate<span class="token operator">:</span> currentRoot</span>
<span class="line"><span class="token operator">+</span>            <span class="token punctuation">}</span></span>
<span class="line"><span class="token operator">+</span>        <span class="token punctuation">}</span></span>
<span class="line"><span class="token operator">+</span>    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span></span>
<span class="line"><span class="token operator">+</span>        workInProgressRoot <span class="token operator">=</span> rootFiber<span class="token punctuation">;</span></span>
<span class="line"><span class="token operator">+</span>    <span class="token punctuation">}</span></span>
<span class="line"><span class="token operator">+</span>    workInProgressRoot<span class="token punctuation">.</span>firstEffect <span class="token operator">=</span> workInProgressRoot<span class="token punctuation">.</span>lastEffect <span class="token operator">=</span> workInProgressRoot<span class="token punctuation">.</span>nextEffect <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token operator">+</span>    nextUnitOfWork <span class="token operator">=</span> workInProgressRoot<span class="token punctuation">;</span></span>
<span class="line"><span class="token operator">+</span><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">function</span> <span class="token function">commitRoot</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    deletions<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span>commitWork<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">let</span> currentFiber <span class="token operator">=</span> workInProgressRoot<span class="token punctuation">.</span>firstEffect<span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">while</span> <span class="token punctuation">(</span>currentFiber<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token function">commitWork</span><span class="token punctuation">(</span>currentFiber<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        currentFiber <span class="token operator">=</span> currentFiber<span class="token punctuation">.</span>nextEffect<span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    deletions<span class="token punctuation">.</span>length <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token comment">//先把要删除的节点清空掉</span></span>
<span class="line"><span class="token operator">+</span>   workInProgressRoot<span class="token punctuation">.</span>firstEffect <span class="token operator">=</span> workInProgressRoot<span class="token punctuation">.</span>lastEffect <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span><span class="token comment">//清除effect list</span></span>
<span class="line">    currentRoot <span class="token operator">=</span> workInProgressRoot<span class="token punctuation">;</span></span>
<span class="line">    workInProgressRoot <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"><span class="token keyword">function</span> <span class="token function">commitWork</span><span class="token punctuation">(</span><span class="token parameter">currentFiber</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line"><span class="token operator">+</span>     <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>currentFiber<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line"><span class="token operator">+</span>        <span class="token keyword">return</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token operator">+</span>    <span class="token punctuation">}</span></span>
<span class="line">    <span class="token keyword">let</span> returnFiber <span class="token operator">=</span> currentFiber<span class="token punctuation">.</span>return<span class="token punctuation">;</span><span class="token comment">//先获取父Fiber</span></span>
<span class="line"><span class="token operator">+</span>    <span class="token keyword">while</span> <span class="token punctuation">(</span>returnFiber<span class="token punctuation">.</span>tag <span class="token operator">!==</span> <span class="token constant">TAG_HOST</span> <span class="token operator">&amp;&amp;</span> returnFiber<span class="token punctuation">.</span>tag <span class="token operator">!==</span> <span class="token constant">TAG_ROOT</span> <span class="token operator">&amp;&amp;</span> returnFiber<span class="token punctuation">.</span>tag <span class="token operator">!==</span> <span class="token constant">TAG_TEXT</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token comment">//如果不是DOM节点就一直向上找,比如ClassCounter</span></span>
<span class="line"><span class="token operator">+</span>        returnFiber <span class="token operator">=</span> returnFiber<span class="token punctuation">.</span>return<span class="token punctuation">;</span></span>
<span class="line"><span class="token operator">+</span>    <span class="token punctuation">}</span></span>
<span class="line">    <span class="token keyword">const</span> domReturn <span class="token operator">=</span> returnFiber<span class="token punctuation">.</span>stateNode<span class="token punctuation">;</span><span class="token comment">//获取父的DOM节点</span></span>
<span class="line">    <span class="token keyword">if</span> <span class="token punctuation">(</span>currentFiber<span class="token punctuation">.</span>effectTag <span class="token operator">===</span> <span class="token constant">PLACEMENT</span> <span class="token operator">&amp;&amp;</span> currentFiber<span class="token punctuation">.</span>stateNode <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token comment">//如果是新增DOM节点</span></span>
<span class="line"><span class="token operator">+</span>        <span class="token keyword">let</span> nextFiber <span class="token operator">=</span> currentFiber<span class="token punctuation">;</span></span>
<span class="line"><span class="token operator">+</span>        <span class="token keyword">while</span> <span class="token punctuation">(</span>nextFiber<span class="token punctuation">.</span>tag <span class="token operator">!==</span> <span class="token constant">TAG_HOST</span> <span class="token operator">&amp;&amp;</span> nextFiber<span class="token punctuation">.</span>tag <span class="token operator">!==</span> <span class="token constant">TAG_TEXT</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line"><span class="token operator">+</span>            nextFiber <span class="token operator">=</span> nextFiber<span class="token punctuation">.</span>child<span class="token punctuation">;</span><span class="token comment">//必须向下找到一个DOM节点 比如Class Counter</span></span>
<span class="line"><span class="token operator">+</span>        <span class="token punctuation">}</span></span>
<span class="line">        domReturn<span class="token punctuation">.</span><span class="token function">appendChild</span><span class="token punctuation">(</span>nextFiber<span class="token punctuation">.</span>stateNode<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>currentFiber<span class="token punctuation">.</span>effectTag <span class="token operator">===</span> <span class="token constant">DELETION</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token comment">//如果是删除则删除并返回</span></span>
<span class="line"><span class="token operator">+</span>        <span class="token function">commitDeletion</span><span class="token punctuation">(</span>currentFiber<span class="token punctuation">,</span> domReturn<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>currentFiber<span class="token punctuation">.</span>effectTag <span class="token operator">===</span> <span class="token constant">UPDATE</span> <span class="token operator">&amp;&amp;</span> currentFiber<span class="token punctuation">.</span>stateNode <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token comment">//如果是更新</span></span>
<span class="line">        <span class="token keyword">if</span> <span class="token punctuation">(</span>currentFiber<span class="token punctuation">.</span>type <span class="token operator">===</span> <span class="token constant">ELEMENT_TEXT</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token keyword">if</span> <span class="token punctuation">(</span>currentFiber<span class="token punctuation">.</span>alternate<span class="token punctuation">.</span>props<span class="token punctuation">.</span>text <span class="token operator">!==</span> currentFiber<span class="token punctuation">.</span>props<span class="token punctuation">.</span>text<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">                currentFiber<span class="token punctuation">.</span>stateNode<span class="token punctuation">.</span>textContent <span class="token operator">=</span> currentFiber<span class="token punctuation">.</span>props<span class="token punctuation">.</span>text<span class="token punctuation">;</span></span>
<span class="line">            <span class="token punctuation">}</span></span>
<span class="line">        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token function">updateDOM</span><span class="token punctuation">(</span>currentFiber<span class="token punctuation">.</span>stateNode<span class="token punctuation">,</span> currentFiber<span class="token punctuation">.</span>alternate<span class="token punctuation">.</span>props<span class="token punctuation">,</span> currentFiber<span class="token punctuation">.</span>props<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    currentFiber<span class="token punctuation">.</span>effectTag <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"><span class="token operator">+</span><span class="token keyword">function</span> <span class="token function">commitDeletion</span><span class="token punctuation">(</span><span class="token parameter">currentFiber<span class="token punctuation">,</span> domReturn</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line"><span class="token operator">+</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>currentFiber<span class="token punctuation">.</span>tag <span class="token operator">===</span> <span class="token constant">TAG_HOST</span> <span class="token operator">||</span> currentFiber<span class="token punctuation">.</span>tag <span class="token operator">===</span> <span class="token constant">TAG_TEXT</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line"><span class="token operator">+</span>        domReturn<span class="token punctuation">.</span><span class="token function">removeChild</span><span class="token punctuation">(</span>currentFiber<span class="token punctuation">.</span>stateNode<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token operator">+</span>    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span></span>
<span class="line"><span class="token operator">+</span>        <span class="token function">commitDeletion</span><span class="token punctuation">(</span>currentFiber<span class="token punctuation">.</span>child<span class="token punctuation">,</span> domReturn<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token operator">+</span>    <span class="token punctuation">}</span></span>
<span class="line"><span class="token operator">+</span><span class="token punctuation">}</span></span>
<span class="line"><span class="token keyword">function</span> <span class="token function">performUnitOfWork</span><span class="token punctuation">(</span><span class="token parameter">currentFiber</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token function">beginWork</span><span class="token punctuation">(</span>currentFiber<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//开始渲染前的Fiber,就是把子元素变成子fiber</span></span>
<span class="line"></span>
<span class="line">    <span class="token keyword">if</span> <span class="token punctuation">(</span>currentFiber<span class="token punctuation">.</span>child<span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token comment">//如果子节点就返回第一个子节点</span></span>
<span class="line">        <span class="token keyword">return</span> currentFiber<span class="token punctuation">.</span>child<span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">    <span class="token keyword">while</span> <span class="token punctuation">(</span>currentFiber<span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token comment">//如果没有子节点说明当前节点已经完成了渲染工作</span></span>
<span class="line">        <span class="token function">completeUnitOfWork</span><span class="token punctuation">(</span>currentFiber<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//可以结束此fiber的渲染了 </span></span>
<span class="line">        <span class="token keyword">if</span> <span class="token punctuation">(</span>currentFiber<span class="token punctuation">.</span>sibling<span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token comment">//如果它有弟弟就返回弟弟</span></span>
<span class="line">            <span class="token keyword">return</span> currentFiber<span class="token punctuation">.</span>sibling<span class="token punctuation">;</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">        currentFiber <span class="token operator">=</span> currentFiber<span class="token punctuation">.</span>return<span class="token punctuation">;</span><span class="token comment">//如果没有弟弟让爸爸完成，然后找叔叔</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">function</span> <span class="token function">beginWork</span><span class="token punctuation">(</span><span class="token parameter">currentFiber</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">if</span> <span class="token punctuation">(</span>currentFiber<span class="token punctuation">.</span>tag <span class="token operator">===</span> <span class="token constant">TAG_ROOT</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token comment">//如果是根节点</span></span>
<span class="line">        <span class="token function">updateHostRoot</span><span class="token punctuation">(</span>currentFiber<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>currentFiber<span class="token punctuation">.</span>tag <span class="token operator">===</span> <span class="token constant">TAG_TEXT</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token comment">//如果是原生文本节点</span></span>
<span class="line">        <span class="token function">updateHostText</span><span class="token punctuation">(</span>currentFiber<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>currentFiber<span class="token punctuation">.</span>tag <span class="token operator">===</span> <span class="token constant">TAG_HOST</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token comment">//如果是原生DOM节点</span></span>
<span class="line">        <span class="token function">updateHostComponent</span><span class="token punctuation">(</span>currentFiber<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token operator">+</span>    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>currentFiber<span class="token punctuation">.</span>tag <span class="token operator">===</span> <span class="token constant">TAG_CLASS</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token comment">//如果是类组件</span></span>
<span class="line"><span class="token operator">+</span>        <span class="token function">updateClassComponent</span><span class="token punctuation">(</span>currentFiber<span class="token punctuation">)</span></span>
<span class="line"><span class="token operator">+</span>    <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"><span class="token operator">+</span><span class="token keyword">function</span> <span class="token function">updateClassComponent</span><span class="token punctuation">(</span><span class="token parameter">currentFiber</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line"><span class="token operator">+</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>currentFiber<span class="token punctuation">.</span>stateNode <span class="token operator">===</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line"><span class="token operator">+</span>        currentFiber<span class="token punctuation">.</span>stateNode <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">currentFiber<span class="token punctuation">.</span>type</span><span class="token punctuation">(</span>currentFiber<span class="token punctuation">.</span>props<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token operator">+</span>        currentFiber<span class="token punctuation">.</span>stateNode<span class="token punctuation">.</span>internalFiber <span class="token operator">=</span> currentFiber<span class="token punctuation">;</span></span>
<span class="line"><span class="token operator">+</span>        currentFiber<span class="token punctuation">.</span>updateQueue <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">UpdateQueue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token operator">+</span>    <span class="token punctuation">}</span></span>
<span class="line"><span class="token operator">+</span>    currentFiber<span class="token punctuation">.</span>stateNode<span class="token punctuation">.</span>state <span class="token operator">=</span> currentFiber<span class="token punctuation">.</span>updateQueue<span class="token punctuation">.</span><span class="token function">forceUpdate</span><span class="token punctuation">(</span>currentFiber<span class="token punctuation">.</span>stateNode<span class="token punctuation">.</span>state<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token operator">+</span>    <span class="token keyword">const</span> newChildren <span class="token operator">=</span> <span class="token punctuation">[</span>currentFiber<span class="token punctuation">.</span>stateNode<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token operator">+</span>    <span class="token function">reconcileChildren</span><span class="token punctuation">(</span>currentFiber<span class="token punctuation">,</span> newChildren<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token operator">+</span><span class="token punctuation">}</span></span>
<span class="line"><span class="token keyword">function</span> <span class="token function">updateHostText</span><span class="token punctuation">(</span><span class="token parameter">currentFiber</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>currentFiber<span class="token punctuation">.</span>stateNode<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        currentFiber<span class="token punctuation">.</span>stateNode <span class="token operator">=</span> <span class="token function">createDOM</span><span class="token punctuation">(</span>currentFiber<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//先创建真实的DOM节点</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"><span class="token keyword">function</span> <span class="token function">updateHostRoot</span><span class="token punctuation">(</span><span class="token parameter">currentFiber</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token comment">//如果是根节点</span></span>
<span class="line">    <span class="token keyword">const</span> newChildren <span class="token operator">=</span> currentFiber<span class="token punctuation">.</span>props<span class="token punctuation">.</span>children<span class="token punctuation">;</span><span class="token comment">//直接渲染子节点</span></span>
<span class="line">    <span class="token function">reconcileChildren</span><span class="token punctuation">(</span>currentFiber<span class="token punctuation">,</span> newChildren<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">function</span> <span class="token function">updateHostComponent</span><span class="token punctuation">(</span><span class="token parameter">currentFiber</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token comment">//如果是原生DOM节点</span></span>
<span class="line">    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>currentFiber<span class="token punctuation">.</span>stateNode<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        currentFiber<span class="token punctuation">.</span>stateNode <span class="token operator">=</span> <span class="token function">createDOM</span><span class="token punctuation">(</span>currentFiber<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//先创建真实的DOM节点</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    <span class="token keyword">const</span> newChildren <span class="token operator">=</span> currentFiber<span class="token punctuation">.</span>props<span class="token punctuation">.</span>children<span class="token punctuation">;</span></span>
<span class="line">    <span class="token function">reconcileChildren</span><span class="token punctuation">(</span>currentFiber<span class="token punctuation">,</span> newChildren<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"><span class="token keyword">function</span> <span class="token function">createDOM</span><span class="token punctuation">(</span><span class="token parameter">currentFiber</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">if</span> <span class="token punctuation">(</span>currentFiber<span class="token punctuation">.</span>type <span class="token operator">===</span> <span class="token constant">ELEMENT_TEXT</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">return</span> document<span class="token punctuation">.</span><span class="token function">createTextNode</span><span class="token punctuation">(</span>currentFiber<span class="token punctuation">.</span>props<span class="token punctuation">.</span>text<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    <span class="token keyword">const</span> stateNode <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span>currentFiber<span class="token punctuation">.</span>type<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token function">updateDOM</span><span class="token punctuation">(</span>stateNode<span class="token punctuation">,</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> currentFiber<span class="token punctuation">.</span>props<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">return</span> stateNode<span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">function</span> <span class="token function">reconcileChildren</span><span class="token punctuation">(</span><span class="token parameter">currentFiber<span class="token punctuation">,</span> newChildren</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">let</span> newChildIndex <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token comment">//新虚拟DOM数组中的索引</span></span>
<span class="line">    <span class="token keyword">let</span> oldFiber <span class="token operator">=</span> currentFiber<span class="token punctuation">.</span>alternate <span class="token operator">&amp;&amp;</span> currentFiber<span class="token punctuation">.</span>alternate<span class="token punctuation">.</span>child<span class="token punctuation">;</span><span class="token comment">//父Fiber中的第一个子Fiber</span></span>
<span class="line"><span class="token operator">+</span>   <span class="token keyword">if</span> <span class="token punctuation">(</span>oldFiber<span class="token punctuation">)</span> oldFiber<span class="token punctuation">.</span>firstEffect <span class="token operator">=</span> oldFiber<span class="token punctuation">.</span>lastEffect <span class="token operator">=</span> oldFiber<span class="token punctuation">.</span>nextEffect <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">let</span> prevSibling<span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">while</span> <span class="token punctuation">(</span>newChildIndex <span class="token operator">&lt;</span> newChildren<span class="token punctuation">.</span>length <span class="token operator">||</span> oldFiber<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">const</span> newChild <span class="token operator">=</span> newChildren<span class="token punctuation">[</span>newChildIndex<span class="token punctuation">]</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">let</span> newFiber<span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">const</span> sameType <span class="token operator">=</span> oldFiber <span class="token operator">&amp;&amp;</span> newChild <span class="token operator">&amp;&amp;</span> newChild<span class="token punctuation">.</span>type <span class="token operator">===</span> oldFiber<span class="token punctuation">.</span>type<span class="token punctuation">;</span><span class="token comment">//新旧都有，并且元素类型一样</span></span>
<span class="line">        <span class="token keyword">let</span> tag<span class="token punctuation">;</span></span>
<span class="line"><span class="token operator">+</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>newChild <span class="token operator">&amp;&amp;</span> <span class="token keyword">typeof</span> newChild<span class="token punctuation">.</span>type <span class="token operator">===</span> <span class="token string">&#39;function&#39;</span> <span class="token operator">&amp;&amp;</span> newChild<span class="token punctuation">.</span>type<span class="token punctuation">.</span>prototype<span class="token punctuation">.</span>isReactComponent<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line"><span class="token operator">+</span>            tag <span class="token operator">=</span> <span class="token constant">TAG_CLASS</span><span class="token punctuation">;</span><span class="token comment">//类组件</span></span>
<span class="line"><span class="token operator">+</span>        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>newChild <span class="token operator">&amp;&amp;</span> newChild<span class="token punctuation">.</span>type <span class="token operator">===</span> <span class="token constant">ELEMENT_TEXT</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">            tag <span class="token operator">=</span> <span class="token constant">TAG_TEXT</span><span class="token punctuation">;</span><span class="token comment">//文本</span></span>
<span class="line">        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>newChild <span class="token operator">&amp;&amp;</span> <span class="token keyword">typeof</span> newChild<span class="token punctuation">.</span>type <span class="token operator">===</span> <span class="token string">&#39;string&#39;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">            tag <span class="token operator">=</span> <span class="token constant">TAG_HOST</span><span class="token punctuation">;</span><span class="token comment">//原生DOM组件</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">        <span class="token keyword">if</span> <span class="token punctuation">(</span>sameType<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line"><span class="token operator">+</span>            <span class="token keyword">let</span> <span class="token punctuation">{</span> <span class="token literal-property property">children</span><span class="token operator">:</span> oldChildren<span class="token punctuation">,</span> <span class="token operator">...</span>oldProps <span class="token punctuation">}</span> <span class="token operator">=</span> oldFiber<span class="token punctuation">.</span>props<span class="token punctuation">;</span></span>
<span class="line"><span class="token operator">+</span>            <span class="token keyword">let</span> <span class="token punctuation">{</span> <span class="token literal-property property">children</span><span class="token operator">:</span> newChildren<span class="token punctuation">,</span> <span class="token operator">...</span>newProps <span class="token punctuation">}</span> <span class="token operator">=</span> newChild<span class="token punctuation">.</span>props<span class="token punctuation">;</span></span>
<span class="line"><span class="token operator">+</span>            newFiber <span class="token operator">=</span> <span class="token punctuation">{</span></span>
<span class="line"><span class="token operator">+</span>                tag<span class="token punctuation">,</span><span class="token comment">//标记Fiber类型，例如是函数组件或者原生组件</span></span>
<span class="line"><span class="token operator">+</span>                type<span class="token operator">:</span> oldFiber<span class="token punctuation">.</span>type<span class="token punctuation">,</span><span class="token comment">//具体的元素类型</span></span>
<span class="line"><span class="token operator">+</span>                props<span class="token operator">:</span> newChild<span class="token punctuation">.</span>props<span class="token punctuation">,</span><span class="token comment">//新的属性对象</span></span>
<span class="line"><span class="token operator">+</span>                stateNode<span class="token operator">:</span> oldFiber<span class="token punctuation">.</span>stateNode<span class="token punctuation">,</span><span class="token comment">//原生组件的话就存放DOM节点，类组件的话是类组件实例，函数组件的话为空，因为没有实例</span></span>
<span class="line"><span class="token operator">+</span>                <span class="token keyword">return</span><span class="token operator">:</span> currentFiber<span class="token punctuation">,</span><span class="token comment">//父Fiber</span></span>
<span class="line"><span class="token operator">+</span>                updateQueue<span class="token operator">:</span> oldFiber<span class="token punctuation">.</span>updateQueue <span class="token operator">||</span> <span class="token keyword">new</span> <span class="token class-name">UpdateQueue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line"><span class="token operator">+</span>                alternate<span class="token operator">:</span> oldFiber<span class="token punctuation">,</span><span class="token comment">//上一个Fiber 指向旧树中的节点</span></span>
<span class="line"><span class="token operator">+</span>                effectTag<span class="token operator">:</span> <span class="token function">deepEquals</span><span class="token punctuation">(</span>oldProps<span class="token punctuation">,</span> newProps<span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token keyword">null</span> <span class="token operator">:</span> <span class="token constant">UPDATE</span><span class="token punctuation">,</span><span class="token comment">//副作用标识</span></span>
<span class="line"><span class="token operator">+</span>            <span class="token punctuation">}</span></span>
<span class="line">        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token keyword">if</span> <span class="token punctuation">(</span>newChild<span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token comment">//类型不一样，创建新的Fiber,旧的不复用了</span></span>
<span class="line">                newFiber <span class="token operator">=</span> <span class="token punctuation">{</span></span>
<span class="line">                    tag<span class="token punctuation">,</span><span class="token comment">//原生DOM组件</span></span>
<span class="line">                    <span class="token literal-property property">type</span><span class="token operator">:</span> newChild<span class="token punctuation">.</span>type<span class="token punctuation">,</span><span class="token comment">//具体的元素类型</span></span>
<span class="line">                    <span class="token literal-property property">props</span><span class="token operator">:</span> newChild<span class="token punctuation">.</span>props<span class="token punctuation">,</span><span class="token comment">//新的属性对象</span></span>
<span class="line">                    <span class="token literal-property property">stateNode</span><span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span><span class="token comment">//stateNode肯定是空的</span></span>
<span class="line">                    <span class="token keyword">return</span><span class="token operator">:</span> currentFiber<span class="token punctuation">,</span><span class="token comment">//父Fiber</span></span>
<span class="line">                    <span class="token literal-property property">effectTag</span><span class="token operator">:</span> <span class="token constant">PLACEMENT</span><span class="token comment">//副作用标识</span></span>
<span class="line">                <span class="token punctuation">}</span></span>
<span class="line">            <span class="token punctuation">}</span></span>
<span class="line">            <span class="token keyword">if</span> <span class="token punctuation">(</span>oldFiber<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">                oldFiber<span class="token punctuation">.</span>effectTag <span class="token operator">=</span> <span class="token constant">DELETION</span><span class="token punctuation">;</span></span>
<span class="line">                deletions<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>oldFiber<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">            <span class="token punctuation">}</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">        <span class="token keyword">if</span> <span class="token punctuation">(</span>oldFiber<span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token comment">//比较完一个元素了，老Fiber向后移动1位</span></span>
<span class="line">            oldFiber <span class="token operator">=</span> oldFiber<span class="token punctuation">.</span>sibling<span class="token punctuation">;</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">       <span class="token keyword">if</span> <span class="token punctuation">(</span>newFiber<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token keyword">if</span> <span class="token punctuation">(</span>newChildIndex <span class="token operator">===</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">                currentFiber<span class="token punctuation">.</span>child <span class="token operator">=</span> newFiber<span class="token punctuation">;</span><span class="token comment">//第一个子节点挂到父节点的child属性上</span></span>
<span class="line">            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span></span>
<span class="line">                prevSibling<span class="token punctuation">.</span>sibling <span class="token operator">=</span> newFiber<span class="token punctuation">;</span></span>
<span class="line">            <span class="token punctuation">}</span></span>
<span class="line">            prevSibling <span class="token operator">=</span> newFiber<span class="token punctuation">;</span><span class="token comment">//然后newFiber变成了上一个哥哥了</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">        newChildIndex<span class="token operator">++</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">function</span> <span class="token function">updateDOM</span><span class="token punctuation">(</span><span class="token parameter">stateNode<span class="token punctuation">,</span> oldProps<span class="token punctuation">,</span> newProps</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token function">setProps</span><span class="token punctuation">(</span>stateNode<span class="token punctuation">,</span> oldProps<span class="token punctuation">,</span> newProps<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"><span class="token keyword">function</span> <span class="token function">completeUnitOfWork</span><span class="token punctuation">(</span><span class="token parameter">currentFiber</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">const</span> returnFiber <span class="token operator">=</span> currentFiber<span class="token punctuation">.</span>return<span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">if</span> <span class="token punctuation">(</span>returnFiber<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>returnFiber<span class="token punctuation">.</span>firstEffect<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">            returnFiber<span class="token punctuation">.</span>firstEffect <span class="token operator">=</span> currentFiber<span class="token punctuation">.</span>firstEffect<span class="token punctuation">;</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token operator">!</span>currentFiber<span class="token punctuation">.</span>lastEffect<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token operator">!</span>returnFiber<span class="token punctuation">.</span>lastEffect<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">                returnFiber<span class="token punctuation">.</span>lastEffect<span class="token punctuation">.</span>nextEffect <span class="token operator">=</span> currentFiber<span class="token punctuation">.</span>firstEffect<span class="token punctuation">;</span></span>
<span class="line">            <span class="token punctuation">}</span></span>
<span class="line">            returnFiber<span class="token punctuation">.</span>lastEffect <span class="token operator">=</span> currentFiber<span class="token punctuation">.</span>lastEffect<span class="token punctuation">;</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">        <span class="token keyword">const</span> effectTag <span class="token operator">=</span> currentFiber<span class="token punctuation">.</span>effectTag<span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">if</span> <span class="token punctuation">(</span>effectTag<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token operator">!</span>returnFiber<span class="token punctuation">.</span>lastEffect<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">                returnFiber<span class="token punctuation">.</span>lastEffect<span class="token punctuation">.</span>nextEffect <span class="token operator">=</span> currentFiber<span class="token punctuation">;</span></span>
<span class="line">            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span></span>
<span class="line">                returnFiber<span class="token punctuation">.</span>firstEffect <span class="token operator">=</span> currentFiber<span class="token punctuation">;</span></span>
<span class="line">            <span class="token punctuation">}</span></span>
<span class="line">            returnFiber<span class="token punctuation">.</span>lastEffect <span class="token operator">=</span> currentFiber<span class="token punctuation">;</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">function</span> <span class="token function">workLoop</span><span class="token punctuation">(</span><span class="token parameter">deadline</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">let</span> shouldYield <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">while</span> <span class="token punctuation">(</span>nextUnitOfWork <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>shouldYield<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        nextUnitOfWork <span class="token operator">=</span> <span class="token function">performUnitOfWork</span><span class="token punctuation">(</span>nextUnitOfWork<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//执行一个任务并返回下一个任务</span></span>
<span class="line">        shouldYield <span class="token operator">=</span> deadline<span class="token punctuation">.</span><span class="token function">timeRemaining</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">1</span><span class="token punctuation">;</span><span class="token comment">//如果剩余时间小于1毫秒就说明没有时间了，需要把控制权让给浏览器</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    <span class="token comment">//如果没有下一个执行单元了，并且当前渲染树存在，则进行提交阶段</span></span>
<span class="line">    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>nextUnitOfWork <span class="token operator">&amp;&amp;</span> workInProgressRoot<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token function">commitRoot</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    <span class="token function">requestIdleCallback</span><span class="token punctuation">(</span>workLoop<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"><span class="token comment">//开始在空闲时间执行workLoop</span></span>
<span class="line"><span class="token function">requestIdleCallback</span><span class="token punctuation">(</span>workLoop<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="_5-实现函数组件" tabindex="-1"><a class="header-anchor" href="#_5-实现函数组件"><span>5.实现函数组件</span></a></h2><h3 id="_5-1-src-index-js" tabindex="-1"><a class="header-anchor" href="#_5-1-src-index-js"><span>5.1 src\\index.js</span></a></h3><p>src\\index.js</p><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text"><pre><code class="language-text"><span class="line">+function FunctionCounter() {</span>
<span class="line">+  return (</span>
<span class="line">+    &lt;h1&gt;</span>
<span class="line">+      Count:0</span>
<span class="line">+    &lt;/h1&gt;</span>
<span class="line">+  )</span>
<span class="line">+}</span>
<span class="line">ReactDOM.render(</span>
<span class="line">+  &lt;FunctionCounter /&gt;,</span>
<span class="line">   document.getElementById(&#39;root&#39;)</span>
<span class="line">);</span>
<span class="line"></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_5-2-constants-js" tabindex="-1"><a class="header-anchor" href="#_5-2-constants-js"><span>5.2 constants.js</span></a></h3><p>src\\constants.js</p><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text"><pre><code class="language-text"><span class="line">export const ELEMENT_TEXT = Symbol.for(&#39;ELEMENT_TEXT&#39;);</span>
<span class="line"></span>
<span class="line">export const TAG_ROOT = Symbol.for(&#39;TAG_ROOT&#39;);</span>
<span class="line">export const TAG_HOST = Symbol.for(&#39;TAG_HOST&#39;);</span>
<span class="line">export const TAG_TEXT = Symbol.for(&#39;TAG_TEXT&#39;);</span>
<span class="line">export const TAG_CLASS = Symbol.for(&#39;TAG_CLASS&#39;);</span>
<span class="line">+export const TAG_FUNCTION = Symbol.for(&#39;TAG_FUNCTION&#39;);</span>
<span class="line">export const UPDATE = Symbol.for(&#39;UPDATE&#39;);</span>
<span class="line">export const PLACEMENT = Symbol.for(&#39;PLACEMENT&#39;);</span>
<span class="line">export const DELETION = Symbol.for(&#39;DELETION&#39;);</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_5-3-scheduler-js" tabindex="-1"><a class="header-anchor" href="#_5-3-scheduler-js"><span>5.3 scheduler.js</span></a></h3><p>src\\scheduler.js</p><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code class="language-javascript"><span class="line"><span class="token keyword">import</span> <span class="token punctuation">{</span> setProps<span class="token punctuation">,</span> deepEquals <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&#39;./utils&#39;</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">import</span> <span class="token punctuation">{</span> UpdateQueue <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&#39;./updateQueue&#39;</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token operator">+</span><span class="token keyword">import</span> <span class="token punctuation">{</span></span>
<span class="line"><span class="token operator">+</span>    <span class="token constant">ELEMENT_TEXT</span><span class="token punctuation">,</span> <span class="token constant">TAG_ROOT</span><span class="token punctuation">,</span> <span class="token constant">TAG_HOST</span><span class="token punctuation">,</span> <span class="token constant">TAG_TEXT</span><span class="token punctuation">,</span> <span class="token constant">TAG_CLASS</span><span class="token punctuation">,</span> <span class="token constant">TAG_FUNCTION</span><span class="token punctuation">,</span> <span class="token constant">PLACEMENT</span><span class="token punctuation">,</span> <span class="token constant">DELETION</span><span class="token punctuation">,</span> <span class="token constant">UPDATE</span></span>
<span class="line"><span class="token operator">+</span><span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&#39;./constants&#39;</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">let</span> currentRoot <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>        <span class="token comment">//当前的根Fiber</span></span>
<span class="line"><span class="token keyword">let</span> workInProgressRoot <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span> <span class="token comment">//正在渲染中的根Fiber</span></span>
<span class="line"><span class="token keyword">let</span> nextUnitOfWork <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>     <span class="token comment">//下一个工作单元</span></span>
<span class="line"><span class="token keyword">let</span> deletions <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>            <span class="token comment">//要删除的fiber节点</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">scheduleRoot</span><span class="token punctuation">(</span><span class="token parameter">rootFiber</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">if</span> <span class="token punctuation">(</span>rootFiber<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        workInProgressRoot <span class="token operator">=</span> rootFiber<span class="token punctuation">;</span> <span class="token comment">//把当前树设置为nextUnitOfWork开始进行调度</span></span>
<span class="line">    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">if</span> <span class="token punctuation">(</span>currentRoot<span class="token punctuation">.</span>alternate<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">            workInProgressRoot <span class="token operator">=</span> currentRoot<span class="token punctuation">.</span>alternate<span class="token punctuation">;</span></span>
<span class="line">            workInProgressRoot<span class="token punctuation">.</span>alternate <span class="token operator">=</span> currentRoot<span class="token punctuation">;</span></span>
<span class="line">        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span></span>
<span class="line">            workInProgressRoot <span class="token operator">=</span> <span class="token punctuation">{</span></span>
<span class="line">                <span class="token operator">...</span>currentRoot<span class="token punctuation">,</span></span>
<span class="line">                <span class="token literal-property property">alternate</span><span class="token operator">:</span> currentRoot</span>
<span class="line">            <span class="token punctuation">}</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    deletions<span class="token punctuation">.</span>length <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span></span>
<span class="line">    nextUnitOfWork <span class="token operator">=</span> workInProgressRoot<span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">function</span> <span class="token function">commitRoot</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    deletions<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span>commitWork<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">let</span> currentFiber <span class="token operator">=</span> workInProgressRoot<span class="token punctuation">.</span>firstEffect<span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">while</span> <span class="token punctuation">(</span>currentFiber<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token function">commitWork</span><span class="token punctuation">(</span>currentFiber<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        currentFiber <span class="token operator">=</span> currentFiber<span class="token punctuation">.</span>nextEffect<span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    deletions<span class="token punctuation">.</span>length <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token comment">//先把要删除的节点清空掉</span></span>
<span class="line">    workInProgressRoot<span class="token punctuation">.</span>firstEffect <span class="token operator">=</span> workInProgressRoot<span class="token punctuation">.</span>lastEffect <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span></span>
<span class="line">    currentRoot <span class="token operator">=</span> workInProgressRoot<span class="token punctuation">;</span></span>
<span class="line">    workInProgressRoot <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"><span class="token keyword">function</span> <span class="token function">commitWork</span><span class="token punctuation">(</span><span class="token parameter">currentFiber</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>currentFiber<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">return</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    <span class="token keyword">let</span> returnFiber <span class="token operator">=</span> currentFiber<span class="token punctuation">.</span>return<span class="token punctuation">;</span><span class="token comment">//先获取父Fiber</span></span>
<span class="line">    <span class="token keyword">while</span> <span class="token punctuation">(</span>returnFiber<span class="token punctuation">.</span>tag <span class="token operator">!==</span> <span class="token constant">TAG_HOST</span> <span class="token operator">&amp;&amp;</span> returnFiber<span class="token punctuation">.</span>tag <span class="token operator">!==</span> <span class="token constant">TAG_ROOT</span> <span class="token operator">&amp;&amp;</span> returnFiber<span class="token punctuation">.</span>tag <span class="token operator">!==</span> <span class="token constant">TAG_TEXT</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token comment">//如果不是DOM节点就一直向上找</span></span>
<span class="line">        returnFiber <span class="token operator">=</span> returnFiber<span class="token punctuation">.</span>return<span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    <span class="token keyword">const</span> domReturn <span class="token operator">=</span> returnFiber<span class="token punctuation">.</span>stateNode<span class="token punctuation">;</span><span class="token comment">//获取父的DOM节点</span></span>
<span class="line">    <span class="token keyword">if</span> <span class="token punctuation">(</span>currentFiber<span class="token punctuation">.</span>effectTag <span class="token operator">===</span> <span class="token constant">PLACEMENT</span> <span class="token operator">&amp;&amp;</span> currentFiber<span class="token punctuation">.</span>stateNode <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token comment">//如果是新增DOM节点</span></span>
<span class="line">        <span class="token keyword">let</span> nextFiber <span class="token operator">=</span> currentFiber<span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">while</span> <span class="token punctuation">(</span>nextFiber<span class="token punctuation">.</span>tag <span class="token operator">!==</span> <span class="token constant">TAG_HOST</span> <span class="token operator">&amp;&amp;</span> nextFiber<span class="token punctuation">.</span>tag <span class="token operator">!==</span> <span class="token constant">TAG_TEXT</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token comment">//必须向下找到一个DOM节点</span></span>
<span class="line">            nextFiber <span class="token operator">=</span> nextFiber<span class="token punctuation">.</span>child<span class="token punctuation">;</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">        domReturn<span class="token punctuation">.</span><span class="token function">appendChild</span><span class="token punctuation">(</span>nextFiber<span class="token punctuation">.</span>stateNode<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>currentFiber<span class="token punctuation">.</span>effectTag <span class="token operator">===</span> <span class="token constant">DELETION</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token comment">//如果是删除则删除并返回</span></span>
<span class="line">        <span class="token function">commitDeletion</span><span class="token punctuation">(</span>currentFiber<span class="token punctuation">,</span> domReturn<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>currentFiber<span class="token punctuation">.</span>effectTag <span class="token operator">===</span> <span class="token constant">UPDATE</span> <span class="token operator">&amp;&amp;</span> currentFiber<span class="token punctuation">.</span>stateNode <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token comment">//如果是更新</span></span>
<span class="line">        <span class="token keyword">if</span> <span class="token punctuation">(</span>currentFiber<span class="token punctuation">.</span>type <span class="token operator">===</span> <span class="token constant">ELEMENT_TEXT</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token keyword">if</span> <span class="token punctuation">(</span>currentFiber<span class="token punctuation">.</span>alternate<span class="token punctuation">.</span>props<span class="token punctuation">.</span>text <span class="token operator">!==</span> currentFiber<span class="token punctuation">.</span>props<span class="token punctuation">.</span>text<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">                currentFiber<span class="token punctuation">.</span>stateNode<span class="token punctuation">.</span>textContent <span class="token operator">=</span> currentFiber<span class="token punctuation">.</span>props<span class="token punctuation">.</span>text<span class="token punctuation">;</span></span>
<span class="line">            <span class="token punctuation">}</span></span>
<span class="line">        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token function">updateDOM</span><span class="token punctuation">(</span>currentFiber<span class="token punctuation">.</span>stateNode<span class="token punctuation">,</span> currentFiber<span class="token punctuation">.</span>alternate<span class="token punctuation">.</span>props<span class="token punctuation">,</span> currentFiber<span class="token punctuation">.</span>props<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    currentFiber<span class="token punctuation">.</span>effectTag <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"><span class="token keyword">function</span> <span class="token function">commitDeletion</span><span class="token punctuation">(</span><span class="token parameter">currentFiber<span class="token punctuation">,</span> domReturn</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">if</span> <span class="token punctuation">(</span>currentFiber<span class="token punctuation">.</span>tag <span class="token operator">===</span> <span class="token constant">TAG_HOST</span> <span class="token operator">||</span> currentFiber<span class="token punctuation">.</span>tag <span class="token operator">===</span> <span class="token constant">TAG_TEXT</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        domReturn<span class="token punctuation">.</span><span class="token function">removeChild</span><span class="token punctuation">(</span>currentFiber<span class="token punctuation">.</span>stateNode<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token function">commitDeletion</span><span class="token punctuation">(</span>currentFiber<span class="token punctuation">.</span>child<span class="token punctuation">,</span> domReturn<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"><span class="token keyword">function</span> <span class="token function">performUnitOfWork</span><span class="token punctuation">(</span><span class="token parameter">currentFiber</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token function">beginWork</span><span class="token punctuation">(</span>currentFiber<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//开始渲染前的Fiber,就是把子元素变成子fiber</span></span>
<span class="line"></span>
<span class="line">    <span class="token keyword">if</span> <span class="token punctuation">(</span>currentFiber<span class="token punctuation">.</span>child<span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token comment">//如果子节点就返回第一个子节点</span></span>
<span class="line">        <span class="token keyword">return</span> currentFiber<span class="token punctuation">.</span>child<span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">    <span class="token keyword">while</span> <span class="token punctuation">(</span>currentFiber<span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token comment">//如果没有子节点说明当前节点已经完成了渲染工作</span></span>
<span class="line">        <span class="token function">completeUnitOfWork</span><span class="token punctuation">(</span>currentFiber<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//可以结束此fiber的渲染了 </span></span>
<span class="line">        <span class="token keyword">if</span> <span class="token punctuation">(</span>currentFiber<span class="token punctuation">.</span>sibling<span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token comment">//如果它有弟弟就返回弟弟</span></span>
<span class="line">            <span class="token keyword">return</span> currentFiber<span class="token punctuation">.</span>sibling<span class="token punctuation">;</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">        currentFiber <span class="token operator">=</span> currentFiber<span class="token punctuation">.</span>return<span class="token punctuation">;</span><span class="token comment">//如果没有弟弟让爸爸完成，然后找叔叔</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">function</span> <span class="token function">beginWork</span><span class="token punctuation">(</span><span class="token parameter">currentFiber</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">if</span> <span class="token punctuation">(</span>currentFiber<span class="token punctuation">.</span>tag <span class="token operator">===</span> <span class="token constant">TAG_ROOT</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token comment">//如果是根节点</span></span>
<span class="line">        <span class="token function">updateHostRoot</span><span class="token punctuation">(</span>currentFiber<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>currentFiber<span class="token punctuation">.</span>tag <span class="token operator">===</span> <span class="token constant">TAG_TEXT</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token comment">//如果是原生文本节点</span></span>
<span class="line">        <span class="token function">updateHostText</span><span class="token punctuation">(</span>currentFiber<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>currentFiber<span class="token punctuation">.</span>tag <span class="token operator">===</span> <span class="token constant">TAG_HOST</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token comment">//如果是原生DOM节点</span></span>
<span class="line">        <span class="token function">updateHostComponent</span><span class="token punctuation">(</span>currentFiber<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>currentFiber<span class="token punctuation">.</span>tag <span class="token operator">===</span> <span class="token constant">TAG_CLASS</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token comment">//如果是类组件</span></span>
<span class="line">        <span class="token function">updateClassComponent</span><span class="token punctuation">(</span>currentFiber<span class="token punctuation">)</span></span>
<span class="line"><span class="token operator">+</span>    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>currentFiber<span class="token punctuation">.</span>tag <span class="token operator">===</span> <span class="token constant">TAG_FUNCTION</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token comment">//如果是函数组件</span></span>
<span class="line"><span class="token operator">+</span>        <span class="token function">updateFunctionComponent</span><span class="token punctuation">(</span>currentFiber<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token operator">+</span>    <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"><span class="token operator">+</span><span class="token keyword">function</span> <span class="token function">updateFunctionComponent</span><span class="token punctuation">(</span><span class="token parameter">currentFiber</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line"><span class="token operator">+</span>    <span class="token keyword">const</span> newChildren <span class="token operator">=</span> <span class="token punctuation">[</span>currentFiber<span class="token punctuation">.</span><span class="token function">type</span><span class="token punctuation">(</span>currentFiber<span class="token punctuation">.</span>props<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token operator">+</span>    <span class="token function">reconcileChildren</span><span class="token punctuation">(</span>currentFiber<span class="token punctuation">,</span> newChildren<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token operator">+</span><span class="token punctuation">}</span></span>
<span class="line"><span class="token keyword">function</span> <span class="token function">updateClassComponent</span><span class="token punctuation">(</span><span class="token parameter">currentFiber</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">if</span> <span class="token punctuation">(</span>currentFiber<span class="token punctuation">.</span>stateNode <span class="token operator">===</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        currentFiber<span class="token punctuation">.</span>stateNode <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">currentFiber<span class="token punctuation">.</span>type</span><span class="token punctuation">(</span>currentFiber<span class="token punctuation">.</span>props<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        currentFiber<span class="token punctuation">.</span>stateNode<span class="token punctuation">.</span>internalFiber <span class="token operator">=</span> currentFiber<span class="token punctuation">;</span></span>
<span class="line">        currentFiber<span class="token punctuation">.</span>updateQueue <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">UpdateQueue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    currentFiber<span class="token punctuation">.</span>stateNode<span class="token punctuation">.</span>state <span class="token operator">=</span> currentFiber<span class="token punctuation">.</span>updateQueue<span class="token punctuation">.</span><span class="token function">forceUpdate</span><span class="token punctuation">(</span>currentFiber<span class="token punctuation">.</span>stateNode<span class="token punctuation">.</span>state<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">const</span> newChildren <span class="token operator">=</span> <span class="token punctuation">[</span>currentFiber<span class="token punctuation">.</span>stateNode<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token function">reconcileChildren</span><span class="token punctuation">(</span>currentFiber<span class="token punctuation">,</span> newChildren<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"><span class="token keyword">function</span> <span class="token function">updateHostText</span><span class="token punctuation">(</span><span class="token parameter">currentFiber</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>currentFiber<span class="token punctuation">.</span>stateNode<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        currentFiber<span class="token punctuation">.</span>stateNode <span class="token operator">=</span> <span class="token function">createDOM</span><span class="token punctuation">(</span>currentFiber<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//先创建真实的DOM节点</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"><span class="token keyword">function</span> <span class="token function">updateHostRoot</span><span class="token punctuation">(</span><span class="token parameter">currentFiber</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token comment">//如果是根节点</span></span>
<span class="line">    <span class="token keyword">const</span> newChildren <span class="token operator">=</span> currentFiber<span class="token punctuation">.</span>props<span class="token punctuation">.</span>children<span class="token punctuation">;</span><span class="token comment">//直接渲染子节点</span></span>
<span class="line">    <span class="token function">reconcileChildren</span><span class="token punctuation">(</span>currentFiber<span class="token punctuation">,</span> newChildren<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">function</span> <span class="token function">updateHostComponent</span><span class="token punctuation">(</span><span class="token parameter">currentFiber</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token comment">//如果是原生DOM节点</span></span>
<span class="line">    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>currentFiber<span class="token punctuation">.</span>stateNode<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        currentFiber<span class="token punctuation">.</span>stateNode <span class="token operator">=</span> <span class="token function">createDOM</span><span class="token punctuation">(</span>currentFiber<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//先创建真实的DOM节点</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    <span class="token keyword">const</span> newChildren <span class="token operator">=</span> currentFiber<span class="token punctuation">.</span>props<span class="token punctuation">.</span>children<span class="token punctuation">;</span></span>
<span class="line">    <span class="token function">reconcileChildren</span><span class="token punctuation">(</span>currentFiber<span class="token punctuation">,</span> newChildren<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"><span class="token keyword">function</span> <span class="token function">createDOM</span><span class="token punctuation">(</span><span class="token parameter">currentFiber</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">if</span> <span class="token punctuation">(</span>currentFiber<span class="token punctuation">.</span>type <span class="token operator">===</span> <span class="token constant">ELEMENT_TEXT</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">return</span> document<span class="token punctuation">.</span><span class="token function">createTextNode</span><span class="token punctuation">(</span>currentFiber<span class="token punctuation">.</span>props<span class="token punctuation">.</span>text<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    <span class="token keyword">const</span> stateNode <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span>currentFiber<span class="token punctuation">.</span>type<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token function">updateDOM</span><span class="token punctuation">(</span>stateNode<span class="token punctuation">,</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> currentFiber<span class="token punctuation">.</span>props<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">return</span> stateNode<span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">function</span> <span class="token function">reconcileChildren</span><span class="token punctuation">(</span><span class="token parameter">currentFiber<span class="token punctuation">,</span> newChildren</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">let</span> newChildIndex <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token comment">//新虚拟DOM数组中的索引</span></span>
<span class="line">    <span class="token keyword">let</span> oldFiber <span class="token operator">=</span> currentFiber<span class="token punctuation">.</span>alternate <span class="token operator">&amp;&amp;</span> currentFiber<span class="token punctuation">.</span>alternate<span class="token punctuation">.</span>child<span class="token punctuation">;</span><span class="token comment">//父Fiber中的第一个子Fiber</span></span>
<span class="line">    <span class="token keyword">let</span> prevSibling<span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">while</span> <span class="token punctuation">(</span>newChildIndex <span class="token operator">&lt;</span> newChildren<span class="token punctuation">.</span>length <span class="token operator">||</span> oldFiber<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">const</span> newChild <span class="token operator">=</span> newChildren<span class="token punctuation">[</span>newChildIndex<span class="token punctuation">]</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">let</span> newFiber<span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">const</span> sameType <span class="token operator">=</span> oldFiber <span class="token operator">&amp;&amp;</span> newChild <span class="token operator">&amp;&amp;</span> newChild<span class="token punctuation">.</span>type <span class="token operator">===</span> oldFiber<span class="token punctuation">.</span>type<span class="token punctuation">;</span><span class="token comment">//新旧都有，并且元素类型一样</span></span>
<span class="line">        <span class="token keyword">let</span> tag<span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">if</span> <span class="token punctuation">(</span>newChild <span class="token operator">&amp;&amp;</span> <span class="token keyword">typeof</span> newChild<span class="token punctuation">.</span>type <span class="token operator">===</span> <span class="token string">&#39;function&#39;</span> <span class="token operator">&amp;&amp;</span> newChild<span class="token punctuation">.</span>type<span class="token punctuation">.</span>prototype<span class="token punctuation">.</span>isReactComponent<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">            tag <span class="token operator">=</span> <span class="token constant">TAG_CLASS</span><span class="token punctuation">;</span><span class="token comment">//类组件</span></span>
<span class="line"><span class="token operator">+</span>        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>newChild <span class="token operator">&amp;&amp;</span> <span class="token keyword">typeof</span> newChild<span class="token punctuation">.</span>type <span class="token operator">===</span> <span class="token string">&#39;function&#39;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line"><span class="token operator">+</span>            tag <span class="token operator">=</span> <span class="token constant">TAG_FUNCTION</span><span class="token punctuation">;</span><span class="token comment">//函数组件</span></span>
<span class="line"><span class="token operator">+</span>        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>newChild <span class="token operator">&amp;&amp;</span> newChild<span class="token punctuation">.</span>type <span class="token operator">===</span> <span class="token constant">ELEMENT_TEXT</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">            tag <span class="token operator">=</span> <span class="token constant">TAG_TEXT</span><span class="token punctuation">;</span><span class="token comment">//文本</span></span>
<span class="line">        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>newChild <span class="token operator">&amp;&amp;</span> <span class="token keyword">typeof</span> newChild<span class="token punctuation">.</span>type <span class="token operator">===</span> <span class="token string">&#39;string&#39;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">            tag <span class="token operator">=</span> <span class="token constant">TAG_HOST</span><span class="token punctuation">;</span><span class="token comment">//原生DOM组件</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">        <span class="token keyword">if</span> <span class="token punctuation">(</span>sameType<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">            newFiber <span class="token operator">=</span> <span class="token punctuation">{</span></span>
<span class="line">                tag<span class="token punctuation">,</span><span class="token comment">//标记Fiber类型，例如是函数组件或者原生组件</span></span>
<span class="line">                <span class="token literal-property property">type</span><span class="token operator">:</span> oldFiber<span class="token punctuation">.</span>type<span class="token punctuation">,</span><span class="token comment">//具体的元素类型</span></span>
<span class="line">                <span class="token literal-property property">props</span><span class="token operator">:</span> newChild<span class="token punctuation">.</span>props<span class="token punctuation">,</span><span class="token comment">//新的属性对象</span></span>
<span class="line">                <span class="token literal-property property">stateNode</span><span class="token operator">:</span> oldFiber<span class="token punctuation">.</span>stateNode<span class="token punctuation">,</span><span class="token comment">//原生组件的话就存放DOM节点，类组件的话是类组件实例，函数组件的话为空，因为没有实例</span></span>
<span class="line">                <span class="token keyword">return</span><span class="token operator">:</span> currentFiber<span class="token punctuation">,</span><span class="token comment">//父Fiber</span></span>
<span class="line">                <span class="token literal-property property">updateQueue</span><span class="token operator">:</span> oldFiber<span class="token punctuation">.</span>updateQueue <span class="token operator">||</span> <span class="token keyword">new</span> <span class="token class-name">UpdateQueue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line">                <span class="token literal-property property">alternate</span><span class="token operator">:</span> oldFiber<span class="token punctuation">,</span><span class="token comment">//上一个Fiber 指向旧树中的节点</span></span>
<span class="line">                <span class="token literal-property property">effectTag</span><span class="token operator">:</span> <span class="token function">deepEquals</span><span class="token punctuation">(</span>oldFiber<span class="token punctuation">.</span>props<span class="token punctuation">,</span> newChild<span class="token punctuation">.</span>props<span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token keyword">null</span> <span class="token operator">:</span> <span class="token constant">UPDATE</span><span class="token punctuation">,</span><span class="token comment">//副作用标识</span></span>
<span class="line">            <span class="token punctuation">}</span></span>
<span class="line">        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token keyword">if</span> <span class="token punctuation">(</span>newChild<span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token comment">//类型不一样，创建新的Fiber,旧的不复用了</span></span>
<span class="line">                newFiber <span class="token operator">=</span> <span class="token punctuation">{</span></span>
<span class="line">                    tag<span class="token punctuation">,</span><span class="token comment">//原生DOM组件</span></span>
<span class="line">                    <span class="token literal-property property">type</span><span class="token operator">:</span> newChild<span class="token punctuation">.</span>type<span class="token punctuation">,</span><span class="token comment">//具体的元素类型</span></span>
<span class="line">                    <span class="token literal-property property">props</span><span class="token operator">:</span> newChild<span class="token punctuation">.</span>props<span class="token punctuation">,</span><span class="token comment">//新的属性对象</span></span>
<span class="line">                    <span class="token literal-property property">stateNode</span><span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span><span class="token comment">//stateNode肯定是空的</span></span>
<span class="line">                    <span class="token keyword">return</span><span class="token operator">:</span> currentFiber<span class="token punctuation">,</span><span class="token comment">//父Fiber</span></span>
<span class="line">                    <span class="token literal-property property">effectTag</span><span class="token operator">:</span> <span class="token constant">PLACEMENT</span> <span class="token comment">//副作用标识 </span></span>
<span class="line">                <span class="token punctuation">}</span></span>
<span class="line">            <span class="token punctuation">}</span></span>
<span class="line">            <span class="token keyword">if</span> <span class="token punctuation">(</span>oldFiber<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">                oldFiber<span class="token punctuation">.</span>effectTag <span class="token operator">=</span> <span class="token constant">DELETION</span><span class="token punctuation">;</span></span>
<span class="line">                deletions<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>oldFiber<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">            <span class="token punctuation">}</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">        <span class="token keyword">if</span> <span class="token punctuation">(</span>oldFiber<span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token comment">//比较完一个元素了，老Fiber向后移动1位</span></span>
<span class="line">            oldFiber <span class="token operator">=</span> oldFiber<span class="token punctuation">.</span>sibling<span class="token punctuation">;</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">        <span class="token keyword">if</span> <span class="token punctuation">(</span>newFiber<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token keyword">if</span> <span class="token punctuation">(</span>newChildIndex <span class="token operator">===</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">                currentFiber<span class="token punctuation">.</span>child <span class="token operator">=</span> newFiber<span class="token punctuation">;</span><span class="token comment">//第一个子节点挂到父节点的child属性上</span></span>
<span class="line">            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span></span>
<span class="line">                prevSibling<span class="token punctuation">.</span>sibling <span class="token operator">=</span> newFiber<span class="token punctuation">;</span></span>
<span class="line">            <span class="token punctuation">}</span></span>
<span class="line">            prevSibling <span class="token operator">=</span> newFiber<span class="token punctuation">;</span><span class="token comment">//然后newFiber变成了上一个哥哥了</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">        newChildIndex<span class="token operator">++</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">function</span> <span class="token function">updateDOM</span><span class="token punctuation">(</span><span class="token parameter">stateNode<span class="token punctuation">,</span> oldProps<span class="token punctuation">,</span> newProps</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token function">setProps</span><span class="token punctuation">(</span>stateNode<span class="token punctuation">,</span> oldProps<span class="token punctuation">,</span> newProps<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"><span class="token keyword">function</span> <span class="token function">completeUnitOfWork</span><span class="token punctuation">(</span><span class="token parameter">currentFiber</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">const</span> returnFiber <span class="token operator">=</span> currentFiber<span class="token punctuation">.</span>return<span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">if</span> <span class="token punctuation">(</span>returnFiber<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>returnFiber<span class="token punctuation">.</span>firstEffect<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">            returnFiber<span class="token punctuation">.</span>firstEffect <span class="token operator">=</span> currentFiber<span class="token punctuation">.</span>firstEffect<span class="token punctuation">;</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token operator">!</span>currentFiber<span class="token punctuation">.</span>lastEffect<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token operator">!</span>returnFiber<span class="token punctuation">.</span>lastEffect<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">                returnFiber<span class="token punctuation">.</span>lastEffect<span class="token punctuation">.</span>nextEffect <span class="token operator">=</span> currentFiber<span class="token punctuation">.</span>firstEffect<span class="token punctuation">;</span></span>
<span class="line">            <span class="token punctuation">}</span></span>
<span class="line">            returnFiber<span class="token punctuation">.</span>lastEffect <span class="token operator">=</span> currentFiber<span class="token punctuation">.</span>lastEffect<span class="token punctuation">;</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">        <span class="token keyword">const</span> effectTag <span class="token operator">=</span> currentFiber<span class="token punctuation">.</span>effectTag<span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">if</span> <span class="token punctuation">(</span>effectTag<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token operator">!</span>returnFiber<span class="token punctuation">.</span>lastEffect<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">                returnFiber<span class="token punctuation">.</span>lastEffect<span class="token punctuation">.</span>nextEffect <span class="token operator">=</span> currentFiber<span class="token punctuation">;</span></span>
<span class="line">            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span></span>
<span class="line">                returnFiber<span class="token punctuation">.</span>firstEffect <span class="token operator">=</span> currentFiber<span class="token punctuation">;</span></span>
<span class="line">            <span class="token punctuation">}</span></span>
<span class="line">            returnFiber<span class="token punctuation">.</span>lastEffect <span class="token operator">=</span> currentFiber<span class="token punctuation">;</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">function</span> <span class="token function">workLoop</span><span class="token punctuation">(</span><span class="token parameter">deadline</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">let</span> shouldYield <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">while</span> <span class="token punctuation">(</span>nextUnitOfWork <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>shouldYield<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        nextUnitOfWork <span class="token operator">=</span> <span class="token function">performUnitOfWork</span><span class="token punctuation">(</span>nextUnitOfWork<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//执行一个任务并返回下一个任务</span></span>
<span class="line">        shouldYield <span class="token operator">=</span> deadline<span class="token punctuation">.</span><span class="token function">timeRemaining</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">1</span><span class="token punctuation">;</span><span class="token comment">//如果剩余时间小于1毫秒就说明没有时间了，需要把控制权让给浏览器</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    <span class="token comment">//如果没有下一个执行单元了，并且当前渲染树存在，则进行提交阶段</span></span>
<span class="line">    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>nextUnitOfWork <span class="token operator">&amp;&amp;</span> workInProgressRoot<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token function">commitRoot</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    <span class="token function">requestIdleCallback</span><span class="token punctuation">(</span>workLoop<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"><span class="token comment">//开始在空闲时间执行workLoop</span></span>
<span class="line"><span class="token function">requestIdleCallback</span><span class="token punctuation">(</span>workLoop<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="_6-实现hooks" tabindex="-1"><a class="header-anchor" href="#_6-实现hooks"><span>6.实现hooks</span></a></h2><h3 id="_6-1-src-index-js" tabindex="-1"><a class="header-anchor" href="#_6-1-src-index-js"><span>6.1 src\\index.js</span></a></h3><p>src\\index.js</p><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text"><pre><code class="language-text"><span class="line">import React from &#39;./react&#39;;</span>
<span class="line">import ReactDOM from &#39;./react-dom&#39;;</span>
<span class="line"></span>
<span class="line">+function reducer(state, action) {</span>
<span class="line">+  switch (action.type) {</span>
<span class="line">+    case &#39;ADD&#39;:</span>
<span class="line">+      return { count: state.count + 1 };</span>
<span class="line">+    default:</span>
<span class="line">+      return state;</span>
<span class="line">+  }</span>
<span class="line">+}</span>
<span class="line">+function FunctionCounter() {</span>
<span class="line">+  const [numberState, setNumberState] = React.useState({ number: 0 });</span>
<span class="line">+  const [countState, dispatch] = React.useReducer(reducer, { count: 0 });</span>
<span class="line">+  return (</span>
<span class="line">+    &lt;div&gt;</span>
<span class="line">+      &lt;h1 onClick={() =&gt; setNumberState(state =&gt; ({ number: state.number + 1 }))}&gt;</span>
<span class="line">+        Count: {numberState.number}</span>
<span class="line">+      &lt;/h1 &gt;</span>
<span class="line">+      &lt;hr /&gt;</span>
<span class="line">+      &lt;h1 onClick={() =&gt; dispatch({ type: &#39;ADD&#39; })}&gt;</span>
<span class="line">+        Count: {countState.count}</span>
<span class="line">+      &lt;/h1 &gt;</span>
<span class="line">+    &lt;/div&gt;</span>
<span class="line">+  )</span>
<span class="line">+}</span>
<span class="line">ReactDOM.render(</span>
<span class="line">  &lt;FunctionCounter /&gt;,</span>
<span class="line">  document.getElementById(&#39;root&#39;)</span>
<span class="line">);</span>
<span class="line"></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_6-2-src-react-js" tabindex="-1"><a class="header-anchor" href="#_6-2-src-react-js"><span>6.2 src\\react.js</span></a></h3><p>src\\react.js</p><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code class="language-javascript"><span class="line"><span class="token keyword">import</span> <span class="token punctuation">{</span> <span class="token constant">ELEMENT_TEXT</span> <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&#39;./constants&#39;</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">import</span> <span class="token punctuation">{</span> Update<span class="token punctuation">,</span> UpdateQueue <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&#39;./updateQueue&#39;</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token operator">+</span><span class="token keyword">import</span> <span class="token punctuation">{</span> scheduleRoot<span class="token punctuation">,</span>useState<span class="token punctuation">,</span>useReducer<span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&#39;./scheduler&#39;</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">function</span> <span class="token function">createElement</span><span class="token punctuation">(</span><span class="token parameter">type<span class="token punctuation">,</span> config<span class="token punctuation">,</span> <span class="token operator">...</span>children</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">delete</span> config<span class="token punctuation">.</span>__self<span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">delete</span> config<span class="token punctuation">.</span>__source<span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">return</span> <span class="token punctuation">{</span></span>
<span class="line">        type<span class="token punctuation">,</span></span>
<span class="line">        <span class="token literal-property property">props</span><span class="token operator">:</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token operator">...</span>config<span class="token punctuation">,</span></span>
<span class="line">            <span class="token literal-property property">children</span><span class="token operator">:</span> children<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span></span>
<span class="line">                <span class="token parameter">child</span> <span class="token operator">=&gt;</span> <span class="token keyword">typeof</span> child <span class="token operator">===</span> <span class="token string">&quot;object&quot;</span> <span class="token operator">?</span></span>
<span class="line">                    <span class="token literal-property property">child</span> <span class="token operator">:</span></span>
<span class="line">                    <span class="token punctuation">{</span> <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token constant">ELEMENT_TEXT</span><span class="token punctuation">,</span> <span class="token literal-property property">props</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token literal-property property">text</span><span class="token operator">:</span> child<span class="token punctuation">,</span> <span class="token literal-property property">children</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token punctuation">}</span> <span class="token punctuation">}</span><span class="token punctuation">)</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"><span class="token keyword">class</span> <span class="token class-name">Component</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter">props</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">this</span><span class="token punctuation">.</span>props <span class="token operator">=</span> props<span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">this</span><span class="token punctuation">.</span>updateQueue <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">UpdateQueue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    <span class="token function">setState</span><span class="token punctuation">(</span><span class="token parameter">payload</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">this</span><span class="token punctuation">.</span>internalFiber<span class="token punctuation">.</span>updateQueue<span class="token punctuation">.</span><span class="token function">enqueueUpdate</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Update</span><span class="token punctuation">(</span>payload<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token function">scheduleRoot</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"><span class="token class-name">Component</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span>isReactComponent <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">let</span> React <span class="token operator">=</span> <span class="token punctuation">{</span></span>
<span class="line">    createElement<span class="token punctuation">,</span></span>
<span class="line">    Component<span class="token punctuation">,</span></span>
<span class="line"><span class="token operator">+</span>    useState<span class="token punctuation">,</span></span>
<span class="line"><span class="token operator">+</span>    useReducer</span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"><span class="token keyword">export</span> <span class="token keyword">default</span> React<span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_6-3-src-scheduler-js" tabindex="-1"><a class="header-anchor" href="#_6-3-src-scheduler-js"><span>6.3 src\\scheduler.js</span></a></h3><p>src\\scheduler.js</p><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code class="language-javascript"><span class="line"><span class="token keyword">import</span> <span class="token punctuation">{</span> setProps<span class="token punctuation">,</span> deepEquals <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&#39;./utils&#39;</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token operator">+</span><span class="token keyword">import</span> <span class="token punctuation">{</span> UpdateQueue<span class="token punctuation">,</span> Update <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&#39;./updateQueue&#39;</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">import</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token constant">ELEMENT_TEXT</span><span class="token punctuation">,</span> <span class="token constant">TAG_ROOT</span><span class="token punctuation">,</span> <span class="token constant">TAG_HOST</span><span class="token punctuation">,</span> <span class="token constant">TAG_TEXT</span><span class="token punctuation">,</span> <span class="token constant">TAG_CLASS</span><span class="token punctuation">,</span> <span class="token constant">TAG_FUNCTION</span><span class="token punctuation">,</span> <span class="token constant">PLACEMENT</span><span class="token punctuation">,</span> <span class="token constant">DELETION</span><span class="token punctuation">,</span> <span class="token constant">UPDATE</span></span>
<span class="line"><span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&#39;./constants&#39;</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">let</span> currentRoot <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>         <span class="token comment">//当前的根Fiber</span></span>
<span class="line"><span class="token keyword">let</span> workInProgressRoot <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>  <span class="token comment">//正在渲染中的根Fiber</span></span>
<span class="line"><span class="token keyword">let</span> nextUnitOfWork <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>      <span class="token comment">//下一个工作单元</span></span>
<span class="line"><span class="token keyword">let</span> deletions <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>             <span class="token comment">//要删除的fiber节点</span></span>
<span class="line"><span class="token operator">+</span><span class="token keyword">let</span> workInProgressFiber <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span> <span class="token comment">//正在工作中的fiber</span></span>
<span class="line"><span class="token operator">+</span><span class="token keyword">let</span> hookIndex <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>              <span class="token comment">//hook索引</span></span>
<span class="line"><span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">scheduleRoot</span><span class="token punctuation">(</span><span class="token parameter">rootFiber</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">if</span> <span class="token punctuation">(</span>rootFiber<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        workInProgressRoot <span class="token operator">=</span> rootFiber<span class="token punctuation">;</span> <span class="token comment">//把当前树设置为nextUnitOfWork开始进行调度</span></span>
<span class="line">    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">if</span> <span class="token punctuation">(</span>currentRoot<span class="token punctuation">.</span>alternate<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">            workInProgressRoot <span class="token operator">=</span> currentRoot<span class="token punctuation">.</span>alternate<span class="token punctuation">;</span></span>
<span class="line">            workInProgressRoot<span class="token punctuation">.</span>alternate <span class="token operator">=</span> currentRoot<span class="token punctuation">;</span></span>
<span class="line">        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span></span>
<span class="line">            workInProgressRoot <span class="token operator">=</span> <span class="token punctuation">{</span></span>
<span class="line">                <span class="token operator">...</span>currentRoot<span class="token punctuation">,</span></span>
<span class="line">                <span class="token literal-property property">alternate</span><span class="token operator">:</span> currentRoot</span>
<span class="line">            <span class="token punctuation">}</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    deletions<span class="token punctuation">.</span>length <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span></span>
<span class="line">    nextUnitOfWork <span class="token operator">=</span> workInProgressRoot<span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">function</span> <span class="token function">commitRoot</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    deletions<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span>commitWork<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">let</span> currentFiber <span class="token operator">=</span> workInProgressRoot<span class="token punctuation">.</span>firstEffect<span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">while</span> <span class="token punctuation">(</span>currentFiber<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token function">commitWork</span><span class="token punctuation">(</span>currentFiber<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        currentFiber <span class="token operator">=</span> currentFiber<span class="token punctuation">.</span>nextEffect<span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    deletions<span class="token punctuation">.</span>length <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token comment">//先把要删除的节点清空掉</span></span>
<span class="line">    workInProgressRoot<span class="token punctuation">.</span>firstEffect <span class="token operator">=</span> workInProgressRoot<span class="token punctuation">.</span>lastEffect <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span></span>
<span class="line">    currentRoot <span class="token operator">=</span> workInProgressRoot<span class="token punctuation">;</span></span>
<span class="line">    workInProgressRoot <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"><span class="token keyword">function</span> <span class="token function">commitWork</span><span class="token punctuation">(</span><span class="token parameter">currentFiber</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>currentFiber<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">return</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    <span class="token keyword">let</span> returnFiber <span class="token operator">=</span> currentFiber<span class="token punctuation">.</span>return<span class="token punctuation">;</span><span class="token comment">//先获取父Fiber</span></span>
<span class="line">    <span class="token keyword">while</span> <span class="token punctuation">(</span>returnFiber<span class="token punctuation">.</span>tag <span class="token operator">!==</span> <span class="token constant">TAG_HOST</span> <span class="token operator">&amp;&amp;</span> returnFiber<span class="token punctuation">.</span>tag <span class="token operator">!==</span> <span class="token constant">TAG_ROOT</span> <span class="token operator">&amp;&amp;</span> returnFiber<span class="token punctuation">.</span>tag <span class="token operator">!==</span> <span class="token constant">TAG_TEXT</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token comment">//如果不是DOM节点就一直向上找</span></span>
<span class="line">        returnFiber <span class="token operator">=</span> returnFiber<span class="token punctuation">.</span>return<span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    <span class="token keyword">const</span> domReturn <span class="token operator">=</span> returnFiber<span class="token punctuation">.</span>stateNode<span class="token punctuation">;</span><span class="token comment">//获取父的DOM节点</span></span>
<span class="line">    <span class="token keyword">if</span> <span class="token punctuation">(</span>currentFiber<span class="token punctuation">.</span>effectTag <span class="token operator">===</span> <span class="token constant">PLACEMENT</span> <span class="token operator">&amp;&amp;</span> currentFiber<span class="token punctuation">.</span>stateNode <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token comment">//如果是新增DOM节点</span></span>
<span class="line">        <span class="token keyword">let</span> nextFiber <span class="token operator">=</span> currentFiber<span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">while</span> <span class="token punctuation">(</span>nextFiber<span class="token punctuation">.</span>tag <span class="token operator">!==</span> <span class="token constant">TAG_HOST</span> <span class="token operator">&amp;&amp;</span> nextFiber<span class="token punctuation">.</span>tag <span class="token operator">!==</span> <span class="token constant">TAG_TEXT</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token comment">//必须向下找到一个DOM节点</span></span>
<span class="line">            nextFiber <span class="token operator">=</span> nextFiber<span class="token punctuation">.</span>child<span class="token punctuation">;</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">        domReturn<span class="token punctuation">.</span><span class="token function">appendChild</span><span class="token punctuation">(</span>nextFiber<span class="token punctuation">.</span>stateNode<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>currentFiber<span class="token punctuation">.</span>effectTag <span class="token operator">===</span> <span class="token constant">DELETION</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token comment">//如果是删除则删除并返回</span></span>
<span class="line">        <span class="token function">commitDeletion</span><span class="token punctuation">(</span>currentFiber<span class="token punctuation">,</span> domReturn<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>currentFiber<span class="token punctuation">.</span>effectTag <span class="token operator">===</span> <span class="token constant">UPDATE</span> <span class="token operator">&amp;&amp;</span> currentFiber<span class="token punctuation">.</span>stateNode <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token comment">//如果是更新</span></span>
<span class="line">        <span class="token keyword">if</span> <span class="token punctuation">(</span>currentFiber<span class="token punctuation">.</span>type <span class="token operator">===</span> <span class="token constant">ELEMENT_TEXT</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token keyword">if</span> <span class="token punctuation">(</span>currentFiber<span class="token punctuation">.</span>alternate<span class="token punctuation">.</span>props<span class="token punctuation">.</span>text <span class="token operator">!==</span> currentFiber<span class="token punctuation">.</span>props<span class="token punctuation">.</span>text<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">                currentFiber<span class="token punctuation">.</span>stateNode<span class="token punctuation">.</span>textContent <span class="token operator">=</span> currentFiber<span class="token punctuation">.</span>props<span class="token punctuation">.</span>text<span class="token punctuation">;</span></span>
<span class="line">            <span class="token punctuation">}</span></span>
<span class="line">        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token function">updateDOM</span><span class="token punctuation">(</span>currentFiber<span class="token punctuation">.</span>stateNode<span class="token punctuation">,</span> currentFiber<span class="token punctuation">.</span>alternate<span class="token punctuation">.</span>props<span class="token punctuation">,</span> currentFiber<span class="token punctuation">.</span>props<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    currentFiber<span class="token punctuation">.</span>effectTag <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"><span class="token keyword">function</span> <span class="token function">commitDeletion</span><span class="token punctuation">(</span><span class="token parameter">currentFiber<span class="token punctuation">,</span> domReturn</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">if</span> <span class="token punctuation">(</span>currentFiber<span class="token punctuation">.</span>tag <span class="token operator">===</span> <span class="token constant">TAG_HOST</span> <span class="token operator">||</span> currentFiber<span class="token punctuation">.</span>tag <span class="token operator">===</span> <span class="token constant">TAG_TEXT</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        domReturn<span class="token punctuation">.</span><span class="token function">removeChild</span><span class="token punctuation">(</span>currentFiber<span class="token punctuation">.</span>stateNode<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token function">commitDeletion</span><span class="token punctuation">(</span>currentFiber<span class="token punctuation">.</span>child<span class="token punctuation">,</span> domReturn<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"><span class="token keyword">function</span> <span class="token function">performUnitOfWork</span><span class="token punctuation">(</span><span class="token parameter">currentFiber</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token function">beginWork</span><span class="token punctuation">(</span>currentFiber<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//开始渲染前的Fiber,就是把子元素变成子fiber</span></span>
<span class="line"></span>
<span class="line">    <span class="token keyword">if</span> <span class="token punctuation">(</span>currentFiber<span class="token punctuation">.</span>child<span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token comment">//如果子节点就返回第一个子节点</span></span>
<span class="line">        <span class="token keyword">return</span> currentFiber<span class="token punctuation">.</span>child<span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">    <span class="token keyword">while</span> <span class="token punctuation">(</span>currentFiber<span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token comment">//如果没有子节点说明当前节点已经完成了渲染工作</span></span>
<span class="line">        <span class="token function">completeUnitOfWork</span><span class="token punctuation">(</span>currentFiber<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//可以结束此fiber的渲染了 </span></span>
<span class="line">        <span class="token keyword">if</span> <span class="token punctuation">(</span>currentFiber<span class="token punctuation">.</span>sibling<span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token comment">//如果它有弟弟就返回弟弟</span></span>
<span class="line">            <span class="token keyword">return</span> currentFiber<span class="token punctuation">.</span>sibling<span class="token punctuation">;</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">        currentFiber <span class="token operator">=</span> currentFiber<span class="token punctuation">.</span>return<span class="token punctuation">;</span><span class="token comment">//如果没有弟弟让爸爸完成，然后找叔叔</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">function</span> <span class="token function">beginWork</span><span class="token punctuation">(</span><span class="token parameter">currentFiber</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">if</span> <span class="token punctuation">(</span>currentFiber<span class="token punctuation">.</span>tag <span class="token operator">===</span> <span class="token constant">TAG_ROOT</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token comment">//如果是根节点</span></span>
<span class="line">        <span class="token function">updateHostRoot</span><span class="token punctuation">(</span>currentFiber<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>currentFiber<span class="token punctuation">.</span>tag <span class="token operator">===</span> <span class="token constant">TAG_TEXT</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token comment">//如果是原生文本节点</span></span>
<span class="line">        <span class="token function">updateHostText</span><span class="token punctuation">(</span>currentFiber<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>currentFiber<span class="token punctuation">.</span>tag <span class="token operator">===</span> <span class="token constant">TAG_HOST</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token comment">//如果是原生DOM节点</span></span>
<span class="line">        <span class="token function">updateHostComponent</span><span class="token punctuation">(</span>currentFiber<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>currentFiber<span class="token punctuation">.</span>tag <span class="token operator">===</span> <span class="token constant">TAG_CLASS</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token comment">//如果是类组件</span></span>
<span class="line">        <span class="token function">updateClassComponent</span><span class="token punctuation">(</span>currentFiber<span class="token punctuation">)</span></span>
<span class="line">    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>currentFiber<span class="token punctuation">.</span>tag <span class="token operator">===</span> <span class="token constant">TAG_FUNCTION</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token comment">//如果是函数组件</span></span>
<span class="line">        <span class="token function">updateFunctionComponent</span><span class="token punctuation">(</span>currentFiber<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"><span class="token keyword">function</span> <span class="token function">updateFunctionComponent</span><span class="token punctuation">(</span><span class="token parameter">currentFiber</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line"><span class="token operator">+</span>    workInProgressFiber <span class="token operator">=</span> currentFiber<span class="token punctuation">;</span></span>
<span class="line"><span class="token operator">+</span>    hookIndex <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token operator">+</span>    workInProgressFiber<span class="token punctuation">.</span>hooks <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">const</span> newChildren <span class="token operator">=</span> <span class="token punctuation">[</span>currentFiber<span class="token punctuation">.</span><span class="token function">type</span><span class="token punctuation">(</span>currentFiber<span class="token punctuation">.</span>props<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token function">reconcileChildren</span><span class="token punctuation">(</span>currentFiber<span class="token punctuation">,</span> newChildren<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"><span class="token keyword">function</span> <span class="token function">updateClassComponent</span><span class="token punctuation">(</span><span class="token parameter">currentFiber</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">if</span> <span class="token punctuation">(</span>currentFiber<span class="token punctuation">.</span>stateNode <span class="token operator">===</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        currentFiber<span class="token punctuation">.</span>stateNode <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">currentFiber<span class="token punctuation">.</span>type</span><span class="token punctuation">(</span>currentFiber<span class="token punctuation">.</span>props<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        currentFiber<span class="token punctuation">.</span>stateNode<span class="token punctuation">.</span>internalFiber <span class="token operator">=</span> currentFiber<span class="token punctuation">;</span></span>
<span class="line">        currentFiber<span class="token punctuation">.</span>updateQueue <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">UpdateQueue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    currentFiber<span class="token punctuation">.</span>stateNode<span class="token punctuation">.</span>state <span class="token operator">=</span> currentFiber<span class="token punctuation">.</span>updateQueue<span class="token punctuation">.</span><span class="token function">forceUpdate</span><span class="token punctuation">(</span>currentFiber<span class="token punctuation">.</span>stateNode<span class="token punctuation">.</span>state<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">const</span> newChildren <span class="token operator">=</span> <span class="token punctuation">[</span>currentFiber<span class="token punctuation">.</span>stateNode<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token function">reconcileChildren</span><span class="token punctuation">(</span>currentFiber<span class="token punctuation">,</span> newChildren<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"><span class="token keyword">function</span> <span class="token function">updateHostText</span><span class="token punctuation">(</span><span class="token parameter">currentFiber</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>currentFiber<span class="token punctuation">.</span>stateNode<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        currentFiber<span class="token punctuation">.</span>stateNode <span class="token operator">=</span> <span class="token function">createDOM</span><span class="token punctuation">(</span>currentFiber<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//先创建真实的DOM节点</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"><span class="token keyword">function</span> <span class="token function">updateHostRoot</span><span class="token punctuation">(</span><span class="token parameter">currentFiber</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token comment">//如果是根节点</span></span>
<span class="line">    <span class="token keyword">const</span> newChildren <span class="token operator">=</span> currentFiber<span class="token punctuation">.</span>props<span class="token punctuation">.</span>children<span class="token punctuation">;</span><span class="token comment">//直接渲染子节点</span></span>
<span class="line">    <span class="token function">reconcileChildren</span><span class="token punctuation">(</span>currentFiber<span class="token punctuation">,</span> newChildren<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">function</span> <span class="token function">updateHostComponent</span><span class="token punctuation">(</span><span class="token parameter">currentFiber</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token comment">//如果是原生DOM节点</span></span>
<span class="line">    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>currentFiber<span class="token punctuation">.</span>stateNode<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        currentFiber<span class="token punctuation">.</span>stateNode <span class="token operator">=</span> <span class="token function">createDOM</span><span class="token punctuation">(</span>currentFiber<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//先创建真实的DOM节点</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    <span class="token keyword">const</span> newChildren <span class="token operator">=</span> currentFiber<span class="token punctuation">.</span>props<span class="token punctuation">.</span>children<span class="token punctuation">;</span></span>
<span class="line">    <span class="token function">reconcileChildren</span><span class="token punctuation">(</span>currentFiber<span class="token punctuation">,</span> newChildren<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"><span class="token keyword">function</span> <span class="token function">createDOM</span><span class="token punctuation">(</span><span class="token parameter">currentFiber</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">if</span> <span class="token punctuation">(</span>currentFiber<span class="token punctuation">.</span>type <span class="token operator">===</span> <span class="token constant">ELEMENT_TEXT</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">return</span> document<span class="token punctuation">.</span><span class="token function">createTextNode</span><span class="token punctuation">(</span>currentFiber<span class="token punctuation">.</span>props<span class="token punctuation">.</span>text<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    <span class="token keyword">const</span> stateNode <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span>currentFiber<span class="token punctuation">.</span>type<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token function">updateDOM</span><span class="token punctuation">(</span>stateNode<span class="token punctuation">,</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> currentFiber<span class="token punctuation">.</span>props<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">return</span> stateNode<span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">function</span> <span class="token function">reconcileChildren</span><span class="token punctuation">(</span><span class="token parameter">currentFiber<span class="token punctuation">,</span> newChildren</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">let</span> newChildIndex <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token comment">//新虚拟DOM数组中的索引</span></span>
<span class="line">    <span class="token keyword">let</span> oldFiber <span class="token operator">=</span> currentFiber<span class="token punctuation">.</span>alternate <span class="token operator">&amp;&amp;</span> currentFiber<span class="token punctuation">.</span>alternate<span class="token punctuation">.</span>child<span class="token punctuation">;</span><span class="token comment">//父Fiber中的第一个子Fiber</span></span>
<span class="line">    <span class="token keyword">let</span> prevSibling<span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">while</span> <span class="token punctuation">(</span>newChildIndex <span class="token operator">&lt;</span> newChildren<span class="token punctuation">.</span>length <span class="token operator">||</span> oldFiber<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">const</span> newChild <span class="token operator">=</span> newChildren<span class="token punctuation">[</span>newChildIndex<span class="token punctuation">]</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">let</span> newFiber<span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">const</span> sameType <span class="token operator">=</span> oldFiber <span class="token operator">&amp;&amp;</span> newChild <span class="token operator">&amp;&amp;</span> newChild<span class="token punctuation">.</span>type <span class="token operator">===</span> oldFiber<span class="token punctuation">.</span>type<span class="token punctuation">;</span><span class="token comment">//新旧都有，并且元素类型一样</span></span>
<span class="line">        <span class="token keyword">let</span> tag<span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">if</span> <span class="token punctuation">(</span>newChild <span class="token operator">&amp;&amp;</span> <span class="token keyword">typeof</span> newChild<span class="token punctuation">.</span>type <span class="token operator">===</span> <span class="token string">&#39;function&#39;</span> <span class="token operator">&amp;&amp;</span> newChild<span class="token punctuation">.</span>type<span class="token punctuation">.</span>prototype<span class="token punctuation">.</span>isReactComponent<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">            tag <span class="token operator">=</span> <span class="token constant">TAG_CLASS</span><span class="token punctuation">;</span><span class="token comment">//类组件</span></span>
<span class="line">        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>newChild <span class="token operator">&amp;&amp;</span> <span class="token keyword">typeof</span> newChild<span class="token punctuation">.</span>type <span class="token operator">===</span> <span class="token string">&#39;function&#39;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">            tag <span class="token operator">=</span> <span class="token constant">TAG_FUNCTION</span><span class="token punctuation">;</span><span class="token comment">//函数组件</span></span>
<span class="line">        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>newChild <span class="token operator">&amp;&amp;</span> newChild<span class="token punctuation">.</span>type <span class="token operator">===</span> <span class="token constant">ELEMENT_TEXT</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">            tag <span class="token operator">=</span> <span class="token constant">TAG_TEXT</span><span class="token punctuation">;</span><span class="token comment">//文本</span></span>
<span class="line">        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>newChild <span class="token operator">&amp;&amp;</span> <span class="token keyword">typeof</span> newChild<span class="token punctuation">.</span>type <span class="token operator">===</span> <span class="token string">&#39;string&#39;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">            tag <span class="token operator">=</span> <span class="token constant">TAG_HOST</span><span class="token punctuation">;</span><span class="token comment">//原生DOM组件</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">        <span class="token keyword">if</span> <span class="token punctuation">(</span>sameType<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">            newFiber <span class="token operator">=</span> <span class="token punctuation">{</span></span>
<span class="line">                tag<span class="token punctuation">,</span><span class="token comment">//标记Fiber类型，例如是函数组件或者原生组件</span></span>
<span class="line">                <span class="token literal-property property">type</span><span class="token operator">:</span> oldFiber<span class="token punctuation">.</span>type<span class="token punctuation">,</span><span class="token comment">//具体的元素类型</span></span>
<span class="line">                <span class="token literal-property property">props</span><span class="token operator">:</span> newChild<span class="token punctuation">.</span>props<span class="token punctuation">,</span><span class="token comment">//新的属性对象</span></span>
<span class="line">                <span class="token literal-property property">stateNode</span><span class="token operator">:</span> oldFiber<span class="token punctuation">.</span>stateNode<span class="token punctuation">,</span><span class="token comment">//原生组件的话就存放DOM节点，类组件的话是类组件实例，函数组件的话为空，因为没有实例</span></span>
<span class="line">                <span class="token keyword">return</span><span class="token operator">:</span> currentFiber<span class="token punctuation">,</span><span class="token comment">//父Fiber</span></span>
<span class="line">                <span class="token literal-property property">updateQueue</span><span class="token operator">:</span> oldFiber<span class="token punctuation">.</span>updateQueue <span class="token operator">||</span> <span class="token keyword">new</span> <span class="token class-name">UpdateQueue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line">                <span class="token literal-property property">alternate</span><span class="token operator">:</span> oldFiber<span class="token punctuation">,</span><span class="token comment">//上一个Fiber 指向旧树中的节点</span></span>
<span class="line">                <span class="token literal-property property">effectTag</span><span class="token operator">:</span> <span class="token function">deepEquals</span><span class="token punctuation">(</span>oldFiber<span class="token punctuation">.</span>props<span class="token punctuation">,</span> newChild<span class="token punctuation">.</span>props<span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token keyword">null</span> <span class="token operator">:</span> <span class="token constant">UPDATE</span><span class="token punctuation">,</span><span class="token comment">//副作用标识</span></span>
<span class="line">            <span class="token punctuation">}</span></span>
<span class="line">        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token keyword">if</span> <span class="token punctuation">(</span>newChild<span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token comment">//类型不一样，创建新的Fiber,旧的不复用了</span></span>
<span class="line">                newFiber <span class="token operator">=</span> <span class="token punctuation">{</span></span>
<span class="line">                    tag<span class="token punctuation">,</span><span class="token comment">//原生DOM组件</span></span>
<span class="line">                    <span class="token literal-property property">type</span><span class="token operator">:</span> newChild<span class="token punctuation">.</span>type<span class="token punctuation">,</span><span class="token comment">//具体的元素类型</span></span>
<span class="line">                    <span class="token literal-property property">props</span><span class="token operator">:</span> newChild<span class="token punctuation">.</span>props<span class="token punctuation">,</span><span class="token comment">//新的属性对象</span></span>
<span class="line">                    <span class="token literal-property property">stateNode</span><span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span><span class="token comment">//stateNode肯定是空的</span></span>
<span class="line">                    <span class="token keyword">return</span><span class="token operator">:</span> currentFiber<span class="token punctuation">,</span><span class="token comment">//父Fiber</span></span>
<span class="line">                    <span class="token literal-property property">effectTag</span><span class="token operator">:</span> <span class="token constant">PLACEMENT</span> <span class="token comment">//副作用标识 </span></span>
<span class="line">                <span class="token punctuation">}</span></span>
<span class="line">            <span class="token punctuation">}</span></span>
<span class="line">            <span class="token keyword">if</span> <span class="token punctuation">(</span>oldFiber<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">                oldFiber<span class="token punctuation">.</span>effectTag <span class="token operator">=</span> <span class="token constant">DELETION</span><span class="token punctuation">;</span></span>
<span class="line">                deletions<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>oldFiber<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">            <span class="token punctuation">}</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">        <span class="token keyword">if</span> <span class="token punctuation">(</span>oldFiber<span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token comment">//比较完一个元素了，老Fiber向后移动1位</span></span>
<span class="line">            oldFiber <span class="token operator">=</span> oldFiber<span class="token punctuation">.</span>sibling<span class="token punctuation">;</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">        <span class="token keyword">if</span> <span class="token punctuation">(</span>newFiber<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token keyword">if</span> <span class="token punctuation">(</span>newChildIndex <span class="token operator">===</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">                currentFiber<span class="token punctuation">.</span>child <span class="token operator">=</span> newFiber<span class="token punctuation">;</span><span class="token comment">//第一个子节点挂到父节点的child属性上</span></span>
<span class="line">            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span></span>
<span class="line">                prevSibling<span class="token punctuation">.</span>sibling <span class="token operator">=</span> newFiber<span class="token punctuation">;</span></span>
<span class="line">            <span class="token punctuation">}</span></span>
<span class="line">            prevSibling <span class="token operator">=</span> newFiber<span class="token punctuation">;</span><span class="token comment">//然后newFiber变成了上一个哥哥了</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">        newChildIndex<span class="token operator">++</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">function</span> <span class="token function">updateDOM</span><span class="token punctuation">(</span><span class="token parameter">stateNode<span class="token punctuation">,</span> oldProps<span class="token punctuation">,</span> newProps</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token function">setProps</span><span class="token punctuation">(</span>stateNode<span class="token punctuation">,</span> oldProps<span class="token punctuation">,</span> newProps<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"><span class="token keyword">function</span> <span class="token function">completeUnitOfWork</span><span class="token punctuation">(</span><span class="token parameter">currentFiber</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">const</span> returnFiber <span class="token operator">=</span> currentFiber<span class="token punctuation">.</span>return<span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">if</span> <span class="token punctuation">(</span>returnFiber<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>returnFiber<span class="token punctuation">.</span>firstEffect<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">            returnFiber<span class="token punctuation">.</span>firstEffect <span class="token operator">=</span> currentFiber<span class="token punctuation">.</span>firstEffect<span class="token punctuation">;</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token operator">!</span>currentFiber<span class="token punctuation">.</span>lastEffect<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token operator">!</span>returnFiber<span class="token punctuation">.</span>lastEffect<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">                returnFiber<span class="token punctuation">.</span>lastEffect<span class="token punctuation">.</span>nextEffect <span class="token operator">=</span> currentFiber<span class="token punctuation">.</span>firstEffect<span class="token punctuation">;</span></span>
<span class="line">            <span class="token punctuation">}</span></span>
<span class="line">            returnFiber<span class="token punctuation">.</span>lastEffect <span class="token operator">=</span> currentFiber<span class="token punctuation">.</span>lastEffect<span class="token punctuation">;</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">        <span class="token keyword">const</span> effectTag <span class="token operator">=</span> currentFiber<span class="token punctuation">.</span>effectTag<span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">if</span> <span class="token punctuation">(</span>effectTag<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token operator">!</span>returnFiber<span class="token punctuation">.</span>lastEffect<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">                returnFiber<span class="token punctuation">.</span>lastEffect<span class="token punctuation">.</span>nextEffect <span class="token operator">=</span> currentFiber<span class="token punctuation">;</span></span>
<span class="line">            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span></span>
<span class="line">                returnFiber<span class="token punctuation">.</span>firstEffect <span class="token operator">=</span> currentFiber<span class="token punctuation">;</span></span>
<span class="line">            <span class="token punctuation">}</span></span>
<span class="line">            returnFiber<span class="token punctuation">.</span>lastEffect <span class="token operator">=</span> currentFiber<span class="token punctuation">;</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"><span class="token operator">+</span><span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">useReducer</span><span class="token punctuation">(</span><span class="token parameter">reducer<span class="token punctuation">,</span> initialValue</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line"><span class="token operator">+</span>    <span class="token keyword">let</span> oldHook <span class="token operator">=</span></span>
<span class="line"><span class="token operator">+</span>        workInProgressFiber<span class="token punctuation">.</span>alternate <span class="token operator">&amp;&amp;</span></span>
<span class="line"><span class="token operator">+</span>        workInProgressFiber<span class="token punctuation">.</span>alternate<span class="token punctuation">.</span>hooks <span class="token operator">&amp;&amp;</span></span>
<span class="line"><span class="token operator">+</span>        workInProgressFiber<span class="token punctuation">.</span>alternate<span class="token punctuation">.</span>hooks<span class="token punctuation">[</span>hookIndex<span class="token punctuation">]</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token operator">+</span>    <span class="token keyword">let</span> newHook <span class="token operator">=</span> oldHook<span class="token punctuation">;</span></span>
<span class="line"><span class="token operator">+</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>oldHook<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line"><span class="token operator">+</span>        oldHook<span class="token punctuation">.</span>state <span class="token operator">=</span> oldHook<span class="token punctuation">.</span>updateQueue<span class="token punctuation">.</span><span class="token function">forceUpdate</span><span class="token punctuation">(</span>oldHook<span class="token punctuation">.</span>state<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token operator">+</span>    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span></span>
<span class="line"><span class="token operator">+</span>        newHook <span class="token operator">=</span> <span class="token punctuation">{</span></span>
<span class="line"><span class="token operator">+</span>            state<span class="token operator">:</span> initialValue<span class="token punctuation">,</span></span>
<span class="line"><span class="token operator">+</span>            updateQueue<span class="token operator">:</span> <span class="token keyword">new</span> <span class="token class-name">UpdateQueue</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line"><span class="token operator">+</span>        <span class="token punctuation">}</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token operator">+</span>    <span class="token punctuation">}</span></span>
<span class="line"><span class="token operator">+</span>    <span class="token keyword">const</span> <span class="token function-variable function">dispatch</span> <span class="token operator">=</span> <span class="token parameter">action</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></span>
<span class="line"><span class="token operator">+</span>        newHook<span class="token punctuation">.</span>updateQueue<span class="token punctuation">.</span><span class="token function">enqueueUpdate</span><span class="token punctuation">(</span></span>
<span class="line"><span class="token operator">+</span>            <span class="token keyword">new</span> <span class="token class-name">Update</span><span class="token punctuation">(</span>reducer <span class="token operator">?</span> <span class="token function">reducer</span><span class="token punctuation">(</span>newHook<span class="token punctuation">.</span>state<span class="token punctuation">,</span> action<span class="token punctuation">)</span> <span class="token operator">:</span> action<span class="token punctuation">)</span></span>
<span class="line"><span class="token operator">+</span>        <span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token operator">+</span>        <span class="token function">scheduleRoot</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token operator">+</span>    <span class="token punctuation">}</span></span>
<span class="line"><span class="token operator">+</span>    workInProgressFiber<span class="token punctuation">.</span>hooks<span class="token punctuation">[</span>hookIndex<span class="token operator">++</span><span class="token punctuation">]</span> <span class="token operator">=</span> newHook<span class="token punctuation">;</span></span>
<span class="line"><span class="token operator">+</span>    <span class="token keyword">return</span> <span class="token punctuation">[</span>newHook<span class="token punctuation">.</span>state<span class="token punctuation">,</span> dispatch<span class="token punctuation">]</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token operator">+</span><span class="token punctuation">}</span></span>
<span class="line"><span class="token operator">+</span><span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">useState</span><span class="token punctuation">(</span><span class="token parameter">initState</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line"><span class="token operator">+</span>    <span class="token keyword">return</span> <span class="token function">useReducer</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> initState<span class="token punctuation">)</span></span>
<span class="line"><span class="token operator">+</span><span class="token punctuation">}</span></span>
<span class="line"><span class="token keyword">function</span> <span class="token function">workLoop</span><span class="token punctuation">(</span><span class="token parameter">deadline</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">let</span> shouldYield <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">while</span> <span class="token punctuation">(</span>nextUnitOfWork <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>shouldYield<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        nextUnitOfWork <span class="token operator">=</span> <span class="token function">performUnitOfWork</span><span class="token punctuation">(</span>nextUnitOfWork<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//执行一个任务并返回下一个任务</span></span>
<span class="line">        shouldYield <span class="token operator">=</span> deadline<span class="token punctuation">.</span><span class="token function">timeRemaining</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">1</span><span class="token punctuation">;</span><span class="token comment">//如果剩余时间小于1毫秒就说明没有时间了，需要把控制权让给浏览器</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    <span class="token comment">//如果没有下一个执行单元了，并且当前渲染树存在，则进行提交阶段</span></span>
<span class="line">    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>nextUnitOfWork <span class="token operator">&amp;&amp;</span> workInProgressRoot<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token function">commitRoot</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    <span class="token function">requestIdleCallback</span><span class="token punctuation">(</span>workLoop<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"><span class="token comment">//开始在空闲时间执行workLoop</span></span>
<span class="line"><span class="token function">requestIdleCallback</span><span class="token punctuation">(</span>workLoop<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div>`,77)])])}const i=s(e,[["render",o]]),u=JSON.parse('{"path":"/strong/96.3.fiber.html","title":"","lang":"en-US","frontmatter":{},"git":{"updatedTime":1681290319000,"contributors":[{"name":"yutao","username":"yutao","email":"642231346@qq.com","commits":1,"url":"https://github.com/yutao"}],"changelog":[{"hash":"f5ab8c9d34991ec274f7f652439afe5b2afb6147","time":1681290319000,"email":"642231346@qq.com","author":"yutao","message":"modify"}]},"filePathRelative":"strong/96.3.fiber.md"}');export{i as comp,u as data};
