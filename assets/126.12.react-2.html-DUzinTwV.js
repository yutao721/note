import{_ as s,c as a,a as e,o as p}from"./app-CD1YpnS1.js";const t={};function l(o,n){return p(),a("div",null,[...n[0]||(n[0]=[e(`<h2 id="_1-monorepo管理" tabindex="-1"><a class="header-anchor" href="#_1-monorepo管理"><span>1. monorepo管理</span></a></h2><ul><li>Monorepo 是管理项目代码的一个方式，指在一个项目仓库(repo)中管理多个模块/包(package)</li><li>monorepo 最主要的好处是统一的工作流和代码共享</li><li><a href="https://github.com/lerna/lerna" target="_blank" rel="noopener noreferrer">Lerna</a>是一个管理多个 npm 模块的工具,优化维护多包的工作流，解决多个包互相依赖，且发布需要手动维护多个包的问题</li><li><a href="https://classic.yarnpkg.com/en/docs/cli/" target="_blank" rel="noopener noreferrer">yarn</a></li></ul><h3 id="_1-1-multirepo" tabindex="-1"><a class="header-anchor" href="#_1-1-multirepo"><span>1.1 MultiRepo</span></a></h3><h4 id="_1-1-1-优点" tabindex="-1"><a class="header-anchor" href="#_1-1-1-优点"><span>1.1.1 优点</span></a></h4><ul><li>各模块的管理自由度较高，可以自行选择构建工具、依赖管理、单元测试等配套设施</li><li>各模块的体积也不会太大</li></ul><h4 id="_1-1-2-缺点" tabindex="-1"><a class="header-anchor" href="#_1-1-2-缺点"><span>1.1.2 缺点</span></a></h4><ul><li>仓库分散不好找，分支管理混乱</li><li>版本更新繁琐，如果公共模块发生了变化，需要对所有的模块进行依赖更新</li><li>CHANGELOG不好梳理，无法自动关联各个模块的变动</li></ul><h3 id="_1-2-monorepo" tabindex="-1"><a class="header-anchor" href="#_1-2-monorepo"><span>1.2 MonoRepo</span></a></h3><h4 id="_1-2-1-优点" tabindex="-1"><a class="header-anchor" href="#_1-2-1-优点"><span>1.2.1 优点</span></a></h4><ul><li>一个仓库维护多个模块，方便好找</li><li>方便版本管理和依赖管理，模块之间的引用调试都比较方便</li><li>方便统一生成CHANGELOG</li></ul><h4 id="_1-2-2-缺点" tabindex="-1"><a class="header-anchor" href="#_1-2-2-缺点"><span>1.2.2 缺点</span></a></h4><ul><li>统一构建工具, 需要构建工具能构建所的模块</li><li>仓库体积变大</li></ul><h3 id="_1-3-使用lerna" tabindex="-1"><a class="header-anchor" href="#_1-3-使用lerna"><span>1.3 使用lerna</span></a></h3><h4 id="_1-3-1-安装lerna" tabindex="-1"><a class="header-anchor" href="#_1-3-1-安装lerna"><span>1.3.1 安装lerna</span></a></h4><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text"><pre><code class="language-text"><span class="line">npm i lerna -g</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><h4 id="_1-3-2-初始化项目" tabindex="-1"><a class="header-anchor" href="#_1-3-2-初始化项目"><span>1.3.2 初始化项目</span></a></h4><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code class="language-javascript"><span class="line">mkdir lerna<span class="token operator">-</span>project</span>
<span class="line">cd lerna<span class="token operator">-</span>project</span>
<span class="line"></span>
<span class="line">lerna init</span>
<span class="line">lerna notice cli v4<span class="token punctuation">.</span><span class="token number">0.0</span></span>
<span class="line">lerna info Initializing Git repository</span>
<span class="line">lerna info Creating <span class="token keyword">package</span><span class="token punctuation">.</span>json</span>
<span class="line">lerna info Creating lerna<span class="token punctuation">.</span>json</span>
<span class="line">lerna info Creating packages directory</span>
<span class="line">lerna success Initialized Lerna files</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><img src="https://img.zhufengpeixun.com/1609568698164" alt="lerna-init"></p><h4 id="_1-3-3-package-json" tabindex="-1"><a class="header-anchor" href="#_1-3-3-package-json"><span>1.3.3 package.json</span></a></h4><p>package.json</p><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code class="language-javascript"><span class="line"><span class="token punctuation">{</span></span>
<span class="line">  <span class="token string-property property">&quot;name&quot;</span><span class="token operator">:</span> <span class="token string">&quot;root&quot;</span><span class="token punctuation">,</span></span>
<span class="line">  <span class="token string-property property">&quot;private&quot;</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token comment">// 私有的,用来管理整个项目,不会被发布到npm</span></span>
<span class="line">  <span class="token string-property property">&quot;devDependencies&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token string-property property">&quot;lerna&quot;</span><span class="token operator">:</span> <span class="token string">&quot;^4.0.0&quot;</span></span>
<span class="line">  <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_1-3-4-lerna-json" tabindex="-1"><a class="header-anchor" href="#_1-3-4-lerna-json"><span>1.3.4 lerna.json</span></a></h4><p>lerna.json</p><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code class="language-javascript"><span class="line"><span class="token punctuation">{</span></span>
<span class="line">  <span class="token string-property property">&quot;packages&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span></span>
<span class="line">    <span class="token string">&quot;packages/*&quot;</span></span>
<span class="line">  <span class="token punctuation">]</span><span class="token punctuation">,</span></span>
<span class="line">  <span class="token string-property property">&quot;version&quot;</span><span class="token operator">:</span> <span class="token string">&quot;0.0.0&quot;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_1-4-yarn-workspace" tabindex="-1"><a class="header-anchor" href="#_1-4-yarn-workspace"><span>1.4 yarn workspace</span></a></h3><ul><li><code>yarn workspace</code>允许我们使用 <code>monorepo</code> 的形式来管理项目</li><li>在安装 node_modules 的时候它不会安装到每个子项目的 node_modules 里面，而是直接安装到根目录下面，这样每个子项目都可以读取到根目录的 node_modules</li><li>整个项目只有根目录下面会有一份 <code>yarn.lock</code> 文件。子项目也会被 <code>link</code> 到 <code>node_modules</code> 里面，这样就允许我们就可以直接用 import 导入对应的项目</li><li><code>yarn.lock</code>文件是自动生成的,也完全Yarn来处理.<code>yarn.lock</code>锁定你安装的每个依赖项的版本，这可以确保你不会意外获得不良依赖</li></ul><h4 id="_1-4-1-开启workspace" tabindex="-1"><a class="header-anchor" href="#_1-4-1-开启workspace"><span>1.4.1 开启workspace</span></a></h4><p>package.json</p><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text"><pre><code class="language-text"><span class="line">{</span>
<span class="line">  &quot;name&quot;: &quot;root&quot;,</span>
<span class="line">  &quot;private&quot;: true, </span>
<span class="line">+  &quot;workspaces&quot;: [</span>
<span class="line">+    &quot;packages/*&quot;</span>
<span class="line">+  ],</span>
<span class="line">  &quot;devDependencies&quot;: {</span>
<span class="line">    &quot;lerna&quot;: &quot;^3.22.1&quot;</span>
<span class="line">  }</span>
<span class="line">}</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_1-3-2-创建子项目" tabindex="-1"><a class="header-anchor" href="#_1-3-2-创建子项目"><span>1.3.2 创建子项目</span></a></h4><ul><li>react是React核心，包含了<code>React.createElement</code>等代码</li><li>shared 存放各个模块公用的全局变量和方法</li><li>scheduler 实现了优先级调度功能</li><li>react-reconciler 提供了协调器的功能</li><li>react-dom 提供了渲染到DOM的功能</li></ul><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text"><pre><code class="language-text"><span class="line">lerna create react</span>
<span class="line">lerna create shared</span>
<span class="line">lerna create scheduler</span>
<span class="line">lerna create react-reconciler</span>
<span class="line">lerna create react-dom</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_1-3-3-添加依赖" tabindex="-1"><a class="header-anchor" href="#_1-3-3-添加依赖"><span>1.3.3 添加依赖</span></a></h4><ul><li><a href="https://classic.yarnpkg.com/en/docs/cli" target="_blank" rel="noopener noreferrer">yarnpkg</a></li><li>[lerna](https://github.com/lerna/lerna</li></ul><h5 id="_1-3-3-1-设置加速镜像" tabindex="-1"><a class="header-anchor" href="#_1-3-3-1-设置加速镜像"><span>1.3.3.1 设置加速镜像</span></a></h5><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code class="language-javascript"><span class="line">yarn config <span class="token keyword">get</span> registry</span>
<span class="line">yarn config <span class="token keyword">set</span> registry http<span class="token operator">:</span><span class="token operator">/</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">registry.npm.taobao.org</span><span class="token regex-delimiter">/</span></span></span>
<span class="line">yarn config <span class="token keyword">set</span> registry http<span class="token operator">:</span><span class="token operator">/</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">registry.npmjs.org</span><span class="token regex-delimiter">/</span></span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_1-3-4-常用命令" tabindex="-1"><a class="header-anchor" href="#_1-3-4-常用命令"><span>1.3.4 常用命令</span></a></h4><h5 id="_1-3-4-1-根空间添加依赖" tabindex="-1"><a class="header-anchor" href="#_1-3-4-1-根空间添加依赖"><span>1.3.4.1 根空间添加依赖</span></a></h5><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text"><pre><code class="language-text"><span class="line">yarn add chalk --ignore-workspace-root-check</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><h5 id="_1-3-4-2-给某个项目添加依赖" tabindex="-1"><a class="header-anchor" href="#_1-3-4-2-给某个项目添加依赖"><span>1.3.4.2 给某个项目添加依赖</span></a></h5><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text"><pre><code class="language-text"><span class="line">yarn workspace react add object-assign</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><h5 id="_1-3-4-3-安装和link" tabindex="-1"><a class="header-anchor" href="#_1-3-4-3-安装和link"><span>1.3.4.3 安装和link</span></a></h5><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text"><pre><code class="language-text"><span class="line">yarn install</span>
<span class="line">lerna bootstrap --npm-client yarn --use-workspaces</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div></div></div><h5 id="_1-3-4-4-其它命令" tabindex="-1"><a class="header-anchor" href="#_1-3-4-4-其它命令"><span>1.3.4.4 其它命令</span></a></h5><table><thead><tr><th style="text-align:left;">作用</th><th style="text-align:left;">命令</th></tr></thead><tbody><tr><td style="text-align:left;">查看工作空间信息</td><td style="text-align:left;">yarn workspaces info</td></tr><tr><td style="text-align:left;">删除所有的 node_modules</td><td style="text-align:left;">lerna clean 等于 yarn workspaces run clean</td></tr><tr><td style="text-align:left;">重新获取所有的 node_modules</td><td style="text-align:left;">yarn install --force</td></tr><tr><td style="text-align:left;">查看缓存目录</td><td style="text-align:left;">yarn cache dir</td></tr><tr><td style="text-align:left;">清除本地缓存</td><td style="text-align:left;">yarn cache clean</td></tr></tbody></table><h2 id="_2-调试源码" tabindex="-1"><a class="header-anchor" href="#_2-调试源码"><span>2. 调试源码</span></a></h2><h3 id="_2-1-下载代码" tabindex="-1"><a class="header-anchor" href="#_2-1-下载代码"><span>2.1 下载代码</span></a></h3><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code class="language-javascript"><span class="line">git clone https<span class="token operator">:</span><span class="token operator">/</span><span class="token operator">/</span>gitee<span class="token punctuation">.</span>com<span class="token operator">/</span>mirrors<span class="token operator">/</span>react<span class="token punctuation">.</span>git</span>
<span class="line"></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_2-2-编译源码" tabindex="-1"><a class="header-anchor" href="#_2-2-编译源码"><span>2.2 编译源码</span></a></h3><ul><li>[development-workflow](https://zh-hans.reactjs.org/docs/how-to-contribute.html</li></ul><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text"><pre><code class="language-text"><span class="line">cd react</span>
<span class="line">yarn build react,shared,scheduler,react-reconciler,react-dom --type=NODE</span>
<span class="line">cd build/node_modules/react</span>
<span class="line">yarn link</span>
<span class="line">cd build/node_modules/react-dom</span>
<span class="line">yarn link</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text"><pre><code class="language-text"><span class="line">create-react-app debug-react17</span>
<span class="line">cd debug-react17</span>
<span class="line">yarn link react react-dom</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="_3-setstate的更新是同步还是异步的" tabindex="-1"><a class="header-anchor" href="#_3-setstate的更新是同步还是异步的"><span>3. setState的更新是同步还是异步的?</span></a></h2><h3 id="_3-1-setstate" tabindex="-1"><a class="header-anchor" href="#_3-1-setstate"><span>3.1 setState</span></a></h3><ul><li>在开发中我们并不能直接通过修改state的值来让界面发生更新 <ul><li>因为修改了state之后，希望React根据最新的State来重新渲染界面，但是这种方式的修改React并不知道数据发生了变化</li><li>React并没有实现类似于Vue2中的Object.defineProperty或者Vue3中的Proxy的方式来监听数据的变化</li><li>必须通过setState来告知React数据已经发生了变化</li></ul></li></ul><h3 id="_3-2-异步更新" tabindex="-1"><a class="header-anchor" href="#_3-2-异步更新"><span>3.2 异步更新</span></a></h3><ul><li>React在执行setState的时候会把更新的内容放入队列</li><li>在事件执行结束后会计算state的数据，然后执行回调</li><li>最后根据最新的state计算虚拟DOM更新真实DOM</li><li>优点 <ul><li>保持内部一致性。如果改为同步更新的方式，尽管 setState 变成了同步，但是 props 不是</li><li>为后续的架构升级启用并发更新,React 会在 setState 时，根据它们的数据来源分配不同的优先级，这些数据来源有：事件回调句柄、动画效果等，再根据优先级并发处理，提升渲染性能</li><li>setState设计为异步，可以显著的提升性能</li></ul></li></ul><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code class="language-javascript"><span class="line"><span class="token keyword">import</span> <span class="token operator">*</span> <span class="token keyword">as</span> React <span class="token keyword">from</span> <span class="token string">&#39;react&#39;</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">import</span> <span class="token operator">*</span> <span class="token keyword">as</span> ReactDOM <span class="token keyword">from</span> <span class="token string">&#39;react-dom&#39;</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">class</span> <span class="token class-name">Counter</span> <span class="token keyword">extends</span> <span class="token class-name">React<span class="token punctuation">.</span>Component</span><span class="token punctuation">{</span></span>
<span class="line">  state <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token literal-property property">number</span><span class="token operator">:</span><span class="token number">0</span><span class="token punctuation">}</span></span>
<span class="line">  <span class="token function-variable function">buttonClick</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span></span>
<span class="line">    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&#39;buttonClick&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">setState</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token literal-property property">number</span><span class="token operator">:</span><span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">.</span>number<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">.</span>number<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">setState</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token literal-property property">number</span><span class="token operator">:</span><span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">.</span>number<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">.</span>number<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">  <span class="token punctuation">}</span></span>
<span class="line">  <span class="token function-variable function">divClick</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span></span>
<span class="line">    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&#39;divClick&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">  <span class="token punctuation">}</span></span>
<span class="line">  <span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">return</span> <span class="token punctuation">(</span></span>
<span class="line">      <span class="token operator">&lt;</span>div onClick<span class="token operator">=</span><span class="token punctuation">{</span><span class="token keyword">this</span><span class="token punctuation">.</span>divClick<span class="token punctuation">}</span> id<span class="token operator">=</span><span class="token string">&quot;counter&quot;</span><span class="token operator">&gt;</span></span>
<span class="line">        <span class="token operator">&lt;</span>p<span class="token operator">&gt;</span><span class="token punctuation">{</span><span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">.</span>number<span class="token punctuation">}</span><span class="token operator">&lt;</span><span class="token operator">/</span>p<span class="token operator">&gt;</span></span>
<span class="line">        <span class="token operator">&lt;</span>button onClick<span class="token operator">=</span><span class="token punctuation">{</span><span class="token keyword">this</span><span class="token punctuation">.</span>buttonClick<span class="token punctuation">}</span><span class="token operator">&gt;</span><span class="token operator">+</span><span class="token operator">&lt;</span><span class="token operator">/</span>button<span class="token operator">&gt;</span></span>
<span class="line">      <span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">&gt;</span></span>
<span class="line">    <span class="token punctuation">)</span></span>
<span class="line">  <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line">ReactDOM<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span><span class="token operator">&lt;</span>Counter<span class="token operator">/</span><span class="token operator">&gt;</span><span class="token punctuation">,</span>document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">&#39;root&#39;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_3-3-回调执行" tabindex="-1"><a class="header-anchor" href="#_3-3-回调执行"><span>3.3 回调执行</span></a></h3><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text"><pre><code class="language-text"><span class="line">import * as React from &#39;react&#39;;</span>
<span class="line">import * as ReactDOM from &#39;react-dom&#39;;</span>
<span class="line"></span>
<span class="line">class Counter extends React.Component{</span>
<span class="line">  state = {number:0}</span>
<span class="line">  buttonClick = ()=&gt;{</span>
<span class="line">    console.log(&#39;buttonClick&#39;);</span>
<span class="line">+   this.setState({number:this.state.number+1},()=&gt;{</span>
<span class="line">+     console.log(this.state.number);</span>
<span class="line">+   }); </span>
<span class="line">+   this.setState({number:this.state.number+1},()=&gt;{</span>
<span class="line">+     console.log(this.state.number);</span>
<span class="line">+   });</span>
<span class="line">  }</span>
<span class="line">  divClick = ()=&gt;{</span>
<span class="line">    console.log(&#39;divClick&#39;);</span>
<span class="line">  }</span>
<span class="line">  render(){</span>
<span class="line">    return (</span>
<span class="line">      &lt;div onClick={this.divClick} id=&quot;counter&quot;&gt;</span>
<span class="line">        &lt;p&gt;{this.state.number}&lt;/p&gt;</span>
<span class="line">        &lt;button onClick={this.buttonClick}&gt;+&lt;/button&gt;</span>
<span class="line">      &lt;/div&gt;</span>
<span class="line">    )</span>
<span class="line">  }</span>
<span class="line">}</span>
<span class="line">ReactDOM.render(&lt;Counter/&gt;,document.getElementById(&#39;root&#39;));</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_3-4-函数更新" tabindex="-1"><a class="header-anchor" href="#_3-4-函数更新"><span>3.4 函数更新</span></a></h3><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text"><pre><code class="language-text"><span class="line">import * as React from &#39;react&#39;;</span>
<span class="line">import * as ReactDOM from &#39;react-dom&#39;;</span>
<span class="line"></span>
<span class="line">class Counter extends React.Component{</span>
<span class="line">  state = {number:0}</span>
<span class="line">  buttonClick = ()=&gt;{</span>
<span class="line">    console.log(&#39;buttonClick&#39;);</span>
<span class="line">+   this.setState((state)=&gt;({number:state.number+1}),()=&gt;{</span>
<span class="line">+     console.log(this.state.number);</span>
<span class="line">+   });</span>
<span class="line">+  </span>
<span class="line">+   this.setState((state)=&gt;({number:state.number+1}),()=&gt;{</span>
<span class="line">+     console.log(this.state.number);</span>
<span class="line">+   });</span>
<span class="line"></span>
<span class="line">  }</span>
<span class="line">  divClick = ()=&gt;{</span>
<span class="line">    console.log(&#39;divClick&#39;);</span>
<span class="line">  }</span>
<span class="line">  render(){</span>
<span class="line">    return (</span>
<span class="line">      &lt;div onClick={this.divClick} id=&quot;counter&quot;&gt;</span>
<span class="line">        &lt;p&gt;{this.state.number}&lt;/p&gt;</span>
<span class="line">        &lt;button onClick={this.buttonClick}&gt;+&lt;/button&gt;</span>
<span class="line">      &lt;/div&gt;</span>
<span class="line">    )</span>
<span class="line">  }</span>
<span class="line">}</span>
<span class="line">ReactDOM.render(&lt;Counter/&gt;,document.getElementById(&#39;root&#39;));</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_3-5-同步执行" tabindex="-1"><a class="header-anchor" href="#_3-5-同步执行"><span>3.5 同步执行</span></a></h3><ul><li>在React的生命周期函数和合成事件中可以修改批量更新的变量<code>isBatchingUpdates</code></li><li>可以设置为批量，其它地方如<code>addEventListener</code>、<code>setTimeout和setInterval</code>里无法设置</li></ul><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text"><pre><code class="language-text"><span class="line">import * as React from &#39;react&#39;;</span>
<span class="line">import * as ReactDOM from &#39;react-dom&#39;;</span>
<span class="line"></span>
<span class="line">class Counter extends React.Component{</span>
<span class="line">  state = {number:0}</span>
<span class="line">  buttonClick = ()=&gt;{</span>
<span class="line">    console.log(&#39;buttonClick&#39;);// 2234</span>
<span class="line">    this.setState((state)=&gt;({number:state.number+1}),()=&gt;{</span>
<span class="line">      console.log(this.state.number);</span>
<span class="line">    });</span>
<span class="line"></span>
<span class="line">    this.setState((state)=&gt;({number:state.number+1}),()=&gt;{</span>
<span class="line">      console.log(this.state.number);</span>
<span class="line">    });</span>
<span class="line">+   setTimeout(()=&gt;{</span>
<span class="line">+     this.setState((state)=&gt;({number:state.number+1}),()=&gt;{</span>
<span class="line">+       console.log(this.state.number);</span>
<span class="line">+     });</span>
<span class="line">+    </span>
<span class="line">+     this.setState((state)=&gt;({number:state.number+1}),()=&gt;{</span>
<span class="line">+       console.log(this.state.number);</span>
<span class="line">+     });</span>
<span class="line">    });</span>
<span class="line"></span>
<span class="line">  }</span>
<span class="line">  divClick = ()=&gt;{</span>
<span class="line">    console.log(&#39;divClick&#39;);</span>
<span class="line">  }</span>
<span class="line">  render(){</span>
<span class="line">    return (</span>
<span class="line">      &lt;div onClick={this.divClick} id=&quot;counter&quot;&gt;</span>
<span class="line">        &lt;p&gt;{this.state.number}&lt;/p&gt;</span>
<span class="line">        &lt;button onClick={this.buttonClick}&gt;+&lt;/button&gt;</span>
<span class="line">      &lt;/div&gt;</span>
<span class="line">    )</span>
<span class="line">  }</span>
<span class="line">}</span>
<span class="line">ReactDOM.render(&lt;Counter/&gt;,document.getElementById(&#39;root&#39;));</span>
<span class="line"></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_3-6-强行批量更新" tabindex="-1"><a class="header-anchor" href="#_3-6-强行批量更新"><span>3.6 强行批量更新</span></a></h3><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text"><pre><code class="language-text"><span class="line">import * as React from &#39;react&#39;;</span>
<span class="line">import * as ReactDOM from &#39;react-dom&#39;;</span>
<span class="line"></span>
<span class="line">class Counter extends React.Component{</span>
<span class="line">  state = {number:0}</span>
<span class="line">  buttonClick = ()=&gt;{</span>
<span class="line">    console.log(&#39;buttonClick&#39;);// 2234</span>
<span class="line">    setTimeout(()=&gt;{</span>
<span class="line">+     ReactDOM.unstable_batchedUpdates(()=&gt;{</span>
<span class="line">+       this.setState((state)=&gt;({number:state.number+1}));</span>
<span class="line">+       console.log(this.state.number);</span>
<span class="line">+     });</span>
<span class="line">    });</span>
<span class="line">  }</span>
<span class="line">  divClick = ()=&gt;{</span>
<span class="line">    console.log(&#39;divClick&#39;);</span>
<span class="line">  }</span>
<span class="line">  render(){</span>
<span class="line">    return (</span>
<span class="line">      &lt;div onClick={this.divClick} id=&quot;counter&quot;&gt;</span>
<span class="line">        &lt;p&gt;{this.state.number}&lt;/p&gt;</span>
<span class="line">        &lt;button onClick={this.buttonClick}&gt;+&lt;/button&gt;</span>
<span class="line">      &lt;/div&gt;</span>
<span class="line">    )</span>
<span class="line">  }</span>
<span class="line">}</span>
<span class="line">ReactDOM.render(&lt;Counter/&gt;,document.getElementById(&#39;root&#39;));</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_3-7-并发更新" tabindex="-1"><a class="header-anchor" href="#_3-7-并发更新"><span>3.7 并发更新</span></a></h3><ul><li>启用<code>concurrent</code>模式</li></ul><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text"><pre><code class="language-text"><span class="line">+ReactDOM.unstable_createRoot(document.getElementById(&#39;root&#39;)).render(&lt;Counter/&gt;);</span>
<span class="line">+ReactDOM.createRoot(document.getElementById(&#39;root&#39;)).render(&lt;Counter/&gt;);</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="_4-实现setstate" tabindex="-1"><a class="header-anchor" href="#_4-实现setstate"><span>4.实现setState</span></a></h2><p><img src="https://img.zhufengpeixun.com/d6da53bd57c6623a994ea922a88becfe" alt="d6da53bd57c6623a994ea922a88becfe"></p><h3 id="_4-1-src-index-js" tabindex="-1"><a class="header-anchor" href="#_4-1-src-index-js"><span>4.1 src\\index.js</span></a></h3><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code class="language-javascript"><span class="line"><span class="token keyword">import</span> <span class="token punctuation">{</span> HostRoot<span class="token punctuation">,</span> ClassComponent <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&#39;./ReactWorkTags&#39;</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">import</span> <span class="token punctuation">{</span> Component <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&#39;./ReactFiberClassComponent&#39;</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">import</span> <span class="token punctuation">{</span> NoMode<span class="token punctuation">,</span> ConcurrentMode <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&#39;./ReactTypeOfMode&#39;</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">import</span> <span class="token punctuation">{</span> batchedUpdates <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&#39;./ReactFiberWorkLoop&#39;</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">class</span> <span class="token class-name">Counter</span> <span class="token keyword">extends</span> <span class="token class-name">Component</span> <span class="token punctuation">{</span></span>
<span class="line">  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">super</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">this</span><span class="token punctuation">.</span>state <span class="token operator">=</span> <span class="token punctuation">{</span> <span class="token literal-property property">number</span><span class="token operator">:</span> <span class="token number">0</span> <span class="token punctuation">}</span><span class="token punctuation">;</span></span>
<span class="line">  <span class="token punctuation">}</span></span>
<span class="line">  <span class="token function-variable function">onClick</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">event</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">setState</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token literal-property property">number</span><span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">.</span>number <span class="token operator">+</span> <span class="token number">1</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&#39;setState1&#39;</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">.</span>number<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">setState</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token literal-property property">number</span><span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">.</span>number <span class="token operator">+</span> <span class="token number">1</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&#39;setState2&#39;</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">.</span>number<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></span>
<span class="line">      <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">setState</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token literal-property property">number</span><span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">.</span>number <span class="token operator">+</span> <span class="token number">1</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&#39;setTimeout setState1&#39;</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">.</span>number<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">      <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">setState</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token literal-property property">number</span><span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">.</span>number <span class="token operator">+</span> <span class="token number">1</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&#39;setTimeout setState2&#39;</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">.</span>number<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">  <span class="token punctuation">}</span></span>
<span class="line">  <span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&#39;render&#39;</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">.</span>number<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">.</span>number<span class="token punctuation">;</span></span>
<span class="line">  <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"><span class="token keyword">let</span> counterInstance <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Counter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">let</span> mode <span class="token operator">=</span> ConcurrentMode<span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">let</span> rootFiber <span class="token operator">=</span> <span class="token punctuation">{</span> <span class="token literal-property property">tag</span><span class="token operator">:</span> HostRoot<span class="token punctuation">,</span> <span class="token literal-property property">updateQueue</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> mode <span class="token punctuation">}</span></span>
<span class="line"><span class="token keyword">let</span> counterFiber <span class="token operator">=</span> <span class="token punctuation">{</span> <span class="token literal-property property">tag</span><span class="token operator">:</span> ClassComponent<span class="token punctuation">,</span> <span class="token literal-property property">updateQueue</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> mode <span class="token punctuation">}</span></span>
<span class="line">counterFiber<span class="token punctuation">.</span>stateNode <span class="token operator">=</span> counterInstance<span class="token punctuation">;</span></span>
<span class="line">counterInstance<span class="token punctuation">.</span>_reactInternals <span class="token operator">=</span> counterFiber<span class="token punctuation">;</span></span>
<span class="line">counterFiber<span class="token punctuation">.</span>return <span class="token operator">=</span> rootFiber<span class="token punctuation">;</span></span>
<span class="line">rootFiber<span class="token punctuation">.</span>child <span class="token operator">=</span> counterFiber<span class="token punctuation">;</span></span>
<span class="line"><span class="token comment">//合成事件</span></span>
<span class="line">document<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">&#39;click&#39;</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token parameter">nativeEvent</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span></span>
<span class="line">  <span class="token keyword">let</span> syntheticEvent <span class="token operator">=</span> <span class="token punctuation">{</span>nativeEvent<span class="token punctuation">}</span><span class="token punctuation">;</span></span>
<span class="line">  <span class="token function">batchedUpdates</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span>counterInstance<span class="token punctuation">.</span><span class="token function">onClick</span><span class="token punctuation">(</span>syntheticEvent<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token comment">//1.同步不批量</span></span>
<span class="line"><span class="token comment">//counterInstance.onClick();</span></span>
<span class="line"><span class="token comment">//2.同步批量</span></span>
<span class="line"><span class="token comment">//batchedUpdates(counterInstance.onClick);</span></span>
<span class="line"><span class="token comment">//3.异步批量</span></span>
<span class="line"><span class="token comment">//counterInstance.onClick();</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_4-2-src-reactworktags-js" tabindex="-1"><a class="header-anchor" href="#_4-2-src-reactworktags-js"><span>4.2 src\\ReactWorkTags.js</span></a></h3><p>src\\ReactWorkTags.js</p><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code class="language-javascript"><span class="line"><span class="token keyword">export</span> <span class="token keyword">const</span> HostRoot <span class="token operator">=</span> <span class="token number">3</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">export</span> <span class="token keyword">const</span> ClassComponent <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_4-3-src-reacttypeofmode-js" tabindex="-1"><a class="header-anchor" href="#_4-3-src-reacttypeofmode-js"><span>4.3 src\\ReactTypeOfMode.js</span></a></h3><p>src\\ReactTypeOfMode.js</p><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code class="language-javascript"><span class="line"><span class="token keyword">export</span> <span class="token keyword">const</span> NoMode <span class="token operator">=</span> <span class="token number">0b00000</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">export</span> <span class="token keyword">const</span> ConcurrentMode <span class="token operator">=</span> <span class="token number">0b00100</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_4-4-src-reactfiberclasscomponent-js" tabindex="-1"><a class="header-anchor" href="#_4-4-src-reactfiberclasscomponent-js"><span>4.4 src\\ReactFiberClassComponent.js</span></a></h3><p>src\\ReactFiberClassComponent.js</p><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code class="language-javascript"><span class="line"><span class="token keyword">import</span> <span class="token punctuation">{</span>scheduleUpdateOnFiber<span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&#39;./ReactFiberWorkLoop&#39;</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">let</span> classComponentUpdater <span class="token operator">=</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token function-variable function">enqueueSetState</span><span class="token operator">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">inst<span class="token punctuation">,</span> payload</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">const</span> fiber <span class="token operator">=</span> <span class="token function">get</span><span class="token punctuation">(</span>inst<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">const</span> update <span class="token operator">=</span> <span class="token function">createUpdate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        update<span class="token punctuation">.</span>payload <span class="token operator">=</span> payload<span class="token punctuation">;</span></span>
<span class="line">        <span class="token function">enqueueUpdate</span><span class="token punctuation">(</span>fiber<span class="token punctuation">,</span> update<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token function">scheduleUpdateOnFiber</span><span class="token punctuation">(</span>fiber<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"><span class="token keyword">function</span> <span class="token function">get</span><span class="token punctuation">(</span><span class="token parameter">inst</span><span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">return</span> inst<span class="token punctuation">.</span>_reactInternals<span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"><span class="token keyword">function</span> <span class="token function">createUpdate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">return</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"><span class="token keyword">function</span> <span class="token function">enqueueUpdate</span><span class="token punctuation">(</span><span class="token parameter">fiber<span class="token punctuation">,</span> update</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">var</span> updateQueue <span class="token operator">=</span> fiber<span class="token punctuation">.</span>updateQueue<span class="token punctuation">;</span></span>
<span class="line">    updateQueue<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>update<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">Component</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">this</span><span class="token punctuation">.</span>updater <span class="token operator">=</span> classComponentUpdater<span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    <span class="token function">setState</span><span class="token punctuation">(</span><span class="token parameter">partialState</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">this</span><span class="token punctuation">.</span>updater<span class="token punctuation">.</span><span class="token function">enqueueSetState</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> partialState<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_4-5-src-reactfiberworkloop-js" tabindex="-1"><a class="header-anchor" href="#_4-5-src-reactfiberworkloop-js"><span>4.5 src\\ReactFiberWorkLoop.js</span></a></h3><p>src\\ReactFiberWorkLoop.js</p><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code class="language-javascript"><span class="line"></span>
<span class="line"><span class="token keyword">import</span> <span class="token punctuation">{</span> ClassComponent<span class="token punctuation">,</span> HostRoot <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&#39;./ReactWorkTags&#39;</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">import</span> <span class="token punctuation">{</span>NoMode<span class="token punctuation">,</span>ConcurrentMode<span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&#39;./ReactTypeOfMode&#39;</span></span>
<span class="line"><span class="token keyword">let</span> syncQueue<span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">let</span> NoLanePriority <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">let</span> SyncLanePriority <span class="token operator">=</span> <span class="token number">12</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">export</span> <span class="token keyword">let</span> NoContext <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">export</span> <span class="token keyword">let</span> BatchedContext <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">export</span> <span class="token keyword">let</span> executionContext <span class="token operator">=</span> NoContext<span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">function</span> <span class="token function">markUpdateLaneFromFiberToRoot</span><span class="token punctuation">(</span><span class="token parameter">fiber</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">let</span> parent <span class="token operator">=</span> fiber<span class="token punctuation">.</span>return<span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">while</span> <span class="token punctuation">(</span>parent<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        fiber <span class="token operator">=</span> parent<span class="token punctuation">;</span></span>
<span class="line">        parent <span class="token operator">=</span> parent<span class="token punctuation">.</span>return<span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    <span class="token keyword">if</span> <span class="token punctuation">(</span>fiber<span class="token punctuation">.</span>tag <span class="token operator">===</span> HostRoot<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">return</span> fiber<span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"><span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">getExecutionContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">return</span> executionContext<span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"><span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">batchedUpdates</span><span class="token punctuation">(</span><span class="token parameter">fn</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">const</span> prevExecutionContext <span class="token operator">=</span> executionContext<span class="token punctuation">;</span></span>
<span class="line">    executionContext <span class="token operator">|=</span> BatchedContext<span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">try</span> <span class="token punctuation">{</span></span>
<span class="line">      <span class="token keyword">return</span> <span class="token function">fn</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span></span>
<span class="line">      executionContext <span class="token operator">=</span> prevExecutionContext<span class="token punctuation">;</span></span>
<span class="line">      <span class="token keyword">if</span> <span class="token punctuation">(</span>executionContext <span class="token operator">===</span> NoContext<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token function">flushSyncCallbackQueue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">      <span class="token punctuation">}</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">  <span class="token punctuation">}</span></span>
<span class="line"><span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">scheduleUpdateOnFiber</span><span class="token punctuation">(</span><span class="token parameter">fiber</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">let</span> root <span class="token operator">=</span> <span class="token function">markUpdateLaneFromFiberToRoot</span><span class="token punctuation">(</span>fiber<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token function">ensureRootIsScheduled</span><span class="token punctuation">(</span>root<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">if</span> <span class="token punctuation">(</span>executionContext <span class="token operator">===</span> NoContext <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>fiber<span class="token punctuation">.</span>mode <span class="token operator">&amp;</span> ConcurrentMode<span class="token punctuation">)</span> <span class="token operator">===</span> NoMode<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token function">flushSyncCallbackQueue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">function</span> <span class="token function">ensureRootIsScheduled</span><span class="token punctuation">(</span><span class="token parameter">root</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">let</span> existingCallbackPriority <span class="token operator">=</span> root<span class="token punctuation">.</span>callbackPriority<span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">let</span> newCallbackPriority <span class="token operator">=</span> SyncLanePriority<span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">if</span> <span class="token punctuation">(</span>existingCallbackPriority <span class="token operator">===</span> newCallbackPriority<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">return</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    <span class="token function">scheduleSyncCallback</span><span class="token punctuation">(</span><span class="token function">performSyncWorkOnRoot</span><span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> root<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token function">queueMicrotask</span><span class="token punctuation">(</span>flushSyncCallbackQueue<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    root<span class="token punctuation">.</span>callbackPriority <span class="token operator">=</span> newCallbackPriority<span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"><span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">flushSyncCallbackQueue</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">if</span><span class="token punctuation">(</span>syncQueue<span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> syncQueue<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token keyword">let</span> callback <span class="token operator">=</span> syncQueue<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span></span>
<span class="line">            <span class="token keyword">do</span> <span class="token punctuation">{</span></span>
<span class="line">                callback <span class="token operator">=</span> <span class="token function">callback</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">            <span class="token punctuation">}</span> <span class="token keyword">while</span> <span class="token punctuation">(</span>callback<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">        syncQueue <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"><span class="token keyword">function</span> <span class="token function">scheduleSyncCallback</span><span class="token punctuation">(</span><span class="token parameter">callback</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>syncQueue<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        syncQueue <span class="token operator">=</span> <span class="token punctuation">[</span>callback<span class="token punctuation">]</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span></span>
<span class="line">        syncQueue<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>callback<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"><span class="token keyword">function</span> <span class="token function">performSyncWorkOnRoot</span><span class="token punctuation">(</span><span class="token parameter">workInProgress</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">let</span> root <span class="token operator">=</span> workInProgress<span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">while</span> <span class="token punctuation">(</span>workInProgress<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">if</span> <span class="token punctuation">(</span>workInProgress<span class="token punctuation">.</span>tag <span class="token operator">===</span> ClassComponent<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token keyword">let</span> inst <span class="token operator">=</span> workInProgress<span class="token punctuation">.</span>stateNode<span class="token punctuation">;</span></span>
<span class="line">            inst<span class="token punctuation">.</span>state <span class="token operator">=</span> <span class="token function">processUpdateQueue</span><span class="token punctuation">(</span>inst<span class="token punctuation">,</span>workInProgress<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">            workInProgress<span class="token punctuation">.</span>stateNode<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">        workInProgress <span class="token operator">=</span> workInProgress<span class="token punctuation">.</span>child<span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    <span class="token function">commitRoot</span><span class="token punctuation">(</span>root<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"><span class="token keyword">function</span> <span class="token function">processUpdateQueue</span><span class="token punctuation">(</span><span class="token parameter">inst<span class="token punctuation">,</span>workInProgress</span><span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">return</span>  workInProgress<span class="token punctuation">.</span>updateQueue<span class="token punctuation">.</span><span class="token function">reduce</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">state<span class="token punctuation">,</span> update</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token operator">...</span>state<span class="token punctuation">,</span> <span class="token operator">...</span>update<span class="token punctuation">.</span>payload <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span> inst<span class="token punctuation">.</span>state<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"><span class="token keyword">function</span> <span class="token function">commitRoot</span><span class="token punctuation">(</span><span class="token parameter">root</span><span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line">    root<span class="token punctuation">.</span>callbackPriority <span class="token operator">=</span> NoLanePriority<span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="_5-react中的优先级" tabindex="-1"><a class="header-anchor" href="#_5-react中的优先级"><span>5.React中的优先级</span></a></h2><ul><li>不同事件产生的更新优先级不同</li></ul><h3 id="_5-1-react中的优先级" tabindex="-1"><a class="header-anchor" href="#_5-1-react中的优先级"><span>5.1 React中的优先级</span></a></h3><ul><li>事件优先级：按照用户事件的交互紧急程度，划分的优先级</li><li>更新优先级：事件导致React产生的更新对象（update）的优先级（update.lane）</li><li>任务优先级：产生更新对象之后，React去执行一个更新任务，这个任务所持有的优先级</li><li>调度优先级：Scheduler依据React更新任务生成一个调度任务，这个调度任务所持有的优先级</li></ul><blockquote><p>前三者属于React的优先级机制，第四个属于<code>scheduler</code>的优先级机制</p></blockquote><h3 id="_5-2-事件优先级" tabindex="-1"><a class="header-anchor" href="#_5-2-事件优先级"><span>5.2 事件优先级</span></a></h3><ul><li>离散事件（DiscreteEvent）：click、keydown等，这些事件的触发不是连续的，优先级为 0</li><li>用户阻塞事件（UserBlockingEvent）：drag、scroll、mouseover等，特点是连续触发，阻塞渲染，优先级为1</li><li>连续事件（ContinuousEvent）：canplay、error，优先级最高，为2</li></ul><p>src\\react\\packages\\shared\\ReactTypes.js</p><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code class="language-javascript"><span class="line"><span class="token keyword">export</span> <span class="token keyword">const</span> DiscreteEvent <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">export</span> <span class="token keyword">const</span> UserBlockingEvent <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">export</span> <span class="token keyword">const</span> ContinuousEvent <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>src\\react\\packages\\scheduler\\src\\Scheduler.js</p><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code class="language-javascript"><span class="line"><span class="token keyword">function</span> <span class="token function">unstable_runWithPriority</span><span class="token punctuation">(</span><span class="token parameter">priorityLevel<span class="token punctuation">,</span> eventHandler</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">  <span class="token keyword">switch</span> <span class="token punctuation">(</span>priorityLevel<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">case</span> <span class="token literal-property property">ImmediatePriority</span><span class="token operator">:</span></span>
<span class="line">    <span class="token keyword">case</span> <span class="token literal-property property">UserBlockingPriority</span><span class="token operator">:</span></span>
<span class="line">    <span class="token keyword">case</span> <span class="token literal-property property">NormalPriority</span><span class="token operator">:</span></span>
<span class="line">    <span class="token keyword">case</span> <span class="token literal-property property">LowPriority</span><span class="token operator">:</span></span>
<span class="line">    <span class="token keyword">case</span> <span class="token literal-property property">IdlePriority</span><span class="token operator">:</span></span>
<span class="line">      <span class="token keyword">break</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">default</span><span class="token operator">:</span></span>
<span class="line">      priorityLevel <span class="token operator">=</span> NormalPriority<span class="token punctuation">;</span></span>
<span class="line">  <span class="token punctuation">}</span></span>
<span class="line">  <span class="token keyword">var</span> previousPriorityLevel <span class="token operator">=</span> currentPriorityLevel<span class="token punctuation">;</span></span>
<span class="line">  currentPriorityLevel <span class="token operator">=</span> priorityLevel<span class="token punctuation">;</span></span>
<span class="line">  <span class="token keyword">try</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">return</span> <span class="token function">eventHandler</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">  <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span></span>
<span class="line">    currentPriorityLevel <span class="token operator">=</span> previousPriorityLevel<span class="token punctuation">;</span></span>
<span class="line">  <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_5-3-更新优先级" tabindex="-1"><a class="header-anchor" href="#_5-3-更新优先级"><span>5.3 更新优先级</span></a></h3><ul><li>setState本质上是调用enqueueSetState,生成一个update对象，这时候会计算它的更新优先级，即update.lane</li><li>首先找出Scheduler中记录的优先级<code>schedulerPriority</code>，然后计算更新优先级</li></ul><p>src\\react\\packages\\react-reconciler\\src\\ReactFiberLane.js</p><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code class="language-javascript"><span class="line"><span class="token keyword">const</span> TotalLanes <span class="token operator">=</span> <span class="token number">31</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">export</span> <span class="token keyword">const</span> <span class="token literal-property property">NoLanes</span><span class="token operator">:</span> Lanes <span class="token operator">=</span> <span class="token comment">/*                        */</span> <span class="token number">0b0000000000000000000000000000000</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">export</span> <span class="token keyword">const</span> <span class="token literal-property property">NoLane</span><span class="token operator">:</span> Lane <span class="token operator">=</span> <span class="token comment">/*                          */</span> <span class="token number">0b0000000000000000000000000000000</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">export</span> <span class="token keyword">const</span> <span class="token literal-property property">SyncLane</span><span class="token operator">:</span> Lane <span class="token operator">=</span> <span class="token comment">/*                        */</span> <span class="token number">0b0000000000000000000000000000001</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">export</span> <span class="token keyword">const</span> <span class="token literal-property property">SyncBatchedLane</span><span class="token operator">:</span> Lane <span class="token operator">=</span> <span class="token comment">/*                 */</span> <span class="token number">0b0000000000000000000000000000010</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">export</span> <span class="token keyword">const</span> <span class="token literal-property property">InputDiscreteHydrationLane</span><span class="token operator">:</span> Lane <span class="token operator">=</span> <span class="token comment">/*      */</span> <span class="token number">0b0000000000000000000000000000100</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">const</span> <span class="token literal-property property">InputDiscreteLanes</span><span class="token operator">:</span> Lanes <span class="token operator">=</span> <span class="token comment">/*                    */</span> <span class="token number">0b0000000000000000000000000011000</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">const</span> <span class="token literal-property property">InputContinuousHydrationLane</span><span class="token operator">:</span> Lane <span class="token operator">=</span> <span class="token comment">/*           */</span> <span class="token number">0b0000000000000000000000000100000</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">const</span> <span class="token literal-property property">InputContinuousLanes</span><span class="token operator">:</span> Lanes <span class="token operator">=</span> <span class="token comment">/*                  */</span> <span class="token number">0b0000000000000000000000011000000</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">export</span> <span class="token keyword">const</span> <span class="token literal-property property">DefaultHydrationLane</span><span class="token operator">:</span> Lane <span class="token operator">=</span> <span class="token comment">/*            */</span> <span class="token number">0b0000000000000000000000100000000</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">export</span> <span class="token keyword">const</span> <span class="token literal-property property">DefaultLanes</span><span class="token operator">:</span> Lanes <span class="token operator">=</span> <span class="token comment">/*                   */</span> <span class="token number">0b0000000000000000000111000000000</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">const</span> <span class="token literal-property property">TransitionHydrationLane</span><span class="token operator">:</span> Lane <span class="token operator">=</span> <span class="token comment">/*                */</span> <span class="token number">0b0000000000000000001000000000000</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">const</span> <span class="token literal-property property">TransitionLanes</span><span class="token operator">:</span> Lanes <span class="token operator">=</span> <span class="token comment">/*                       */</span> <span class="token number">0b0000000001111111110000000000000</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">const</span> <span class="token literal-property property">RetryLanes</span><span class="token operator">:</span> Lanes <span class="token operator">=</span> <span class="token comment">/*                            */</span> <span class="token number">0b0000011110000000000000000000000</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">export</span> <span class="token keyword">const</span> <span class="token literal-property property">SomeRetryLane</span><span class="token operator">:</span> Lanes <span class="token operator">=</span> <span class="token comment">/*                  */</span> <span class="token number">0b0000010000000000000000000000000</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">export</span> <span class="token keyword">const</span> <span class="token literal-property property">SelectiveHydrationLane</span><span class="token operator">:</span> Lane <span class="token operator">=</span> <span class="token comment">/*          */</span> <span class="token number">0b0000100000000000000000000000000</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">const</span> NonIdleLanes <span class="token operator">=</span> <span class="token comment">/*                                 */</span> <span class="token number">0b0000111111111111111111111111111</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">export</span> <span class="token keyword">const</span> <span class="token literal-property property">IdleHydrationLane</span><span class="token operator">:</span> Lane <span class="token operator">=</span> <span class="token comment">/*               */</span> <span class="token number">0b0001000000000000000000000000000</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">const</span> <span class="token literal-property property">IdleLanes</span><span class="token operator">:</span> Lanes <span class="token operator">=</span> <span class="token comment">/*                             */</span> <span class="token number">0b0110000000000000000000000000000</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">export</span> <span class="token keyword">const</span> <span class="token literal-property property">OffscreenLane</span><span class="token operator">:</span> Lane <span class="token operator">=</span> <span class="token comment">/*                   */</span> <span class="token number">0b1000000000000000000000000000000</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">let</span> currentUpdateLanePriority <span class="token operator">=</span> NoLanePriority<span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">getCurrentUpdateLanePriority</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">  <span class="token keyword">return</span> currentUpdateLanePriority<span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">setCurrentUpdateLanePriority</span><span class="token punctuation">(</span><span class="token parameter">newLanePriority</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">  currentUpdateLanePriority <span class="token operator">=</span> newLanePriority<span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_5-4-任务优先级" tabindex="-1"><a class="header-anchor" href="#_5-4-任务优先级"><span>5.4 任务优先级</span></a></h3><ul><li>update会被一个React的更新任务执行</li><li>任务优先级被用来区分多个更新任务的紧急程度</li><li>收敛同等优先级的任务调度</li><li>高优先级任务及时响应</li></ul><p>src\\react\\packages\\react-reconciler\\src\\ReactFiberLane.js</p><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code class="language-javascript"><span class="line"></span>
<span class="line"><span class="token keyword">export</span> <span class="token keyword">const</span> <span class="token literal-property property">SyncLanePriority</span><span class="token operator">:</span> LanePriority <span class="token operator">=</span> <span class="token number">15</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">export</span> <span class="token keyword">const</span> <span class="token literal-property property">SyncBatchedLanePriority</span><span class="token operator">:</span> LanePriority <span class="token operator">=</span> <span class="token number">14</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">const</span> <span class="token literal-property property">InputDiscreteHydrationLanePriority</span><span class="token operator">:</span> LanePriority <span class="token operator">=</span> <span class="token number">13</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">export</span> <span class="token keyword">const</span> <span class="token literal-property property">InputDiscreteLanePriority</span><span class="token operator">:</span> LanePriority <span class="token operator">=</span> <span class="token number">12</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">const</span> <span class="token literal-property property">InputContinuousHydrationLanePriority</span><span class="token operator">:</span> LanePriority <span class="token operator">=</span> <span class="token number">11</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">export</span> <span class="token keyword">const</span> <span class="token literal-property property">InputContinuousLanePriority</span><span class="token operator">:</span> LanePriority <span class="token operator">=</span> <span class="token number">10</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">const</span> <span class="token literal-property property">DefaultHydrationLanePriority</span><span class="token operator">:</span> LanePriority <span class="token operator">=</span> <span class="token number">9</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">export</span> <span class="token keyword">const</span> <span class="token literal-property property">DefaultLanePriority</span><span class="token operator">:</span> LanePriority <span class="token operator">=</span> <span class="token number">8</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">const</span> <span class="token literal-property property">TransitionHydrationPriority</span><span class="token operator">:</span> LanePriority <span class="token operator">=</span> <span class="token number">7</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">export</span> <span class="token keyword">const</span> <span class="token literal-property property">TransitionPriority</span><span class="token operator">:</span> LanePriority <span class="token operator">=</span> <span class="token number">6</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">const</span> <span class="token literal-property property">RetryLanePriority</span><span class="token operator">:</span> LanePriority <span class="token operator">=</span> <span class="token number">5</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">const</span> <span class="token literal-property property">SelectiveHydrationLanePriority</span><span class="token operator">:</span> LanePriority <span class="token operator">=</span> <span class="token number">4</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">const</span> <span class="token literal-property property">IdleHydrationLanePriority</span><span class="token operator">:</span> LanePriority <span class="token operator">=</span> <span class="token number">3</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">const</span> <span class="token literal-property property">IdleLanePriority</span><span class="token operator">:</span> LanePriority <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">const</span> <span class="token literal-property property">OffscreenLanePriority</span><span class="token operator">:</span> LanePriority <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">export</span> <span class="token keyword">const</span> <span class="token literal-property property">NoLanePriority</span><span class="token operator">:</span> LanePriority <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_5-5-调度优先级" tabindex="-1"><a class="header-anchor" href="#_5-5-调度优先级"><span>5.5 调度优先级</span></a></h3><ul><li>一旦任务被调度，那么它就会进入scheduler</li><li>在Scheduler中，这个任务会被包装一下，生成一个属于Scheduler自己的task，这个task持有的优先级就是调度优先级</li></ul><p>src\\react\\packages\\react-reconciler\\src\\SchedulerWithReactIntegration.old.js</p><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code class="language-javascript"><span class="line"><span class="token keyword">export</span> <span class="token keyword">const</span> <span class="token literal-property property">ImmediatePriority</span><span class="token operator">:</span> ReactPriorityLevel <span class="token operator">=</span> <span class="token number">99</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">export</span> <span class="token keyword">const</span> <span class="token literal-property property">UserBlockingPriority</span><span class="token operator">:</span> ReactPriorityLevel <span class="token operator">=</span> <span class="token number">98</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">export</span> <span class="token keyword">const</span> <span class="token literal-property property">NormalPriority</span><span class="token operator">:</span> ReactPriorityLevel <span class="token operator">=</span> <span class="token number">97</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">export</span> <span class="token keyword">const</span> <span class="token literal-property property">LowPriority</span><span class="token operator">:</span> ReactPriorityLevel <span class="token operator">=</span> <span class="token number">96</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">export</span> <span class="token keyword">const</span> <span class="token literal-property property">IdlePriority</span><span class="token operator">:</span> ReactPriorityLevel <span class="token operator">=</span> <span class="token number">95</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">export</span> <span class="token keyword">const</span> <span class="token literal-property property">NoPriority</span><span class="token operator">:</span> ReactPriorityLevel <span class="token operator">=</span> <span class="token number">90</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div>`,109)])])}const i=s(t,[["render",l]]),r=JSON.parse('{"path":"/strong/126.12.react-2.html","title":"","lang":"en-US","frontmatter":{},"git":{"updatedTime":1681290319000,"contributors":[{"name":"yutao","username":"yutao","email":"642231346@qq.com","commits":1,"url":"https://github.com/yutao"}],"changelog":[{"hash":"f5ab8c9d34991ec274f7f652439afe5b2afb6147","time":1681290319000,"email":"642231346@qq.com","author":"yutao","message":"modify"}]},"filePathRelative":"strong/126.12.react-2.md"}');export{i as comp,r as data};
