import{_ as s,c as a,a as p,o as t}from"./app-CD1YpnS1.js";const e={};function l(o,n){return t(),a("div",null,[...n[0]||(n[0]=[p(`<h2 id="_1-本课学习目标" tabindex="-1"><a class="header-anchor" href="#_1-本课学习目标"><span>1.本课学习目标</span></a></h2><ul><li>学习如何获取专业权威的一手知识</li><li>学习如何阅读RFC标准文档</li><li>学习扩展的巴科斯范式(ABNF)定义的通信协议语言</li><li>学习HTTP协议的实现和解析细节</li></ul><h3 id="_1-1-tcp-ip参考模型" tabindex="-1"><a class="header-anchor" href="#_1-1-tcp-ip参考模型"><span>1.1 TCP/IP参考模型</span></a></h3><ul><li>TCP/IP协议被称为传输控制协议/互联网协议，又称网络通讯协议</li></ul><p><img src="http://img.zhufengpeixun.cn/protocal.png" alt="protocal"></p><h2 id="_2-get" tabindex="-1"><a class="header-anchor" href="#_2-get"><span>2.GET</span></a></h2><h3 id="_2-1-使用" tabindex="-1"><a class="header-anchor" href="#_2-1-使用"><span>2.1 使用</span></a></h3><h4 id="_2-1-1-http-server-js" tabindex="-1"><a class="header-anchor" href="#_2-1-1-http-server-js"><span>2.1.1 http-server.js</span></a></h4><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code class="language-javascript"><span class="line"><span class="token keyword">const</span> http <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&#39;http&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">const</span> fs <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&#39;fs&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">const</span> path <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&#39;path&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">const</span> server <span class="token operator">=</span> http<span class="token punctuation">.</span><span class="token function">createServer</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span>res</span><span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line">  <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">&#39;/get.html&#39;</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">includes</span><span class="token punctuation">(</span>req<span class="token punctuation">.</span>url<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line">    res<span class="token punctuation">.</span><span class="token function">writeHead</span><span class="token punctuation">(</span><span class="token number">200</span><span class="token punctuation">,</span><span class="token punctuation">{</span><span class="token string-property property">&#39;Context-type&#39;</span><span class="token operator">:</span><span class="token string">&quot;text-html&quot;</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    res<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span>fs<span class="token punctuation">.</span><span class="token function">readFileSync</span><span class="token punctuation">(</span>path<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span><span class="token string">&#39;static&#39;</span><span class="token punctuation">,</span>req<span class="token punctuation">.</span>url<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">  <span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>req<span class="token punctuation">.</span>url <span class="token operator">===</span> <span class="token string">&#39;/get&#39;</span><span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line">    res<span class="token punctuation">.</span><span class="token function">writeHead</span><span class="token punctuation">(</span><span class="token number">200</span><span class="token punctuation">,</span><span class="token punctuation">{</span><span class="token string-property property">&#39;Context-type&#39;</span><span class="token operator">:</span><span class="token string">&quot;text-plain&quot;</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    res<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token string">&#39;get&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">  <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">server<span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span><span class="token number">8080</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_2-1-2-static-get-html" tabindex="-1"><a class="header-anchor" href="#_2-1-2-static-get-html"><span>2.1.2 static\\get.html</span></a></h4><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code class="language-javascript"><span class="line"><span class="token operator">&lt;</span><span class="token operator">!</span><span class="token constant">DOCTYPE</span> html<span class="token operator">&gt;</span></span>
<span class="line"><span class="token operator">&lt;</span>html lang<span class="token operator">=</span><span class="token string">&quot;en&quot;</span><span class="token operator">&gt;</span></span>
<span class="line"><span class="token operator">&lt;</span>head<span class="token operator">&gt;</span></span>
<span class="line">    <span class="token operator">&lt;</span>meta charset<span class="token operator">=</span><span class="token string">&quot;UTF-8&quot;</span><span class="token operator">&gt;</span></span>
<span class="line">    <span class="token operator">&lt;</span>meta name<span class="token operator">=</span><span class="token string">&quot;viewport&quot;</span> content<span class="token operator">=</span><span class="token string">&quot;width=device-width, initial-scale=1.0&quot;</span><span class="token operator">&gt;</span></span>
<span class="line">    <span class="token operator">&lt;</span>title<span class="token operator">&gt;</span>get<span class="token operator">&lt;</span><span class="token operator">/</span>title<span class="token operator">&gt;</span></span>
<span class="line"><span class="token operator">&lt;</span><span class="token operator">/</span>head<span class="token operator">&gt;</span></span>
<span class="line"><span class="token operator">&lt;</span>body<span class="token operator">&gt;</span></span>
<span class="line">    <span class="token operator">&lt;</span>script<span class="token operator">&gt;</span></span>
<span class="line">        <span class="token keyword">let</span> xhr <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">XMLHttpRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        xhr<span class="token punctuation">.</span><span class="token function-variable function">onreadystatechange</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span></span>
<span class="line">            console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&#39;onreadystatechange&#39;</span><span class="token punctuation">,</span>xhr<span class="token punctuation">.</span>readyState<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">        xhr<span class="token punctuation">.</span><span class="token function">open</span><span class="token punctuation">(</span><span class="token string">&quot;GET&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;http://127.0.0.1:8080/get&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        xhr<span class="token punctuation">.</span>responseType<span class="token operator">=</span><span class="token string">&quot;text&quot;</span><span class="token punctuation">;</span></span>
<span class="line">        xhr<span class="token punctuation">.</span><span class="token function">setRequestHeader</span><span class="token punctuation">(</span><span class="token string">&#39;name&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;zhufeng&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        xhr<span class="token punctuation">.</span><span class="token function">setRequestHeader</span><span class="token punctuation">(</span><span class="token string">&#39;age&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;10&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        xhr<span class="token punctuation">.</span><span class="token function-variable function">onload</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></span>
<span class="line">            console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&#39;readyState&#39;</span><span class="token punctuation">,</span>xhr<span class="token punctuation">.</span>readyState<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">            console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&#39;status&#39;</span><span class="token punctuation">,</span>xhr<span class="token punctuation">.</span>status<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">            console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&#39;statusText&#39;</span><span class="token punctuation">,</span>xhr<span class="token punctuation">.</span>statusText<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">            console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&#39;getAllResponseHeaders&#39;</span><span class="token punctuation">,</span>xhr<span class="token punctuation">.</span><span class="token function">getAllResponseHeaders</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">            console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&#39;response&#39;</span><span class="token punctuation">,</span>xhr<span class="token punctuation">.</span>response<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token punctuation">}</span><span class="token punctuation">;</span></span>
<span class="line">        xhr<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">     <span class="token operator">&lt;</span><span class="token operator">/</span>script<span class="token operator">&gt;</span></span>
<span class="line"><span class="token operator">&lt;</span><span class="token operator">/</span>body<span class="token operator">&gt;</span></span>
<span class="line"><span class="token operator">&lt;</span><span class="token operator">/</span>html<span class="token operator">&gt;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_2-1-3-请求响应格式" tabindex="-1"><a class="header-anchor" href="#_2-1-3-请求响应格式"><span>2.1.3 请求响应格式</span></a></h4><ul><li>一个请求消息是从客户端到服务器端的,在消息首行里包含方法,资源指标符,协议版本</li></ul><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text"><pre><code class="language-text"><span class="line">Request=Request-Line;</span>
<span class="line">*((general-header|request-header|entity-header)CRLF)</span>
<span class="line">CRLF</span>
<span class="line">[message-body]</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h5 id="_2-1-3-1-请求" tabindex="-1"><a class="header-anchor" href="#_2-1-3-1-请求"><span>2.1.3.1 请求</span></a></h5><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code class="language-javascript"><span class="line"><span class="token constant">GET</span> <span class="token operator">/</span><span class="token keyword">get</span> <span class="token constant">HTTP</span><span class="token operator">/</span><span class="token number">1.1</span></span>
<span class="line"><span class="token literal-property property">Host</span><span class="token operator">:</span> <span class="token number">127.0</span><span class="token number">.0</span><span class="token number">.1</span><span class="token operator">:</span><span class="token number">8080</span></span>
<span class="line"><span class="token literal-property property">Connection</span><span class="token operator">:</span> keep<span class="token operator">-</span>alive</span>
<span class="line"><span class="token literal-property property">name</span><span class="token operator">:</span> zhufeng</span>
<span class="line"><span class="token literal-property property">age</span><span class="token operator">:</span> <span class="token number">10</span></span>
<span class="line">User<span class="token operator">-</span>Agent<span class="token operator">:</span> Mozilla<span class="token operator">/</span><span class="token number">5.0</span> <span class="token punctuation">(</span>Windows <span class="token constant">NT</span> <span class="token number">10.0</span><span class="token punctuation">;</span> Win64<span class="token punctuation">;</span> x64<span class="token punctuation">)</span> AppleWebKit<span class="token operator">/</span><span class="token number">537.36</span> <span class="token punctuation">(</span><span class="token constant">KHTML</span><span class="token punctuation">,</span> like Gecko<span class="token punctuation">)</span> Chrome<span class="token operator">/</span><span class="token number">84.0</span><span class="token number">.4147</span><span class="token number">.89</span> Safari<span class="token operator">/</span><span class="token number">537.36</span></span>
<span class="line"><span class="token literal-property property">Accept</span><span class="token operator">:</span> <span class="token operator">*</span><span class="token comment">/*</span>
<span class="line">Accept-Encoding: gzip, deflate, br</span>
<span class="line">Accept-Language: zh-CN,zh;q=0.9</span>
<span class="line"></span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><img src="http://img.zhufengpeixun.cn/http_get_request.png" alt="http_get_request"></p><h5 id="_2-1-3-2-响应" tabindex="-1"><a class="header-anchor" href="#_2-1-3-2-响应"><span>2.1.3.2 响应</span></a></h5><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text"><pre><code class="language-text"><span class="line">Response=Status-Line;</span>
<span class="line">*((general-header|response-header|entity-header)CRLF)</span>
<span class="line">CRLF</span>
<span class="line">[message-body]</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code class="language-javascript"><span class="line"><span class="token constant">HTTP</span><span class="token operator">/</span><span class="token number">1.1</span> <span class="token number">200</span> <span class="token constant">OK</span></span>
<span class="line">Context<span class="token operator">-</span>type<span class="token operator">:</span> text<span class="token operator">-</span>plain</span>
<span class="line"><span class="token literal-property property">Date</span><span class="token operator">:</span> Fri<span class="token punctuation">,</span> <span class="token number">14</span> Aug <span class="token number">2020</span> <span class="token number">03</span><span class="token operator">:</span><span class="token number">58</span><span class="token operator">:</span><span class="token number">41</span> <span class="token constant">GMT</span></span>
<span class="line"><span class="token literal-property property">Connection</span><span class="token operator">:</span> keep<span class="token operator">-</span>alive</span>
<span class="line">Transfer<span class="token operator">-</span>Encoding<span class="token operator">:</span> chunked</span>
<span class="line"></span>
<span class="line"><span class="token number">3</span></span>
<span class="line"><span class="token keyword">get</span></span>
<span class="line"><span class="token number">0</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><img src="http://img.zhufengpeixun.cn/http_get_response.png" alt="http_get_response"></p><h3 id="_2-2-实现" tabindex="-1"><a class="header-anchor" href="#_2-2-实现"><span>2.2 实现</span></a></h3><h4 id="_2-2-1-tcp-get-client-js" tabindex="-1"><a class="header-anchor" href="#_2-2-1-tcp-get-client-js"><span>2.2.1 tcp-get-client.js</span></a></h4><ul><li><a href="https://developer.mozilla.org/zh-CN/docs/Web/API/XMLHttpRequest/readyState" target="_blank" rel="noopener noreferrer">readyState</a></li></ul><p>tcp-get-client.js</p><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code class="language-javascript"><span class="line"><span class="token keyword">let</span> net <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&#39;net&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">const</span> ReadyState <span class="token operator">=</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token constant">UNSENT</span><span class="token operator">:</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token comment">//（代理被创建，但尚未调用 open() 方法。</span></span>
<span class="line">    <span class="token constant">OPENED</span><span class="token operator">:</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token comment">//open() 方法已经被调用</span></span>
<span class="line">    <span class="token constant">HEADERS_RECEIVED</span><span class="token operator">:</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token comment">//send() 方法已经被调用，并且头部和状态已经可获得。</span></span>
<span class="line">    <span class="token constant">LOADING</span><span class="token operator">:</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token comment">//（交互）正在解析响应内容</span></span>
<span class="line">    <span class="token constant">DONE</span><span class="token operator">:</span><span class="token number">4</span> <span class="token comment">//（完成）响应内容解析完成，可以在客户端调用了</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"><span class="token keyword">class</span> <span class="token class-name">XMLHttpRequest</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">this</span><span class="token punctuation">.</span>readyState <span class="token operator">=</span> ReadyState<span class="token punctuation">.</span><span class="token constant">UNSENT</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">this</span><span class="token punctuation">.</span>headers <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    <span class="token function">open</span><span class="token punctuation">(</span><span class="token parameter">method<span class="token punctuation">,</span> url</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">this</span><span class="token punctuation">.</span>method <span class="token operator">=</span> method<span class="token operator">||</span><span class="token string">&#39;GET&#39;</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">this</span><span class="token punctuation">.</span>url <span class="token operator">=</span> url<span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">let</span> <span class="token punctuation">{</span>hostname<span class="token punctuation">,</span>port<span class="token punctuation">,</span>path<span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&#39;url&#39;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>url<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">this</span><span class="token punctuation">.</span>hostname <span class="token operator">=</span> hostname<span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">this</span><span class="token punctuation">.</span>port <span class="token operator">=</span> port<span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">this</span><span class="token punctuation">.</span>path <span class="token operator">=</span> path<span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">this</span><span class="token punctuation">.</span>headers<span class="token punctuation">.</span>Host<span class="token operator">=</span><span class="token template-string"><span class="token template-punctuation string">\`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">\${</span>hostname<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">:</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">\${</span>port<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">\`</span></span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">const</span> socket <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>socket <span class="token operator">=</span>  net<span class="token punctuation">.</span><span class="token function">createConnection</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token literal-property property">port</span><span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>port<span class="token punctuation">,</span><span class="token literal-property property">hostname</span><span class="token operator">:</span><span class="token keyword">this</span><span class="token punctuation">.</span>hostname<span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span></span>
<span class="line">            socket<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">&#39;data&#39;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">data</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></span>
<span class="line">                data <span class="token operator">=</span> data<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">                <span class="token keyword">let</span> <span class="token punctuation">[</span>response<span class="token punctuation">,</span>bodyRows<span class="token punctuation">]</span> <span class="token operator">=</span> data<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">&#39;\\r\\n\\r\\n&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">                <span class="token keyword">let</span> <span class="token punctuation">[</span>statusLine<span class="token punctuation">,</span><span class="token operator">...</span>headerRows<span class="token punctuation">]</span> <span class="token operator">=</span> response<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">&#39;\\r\\n&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">                <span class="token keyword">let</span> <span class="token punctuation">[</span><span class="token punctuation">,</span>status<span class="token punctuation">,</span>statusText<span class="token punctuation">]</span> <span class="token operator">=</span> statusLine<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">&#39; &#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">                <span class="token keyword">this</span><span class="token punctuation">.</span>status <span class="token operator">=</span> status<span class="token punctuation">;</span></span>
<span class="line">                <span class="token keyword">this</span><span class="token punctuation">.</span>statusText <span class="token operator">=</span> statusText<span class="token punctuation">;</span></span>
<span class="line">                <span class="token keyword">this</span><span class="token punctuation">.</span>responseHeaders <span class="token operator">=</span> headerRows<span class="token punctuation">.</span><span class="token function">reduce</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">memo<span class="token punctuation">,</span>row</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span></span>
<span class="line">                    <span class="token keyword">let</span> <span class="token punctuation">[</span>key<span class="token punctuation">,</span>value<span class="token punctuation">]</span> <span class="token operator">=</span> row<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">&#39;: &#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">                    memo<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token operator">=</span> value<span class="token punctuation">;</span></span>
<span class="line">                    <span class="token keyword">return</span> memo<span class="token punctuation">;</span></span>
<span class="line">                <span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">                <span class="token keyword">this</span><span class="token punctuation">.</span>readyState <span class="token operator">=</span> ReadyState<span class="token punctuation">.</span><span class="token constant">HEADERS_RECEIVED</span><span class="token punctuation">;</span></span>
<span class="line">                xhr<span class="token punctuation">.</span>onreadystatechange<span class="token operator">&amp;&amp;</span>xhr<span class="token punctuation">.</span><span class="token function">onreadystatechange</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">                <span class="token keyword">this</span><span class="token punctuation">.</span>readyState <span class="token operator">=</span> ReadyState<span class="token punctuation">.</span><span class="token constant">LOADING</span><span class="token punctuation">;</span></span>
<span class="line">                xhr<span class="token punctuation">.</span>onreadystatechange<span class="token operator">&amp;&amp;</span>xhr<span class="token punctuation">.</span><span class="token function">onreadystatechange</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">                <span class="token keyword">let</span> <span class="token punctuation">[</span><span class="token punctuation">,</span>body<span class="token punctuation">,</span><span class="token punctuation">]</span> <span class="token operator">=</span> bodyRows<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">&#39;\\r\\n&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">                <span class="token keyword">this</span><span class="token punctuation">.</span>response <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>responseText <span class="token operator">=</span> body<span class="token punctuation">;</span></span>
<span class="line">                <span class="token keyword">this</span><span class="token punctuation">.</span>readyState <span class="token operator">=</span> ReadyState<span class="token punctuation">.</span><span class="token constant">DONE</span><span class="token punctuation">;</span></span>
<span class="line">                xhr<span class="token punctuation">.</span>onreadystatechange<span class="token operator">&amp;&amp;</span>xhr<span class="token punctuation">.</span><span class="token function">onreadystatechange</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">                <span class="token keyword">this</span><span class="token punctuation">.</span>onload<span class="token operator">&amp;&amp;</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">onload</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">            socket<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">&#39;error&#39;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">err</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></span>
<span class="line">                <span class="token keyword">this</span><span class="token punctuation">.</span>onerror<span class="token operator">&amp;&amp;</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">onerror</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">         <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">         <span class="token keyword">this</span><span class="token punctuation">.</span>readyState <span class="token operator">=</span> ReadyState<span class="token punctuation">.</span><span class="token constant">OPENED</span><span class="token punctuation">;</span></span>
<span class="line">         xhr<span class="token punctuation">.</span>onreadystatechange<span class="token operator">&amp;&amp;</span>xhr<span class="token punctuation">.</span><span class="token function">onreadystatechange</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    <span class="token function">getAllResponseHeaders</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">let</span> allResponseHeaders<span class="token operator">=</span><span class="token string">&#39;&#39;</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">let</span> key <span class="token keyword">in</span> <span class="token keyword">this</span><span class="token punctuation">.</span>responseHeaders<span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line">            allResponseHeaders<span class="token operator">+=</span><span class="token template-string"><span class="token template-punctuation string">\`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">\${</span>key<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">\${</span><span class="token keyword">this</span><span class="token punctuation">.</span>responseHeaders<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">\\r\\n</span><span class="token template-punctuation string">\`</span></span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">        <span class="token keyword">return</span> allResponseHeaders<span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    <span class="token function">setRequestHeader</span><span class="token punctuation">(</span><span class="token parameter">header<span class="token punctuation">,</span>value</span><span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">this</span><span class="token punctuation">.</span>headers<span class="token punctuation">[</span>header<span class="token punctuation">]</span><span class="token operator">=</span> value<span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    <span class="token function">send</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">let</span> rows <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span></span>
<span class="line">        rows<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">\`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">\${</span><span class="token keyword">this</span><span class="token punctuation">.</span>method<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">\${</span><span class="token keyword">this</span><span class="token punctuation">.</span>path<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> HTTP/1.1</span><span class="token template-punctuation string">\`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        rows<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token operator">...</span>Object<span class="token punctuation">.</span><span class="token function">keys</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>headers<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token parameter">key</span><span class="token operator">=&gt;</span><span class="token template-string"><span class="token template-punctuation string">\`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">\${</span>key<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">\${</span><span class="token keyword">this</span><span class="token punctuation">.</span>headers<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">\`</span></span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">this</span><span class="token punctuation">.</span>socket<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span>rows<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token string">&#39;\\r\\n&#39;</span><span class="token punctuation">)</span><span class="token operator">+</span><span class="token string">&#39;\\r\\n\\r\\n&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">let</span> xhr <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">XMLHttpRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">xhr<span class="token punctuation">.</span><span class="token function-variable function">onreadystatechange</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span></span>
<span class="line">    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&#39;onreadystatechange&#39;</span><span class="token punctuation">,</span>xhr<span class="token punctuation">.</span>readyState<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line">xhr<span class="token punctuation">.</span><span class="token function">open</span><span class="token punctuation">(</span><span class="token string">&quot;GET&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;http://127.0.0.1:8080/get&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">xhr<span class="token punctuation">.</span>responseType<span class="token operator">=</span><span class="token string">&quot;text&quot;</span><span class="token punctuation">;</span></span>
<span class="line">xhr<span class="token punctuation">.</span><span class="token function">setRequestHeader</span><span class="token punctuation">(</span><span class="token string">&#39;name&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;zhufeng&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">xhr<span class="token punctuation">.</span><span class="token function">setRequestHeader</span><span class="token punctuation">(</span><span class="token string">&#39;age&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;10&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">xhr<span class="token punctuation">.</span><span class="token function-variable function">onload</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></span>
<span class="line">    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&#39;readyState&#39;</span><span class="token punctuation">,</span>xhr<span class="token punctuation">.</span>readyState<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&#39;status&#39;</span><span class="token punctuation">,</span>xhr<span class="token punctuation">.</span>status<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&#39;statusText&#39;</span><span class="token punctuation">,</span>xhr<span class="token punctuation">.</span>statusText<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&#39;getAllResponseHeaders&#39;</span><span class="token punctuation">,</span>xhr<span class="token punctuation">.</span><span class="token function">getAllResponseHeaders</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&#39;response&#39;</span><span class="token punctuation">,</span>xhr<span class="token punctuation">.</span>response<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span><span class="token punctuation">;</span></span>
<span class="line">xhr<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_2-2-2-tcp-get-sever" tabindex="-1"><a class="header-anchor" href="#_2-2-2-tcp-get-sever"><span>2.2.2 tcp-get-sever</span></a></h4><p>tcp-get-sever.js</p><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code class="language-javascript"><span class="line"><span class="token keyword">const</span> net <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&#39;net&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">const</span> server <span class="token operator">=</span> net<span class="token punctuation">.</span><span class="token function">createServer</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">socket</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></span>
<span class="line">  socket<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">&#39;data&#39;</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token parameter">data</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">let</span> request <span class="token operator">=</span> data<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">let</span> <span class="token punctuation">[</span>requestLine<span class="token punctuation">,</span><span class="token operator">...</span>headerRows<span class="token punctuation">]</span> <span class="token operator">=</span> request<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">&#39;\\r\\n&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">let</span> <span class="token punctuation">[</span>method<span class="token punctuation">,</span>path<span class="token punctuation">]</span> <span class="token operator">=</span> requestLine<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">&#39; &#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">let</span> headers <span class="token operator">=</span> headerRows<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">reduce</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">memo<span class="token punctuation">,</span>row</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span></span>
<span class="line">      <span class="token keyword">let</span> <span class="token punctuation">[</span>key<span class="token punctuation">,</span>value<span class="token punctuation">]</span> <span class="token operator">=</span> row<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">&#39;: &#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">      memo<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">=</span> value<span class="token punctuation">;</span></span>
<span class="line">      <span class="token keyword">return</span> memo<span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&#39;method&#39;</span><span class="token punctuation">,</span>method<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&#39;path&#39;</span><span class="token punctuation">,</span>path<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&#39;headers&#39;</span><span class="token punctuation">,</span>headers<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">    <span class="token keyword">let</span> rows <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span></span>
<span class="line">    rows<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">\`</span><span class="token string">HTTP/1.1 200 OK</span><span class="token template-punctuation string">\`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    rows<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">\`</span><span class="token string">Context-type: text-plain</span><span class="token template-punctuation string">\`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    rows<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">\`</span><span class="token string">Date: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">\${</span><span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toGMTString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">\`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    rows<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">\`</span><span class="token string">Connection: keep-alive</span><span class="token template-punctuation string">\`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    rows<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">\`</span><span class="token string">Transfer-Encoding: chunked</span><span class="token template-punctuation string">\`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">let</span> responseBody <span class="token operator">=</span> <span class="token string">&#39;get&#39;</span><span class="token punctuation">;</span></span>
<span class="line">    rows<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">\`</span><span class="token string">\\r\\n</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">\${</span>Buffer<span class="token punctuation">.</span><span class="token function">byteLength</span><span class="token punctuation">(</span>responseBody<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">\\r\\n</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">\${</span>responseBody<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">\\r\\n0</span><span class="token template-punctuation string">\`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">let</span> response <span class="token operator">=</span> rows<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token string">&#39;\\r\\n&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    socket<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span>response<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span><span class="token punctuation">)</span></span>
<span class="line">server<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">&#39;error&#39;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">err</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></span>
<span class="line">  console<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">server<span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span><span class="token number">8080</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></span>
<span class="line">  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&#39;服务器已经启动&#39;</span><span class="token punctuation">,</span> server<span class="token punctuation">.</span><span class="token function">address</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="_5-post方法" tabindex="-1"><a class="header-anchor" href="#_5-post方法"><span>5.POST方法</span></a></h2><h3 id="_5-1-实战" tabindex="-1"><a class="header-anchor" href="#_5-1-实战"><span>5.1 实战</span></a></h3><h4 id="_5-1-1-请求和响应" tabindex="-1"><a class="header-anchor" href="#_5-1-1-请求和响应"><span>5.1.1 请求和响应</span></a></h4><h5 id="_5-1-1-1-请求" tabindex="-1"><a class="header-anchor" href="#_5-1-1-1-请求"><span>5.1.1.1 请求</span></a></h5><p><img src="http://img.zhufengpeixun.cn/http_post_request.png" alt="http_post_request"></p><h5 id="_5-1-1-2-响应" tabindex="-1"><a class="header-anchor" href="#_5-1-1-2-响应"><span>5.1.1.2 响应</span></a></h5><p><img src="http://img.zhufengpeixun.cn/http_post_response.png" alt="http_post_response"></p><h4 id="_5-1-2-http-server-js" tabindex="-1"><a class="header-anchor" href="#_5-1-2-http-server-js"><span>5.1.2 http-server.js</span></a></h4><p>http-server.js</p><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code class="language-javascript"><span class="line"><span class="token keyword">const</span> http <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&#39;http&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">const</span> fs <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&#39;fs&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">const</span> path <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&#39;path&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">const</span> server <span class="token operator">=</span> http<span class="token punctuation">.</span><span class="token function">createServer</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span>res</span><span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line"><span class="token operator">+</span>  <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">&#39;/get.html&#39;</span><span class="token punctuation">,</span><span class="token string">&#39;/post.html&#39;</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">includes</span><span class="token punctuation">(</span>req<span class="token punctuation">.</span>url<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line">    res<span class="token punctuation">.</span><span class="token function">writeHead</span><span class="token punctuation">(</span><span class="token number">200</span><span class="token punctuation">,</span><span class="token punctuation">{</span><span class="token string-property property">&#39;Context-type&#39;</span><span class="token operator">:</span><span class="token string">&quot;text-html&quot;</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    res<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span>fs<span class="token punctuation">.</span><span class="token function">readFileSync</span><span class="token punctuation">(</span>path<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span><span class="token string">&#39;static&#39;</span><span class="token punctuation">,</span>req<span class="token punctuation">.</span>url<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">  <span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>req<span class="token punctuation">.</span>url <span class="token operator">===</span> <span class="token string">&#39;/get&#39;</span><span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line">    res<span class="token punctuation">.</span><span class="token function">writeHead</span><span class="token punctuation">(</span><span class="token number">200</span><span class="token punctuation">,</span><span class="token punctuation">{</span><span class="token string-property property">&#39;Context-type&#39;</span><span class="token operator">:</span><span class="token string">&quot;text-plain&quot;</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    res<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token string">&#39;get&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token operator">+</span>  <span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>req<span class="token punctuation">.</span>url <span class="token operator">===</span> <span class="token string">&#39;/post&#39;</span><span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line"><span class="token operator">+</span>    <span class="token keyword">let</span> buffers <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token operator">+</span>    req<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">&#39;data&#39;</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token parameter">data</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span></span>
<span class="line"><span class="token operator">+</span>      buffers<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token operator">+</span>    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token operator">+</span>    req<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">&#39;end&#39;</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span></span>
<span class="line"><span class="token operator">+</span>      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&#39;method&#39;</span><span class="token punctuation">,</span>req<span class="token punctuation">.</span>method<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token operator">+</span>      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&#39;url&#39;</span><span class="token punctuation">,</span>req<span class="token punctuation">.</span>url<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token operator">+</span>      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&#39;headers&#39;</span><span class="token punctuation">,</span>req<span class="token punctuation">.</span>headers<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token operator">+</span>      <span class="token keyword">let</span> body <span class="token operator">=</span> Buffer<span class="token punctuation">.</span><span class="token function">concat</span><span class="token punctuation">(</span>buffers<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token operator">+</span>      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&#39;body&#39;</span><span class="token punctuation">,</span>body<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token operator">+</span>      res<span class="token punctuation">.</span>statusCode <span class="token operator">=</span> <span class="token number">200</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token operator">+</span>      res<span class="token punctuation">.</span><span class="token function">setHeader</span><span class="token punctuation">(</span><span class="token string">&#39;Context-type&#39;</span><span class="token punctuation">,</span><span class="token string">&quot;text-plain&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token operator">+</span>      res<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span>body<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token operator">+</span>      res<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token operator">+</span>    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">  <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">server<span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span><span class="token number">8080</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_5-1-3-static-post-html" tabindex="-1"><a class="header-anchor" href="#_5-1-3-static-post-html"><span>5.1.3 static\\post.html</span></a></h4><p>static\\post.html</p><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text"><pre><code class="language-text"><span class="line">&lt;!DOCTYPE html&gt;</span>
<span class="line">&lt;html lang=&quot;en&quot;&gt;</span>
<span class="line">&lt;head&gt;</span>
<span class="line">    &lt;meta charset=&quot;UTF-8&quot;&gt;</span>
<span class="line">    &lt;meta name=&quot;viewport&quot; content=&quot;width=device-width, initial-scale=1.0&quot;&gt;</span>
<span class="line">    &lt;title&gt;get&lt;/title&gt;</span>
<span class="line">&lt;/head&gt;</span>
<span class="line">&lt;body&gt;</span>
<span class="line">    &lt;script&gt;</span>
<span class="line">        let xhr = new XMLHttpRequest();</span>
<span class="line">        xhr.onreadystatechange = ()=&gt;{</span>
<span class="line">            console.log(&#39;onreadystatechange&#39;,xhr.readyState);</span>
<span class="line">        }</span>
<span class="line">+        xhr.open(&quot;POST&quot;, &quot;http://127.0.0.1:8080/post&quot;);</span>
<span class="line">        xhr.responseType=&quot;text&quot;;</span>
<span class="line">+        xhr.setRequestHeader(&#39;Content-Type&#39;,&#39;application/json&#39;);</span>
<span class="line">        xhr.onload = () =&gt; {</span>
<span class="line">            console.log(&#39;readyState&#39;,xhr.readyState);</span>
<span class="line">            console.log(&#39;status&#39;,xhr.status);</span>
<span class="line">            console.log(&#39;statusText&#39;,xhr.statusText);</span>
<span class="line">            console.log(&#39;getAllResponseHeaders&#39;,xhr.getAllResponseHeaders());</span>
<span class="line">            console.log(&#39;response&#39;,xhr.response);</span>
<span class="line">        };</span>
<span class="line">+        xhr.send(JSON.stringify({name:&#39;zhufeng&#39;,age:10}));</span>
<span class="line">     &lt;/script&gt;</span>
<span class="line">&lt;/body&gt;</span>
<span class="line">&lt;/html&gt;</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_5-2-实现" tabindex="-1"><a class="header-anchor" href="#_5-2-实现"><span>5.2 实现</span></a></h3><h4 id="_5-2-1-tcp-post-client-js" tabindex="-1"><a class="header-anchor" href="#_5-2-1-tcp-post-client-js"><span>5.2.1 tcp-post-client.js</span></a></h4><p>tcp-post-client.js</p><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text"><pre><code class="language-text"><span class="line">let net = require(&#39;net&#39;);</span>
<span class="line">const ReadyState = {</span>
<span class="line">    UNSENT:0,//（代理被创建，但尚未调用 open() 方法。</span>
<span class="line">    OPENED:1,//open() 方法已经被调用</span>
<span class="line">    HEADERS_RECEIVED:2,//send() 方法已经被调用，并且头部和状态已经可获得。</span>
<span class="line">    LOADING:3,//（交互）正在解析响应内容</span>
<span class="line">    DONE:4 //（完成）响应内容解析完成，可以在客户端调用了</span>
<span class="line">}</span>
<span class="line">class XMLHttpRequest {</span>
<span class="line">    constructor(){</span>
<span class="line">        this.readyState = ReadyState.UNSENT;</span>
<span class="line">        this.headers = {};</span>
<span class="line">    }</span>
<span class="line">    open(method, url) {</span>
<span class="line">        this.method = method||&#39;GET&#39;;</span>
<span class="line">        this.url = url;</span>
<span class="line">        let {hostname,port,path} = require(&#39;url&#39;).parse(url);</span>
<span class="line">        this.hostname = hostname;</span>
<span class="line">        this.port = port;</span>
<span class="line">        this.path = path;</span>
<span class="line">        this.headers.Host=\`\${hostname}:\${port}\`;</span>
<span class="line">+       this.headers.Connection=\`keep-alive\`;</span>
<span class="line">        const socket = this.socket =  net.createConnection({port: this.port,hostname:this.hostname},()=&gt;{</span>
<span class="line">            socket.on(&#39;data&#39;, (data) =&gt; {</span>
<span class="line">                data = data.toString();</span>
<span class="line">                console.log(data);</span>
<span class="line">                let [response,bodyRows] = data.split(&#39;\\r\\n\\r\\n&#39;);</span>
<span class="line">                let [statusLine,...headerRows] = response.split(&#39;\\r\\n&#39;);</span>
<span class="line">                let [,status,statusText] = statusLine.split(&#39; &#39;);</span>
<span class="line">                this.status = status;</span>
<span class="line">                this.statusText = statusText;</span>
<span class="line">                this.responseHeaders = headerRows.reduce((memo,row)=&gt;{</span>
<span class="line">                    let [key,value] = row.split(&#39;: &#39;);</span>
<span class="line">                    memo[key]= value;</span>
<span class="line">                    return memo;</span>
<span class="line">                },{});</span>
<span class="line">                this.readyState = ReadyState.HEADERS_RECEIVED;</span>
<span class="line">                xhr.onreadystatechange&amp;&amp;xhr.onreadystatechange();</span>
<span class="line">                this.readyState = ReadyState.LOADING;</span>
<span class="line">                xhr.onreadystatechange&amp;&amp;xhr.onreadystatechange();</span>
<span class="line">                let [,body,] = bodyRows.split(&#39;\\r\\n&#39;);</span>
<span class="line">                this.response = this.responseText = body;</span>
<span class="line">                this.readyState = ReadyState.DONE;</span>
<span class="line">                xhr.onreadystatechange&amp;&amp;xhr.onreadystatechange();</span>
<span class="line">                this.onload&amp;&amp;this.onload();</span>
<span class="line">            });</span>
<span class="line">            socket.on(&#39;error&#39;, (err) =&gt; {</span>
<span class="line">                this.onerror&amp;&amp;this.onerror(err);</span>
<span class="line">            });</span>
<span class="line">         });</span>
<span class="line">         this.readyState = ReadyState.OPENED;</span>
<span class="line">         xhr.onreadystatechange&amp;&amp;xhr.onreadystatechange();</span>
<span class="line">    }</span>
<span class="line">    getAllResponseHeaders(){</span>
<span class="line">        let allResponseHeaders=&#39;&#39;;</span>
<span class="line">        for(let key in this.responseHeaders){</span>
<span class="line">            allResponseHeaders+=\`\${key}: \${this.responseHeaders[key]}\\r\\n\`;</span>
<span class="line">        }</span>
<span class="line">        return allResponseHeaders;</span>
<span class="line">    }</span>
<span class="line">    setRequestHeader(header,value){</span>
<span class="line">        this.headers[header]= value;</span>
<span class="line">    }</span>
<span class="line">    send(body) {</span>
<span class="line">        let rows = [];</span>
<span class="line">        rows.push(\`\${this.method} \${this.path} HTTP/1.1\`);</span>
<span class="line">+       this.headers[&quot;Content-Length&quot;]=Buffer.byteLength(body);</span>
<span class="line">        rows.push(...Object.keys(this.headers).map(key=&gt;\`\${key}: \${this.headers[key]}\`));</span>
<span class="line">+       let request = rows.join(&#39;\\r\\n&#39;)+&#39;\\r\\n\\r\\n&#39;+body;</span>
<span class="line">        console.log(request);</span>
<span class="line">        this.socket.write(request);</span>
<span class="line">    }</span>
<span class="line">}</span>
<span class="line"></span>
<span class="line">let xhr = new XMLHttpRequest();</span>
<span class="line">xhr.onreadystatechange = ()=&gt;{</span>
<span class="line">    console.log(&#39;onreadystatechange&#39;,xhr.readyState);</span>
<span class="line">}</span>
<span class="line">xhr.open(&quot;POST&quot;, &quot;http://127.0.0.1:8080/post&quot;);</span>
<span class="line">xhr.responseType=&quot;text&quot;;</span>
<span class="line">xhr.setRequestHeader(&#39;Content-Type&#39;,&#39;application/json&#39;);</span>
<span class="line">xhr.onload = () =&gt; {</span>
<span class="line">    console.log(&#39;readyState&#39;,xhr.readyState);</span>
<span class="line">    console.log(&#39;status&#39;,xhr.status);</span>
<span class="line">    console.log(&#39;statusText&#39;,xhr.statusText);</span>
<span class="line">    console.log(&#39;getAllResponseHeaders&#39;,xhr.getAllResponseHeaders());</span>
<span class="line">    console.log(&#39;response&#39;,xhr.response);</span>
<span class="line">};</span>
<span class="line">xhr.send(\`{&quot;name&quot;:&quot;zf&quot;}\`);</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_5-2-2-tcp-post-server-js" tabindex="-1"><a class="header-anchor" href="#_5-2-2-tcp-post-server-js"><span>5.2.2 tcp-post-server.js</span></a></h4><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text"><pre><code class="language-text"><span class="line">const net = require(&#39;net&#39;);</span>
<span class="line">const Parer = require(&#39;./Parser&#39;);</span>
<span class="line">const server = net.createServer((socket) =&gt; {</span>
<span class="line">  socket.on(&#39;data&#39;,(data)=&gt;{</span>
<span class="line">+   let parser = new Parer();</span>
<span class="line">+   let {method,url,headers,body} = parser.parse(data);</span>
<span class="line">+   console.log(&#39;method&#39;,method);</span>
<span class="line">+   console.log(&#39;url&#39;,url);</span>
<span class="line">+   console.log(&#39;headers&#39;,headers);</span>
<span class="line">+   console.log(&#39;body&#39;,body);</span>
<span class="line">    let rows = [];</span>
<span class="line">    rows.push(\`HTTP/1.1 200 OK\`);</span>
<span class="line">    rows.push(\`Context-type: text-plain\`);</span>
<span class="line">    rows.push(\`Date: \${new Date().toGMTString()}\`);</span>
<span class="line">    rows.push(\`Connection: keep-alive\`);</span>
<span class="line">    rows.push(\`Transfer-Encoding: chunked\`);</span>
<span class="line">    rows.push(\`\\r\\n\${Buffer.byteLength(body).toString(16)}\\r\\n\${body}\\r\\n0\`);</span>
<span class="line">    let response = rows.join(&#39;\\r\\n&#39;);</span>
<span class="line">    socket.end(response);</span>
<span class="line">  });</span>
<span class="line">})</span>
<span class="line">server.on(&#39;error&#39;, (err) =&gt; {</span>
<span class="line">  console.error(err);</span>
<span class="line">});</span>
<span class="line"></span>
<span class="line">server.listen(8080,() =&gt; {</span>
<span class="line">  console.log(&#39;服务器已经启动&#39;, server.address());</span>
<span class="line">});</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_5-2-3-parser-js" tabindex="-1"><a class="header-anchor" href="#_5-2-3-parser-js"><span>5.2.3 Parser.js</span></a></h4><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code class="language-javascript"><span class="line"><span class="token keyword">let</span> <span class="token constant">LF</span> <span class="token operator">=</span> <span class="token number">10</span><span class="token punctuation">,</span><span class="token comment">//换行  line feed</span></span>
<span class="line">    <span class="token constant">CR</span> <span class="token operator">=</span> <span class="token number">13</span><span class="token punctuation">,</span><span class="token comment">//回车 carriage return</span></span>
<span class="line">    <span class="token constant">SPACE</span> <span class="token operator">=</span> <span class="token number">32</span><span class="token punctuation">,</span><span class="token comment">//空格</span></span>
<span class="line">    <span class="token constant">COLON</span> <span class="token operator">=</span> <span class="token number">58</span><span class="token punctuation">;</span><span class="token comment">//冒号</span></span>
<span class="line"><span class="token keyword">let</span> <span class="token constant">PARSER_UNINITIALIZED</span><span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token comment">//未解析</span></span>
<span class="line">    <span class="token constant">START</span><span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token comment">//开始解析</span></span>
<span class="line">    <span class="token constant">REQUEST_LINE</span><span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token constant">HEADER_FIELD_START</span><span class="token operator">=</span><span class="token number">3</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token constant">HEADER_FIELD</span><span class="token operator">=</span><span class="token number">4</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token constant">HEADER_VALUE_START</span><span class="token operator">=</span><span class="token number">5</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token constant">HEADER_VALUE</span><span class="token operator">=</span><span class="token number">6</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token constant">READING_BODY</span><span class="token operator">=</span><span class="token number">7</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">class</span> <span class="token class-name">Parser</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">this</span><span class="token punctuation">.</span>state <span class="token operator">=</span> <span class="token constant">PARSER_UNINITIALIZED</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    <span class="token function">parse</span><span class="token punctuation">(</span><span class="token parameter">buffer</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">let</span> self <span class="token operator">=</span><span class="token keyword">this</span><span class="token punctuation">,</span></span>
<span class="line">            requestLine<span class="token operator">=</span><span class="token string">&#39;&#39;</span><span class="token punctuation">,</span></span>
<span class="line">            headers <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">            body<span class="token operator">=</span><span class="token string">&#39;&#39;</span><span class="token punctuation">,</span></span>
<span class="line">            i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span></span>
<span class="line">            char<span class="token punctuation">,</span></span>
<span class="line">            state <span class="token operator">=</span> <span class="token constant">START</span><span class="token punctuation">,</span><span class="token comment">//开始解析</span></span>
<span class="line">            headerField<span class="token operator">=</span><span class="token string">&#39;&#39;</span><span class="token punctuation">,</span></span>
<span class="line">            headerValue<span class="token operator">=</span><span class="token string">&#39;&#39;</span><span class="token punctuation">;</span></span>
<span class="line">            console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>buffer<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> buffer<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">            char <span class="token operator">=</span> buffer<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span></span>
<span class="line">            <span class="token keyword">switch</span> <span class="token punctuation">(</span>state<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">                <span class="token keyword">case</span> <span class="token constant">START</span><span class="token operator">:</span></span>
<span class="line">                    state <span class="token operator">=</span> <span class="token constant">REQUEST_LINE</span><span class="token punctuation">;</span></span>
<span class="line">                    self<span class="token punctuation">[</span><span class="token string">&#39;requestLineMark&#39;</span><span class="token punctuation">]</span><span class="token operator">=</span>i<span class="token punctuation">;</span></span>
<span class="line">                <span class="token keyword">case</span> <span class="token constant">REQUEST_LINE</span><span class="token operator">:</span></span>
<span class="line">                    <span class="token keyword">if</span> <span class="token punctuation">(</span>char <span class="token operator">==</span> <span class="token constant">CR</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token comment">//换行</span></span>
<span class="line">                        requestLine<span class="token operator">=</span>buffer<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token string">&#39;utf8&#39;</span><span class="token punctuation">,</span> self<span class="token punctuation">[</span><span class="token string">&#39;requestLineMark&#39;</span><span class="token punctuation">]</span><span class="token punctuation">,</span> i<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">                        <span class="token keyword">break</span><span class="token punctuation">;</span></span>
<span class="line">                    <span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>char <span class="token operator">==</span> <span class="token constant">LF</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token comment">//回车</span></span>
<span class="line">                        state <span class="token operator">=</span> <span class="token constant">HEADER_FIELD_START</span><span class="token punctuation">;</span></span>
<span class="line">                    <span class="token punctuation">}</span></span>
<span class="line">                    <span class="token keyword">break</span><span class="token punctuation">;</span></span>
<span class="line">                <span class="token keyword">case</span> <span class="token constant">HEADER_FIELD_START</span><span class="token operator">:</span></span>
<span class="line">                    <span class="token keyword">if</span><span class="token punctuation">(</span>char <span class="token operator">===</span> <span class="token constant">CR</span><span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line">                        state <span class="token operator">=</span> <span class="token constant">READING_BODY</span><span class="token punctuation">;</span></span>
<span class="line">                        self<span class="token punctuation">[</span><span class="token string">&#39;bodyMark&#39;</span><span class="token punctuation">]</span> <span class="token operator">=</span> i<span class="token operator">+</span><span class="token number">2</span><span class="token punctuation">;</span></span>
<span class="line">                        <span class="token keyword">break</span><span class="token punctuation">;</span></span>
<span class="line">                    <span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{</span></span>
<span class="line">                        state <span class="token operator">=</span> <span class="token constant">HEADER_FIELD</span><span class="token punctuation">;</span></span>
<span class="line">                        self<span class="token punctuation">[</span><span class="token string">&#39;headerFieldMark&#39;</span><span class="token punctuation">]</span> <span class="token operator">=</span> i<span class="token punctuation">;</span></span>
<span class="line">                    <span class="token punctuation">}</span></span>
<span class="line">                <span class="token keyword">case</span> <span class="token constant">HEADER_FIELD</span><span class="token operator">:</span>   </span>
<span class="line">                   <span class="token keyword">if</span> <span class="token punctuation">(</span>char <span class="token operator">==</span> <span class="token constant">COLON</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">                    headerField<span class="token operator">=</span>buffer<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token string">&#39;utf8&#39;</span><span class="token punctuation">,</span> self<span class="token punctuation">[</span><span class="token string">&#39;headerFieldMark&#39;</span><span class="token punctuation">]</span><span class="token punctuation">,</span> i<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">                    state <span class="token operator">=</span> <span class="token constant">HEADER_VALUE_START</span><span class="token punctuation">;</span></span>
<span class="line">                   <span class="token punctuation">}</span></span>
<span class="line">                   <span class="token keyword">break</span><span class="token punctuation">;</span></span>
<span class="line">                <span class="token keyword">case</span> <span class="token constant">HEADER_VALUE_START</span><span class="token operator">:</span></span>
<span class="line">                    <span class="token keyword">if</span> <span class="token punctuation">(</span>char <span class="token operator">==</span> <span class="token constant">SPACE</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">                        <span class="token keyword">break</span><span class="token punctuation">;</span></span>
<span class="line">                    <span class="token punctuation">}</span></span>
<span class="line">                    self<span class="token punctuation">[</span><span class="token string">&#39;headerValueMark&#39;</span><span class="token punctuation">]</span> <span class="token operator">=</span> i<span class="token punctuation">;</span></span>
<span class="line">                    state <span class="token operator">=</span> <span class="token constant">HEADER_VALUE</span><span class="token punctuation">;</span></span>
<span class="line">                <span class="token keyword">case</span> <span class="token constant">HEADER_VALUE</span><span class="token operator">:</span></span>
<span class="line">                    <span class="token keyword">if</span> <span class="token punctuation">(</span>char <span class="token operator">===</span> <span class="token constant">CR</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">                        headerValue<span class="token operator">=</span>buffer<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token string">&#39;utf8&#39;</span><span class="token punctuation">,</span> self<span class="token punctuation">[</span><span class="token string">&#39;headerValueMark&#39;</span><span class="token punctuation">]</span><span class="token punctuation">,</span> i<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">                        headers<span class="token punctuation">[</span>headerField<span class="token punctuation">]</span> <span class="token operator">=</span> headerValue<span class="token punctuation">;</span></span>
<span class="line">                        headerField <span class="token operator">=</span> <span class="token string">&#39;&#39;</span><span class="token punctuation">;</span></span>
<span class="line">                        headerValue <span class="token operator">=</span> <span class="token string">&#39;&#39;</span><span class="token punctuation">;</span></span>
<span class="line">                    <span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>char <span class="token operator">===</span> <span class="token constant">LF</span><span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line">                        state <span class="token operator">=</span> <span class="token constant">HEADER_FIELD_START</span><span class="token punctuation">;</span></span>
<span class="line">                    <span class="token punctuation">}</span></span>
<span class="line">                    <span class="token keyword">break</span><span class="token punctuation">;</span></span>
<span class="line">                <span class="token keyword">default</span><span class="token operator">:</span></span>
<span class="line">                    <span class="token keyword">break</span><span class="token punctuation">;</span>    </span>
<span class="line">            <span class="token punctuation">}</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">        <span class="token keyword">let</span> <span class="token punctuation">[</span>method<span class="token punctuation">,</span>url<span class="token punctuation">]</span> <span class="token operator">=</span>requestLine<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">&#39; &#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        body<span class="token operator">=</span>buffer<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token string">&#39;utf8&#39;</span><span class="token punctuation">,</span> self<span class="token punctuation">[</span><span class="token string">&#39;bodyMark&#39;</span><span class="token punctuation">]</span><span class="token punctuation">,</span> i<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">return</span> <span class="token punctuation">{</span>method<span class="token punctuation">,</span>url<span class="token punctuation">,</span>headers<span class="token punctuation">,</span>body<span class="token punctuation">}</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line">module<span class="token punctuation">.</span>exports <span class="token operator">=</span> Parser<span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="_6-文件上传" tabindex="-1"><a class="header-anchor" href="#_6-文件上传"><span>6.文件上传</span></a></h2><h3 id="_6-1-实战" tabindex="-1"><a class="header-anchor" href="#_6-1-实战"><span>6.1 实战</span></a></h3><h4 id="_6-1-1-请求和响应" tabindex="-1"><a class="header-anchor" href="#_6-1-1-请求和响应"><span>6.1.1 请求和响应</span></a></h4><h5 id="_6-1-1-1-请求" tabindex="-1"><a class="header-anchor" href="#_6-1-1-1-请求"><span>6.1.1.1 请求</span></a></h5><p><img src="http://img.zhufengpeixun.cn/http_upload_request.png" alt="http_upload_request"></p><h5 id="_6-1-1-2-响应" tabindex="-1"><a class="header-anchor" href="#_6-1-1-2-响应"><span>6.1.1.2 响应</span></a></h5><p><img src="http://img.zhufengpeixun.cn/http_upload_response.png" alt="http_upload_response"></p><h4 id="_6-1-2-http-server-js" tabindex="-1"><a class="header-anchor" href="#_6-1-2-http-server-js"><span>6.1.2 http-server.js</span></a></h4><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code class="language-javascript"><span class="line"><span class="token keyword">const</span> http <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&#39;http&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">const</span> fs <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&#39;fs&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">const</span> path <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&#39;path&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">const</span> formidable <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&#39;formidable&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">const</span> url <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&#39;url&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">const</span> server <span class="token operator">=</span> http<span class="token punctuation">.</span><span class="token function">createServer</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span>res</span><span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line">  <span class="token keyword">const</span> <span class="token punctuation">{</span>pathname<span class="token punctuation">}</span> <span class="token operator">=</span> url<span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>req<span class="token punctuation">.</span>url<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">  <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">&#39;/get.html&#39;</span><span class="token punctuation">,</span><span class="token string">&#39;/post.html&#39;</span><span class="token punctuation">,</span><span class="token string">&#39;/upload.html&#39;</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">includes</span><span class="token punctuation">(</span>pathname<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line">    res<span class="token punctuation">.</span><span class="token function">writeHead</span><span class="token punctuation">(</span><span class="token number">200</span><span class="token punctuation">,</span><span class="token punctuation">{</span><span class="token string-property property">&#39;Context-type&#39;</span><span class="token operator">:</span><span class="token string">&quot;text-html&quot;</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    res<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span>fs<span class="token punctuation">.</span><span class="token function">readFileSync</span><span class="token punctuation">(</span>path<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span><span class="token string">&#39;static&#39;</span><span class="token punctuation">,</span>pathname<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">  <span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>pathname <span class="token operator">===</span> <span class="token string">&#39;/get&#39;</span><span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line">    res<span class="token punctuation">.</span><span class="token function">writeHead</span><span class="token punctuation">(</span><span class="token number">200</span><span class="token punctuation">,</span><span class="token punctuation">{</span><span class="token string-property property">&#39;Context-type&#39;</span><span class="token operator">:</span><span class="token string">&quot;text-plain&quot;</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    res<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token string">&#39;get&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">  <span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>pathname <span class="token operator">===</span> <span class="token string">&#39;/post&#39;</span><span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">let</span> buffers <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span></span>
<span class="line">    req<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">&#39;data&#39;</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token parameter">data</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span></span>
<span class="line">      buffers<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    req<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">&#39;end&#39;</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span></span>
<span class="line">      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&#39;method&#39;</span><span class="token punctuation">,</span>req<span class="token punctuation">.</span>method<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&#39;url&#39;</span><span class="token punctuation">,</span>req<span class="token punctuation">.</span>url<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&#39;headers&#39;</span><span class="token punctuation">,</span>req<span class="token punctuation">.</span>headers<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">      <span class="token keyword">let</span> body <span class="token operator">=</span> Buffer<span class="token punctuation">.</span><span class="token function">concat</span><span class="token punctuation">(</span>buffers<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&#39;body&#39;</span><span class="token punctuation">,</span>body<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">      res<span class="token punctuation">.</span>statusCode <span class="token operator">=</span> <span class="token number">200</span><span class="token punctuation">;</span></span>
<span class="line">      res<span class="token punctuation">.</span><span class="token function">setHeader</span><span class="token punctuation">(</span><span class="token string">&#39;Context-type&#39;</span><span class="token punctuation">,</span><span class="token string">&quot;text-plain&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">      res<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span>body<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">      res<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">  <span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>req<span class="token punctuation">.</span>url <span class="token operator">===</span> <span class="token string">&#39;/upload&#39;</span><span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line"><span class="token operator">+</span>    <span class="token keyword">const</span> form <span class="token operator">=</span> <span class="token function">formidable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token operator">+</span>    form<span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>req<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">err<span class="token punctuation">,</span> fields<span class="token punctuation">,</span> files</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></span>
<span class="line"><span class="token operator">+</span>      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&#39;fields&#39;</span><span class="token punctuation">,</span>fields<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token operator">+</span>      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&#39;files&#39;</span><span class="token punctuation">,</span>files<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token operator">+</span>      <span class="token keyword">let</span> avatar <span class="token operator">=</span> files<span class="token punctuation">.</span>avatar<span class="token punctuation">;</span></span>
<span class="line"><span class="token operator">+</span>      <span class="token keyword">let</span> filePath <span class="token operator">=</span> path<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span><span class="token string">&#39;static&#39;</span><span class="token punctuation">,</span>avatar<span class="token punctuation">.</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token operator">+</span>      fs<span class="token punctuation">.</span><span class="token function">writeFileSync</span><span class="token punctuation">(</span>filePath<span class="token punctuation">,</span>fs<span class="token punctuation">.</span><span class="token function">readFileSync</span><span class="token punctuation">(</span>avatar<span class="token punctuation">.</span>path<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token operator">+</span>      res<span class="token punctuation">.</span>statusCode <span class="token operator">=</span> <span class="token number">200</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token operator">+</span>      res<span class="token punctuation">.</span><span class="token function">setHeader</span><span class="token punctuation">(</span><span class="token string">&#39;Context-type&#39;</span><span class="token punctuation">,</span><span class="token string">&quot;text-plain&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token operator">+</span>      res<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span><span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token operator">...</span>fields<span class="token punctuation">,</span><span class="token literal-property property">avatar</span><span class="token operator">:</span>filePath<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token operator">+</span>      res<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token operator">+</span>    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">  <span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{</span></span>
<span class="line">    res<span class="token punctuation">.</span>statusCode <span class="token operator">=</span> <span class="token number">404</span><span class="token punctuation">;</span></span>
<span class="line">    res<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">  <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">server<span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span><span class="token number">8080</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_6-1-3-static-upload-html" tabindex="-1"><a class="header-anchor" href="#_6-1-3-static-upload-html"><span>6.1.3 static\\upload.html</span></a></h4><p>static\\upload.html</p><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code class="language-javascript"><span class="line"><span class="token operator">&lt;</span><span class="token operator">!</span><span class="token constant">DOCTYPE</span> html<span class="token operator">&gt;</span></span>
<span class="line"><span class="token operator">&lt;</span>html lang<span class="token operator">=</span><span class="token string">&quot;en&quot;</span><span class="token operator">&gt;</span></span>
<span class="line"><span class="token operator">&lt;</span>head<span class="token operator">&gt;</span></span>
<span class="line">    <span class="token operator">&lt;</span>meta charset<span class="token operator">=</span><span class="token string">&quot;UTF-8&quot;</span><span class="token operator">&gt;</span></span>
<span class="line">    <span class="token operator">&lt;</span>meta name<span class="token operator">=</span><span class="token string">&quot;viewport&quot;</span> content<span class="token operator">=</span><span class="token string">&quot;width=device-width, initial-scale=1.0&quot;</span><span class="token operator">&gt;</span></span>
<span class="line">    <span class="token operator">&lt;</span>title<span class="token operator">&gt;</span>get<span class="token operator">&lt;</span><span class="token operator">/</span>title<span class="token operator">&gt;</span></span>
<span class="line"><span class="token operator">&lt;</span><span class="token operator">/</span>head<span class="token operator">&gt;</span></span>
<span class="line"><span class="token operator">&lt;</span>body<span class="token operator">&gt;</span></span>
<span class="line">    <span class="token operator">&lt;</span>form onsubmit<span class="token operator">=</span><span class="token string">&quot;upload(event)&quot;</span><span class="token operator">&gt;</span></span>
<span class="line">        <span class="token operator">&lt;</span>input type<span class="token operator">=</span><span class="token string">&quot;text&quot;</span> id<span class="token operator">=</span><span class="token string">&quot;username&quot;</span><span class="token operator">/</span><span class="token operator">&gt;</span></span>
<span class="line">        <span class="token operator">&lt;</span>input type<span class="token operator">=</span><span class="token string">&quot;file&quot;</span> id<span class="token operator">=</span><span class="token string">&quot;file&quot;</span><span class="token operator">/</span><span class="token operator">&gt;</span></span>
<span class="line">        <span class="token operator">&lt;</span>input type<span class="token operator">=</span><span class="token string">&quot;submit&quot;</span><span class="token operator">/</span><span class="token operator">&gt;</span></span>
<span class="line">    <span class="token operator">&lt;</span><span class="token operator">/</span>form<span class="token operator">&gt;</span></span>
<span class="line">    <span class="token operator">&lt;</span>script<span class="token operator">&gt;</span></span>
<span class="line">       <span class="token keyword">function</span> <span class="token function">upload</span><span class="token punctuation">(</span><span class="token parameter">event</span><span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line">        event<span class="token punctuation">.</span><span class="token function">preventDefault</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">let</span> username<span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">&#39;username&#39;</span><span class="token punctuation">)</span><span class="token punctuation">.</span>value<span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">let</span> file<span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">&#39;file&#39;</span><span class="token punctuation">)</span><span class="token punctuation">.</span>files<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">let</span> xhr <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">XMLHttpRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        xhr<span class="token punctuation">.</span><span class="token function">open</span><span class="token punctuation">(</span><span class="token string">&quot;POST&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;http://localhost:8080/upload&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">var</span> formData<span class="token operator">=</span><span class="token keyword">new</span> <span class="token class-name">FormData</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        formData<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string">&quot;username&quot;</span><span class="token punctuation">,</span>username<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        formData<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string">&quot;file&quot;</span><span class="token punctuation">,</span>file<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        xhr<span class="token punctuation">.</span>responseType<span class="token operator">=</span><span class="token string">&quot;text&quot;</span><span class="token punctuation">;</span></span>
<span class="line">        xhr<span class="token punctuation">.</span><span class="token function-variable function">onload</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></span>
<span class="line">            console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>xhr<span class="token punctuation">.</span>response<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token punctuation">}</span><span class="token punctuation">;</span></span>
<span class="line">        xhr<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span>formData<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">       <span class="token punctuation">}</span></span>
<span class="line">     <span class="token operator">&lt;</span><span class="token operator">/</span>script<span class="token operator">&gt;</span></span>
<span class="line"><span class="token operator">&lt;</span><span class="token operator">/</span>body<span class="token operator">&gt;</span></span>
<span class="line"><span class="token operator">&lt;</span><span class="token operator">/</span>html<span class="token operator">&gt;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_6-1-4-tcp-upload-client-js" tabindex="-1"><a class="header-anchor" href="#_6-1-4-tcp-upload-client-js"><span>6.1.4 tcp-upload-client.js</span></a></h4><p>tcp-upload-client.js</p><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text"><pre><code class="language-text"><span class="line">let net = require(&#39;net&#39;);</span>
<span class="line">let fs = require(&#39;fs&#39;);</span>
<span class="line">let path = require(&#39;path&#39;);</span>
<span class="line">const ReadyState = {</span>
<span class="line">    UNSENT:0,//（代理被创建，但尚未调用 open() 方法。</span>
<span class="line">    OPENED:1,//open() 方法已经被调用</span>
<span class="line">    HEADERS_RECEIVED:2,//send() 方法已经被调用，并且头部和状态已经可获得。</span>
<span class="line">    LOADING:3,//（交互）正在解析响应内容</span>
<span class="line">    DONE:4 //（完成）响应内容解析完成，可以在客户端调用了</span>
<span class="line">}</span>
<span class="line">class XMLHttpRequest {</span>
<span class="line">    constructor(){</span>
<span class="line">        this.readyState = ReadyState.UNSENT;</span>
<span class="line">        this.headers = {};</span>
<span class="line">    }</span>
<span class="line">    open(method, url) {</span>
<span class="line">        this.method = method||&#39;GET&#39;;</span>
<span class="line">        this.url = url;</span>
<span class="line">        let {hostname,port,path} = require(&#39;url&#39;).parse(url);</span>
<span class="line">        this.hostname = hostname;</span>
<span class="line">        this.port = port;</span>
<span class="line">        this.path = path;</span>
<span class="line">        this.headers.Host=\`\${hostname}:\${port}\`;</span>
<span class="line">        this.headers.Connection=\`keep-alive\`;</span>
<span class="line">        const socket = this.socket =  net.createConnection({port: this.port,hostname:this.hostname},()=&gt;{</span>
<span class="line">            socket.on(&#39;data&#39;, (data) =&gt; {</span>
<span class="line">                data = data.toString();</span>
<span class="line">                console.log(data);</span>
<span class="line">                let [response,bodyRows] = data.split(&#39;\\r\\n\\r\\n&#39;);</span>
<span class="line">                let [statusLine,...headerRows] = response.split(&#39;\\r\\n&#39;);</span>
<span class="line">                let [,status,statusText] = statusLine.split(&#39; &#39;);</span>
<span class="line">                this.status = status;</span>
<span class="line">                this.statusText = statusText;</span>
<span class="line">                this.responseHeaders = headerRows.reduce((memo,row)=&gt;{</span>
<span class="line">                    let [key,value] = row.split(&#39;: &#39;);</span>
<span class="line">                    memo[key]= value;</span>
<span class="line">                    return memo;</span>
<span class="line">                },{});</span>
<span class="line">                this.readyState = ReadyState.HEADERS_RECEIVED;</span>
<span class="line">                xhr.onreadystatechange&amp;&amp;xhr.onreadystatechange();</span>
<span class="line">                this.readyState = ReadyState.LOADING;</span>
<span class="line">                xhr.onreadystatechange&amp;&amp;xhr.onreadystatechange();</span>
<span class="line">                let [,body,] = bodyRows.split(&#39;\\r\\n&#39;);</span>
<span class="line">                this.response = this.responseText = body;</span>
<span class="line">                this.readyState = ReadyState.DONE;</span>
<span class="line">                xhr.onreadystatechange&amp;&amp;xhr.onreadystatechange();</span>
<span class="line">                this.onload&amp;&amp;this.onload();</span>
<span class="line">            });</span>
<span class="line">            socket.on(&#39;error&#39;, (err) =&gt; {</span>
<span class="line">                this.onerror&amp;&amp;this.onerror(err);</span>
<span class="line">            });</span>
<span class="line">         });</span>
<span class="line">         this.readyState = ReadyState.OPENED;</span>
<span class="line">         xhr.onreadystatechange&amp;&amp;xhr.onreadystatechange();</span>
<span class="line">    }</span>
<span class="line">    getAllResponseHeaders(){</span>
<span class="line">        let allResponseHeaders=&#39;&#39;;</span>
<span class="line">        for(let key in this.responseHeaders){</span>
<span class="line">            allResponseHeaders+=\`\${key}: \${this.responseHeaders[key]}\\r\\n\`;</span>
<span class="line">        }</span>
<span class="line">        return allResponseHeaders;</span>
<span class="line">    }</span>
<span class="line">    setRequestHeader(header,value){</span>
<span class="line">        this.headers[header]= value;</span>
<span class="line">    }</span>
<span class="line">+    send(formData) {</span>
<span class="line">+        let rows = [];</span>
<span class="line">+        let boundary = &#39;----WebKitFormBoundaryF5odcsAPqFAB2mkm&#39;;</span>
<span class="line">+        this.headers[&#39;Content-Type&#39;]= \`multipart/form-data; boundary=\${boundary}\`;</span>
<span class="line">+        let parts = [];</span>
<span class="line">+        for(let key in formData){</span>
<span class="line">+            let value = formData[key];</span>
<span class="line">+            if(typeof value === &#39;string&#39;){</span>
<span class="line">+                let rows = [];</span>
<span class="line">+                rows.push(\`Content-Disposition: form-data; name=&quot;\${key}&quot;\\r\\n\`);</span>
<span class="line">+                rows.push(value);</span>
<span class="line">+                parts.push(rows.join(&#39;\\r\\n&#39;));</span>
<span class="line">+            }else{</span>
<span class="line">+                let rows = [];</span>
<span class="line">+                rows.push(\`Content-Disposition: form-data; name=&quot;\${value.name}&quot;; filename=&quot;\${value.filename}&quot;\`);</span>
<span class="line">+                rows.push(\`Content-Type: \${value.contentType}\\r\\n\`);</span>
<span class="line">+                rows.push(value.content);</span>
<span class="line">+                parts.push(rows.join(&#39;\\r\\n&#39;));</span>
<span class="line">+            }</span>
<span class="line">+        }</span>
<span class="line">+        let body = parts.join(&#39;\\r\\n&#39;+&#39;--&#39;+boundary+&#39;\\r\\n&#39;);</span>
<span class="line">+        body = &#39;--&#39;+boundary+&#39;\\r\\n&#39;+body+&#39;\\r\\n--&#39;+boundary+&#39;--&#39;;</span>
<span class="line">+        this.headers[&quot;Content-Length&quot;]=Buffer.byteLength(body);</span>
<span class="line">+        rows.push(\`\${this.method} \${this.path} HTTP/1.1\`);</span>
<span class="line">+        rows.push(...Object.keys(this.headers).map(key=&gt;\`\${key}: \${this.headers[key]}\`));</span>
<span class="line">+        let request = rows.join(&#39;\\r\\n&#39;);</span>
<span class="line">+        request += &#39;\\r\\n\\r\\n&#39;;</span>
<span class="line">+        let buffers = [Buffer.from(request)];</span>
<span class="line">+        buffers.push(Buffer.from(body));</span>
<span class="line">+        this.socket.write(Buffer.concat(buffers));</span>
<span class="line">    }</span>
<span class="line">}</span>
<span class="line">+class FormData{</span>
<span class="line">+    append(key,value){</span>
<span class="line">+        this[key]=value;</span>
<span class="line">+    }</span>
<span class="line">+}</span>
<span class="line">let xhr = new XMLHttpRequest();</span>
<span class="line">xhr.onreadystatechange = ()=&gt;{</span>
<span class="line">    console.log(&#39;onreadystatechange&#39;,xhr.readyState);</span>
<span class="line">}</span>
<span class="line">+xhr.open(&quot;POST&quot;, &quot;http://127.0.0.1:8080/upload&quot;);</span>
<span class="line">xhr.responseType=&quot;text&quot;;</span>
<span class="line">+let formData=new FormData();</span>
<span class="line">+formData.append(&quot;username&quot;,&#39;zhufeng&#39;);</span>
<span class="line">+let file = fs.readFileSync(path.join(__dirname,&#39;file.txt&#39;));</span>
<span class="line">+formData.append(&quot;avatar&quot;,{name:&#39;file&#39;,filename:&#39;file.txt&#39;,contentType:&#39;text/plain&#39;,content:file});</span>
<span class="line">xhr.onload = () =&gt; {</span>
<span class="line">    console.log(&#39;readyState&#39;,xhr.readyState);</span>
<span class="line">    console.log(&#39;status&#39;,xhr.status);</span>
<span class="line">    console.log(&#39;statusText&#39;,xhr.statusText);</span>
<span class="line">    console.log(&#39;getAllResponseHeaders&#39;,xhr.getAllResponseHeaders());</span>
<span class="line">    console.log(&#39;response&#39;,xhr.response);</span>
<span class="line">};</span>
<span class="line">+xhr.send(formData);</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_6-1-5-tcp-upload-server-js" tabindex="-1"><a class="header-anchor" href="#_6-1-5-tcp-upload-server-js"><span>6.1.5 tcp-upload-server.js</span></a></h4><p>tcp-upload-server.js</p><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text"><pre><code class="language-text"><span class="line">const net = require(&#39;net&#39;);</span>
<span class="line">const path = require(&#39;path&#39;);</span>
<span class="line">const fs = require(&#39;fs&#39;);</span>
<span class="line">const Parer = require(&#39;./Parser&#39;);</span>
<span class="line">const server = net.createServer((socket) =&gt; {</span>
<span class="line">  socket.on(&#39;data&#39;,(data)=&gt;{</span>
<span class="line">    let parser = new Parer();</span>
<span class="line">    let {method,url,headers,body} = parser.parse(data);</span>
<span class="line">    console.log(&#39;method&#39;,method);</span>
<span class="line">    console.log(&#39;url&#39;,url);</span>
<span class="line">    console.log(&#39;headers&#39;,headers);</span>
<span class="line">    console.log(&#39;body&#39;,body);</span>
<span class="line">+    let [,boundary] = headers[&#39;Content-Type&#39;].match(/boundary=([^;]+)/i);</span>
<span class="line">+    let parts = body.split(&#39;--&#39;+boundary).slice(1,-1);</span>
<span class="line">+    parts= parts.map(item=&gt;item.slice(2,-2));</span>
<span class="line">+    let fields = {};</span>
<span class="line">+    let files = {};</span>
<span class="line">+    for(let i=0;i&lt;parts.length;i++){</span>
<span class="line">+      let part = parts[i];</span>
<span class="line">+      let rows = part.split(&#39;\\r\\n&#39;);</span>
<span class="line">+      if(rows.length==3){</span>
<span class="line">+        let [key,,value] = rows;</span>
<span class="line">+        let [,name] = key.toString().match(/name=&quot;([^&quot;]+?)&quot;/);</span>
<span class="line">+        fields[name]= value.toString();</span>
<span class="line">+      }else if(rows.length==4){</span>
<span class="line">+        let [key,type,,value] = rows;</span>
<span class="line">+        let [,name,filename] = key.toString().match(/name=&quot;([^&quot;]+?)&quot;; filename=&quot;([^&quot;]+?)&quot;/);</span>
<span class="line">+        let filePath = path.join(__dirname,&#39;static&#39;,filename);</span>
<span class="line">+        fs.writeFileSync(filePath,value);</span>
<span class="line">+        files[name]={name,filename,path:filePath};</span>
<span class="line">+      }</span>
<span class="line">+    }</span>
<span class="line">+    console.log(fields);</span>
<span class="line">+    console.log(files);</span>
<span class="line">    let rows = [];</span>
<span class="line">    rows.push(\`HTTP/1.1 200 OK\`);</span>
<span class="line">    rows.push(\`Context-type: text-plain\`);</span>
<span class="line">    rows.push(\`Date: \${new Date().toGMTString()}\`);</span>
<span class="line">    rows.push(\`Connection: keep-alive\`);</span>
<span class="line">    rows.push(\`Transfer-Encoding: chunked\`);</span>
<span class="line">+    let responseBody = JSON.stringify({...fields,...files});</span>
<span class="line">+    rows.push(\`\\r\\n\${Buffer.byteLength(responseBody).toString(16)}\\r\\n\${responseBody}\\r\\n0\`);</span>
<span class="line">    let response = rows.join(&#39;\\r\\n&#39;);</span>
<span class="line">    socket.end(response);</span>
<span class="line">  });</span>
<span class="line">})</span>
<span class="line">server.on(&#39;error&#39;, (err) =&gt; {</span>
<span class="line">  console.error(err);</span>
<span class="line">});</span>
<span class="line"></span>
<span class="line">server.listen(8080,() =&gt; {</span>
<span class="line">  console.log(&#39;服务器已经启动&#39;, server.address());</span>
<span class="line">});</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div>`,68)])])}const i=s(e,[["render",l]]),u=JSON.parse('{"path":"/strong/108.http.html","title":"","lang":"en-US","frontmatter":{},"git":{"updatedTime":1681290319000,"contributors":[{"name":"yutao","username":"yutao","email":"642231346@qq.com","commits":1,"url":"https://github.com/yutao"}],"changelog":[{"hash":"f5ab8c9d34991ec274f7f652439afe5b2afb6147","time":1681290319000,"email":"642231346@qq.com","author":"yutao","message":"modify"}]},"filePathRelative":"strong/108.http.md"}');export{i as comp,u as data};
