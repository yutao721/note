import{_ as s,c as a,a as p,o as e}from"./app-CD1YpnS1.js";const t={};function l(c,n){return e(),a("div",null,[...n[0]||(n[0]=[p(`<h2 id="_1-rollup实战" tabindex="-1"><a class="header-anchor" href="#_1-rollup实战"><span>1. rollup实战</span></a></h2><ul><li><a href="https://rollupjs.org/guide/en/" target="_blank" rel="noopener noreferrer">rollupjs</a>是下一代ES模块捆绑器</li></ul><h3 id="_1-1-背景" tabindex="-1"><a class="header-anchor" href="#_1-1-背景"><span>1.1 背景</span></a></h3><ul><li>webpack打包非常繁琐，打包体积比较大</li><li>rollup主要是用来打包JS库的</li><li>vue/react/angular都在用rollup作为打包工具</li></ul><h3 id="_1-2-安装依赖" tabindex="-1"><a class="header-anchor" href="#_1-2-安装依赖"><span>1.2 安装依赖</span></a></h3><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text"><pre><code class="language-text"><span class="line">cnpm i @babel/core @babel/preset-env  @rollup/plugin-commonjs @rollup/plugin-node-resolve @rollup/plugin-typescript lodash rollup rollup-plugin-babel postcss rollup-plugin-postcss rollup-plugin-terser tslib typescript rollup-plugin-serve rollup-plugin-livereload -D</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><h3 id="_1-3-初次使用" tabindex="-1"><a class="header-anchor" href="#_1-3-初次使用"><span>1.3 初次使用</span></a></h3><h4 id="_1-3-1-rollup-config-js" tabindex="-1"><a class="header-anchor" href="#_1-3-1-rollup-config-js"><span>1.3.1 rollup.config.js</span></a></h4><ul><li><code>Asynchronous Module Definition</code>异步模块定义</li><li>ES6 module是es6提出了新的模块化方案</li><li><code>IIFE(Immediately Invoked Function Expression)</code>即立即执行函数表达式，所谓立即执行，就是声明一个函数，声明完了立即执行</li><li>UMD全称为<code>Universal Module Definition</code>,也就是通用模块定义</li><li><code>cjs</code>是nodejs采用的模块化标准，commonjs使用方法<code>require</code>来引入模块,这里<code>require()</code>接收的参数是模块名或者是模块文件的路径</li></ul><p>rollup.config.js</p><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code class="language-javascript"><span class="line"><span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token literal-property property">input</span><span class="token operator">:</span><span class="token string">&#39;src/main.js&#39;</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token literal-property property">output</span><span class="token operator">:</span><span class="token punctuation">{</span></span>
<span class="line">        <span class="token literal-property property">file</span><span class="token operator">:</span><span class="token string">&#39;dist/bundle.cjs.js&#39;</span><span class="token punctuation">,</span><span class="token comment">//输出文件的路径和名称</span></span>
<span class="line">        <span class="token literal-property property">format</span><span class="token operator">:</span><span class="token string">&#39;cjs&#39;</span><span class="token punctuation">,</span><span class="token comment">//五种输出格式：amd/es6/iife/umd/cjs</span></span>
<span class="line">        <span class="token literal-property property">name</span><span class="token operator">:</span><span class="token string">&#39;bundleName&#39;</span><span class="token comment">//当format为iife和umd时必须提供，将作为全局变量挂在window下</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_1-3-2-src-main-js" tabindex="-1"><a class="header-anchor" href="#_1-3-2-src-main-js"><span>1.3.2 src\\main.js</span></a></h4><p>src\\main.js</p><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code class="language-javascript"><span class="line">console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&#39;hello&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><h4 id="_1-3-3-package-json" tabindex="-1"><a class="header-anchor" href="#_1-3-3-package-json"><span>1.3.3 package.json</span></a></h4><p>package.json</p><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code class="language-javascript"><span class="line"><span class="token punctuation">{</span></span>
<span class="line"> <span class="token string-property property">&quot;scripts&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token string-property property">&quot;build&quot;</span><span class="token operator">:</span> <span class="token string">&quot;rollup --config&quot;</span></span>
<span class="line">  <span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_1-3-4-dist-index-html" tabindex="-1"><a class="header-anchor" href="#_1-3-4-dist-index-html"><span>1.3.4 dist\\index.html</span></a></h4><p>dist\\index.html</p><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code class="language-javascript"><span class="line"><span class="token operator">&lt;</span><span class="token operator">!</span><span class="token constant">DOCTYPE</span> html<span class="token operator">&gt;</span></span>
<span class="line"><span class="token operator">&lt;</span>html lang<span class="token operator">=</span><span class="token string">&quot;en&quot;</span><span class="token operator">&gt;</span></span>
<span class="line"><span class="token operator">&lt;</span>head<span class="token operator">&gt;</span></span>
<span class="line">    <span class="token operator">&lt;</span>meta charset<span class="token operator">=</span><span class="token string">&quot;UTF-8&quot;</span><span class="token operator">&gt;</span></span>
<span class="line">    <span class="token operator">&lt;</span>meta http<span class="token operator">-</span>equiv<span class="token operator">=</span><span class="token string">&quot;X-UA-Compatible&quot;</span> content<span class="token operator">=</span><span class="token string">&quot;IE=edge&quot;</span><span class="token operator">&gt;</span></span>
<span class="line">    <span class="token operator">&lt;</span>meta name<span class="token operator">=</span><span class="token string">&quot;viewport&quot;</span> content<span class="token operator">=</span><span class="token string">&quot;width=device-width, initial-scale=1.0&quot;</span><span class="token operator">&gt;</span></span>
<span class="line">    <span class="token operator">&lt;</span>title<span class="token operator">&gt;</span>rollup<span class="token operator">&lt;</span><span class="token operator">/</span>title<span class="token operator">&gt;</span></span>
<span class="line"><span class="token operator">&lt;</span><span class="token operator">/</span>head<span class="token operator">&gt;</span></span>
<span class="line"><span class="token operator">&lt;</span>body<span class="token operator">&gt;</span></span>
<span class="line">    <span class="token operator">&lt;</span>script src<span class="token operator">=</span><span class="token string">&quot;bundle.cjs.js&quot;</span><span class="token operator">&gt;</span><span class="token operator">&lt;</span><span class="token operator">/</span>script<span class="token operator">&gt;</span></span>
<span class="line"><span class="token operator">&lt;</span><span class="token operator">/</span>body<span class="token operator">&gt;</span></span>
<span class="line"><span class="token operator">&lt;</span><span class="token operator">/</span>html<span class="token operator">&gt;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_1-4-支持babel" tabindex="-1"><a class="header-anchor" href="#_1-4-支持babel"><span>1.4 支持babel</span></a></h3><ul><li>为了使用新的语法，可以使用babel来进行编译输出</li></ul><h4 id="_1-4-1-安装依赖" tabindex="-1"><a class="header-anchor" href="#_1-4-1-安装依赖"><span>1.4.1 安装依赖</span></a></h4><ul><li>@babel/core是babel的核心包</li><li>@babel/preset-env是预设</li><li>@rollup/plugin-babel是babel插件</li></ul><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text"><pre><code class="language-text"><span class="line">cnpm install @rollup/plugin-babel @babel/core @babel/preset-env --save-dev</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><h4 id="_1-4-2-src-main-js" tabindex="-1"><a class="header-anchor" href="#_1-4-2-src-main-js"><span>1.4.2 src\\main.js</span></a></h4><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code class="language-javascript"><span class="line"><span class="token keyword">let</span> <span class="token function-variable function">sum</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">a<span class="token punctuation">,</span>b</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">return</span> a<span class="token operator">+</span>b<span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"><span class="token keyword">let</span> result <span class="token operator">=</span> <span class="token function">sum</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_1-4-3-babelrc" tabindex="-1"><a class="header-anchor" href="#_1-4-3-babelrc"><span>1.4.3 .babelrc</span></a></h4><p>.babelrc</p><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code class="language-javascript"><span class="line"><span class="token punctuation">{</span></span>
<span class="line">    <span class="token string-property property">&quot;presets&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span></span>
<span class="line">       <span class="token punctuation">[</span></span>
<span class="line">        <span class="token string">&quot;@babel/env&quot;</span><span class="token punctuation">,</span></span>
<span class="line">        <span class="token punctuation">{</span></span>
<span class="line">            <span class="token string-property property">&quot;modules&quot;</span><span class="token operator">:</span><span class="token boolean">false</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">       <span class="token punctuation">]</span></span>
<span class="line">    <span class="token punctuation">]</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_1-4-4-rollup-config-js" tabindex="-1"><a class="header-anchor" href="#_1-4-4-rollup-config-js"><span>1.4.4 rollup.config.js</span></a></h4><p>rollup.config.js</p><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text"><pre><code class="language-text"><span class="line">+import babel from &#39;@rollup/plugin-babel&#39;;</span>
<span class="line">export default {</span>
<span class="line">    input:&#39;src/main.js&#39;,</span>
<span class="line">    output:{</span>
<span class="line">        file:&#39;dist/bundle.cjs.js&#39;,//输出文件的路径和名称</span>
<span class="line">        format:&#39;cjs&#39;,//五种输出格式：amd/es6/iife/umd/cjs</span>
<span class="line">        name:&#39;bundleName&#39;//当format为iife和umd时必须提供，将作为全局变量挂在window下</span>
<span class="line">    },</span>
<span class="line">+   plugins:[</span>
<span class="line">+       babel({</span>
<span class="line">+           exclude:&quot;node_modules/**&quot;</span>
<span class="line">+       })</span>
<span class="line">+   ]</span>
<span class="line">}</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_1-5-tree-shaking" tabindex="-1"><a class="header-anchor" href="#_1-5-tree-shaking"><span>1.5 tree-shaking</span></a></h3><ul><li>Tree-shaking的本质是消除无用的js代码</li><li>rollup只处理函数和顶层的import/export变量</li></ul><h4 id="_1-5-1-src-main-js" tabindex="-1"><a class="header-anchor" href="#_1-5-1-src-main-js"><span>1.5.1 src\\main.js</span></a></h4><p>src\\main.js</p><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code class="language-javascript"><span class="line"><span class="token keyword">import</span> <span class="token punctuation">{</span>name<span class="token punctuation">,</span>age<span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&#39;./msg&#39;</span><span class="token punctuation">;</span></span>
<span class="line">console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_1-5-2-src-msg-js" tabindex="-1"><a class="header-anchor" href="#_1-5-2-src-msg-js"><span>1.5.2 src\\msg.js</span></a></h4><p>src\\msg.js</p><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code class="language-javascript"><span class="line"><span class="token keyword">export</span> <span class="token keyword">var</span> name <span class="token operator">=</span> <span class="token string">&#39;zhufeng&#39;</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">export</span> <span class="token keyword">var</span> age <span class="token operator">=</span> <span class="token number">12</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_1-6-使用第三方模块" tabindex="-1"><a class="header-anchor" href="#_1-6-使用第三方模块"><span>1.6 使用第三方模块</span></a></h3><ul><li>rollup.js编译源码中的模块引用默认只支持 ES6+的模块方式<code>import/export</code></li></ul><h4 id="_1-6-1-安装依赖" tabindex="-1"><a class="header-anchor" href="#_1-6-1-安装依赖"><span>1.6.1 安装依赖</span></a></h4><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text"><pre><code class="language-text"><span class="line">cnpm install @rollup/plugin-node-resolve @rollup/plugin-commonjs lodash  --save-dev</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><h4 id="_1-6-2-src-main-js" tabindex="-1"><a class="header-anchor" href="#_1-6-2-src-main-js"><span>1.6.2 src\\main.js</span></a></h4><p>src\\main.js</p><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code class="language-javascript"><span class="line"><span class="token keyword">import</span> _ <span class="token keyword">from</span> <span class="token string">&#39;lodash&#39;</span><span class="token punctuation">;</span></span>
<span class="line">console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>_<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_1-6-3-rollup-config-js" tabindex="-1"><a class="header-anchor" href="#_1-6-3-rollup-config-js"><span>1.6.3 rollup.config.js</span></a></h4><p>rollup.config.js</p><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text"><pre><code class="language-text"><span class="line">import babel from &#39;rollup-plugin-babel&#39;;</span>
<span class="line">+import resolve from &#39;@rollup/plugin-node-resolve&#39;;</span>
<span class="line">+import commonjs from &#39;@rollup/plugin-commonjs&#39;;</span>
<span class="line">export default {</span>
<span class="line">    input:&#39;src/main.js&#39;,</span>
<span class="line">    output:{</span>
<span class="line">        file:&#39;dist/bundle.cjs.js&#39;,//输出文件的路径和名称</span>
<span class="line">        format:&#39;cjs&#39;,//五种输出格式：amd/es6/iife/umd/cjs</span>
<span class="line">        name:&#39;bundleName&#39;//当format为iife和umd时必须提供，将作为全局变量挂在window下</span>
<span class="line">    },</span>
<span class="line">    plugins:[</span>
<span class="line">        babel({</span>
<span class="line">            exclude:&quot;node_modules/**&quot;</span>
<span class="line">        }),</span>
<span class="line">+       resolve(),</span>
<span class="line">+       commonjs()</span>
<span class="line">    ]</span>
<span class="line">}</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_1-7-使用cdn" tabindex="-1"><a class="header-anchor" href="#_1-7-使用cdn"><span>1.7 使用CDN</span></a></h3><h4 id="_1-7-1-src-main-js" tabindex="-1"><a class="header-anchor" href="#_1-7-1-src-main-js"><span>1.7.1 src\\main.js</span></a></h4><p>src\\main.js</p><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code class="language-javascript"><span class="line"><span class="token keyword">import</span> _ <span class="token keyword">from</span> <span class="token string">&#39;lodash&#39;</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">import</span> $ <span class="token keyword">from</span> <span class="token string">&#39;jquery&#39;</span><span class="token punctuation">;</span></span>
<span class="line">console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>_<span class="token punctuation">.</span><span class="token function">concat</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token number">4</span><span class="token punctuation">,</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>$<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token string">&#39;main&#39;</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_1-7-2-dist-index-html" tabindex="-1"><a class="header-anchor" href="#_1-7-2-dist-index-html"><span>1.7.2 dist\\index.html</span></a></h4><p>dist\\index.html</p><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code class="language-javascript"><span class="line"><span class="token operator">&lt;</span><span class="token operator">!</span><span class="token constant">DOCTYPE</span> html<span class="token operator">&gt;</span></span>
<span class="line"><span class="token operator">&lt;</span>html lang<span class="token operator">=</span><span class="token string">&quot;en&quot;</span><span class="token operator">&gt;</span></span>
<span class="line"><span class="token operator">&lt;</span>head<span class="token operator">&gt;</span></span>
<span class="line">    <span class="token operator">&lt;</span>meta charset<span class="token operator">=</span><span class="token string">&quot;UTF-8&quot;</span><span class="token operator">&gt;</span></span>
<span class="line">    <span class="token operator">&lt;</span>meta http<span class="token operator">-</span>equiv<span class="token operator">=</span><span class="token string">&quot;X-UA-Compatible&quot;</span> content<span class="token operator">=</span><span class="token string">&quot;IE=edge&quot;</span><span class="token operator">&gt;</span></span>
<span class="line">    <span class="token operator">&lt;</span>meta name<span class="token operator">=</span><span class="token string">&quot;viewport&quot;</span> content<span class="token operator">=</span><span class="token string">&quot;width=device-width, initial-scale=1.0&quot;</span><span class="token operator">&gt;</span></span>
<span class="line">    <span class="token operator">&lt;</span>title<span class="token operator">&gt;</span>rollup<span class="token operator">&lt;</span><span class="token operator">/</span>title<span class="token operator">&gt;</span></span>
<span class="line"><span class="token operator">&lt;</span><span class="token operator">/</span>head<span class="token operator">&gt;</span></span>
<span class="line"><span class="token operator">&lt;</span>body<span class="token operator">&gt;</span></span>
<span class="line">    <span class="token operator">&lt;</span>script src<span class="token operator">=</span><span class="token string">&quot;https://cdn.jsdelivr.net/npm/lodash/lodash.min.js&quot;</span><span class="token operator">&gt;</span><span class="token operator">&lt;</span><span class="token operator">/</span>script<span class="token operator">&gt;</span></span>
<span class="line">    <span class="token operator">&lt;</span>script src<span class="token operator">=</span><span class="token string">&quot;https://cdn.jsdelivr.net/npm/jquery/jquery.min.js&quot;</span><span class="token operator">&gt;</span><span class="token operator">&lt;</span><span class="token operator">/</span>script<span class="token operator">&gt;</span></span>
<span class="line">    <span class="token operator">&lt;</span>script src<span class="token operator">=</span><span class="token string">&quot;bundle.cjs.js&quot;</span><span class="token operator">&gt;</span><span class="token operator">&lt;</span><span class="token operator">/</span>script<span class="token operator">&gt;</span></span>
<span class="line"><span class="token operator">&lt;</span><span class="token operator">/</span>body<span class="token operator">&gt;</span></span>
<span class="line"><span class="token operator">&lt;</span><span class="token operator">/</span>html<span class="token operator">&gt;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_1-7-3-rollup-config-js" tabindex="-1"><a class="header-anchor" href="#_1-7-3-rollup-config-js"><span>1.7.3 rollup.config.js</span></a></h4><p>rollup.config.js</p><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text"><pre><code class="language-text"><span class="line">import babel from &#39;rollup-plugin-babel&#39;;</span>
<span class="line">import resolve from &#39;@rollup/plugin-node-resolve&#39;;</span>
<span class="line">import commonjs from &#39;@rollup/plugin-commonjs&#39;;</span>
<span class="line">export default {</span>
<span class="line">    input:&#39;src/main.js&#39;,</span>
<span class="line">    output:{</span>
<span class="line">        file:&#39;dist/bundle.cjs.js&#39;,//输出文件的路径和名称</span>
<span class="line">+       format:&#39;iife&#39;,//五种输出格式：amd/es6/iife/umd/cjs</span>
<span class="line">+       name:&#39;bundleName&#39;,//当format为iife和umd时必须提供，将作为全局变量挂在window下</span>
<span class="line">+       globals:{</span>
<span class="line">+           lodash:&#39;_&#39;, //告诉rollup全局变量_即是lodash</span>
<span class="line">+           jquery:&#39;$&#39; //告诉rollup全局变量$即是jquery</span>
<span class="line">+       }</span>
<span class="line">    },</span>
<span class="line">    plugins:[</span>
<span class="line">        babel({</span>
<span class="line">            exclude:&quot;node_modules/**&quot;</span>
<span class="line">        }),</span>
<span class="line">        resolve(),</span>
<span class="line">        commonjs()</span>
<span class="line">    ],</span>
<span class="line">+   external:[&#39;lodash&#39;,&#39;jquery&#39;]</span>
<span class="line">}</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_1-8-使用typescript" tabindex="-1"><a class="header-anchor" href="#_1-8-使用typescript"><span>1.8 使用typescript</span></a></h3><h4 id="_1-8-1-安装" tabindex="-1"><a class="header-anchor" href="#_1-8-1-安装"><span>1.8.1 安装</span></a></h4><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text"><pre><code class="language-text"><span class="line">cnpm install tslib typescript @rollup/plugin-typescript --save-dev</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><h4 id="_1-8-2-src-main-ts" tabindex="-1"><a class="header-anchor" href="#_1-8-2-src-main-ts"><span>1.8.2 src\\main.ts</span></a></h4><p>src\\main.ts</p><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code class="language-javascript"><span class="line"><span class="token keyword">let</span> <span class="token literal-property property">myName</span><span class="token operator">:</span>string <span class="token operator">=</span> <span class="token string">&#39;zhufeng&#39;</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">let</span> <span class="token literal-property property">age</span><span class="token operator">:</span>number<span class="token operator">=</span><span class="token number">12</span><span class="token punctuation">;</span></span>
<span class="line">console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>myName<span class="token punctuation">,</span>age<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_1-8-3-rollup-config-js" tabindex="-1"><a class="header-anchor" href="#_1-8-3-rollup-config-js"><span>1.8.3 rollup.config.js</span></a></h4><p>rollup.config.js</p><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text"><pre><code class="language-text"><span class="line">import babel from &#39;rollup-plugin-babel&#39;;</span>
<span class="line">import resolve from &#39;@rollup/plugin-node-resolve&#39;;</span>
<span class="line">import commonjs from &#39;@rollup/plugin-commonjs&#39;;</span>
<span class="line">+import typescript from &#39;@rollup/plugin-typescript&#39;;</span>
<span class="line">export default {</span>
<span class="line">+   input:&#39;src/main.ts&#39;,</span>
<span class="line">    output:{</span>
<span class="line">        file:&#39;dist/bundle.cjs.js&#39;,//输出文件的路径和名称</span>
<span class="line">        format:&#39;iife&#39;,//五种输出格式：amd/es6/iife/umd/cjs</span>
<span class="line">        name:&#39;bundleName&#39;,//当format为iife和umd时必须提供，将作为全局变量挂在window下</span>
<span class="line">        globals:{</span>
<span class="line">            lodash:&#39;_&#39;, //告诉rollup全局变量_即是lodash</span>
<span class="line">            jquery:&#39;$&#39; //告诉rollup全局变量$即是jquery</span>
<span class="line">        }</span>
<span class="line">    },</span>
<span class="line">    plugins:[</span>
<span class="line">        babel({</span>
<span class="line">            exclude:&quot;node_modules/**&quot;</span>
<span class="line">        }),</span>
<span class="line">        resolve(),</span>
<span class="line">        commonjs(),</span>
<span class="line">+       typescript()</span>
<span class="line">    ],</span>
<span class="line">    external:[&#39;lodash&#39;,&#39;jquery&#39;]</span>
<span class="line">}</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_1-8-4-tsconfig-json" tabindex="-1"><a class="header-anchor" href="#_1-8-4-tsconfig-json"><span>1.8.4 tsconfig.json</span></a></h4><p>tsconfig.json</p><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code class="language-javascript"><span class="line"><span class="token punctuation">{</span></span>
<span class="line">  <span class="token string-property property">&quot;compilerOptions&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>  </span>
<span class="line">    <span class="token string-property property">&quot;target&quot;</span><span class="token operator">:</span> <span class="token string">&quot;es5&quot;</span><span class="token punctuation">,</span>                          </span>
<span class="line">    <span class="token string-property property">&quot;module&quot;</span><span class="token operator">:</span> <span class="token string">&quot;ESNext&quot;</span><span class="token punctuation">,</span>                     </span>
<span class="line">    <span class="token string-property property">&quot;strict&quot;</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>                         </span>
<span class="line">    <span class="token string-property property">&quot;skipLibCheck&quot;</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>                    </span>
<span class="line">    <span class="token string-property property">&quot;forceConsistentCasingInFileNames&quot;</span><span class="token operator">:</span> <span class="token boolean">true</span> </span>
<span class="line">  <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_1-9-压缩js" tabindex="-1"><a class="header-anchor" href="#_1-9-压缩js"><span>1.9 压缩JS</span></a></h3><ul><li>terser是支持ES6 +的JavaScript压缩器工具包</li></ul><h4 id="_1-9-1-安装" tabindex="-1"><a class="header-anchor" href="#_1-9-1-安装"><span>1.9.1 安装</span></a></h4><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text"><pre><code class="language-text"><span class="line">cnpm install rollup-plugin-terser --save-dev</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><h4 id="_1-9-2-rollup-config-js" tabindex="-1"><a class="header-anchor" href="#_1-9-2-rollup-config-js"><span>1.9.2 rollup.config.js</span></a></h4><p>rollup.config.js</p><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text"><pre><code class="language-text"><span class="line">import babel from &#39;rollup-plugin-babel&#39;;</span>
<span class="line">import resolve from &#39;@rollup/plugin-node-resolve&#39;;</span>
<span class="line">import commonjs from &#39;@rollup/plugin-commonjs&#39;;</span>
<span class="line">import typescript from &#39;@rollup/plugin-typescript&#39;;</span>
<span class="line">+import {terser} from &#39;rollup-plugin-terser&#39;;</span>
<span class="line">export default {</span>
<span class="line">    input:&#39;src/main.ts&#39;,</span>
<span class="line">    output:{</span>
<span class="line">        file:&#39;dist/bundle.cjs.js&#39;,//输出文件的路径和名称</span>
<span class="line">        format:&#39;iife&#39;,//五种输出格式：amd/es6/iife/umd/cjs</span>
<span class="line">        name:&#39;bundleName&#39;,//当format为iife和umd时必须提供，将作为全局变量挂在window下</span>
<span class="line">        globals:{</span>
<span class="line">            lodash:&#39;_&#39;, //告诉rollup全局变量_即是lodash</span>
<span class="line">            jquery:&#39;$&#39; //告诉rollup全局变量$即是jquery</span>
<span class="line">        }</span>
<span class="line">    },</span>
<span class="line">    plugins:[</span>
<span class="line">        babel({</span>
<span class="line">            exclude:&quot;node_modules/**&quot;</span>
<span class="line">        }),</span>
<span class="line">        resolve(),</span>
<span class="line">        commonjs(),</span>
<span class="line">        typescript(),</span>
<span class="line">+       terser(),</span>
<span class="line">    ],</span>
<span class="line">    external:[&#39;lodash&#39;,&#39;jquery&#39;]</span>
<span class="line">}</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_1-10-编译css" tabindex="-1"><a class="header-anchor" href="#_1-10-编译css"><span>1.10 编译css</span></a></h3><ul><li>terser是支持ES6 +的JavaScript压缩器工具包</li></ul><h4 id="_1-10-1-安装" tabindex="-1"><a class="header-anchor" href="#_1-10-1-安装"><span>1.10.1 安装</span></a></h4><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text"><pre><code class="language-text"><span class="line">cnpm install  postcss rollup-plugin-postcss --save-dev</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><h4 id="_1-10-2-rollup-config-js" tabindex="-1"><a class="header-anchor" href="#_1-10-2-rollup-config-js"><span>1.10.2 rollup.config.js</span></a></h4><p>rollup.config.js</p><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text"><pre><code class="language-text"><span class="line">import babel from &#39;rollup-plugin-babel&#39;;</span>
<span class="line">import resolve from &#39;@rollup/plugin-node-resolve&#39;;</span>
<span class="line">import commonjs from &#39;@rollup/plugin-commonjs&#39;;</span>
<span class="line">import typescript from &#39;@rollup/plugin-typescript&#39;;</span>
<span class="line">import {terser} from &#39;rollup-plugin-terser&#39;;</span>
<span class="line">+import postcss from &#39;rollup-plugin-postcss&#39;;</span>
<span class="line">export default {</span>
<span class="line">    input:&#39;src/main.js&#39;,</span>
<span class="line">    output:{</span>
<span class="line">        file:&#39;dist/bundle.cjs.js&#39;,//输出文件的路径和名称</span>
<span class="line">        format:&#39;iife&#39;,//五种输出格式：amd/es6/iife/umd/cjs</span>
<span class="line">        name:&#39;bundleName&#39;,//当format为iife和umd时必须提供，将作为全局变量挂在window下</span>
<span class="line">        globals:{</span>
<span class="line">            lodash:&#39;_&#39;, //告诉rollup全局变量_即是lodash</span>
<span class="line">            jquery:&#39;$&#39; //告诉rollup全局变量$即是jquery</span>
<span class="line">        }</span>
<span class="line">    },</span>
<span class="line">    plugins:[</span>
<span class="line">        babel({</span>
<span class="line">            exclude:&quot;node_modules/**&quot;</span>
<span class="line">        }),</span>
<span class="line">        resolve(),</span>
<span class="line">        commonjs(),</span>
<span class="line">        typescript(),</span>
<span class="line">        //terser(),</span>
<span class="line">+       postcss()</span>
<span class="line">    ],</span>
<span class="line">    external:[&#39;lodash&#39;,&#39;jquery&#39;]</span>
<span class="line">}</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_1-10-3-src-main-js" tabindex="-1"><a class="header-anchor" href="#_1-10-3-src-main-js"><span>1.10.3 src\\main.js</span></a></h4><p>src\\main.js</p><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code class="language-javascript"><span class="line"><span class="token keyword">import</span> <span class="token string">&#39;./main.css&#39;</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><h4 id="_1-10-4-src-main-css" tabindex="-1"><a class="header-anchor" href="#_1-10-4-src-main-css"><span>1.10.4 src\\main.css</span></a></h4><p>src\\main.css</p><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text"><pre><code class="language-text"><span class="line">body{</span>
<span class="line">    background-color: green;</span>
<span class="line">}</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_1-11-本地服务器" tabindex="-1"><a class="header-anchor" href="#_1-11-本地服务器"><span>1.11 本地服务器</span></a></h3><h4 id="_1-11-1-安装" tabindex="-1"><a class="header-anchor" href="#_1-11-1-安装"><span>1.11.1 安装</span></a></h4><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text"><pre><code class="language-text"><span class="line">cnpm install rollup-plugin-serve --save-dev</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><h4 id="_1-11-2-rollup-config-dev-js" tabindex="-1"><a class="header-anchor" href="#_1-11-2-rollup-config-dev-js"><span>1.11.2 rollup.config.dev.js</span></a></h4><p>rollup.config.dev.js</p><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text"><pre><code class="language-text"><span class="line">import babel from &#39;rollup-plugin-babel&#39;;</span>
<span class="line">import resolve from &#39;@rollup/plugin-node-resolve&#39;;</span>
<span class="line">import commonjs from &#39;@rollup/plugin-commonjs&#39;;</span>
<span class="line">import typescript from &#39;@rollup/plugin-typescript&#39;;</span>
<span class="line">import postcss from &#39;rollup-plugin-postcss&#39;;</span>
<span class="line">+import serve from &#39;rollup-plugin-serve&#39;;</span>
<span class="line">export default {</span>
<span class="line">    input:&#39;src/main.js&#39;,</span>
<span class="line">    output:{</span>
<span class="line">        file:&#39;dist/bundle.cjs.js&#39;,//输出文件的路径和名称</span>
<span class="line">        format:&#39;iife&#39;,//五种输出格式：amd/es6/iife/umd/cjs</span>
<span class="line">        name:&#39;bundleName&#39;,//当format为iife和umd时必须提供，将作为全局变量挂在window下</span>
<span class="line">        sourcemap:true,</span>
<span class="line">        globals:{</span>
<span class="line">            lodash:&#39;_&#39;, //告诉rollup全局变量_即是lodash</span>
<span class="line">            jquery:&#39;$&#39; //告诉rollup全局变量$即是jquery</span>
<span class="line">        }</span>
<span class="line">    },</span>
<span class="line">    plugins:[</span>
<span class="line">        babel({</span>
<span class="line">            exclude:&quot;node_modules/**&quot;</span>
<span class="line">        }),</span>
<span class="line">        resolve(),</span>
<span class="line">        commonjs(),</span>
<span class="line">        typescript(),</span>
<span class="line">        postcss(),</span>
<span class="line">+       serve({</span>
<span class="line">+           open:true,</span>
<span class="line">+           port:8080,</span>
<span class="line">+           contentBase:&#39;./dist&#39;</span>
<span class="line">+       })</span>
<span class="line">    ],</span>
<span class="line">    external:[&#39;lodash&#39;,&#39;jquery&#39;]</span>
<span class="line">}</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_1-11-3-package-json" tabindex="-1"><a class="header-anchor" href="#_1-11-3-package-json"><span>1.11.3 package.json</span></a></h4><p>package.json</p><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text"><pre><code class="language-text"><span class="line">{</span>
<span class="line">  &quot;scripts&quot;: {</span>
<span class="line">    &quot;build&quot;: &quot;rollup --config rollup.config.build.js&quot;,</span>
<span class="line">    &quot;dev&quot;: &quot;rollup --config rollup.config.dev.js -w&quot;</span>
<span class="line">  },</span>
<span class="line">}</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="_2-前置知识" tabindex="-1"><a class="header-anchor" href="#_2-前置知识"><span>2.前置知识</span></a></h2><h3 id="_2-1-初始化项目" tabindex="-1"><a class="header-anchor" href="#_2-1-初始化项目"><span>2.1. 初始化项目</span></a></h3><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text"><pre><code class="language-text"><span class="line">cnpm install magic-string acorn --save</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><h3 id="_2-2-magic-string" tabindex="-1"><a class="header-anchor" href="#_2-2-magic-string"><span>2.2. magic-string</span></a></h3><ul><li><a href="https://www.npmjs.com/package/magic-string" target="_blank" rel="noopener noreferrer">magic-string</a>是一个操作字符串和生成source-map的工具</li></ul><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code class="language-javascript"><span class="line"><span class="token keyword">var</span> MagicString <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&#39;magic-string&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">let</span> sourceCode <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">\`</span><span class="token string">export var name = &quot;zhufeng&quot;</span><span class="token template-punctuation string">\`</span></span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">let</span> ms <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MagicString</span><span class="token punctuation">(</span>sourceCode<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>ms<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token comment">//裁剪出原始字符串开始和结束之间所有的内容</span></span>
<span class="line"><span class="token comment">//返回一个克隆后的MagicString的实例</span></span>
<span class="line">console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>ms<span class="token punctuation">.</span><span class="token function">snip</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//sourceCode.slice(0,6);</span></span>
<span class="line"><span class="token comment">//删除0, 7之间的内容</span></span>
<span class="line">console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>ms<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//sourceCode.slice(7);</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">//还可以用用来合并代码 //TODO</span></span>
<span class="line"><span class="token keyword">let</span> bundle <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MagicString<span class="token punctuation">.</span>Bundle</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">bundle<span class="token punctuation">.</span><span class="token function">addSource</span><span class="token punctuation">(</span><span class="token punctuation">{</span></span>
<span class="line">  <span class="token literal-property property">content</span><span class="token operator">:</span> <span class="token string">&#39;var a = 1;&#39;</span><span class="token punctuation">,</span></span>
<span class="line">  <span class="token literal-property property">separator</span><span class="token operator">:</span> <span class="token string">&#39;\\n&#39;</span></span>
<span class="line"><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">bundle<span class="token punctuation">.</span><span class="token function">addSource</span><span class="token punctuation">(</span><span class="token punctuation">{</span></span>
<span class="line">  <span class="token literal-property property">content</span><span class="token operator">:</span> <span class="token string">&#39;var b = 2;&#39;</span><span class="token punctuation">,</span></span>
<span class="line">  <span class="token literal-property property">separator</span><span class="token operator">:</span> <span class="token string">&#39;\\n&#39;</span></span>
<span class="line"><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>bundle<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_2-3-ast" tabindex="-1"><a class="header-anchor" href="#_2-3-ast"><span>2.3. AST</span></a></h3><ul><li>通过<code>JavaScript Parser</code>可以把代码转化为一颗抽象语法树AST,这颗树定义了代码的结构，通过操纵这颗树，我们可以精准的定位到声明语句、赋值语句、运算语句等等，实现对代码的分析、优化、变更等操作</li></ul><p><img src="https://img.zhufengpeixun.com/868f60df0f5227621151031e261678a9" alt="868f60df0f5227621151031e261678a9"></p><h4 id="_2-3-1-ast工作流" tabindex="-1"><a class="header-anchor" href="#_2-3-1-ast工作流"><span>2.3.1 AST工作流</span></a></h4><ul><li>Parse(解析) 将源代码转换成抽象语法树，树上有很多的estree节点</li><li>Transform(转换) 对抽象语法树进行转换</li><li>Generate(代码生成) 将上一步经过转换过的抽象语法树生成新的代码</li></ul><p><img src="https://img.zhufengpeixun.com/1d821a22ff221e924731a6d8c8a654c4" alt="1d821a22ff221e924731a6d8c8a654c4"></p><h4 id="_2-3-2-acorn" tabindex="-1"><a class="header-anchor" href="#_2-3-2-acorn"><span>2.3.2 acorn</span></a></h4><ul><li><a href="https://astexplorer.net/" target="_blank" rel="noopener noreferrer">astexplorer</a>可以把代码转成语法树</li><li>acorn 解析结果符合<code>The Estree Spec</code>规范</li></ul><p><img src="https://img.zhufengpeixun.com/d434186f338a42917a8ef3835df3a28f" alt="d434186f338a42917a8ef3835df3a28f"></p><h5 id="_2-3-2-1-walk-js" tabindex="-1"><a class="header-anchor" href="#_2-3-2-1-walk-js"><span>2.3.2.1 walk.js</span></a></h5><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code class="language-javascript"><span class="line"><span class="token keyword">function</span> <span class="token function">walk</span><span class="token punctuation">(</span><span class="token parameter">astNode<span class="token punctuation">,</span> <span class="token punctuation">{</span> enter<span class="token punctuation">,</span> leave <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">  <span class="token function">visit</span><span class="token punctuation">(</span>astNode<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> enter<span class="token punctuation">,</span> leave<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"><span class="token keyword">function</span> <span class="token function">visit</span><span class="token punctuation">(</span><span class="token parameter">node<span class="token punctuation">,</span> parent<span class="token punctuation">,</span> enter<span class="token punctuation">,</span> leave</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">  <span class="token keyword">if</span> <span class="token punctuation">(</span>enter<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token function">enter</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> node<span class="token punctuation">,</span> parent<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">  <span class="token punctuation">}</span></span>
<span class="line">  <span class="token keyword">let</span> keys <span class="token operator">=</span> Object<span class="token punctuation">.</span><span class="token function">keys</span><span class="token punctuation">(</span>node<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span><span class="token parameter">key</span> <span class="token operator">=&gt;</span> <span class="token keyword">typeof</span> node<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">===</span> <span class="token string">&#39;object&#39;</span><span class="token punctuation">)</span></span>
<span class="line">  keys<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">key</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">let</span> value <span class="token operator">=</span> node<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">if</span> <span class="token punctuation">(</span>Array<span class="token punctuation">.</span><span class="token function">isArray</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">      value<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">val</span> <span class="token operator">=&gt;</span> <span class="token function">visit</span><span class="token punctuation">(</span>val<span class="token punctuation">,</span> node<span class="token punctuation">,</span> enter<span class="token punctuation">,</span> leave<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>value <span class="token operator">&amp;&amp;</span> value<span class="token punctuation">.</span>type<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">      <span class="token function">visit</span><span class="token punctuation">(</span>value<span class="token punctuation">,</span> node<span class="token punctuation">,</span> enter<span class="token punctuation">,</span> leave<span class="token punctuation">)</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">  <span class="token keyword">if</span> <span class="token punctuation">(</span>leave<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token function">leave</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> node<span class="token punctuation">,</span> parent<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">  <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line">module<span class="token punctuation">.</span>exports <span class="token operator">=</span> walk<span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h5 id="_2-3-2-2-use-js" tabindex="-1"><a class="header-anchor" href="#_2-3-2-2-use-js"><span>2.3.2.2 use.js</span></a></h5><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code class="language-javascript"><span class="line"><span class="token keyword">const</span> acorn <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&#39;acorn&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">const</span> walk <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&#39;./walk&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">const</span> sourceCode <span class="token operator">=</span> <span class="token string">&#39;import $ from &quot;jquery&quot;&#39;</span></span>
<span class="line"><span class="token keyword">const</span> ast <span class="token operator">=</span> acorn<span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>sourceCode<span class="token punctuation">,</span> <span class="token punctuation">{</span></span>
<span class="line">  <span class="token literal-property property">locations</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token literal-property property">ranges</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token literal-property property">sourceType</span><span class="token operator">:</span> <span class="token string">&#39;module&#39;</span><span class="token punctuation">,</span> <span class="token literal-property property">ecmaVersion</span><span class="token operator">:</span> <span class="token number">8</span></span>
<span class="line"><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">let</span> indent <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">const</span> <span class="token function-variable function">padding</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token string">&#39; &#39;</span><span class="token punctuation">.</span><span class="token function">repeat</span><span class="token punctuation">(</span>indent<span class="token punctuation">)</span></span>
<span class="line">ast<span class="token punctuation">.</span>body<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">statement</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></span>
<span class="line">  <span class="token function">walk</span><span class="token punctuation">(</span>statement<span class="token punctuation">,</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token function">enter</span><span class="token punctuation">(</span><span class="token parameter">node</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">      <span class="token keyword">if</span> <span class="token punctuation">(</span>node<span class="token punctuation">.</span>type<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token function">padding</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> node<span class="token punctuation">.</span>type <span class="token operator">+</span> <span class="token string">&quot;进入&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        indent <span class="token operator">+=</span> <span class="token number">2</span><span class="token punctuation">;</span></span>
<span class="line">      <span class="token punctuation">}</span></span>
<span class="line">    <span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token function">leave</span><span class="token punctuation">(</span><span class="token parameter">node</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">      <span class="token keyword">if</span> <span class="token punctuation">(</span>node<span class="token punctuation">.</span>type<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        indent <span class="token operator">-=</span> <span class="token number">2</span><span class="token punctuation">;</span></span>
<span class="line">        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token function">padding</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> node<span class="token punctuation">.</span>type <span class="token operator">+</span> <span class="token string">&quot;离开&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">      <span class="token punctuation">}</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><img src="https://img.zhufengpeixun.com/d39f73349c0580b4bfe6aa106ef0b1ae" alt="d39f73349c0580b4bfe6aa106ef0b1ae"></p><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text"><pre><code class="language-text"><span class="line">ImportDeclaration进入</span>
<span class="line">  ImportDefaultSpecifier进入</span>
<span class="line">    Identifier进入</span>
<span class="line">    Identifier离开</span>
<span class="line">  ImportDefaultSpecifier离开</span>
<span class="line">  Literal进入</span>
<span class="line">  Literal离开</span>
<span class="line">ImportDeclaration离开</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_2-4-作用域" tabindex="-1"><a class="header-anchor" href="#_2-4-作用域"><span>2.4 作用域</span></a></h3><h4 id="_2-4-1-作用域" tabindex="-1"><a class="header-anchor" href="#_2-4-1-作用域"><span>2.4.1 作用域</span></a></h4><ul><li>在JS中，作用域是用来规定变量访问范围的规则<div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code class="language-javascript"><span class="line"><span class="token keyword">function</span> <span class="token function">one</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">  <span class="token keyword">var</span> a <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line">console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></li></ul><h4 id="_2-4-2-作用域链" tabindex="-1"><a class="header-anchor" href="#_2-4-2-作用域链"><span>2.4.2 作用域链</span></a></h4><ul><li>作用域链是由当前执行环境与上层执行环境的一系列变量对象组成的，它保证了当前执行环境对符合访问权限的变量和函数的有序访问</li></ul><h5 id="_2-4-2-1-scope-js" tabindex="-1"><a class="header-anchor" href="#_2-4-2-1-scope-js"><span>2.4.2.1 scope.js</span></a></h5><p>scope.js</p><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code class="language-javascript"><span class="line"></span>
<span class="line"><span class="token keyword">class</span> <span class="token class-name">Scope</span> <span class="token punctuation">{</span></span>
<span class="line">  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter">options <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token comment">//作用域的名称</span></span>
<span class="line">    <span class="token keyword">this</span><span class="token punctuation">.</span>name <span class="token operator">=</span> options<span class="token punctuation">.</span>name<span class="token punctuation">;</span></span>
<span class="line">    <span class="token comment">//父作用域</span></span>
<span class="line">    <span class="token keyword">this</span><span class="token punctuation">.</span>parent <span class="token operator">=</span> options<span class="token punctuation">.</span>parent<span class="token punctuation">;</span></span>
<span class="line">    <span class="token comment">//此作用域内定义的变量</span></span>
<span class="line">    <span class="token keyword">this</span><span class="token punctuation">.</span>names <span class="token operator">=</span> options<span class="token punctuation">.</span>names <span class="token operator">||</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span></span>
<span class="line">  <span class="token punctuation">}</span></span>
<span class="line">  <span class="token function">add</span><span class="token punctuation">(</span><span class="token parameter">name</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">this</span><span class="token punctuation">.</span>names<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">  <span class="token punctuation">}</span></span>
<span class="line">  <span class="token function">findDefiningScope</span><span class="token punctuation">(</span><span class="token parameter">name</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>names<span class="token punctuation">.</span><span class="token function">includes</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">      <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>parent<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">      <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>parent<span class="token punctuation">.</span><span class="token function">findDefiningScope</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span></span>
<span class="line">      <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">  <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line">module<span class="token punctuation">.</span>exports <span class="token operator">=</span> Scope<span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h5 id="_2-4-2-2-usescope-js" tabindex="-1"><a class="header-anchor" href="#_2-4-2-2-usescope-js"><span>2.4.2.2 useScope.js</span></a></h5><p>useScope.js</p><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code class="language-javascript"><span class="line"><span class="token keyword">var</span> a <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">function</span> <span class="token function">one</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">  <span class="token keyword">var</span> b <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span></span>
<span class="line">  <span class="token keyword">function</span> <span class="token function">two</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">var</span> c <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span></span>
<span class="line">     console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span> b<span class="token punctuation">,</span> c<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">  <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"><span class="token keyword">let</span> Scope <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&#39;./scope&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">let</span> globalScope <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Scope</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">&#39;global&#39;</span><span class="token punctuation">,</span> <span class="token literal-property property">names</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token literal-property property">parent</span><span class="token operator">:</span> <span class="token keyword">null</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">let</span> oneScope <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Scope</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">&#39;one&#39;</span><span class="token punctuation">,</span> <span class="token literal-property property">names</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">&#39;b&#39;</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token literal-property property">parent</span><span class="token operator">:</span> globalScope <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">let</span> twoScope <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Scope</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">&#39;two&#39;</span><span class="token punctuation">,</span> <span class="token literal-property property">names</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">&#39;c&#39;</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token literal-property property">parent</span><span class="token operator">:</span> oneScope <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span></span>
<span class="line">  threeScope<span class="token punctuation">.</span><span class="token function">findDefiningScope</span><span class="token punctuation">(</span><span class="token string">&#39;a&#39;</span><span class="token punctuation">)</span><span class="token punctuation">.</span>name<span class="token punctuation">,</span></span>
<span class="line">  threeScope<span class="token punctuation">.</span><span class="token function">findDefiningScope</span><span class="token punctuation">(</span><span class="token string">&#39;b&#39;</span><span class="token punctuation">)</span><span class="token punctuation">.</span>name<span class="token punctuation">,</span></span>
<span class="line">  threeScope<span class="token punctuation">.</span><span class="token function">findDefiningScope</span><span class="token punctuation">(</span><span class="token string">&#39;c&#39;</span><span class="token punctuation">)</span><span class="token punctuation">.</span>name</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="_3-实现rollup" tabindex="-1"><a class="header-anchor" href="#_3-实现rollup"><span>3. 实现rollup</span></a></h2><h3 id="_3-1-目录结构" tabindex="-1"><a class="header-anchor" href="#_3-1-目录结构"><span>3.1 目录结构</span></a></h3><ul><li><a href="https://gitee.com/zhufengpeixun/rollup" target="_blank" rel="noopener noreferrer">rollup代码仓库地址</a></li></ul><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code class="language-javascript"><span class="line"><span class="token punctuation">.</span></span>
<span class="line">├── <span class="token keyword">package</span><span class="token punctuation">.</span>json</span>
<span class="line">├── <span class="token constant">README</span><span class="token punctuation">.</span>md</span>
<span class="line">├── src</span>
<span class="line">    ├── ast</span>
<span class="line">    │   ├── analyse<span class="token punctuation">.</span>js <span class="token comment">//分析AST节点的作用域和依赖项</span></span>
<span class="line">    │   ├── Scope<span class="token punctuation">.</span>js <span class="token comment">//有些语句会创建新的作用域实例</span></span>
<span class="line">    │   └── walk<span class="token punctuation">.</span>js <span class="token comment">//提供了递归遍历AST语法树的功能</span></span>
<span class="line">    ├── Bundle<span class="token comment">//打包工具，在打包的时候会生成一个Bundle实例，并收集其它模块，最后把所有代码打包在一起输出</span></span>
<span class="line">    │   └── index<span class="token punctuation">.</span>js </span>
<span class="line">    ├── Module<span class="token comment">//每个文件都是一个模块</span></span>
<span class="line">    │   └── index<span class="token punctuation">.</span>js</span>
<span class="line">    ├── rollup<span class="token punctuation">.</span>js <span class="token comment">//打包的入口模块</span></span>
<span class="line">    └── utils</span>
<span class="line">        ├── map<span class="token operator">-</span>helpers<span class="token punctuation">.</span>js</span>
<span class="line">        ├── object<span class="token punctuation">.</span>js</span>
<span class="line">        └── promise<span class="token punctuation">.</span>js</span>
<span class="line"></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_3-2-src-main-js" tabindex="-1"><a class="header-anchor" href="#_3-2-src-main-js"><span>3.2 src\\main.js</span></a></h3><p>src\\main.js</p><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code class="language-javascript"><span class="line">console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&#39;hello&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><h3 id="_3-3-debugger-js" tabindex="-1"><a class="header-anchor" href="#_3-3-debugger-js"><span>3.3 debugger.js</span></a></h3><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code class="language-javascript"><span class="line"><span class="token keyword">const</span> path <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&#39;path&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">const</span> rollup <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&#39;./lib/rollup&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">let</span> entry <span class="token operator">=</span> path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">&#39;src/main.js&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token function">rollup</span><span class="token punctuation">(</span>entry<span class="token punctuation">,</span><span class="token string">&#39;bundle.js&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_3-4-rollup-js" tabindex="-1"><a class="header-anchor" href="#_3-4-rollup-js"><span>3.4 rollup.js</span></a></h3><p>lib\\rollup.js</p><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code class="language-javascript"><span class="line"><span class="token keyword">const</span> Bundle <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&#39;./bundle&#39;</span><span class="token punctuation">)</span></span>
<span class="line"><span class="token keyword">const</span> fs <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&#39;fs&#39;</span><span class="token punctuation">)</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">function</span> <span class="token function">rollup</span><span class="token punctuation">(</span><span class="token parameter">entry<span class="token punctuation">,</span> filename</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">const</span> bundle <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Bundle</span><span class="token punctuation">(</span><span class="token punctuation">{</span> entry <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    bundle<span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span>filename<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line">module<span class="token punctuation">.</span>exports <span class="token operator">=</span> rollup<span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_3-5-bundle-js" tabindex="-1"><a class="header-anchor" href="#_3-5-bundle-js"><span>3.5 bundle.js</span></a></h3><p>lib\\bundle.js</p><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code class="language-javascript"><span class="line"><span class="token keyword">let</span> fs <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&#39;fs&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">let</span> path <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&#39;path&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">let</span> Module <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&#39;./module&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">let</span> MagicString <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&#39;magic-string&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">class</span> <span class="token class-name">Bundle</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter">options</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token comment">//入口文件数据</span></span>
<span class="line">        <span class="token keyword">this</span><span class="token punctuation">.</span>entryPath <span class="token operator">=</span> path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>options<span class="token punctuation">.</span>entry<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">\\.js$</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">,</span> <span class="token string">&#39;&#39;</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&#39;.js&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">this</span><span class="token punctuation">.</span>modules <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span><span class="token comment">//存放所有的模块</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    <span class="token function">build</span><span class="token punctuation">(</span><span class="token parameter">filename</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">let</span> entryModule <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">fetchModule</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>entryPath<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">this</span><span class="token punctuation">.</span>statements <span class="token operator">=</span> entryModule<span class="token punctuation">.</span><span class="token function">expandAllStatements</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">const</span> <span class="token punctuation">{</span> code <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">generate</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        fs<span class="token punctuation">.</span><span class="token function">writeFileSync</span><span class="token punctuation">(</span>filename<span class="token punctuation">,</span> code<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    <span class="token function">fetchModule</span><span class="token punctuation">(</span><span class="token parameter">importee</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">let</span> route <span class="token operator">=</span> importee<span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">if</span> <span class="token punctuation">(</span>route<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token keyword">let</span> code <span class="token operator">=</span> fs<span class="token punctuation">.</span><span class="token function">readFileSync</span><span class="token punctuation">(</span>route<span class="token punctuation">,</span> <span class="token string">&#39;utf8&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">            <span class="token keyword">const</span> module <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Module</span><span class="token punctuation">(</span><span class="token punctuation">{</span></span>
<span class="line">                code<span class="token punctuation">,</span></span>
<span class="line">                <span class="token literal-property property">path</span><span class="token operator">:</span> importee<span class="token punctuation">,</span></span>
<span class="line">                <span class="token literal-property property">bundle</span><span class="token operator">:</span> <span class="token keyword">this</span></span>
<span class="line">            <span class="token punctuation">}</span><span class="token punctuation">)</span></span>
<span class="line">            <span class="token keyword">return</span> module<span class="token punctuation">;</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    <span class="token function">generate</span><span class="token punctuation">(</span><span class="token parameter">options</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">let</span> magicString <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MagicString<span class="token punctuation">.</span>Bundle</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">this</span><span class="token punctuation">.</span>statements<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">statement</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token keyword">const</span> source <span class="token operator">=</span> statement<span class="token punctuation">.</span>_source<span class="token punctuation">.</span><span class="token function">clone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">            magicString<span class="token punctuation">.</span><span class="token function">addSource</span><span class="token punctuation">(</span><span class="token punctuation">{</span></span>
<span class="line">                <span class="token literal-property property">content</span><span class="token operator">:</span> source<span class="token punctuation">,</span></span>
<span class="line">                <span class="token literal-property property">separator</span><span class="token operator">:</span> <span class="token string">&#39;\\n&#39;</span></span>
<span class="line">            <span class="token punctuation">}</span><span class="token punctuation">)</span></span>
<span class="line"></span>
<span class="line">        <span class="token punctuation">}</span><span class="token punctuation">)</span></span>
<span class="line">        <span class="token keyword">return</span> <span class="token punctuation">{</span> <span class="token literal-property property">code</span><span class="token operator">:</span> magicString<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">}</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line">module<span class="token punctuation">.</span>exports <span class="token operator">=</span> Bundle<span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_3-6-module-js" tabindex="-1"><a class="header-anchor" href="#_3-6-module-js"><span>3.6 module.js</span></a></h3><p>lib\\module.js</p><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code class="language-javascript"><span class="line"><span class="token keyword">const</span> MagicString <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&#39;magic-string&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">const</span> <span class="token punctuation">{</span> parse <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&#39;acorn&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">let</span> analyse <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&#39;./ast/analyse&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">class</span> <span class="token class-name">Module</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> code<span class="token punctuation">,</span> path<span class="token punctuation">,</span> bundle <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">this</span><span class="token punctuation">.</span>code <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MagicString</span><span class="token punctuation">(</span>code<span class="token punctuation">,</span> <span class="token punctuation">{</span> <span class="token literal-property property">filename</span><span class="token operator">:</span> path <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">this</span><span class="token punctuation">.</span>path <span class="token operator">=</span> path<span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">this</span><span class="token punctuation">.</span>bundle <span class="token operator">=</span> bundle<span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">this</span><span class="token punctuation">.</span>ast <span class="token operator">=</span> <span class="token function">parse</span><span class="token punctuation">(</span>code<span class="token punctuation">,</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token literal-property property">ecmaVersion</span><span class="token operator">:</span> <span class="token number">7</span><span class="token punctuation">,</span></span>
<span class="line">            <span class="token literal-property property">sourceType</span><span class="token operator">:</span> <span class="token string">&#39;module&#39;</span></span>
<span class="line">        <span class="token punctuation">}</span><span class="token punctuation">)</span></span>
<span class="line">        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">analyse</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    <span class="token function">analyse</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token function">analyse</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>ast<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>code<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    <span class="token function">expandAllStatements</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">let</span> allStatements <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">this</span><span class="token punctuation">.</span>ast<span class="token punctuation">.</span>body<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">statement</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token keyword">let</span> statements <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">expandStatement</span><span class="token punctuation">(</span>statement<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">            allStatements<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token operator">...</span>statements<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">return</span> allStatements<span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    <span class="token function">expandStatement</span><span class="token punctuation">(</span><span class="token parameter">statement</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        statement<span class="token punctuation">.</span>_included <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">let</span> result <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span></span>
<span class="line">        result<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>statement<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">return</span> result<span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line">module<span class="token punctuation">.</span>exports <span class="token operator">=</span> Module<span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_3-7-analyse-js" tabindex="-1"><a class="header-anchor" href="#_3-7-analyse-js"><span>3.7 analyse.js</span></a></h3><p>lib\\ast\\analyse.js</p><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code class="language-javascript"><span class="line"><span class="token keyword">function</span> <span class="token function">analyse</span><span class="token punctuation">(</span><span class="token parameter">ast<span class="token punctuation">,</span> magicString</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    ast<span class="token punctuation">.</span>body<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">statement</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></span>
<span class="line">        Object<span class="token punctuation">.</span><span class="token function">defineProperties</span><span class="token punctuation">(</span>statement<span class="token punctuation">,</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token literal-property property">_source</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token literal-property property">value</span><span class="token operator">:</span> magicString<span class="token punctuation">.</span><span class="token function">snip</span><span class="token punctuation">(</span>statement<span class="token punctuation">.</span>start<span class="token punctuation">,</span> statement<span class="token punctuation">.</span>end<span class="token punctuation">)</span> <span class="token punctuation">}</span></span>
<span class="line">        <span class="token punctuation">}</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line">module<span class="token punctuation">.</span>exports <span class="token operator">=</span> analyse<span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="_4-实现tree-shaking" tabindex="-1"><a class="header-anchor" href="#_4-实现tree-shaking"><span>4. 实现tree-shaking</span></a></h2><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code class="language-javascript"><span class="line"><span class="token comment">//本模块从哪个模块导入了什么变量，叫什么名字</span></span>
<span class="line"><span class="token keyword">this</span><span class="token punctuation">.</span>imports<span class="token punctuation">[</span>localName<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span> localName<span class="token punctuation">,</span> <span class="token literal-property property">importName</span><span class="token operator">:</span> <span class="token string">&#39;default&#39;</span><span class="token punctuation">,</span> source <span class="token punctuation">}</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token comment">//本模块导出了什么变量</span></span>
<span class="line"><span class="token keyword">this</span><span class="token punctuation">.</span>exports<span class="token punctuation">[</span>exportName<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span> node<span class="token punctuation">,</span> localName<span class="token punctuation">,</span> exportName<span class="token punctuation">,</span> <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token string">&#39;ExportSpecifier&#39;</span> <span class="token punctuation">}</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token comment">//本语句定义的变量</span></span>
<span class="line">statement<span class="token punctuation">.</span>_defines<span class="token punctuation">[</span>name<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token comment">//本模块定义了哪些变量</span></span>
<span class="line"><span class="token keyword">this</span><span class="token punctuation">.</span>definitions<span class="token punctuation">[</span>name<span class="token punctuation">]</span> <span class="token operator">=</span> statement<span class="token punctuation">;</span> <span class="token comment">//定义语句的变量</span></span>
<span class="line"><span class="token comment">//使用到的变量没有定义，就表示依赖的外部变量</span></span>
<span class="line">statement<span class="token punctuation">.</span>_dependsOn<span class="token punctuation">[</span>node<span class="token punctuation">.</span>name<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_4-1-msg-js" tabindex="-1"><a class="header-anchor" href="#_4-1-msg-js"><span>4.1 msg.js</span></a></h3><p>src\\msg.js</p><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code class="language-javascript"><span class="line"><span class="token keyword">export</span> <span class="token keyword">var</span> name <span class="token operator">=</span> <span class="token string">&#39;zhufeng&#39;</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">export</span> <span class="token keyword">var</span> age <span class="token operator">=</span> <span class="token number">12</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div></div></div><p><img src="https://img.zhufengpeixun.com/4324fd261744db779245477d4cc336a6" alt="4324fd261744db779245477d4cc336a6"></p><h3 id="_4-2-src-main-js" tabindex="-1"><a class="header-anchor" href="#_4-2-src-main-js"><span>4.2 src\\main.js</span></a></h3><p>src\\main.js</p><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code class="language-javascript"><span class="line"><span class="token keyword">import</span> <span class="token punctuation">{</span>name<span class="token punctuation">,</span>age<span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&#39;./msg&#39;</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">function</span> <span class="token function">say</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line">    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&#39;hello&#39;</span><span class="token punctuation">,</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"><span class="token function">say</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><img src="https://img.zhufengpeixun.com/d6bcbc174f98e9aa834ea48397efb177" alt="d6bcbc174f98e9aa834ea48397efb177"></p><h3 id="_4-3-bundle-js" tabindex="-1"><a class="header-anchor" href="#_4-3-bundle-js"><span>4.3 bundle.js</span></a></h3><p>lib\\bundle.js</p><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text"><pre><code class="language-text"><span class="line"></span>
<span class="line">const path = require(&#39;path&#39;);</span>
<span class="line">const fs = require(&#39;fs&#39;);</span>
<span class="line">const MagicString = require(&#39;magic-string&#39;);</span>
<span class="line">const Module = require(&#39;./module&#39;);</span>
<span class="line">class Bundle {</span>
<span class="line">  constructor(options) {</span>
<span class="line">    //入口文件的绝对路径</span>
<span class="line">    this.entryPath = path.resolve(options.entry);</span>
<span class="line">  }</span>
<span class="line">  build(filename) {</span>
<span class="line">    let entryModule = this.fetchModule(this.entryPath);</span>
<span class="line">    this.statements = entryModule.expandAllStatements();//this.ast.body</span>
<span class="line">    const { code } = this.generate();</span>
<span class="line">    fs.writeFileSync(filename, code);</span>
<span class="line">  }</span>
<span class="line">  //根据模块的路径，返回模块对象</span>
<span class="line">  fetchModule(importee, importer) {//importee=./msg.js</span>
<span class="line">+   let route;</span>
<span class="line">+   if (!importer) {//如果无人导入，说明是入口模块</span>
<span class="line">+     route = importee;</span>
<span class="line">+   } else {</span>
<span class="line">+     if (path.isAbsolute(importee)) {</span>
<span class="line">+       route = importee;</span>
<span class="line">+     } else {</span>
<span class="line">+       route = path.resolve(path.dirname(importer), importee.replace(/\\.js$/, &#39;&#39;) + &#39;.js&#39;)</span>
<span class="line">+     }</span>
<span class="line">+   }</span>
<span class="line">    if (route) {</span>
<span class="line">      let code = fs.readFileSync(route, &#39;utf8&#39;);</span>
<span class="line">      let module = new Module({</span>
<span class="line">        path: route,//模块的绝对路径</span>
<span class="line">        code,//模块内容</span>
<span class="line">        bundle: this//它所属的bundle的实例</span>
<span class="line">      })</span>
<span class="line">      return module;</span>
<span class="line">    }</span>
<span class="line">  }</span>
<span class="line">  generate() {</span>
<span class="line">    let bundle = new MagicString.Bundle();</span>
<span class="line">    this.statements.forEach(statement =&gt; {</span>
<span class="line">      const source = statement._source.clone();</span>
<span class="line">+     if (statement.type === &#39;ExportNamedDeclaration&#39;) {</span>
<span class="line">+       source.remove(statement.start, statement.declaration.start);</span>
<span class="line">+     }</span>
<span class="line">      bundle.addSource({</span>
<span class="line">        content: source,</span>
<span class="line">        separator: &#39;\\n&#39;</span>
<span class="line">      });</span>
<span class="line">    });</span>
<span class="line">    return { code: bundle.toString() };</span>
<span class="line">  }</span>
<span class="line">}</span>
<span class="line">module.exports = Bundle;</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_4-4-scope-js" tabindex="-1"><a class="header-anchor" href="#_4-4-scope-js"><span>4.4 scope.js</span></a></h3><p>lib\\ast\\scope.js</p><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code class="language-javascript"><span class="line"></span>
<span class="line"><span class="token keyword">class</span> <span class="token class-name">Scope</span> <span class="token punctuation">{</span></span>
<span class="line">  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter">options <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token comment">//作用域的名称</span></span>
<span class="line">    <span class="token keyword">this</span><span class="token punctuation">.</span>name <span class="token operator">=</span> options<span class="token punctuation">.</span>name<span class="token punctuation">;</span></span>
<span class="line">    <span class="token comment">//父作用域</span></span>
<span class="line">    <span class="token keyword">this</span><span class="token punctuation">.</span>parent <span class="token operator">=</span> options<span class="token punctuation">.</span>parent<span class="token punctuation">;</span></span>
<span class="line">    <span class="token comment">//此作用域内定义的变量</span></span>
<span class="line">    <span class="token keyword">this</span><span class="token punctuation">.</span>names <span class="token operator">=</span> options<span class="token punctuation">.</span>names <span class="token operator">||</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span></span>
<span class="line">  <span class="token punctuation">}</span></span>
<span class="line">  <span class="token function">add</span><span class="token punctuation">(</span><span class="token parameter">name</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">this</span><span class="token punctuation">.</span>names<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">  <span class="token punctuation">}</span></span>
<span class="line">  <span class="token function">findDefiningScope</span><span class="token punctuation">(</span><span class="token parameter">name</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>names<span class="token punctuation">.</span><span class="token function">includes</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">      <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>parent<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">      <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>parent<span class="token punctuation">.</span><span class="token function">findDefiningScope</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span></span>
<span class="line">      <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">  <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line">module<span class="token punctuation">.</span>exports <span class="token operator">=</span> Scope<span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_4-5-utils-js" tabindex="-1"><a class="header-anchor" href="#_4-5-utils-js"><span>4.5 utils.js</span></a></h3><p>lib\\utils.js</p><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code class="language-javascript"><span class="line"><span class="token keyword">function</span> <span class="token function">hasOwnProperty</span><span class="token punctuation">(</span><span class="token parameter">obj<span class="token punctuation">,</span> prop</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">  <span class="token keyword">return</span> <span class="token class-name">Object</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function">hasOwnProperty</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>obj<span class="token punctuation">,</span> prop<span class="token punctuation">)</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line">exports<span class="token punctuation">.</span>hasOwnProperty <span class="token operator">=</span> hasOwnProperty<span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_4-5-module-js" tabindex="-1"><a class="header-anchor" href="#_4-5-module-js"><span>4.5 module.js</span></a></h3><p>lib\\module.js</p><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text"><pre><code class="language-text"><span class="line"></span>
<span class="line">const MagicString = require(&#39;magic-string&#39;);</span>
<span class="line">const acorn = require(&#39;acorn&#39;);</span>
<span class="line">const analyse = require(&#39;./ast/analyse&#39;);</span>
<span class="line">const { hasOwnProperty } = require(&#39;./utils&#39;);</span>
<span class="line">class Module {</span>
<span class="line">  constructor({ path, code, bundle }) {</span>
<span class="line">    this.code = new MagicString(code, {</span>
<span class="line">      filename: path</span>
<span class="line">    })</span>
<span class="line">    this.path = path;</span>
<span class="line">    this.bundle = bundle;</span>
<span class="line">    //把源代码转成一个语法树</span>
<span class="line">    this.ast = acorn.parse(code, {</span>
<span class="line">      ecmaVersion: 8,</span>
<span class="line">      sourceType: &#39;module&#39;</span>
<span class="line">    });</span>
<span class="line">+   //存放本模块的导入信息</span>
<span class="line">+   this.imports = {};</span>
<span class="line">+   //本模块的导出信息</span>
<span class="line">+   this.exports = {};</span>
<span class="line">+   //存放本模块的定义变量的语句 a=&gt;var a = 1;b =var b =2;</span>
<span class="line">+   this.definitions = {};</span>
<span class="line">    //开始进行语法树的解析</span>
<span class="line">    this.analyse();</span>
<span class="line">  }</span>
<span class="line">  analyse() {</span>
<span class="line">+   this.ast.body.forEach(statement =&gt; {</span>
<span class="line">+     //给this.imports赋值 分析 导入</span>
<span class="line">+     if (statement.type === &#39;ImportDeclaration&#39;) {//main.js</span>
<span class="line">+       let source = statement.source.value;//&quot;./msg&quot;</span>
<span class="line">+       statement.specifiers.forEach(specifier =&gt; {</span>
<span class="line">+         let importName = specifier.imported.name;//name 外部msg模块导出的名称 name</span>
<span class="line">+         let localName = specifier.local.name;//n 导入到本模块后，本地变量的名字 n</span>
<span class="line">+         this.imports[localName] = { importName, source };</span>
<span class="line">+       });</span>
<span class="line">+       //给this.exports赋值，分析导出</span>
<span class="line">+     } else if (statement.type === &#39;ExportNamedDeclaration&#39;) {//msg.js</span>
<span class="line">+       let declaration = statement.declaration;</span>
<span class="line">+       if (declaration.type === &#39;VariableDeclaration&#39;) {</span>
<span class="line">+         const declarations = declaration.declarations;</span>
<span class="line">+         declarations.forEach((variableDeclarator) =&gt; {</span>
<span class="line">+           let localName = variableDeclarator.id.name;//name</span>
<span class="line">+           this.exports[localName] = { exportName: localName }</span>
<span class="line">+         });</span>
<span class="line">+       }</span>
<span class="line">+     }</span>
<span class="line">+   });</span>
<span class="line">    analyse(this.ast, this.code, this);</span>
<span class="line">  }</span>
<span class="line">  expandAllStatements() {</span>
<span class="line">    let allStatements = [];</span>
<span class="line">    this.ast.body.forEach(statement =&gt; {</span>
<span class="line">+     if (statement.type === &#39;ImportDeclaration&#39;) return;</span>
<span class="line">      let statements = this.expandStatement(statement);</span>
<span class="line">      allStatements.push(...statements);</span>
<span class="line">    });</span>
<span class="line">    return allStatements;</span>
<span class="line">  }</span>
<span class="line">  expandStatement(statement) {</span>
<span class="line">    //为了避免语句被 重复添加，所以给每个语句放置一个变量，表示是否已经添加到结果 里了</span>
<span class="line">    statement._included = true;</span>
<span class="line">    let result = [];</span>
<span class="line">    //获取此语句依赖的变量</span>
<span class="line">    let dependencies = Object.keys(statement._dependsOn);</span>
<span class="line">    dependencies.forEach(name =&gt; {</span>
<span class="line">      //找到此变量定义的语句，添加到输出数组里</span>
<span class="line">      let definitions = this.define(name);</span>
<span class="line">      result.push(...definitions);</span>
<span class="line">    });</span>
<span class="line">    result.push(statement);</span>
<span class="line">    return result;</span>
<span class="line">  }</span>
<span class="line">+ define(name) {//name</span>
<span class="line">+   //说明是导入的</span>
<span class="line">+   if (hasOwnProperty(this.imports, name)) {</span>
<span class="line">+     //this.imports[localName]= {localName,importName,source};</span>
<span class="line">+     const { importName, source } = this.imports[name];</span>
<span class="line">+     let importModule = this.bundle.fetchModule(source, this.path);//msg.js</span>
<span class="line">+     // this.exports[localName] = {localName, exportName: localName, declaration}</span>
<span class="line">+     let { exportName } = importModule.exports[importName];//name</span>
<span class="line">+     return importModule.define(exportName);//msgModule.define(name);</span>
<span class="line">+   } else {//模块内声明的</span>
<span class="line">+     let statement = this.definitions[name];</span>
<span class="line">+     if (statement &amp;&amp; !statement._included) {</span>
<span class="line">+       return this.expandStatement(statement);</span>
<span class="line">+     } else {</span>
<span class="line">+       return []</span>
<span class="line">+     }</span>
<span class="line">+   }</span>
<span class="line">+ }</span>
<span class="line">}</span>
<span class="line">module.exports = Module;</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_4-6-walk-js" tabindex="-1"><a class="header-anchor" href="#_4-6-walk-js"><span>4.6 walk.js</span></a></h3><p>lib\\ast\\walk.js</p><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code class="language-javascript"><span class="line"></span>
<span class="line"></span>
<span class="line"><span class="token keyword">function</span> <span class="token function">walk</span><span class="token punctuation">(</span><span class="token parameter">astNode<span class="token punctuation">,</span> <span class="token punctuation">{</span> enter<span class="token punctuation">,</span> leave <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">  <span class="token function">visit</span><span class="token punctuation">(</span>astNode<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> enter<span class="token punctuation">,</span> leave<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"><span class="token keyword">function</span> <span class="token function">visit</span><span class="token punctuation">(</span><span class="token parameter">node<span class="token punctuation">,</span> parent<span class="token punctuation">,</span> enter<span class="token punctuation">,</span> leave</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">  <span class="token keyword">if</span> <span class="token punctuation">(</span>enter<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token function">enter</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> node<span class="token punctuation">,</span> parent<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">  <span class="token punctuation">}</span></span>
<span class="line">  <span class="token keyword">let</span> keys <span class="token operator">=</span> Object<span class="token punctuation">.</span><span class="token function">keys</span><span class="token punctuation">(</span>node<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span><span class="token parameter">key</span> <span class="token operator">=&gt;</span> <span class="token keyword">typeof</span> node<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">===</span> <span class="token string">&#39;object&#39;</span><span class="token punctuation">)</span></span>
<span class="line">  keys<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">key</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">let</span> value <span class="token operator">=</span> node<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">if</span> <span class="token punctuation">(</span>Array<span class="token punctuation">.</span><span class="token function">isArray</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">      value<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">val</span> <span class="token operator">=&gt;</span> <span class="token function">visit</span><span class="token punctuation">(</span>val<span class="token punctuation">,</span> node<span class="token punctuation">,</span> enter<span class="token punctuation">,</span> leave<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>value <span class="token operator">&amp;&amp;</span> value<span class="token punctuation">.</span>type<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">      <span class="token function">visit</span><span class="token punctuation">(</span>value<span class="token punctuation">,</span> node<span class="token punctuation">,</span> enter<span class="token punctuation">,</span> leave<span class="token punctuation">)</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">  <span class="token keyword">if</span> <span class="token punctuation">(</span>leave<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token function">leave</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> node<span class="token punctuation">,</span> parent<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">  <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line">module<span class="token punctuation">.</span>exports <span class="token operator">=</span> walk<span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_4-7-analyse-js" tabindex="-1"><a class="header-anchor" href="#_4-7-analyse-js"><span>4.7 analyse.js</span></a></h3><p>lib\\ast\\analyse.js</p><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text"><pre><code class="language-text"><span class="line">+const Scope = require(&#39;./scope&#39;);</span>
<span class="line">+const walk = require(&#39;./walk&#39;);</span>
<span class="line">+const { hasOwnProperty } = require(&#39;../utils&#39;);</span>
<span class="line">function analyse(ast, code, module) {</span>
<span class="line">+ //处理作用域 构建作用域链 其实就是模块内的顶级作用域 </span>
<span class="line">+ let currentScope = new Scope({ name: &#39;全局作用域&#39; });</span>
<span class="line">+ ast.body.forEach(statement =&gt; {</span>
<span class="line">+   function addToScope(name) {</span>
<span class="line">+     currentScope.add(name);</span>
<span class="line">+     //如果说当前的作用域没有父亲 了，说明它是顶级作用域，说明name是顶级作用域中定义的变量 类似模块内的全局变量</span>
<span class="line">+     if (!currentScope.parent || currentScope.isBlockScope) {</span>
<span class="line">+       //此语句上定义了哪些变量</span>
<span class="line">+       statement._defines[name] = true</span>
<span class="line">+     }</span>
<span class="line">+   }</span>
<span class="line">+   //给statement语法树节点，定义属性_source=console.log(&#39;hello&#39;);</span>
<span class="line">+   Object.defineProperties(statement, {</span>
<span class="line">+     _source: { value: code.snip(statement.start, statement.end) },</span>
<span class="line">+     _defines: { value: {} },</span>
<span class="line">+     _included: { value: false, writable: true },</span>
<span class="line">+     _dependsOn: { value: {} }</span>
<span class="line">+   });</span>
<span class="line"></span>
<span class="line">+   walk(statement, {</span>
<span class="line">+     enter(node) {</span>
<span class="line">+       //当前节点的新的作用域</span>
<span class="line">+       let newScope;</span>
<span class="line">+       switch (node.type) {</span>
<span class="line">+         case &#39;FunctionDeclaration&#39;:</span>
<span class="line">+           //函数的名字添加到当前作用域中</span>
<span class="line">+           addToScope(node.id.name);</span>
<span class="line">+           //函数的参数添加到新作用域</span>
<span class="line">+           const names = node.params.map(param =&gt; param.name);</span>
<span class="line">+           newScope = new Scope({ name: node.id.name, parent: currentScope, names })</span>
<span class="line">+           break;</span>
<span class="line">+         case &#39;VariableDeclaration&#39;:</span>
<span class="line">+           node.declarations.forEach(declaration =&gt; {</span>
<span class="line">+             addToScope(declaration.id.name);</span>
<span class="line">+           });</span>
<span class="line">+           break;</span>
<span class="line">+         default:</span>
<span class="line">+           break;</span>
<span class="line">+       }</span>
<span class="line">+       if (newScope) {</span>
<span class="line">+         //此节点上创建了新的作用域</span>
<span class="line">+         Object.defineProperty(statement, &#39;_scope&#39;, { value: newScope });</span>
<span class="line">+         currentScope = newScope;</span>
<span class="line">+       }</span>
<span class="line">+     },</span>
<span class="line">+     leave(node) {</span>
<span class="line">+       if (hasOwnProperty(node, &#39;_scope&#39;)) {</span>
<span class="line">+         currentScope = currentScope.parent;</span>
<span class="line">+       }</span>
<span class="line">+     }</span>
<span class="line">+   });</span>
<span class="line">+ });</span>
<span class="line">+ //第二次循环</span>
<span class="line">+ ast.body.forEach(statement =&gt; {</span>
<span class="line">+   walk(statement, {</span>
<span class="line">+     enter(node) {</span>
<span class="line">+       if (node.type === &#39;Identifier&#39;) {</span>
<span class="line">+         statement._dependsOn[node.name] = true;</span>
<span class="line">+       }</span>
<span class="line">+     }</span>
<span class="line">+   });</span>
<span class="line">+ });</span>
<span class="line">+ ast.body.forEach(statement =&gt; {</span>
<span class="line">+   //获取每个语句定义的变量</span>
<span class="line">+   Object.keys(statement._defines).forEach(name =&gt; {</span>
<span class="line">+     //记录模块内定义的变量，key是变量名，值是定义变量的语句</span>
<span class="line">+     module.definitions[name] = statement;</span>
<span class="line">+   });</span>
<span class="line">+ });</span>
<span class="line">}</span>
<span class="line">module.exports = analyse;</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="_5-包含修改语句" tabindex="-1"><a class="header-anchor" href="#_5-包含修改语句"><span>5. 包含修改语句</span></a></h2><h3 id="_5-1-src-index-js" tabindex="-1"><a class="header-anchor" href="#_5-1-src-index-js"><span>5.1 src\\index.js</span></a></h3><p>src\\index.js</p><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code class="language-javascript"><span class="line"><span class="token keyword">import</span> <span class="token punctuation">{</span>name<span class="token punctuation">,</span>age<span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&#39;./msg&#39;</span><span class="token punctuation">;</span></span>
<span class="line">console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_5-2-msg-js" tabindex="-1"><a class="header-anchor" href="#_5-2-msg-js"><span>5.2 msg.js</span></a></h3><p>src\\msg.js</p><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text"><pre><code class="language-text"><span class="line">export var name = &#39;zhufeng&#39;;</span>
<span class="line">+name += &#39;jiagou&#39;;</span>
<span class="line">export var age = 12;</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_5-3-lib-module-js" tabindex="-1"><a class="header-anchor" href="#_5-3-lib-module-js"><span>5.3 lib\\module.js</span></a></h3><p>lib\\module.js</p><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code class="language-javascript"><span class="line"></span>
<span class="line"><span class="token keyword">const</span> MagicString <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&#39;magic-string&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">const</span> <span class="token punctuation">{</span> parse <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&#39;acorn&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">const</span> analyse <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&#39;./ast/analyse&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">const</span> <span class="token punctuation">{</span> hasOwnProperty <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&#39;./utils&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">class</span> <span class="token class-name">Module</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> code<span class="token punctuation">,</span> path<span class="token punctuation">,</span> bundle <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">this</span><span class="token punctuation">.</span>code <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MagicString</span><span class="token punctuation">(</span>code<span class="token punctuation">,</span> <span class="token punctuation">{</span> <span class="token literal-property property">filename</span><span class="token operator">:</span> path <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">this</span><span class="token punctuation">.</span>path <span class="token operator">=</span> path<span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">this</span><span class="token punctuation">.</span>bundle <span class="token operator">=</span> bundle<span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">this</span><span class="token punctuation">.</span>ast <span class="token operator">=</span> <span class="token function">parse</span><span class="token punctuation">(</span>code<span class="token punctuation">,</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token literal-property property">ecmaVersion</span><span class="token operator">:</span> <span class="token number">8</span><span class="token punctuation">,</span></span>
<span class="line">            <span class="token literal-property property">sourceType</span><span class="token operator">:</span> <span class="token string">&#39;module&#39;</span></span>
<span class="line">        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">this</span><span class="token punctuation">.</span>imports <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span><span class="token comment">//导入</span></span>
<span class="line">        <span class="token keyword">this</span><span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span><span class="token comment">//导出</span></span>
<span class="line">        <span class="token keyword">this</span><span class="token punctuation">.</span>definitions <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span><span class="token comment">//此变量存放所有的变量定义的语句</span></span>
<span class="line"><span class="token operator">+</span>       <span class="token keyword">this</span><span class="token punctuation">.</span>modifications <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">analyse</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    <span class="token function">analyse</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">this</span><span class="token punctuation">.</span>ast<span class="token punctuation">.</span>body<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">statement</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token comment">//1.给import赋值 </span></span>
<span class="line">            <span class="token keyword">if</span> <span class="token punctuation">(</span>statement<span class="token punctuation">.</span>type <span class="token operator">===</span> <span class="token string">&#39;ImportDeclaration&#39;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">                <span class="token keyword">let</span> source <span class="token operator">=</span> statement<span class="token punctuation">.</span>source<span class="token punctuation">.</span>value<span class="token punctuation">;</span><span class="token comment">//./msg</span></span>
<span class="line">                statement<span class="token punctuation">.</span>specifiers<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">specifier</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></span>
<span class="line">                    <span class="token keyword">let</span> importName <span class="token operator">=</span> specifier<span class="token punctuation">.</span>imported<span class="token punctuation">.</span>name<span class="token punctuation">;</span><span class="token comment">//age</span></span>
<span class="line">                    <span class="token keyword">let</span> localName <span class="token operator">=</span> specifier<span class="token punctuation">.</span>local<span class="token punctuation">.</span>name<span class="token punctuation">;</span><span class="token comment">//age</span></span>
<span class="line">                    <span class="token comment">//记录一下当前的这个引入的变量是从哪个模块的哪个变量导入进来的</span></span>
<span class="line">                    <span class="token keyword">this</span><span class="token punctuation">.</span>imports<span class="token punctuation">[</span>localName<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span> localName<span class="token punctuation">,</span> source<span class="token punctuation">,</span> importName <span class="token punctuation">}</span><span class="token punctuation">;</span></span>
<span class="line">                <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">                <span class="token comment">//2.this.exports赋值</span></span>
<span class="line">            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>statement<span class="token punctuation">.</span>type <span class="token operator">===</span> <span class="token string">&#39;ExportNamedDeclaration&#39;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">                <span class="token keyword">let</span> declaration <span class="token operator">=</span> statement<span class="token punctuation">.</span>declaration<span class="token punctuation">;</span></span>
<span class="line">                <span class="token keyword">if</span> <span class="token punctuation">(</span>declaration<span class="token punctuation">.</span>type <span class="token operator">===</span> <span class="token string">&#39;VariableDeclaration&#39;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">                    <span class="token keyword">const</span> declarations <span class="token operator">=</span> declaration<span class="token punctuation">.</span>declarations<span class="token punctuation">;</span></span>
<span class="line">                    declarations<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">variableDeclarator</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></span>
<span class="line">                        <span class="token keyword">let</span> localName <span class="token operator">=</span> variableDeclarator<span class="token punctuation">.</span>id<span class="token punctuation">.</span>name<span class="token punctuation">;</span></span>
<span class="line">                        <span class="token comment">//this.exports.age = {localName:&#39;age&#39;,exportName:&#39;age&#39;,expression:};</span></span>
<span class="line">                        <span class="token keyword">this</span><span class="token punctuation">.</span>exports<span class="token punctuation">[</span>localName<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span> localName<span class="token punctuation">,</span> <span class="token literal-property property">exportName</span><span class="token operator">:</span> localName<span class="token punctuation">,</span> <span class="token literal-property property">expression</span><span class="token operator">:</span> declaration <span class="token punctuation">}</span><span class="token punctuation">;</span></span>
<span class="line">                    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">                <span class="token punctuation">}</span></span>
<span class="line">            <span class="token punctuation">}</span></span>
<span class="line">        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token comment">//1.构建了作用域 2.找到模块块依赖了哪些外部变量</span></span>
<span class="line">        <span class="token function">analyse</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>ast<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>code<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">this</span><span class="token punctuation">.</span>ast<span class="token punctuation">.</span>body<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">statement</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></span>
<span class="line">            Object<span class="token punctuation">.</span><span class="token function">keys</span><span class="token punctuation">(</span>statement<span class="token punctuation">.</span>_defines<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">name</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></span>
<span class="line">                <span class="token comment">//当前模块内 定义name这个变量的语句是statement</span></span>
<span class="line">                <span class="token comment">//main.js  type   let type = &#39;dog&#39;;</span></span>
<span class="line">                <span class="token keyword">this</span><span class="token punctuation">.</span>definitions<span class="token punctuation">[</span>name<span class="token punctuation">]</span> <span class="token operator">=</span> statement<span class="token punctuation">;</span></span>
<span class="line">            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token operator">+</span>           Object<span class="token punctuation">.</span><span class="token function">keys</span><span class="token punctuation">(</span>statement<span class="token punctuation">.</span>_modifies<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">name</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></span>
<span class="line"><span class="token operator">+</span>               <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">hasOwnProperty</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>modifications<span class="token punctuation">,</span> name<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line"><span class="token operator">+</span>                   <span class="token keyword">this</span><span class="token punctuation">.</span>modifications<span class="token punctuation">[</span>name<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token operator">+</span>               <span class="token punctuation">}</span></span>
<span class="line"><span class="token operator">+</span>               <span class="token keyword">this</span><span class="token punctuation">.</span>modifications<span class="token punctuation">[</span>name<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>statement<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token operator">+</span>           <span class="token punctuation">}</span><span class="token punctuation">)</span></span>
<span class="line"><span class="token operator">+</span>       <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    <span class="token function">expandAllStatements</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">let</span> allStatements <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">this</span><span class="token punctuation">.</span>ast<span class="token punctuation">.</span>body<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">statement</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token keyword">if</span> <span class="token punctuation">(</span>statement<span class="token punctuation">.</span>type <span class="token operator">===</span> <span class="token string">&#39;ImportDeclaration&#39;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token comment">//不再需要import语句</span></span>
<span class="line">                <span class="token keyword">return</span><span class="token punctuation">;</span></span>
<span class="line">            <span class="token punctuation">}</span></span>
<span class="line">            <span class="token keyword">let</span> statements <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">expandStatement</span><span class="token punctuation">(</span>statement<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">            <span class="token comment">//我们要把statement进行扩展，有可能一行变多行var name =&#39;zhufeng&#39;, console.log(&#39;name&#39;); TODO</span></span>
<span class="line">            allStatements<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token operator">...</span>statements<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">return</span> allStatements<span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    <span class="token comment">//展开单 条语句  console.log(name,age);</span></span>
<span class="line">    <span class="token function">expandStatement</span><span class="token punctuation">(</span><span class="token parameter">statement</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>statement<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        statement<span class="token punctuation">.</span>_included <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span><span class="token comment">// 把当前语句标记为包含</span></span>
<span class="line">        <span class="token keyword">let</span> result <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">const</span> dependencies <span class="token operator">=</span> Object<span class="token punctuation">.</span><span class="token function">keys</span><span class="token punctuation">(</span>statement<span class="token punctuation">.</span>_dependsOn<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        dependencies<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">name</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token comment">//获取依赖的变量对应的变量定义语句 name</span></span>
<span class="line">            <span class="token keyword">let</span> definition <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">define</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">            result<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token operator">...</span>definition<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        result<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>statement<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//再放进来当前的语句</span></span>
<span class="line"><span class="token operator">+</span>       <span class="token keyword">const</span> defines <span class="token operator">=</span> Object<span class="token punctuation">.</span><span class="token function">keys</span><span class="token punctuation">(</span>statement<span class="token punctuation">.</span>_defines<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token operator">+</span>       defines<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">name</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></span>
<span class="line"><span class="token operator">+</span>           <span class="token keyword">const</span> modifications <span class="token operator">=</span> <span class="token function">hasOwnProperty</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>modifications<span class="token punctuation">,</span> name<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token keyword">this</span><span class="token punctuation">.</span>modifications<span class="token punctuation">[</span>name<span class="token punctuation">]</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token operator">+</span>           <span class="token keyword">if</span> <span class="token punctuation">(</span>modifications<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line"><span class="token operator">+</span>               modifications<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">statement</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></span>
<span class="line"><span class="token operator">+</span>                   <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>statement<span class="token punctuation">.</span>_included<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line"><span class="token operator">+</span>                       <span class="token keyword">let</span> statements <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">expandStatement</span><span class="token punctuation">(</span>statement<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token operator">+</span>                       result<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token operator">...</span>statements<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token operator">+</span>                   <span class="token punctuation">}</span></span>
<span class="line"><span class="token operator">+</span>               <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token operator">+</span>           <span class="token punctuation">}</span></span>
<span class="line"><span class="token operator">+</span>       <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">return</span> result<span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    <span class="token function">define</span><span class="token punctuation">(</span><span class="token parameter">name</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token comment">//说明此变量是外部导入进来的</span></span>
<span class="line">        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">hasOwnProperty</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>imports<span class="token punctuation">,</span> name<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token comment">//this.imports[localName]={localName,source,importName};</span></span>
<span class="line">            <span class="token keyword">const</span> <span class="token punctuation">{</span> localName<span class="token punctuation">,</span> source<span class="token punctuation">,</span> importName <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>imports<span class="token punctuation">[</span>name<span class="token punctuation">]</span><span class="token punctuation">;</span></span>
<span class="line">            <span class="token comment">// source .msg</span></span>
<span class="line">            <span class="token keyword">let</span> importedModule <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>bundle<span class="token punctuation">.</span><span class="token function">fetchModule</span><span class="token punctuation">(</span>source<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>path<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">            <span class="token keyword">const</span> <span class="token punctuation">{</span> <span class="token literal-property property">localName</span><span class="token operator">:</span> exportLocalName <span class="token punctuation">}</span> <span class="token operator">=</span> importedModule<span class="token punctuation">.</span>exports<span class="token punctuation">[</span>importName<span class="token punctuation">]</span><span class="token punctuation">;</span></span>
<span class="line">            <span class="token comment">//this.exports.name = {localName:&#39;name&#39;,exportName:&#39;name&#39;,expression:};</span></span>
<span class="line">            <span class="token keyword">return</span> importedModule<span class="token punctuation">.</span><span class="token function">define</span><span class="token punctuation">(</span>exportLocalName<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span><span class="token comment">//说明是在当前模块内声明的</span></span>
<span class="line">            <span class="token keyword">let</span> statement <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>definitions<span class="token punctuation">[</span>name<span class="token punctuation">]</span><span class="token punctuation">;</span></span>
<span class="line">            <span class="token keyword">if</span> <span class="token punctuation">(</span>statement <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>statement<span class="token punctuation">.</span>_included<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">                <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">expandStatement</span><span class="token punctuation">(</span>statement<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span></span>
<span class="line">                <span class="token keyword">return</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span></span>
<span class="line">            <span class="token punctuation">}</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line">module<span class="token punctuation">.</span>exports <span class="token operator">=</span> Module<span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_5-4-analyse-js" tabindex="-1"><a class="header-anchor" href="#_5-4-analyse-js"><span>5.4 analyse.js</span></a></h3><p>lib\\ast\\analyse.js</p><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text"><pre><code class="language-text"><span class="line"></span>
<span class="line"></span>
<span class="line">let walk = require(&#39;./walk&#39;);</span>
<span class="line">let Scope = require(&#39;./scope&#39;);</span>
<span class="line">const {hasOwnProperty} = require(&#39;../utils&#39;);</span>
<span class="line">function analyse(ast, magicStringOfAst) {</span>
<span class="line">    //在遍历之前先创建作用域对象</span>
<span class="line">    let scope = new Scope({ name: &#39;全局作用域&#39; });</span>
<span class="line">    ast.body.forEach(statement =&gt; {</span>
<span class="line">        function addToScope(name) {</span>
<span class="line">            scope.add(name);</span>
<span class="line">            if (!scope.parent || currentScope.isBlockScope) {//如果此作用域 没有父作用域,那这就是顶级变量，根作用域下的变量，可以放在_defines=tree</span>
<span class="line">                //模块内的顶级变量</span>
<span class="line">                statement._defines[name] = true;</span>
<span class="line">            }</span>
<span class="line">        }</span>
<span class="line">        Object.defineProperties(statement, {</span>
<span class="line">+           _modifies:{ value: {} },//修改</span>
<span class="line">            _defines: { value: {} },//当前statement语法树节点声明了哪些变量</span>
<span class="line">            _dependsOn: { value: {} },//当前statement语句外部依赖的变量</span>
<span class="line">            _included: { value: false, writable: true },//当前的语句是否放置在结果中，是否会出现在打包结果中</span>
<span class="line">            _source: { value: magicStringOfAst.snip(statement.start, statement.end) }//key是_source 值是这个语法树节点在源码中的源代码</span>
<span class="line">        });</span>
<span class="line">        //如何知道某个变量有没有在当前模块内定义的呢？</span>
<span class="line">        //原理是这样 扫描整个模块，找到所有的定义的变量</span>
<span class="line">        //构建使用域链</span>
<span class="line">        walk(statement, {</span>
<span class="line">            enter(node) {</span>
<span class="line">                let newScope;</span>
<span class="line">                switch (node.type) {</span>
<span class="line">                    case &#39;FunctionDeclaration&#39;:</span>
<span class="line">                        //函数的参数将会成为此函数子作用域内的局部变量</span>
<span class="line">                        const names = node.params.map(param =&gt; param.name);</span>
<span class="line">                        addToScope(node.id.name);//把node也就是say这个变量添加到当前作用内 </span>
<span class="line">                        //如果遇到函数声明，就会产生一个新作用域</span>
<span class="line">                        newScope = new Scope({ name: node.id.name, parent: scope, params: names });</span>
<span class="line">                        break;</span>
<span class="line">                    case &#39;VariableDeclaration&#39;:</span>
<span class="line">                        node.declarations.forEach((declaration) =&gt; addToScope(declaration.id.name));</span>
<span class="line">                        break;</span>
<span class="line">                }</span>
<span class="line">                if (newScope) {//如果创建了新的作用域，那么这个作用域将会成为新的当前作用域</span>
<span class="line">                    Object.defineProperty(node, &#39;_scope&#39;, { value: newScope });</span>
<span class="line">                    scope = newScope;// say这个函数作用域</span>
<span class="line">                }</span>
<span class="line">            },</span>
<span class="line">            leave(node) {</span>
<span class="line">                //当离开节点的时候 ，如果发现这个节点创建 新的作用域，就回退到使用域</span>
<span class="line">                if (hasOwnProperty(node,&#39;_scope&#39;)) {</span>
<span class="line">                    scope = scope.parent;</span>
<span class="line">                }</span>
<span class="line">            }</span>
<span class="line">        });</span>
<span class="line"></span>
<span class="line">    });</span>
<span class="line">    //2.作用域链构建完成后，再遍历一次，找出本模块定义了依赖了哪些外部变量</span>
<span class="line">    ast.body.forEach(statement =&gt; {</span>
<span class="line">+        function checkForReads(node) {</span>
<span class="line">+            if (node.type === &#39;Identifier&#39; &amp;&amp; parent.type !== &#39;VariableDeclarator&#39;) {</span>
<span class="line">+                const definingScope = scope.findDefiningScope(node.name);</span>
<span class="line">+                if (!definingScope) {</span>
<span class="line">+                    statement._dependsOn[node.name] = true;//添加外部依赖</span>
<span class="line">+                }</span>
<span class="line">+            }</span>
<span class="line">+        }</span>
<span class="line">+        function checkForWrites(node) {</span>
<span class="line">+            function addNode(node) {</span>
<span class="line">+                while (node.type === &#39;MemberExpression&#39;) {</span>
<span class="line">+                    node = node.object;</span>
<span class="line">+                }</span>
<span class="line">+                if (node.type !== &#39;Identifier&#39;) {</span>
<span class="line">+                    return</span>
<span class="line">+                }</span>
<span class="line">+                statement._modifies[node.name] = true;</span>
<span class="line">+            }</span>
<span class="line">+            if (node.type === &#39;AssignmentExpression&#39;) {// name=&#39;jiagou&#39;</span>
<span class="line">+                addNode(node.left, true)</span>
<span class="line">+            } else if (node.type === &#39;UpdateExpression&#39;) {//name+=&#39;jiagou&#39;</span>
<span class="line">+                addNode(node.argument, true)</span>
<span class="line">+            }</span>
<span class="line">+        }</span>
<span class="line">+        walk(statement, {</span>
<span class="line">+            enter(node) {</span>
<span class="line">+                if (hasOwnProperty(node,&#39;_scope&#39;)) scope = node._scope;</span>
<span class="line">+                checkForReads(node)</span>
<span class="line">+                checkForWrites(node)</span>
<span class="line">+            },</span>
<span class="line">+            leave(node) {</span>
<span class="line">+                if (node._scope) scope = scope.parent</span>
<span class="line">+            }</span>
<span class="line">+        })</span>
<span class="line">    });</span>
<span class="line"></span>
<span class="line">}</span>
<span class="line">module.exports = analyse;</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="_6-支持块级作用域和入口treeshaking" tabindex="-1"><a class="header-anchor" href="#_6-支持块级作用域和入口treeshaking"><span>6. 支持块级作用域和入口treeshaking</span></a></h2><h3 id="_6-1-src-main-js" tabindex="-1"><a class="header-anchor" href="#_6-1-src-main-js"><span>6.1 src\\main.js</span></a></h3><p>src\\main.js</p><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code class="language-javascript"><span class="line"><span class="token keyword">if</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">var</span> age <span class="token operator">=</span> <span class="token number">12</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line">console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>age<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code class="language-javascript"><span class="line"><span class="token keyword">var</span> name <span class="token operator">=</span> <span class="token string">&#39;zhufeng&#39;</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">var</span> age <span class="token operator">=</span> <span class="token number">12</span><span class="token punctuation">;</span></span>
<span class="line">console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>age<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_6-2-scope-js" tabindex="-1"><a class="header-anchor" href="#_6-2-scope-js"><span>6.2 scope.js</span></a></h3><p>lib\\ast\\scope.js</p><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text"><pre><code class="language-text"><span class="line"></span>
<span class="line"></span>
<span class="line">class Scope {</span>
<span class="line">    constructor(options = {}) {</span>
<span class="line">        this.name = options.name;</span>
<span class="line">        this.parent = options.parent;</span>
<span class="line">        this.names = options.params || [];//存放着当前作用域内的所有的变量</span>
<span class="line">+       this.isBlockScope = !!options.block// 是否块作用域</span>
<span class="line">    }</span>
<span class="line">+   add(name, isBlockDeclaration) {</span>
<span class="line">+       if (!isBlockDeclaration &amp;&amp; this.isBlockScope) {</span>
<span class="line">            //这是一个var或者函数声明，并且这是一个块级作用域，所以我们需要向上提升</span>
<span class="line">+           this.parent.add(name, isBlockDeclaration)</span>
<span class="line">        } else {</span>
<span class="line">            this.names.push(name)</span>
<span class="line">        }</span>
<span class="line">    }</span>
<span class="line">    //给我一个变量，我查一下在哪个作用域中定义的这个变量</span>
<span class="line">    findDefiningScope(name) {</span>
<span class="line">        if (this.names.includes(name)) {//如果自己有，就返回自己这个作用</span>
<span class="line">            return this;</span>
<span class="line">        }</span>
<span class="line">        if (this.parent) {//如果自己没有这个变量，但是有爹，问问爹有没有</span>
<span class="line">            return this.parent.findDefiningScope(name)</span>
<span class="line">        }</span>
<span class="line">        return null;</span>
<span class="line">    }</span>
<span class="line">}</span>
<span class="line">module.exports = Scope;</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_6-3-analyse-js" tabindex="-1"><a class="header-anchor" href="#_6-3-analyse-js"><span>6.3 analyse.js</span></a></h3><p>lib\\ast\\analyse.js</p><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code class="language-javascript"><span class="line"></span>
<span class="line"></span>
<span class="line"><span class="token keyword">let</span> walk <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&#39;./walk&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">let</span> Scope <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&#39;./scope&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">const</span> <span class="token punctuation">{</span> hasOwnProperty <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&#39;../utils&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">function</span> <span class="token function">analyse</span><span class="token punctuation">(</span><span class="token parameter">ast<span class="token punctuation">,</span> magicStringOfAst</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token comment">//在遍历之前先创建作用域对象</span></span>
<span class="line">    <span class="token keyword">let</span> scope <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Scope</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">&#39;全局作用域&#39;</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    ast<span class="token punctuation">.</span>body<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">statement</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></span>
<span class="line"><span class="token operator">+</span>       <span class="token keyword">function</span> <span class="token function">addToScope</span><span class="token punctuation">(</span><span class="token parameter">name<span class="token punctuation">,</span> isBlockDeclaration</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line"><span class="token operator">+</span>           scope<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> isBlockDeclaration<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>scope<span class="token punctuation">.</span>parent<span class="token operator">||</span> currentScope<span class="token punctuation">.</span>isBlockScope<span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token comment">//如果此作用域 没有父作用域,那这就是顶级变量，根作用域下的变量，可以放在_defines=tree</span></span>
<span class="line">                <span class="token comment">//模块内的顶级变量</span></span>
<span class="line">                statement<span class="token punctuation">.</span>_defines<span class="token punctuation">[</span>name<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span></span>
<span class="line">            <span class="token punctuation">}</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">        Object<span class="token punctuation">.</span><span class="token function">defineProperties</span><span class="token punctuation">(</span>statement<span class="token punctuation">,</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token literal-property property">_modifies</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token literal-property property">value</span><span class="token operator">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span> <span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token comment">//修改</span></span>
<span class="line">            <span class="token literal-property property">_defines</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token literal-property property">value</span><span class="token operator">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span> <span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token comment">//当前statement语法树节点声明了哪些变量</span></span>
<span class="line">            <span class="token literal-property property">_dependsOn</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token literal-property property">value</span><span class="token operator">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span> <span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token comment">//当前statement语句外部依赖的变量</span></span>
<span class="line">            <span class="token literal-property property">_included</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token literal-property property">value</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token literal-property property">writable</span><span class="token operator">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token comment">//当前的语句是否放置在结果中，是否会出现在打包结果中</span></span>
<span class="line">            <span class="token literal-property property">_source</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token literal-property property">value</span><span class="token operator">:</span> magicStringOfAst<span class="token punctuation">.</span><span class="token function">snip</span><span class="token punctuation">(</span>statement<span class="token punctuation">.</span>start<span class="token punctuation">,</span> statement<span class="token punctuation">.</span>end<span class="token punctuation">)</span> <span class="token punctuation">}</span><span class="token comment">//key是_source 值是这个语法树节点在源码中的源代码</span></span>
<span class="line">        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token comment">//如何知道某个变量有没有在当前模块内定义的呢？</span></span>
<span class="line">        <span class="token comment">//原理是这样 扫描整个模块，找到所有的定义的变量</span></span>
<span class="line">        <span class="token comment">//构建使用域链</span></span>
<span class="line">        <span class="token function">walk</span><span class="token punctuation">(</span>statement<span class="token punctuation">,</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token function">enter</span><span class="token punctuation">(</span><span class="token parameter">node</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">                <span class="token keyword">let</span> newScope<span class="token punctuation">;</span></span>
<span class="line">                <span class="token keyword">switch</span> <span class="token punctuation">(</span>node<span class="token punctuation">.</span>type<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">                    <span class="token keyword">case</span> <span class="token string">&#39;FunctionDeclaration&#39;</span><span class="token operator">:</span></span>
<span class="line">                        <span class="token comment">//函数的参数将会成为此函数子作用域内的局部变量</span></span>
<span class="line">                        <span class="token keyword">const</span> names <span class="token operator">=</span> node<span class="token punctuation">.</span>params<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token parameter">param</span> <span class="token operator">=&gt;</span> param<span class="token punctuation">.</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">                        <span class="token function">addToScope</span><span class="token punctuation">(</span>node<span class="token punctuation">.</span>id<span class="token punctuation">.</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//把node也就是say这个变量添加到当前作用内 </span></span>
<span class="line">                        <span class="token comment">//如果遇到函数声明，就会产生一个新作用域</span></span>
<span class="line">                        newScope <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Scope</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token literal-property property">name</span><span class="token operator">:</span> node<span class="token punctuation">.</span>id<span class="token punctuation">.</span>name<span class="token punctuation">,</span> <span class="token literal-property property">parent</span><span class="token operator">:</span> scope<span class="token punctuation">,</span> <span class="token literal-property property">params</span><span class="token operator">:</span> names<span class="token punctuation">,</span> </span>
<span class="line"><span class="token operator">+</span>                       block<span class="token operator">:</span> <span class="token boolean">false</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">                        <span class="token keyword">break</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token operator">+</span>                   <span class="token keyword">case</span> <span class="token string">&#39;BlockStatement&#39;</span><span class="token operator">:</span></span>
<span class="line"><span class="token operator">+</span>                       newScope <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Scope</span><span class="token punctuation">(</span><span class="token punctuation">{</span></span>
<span class="line"><span class="token operator">+</span>                           parent<span class="token operator">:</span> scope<span class="token punctuation">,</span></span>
<span class="line"><span class="token operator">+</span>                           block<span class="token operator">:</span> <span class="token boolean">true</span></span>
<span class="line"><span class="token operator">+</span>                       <span class="token punctuation">}</span><span class="token punctuation">)</span></span>
<span class="line"><span class="token operator">+</span>                       <span class="token keyword">break</span><span class="token punctuation">;</span></span>
<span class="line">                    <span class="token keyword">case</span> <span class="token string">&#39;VariableDeclaration&#39;</span><span class="token operator">:</span></span>
<span class="line">                        node<span class="token punctuation">.</span>declarations<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">declaration</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></span>
<span class="line"><span class="token operator">+</span>                           <span class="token keyword">if</span><span class="token punctuation">(</span>node<span class="token punctuation">.</span>kind <span class="token operator">===</span> <span class="token string">&#39;let&#39;</span><span class="token operator">||</span>node<span class="token punctuation">.</span>kind <span class="token operator">===</span> <span class="token string">&#39;const&#39;</span><span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line"><span class="token operator">+</span>                               <span class="token function">addToScope</span><span class="token punctuation">(</span>declaration<span class="token punctuation">.</span>id<span class="token punctuation">.</span>name<span class="token punctuation">,</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token operator">+</span>                           <span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{</span></span>
<span class="line"><span class="token operator">+</span>                               <span class="token function">addToScope</span><span class="token punctuation">(</span>declaration<span class="token punctuation">.</span>id<span class="token punctuation">.</span>name<span class="token punctuation">)</span></span>
<span class="line"><span class="token operator">+</span>                           <span class="token punctuation">}</span></span>
<span class="line">                        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">                        <span class="token keyword">break</span><span class="token punctuation">;</span></span>
<span class="line">                <span class="token punctuation">}</span></span>
<span class="line">                <span class="token keyword">if</span> <span class="token punctuation">(</span>newScope<span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token comment">//如果创建了新的作用域，那么这个作用域将会成为新的当前作用域</span></span>
<span class="line">                    Object<span class="token punctuation">.</span><span class="token function">defineProperty</span><span class="token punctuation">(</span>node<span class="token punctuation">,</span> <span class="token string">&#39;_scope&#39;</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> <span class="token literal-property property">value</span><span class="token operator">:</span> newScope <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">                    scope <span class="token operator">=</span> newScope<span class="token punctuation">;</span><span class="token comment">// say这个函数作用域</span></span>
<span class="line">                <span class="token punctuation">}</span></span>
<span class="line">            <span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">            <span class="token function">leave</span><span class="token punctuation">(</span><span class="token parameter">node</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">                <span class="token comment">//当离开节点的时候 ，如果发现这个节点创建 新的作用域，就回退到使用域</span></span>
<span class="line">                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">hasOwnProperty</span><span class="token punctuation">(</span>node<span class="token punctuation">,</span> <span class="token string">&#39;_scope&#39;</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">                    scope <span class="token operator">=</span> scope<span class="token punctuation">.</span>parent<span class="token punctuation">;</span></span>
<span class="line">                <span class="token punctuation">}</span></span>
<span class="line">            <span class="token punctuation">}</span></span>
<span class="line">        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token comment">//2.作用域链构建完成后，再遍历一次，找出本模块定义了依赖了哪些外部变量</span></span>
<span class="line">    ast<span class="token punctuation">.</span>body<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">statement</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">function</span> <span class="token function">checkForReads</span><span class="token punctuation">(</span><span class="token parameter">node</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token keyword">if</span> <span class="token punctuation">(</span>node<span class="token punctuation">.</span>type <span class="token operator">===</span> <span class="token string">&#39;Identifier&#39;</span><span class="token operator">&amp;&amp;</span> parent<span class="token punctuation">.</span>type <span class="token operator">!==</span> <span class="token string">&#39;VariableDeclarator&#39;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">                <span class="token keyword">const</span> definingScope <span class="token operator">=</span> scope<span class="token punctuation">.</span><span class="token function">findDefiningScope</span><span class="token punctuation">(</span>node<span class="token punctuation">.</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token operator">-</span>               <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>definingScope<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">                    statement<span class="token punctuation">.</span>_dependsOn<span class="token punctuation">[</span>node<span class="token punctuation">.</span>name<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span><span class="token comment">//添加外部依赖</span></span>
<span class="line"><span class="token operator">-</span>               <span class="token punctuation">}</span></span>
<span class="line">            <span class="token punctuation">}</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">        <span class="token keyword">function</span> <span class="token function">checkForWrites</span><span class="token punctuation">(</span><span class="token parameter">node</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token keyword">function</span> <span class="token function">addNode</span><span class="token punctuation">(</span><span class="token parameter">node</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">                <span class="token keyword">while</span> <span class="token punctuation">(</span>node<span class="token punctuation">.</span>type <span class="token operator">===</span> <span class="token string">&#39;MemberExpression&#39;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">                    node <span class="token operator">=</span> node<span class="token punctuation">.</span>object<span class="token punctuation">;</span></span>
<span class="line">                <span class="token punctuation">}</span></span>
<span class="line">                <span class="token keyword">if</span> <span class="token punctuation">(</span>node<span class="token punctuation">.</span>type <span class="token operator">!==</span> <span class="token string">&#39;Identifier&#39;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">                    <span class="token keyword">return</span></span>
<span class="line">                <span class="token punctuation">}</span></span>
<span class="line">                statement<span class="token punctuation">.</span>_modifies<span class="token punctuation">[</span>node<span class="token punctuation">.</span>name<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span></span>
<span class="line">            <span class="token punctuation">}</span></span>
<span class="line">            <span class="token keyword">if</span> <span class="token punctuation">(</span>node<span class="token punctuation">.</span>type <span class="token operator">===</span> <span class="token string">&#39;AssignmentExpression&#39;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token comment">// name=&#39;jiagou&#39;</span></span>
<span class="line">                <span class="token function">addNode</span><span class="token punctuation">(</span>node<span class="token punctuation">.</span>left<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span></span>
<span class="line">            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>node<span class="token punctuation">.</span>type <span class="token operator">===</span> <span class="token string">&#39;UpdateExpression&#39;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token comment">//name+=&#39;jiagou&#39;</span></span>
<span class="line">                <span class="token function">addNode</span><span class="token punctuation">(</span>node<span class="token punctuation">.</span>argument<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span></span>
<span class="line">            <span class="token punctuation">}</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">        <span class="token function">walk</span><span class="token punctuation">(</span>statement<span class="token punctuation">,</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token function">enter</span><span class="token punctuation">(</span><span class="token parameter">node</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">hasOwnProperty</span><span class="token punctuation">(</span>node<span class="token punctuation">,</span> <span class="token string">&#39;_scope&#39;</span><span class="token punctuation">)</span><span class="token punctuation">)</span> scope <span class="token operator">=</span> node<span class="token punctuation">.</span>_scope<span class="token punctuation">;</span></span>
<span class="line">                <span class="token function">checkForReads</span><span class="token punctuation">(</span>node<span class="token punctuation">)</span></span>
<span class="line">                <span class="token function">checkForWrites</span><span class="token punctuation">(</span>node<span class="token punctuation">)</span></span>
<span class="line">            <span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">            <span class="token function">leave</span><span class="token punctuation">(</span><span class="token parameter">node</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">                <span class="token keyword">if</span> <span class="token punctuation">(</span>node<span class="token punctuation">.</span>_scope<span class="token punctuation">)</span> scope <span class="token operator">=</span> scope<span class="token punctuation">.</span>parent</span>
<span class="line">            <span class="token punctuation">}</span></span>
<span class="line">        <span class="token punctuation">}</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line">module<span class="token punctuation">.</span>exports <span class="token operator">=</span> analyse<span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_6-4-module-js" tabindex="-1"><a class="header-anchor" href="#_6-4-module-js"><span>6.4 module.js</span></a></h3><p>lib\\module.js</p><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code class="language-javascript"><span class="line"></span>
<span class="line"><span class="token keyword">const</span> MagicString <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&#39;magic-string&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">const</span> <span class="token punctuation">{</span> parse <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&#39;acorn&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">const</span> analyse <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&#39;./ast/analyse&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">const</span> <span class="token punctuation">{</span> hasOwnProperty <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&#39;./utils&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token operator">+</span><span class="token keyword">const</span> <span class="token constant">SYSTEM_VARIABLE</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">&#39;console&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;log&#39;</span><span class="token punctuation">]</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">class</span> <span class="token class-name">Module</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> code<span class="token punctuation">,</span> path<span class="token punctuation">,</span> bundle <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">this</span><span class="token punctuation">.</span>code <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MagicString</span><span class="token punctuation">(</span>code<span class="token punctuation">,</span> <span class="token punctuation">{</span> <span class="token literal-property property">filename</span><span class="token operator">:</span> path <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">this</span><span class="token punctuation">.</span>path <span class="token operator">=</span> path<span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">this</span><span class="token punctuation">.</span>bundle <span class="token operator">=</span> bundle<span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">this</span><span class="token punctuation">.</span>ast <span class="token operator">=</span> <span class="token function">parse</span><span class="token punctuation">(</span>code<span class="token punctuation">,</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token literal-property property">ecmaVersion</span><span class="token operator">:</span> <span class="token number">8</span><span class="token punctuation">,</span></span>
<span class="line">            <span class="token literal-property property">sourceType</span><span class="token operator">:</span> <span class="token string">&#39;module&#39;</span></span>
<span class="line">        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">this</span><span class="token punctuation">.</span>imports <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span><span class="token comment">//导入</span></span>
<span class="line">        <span class="token keyword">this</span><span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span><span class="token comment">//导出</span></span>
<span class="line">        <span class="token keyword">this</span><span class="token punctuation">.</span>definitions <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span><span class="token comment">//此变量存放所有的变量定义的语句</span></span>
<span class="line">        <span class="token keyword">this</span><span class="token punctuation">.</span>modifications <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">analyse</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    <span class="token function">analyse</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">this</span><span class="token punctuation">.</span>ast<span class="token punctuation">.</span>body<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">statement</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token comment">//1.给import赋值 </span></span>
<span class="line">            <span class="token keyword">if</span> <span class="token punctuation">(</span>statement<span class="token punctuation">.</span>type <span class="token operator">===</span> <span class="token string">&#39;ImportDeclaration&#39;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">                <span class="token keyword">let</span> source <span class="token operator">=</span> statement<span class="token punctuation">.</span>source<span class="token punctuation">.</span>value<span class="token punctuation">;</span><span class="token comment">//./msg</span></span>
<span class="line">                statement<span class="token punctuation">.</span>specifiers<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">specifier</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></span>
<span class="line">                    <span class="token keyword">let</span> importName <span class="token operator">=</span> specifier<span class="token punctuation">.</span>imported<span class="token punctuation">.</span>name<span class="token punctuation">;</span><span class="token comment">//age</span></span>
<span class="line">                    <span class="token keyword">let</span> localName <span class="token operator">=</span> specifier<span class="token punctuation">.</span>local<span class="token punctuation">.</span>name<span class="token punctuation">;</span><span class="token comment">//age</span></span>
<span class="line">                    <span class="token comment">//记录一下当前的这个引入的变量是从哪个模块的哪个变量导入进来的</span></span>
<span class="line">                    <span class="token keyword">this</span><span class="token punctuation">.</span>imports<span class="token punctuation">[</span>localName<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span> localName<span class="token punctuation">,</span> source<span class="token punctuation">,</span> importName <span class="token punctuation">}</span><span class="token punctuation">;</span></span>
<span class="line">                <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">                <span class="token comment">//2.this.exports赋值</span></span>
<span class="line">            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>statement<span class="token punctuation">.</span>type <span class="token operator">===</span> <span class="token string">&#39;ExportNamedDeclaration&#39;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">                <span class="token keyword">let</span> declaration <span class="token operator">=</span> statement<span class="token punctuation">.</span>declaration<span class="token punctuation">;</span></span>
<span class="line">                <span class="token keyword">if</span> <span class="token punctuation">(</span>declaration<span class="token punctuation">.</span>type <span class="token operator">===</span> <span class="token string">&#39;VariableDeclaration&#39;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">                    <span class="token keyword">const</span> declarations <span class="token operator">=</span> declaration<span class="token punctuation">.</span>declarations<span class="token punctuation">;</span></span>
<span class="line">                    declarations<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">variableDeclarator</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></span>
<span class="line">                        <span class="token keyword">let</span> localName <span class="token operator">=</span> variableDeclarator<span class="token punctuation">.</span>id<span class="token punctuation">.</span>name<span class="token punctuation">;</span></span>
<span class="line">                        <span class="token comment">//this.exports.age = {localName:&#39;age&#39;,exportName:&#39;age&#39;,expression:};</span></span>
<span class="line">                        <span class="token keyword">this</span><span class="token punctuation">.</span>exports<span class="token punctuation">[</span>localName<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span> localName<span class="token punctuation">,</span> <span class="token literal-property property">exportName</span><span class="token operator">:</span> localName<span class="token punctuation">,</span> <span class="token literal-property property">expression</span><span class="token operator">:</span> declaration <span class="token punctuation">}</span><span class="token punctuation">;</span></span>
<span class="line">                    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">                <span class="token punctuation">}</span></span>
<span class="line">            <span class="token punctuation">}</span></span>
<span class="line">        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token comment">//1.构建了作用域 2.找到模块块依赖了哪些外部变量</span></span>
<span class="line">        <span class="token function">analyse</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>ast<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>code<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">this</span><span class="token punctuation">.</span>ast<span class="token punctuation">.</span>body<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">statement</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></span>
<span class="line">            Object<span class="token punctuation">.</span><span class="token function">keys</span><span class="token punctuation">(</span>statement<span class="token punctuation">.</span>_defines<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">name</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></span>
<span class="line">                <span class="token comment">//当前模块内 定义name这个变量的语句是statement</span></span>
<span class="line">                <span class="token comment">//main.js  type   let type = &#39;dog&#39;;</span></span>
<span class="line">                <span class="token keyword">this</span><span class="token punctuation">.</span>definitions<span class="token punctuation">[</span>name<span class="token punctuation">]</span> <span class="token operator">=</span> statement<span class="token punctuation">;</span></span>
<span class="line">            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">            Object<span class="token punctuation">.</span><span class="token function">keys</span><span class="token punctuation">(</span>statement<span class="token punctuation">.</span>_modifies<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">name</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></span>
<span class="line">                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">hasOwnProperty</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>modifications<span class="token punctuation">,</span> name<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">                    <span class="token keyword">this</span><span class="token punctuation">.</span>modifications<span class="token punctuation">[</span>name<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span></span>
<span class="line">                <span class="token punctuation">}</span></span>
<span class="line">                <span class="token keyword">this</span><span class="token punctuation">.</span>modifications<span class="token punctuation">[</span>name<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>statement<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">            <span class="token punctuation">}</span><span class="token punctuation">)</span></span>
<span class="line">        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    <span class="token function">expandAllStatements</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">let</span> allStatements <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">this</span><span class="token punctuation">.</span>ast<span class="token punctuation">.</span>body<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">statement</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token keyword">if</span> <span class="token punctuation">(</span>statement<span class="token punctuation">.</span>type <span class="token operator">===</span> <span class="token string">&#39;ImportDeclaration&#39;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token comment">//不再需要import语句</span></span>
<span class="line">                <span class="token keyword">return</span><span class="token punctuation">;</span></span>
<span class="line">            <span class="token punctuation">}</span></span>
<span class="line"><span class="token operator">+</span>           <span class="token keyword">if</span> <span class="token punctuation">(</span>statement<span class="token punctuation">.</span>type <span class="token operator">===</span> <span class="token string">&#39;VariableDeclaration&#39;</span><span class="token punctuation">)</span> <span class="token keyword">return</span><span class="token punctuation">;</span></span>
<span class="line">            <span class="token keyword">let</span> statements <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">expandStatement</span><span class="token punctuation">(</span>statement<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">            <span class="token comment">//我们要把statement进行扩展，有可能一行变多行var name =&#39;zhufeng&#39;, console.log(&#39;name&#39;); TODO</span></span>
<span class="line">            allStatements<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token operator">...</span>statements<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">return</span> allStatements<span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    <span class="token comment">//展开单 条语句  console.log(name,age);</span></span>
<span class="line">    <span class="token function">expandStatement</span><span class="token punctuation">(</span><span class="token parameter">statement</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>statement<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        statement<span class="token punctuation">.</span>_included <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span><span class="token comment">// 把当前语句标记为包含</span></span>
<span class="line">        <span class="token keyword">let</span> result <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">const</span> dependencies <span class="token operator">=</span> Object<span class="token punctuation">.</span><span class="token function">keys</span><span class="token punctuation">(</span>statement<span class="token punctuation">.</span>_dependsOn<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        dependencies<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">name</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token comment">//获取依赖的变量对应的变量定义语句 name</span></span>
<span class="line">            <span class="token keyword">let</span> definition <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">define</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">            result<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token operator">...</span>definition<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        result<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>statement<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//再放进来当前的语句</span></span>
<span class="line">        <span class="token keyword">const</span> defines <span class="token operator">=</span> Object<span class="token punctuation">.</span><span class="token function">keys</span><span class="token punctuation">(</span>statement<span class="token punctuation">.</span>_defines<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        defines<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">name</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token keyword">const</span> modifications <span class="token operator">=</span> <span class="token function">hasOwnProperty</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>modifications<span class="token punctuation">,</span> name<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token keyword">this</span><span class="token punctuation">.</span>modifications<span class="token punctuation">[</span>name<span class="token punctuation">]</span><span class="token punctuation">;</span></span>
<span class="line">            <span class="token keyword">if</span> <span class="token punctuation">(</span>modifications<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">                modifications<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">statement</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></span>
<span class="line">                    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>statement<span class="token punctuation">.</span>_included<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">                        <span class="token keyword">let</span> statements <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">expandStatement</span><span class="token punctuation">(</span>statement<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">                        result<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token operator">...</span>statements<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">                    <span class="token punctuation">}</span></span>
<span class="line">                <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">            <span class="token punctuation">}</span></span>
<span class="line">        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">return</span> result<span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    <span class="token function">define</span><span class="token punctuation">(</span><span class="token parameter">name</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&#39;name&#39;</span><span class="token punctuation">,</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token comment">//说明此变量是外部导入进来的</span></span>
<span class="line">        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">hasOwnProperty</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>imports<span class="token punctuation">,</span> name<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token comment">//this.imports[localName]={localName,source,importName};</span></span>
<span class="line">            <span class="token keyword">const</span> <span class="token punctuation">{</span> localName<span class="token punctuation">,</span> source<span class="token punctuation">,</span> importName <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>imports<span class="token punctuation">[</span>name<span class="token punctuation">]</span><span class="token punctuation">;</span></span>
<span class="line">            <span class="token comment">// source .msg</span></span>
<span class="line">            <span class="token keyword">let</span> importedModule <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>bundle<span class="token punctuation">.</span><span class="token function">fetchModule</span><span class="token punctuation">(</span>source<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>path<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">            <span class="token keyword">const</span> <span class="token punctuation">{</span> <span class="token literal-property property">localName</span><span class="token operator">:</span> exportLocalName <span class="token punctuation">}</span> <span class="token operator">=</span> importedModule<span class="token punctuation">.</span>exports<span class="token punctuation">[</span>importName<span class="token punctuation">]</span><span class="token punctuation">;</span></span>
<span class="line">            <span class="token comment">//this.exports.name = {localName:&#39;name&#39;,exportName:&#39;name&#39;,expression:};</span></span>
<span class="line">            <span class="token keyword">return</span> importedModule<span class="token punctuation">.</span><span class="token function">define</span><span class="token punctuation">(</span>exportLocalName<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span><span class="token comment">//说明是在当前模块内声明的</span></span>
<span class="line"><span class="token operator">+</span>            <span class="token keyword">let</span> statement <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>definitions<span class="token punctuation">[</span>name<span class="token punctuation">]</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token operator">+</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span>statement<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line"><span class="token operator">+</span>                <span class="token keyword">if</span><span class="token punctuation">(</span>statement<span class="token punctuation">.</span>_included<span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line"><span class="token operator">+</span>                    <span class="token keyword">return</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token operator">+</span>                <span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{</span></span>
<span class="line"><span class="token operator">+</span>                    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">expandStatement</span><span class="token punctuation">(</span>statement<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token operator">+</span>                <span class="token punctuation">}</span></span>
<span class="line"><span class="token operator">+</span>            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token constant">SYSTEM_VARIABLE</span><span class="token punctuation">.</span><span class="token function">includes</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line"><span class="token operator">+</span>                <span class="token keyword">return</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token operator">+</span>            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span></span>
<span class="line"><span class="token operator">+</span>                <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">\`</span><span class="token string">变量</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">\${</span>name<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">没有既没有从外部导入，也没有在当前模块内声明！</span><span class="token template-punctuation string">\`</span></span><span class="token punctuation">)</span></span>
<span class="line"><span class="token operator">+</span>            <span class="token punctuation">}</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line">module<span class="token punctuation">.</span>exports <span class="token operator">=</span> Module<span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="_7-实现变量名重命名" tabindex="-1"><a class="header-anchor" href="#_7-实现变量名重命名"><span>7. 实现变量名重命名</span></a></h2><h3 id="_7-1-src-main-js" tabindex="-1"><a class="header-anchor" href="#_7-1-src-main-js"><span>7.1 src\\main.js</span></a></h3><p>src\\main.js</p><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code class="language-javascript"><span class="line"><span class="token keyword">import</span> <span class="token punctuation">{</span>age1<span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&#39;./age1.js&#39;</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">import</span> <span class="token punctuation">{</span>age2<span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&#39;./age2.js&#39;</span><span class="token punctuation">;</span></span>
<span class="line">console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>age1<span class="token punctuation">,</span>age2<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_7-2-src-age1-js" tabindex="-1"><a class="header-anchor" href="#_7-2-src-age1-js"><span>7.2 src\\age1.js</span></a></h3><p>src\\age1.js</p><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code class="language-javascript"><span class="line"><span class="token keyword">const</span> age <span class="token operator">=</span> <span class="token string">&#39;年龄&#39;</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">export</span> <span class="token keyword">const</span> age1 <span class="token operator">=</span> age<span class="token operator">+</span><span class="token string">&#39;1&#39;</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_7-3-src-age2-js" tabindex="-1"><a class="header-anchor" href="#_7-3-src-age2-js"><span>7.3 src\\age2.js</span></a></h3><p>age2.js</p><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code class="language-javascript"><span class="line"><span class="token keyword">const</span> age <span class="token operator">=</span> <span class="token string">&#39;年龄&#39;</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">export</span> <span class="token keyword">const</span> age2 <span class="token operator">=</span> age<span class="token operator">+</span><span class="token string">&#39;2&#39;</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_7-4-bundle-js" tabindex="-1"><a class="header-anchor" href="#_7-4-bundle-js"><span>7.4 bundle.js</span></a></h3><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code class="language-javascript"><span class="line"><span class="token keyword">const</span> _age <span class="token operator">=</span> <span class="token string">&#39;年龄&#39;</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">const</span> age1 <span class="token operator">=</span> _age<span class="token operator">+</span><span class="token string">&#39;1&#39;</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">const</span> age <span class="token operator">=</span> <span class="token string">&#39;年龄&#39;</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">const</span> age2 <span class="token operator">=</span> age<span class="token operator">+</span><span class="token string">&#39;2&#39;</span><span class="token punctuation">;</span></span>
<span class="line">console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>age1<span class="token punctuation">,</span>age2<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_7-5-lib-utils-js" tabindex="-1"><a class="header-anchor" href="#_7-5-lib-utils-js"><span>7.5 lib\\utils.js</span></a></h3><p>lib\\utils.js</p><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code class="language-javascript"><span class="line"><span class="token keyword">const</span> walk <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&#39;./ast/walk&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">function</span> <span class="token function">hasOwnProperty</span><span class="token punctuation">(</span><span class="token parameter">obj<span class="token punctuation">,</span> prop</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">return</span> <span class="token class-name">Object</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function">hasOwnProperty</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>obj<span class="token punctuation">,</span> prop<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"><span class="token keyword">function</span> <span class="token function">keys</span><span class="token punctuation">(</span><span class="token parameter">obj</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">return</span> Object<span class="token punctuation">.</span><span class="token function">keys</span><span class="token punctuation">(</span>obj<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"><span class="token keyword">function</span> <span class="token function">replaceIdentifiers</span><span class="token punctuation">(</span><span class="token parameter">statement<span class="token punctuation">,</span> source<span class="token punctuation">,</span> replacements</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token function">walk</span><span class="token punctuation">(</span>statement<span class="token punctuation">,</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token function">enter</span><span class="token punctuation">(</span><span class="token parameter">node</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token keyword">if</span> <span class="token punctuation">(</span>node<span class="token punctuation">.</span>type <span class="token operator">===</span> <span class="token string">&#39;Identifier&#39;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">                <span class="token keyword">if</span><span class="token punctuation">(</span>node<span class="token punctuation">.</span>name <span class="token operator">&amp;&amp;</span> replacements<span class="token punctuation">[</span>node<span class="token punctuation">.</span>name<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line">                    source<span class="token punctuation">.</span><span class="token function">overwrite</span><span class="token punctuation">(</span>node<span class="token punctuation">.</span>start<span class="token punctuation">,</span> node<span class="token punctuation">.</span>end<span class="token punctuation">,</span> replacements<span class="token punctuation">[</span>node<span class="token punctuation">.</span>name<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">                <span class="token punctuation">}</span></span>
<span class="line">            <span class="token punctuation">}</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">    <span class="token punctuation">}</span><span class="token punctuation">)</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line">exports<span class="token punctuation">.</span>hasOwnProperty<span class="token operator">=</span>hasOwnProperty<span class="token punctuation">;</span></span>
<span class="line">exports<span class="token punctuation">.</span>keys<span class="token operator">=</span>keys<span class="token punctuation">;</span></span>
<span class="line">exports<span class="token punctuation">.</span>replaceIdentifiers<span class="token operator">=</span>replaceIdentifiers<span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_7-6-analyse-js" tabindex="-1"><a class="header-anchor" href="#_7-6-analyse-js"><span>7.6 analyse.js</span></a></h3><p>lib\\ast\\analyse.js</p><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code class="language-javascript"><span class="line"><span class="token keyword">let</span> walk <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&#39;./walk&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">let</span> Scope <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&#39;./scope&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">const</span> <span class="token punctuation">{</span> hasOwnProperty <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&#39;../utils&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token operator">+</span><span class="token keyword">function</span> <span class="token function">analyse</span><span class="token punctuation">(</span><span class="token parameter">ast<span class="token punctuation">,</span> magicStringOfAst<span class="token punctuation">,</span>module</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token comment">//在遍历之前先创建作用域对象</span></span>
<span class="line">    <span class="token keyword">let</span> scope <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Scope</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">&#39;全局作用域&#39;</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    ast<span class="token punctuation">.</span>body<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">statement</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">function</span> <span class="token function">addToScope</span><span class="token punctuation">(</span><span class="token parameter">name<span class="token punctuation">,</span> isBlockDeclaration</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">            scope<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> isBlockDeclaration<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>scope<span class="token punctuation">.</span>parent<span class="token operator">||</span> currentScope<span class="token punctuation">.</span>isBlockScope<span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token comment">//如果此作用域 没有父作用域,那这就是顶级变量，根作用域下的变量，可以放在_defines=tree</span></span>
<span class="line">                <span class="token comment">//模块内的顶级变量</span></span>
<span class="line">                statement<span class="token punctuation">.</span>_defines<span class="token punctuation">[</span>name<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span></span>
<span class="line">            <span class="token punctuation">}</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">        Object<span class="token punctuation">.</span><span class="token function">defineProperties</span><span class="token punctuation">(</span>statement<span class="token punctuation">,</span> <span class="token punctuation">{</span></span>
<span class="line"><span class="token operator">+</span>           _module<span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token literal-property property">value</span><span class="token operator">:</span> module <span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">            <span class="token literal-property property">_modifies</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token literal-property property">value</span><span class="token operator">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span> <span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token comment">//修改</span></span>
<span class="line">            <span class="token literal-property property">_defines</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token literal-property property">value</span><span class="token operator">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span> <span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token comment">//当前statement语法树节点声明了哪些变量</span></span>
<span class="line">            <span class="token literal-property property">_dependsOn</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token literal-property property">value</span><span class="token operator">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span> <span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token comment">//当前statement语句外部依赖的变量</span></span>
<span class="line">            <span class="token literal-property property">_included</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token literal-property property">value</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token literal-property property">writable</span><span class="token operator">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token comment">//当前的语句是否放置在结果中，是否会出现在打包结果中</span></span>
<span class="line">            <span class="token literal-property property">_source</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token literal-property property">value</span><span class="token operator">:</span> magicStringOfAst<span class="token punctuation">.</span><span class="token function">snip</span><span class="token punctuation">(</span>statement<span class="token punctuation">.</span>start<span class="token punctuation">,</span> statement<span class="token punctuation">.</span>end<span class="token punctuation">)</span> <span class="token punctuation">}</span><span class="token comment">//key是_source 值是这个语法树节点在源码中的源代码</span></span>
<span class="line">        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token comment">//如何知道某个变量有没有在当前模块内定义的呢？</span></span>
<span class="line">        <span class="token comment">//原理是这样 扫描整个模块，找到所有的定义的变量</span></span>
<span class="line">        <span class="token comment">//构建使用域链</span></span>
<span class="line">        <span class="token function">walk</span><span class="token punctuation">(</span>statement<span class="token punctuation">,</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token function">enter</span><span class="token punctuation">(</span><span class="token parameter">node</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">                <span class="token keyword">let</span> newScope<span class="token punctuation">;</span></span>
<span class="line">                <span class="token keyword">switch</span> <span class="token punctuation">(</span>node<span class="token punctuation">.</span>type<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">                    <span class="token keyword">case</span> <span class="token string">&#39;FunctionDeclaration&#39;</span><span class="token operator">:</span></span>
<span class="line">                        <span class="token comment">//函数的参数将会成为此函数子作用域内的局部变量</span></span>
<span class="line">                        <span class="token keyword">const</span> names <span class="token operator">=</span> node<span class="token punctuation">.</span>params<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token parameter">param</span> <span class="token operator">=&gt;</span> param<span class="token punctuation">.</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">                        <span class="token function">addToScope</span><span class="token punctuation">(</span>node<span class="token punctuation">.</span>id<span class="token punctuation">.</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//把node也就是say这个变量添加到当前作用内 </span></span>
<span class="line">                        <span class="token comment">//如果遇到函数声明，就会产生一个新作用域</span></span>
<span class="line">                        newScope <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Scope</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token literal-property property">name</span><span class="token operator">:</span> node<span class="token punctuation">.</span>id<span class="token punctuation">.</span>name<span class="token punctuation">,</span> <span class="token literal-property property">parent</span><span class="token operator">:</span> scope<span class="token punctuation">,</span> <span class="token literal-property property">params</span><span class="token operator">:</span> names<span class="token punctuation">,</span> <span class="token literal-property property">block</span><span class="token operator">:</span> <span class="token boolean">false</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">                        <span class="token keyword">break</span><span class="token punctuation">;</span></span>
<span class="line">                    <span class="token keyword">case</span> <span class="token string">&#39;BlockStatement&#39;</span><span class="token operator">:</span></span>
<span class="line">                        newScope <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Scope</span><span class="token punctuation">(</span><span class="token punctuation">{</span></span>
<span class="line">                            <span class="token literal-property property">parent</span><span class="token operator">:</span> scope<span class="token punctuation">,</span></span>
<span class="line">                            <span class="token literal-property property">block</span><span class="token operator">:</span> <span class="token boolean">true</span></span>
<span class="line">                        <span class="token punctuation">}</span><span class="token punctuation">)</span></span>
<span class="line">                        <span class="token keyword">break</span><span class="token punctuation">;</span></span>
<span class="line">                    <span class="token keyword">case</span> <span class="token string">&#39;VariableDeclaration&#39;</span><span class="token operator">:</span></span>
<span class="line">                        node<span class="token punctuation">.</span>declarations<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">declaration</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></span>
<span class="line">                            <span class="token keyword">if</span><span class="token punctuation">(</span>node<span class="token punctuation">.</span>kind <span class="token operator">===</span> <span class="token string">&#39;let&#39;</span><span class="token operator">||</span>node<span class="token punctuation">.</span>kind <span class="token operator">===</span> <span class="token string">&#39;const&#39;</span><span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line">                                <span class="token function">addToScope</span><span class="token punctuation">(</span>declaration<span class="token punctuation">.</span>id<span class="token punctuation">.</span>name<span class="token punctuation">,</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">                            <span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{</span></span>
<span class="line">                                <span class="token function">addToScope</span><span class="token punctuation">(</span>declaration<span class="token punctuation">.</span>id<span class="token punctuation">.</span>name<span class="token punctuation">)</span></span>
<span class="line">                            <span class="token punctuation">}</span></span>
<span class="line">                        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">                        <span class="token keyword">break</span><span class="token punctuation">;</span></span>
<span class="line">                <span class="token punctuation">}</span></span>
<span class="line">                <span class="token keyword">if</span> <span class="token punctuation">(</span>newScope<span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token comment">//如果创建了新的作用域，那么这个作用域将会成为新的当前作用域</span></span>
<span class="line">                    Object<span class="token punctuation">.</span><span class="token function">defineProperty</span><span class="token punctuation">(</span>node<span class="token punctuation">,</span> <span class="token string">&#39;_scope&#39;</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> <span class="token literal-property property">value</span><span class="token operator">:</span> newScope <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">                    scope <span class="token operator">=</span> newScope<span class="token punctuation">;</span><span class="token comment">// say这个函数作用域</span></span>
<span class="line">                <span class="token punctuation">}</span></span>
<span class="line">            <span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">            <span class="token function">leave</span><span class="token punctuation">(</span><span class="token parameter">node</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">                <span class="token comment">//当离开节点的时候 ，如果发现这个节点创建 新的作用域，就回退到使用域</span></span>
<span class="line">                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">hasOwnProperty</span><span class="token punctuation">(</span>node<span class="token punctuation">,</span> <span class="token string">&#39;_scope&#39;</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">                    scope <span class="token operator">=</span> scope<span class="token punctuation">.</span>parent<span class="token punctuation">;</span></span>
<span class="line">                <span class="token punctuation">}</span></span>
<span class="line">            <span class="token punctuation">}</span></span>
<span class="line">        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token comment">//2.作用域链构建完成后，再遍历一次，找出本模块定义了依赖了哪些外部变量</span></span>
<span class="line">    ast<span class="token punctuation">.</span>body<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">statement</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">function</span> <span class="token function">checkForReads</span><span class="token punctuation">(</span><span class="token parameter">node</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token keyword">if</span> <span class="token punctuation">(</span>node<span class="token punctuation">.</span>type <span class="token operator">===</span> <span class="token string">&#39;Identifier&#39;</span><span class="token operator">&amp;&amp;</span> parent<span class="token punctuation">.</span>type <span class="token operator">!==</span> <span class="token string">&#39;VariableDeclarator&#39;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">                <span class="token keyword">const</span> definingScope <span class="token operator">=</span> scope<span class="token punctuation">.</span><span class="token function">findDefiningScope</span><span class="token punctuation">(</span>node<span class="token punctuation">.</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">                <span class="token comment">//-if (!definingScope) {</span></span>
<span class="line">                    statement<span class="token punctuation">.</span>_dependsOn<span class="token punctuation">[</span>node<span class="token punctuation">.</span>name<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span><span class="token comment">//添加外部依赖</span></span>
<span class="line">                <span class="token comment">//-}</span></span>
<span class="line">            <span class="token punctuation">}</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">        <span class="token keyword">function</span> <span class="token function">checkForWrites</span><span class="token punctuation">(</span><span class="token parameter">node</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token keyword">function</span> <span class="token function">addNode</span><span class="token punctuation">(</span><span class="token parameter">node</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">                <span class="token keyword">while</span> <span class="token punctuation">(</span>node<span class="token punctuation">.</span>type <span class="token operator">===</span> <span class="token string">&#39;MemberExpression&#39;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">                    node <span class="token operator">=</span> node<span class="token punctuation">.</span>object<span class="token punctuation">;</span></span>
<span class="line">                <span class="token punctuation">}</span></span>
<span class="line">                <span class="token keyword">if</span> <span class="token punctuation">(</span>node<span class="token punctuation">.</span>type <span class="token operator">!==</span> <span class="token string">&#39;Identifier&#39;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">                    <span class="token keyword">return</span></span>
<span class="line">                <span class="token punctuation">}</span></span>
<span class="line">                statement<span class="token punctuation">.</span>_modifies<span class="token punctuation">[</span>node<span class="token punctuation">.</span>name<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span></span>
<span class="line">            <span class="token punctuation">}</span></span>
<span class="line">            <span class="token keyword">if</span> <span class="token punctuation">(</span>node<span class="token punctuation">.</span>type <span class="token operator">===</span> <span class="token string">&#39;AssignmentExpression&#39;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token comment">// name=&#39;jiagou&#39;</span></span>
<span class="line">                <span class="token function">addNode</span><span class="token punctuation">(</span>node<span class="token punctuation">.</span>left<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span></span>
<span class="line">            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>node<span class="token punctuation">.</span>type <span class="token operator">===</span> <span class="token string">&#39;UpdateExpression&#39;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token comment">//name+=&#39;jiagou&#39;</span></span>
<span class="line">                <span class="token function">addNode</span><span class="token punctuation">(</span>node<span class="token punctuation">.</span>argument<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span></span>
<span class="line">            <span class="token punctuation">}</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">        <span class="token function">walk</span><span class="token punctuation">(</span>statement<span class="token punctuation">,</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token function">enter</span><span class="token punctuation">(</span><span class="token parameter">node</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">hasOwnProperty</span><span class="token punctuation">(</span>node<span class="token punctuation">,</span> <span class="token string">&#39;_scope&#39;</span><span class="token punctuation">)</span><span class="token punctuation">)</span> scope <span class="token operator">=</span> node<span class="token punctuation">.</span>_scope<span class="token punctuation">;</span></span>
<span class="line">                <span class="token function">checkForReads</span><span class="token punctuation">(</span>node<span class="token punctuation">)</span></span>
<span class="line">                <span class="token function">checkForWrites</span><span class="token punctuation">(</span>node<span class="token punctuation">)</span></span>
<span class="line">            <span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">            <span class="token function">leave</span><span class="token punctuation">(</span><span class="token parameter">node</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">                <span class="token keyword">if</span> <span class="token punctuation">(</span>node<span class="token punctuation">.</span>_scope<span class="token punctuation">)</span> scope <span class="token operator">=</span> scope<span class="token punctuation">.</span>parent</span>
<span class="line">            <span class="token punctuation">}</span></span>
<span class="line">        <span class="token punctuation">}</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line">module<span class="token punctuation">.</span>exports <span class="token operator">=</span> analyse<span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_7-7-module-js" tabindex="-1"><a class="header-anchor" href="#_7-7-module-js"><span>7.7 module.js</span></a></h3><p>lib\\module.js</p><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code class="language-javascript"><span class="line"></span>
<span class="line"><span class="token keyword">const</span> MagicString <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&#39;magic-string&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">const</span> <span class="token punctuation">{</span> parse <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&#39;acorn&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">const</span> analyse <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&#39;./ast/analyse&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">const</span> <span class="token punctuation">{</span> hasOwnProperty <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&#39;./utils&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">const</span> <span class="token constant">SYSTEM_VARIABLE</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">&#39;console&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;log&#39;</span><span class="token punctuation">]</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">class</span> <span class="token class-name">Module</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> code<span class="token punctuation">,</span> path<span class="token punctuation">,</span> bundle <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">this</span><span class="token punctuation">.</span>code <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MagicString</span><span class="token punctuation">(</span>code<span class="token punctuation">,</span> <span class="token punctuation">{</span> <span class="token literal-property property">filename</span><span class="token operator">:</span> path <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">this</span><span class="token punctuation">.</span>path <span class="token operator">=</span> path<span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">this</span><span class="token punctuation">.</span>bundle <span class="token operator">=</span> bundle<span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">this</span><span class="token punctuation">.</span>ast <span class="token operator">=</span> <span class="token function">parse</span><span class="token punctuation">(</span>code<span class="token punctuation">,</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token literal-property property">ecmaVersion</span><span class="token operator">:</span> <span class="token number">8</span><span class="token punctuation">,</span></span>
<span class="line">            <span class="token literal-property property">sourceType</span><span class="token operator">:</span> <span class="token string">&#39;module&#39;</span></span>
<span class="line">        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">this</span><span class="token punctuation">.</span>imports <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span><span class="token comment">//导入</span></span>
<span class="line">        <span class="token keyword">this</span><span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span><span class="token comment">//导出</span></span>
<span class="line">        <span class="token keyword">this</span><span class="token punctuation">.</span>definitions <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span><span class="token comment">//此变量存放所有的变量定义的语句</span></span>
<span class="line">        <span class="token keyword">this</span><span class="token punctuation">.</span>modifications <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token operator">+</span>       <span class="token keyword">this</span><span class="token punctuation">.</span>canonicalNames <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">analyse</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    <span class="token function">analyse</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">this</span><span class="token punctuation">.</span>ast<span class="token punctuation">.</span>body<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">statement</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token comment">//1.给import赋值 </span></span>
<span class="line">            <span class="token keyword">if</span> <span class="token punctuation">(</span>statement<span class="token punctuation">.</span>type <span class="token operator">===</span> <span class="token string">&#39;ImportDeclaration&#39;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">                <span class="token keyword">let</span> source <span class="token operator">=</span> statement<span class="token punctuation">.</span>source<span class="token punctuation">.</span>value<span class="token punctuation">;</span><span class="token comment">//./msg</span></span>
<span class="line">                statement<span class="token punctuation">.</span>specifiers<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">specifier</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></span>
<span class="line">                    <span class="token keyword">let</span> importName <span class="token operator">=</span> specifier<span class="token punctuation">.</span>imported<span class="token punctuation">.</span>name<span class="token punctuation">;</span><span class="token comment">//age</span></span>
<span class="line">                    <span class="token keyword">let</span> localName <span class="token operator">=</span> specifier<span class="token punctuation">.</span>local<span class="token punctuation">.</span>name<span class="token punctuation">;</span><span class="token comment">//age</span></span>
<span class="line">                    <span class="token comment">//记录一下当前的这个引入的变量是从哪个模块的哪个变量导入进来的</span></span>
<span class="line">                    <span class="token keyword">this</span><span class="token punctuation">.</span>imports<span class="token punctuation">[</span>localName<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span> localName<span class="token punctuation">,</span> source<span class="token punctuation">,</span> importName <span class="token punctuation">}</span><span class="token punctuation">;</span></span>
<span class="line">                <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">                <span class="token comment">//2.this.exports赋值</span></span>
<span class="line">            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>statement<span class="token punctuation">.</span>type <span class="token operator">===</span> <span class="token string">&#39;ExportNamedDeclaration&#39;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">                <span class="token keyword">let</span> declaration <span class="token operator">=</span> statement<span class="token punctuation">.</span>declaration<span class="token punctuation">;</span></span>
<span class="line">                <span class="token keyword">if</span> <span class="token punctuation">(</span>declaration<span class="token punctuation">.</span>type <span class="token operator">===</span> <span class="token string">&#39;VariableDeclaration&#39;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">                    <span class="token keyword">const</span> declarations <span class="token operator">=</span> declaration<span class="token punctuation">.</span>declarations<span class="token punctuation">;</span></span>
<span class="line">                    declarations<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">variableDeclarator</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></span>
<span class="line">                        <span class="token keyword">let</span> localName <span class="token operator">=</span> variableDeclarator<span class="token punctuation">.</span>id<span class="token punctuation">.</span>name<span class="token punctuation">;</span></span>
<span class="line">                        <span class="token comment">//this.exports.age = {localName:&#39;age&#39;,exportName:&#39;age&#39;,expression:};</span></span>
<span class="line">                        <span class="token keyword">this</span><span class="token punctuation">.</span>exports<span class="token punctuation">[</span>localName<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span> localName<span class="token punctuation">,</span> <span class="token literal-property property">exportName</span><span class="token operator">:</span> localName<span class="token punctuation">,</span> <span class="token literal-property property">expression</span><span class="token operator">:</span> declaration <span class="token punctuation">}</span><span class="token punctuation">;</span></span>
<span class="line">                    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">                <span class="token punctuation">}</span></span>
<span class="line">            <span class="token punctuation">}</span></span>
<span class="line">        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token comment">//1.构建了作用域 2.找到模块块依赖了哪些外部变量</span></span>
<span class="line">        <span class="token function">analyse</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>ast<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>code<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">this</span><span class="token punctuation">.</span>ast<span class="token punctuation">.</span>body<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">statement</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></span>
<span class="line">            Object<span class="token punctuation">.</span><span class="token function">keys</span><span class="token punctuation">(</span>statement<span class="token punctuation">.</span>_defines<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">name</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></span>
<span class="line">                <span class="token comment">//当前模块内 定义name这个变量的语句是statement</span></span>
<span class="line">                <span class="token comment">//main.js  type   let type = &#39;dog&#39;;</span></span>
<span class="line">                <span class="token keyword">this</span><span class="token punctuation">.</span>definitions<span class="token punctuation">[</span>name<span class="token punctuation">]</span> <span class="token operator">=</span> statement<span class="token punctuation">;</span></span>
<span class="line">            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">            Object<span class="token punctuation">.</span><span class="token function">keys</span><span class="token punctuation">(</span>statement<span class="token punctuation">.</span>_modifies<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">name</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></span>
<span class="line">                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">hasOwnProperty</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>modifications<span class="token punctuation">,</span> name<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">                    <span class="token keyword">this</span><span class="token punctuation">.</span>modifications<span class="token punctuation">[</span>name<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span></span>
<span class="line">                <span class="token punctuation">}</span></span>
<span class="line">                <span class="token keyword">this</span><span class="token punctuation">.</span>modifications<span class="token punctuation">[</span>name<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>statement<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">            <span class="token punctuation">}</span><span class="token punctuation">)</span></span>
<span class="line">        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    <span class="token function">expandAllStatements</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">let</span> allStatements <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">this</span><span class="token punctuation">.</span>ast<span class="token punctuation">.</span>body<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">statement</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token keyword">if</span> <span class="token punctuation">(</span>statement<span class="token punctuation">.</span>type <span class="token operator">===</span> <span class="token string">&#39;ImportDeclaration&#39;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token comment">//不再需要import语句</span></span>
<span class="line">                <span class="token keyword">return</span><span class="token punctuation">;</span></span>
<span class="line">            <span class="token punctuation">}</span></span>
<span class="line">            <span class="token keyword">if</span> <span class="token punctuation">(</span>statement<span class="token punctuation">.</span>type <span class="token operator">===</span> <span class="token string">&#39;VariableDeclaration&#39;</span><span class="token punctuation">)</span> <span class="token keyword">return</span><span class="token punctuation">;</span></span>
<span class="line">            <span class="token keyword">let</span> statements <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">expandStatement</span><span class="token punctuation">(</span>statement<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">            <span class="token comment">//我们要把statement进行扩展，有可能一行变多行var name =&#39;zhufeng&#39;, console.log(&#39;name&#39;); TODO</span></span>
<span class="line">            allStatements<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token operator">...</span>statements<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">return</span> allStatements<span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    <span class="token comment">//展开单 条语句  console.log(name,age);</span></span>
<span class="line">    <span class="token function">expandStatement</span><span class="token punctuation">(</span><span class="token parameter">statement</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>statement<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        statement<span class="token punctuation">.</span>_included <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span><span class="token comment">// 把当前语句标记为包含</span></span>
<span class="line">        <span class="token keyword">let</span> result <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">const</span> dependencies <span class="token operator">=</span> Object<span class="token punctuation">.</span><span class="token function">keys</span><span class="token punctuation">(</span>statement<span class="token punctuation">.</span>_dependsOn<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        dependencies<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">name</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token comment">//获取依赖的变量对应的变量定义语句 name</span></span>
<span class="line">            <span class="token keyword">let</span> definition <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">define</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">            result<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token operator">...</span>definition<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        result<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>statement<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//再放进来当前的语句</span></span>
<span class="line">        <span class="token keyword">const</span> defines <span class="token operator">=</span> Object<span class="token punctuation">.</span><span class="token function">keys</span><span class="token punctuation">(</span>statement<span class="token punctuation">.</span>_defines<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        defines<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">name</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token keyword">const</span> modifications <span class="token operator">=</span> <span class="token function">hasOwnProperty</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>modifications<span class="token punctuation">,</span> name<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token keyword">this</span><span class="token punctuation">.</span>modifications<span class="token punctuation">[</span>name<span class="token punctuation">]</span><span class="token punctuation">;</span></span>
<span class="line">            <span class="token keyword">if</span> <span class="token punctuation">(</span>modifications<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">                modifications<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">statement</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></span>
<span class="line">                    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>statement<span class="token punctuation">.</span>_included<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">                        <span class="token keyword">let</span> statements <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">expandStatement</span><span class="token punctuation">(</span>statement<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">                        result<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token operator">...</span>statements<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">                    <span class="token punctuation">}</span></span>
<span class="line">                <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">            <span class="token punctuation">}</span></span>
<span class="line">        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">return</span> result<span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    <span class="token function">define</span><span class="token punctuation">(</span><span class="token parameter">name</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&#39;name&#39;</span><span class="token punctuation">,</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token comment">//说明此变量是外部导入进来的</span></span>
<span class="line">        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">hasOwnProperty</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>imports<span class="token punctuation">,</span> name<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token comment">//this.imports[localName]={localName,source,importName};</span></span>
<span class="line">            <span class="token keyword">const</span> <span class="token punctuation">{</span> localName<span class="token punctuation">,</span> source<span class="token punctuation">,</span> importName <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>imports<span class="token punctuation">[</span>name<span class="token punctuation">]</span><span class="token punctuation">;</span></span>
<span class="line">            <span class="token comment">// source .msg</span></span>
<span class="line">            <span class="token keyword">let</span> importedModule <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>bundle<span class="token punctuation">.</span><span class="token function">fetchModule</span><span class="token punctuation">(</span>source<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>path<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">            <span class="token keyword">const</span> <span class="token punctuation">{</span> <span class="token literal-property property">localName</span><span class="token operator">:</span> exportLocalName <span class="token punctuation">}</span> <span class="token operator">=</span> importedModule<span class="token punctuation">.</span>exports<span class="token punctuation">[</span>importName<span class="token punctuation">]</span><span class="token punctuation">;</span></span>
<span class="line">            <span class="token comment">//this.exports.name = {localName:&#39;name&#39;,exportName:&#39;name&#39;,expression:};</span></span>
<span class="line">            <span class="token keyword">return</span> importedModule<span class="token punctuation">.</span><span class="token function">define</span><span class="token punctuation">(</span>exportLocalName<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span><span class="token comment">//说明是在当前模块内声明的</span></span>
<span class="line">            <span class="token keyword">let</span> statement <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>definitions<span class="token punctuation">[</span>name<span class="token punctuation">]</span><span class="token punctuation">;</span></span>
<span class="line">            <span class="token keyword">if</span> <span class="token punctuation">(</span>statement<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">                <span class="token keyword">if</span><span class="token punctuation">(</span>statement<span class="token punctuation">.</span>_included<span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line">                    <span class="token keyword">return</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span></span>
<span class="line">                <span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{</span></span>
<span class="line">                    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">expandStatement</span><span class="token punctuation">(</span>statement<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">                <span class="token punctuation">}</span></span>
<span class="line">            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token constant">SYSTEM_VARIABLE</span><span class="token punctuation">.</span><span class="token function">includes</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">                <span class="token keyword">return</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span></span>
<span class="line">            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span></span>
<span class="line">                <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">\`</span><span class="token string">变量</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">\${</span>name<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">没有既没有从外部导入，也没有在当前模块内声明！</span><span class="token template-punctuation string">\`</span></span><span class="token punctuation">)</span></span>
<span class="line">            <span class="token punctuation">}</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"><span class="token operator">+</span>   <span class="token function">rename</span><span class="token punctuation">(</span><span class="token parameter">name<span class="token punctuation">,</span> replacement</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line"><span class="token operator">+</span>     <span class="token keyword">this</span><span class="token punctuation">.</span>canonicalName<span class="token punctuation">[</span>name<span class="token punctuation">]</span> <span class="token operator">=</span> replacement<span class="token punctuation">;</span></span>
<span class="line"><span class="token operator">+</span>   <span class="token punctuation">}</span></span>
<span class="line"><span class="token operator">+</span>   <span class="token function">getCanonicalName</span><span class="token punctuation">(</span><span class="token parameter">name</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line"><span class="token operator">+</span>     <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>canonicalName<span class="token punctuation">[</span>name<span class="token punctuation">]</span> <span class="token operator">||</span> name<span class="token punctuation">;</span></span>
<span class="line"><span class="token operator">+</span>   <span class="token punctuation">}</span>f</span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line">module<span class="token punctuation">.</span>exports <span class="token operator">=</span> Module<span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_7-8-lib-bundle-js" tabindex="-1"><a class="header-anchor" href="#_7-8-lib-bundle-js"><span>7.8 lib\\bundle.js</span></a></h3><p>lib\\bundle.js</p><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code class="language-javascript"><span class="line"><span class="token keyword">const</span> MagicString <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&#39;magic-string&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">const</span> path <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&#39;path&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">const</span> fs <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&#39;fs&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">const</span> Module <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&#39;./module&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token operator">+</span><span class="token keyword">let</span> <span class="token punctuation">{</span> hasOwnProperty<span class="token punctuation">,</span> keys<span class="token punctuation">,</span> replaceIdentifiers <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&#39;./utils&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">class</span> <span class="token class-name">Bundle</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter">entry</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">this</span><span class="token punctuation">.</span>entryPath <span class="token operator">=</span> path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>entry<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//得到入口文件的绝对路径</span></span>
<span class="line">        <span class="token keyword">this</span><span class="token punctuation">.</span>modules <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span><span class="token comment">//存放着本次打包的所有的模块</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    <span class="token comment">//负责编译入口文件，然后把结果写入outputFile</span></span>
<span class="line">    <span class="token function">build</span><span class="token punctuation">(</span><span class="token parameter">outputFile</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token comment">//先获取入口模块的实例</span></span>
<span class="line">        <span class="token keyword">let</span> entryModule <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>entryModule <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">fetchModule</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>entryPath<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token comment">//展开入口模块语句</span></span>
<span class="line">        <span class="token keyword">this</span><span class="token punctuation">.</span>statements <span class="token operator">=</span> entryModule<span class="token punctuation">.</span><span class="token function">expandAllStatements</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token operator">+</span>       <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">deConflict</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">const</span> transformedCode <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">generate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        fs<span class="token punctuation">.</span><span class="token function">writeFileSync</span><span class="token punctuation">(</span>outputFile<span class="token punctuation">,</span> transformedCode<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"><span class="token operator">+</span>   <span class="token function">deconflict</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line"><span class="token operator">+</span>     <span class="token keyword">const</span> defines <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span><span class="token comment">//定义的变量</span></span>
<span class="line"><span class="token operator">+</span>     <span class="token keyword">const</span> conflicts <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span><span class="token comment">//冲突的变量</span></span>
<span class="line"><span class="token operator">+</span>     <span class="token keyword">this</span><span class="token punctuation">.</span>statements<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">statement</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></span>
<span class="line"><span class="token operator">+</span>       <span class="token comment">//循环此语句上定义的所有的变量</span></span>
<span class="line"><span class="token operator">+</span>       <span class="token function">keys</span><span class="token punctuation">(</span>statement<span class="token punctuation">.</span>_defines<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">name</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></span>
<span class="line"><span class="token operator">+</span>         <span class="token comment">//判断此变量name是否已经定义过了</span></span>
<span class="line"><span class="token operator">+</span>         <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">hasOwnProperty</span><span class="token punctuation">(</span>defines<span class="token punctuation">,</span> name<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line"><span class="token operator">+</span>           <span class="token comment">//此变量已经出现过了，就标记为此变量冲突</span></span>
<span class="line"><span class="token operator">+</span>           conflicts<span class="token punctuation">[</span>name<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token operator">+</span>         <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span></span>
<span class="line"><span class="token operator">+</span>           defines<span class="token punctuation">[</span>name<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token operator">+</span>         <span class="token punctuation">}</span></span>
<span class="line"><span class="token operator">+</span>         defines<span class="token punctuation">[</span>name<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>statement<span class="token punctuation">.</span>_module<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token operator">+</span>       <span class="token punctuation">}</span><span class="token punctuation">)</span></span>
<span class="line"><span class="token operator">+</span>     <span class="token punctuation">}</span><span class="token punctuation">)</span></span>
<span class="line"><span class="token operator">+</span>     Object<span class="token punctuation">.</span><span class="token function">keys</span><span class="token punctuation">(</span>conflicts<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">name</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></span>
<span class="line"><span class="token operator">+</span>       <span class="token keyword">const</span> modules <span class="token operator">=</span> defines<span class="token punctuation">[</span>name<span class="token punctuation">]</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token operator">+</span>       <span class="token comment">//最后一个模块不需要重命名</span></span>
<span class="line"><span class="token operator">+</span>       modules<span class="token punctuation">.</span><span class="token function">pop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token operator">+</span>       modules<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">module<span class="token punctuation">,</span> index</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></span>
<span class="line"><span class="token operator">+</span>         <span class="token keyword">const</span> replacement <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">\`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">\${</span>name<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">$</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">\${</span>modules<span class="token punctuation">.</span>length <span class="token operator">-</span> index<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">\`</span></span><span class="token punctuation">;</span></span>
<span class="line"><span class="token operator">+</span>         module<span class="token punctuation">.</span><span class="token function">rename</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> replacement<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token operator">+</span>       <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token operator">+</span> </span>
<span class="line"><span class="token operator">+</span>     <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token operator">+</span>   <span class="token punctuation">}</span></span>
<span class="line">    <span class="token doc-comment comment">/**</span>
<span class="line">     * 根据模块的绝对路径返回模块的实例</span>
<span class="line">     * <span class="token keyword">@param</span> <span class="token class-name"><span class="token punctuation">{</span><span class="token operator">*</span><span class="token punctuation">}</span></span> <span class="token parameter">importee</span> 被 导入的模块的绝对路径也可能是相对</span>
<span class="line">     * <span class="token keyword">@param</span> <span class="token class-name"><span class="token punctuation">{</span><span class="token operator">*</span><span class="token punctuation">}</span></span> <span class="token parameter">importer</span> 导入的模块绝对路径</span>
<span class="line">     */</span></span>
<span class="line">    <span class="token function">fetchModule</span><span class="token punctuation">(</span><span class="token parameter">importee<span class="token punctuation">,</span> importer</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">let</span> route<span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>importer<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">            route <span class="token operator">=</span> importee<span class="token punctuation">;</span></span>
<span class="line">        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token keyword">if</span> <span class="token punctuation">(</span>path<span class="token punctuation">.</span><span class="token function">isAbsolute</span><span class="token punctuation">(</span>importee<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">                route <span class="token operator">=</span> importee<span class="token punctuation">;</span></span>
<span class="line">            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span></span>
<span class="line">                route <span class="token operator">=</span> path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>path<span class="token punctuation">.</span><span class="token function">dirname</span><span class="token punctuation">(</span>importer<span class="token punctuation">)</span><span class="token punctuation">,</span> importee<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">            <span class="token punctuation">}</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">        <span class="token keyword">if</span> <span class="token punctuation">(</span>route<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token keyword">let</span> code <span class="token operator">=</span> fs<span class="token punctuation">.</span><span class="token function">readFileSync</span><span class="token punctuation">(</span>route<span class="token punctuation">,</span> <span class="token string">&#39;utf8&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">            <span class="token keyword">const</span> module <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Module</span><span class="token punctuation">(</span><span class="token punctuation">{</span></span>
<span class="line">                code<span class="token punctuation">,</span></span>
<span class="line">                <span class="token literal-property property">path</span><span class="token operator">:</span> route<span class="token punctuation">,</span></span>
<span class="line">                <span class="token literal-property property">bundle</span><span class="token operator">:</span> <span class="token keyword">this</span></span>
<span class="line">            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">            <span class="token keyword">return</span> module<span class="token punctuation">;</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    <span class="token function">generate</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">let</span> transformedCode <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MagicString<span class="token punctuation">.</span>Bundle</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//字符串包</span></span>
<span class="line">        <span class="token comment">//this.statements只有入口模块里所有的顶层节点</span></span>
<span class="line">        <span class="token keyword">this</span><span class="token punctuation">.</span>statements<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">statement</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></span>
<span class="line"><span class="token operator">+</span>            <span class="token keyword">let</span> replacements <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token operator">+</span>            Object<span class="token punctuation">.</span><span class="token function">keys</span><span class="token punctuation">(</span>statement<span class="token punctuation">.</span>_dependsOn<span class="token punctuation">)</span></span>
<span class="line"><span class="token operator">+</span>                <span class="token punctuation">.</span><span class="token function">concat</span><span class="token punctuation">(</span>Object<span class="token punctuation">.</span><span class="token function">keys</span><span class="token punctuation">(</span>statement<span class="token punctuation">.</span>_defines<span class="token punctuation">)</span><span class="token punctuation">)</span></span>
<span class="line"><span class="token operator">+</span>                <span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">name</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></span>
<span class="line"><span class="token operator">+</span>                    <span class="token keyword">const</span> canonicalName <span class="token operator">=</span> statement<span class="token punctuation">.</span>_module<span class="token punctuation">.</span><span class="token function">getCanonicalName</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span></span>
<span class="line"><span class="token operator">+</span>                   <span class="token keyword">if</span> <span class="token punctuation">(</span>name <span class="token operator">!==</span> canonicalName<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line"><span class="token operator">+</span>                       replacements<span class="token punctuation">[</span>name<span class="token punctuation">]</span> <span class="token operator">=</span> canonicalName<span class="token punctuation">;</span></span>
<span class="line"><span class="token operator">+</span>                   <span class="token punctuation">}</span></span>
<span class="line"><span class="token operator">+</span>               <span class="token punctuation">}</span><span class="token punctuation">)</span></span>
<span class="line">            <span class="token comment">//我如何向statement这个顶级节点上添加_source属性，值是magicString实例</span></span>
<span class="line">            <span class="token keyword">const</span> content <span class="token operator">=</span> statement<span class="token punctuation">.</span>_source<span class="token punctuation">.</span><span class="token function">clone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">^Export</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">.</span><span class="token function">test</span><span class="token punctuation">(</span>statement<span class="token punctuation">.</span>type<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">                <span class="token keyword">if</span> <span class="token punctuation">(</span>statement<span class="token punctuation">.</span>type <span class="token operator">===</span> <span class="token string">&#39;ExportNamedDeclaration&#39;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">                    content<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span>statement<span class="token punctuation">.</span>start<span class="token punctuation">,</span> statement<span class="token punctuation">.</span>declaration<span class="token punctuation">.</span>start<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">                <span class="token punctuation">}</span></span>
<span class="line">            <span class="token punctuation">}</span></span>
<span class="line"><span class="token operator">+</span>            <span class="token function">replaceIdentifiers</span><span class="token punctuation">(</span>statement<span class="token punctuation">,</span> content<span class="token punctuation">,</span> replacements<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">            transformedCode<span class="token punctuation">.</span><span class="token function">addSource</span><span class="token punctuation">(</span><span class="token punctuation">{</span></span>
<span class="line">                content<span class="token punctuation">,</span></span>
<span class="line">                <span class="token literal-property property">separator</span><span class="token operator">:</span> <span class="token string">&#39;\\n&#39;</span></span>
<span class="line">            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">return</span> transformedCode<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line">module<span class="token punctuation">.</span>exports <span class="token operator">=</span> Bundle<span class="token punctuation">;</span></span>
<span class="line"><span class="token comment">//webpack Compiler</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div>`,234)])])}const i=s(t,[["render",l]]),u=JSON.parse('{"path":"/strong/128.rollup.html","title":"","lang":"en-US","frontmatter":{},"git":{"updatedTime":1681290319000,"contributors":[{"name":"yutao","username":"yutao","email":"642231346@qq.com","commits":1,"url":"https://github.com/yutao"}],"changelog":[{"hash":"f5ab8c9d34991ec274f7f652439afe5b2afb6147","time":1681290319000,"email":"642231346@qq.com","author":"yutao","message":"modify"}]},"filePathRelative":"strong/128.rollup.md"}');export{i as comp,u as data};
