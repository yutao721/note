import{_ as s,c as a,a as p,o as t}from"./app-CD1YpnS1.js";const e={};function o(c,n){return t(),a("div",null,[...n[0]||(n[0]=[p(`<h2 id="_1-抽象语法树-abstract-syntax-tree" tabindex="-1"><a class="header-anchor" href="#_1-抽象语法树-abstract-syntax-tree"><span>1.抽象语法树(Abstract Syntax Tree)</span></a></h2><ul><li>抽象语法树（Abstract Syntax Tree，AST）是源代码语法结构的一种抽象表示</li><li>它以树状的形式表现编程语言的语法结构，树上的每个节点都表示源代码中的一种结构</li></ul><h2 id="_2-抽象语法树用途" tabindex="-1"><a class="header-anchor" href="#_2-抽象语法树用途"><span>2.抽象语法树用途</span></a></h2><ul><li>代码语法的检查、代码风格的检查、代码的格式化、代码的高亮、代码错误提示、代码自动补全等等</li><li>优化变更代码，改变代码结构使达到想要的结构</li></ul><h2 id="_3-抽象语法树定义" tabindex="-1"><a class="header-anchor" href="#_3-抽象语法树定义"><span>3.抽象语法树定义</span></a></h2><ul><li>这些工具的原理都是通过<code>JavaScript Parser</code>把代码转化为一颗抽象语法树（AST），这颗树定义了代码的结构，通过操纵这颗树，我们可以精准的定位到声明语句、赋值语句、运算语句等等，实现对代码的分析、优化、变更等操作</li></ul><p><img src="http://img.zhufengpeixun.cn/ast.jpg" alt="ast"></p><h2 id="_4-javascript-parser" tabindex="-1"><a class="header-anchor" href="#_4-javascript-parser"><span>4. JavaScript Parser</span></a></h2><ul><li><code>JavaScript Parser</code>是把JavaScript源码转化为抽象语法树的解析器</li></ul><h3 id="_4-1-常用的-javascript-parser" tabindex="-1"><a class="header-anchor" href="#_4-1-常用的-javascript-parser"><span>4.1 常用的 JavaScript Parser</span></a></h3><ul><li>SpiderMonkey <ul><li>estree <ul><li>esprima</li><li>acorn <ul><li>babel parser</li></ul></li></ul></li></ul></li></ul><h3 id="_4-2-ast节点" tabindex="-1"><a class="header-anchor" href="#_4-2-ast节点"><span>4.2 AST节点</span></a></h3><ul><li><a href="https://github.com/estree/estree" target="_blank" rel="noopener noreferrer">estree</a></li><li><a href="https://github.com/babel/babel/blob/main/packages/babel-parser/ast/spec.md" target="_blank" rel="noopener noreferrer">spec.md</a></li><li><a href="https://astexplorer.net/" target="_blank" rel="noopener noreferrer">astexplorer</a></li><li>AST节点 <ul><li>File 文件</li><li>Program 程序</li><li>Literal 字面量 NumericLiteral StringLiteral BooleanLiteral</li><li>Identifier 标识符</li><li>Statement 语句</li><li>Declaration 声明语句</li><li>Expression 表达式</li><li>Class 类</li></ul></li></ul><h3 id="_4-3-ast遍历" tabindex="-1"><a class="header-anchor" href="#_4-3-ast遍历"><span>4.3 AST遍历</span></a></h3><ul><li><a href="https://astexplorer.net/" target="_blank" rel="noopener noreferrer">astexplorer</a></li><li>AST是深度优先遍历</li></ul><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text"><pre><code class="language-text"><span class="line">npm i esprima estraverse escodegen -S</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code class="language-javascript"><span class="line"><span class="token keyword">let</span> esprima <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&#39;esprima&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//把JS源代码转成AST语法树</span></span>
<span class="line"><span class="token keyword">let</span> estraverse <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&#39;estraverse&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">///遍历语法树,修改树上的节点</span></span>
<span class="line"><span class="token keyword">let</span> escodegen <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&#39;escodegen&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//把AST语法树重新转换成代码</span></span>
<span class="line"><span class="token keyword">let</span> code <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">\`</span><span class="token string">function ast(){}</span><span class="token template-punctuation string">\`</span></span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">let</span> ast <span class="token operator">=</span> esprima<span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>code<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">let</span> indent <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">const</span> <span class="token function-variable function">padding</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token string">&quot; &quot;</span><span class="token punctuation">.</span><span class="token function">repeat</span><span class="token punctuation">(</span>indent<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">estraverse<span class="token punctuation">.</span><span class="token function">traverse</span><span class="token punctuation">(</span>ast<span class="token punctuation">,</span><span class="token punctuation">{</span></span>
<span class="line">    <span class="token function">enter</span><span class="token punctuation">(</span><span class="token parameter">node</span><span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line">        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token function">padding</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">+</span>node<span class="token punctuation">.</span>type<span class="token operator">+</span><span class="token string">&#39;进入&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">if</span><span class="token punctuation">(</span>node<span class="token punctuation">.</span>type <span class="token operator">===</span> <span class="token string">&#39;FunctionDeclaration&#39;</span><span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line">            node<span class="token punctuation">.</span>id<span class="token punctuation">.</span>name <span class="token operator">=</span> <span class="token string">&#39;newAst&#39;</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">        indent<span class="token operator">+=</span><span class="token number">2</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token function">leave</span><span class="token punctuation">(</span><span class="token parameter">node</span><span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line">        indent<span class="token operator">-=</span><span class="token number">2</span><span class="token punctuation">;</span></span>
<span class="line">        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token function">padding</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">+</span>node<span class="token punctuation">.</span>type<span class="token operator">+</span><span class="token string">&#39;离开&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text"><pre><code class="language-text"><span class="line">Program进入</span>
<span class="line">  FunctionDeclaration进入</span>
<span class="line">    Identifier进入</span>
<span class="line">    Identifier离开</span>
<span class="line">    BlockStatement进入</span>
<span class="line">    BlockStatement离开</span>
<span class="line">  FunctionDeclaration离开</span>
<span class="line">Program离开</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="_5-babel" tabindex="-1"><a class="header-anchor" href="#_5-babel"><span>5.babel</span></a></h2><ul><li>Babel 能够转译 <code>ECMAScript 2015+</code> 的代码，使它在旧的浏览器或者环境中也能够运行</li><li>工作过程分为三个部分 <ul><li>Parse(解析) 将源代码转换成抽象语法树，树上有很多的<a href="https://github.com/estree/estree" target="_blank" rel="noopener noreferrer">estree节点</a></li><li>Transform(转换) 对抽象语法树进行转换</li><li>Generate(代码生成) 将上一步经过转换过的抽象语法树生成新的代码</li></ul></li></ul><p><img src="https://img.zhufengpeixun.com/ast-compiler-flow.jpg" alt="ast-compiler-flow.jpg"></p><h3 id="_5-2-babel-插件" tabindex="-1"><a class="header-anchor" href="#_5-2-babel-插件"><span>5.2 babel 插件</span></a></h3><ul><li><a href="https://github.com/babel/babel/tree/master/packages/@babel/parser" target="_blank" rel="noopener noreferrer">@babel/parser</a> 可以把源码转换成AST</li><li><a href="https://www.npmjs.com/package/babel-traverse" target="_blank" rel="noopener noreferrer">@babel/traverse</a>用于对 AST 的遍历，维护了整棵树的状态，并且负责替换、移除和添加节点</li><li><a href="https://github.com/babel/babel/tree/master/packages/@babel/generate" target="_blank" rel="noopener noreferrer">@babel/generate</a> 可以把AST生成源码，同时生成sourcemap</li><li><a href="https://github.com/babel/babel/tree/master/packages/babel-types" target="_blank" rel="noopener noreferrer">@babel/types</a> 用于 AST 节点的 Lodash 式工具库, 它包含了构造、验证以及变换 AST 节点的方法，对编写处理 AST 逻辑非常有用</li><li><a href="https://www.npmjs.com/package/@babel/template" target="_blank" rel="noopener noreferrer">@babel/template</a>可以简化AST的创建逻辑</li><li><a href="https://www.npmjs.com/package/@babel/code-frame" target="_blank" rel="noopener noreferrer">@babel/code-frame</a>可以打印代码位置</li><li><a href="https://www.npmjs.com/package/@babel/core" target="_blank" rel="noopener noreferrer">@babel/core</a> Babel 的编译器，核心 API 都在这里面，比如常见的 transform、parse,并实现了插件功能</li><li><a href="https://www.npmjs.com/package/babylon" target="_blank" rel="noopener noreferrer">babylon</a> Babel 的解析器，以前叫babel parser,是基于acorn扩展而来，扩展了很多语法,可以支持es2020、jsx、typescript等语法</li><li><a href="https://babeljs.io/docs/en/next/babel-types.html" target="_blank" rel="noopener noreferrer">babel-types-api</a></li><li>[Babel 插件手册](https://github.com/brigand/babel-plugin-handbook/blob/master/translations/zh-Hans/README.md</li><li><a href="https://babeljs.io/en/repl.html" target="_blank" rel="noopener noreferrer">babeljs.io</a> babel 可视化编译器</li><li><a href="https://babeljs.io/docs/en/babel-types" target="_blank" rel="noopener noreferrer">babel-types</a></li><li>[类型别名](https://github.com/babel/babel/blob/main/packages/babel-types/src/ast-types/generated/index.ts</li><li><a href="https://github.com/DefinitelyTyped/DefinitelyTyped/tree/master/types" target="_blank" rel="noopener noreferrer">DefinitelyTyped</a></li></ul><h3 id="_5-3-visitor" tabindex="-1"><a class="header-anchor" href="#_5-3-visitor"><span>5.3 Visitor</span></a></h3><ul><li>访问者模式 Visitor 对于某个对象或者一组对象，不同的访问者，产生的结果不同，执行操作也不同</li><li>Visitor 的对象定义了用于 AST 中获取具体节点的方法</li><li>Visitor 上挂载以节点 <code>type</code> 命名的方法，当遍历 AST 的时候，如果匹配上 type，就会执行对应的方法</li></ul><h4 id="_5-3-1-path" tabindex="-1"><a class="header-anchor" href="#_5-3-1-path"><span>5.3.1 path</span></a></h4><ul><li><a href="https://github.com/babel/babel/blob/main/packages/babel-traverse/src/path/index.ts" target="_blank" rel="noopener noreferrer">path</a></li><li>node 当前 AST 节点</li><li>parent 父 AST 节点</li><li>parentPath 父AST节点的路径</li><li>scope 作用域</li><li>get(key) 获取某个属性的 path</li><li>set(key, node) 设置某个属性</li><li>is类型(opts) 判断当前节点是否是某个类型</li><li>find(callback) 从当前节点一直向上找到根节点(包括自己)</li><li>findParent(callback)从当前节点一直向上找到根节点(不包括自己)</li><li>insertBefore(nodes) 在之前插入节点</li><li>insertAfter(nodes) 在之后插入节点</li><li>replaceWith(replacement) 用某个节点替换当前节点</li><li>replaceWithMultiple(nodes) 用多个节点替换当前节点</li><li>replaceWithSourceString(replacement) 把源代码转成AST节点再替换当前节点</li><li>remove() 删除当前节点</li><li>traverse(visitor, state) 遍历当前节点的子节点,第1个参数是节点，第2个参数是用来传递数据的状态</li><li>skip() 跳过当前节点子节点的遍历</li><li>stop() 结束所有的遍历</li></ul><h4 id="_5-3-2-scope" tabindex="-1"><a class="header-anchor" href="#_5-3-2-scope"><span>5.3.2 scope</span></a></h4><ul><li><a href="https://github.com/babel/babel/blob/main/packages/babel-traverse/src/scope/index.ts" target="_blank" rel="noopener noreferrer">scope</a></li><li>scope.bindings 当前作用域内声明所有变量</li><li>scope.path 生成作用域的节点对应的路径</li><li>scope.references 所有的变量引用的路径</li><li>getAllBindings() 获取从当前作用域一直到根作用域的集合</li><li>getBinding(name) 从当前作用域到根使用域查找变量</li><li>getOwnBinding(name) 在当前作用域查找变量</li><li>parentHasBinding(name, noGlobals) 从当前父作用域到根使用域查找变量</li><li>removeBinding(name) 删除变量</li><li>hasBinding(name, noGlobals) 判断是否包含变量</li><li>moveBindingTo(name, scope) 把当前作用域的变量移动到其它作用域中</li><li>generateUid(name) 生成作用域中的唯一变量名,如果变量名被占用就在前面加下划线</li></ul><h3 id="_5-4-转换箭头函数" tabindex="-1"><a class="header-anchor" href="#_5-4-转换箭头函数"><span>5.4 转换箭头函数</span></a></h3><ul><li><a href="https://astexplorer.net/" target="_blank" rel="noopener noreferrer">astexplorer</a></li><li><a href="https://www.npmjs.com/package/babel-plugin-transform-es2015-arrow-functions" target="_blank" rel="noopener noreferrer">babel-plugin-transform-es2015-arrow-functions</a></li><li><a href="https://babeljs.io/en/repl.html" target="_blank" rel="noopener noreferrer">babeljs.io</a> babel 可视化编译器</li><li><a href="https://github.com/jamiebuilds/babel-handbook/blob/master/translations/zh-Hans/README.md" target="_blank" rel="noopener noreferrer">babel-handbook</a></li><li><a href="https://babeljs.io/docs/en/next/babel-types.html" target="_blank" rel="noopener noreferrer">babel-types-api</a></li></ul><p>转换前</p><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code class="language-javascript"><span class="line"><span class="token keyword">const</span> <span class="token function-variable function">sum</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">a<span class="token punctuation">,</span>b</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span></span>
<span class="line">    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">return</span> a<span class="token operator">+</span>b<span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>转换后</p><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code class="language-javascript"><span class="line"><span class="token keyword">var</span> _this <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">const</span> <span class="token function-variable function">sum</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">a<span class="token punctuation">,</span> b</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>_this<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">  <span class="token keyword">return</span> a <span class="token operator">+</span> b<span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text"><pre><code class="language-text"><span class="line">npm i @babel/core @babel/types -D</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p>实现</p><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code class="language-javascript"><span class="line"><span class="token comment">//babel核心模块</span></span>
<span class="line"><span class="token keyword">const</span> core <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&#39;@babel/core&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token comment">//用来生成或者判断节点的AST语法树的节点</span></span>
<span class="line"><span class="token keyword">let</span> types <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;@babel/types&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token comment">//let arrowFunctionPlugin = require(&#39;babel-plugin-transform-es2015-arrow-functions&#39;);</span></span>
<span class="line"><span class="token keyword">let</span> arrowFunctionPlugin <span class="token operator">=</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token literal-property property">visitor</span><span class="token operator">:</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token comment">//如果是箭头函数，那么就会进来此函数，参数是箭头函数的节点路径对象</span></span>
<span class="line">        <span class="token function">ArrowFunctionExpression</span><span class="token punctuation">(</span><span class="token parameter">path</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token keyword">let</span> <span class="token punctuation">{</span> node <span class="token punctuation">}</span> <span class="token operator">=</span> path<span class="token punctuation">;</span></span>
<span class="line">            <span class="token function">hoistFunctionEnvironment</span><span class="token punctuation">(</span>path<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">            node<span class="token punctuation">.</span>type <span class="token operator">=</span> <span class="token string">&#39;FunctionExpression&#39;</span><span class="token punctuation">;</span></span>
<span class="line">            <span class="token keyword">let</span> body <span class="token operator">=</span> node<span class="token punctuation">.</span>body<span class="token punctuation">;</span></span>
<span class="line">            <span class="token comment">//如果函数体不是语句块</span></span>
<span class="line">            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>types<span class="token punctuation">.</span><span class="token function">isBlockStatement</span><span class="token punctuation">(</span>body<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">                node<span class="token punctuation">.</span>body <span class="token operator">=</span> types<span class="token punctuation">.</span><span class="token function">blockStatement</span><span class="token punctuation">(</span><span class="token punctuation">[</span>types<span class="token punctuation">.</span><span class="token function">returnStatement</span><span class="token punctuation">(</span>body<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">            <span class="token punctuation">}</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"><span class="token doc-comment comment">/**</span>
<span class="line"> * 1.要在函数的外面声明一个_this变量，值是this</span>
<span class="line"> * 2.在函数的内容，换this 变成_this</span>
<span class="line"> * <span class="token keyword">@param</span> <span class="token class-name"><span class="token punctuation">{</span><span class="token operator">*</span><span class="token punctuation">}</span></span> <span class="token parameter">path</span> </span>
<span class="line"> */</span></span>
<span class="line"><span class="token keyword">function</span> <span class="token function">hoistFunctionEnvironment</span><span class="token punctuation">(</span><span class="token parameter">path</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token comment">//1.确定我要用哪里的this 向上找不是箭头函数的函数或者根节点</span></span>
<span class="line">    <span class="token keyword">const</span> thisEnv <span class="token operator">=</span> path<span class="token punctuation">.</span><span class="token function">findParent</span><span class="token punctuation">(</span><span class="token parameter">parent</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">return</span> <span class="token punctuation">(</span>parent<span class="token punctuation">.</span><span class="token function">isFunction</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>path<span class="token punctuation">.</span><span class="token function">isArrowFunctionExpression</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">||</span> parent<span class="token punctuation">.</span><span class="token function">isProgram</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">let</span> thisBindings <span class="token operator">=</span> <span class="token string">&#39;_this&#39;</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">let</span> thisPaths <span class="token operator">=</span> <span class="token function">getThisPaths</span><span class="token punctuation">(</span>path<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">if</span> <span class="token punctuation">(</span>thisPaths<span class="token punctuation">.</span>length<span class="token operator">&gt;</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token comment">//在thisEnv这个节点的作用域中添加一个变量 变量名为_this, 值 为this var _this = this;</span></span>
<span class="line">        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>thisEnv<span class="token punctuation">.</span>scope<span class="token punctuation">.</span><span class="token function">hasBinding</span><span class="token punctuation">(</span>thisBindings<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">            thisEnv<span class="token punctuation">.</span>scope<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token punctuation">{</span></span>
<span class="line">                <span class="token literal-property property">id</span><span class="token operator">:</span> types<span class="token punctuation">.</span><span class="token function">identifier</span><span class="token punctuation">(</span>thisBindings<span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line">                <span class="token literal-property property">init</span><span class="token operator">:</span> types<span class="token punctuation">.</span><span class="token function">thisExpression</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    thisPaths<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">thisPath</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token comment">//this=&gt;_this</span></span>
<span class="line">        thisPath<span class="token punctuation">.</span><span class="token function">replaceWith</span><span class="token punctuation">(</span>types<span class="token punctuation">.</span><span class="token function">identifier</span><span class="token punctuation">(</span>thisBindings<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"><span class="token keyword">function</span> <span class="token function">getThisPaths</span><span class="token punctuation">(</span><span class="token parameter">path</span><span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">let</span> thisPaths <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span></span>
<span class="line">    path<span class="token punctuation">.</span><span class="token function">traverse</span><span class="token punctuation">(</span><span class="token punctuation">{</span></span>
<span class="line">        <span class="token function">ThisExpression</span><span class="token punctuation">(</span><span class="token parameter">path</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">            thisPaths<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>path<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">return</span> thisPaths<span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"><span class="token keyword">let</span> sourceCode <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">\`</span><span class="token string"></span>
<span class="line">const sum = (a, b) =&gt; {</span>
<span class="line">    console.log(this);</span>
<span class="line">    const minus = (c,d)=&gt;{</span>
<span class="line">          console.log(this);</span>
<span class="line">        return c-d;</span>
<span class="line">    }</span>
<span class="line">    return a + b;</span>
<span class="line">}</span>
<span class="line"></span><span class="token template-punctuation string">\`</span></span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">let</span> targetSource <span class="token operator">=</span> core<span class="token punctuation">.</span><span class="token function">transform</span><span class="token punctuation">(</span>sourceCode<span class="token punctuation">,</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token literal-property property">plugins</span><span class="token operator">:</span> <span class="token punctuation">[</span>arrowFunctionPlugin<span class="token punctuation">]</span></span>
<span class="line"><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>targetSource<span class="token punctuation">.</span>code<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_5-5-把类编译为-function" tabindex="-1"><a class="header-anchor" href="#_5-5-把类编译为-function"><span>5.5 把类编译为 Function</span></a></h3><ul><li><a href="https://www.npmjs.com/package/@babel/plugin-transform-classes" target="_blank" rel="noopener noreferrer">@babel/plugin-transform-classes</a></li></ul><p>es6</p><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code class="language-javascript"><span class="line"><span class="token keyword">class</span> <span class="token class-name">Person</span> <span class="token punctuation">{</span></span>
<span class="line">  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter">name</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">this</span><span class="token punctuation">.</span>name <span class="token operator">=</span> name<span class="token punctuation">;</span></span>
<span class="line">  <span class="token punctuation">}</span></span>
<span class="line">  <span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>name<span class="token punctuation">;</span></span>
<span class="line">  <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><img src="http://img.zhufengpeixun.cn/classast.png" alt="classast"></p><p>es5</p><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code class="language-javascript"><span class="line"><span class="token keyword">function</span> <span class="token function">Person</span><span class="token punctuation">(</span><span class="token parameter">name</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">  <span class="token keyword">this</span><span class="token punctuation">.</span>name <span class="token operator">=</span> name<span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"><span class="token class-name">Person</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">getName</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">  <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>name<span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><img src="http://img.zhufengpeixun.cn/es5class1.png" alt="es5class1"> <img src="http://img.zhufengpeixun.cn/es5class2.png" alt="es5class2"></p><p>实现</p><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code class="language-javascript"><span class="line"><span class="token comment">//babel核心模块</span></span>
<span class="line"><span class="token keyword">const</span> core <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&#39;@babel/core&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token comment">//用来生成或者判断节点的AST语法树的节点</span></span>
<span class="line"><span class="token keyword">let</span> types <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;@babel/types&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token comment">//let transformClassesPlugin = require(&#39;@babel/plugin-transform-classes&#39;);</span></span>
<span class="line"><span class="token keyword">let</span> transformClassesPlugin <span class="token operator">=</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token literal-property property">visitor</span><span class="token operator">:</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token comment">//如果是箭头函数，那么就会进来此函数，参数是箭头函数的节点路径对象</span></span>
<span class="line">        <span class="token comment">//path代表路径，node代表路径上的节点</span></span>
<span class="line">        <span class="token function">ClassDeclaration</span><span class="token punctuation">(</span><span class="token parameter">path</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token keyword">let</span> node <span class="token operator">=</span> path<span class="token punctuation">.</span>node<span class="token punctuation">;</span></span>
<span class="line">            <span class="token keyword">let</span> id <span class="token operator">=</span> node<span class="token punctuation">.</span>id<span class="token punctuation">;</span><span class="token comment">//Identifier name:Person</span></span>
<span class="line">            <span class="token keyword">let</span> methods <span class="token operator">=</span> node<span class="token punctuation">.</span>body<span class="token punctuation">.</span>body<span class="token punctuation">;</span><span class="token comment">//Array&lt;MethodDefinition&gt;</span></span>
<span class="line">            <span class="token keyword">let</span> nodes <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span></span>
<span class="line">            methods<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">method</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></span>
<span class="line">                <span class="token keyword">if</span> <span class="token punctuation">(</span>method<span class="token punctuation">.</span>kind <span class="token operator">===</span> <span class="token string">&#39;constructor&#39;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">                    <span class="token keyword">let</span> constructorFunction <span class="token operator">=</span> types<span class="token punctuation">.</span><span class="token function">functionDeclaration</span><span class="token punctuation">(</span></span>
<span class="line">                        id<span class="token punctuation">,</span></span>
<span class="line">                        method<span class="token punctuation">.</span>params<span class="token punctuation">,</span></span>
<span class="line">                        method<span class="token punctuation">.</span>body</span>
<span class="line">                    <span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">                    nodes<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>constructorFunction<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span></span>
<span class="line">                    <span class="token keyword">let</span> memberExpression <span class="token operator">=</span> types<span class="token punctuation">.</span><span class="token function">memberExpression</span><span class="token punctuation">(</span></span>
<span class="line">                        types<span class="token punctuation">.</span><span class="token function">memberExpression</span><span class="token punctuation">(</span></span>
<span class="line">                            id<span class="token punctuation">,</span> types<span class="token punctuation">.</span><span class="token function">identifier</span><span class="token punctuation">(</span><span class="token string">&#39;prototype&#39;</span><span class="token punctuation">)</span></span>
<span class="line">                        <span class="token punctuation">)</span><span class="token punctuation">,</span> method<span class="token punctuation">.</span>key</span>
<span class="line">                    <span class="token punctuation">)</span></span>
<span class="line">                    <span class="token keyword">let</span> functionExpression <span class="token operator">=</span> types<span class="token punctuation">.</span><span class="token function">functionExpression</span><span class="token punctuation">(</span></span>
<span class="line">                        <span class="token keyword">null</span><span class="token punctuation">,</span></span>
<span class="line">                        method<span class="token punctuation">.</span>params<span class="token punctuation">,</span></span>
<span class="line">                        method<span class="token punctuation">.</span>body</span>
<span class="line">                    <span class="token punctuation">)</span></span>
<span class="line">                    <span class="token keyword">let</span> assignmentExpression <span class="token operator">=</span> types<span class="token punctuation">.</span><span class="token function">assignmentExpression</span><span class="token punctuation">(</span></span>
<span class="line">                        <span class="token string">&#39;=&#39;</span><span class="token punctuation">,</span></span>
<span class="line">                        memberExpression<span class="token punctuation">,</span></span>
<span class="line">                        functionExpression</span>
<span class="line">                    <span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">                    nodes<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>assignmentExpression<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">                <span class="token punctuation">}</span></span>
<span class="line">            <span class="token punctuation">}</span><span class="token punctuation">)</span></span>
<span class="line">            <span class="token keyword">if</span> <span class="token punctuation">(</span>nodes<span class="token punctuation">.</span>length <span class="token operator">===</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">                <span class="token comment">//单节点用replaceWith</span></span>
<span class="line">                <span class="token comment">//path代表路径，用nodes[0]这个新节点替换旧path上现有老节点node ClassDeclaration</span></span>
<span class="line">                path<span class="token punctuation">.</span><span class="token function">replaceWith</span><span class="token punctuation">(</span>nodes<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span></span>
<span class="line">                <span class="token comment">//多节点用replaceWithMultiple</span></span>
<span class="line">                path<span class="token punctuation">.</span><span class="token function">replaceWithMultiple</span><span class="token punctuation">(</span>nodes<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">            <span class="token punctuation">}</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"><span class="token keyword">let</span> sourceCode <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">\`</span><span class="token string"></span>
<span class="line">class Person{</span>
<span class="line">    constructor(name){</span>
<span class="line">        this.name = name;</span>
<span class="line">    }</span>
<span class="line">    sayName(){</span>
<span class="line">        console.log(this.name);</span>
<span class="line">    }</span>
<span class="line">}</span>
<span class="line"></span><span class="token template-punctuation string">\`</span></span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">let</span> targetSource <span class="token operator">=</span> core<span class="token punctuation">.</span><span class="token function">transform</span><span class="token punctuation">(</span>sourceCode<span class="token punctuation">,</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token literal-property property">plugins</span><span class="token operator">:</span> <span class="token punctuation">[</span>transformClassesPlugin<span class="token punctuation">]</span></span>
<span class="line"><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>targetSource<span class="token punctuation">.</span>code<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_5-6-实现日志插件" tabindex="-1"><a class="header-anchor" href="#_5-6-实现日志插件"><span>5.6 实现日志插件</span></a></h3><h4 id="_5-6-1-logger-js" tabindex="-1"><a class="header-anchor" href="#_5-6-1-logger-js"><span>5.6.1 logger.js</span></a></h4><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code class="language-javascript"><span class="line"><span class="token comment">//babel核心模块</span></span>
<span class="line"><span class="token keyword">const</span> core <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&#39;@babel/core&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token comment">//用来生成或者判断节点的AST语法树的节点</span></span>
<span class="line"><span class="token keyword">const</span> types <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;@babel/types&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">const</span> path <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&#39;path&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">const</span> visitor <span class="token operator">=</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token function">CallExpression</span><span class="token punctuation">(</span><span class="token parameter">nodePath<span class="token punctuation">,</span> state</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">const</span> <span class="token punctuation">{</span> node <span class="token punctuation">}</span> <span class="token operator">=</span> nodePath<span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">if</span> <span class="token punctuation">(</span>types<span class="token punctuation">.</span><span class="token function">isMemberExpression</span><span class="token punctuation">(</span>node<span class="token punctuation">.</span>callee<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token keyword">if</span> <span class="token punctuation">(</span>node<span class="token punctuation">.</span>callee<span class="token punctuation">.</span>object<span class="token punctuation">.</span>name <span class="token operator">===</span> <span class="token string">&#39;console&#39;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">&#39;log&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;info&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;warn&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;error&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;debug&#39;</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">includes</span><span class="token punctuation">(</span>node<span class="token punctuation">.</span>callee<span class="token punctuation">.</span>property<span class="token punctuation">.</span>name<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">                    <span class="token keyword">const</span> <span class="token punctuation">{</span> line<span class="token punctuation">,</span> column <span class="token punctuation">}</span> <span class="token operator">=</span> node<span class="token punctuation">.</span>loc<span class="token punctuation">.</span>start<span class="token punctuation">;</span></span>
<span class="line">                    <span class="token keyword">const</span> relativeFileName <span class="token operator">=</span> path<span class="token punctuation">.</span><span class="token function">relative</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> state<span class="token punctuation">.</span>file<span class="token punctuation">.</span>opts<span class="token punctuation">.</span>filename<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">\\\\</span><span class="token regex-delimiter">/</span><span class="token regex-flags">g</span></span><span class="token punctuation">,</span> <span class="token string">&#39;/&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">                    node<span class="token punctuation">.</span>arguments<span class="token punctuation">.</span><span class="token function">unshift</span><span class="token punctuation">(</span>types<span class="token punctuation">.</span><span class="token function">stringLiteral</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">\`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">\${</span>relativeFileName<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">\${</span>line<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">:</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">\${</span>column<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">\`</span></span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">                <span class="token punctuation">}</span></span>
<span class="line">            <span class="token punctuation">}</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line">module<span class="token punctuation">.</span><span class="token function-variable function">exports</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">return</span> <span class="token punctuation">{</span></span>
<span class="line">        visitor</span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"><span class="token comment">/* {</span>
<span class="line">    loc: {</span>
<span class="line">        start: { line: 1, column: 1 }</span>
<span class="line">    }</span>
<span class="line">} */</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_5-7-自动日志插件" tabindex="-1"><a class="header-anchor" href="#_5-7-自动日志插件"><span>5.7 自动日志插件</span></a></h3><ul><li><a href="https://babeljs.io/docs/en/babel-helper-plugin-utils" target="_blank" rel="noopener noreferrer">babel-helper-plugin-utils</a></li><li>[babel-types](https://babeljs.io/docs/en/babel-types.html</li><li><a href="https://babeljs.io/docs/en/babel-helper-module-imports" target="_blank" rel="noopener noreferrer">babel-helper-module-imports</a>帮助插入模块</li><li><a href="https://www.npmjs.com/package/@babel/template" target="_blank" rel="noopener noreferrer">@babel/template</a>根据字符串模板生成AST节点</li><li><code>state</code> 用于在遍历过程中在AST节点之间传递数据的方式</li></ul><h4 id="_5-7-1-use-js" tabindex="-1"><a class="header-anchor" href="#_5-7-1-use-js"><span>5.7.1 use.js</span></a></h4><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code class="language-javascript"><span class="line"><span class="token keyword">const</span> <span class="token punctuation">{</span> transformSync <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&#39;@babel/core&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">const</span> autoLoggerPlugin <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&#39;./auto-logger-plugin&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">const</span> sourceCode <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">\`</span><span class="token string"></span>
<span class="line">function sum(a,b){return a+b;}</span>
<span class="line">const multiply = function(a,b){return a*b;};</span>
<span class="line">const minus = (a,b)=&gt;a-b</span>
<span class="line">class Calculator{divide(a,b){return a/b}}</span>
<span class="line"></span><span class="token template-punctuation string">\`</span></span></span>
<span class="line"><span class="token keyword">const</span> <span class="token punctuation">{</span> code <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">transformSync</span><span class="token punctuation">(</span>sourceCode<span class="token punctuation">,</span> <span class="token punctuation">{</span></span>
<span class="line">  <span class="token literal-property property">plugins</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token function">autoLoggerPlugin</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token literal-property property">libName</span><span class="token operator">:</span> <span class="token string">&#39;logger&#39;</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">]</span></span>
<span class="line"><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>code<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_5-7-2-auto-logger-plugin" tabindex="-1"><a class="header-anchor" href="#_5-7-2-auto-logger-plugin"><span>5.7.2 auto-logger-plugin</span></a></h4><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code class="language-javascript"><span class="line"><span class="token keyword">const</span> importModule <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&#39;@babel/helper-module-imports&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">const</span> template <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&#39;@babel/template&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">const</span> types <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&#39;@babel/types&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">const</span> <span class="token function-variable function">autoLoggerPlugin</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">options</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">return</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token literal-property property">visitor</span><span class="token operator">:</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token literal-property property">Program</span><span class="token operator">:</span> <span class="token punctuation">{</span></span>
<span class="line">                <span class="token function">enter</span><span class="token punctuation">(</span><span class="token parameter">path<span class="token punctuation">,</span> state</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">                    <span class="token keyword">let</span> loggerId<span class="token punctuation">;</span></span>
<span class="line">                    path<span class="token punctuation">.</span><span class="token function">traverse</span><span class="token punctuation">(</span><span class="token punctuation">{</span></span>
<span class="line">                        <span class="token function">ImportDeclaration</span><span class="token punctuation">(</span><span class="token parameter">path</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">                            <span class="token keyword">const</span> libName <span class="token operator">=</span> path<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&#39;source&#39;</span><span class="token punctuation">)</span><span class="token punctuation">.</span>node<span class="token punctuation">.</span>value<span class="token punctuation">;</span></span>
<span class="line">                            <span class="token keyword">if</span> <span class="token punctuation">(</span>libName <span class="token operator">===</span> options<span class="token punctuation">.</span>libName<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">                                <span class="token keyword">const</span> specifierPath <span class="token operator">=</span> path<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&#39;specifiers.0&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">                                <span class="token comment">//import logger from &#39;logger&#39;</span></span>
<span class="line">                                <span class="token comment">//import { logger } from &#39;logger&#39;;</span></span>
<span class="line">                                <span class="token comment">//import * as logger from &#39;logger&#39;;</span></span>
<span class="line">                                <span class="token keyword">if</span> <span class="token punctuation">(</span>specifierPath<span class="token punctuation">.</span><span class="token function">isImportDefaultSpecifier</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">                                    <span class="token operator">||</span> specifierPath<span class="token punctuation">.</span><span class="token function">isImportSpecifier</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">                                    <span class="token operator">||</span> specifierPath<span class="token punctuation">.</span><span class="token function">isImportNamespaceSpecifier</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">                                    loggerId <span class="token operator">=</span> specifierPath<span class="token punctuation">.</span>local<span class="token punctuation">.</span>name<span class="token punctuation">;</span></span>
<span class="line">                                <span class="token punctuation">}</span></span>
<span class="line">                                path<span class="token punctuation">.</span><span class="token function">stop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">                            <span class="token punctuation">}</span></span>
<span class="line">                        <span class="token punctuation">}</span></span>
<span class="line">                    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">                    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>loggerId<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">                        loggerId <span class="token operator">=</span> importModule<span class="token punctuation">.</span><span class="token function">addDefault</span><span class="token punctuation">(</span>path<span class="token punctuation">,</span> <span class="token string">&#39;logger&#39;</span><span class="token punctuation">,</span> <span class="token punctuation">{</span></span>
<span class="line">                            <span class="token literal-property property">nameHint</span><span class="token operator">:</span> path<span class="token punctuation">.</span>scope<span class="token punctuation">.</span><span class="token function">generateUid</span><span class="token punctuation">(</span><span class="token string">&#39;logger&#39;</span><span class="token punctuation">)</span></span>
<span class="line">                        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span>name<span class="token punctuation">;</span></span>
<span class="line">                    <span class="token punctuation">}</span></span>
<span class="line">                    <span class="token comment">//state.loggerNode = types.expressionStatement(types.callExpression(types.identifier(loggerId), []));</span></span>
<span class="line">                    <span class="token comment">//state.loggerNode = template.statement(\`\${loggerId}();\`)();</span></span>
<span class="line">                    state<span class="token punctuation">.</span>loggerNode <span class="token operator">=</span> template<span class="token punctuation">.</span><span class="token function">statement</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">\`</span><span class="token string">LOGGER();</span><span class="token template-punctuation string">\`</span></span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">{</span></span>
<span class="line">                        <span class="token constant">LOGGER</span><span class="token operator">:</span> loggerId</span>
<span class="line">                    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">                <span class="token punctuation">}</span></span>
<span class="line">            <span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">            <span class="token string">&#39;FunctionExpression|FunctionDeclaration|ArrowFunctionExpression|ClassMethod&#39;</span><span class="token punctuation">(</span>path<span class="token punctuation">,</span> state<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">                <span class="token keyword">const</span> <span class="token punctuation">{</span> node <span class="token punctuation">}</span> <span class="token operator">=</span> path</span>
<span class="line">                <span class="token keyword">if</span> <span class="token punctuation">(</span>types<span class="token punctuation">.</span><span class="token function">isBlockStatement</span><span class="token punctuation">(</span>node<span class="token punctuation">.</span>body<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">                    node<span class="token punctuation">.</span>body<span class="token punctuation">.</span>body<span class="token punctuation">.</span><span class="token function">unshift</span><span class="token punctuation">(</span>state<span class="token punctuation">.</span>loggerNode<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span></span>
<span class="line">                    <span class="token keyword">const</span> newNode <span class="token operator">=</span> types<span class="token punctuation">.</span><span class="token function">blockStatement</span><span class="token punctuation">(</span><span class="token punctuation">[</span></span>
<span class="line">                        state<span class="token punctuation">.</span>loggerNode<span class="token punctuation">,</span></span>
<span class="line">                        types<span class="token punctuation">.</span><span class="token function">expressionStatement</span><span class="token punctuation">(</span>node<span class="token punctuation">.</span>body<span class="token punctuation">)</span></span>
<span class="line">                    <span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">                    path<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&#39;body&#39;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">replaceWith</span><span class="token punctuation">(</span>newNode<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">                <span class="token punctuation">}</span></span>
<span class="line">            <span class="token punctuation">}</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span><span class="token punctuation">;</span></span>
<span class="line">module<span class="token punctuation">.</span>exports <span class="token operator">=</span> autoLoggerPlugin<span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_5-8-eslint" tabindex="-1"><a class="header-anchor" href="#_5-8-eslint"><span>5.8 eslint</span></a></h3><ul><li><a href="//https://eslint.bootcss.com/docs/rules/" target="_blank" rel="noopener noreferrer">rules</a></li></ul><h4 id="_5-8-1-use-js" tabindex="-1"><a class="header-anchor" href="#_5-8-1-use-js"><span>5.8.1 use.js</span></a></h4><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code class="language-javascript"><span class="line"><span class="token keyword">const</span> <span class="token punctuation">{</span> transformSync <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&#39;@babel/core&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">const</span> eslintPlugin <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&#39;./eslintPlugin&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">const</span> sourceCode <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">\`</span><span class="token string"></span>
<span class="line">var a = 1;</span>
<span class="line">console.log(a);</span>
<span class="line">var b = 2;</span>
<span class="line"></span><span class="token template-punctuation string">\`</span></span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">const</span> <span class="token punctuation">{</span> code <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">transformSync</span><span class="token punctuation">(</span>sourceCode<span class="token punctuation">,</span> <span class="token punctuation">{</span></span>
<span class="line">  <span class="token literal-property property">plugins</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token function">eslintPlugin</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token literal-property property">fix</span><span class="token operator">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">]</span></span>
<span class="line"><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>code<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_5-8-2-eslintplugin-js" tabindex="-1"><a class="header-anchor" href="#_5-8-2-eslintplugin-js"><span>5.8.2 eslintPlugin.js</span></a></h4><p>eslintPlugin.js</p><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code class="language-javascript"><span class="line"><span class="token comment">//no-console 禁用 console</span></span>
<span class="line"><span class="token keyword">const</span> <span class="token function-variable function">eslintPlugin</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> fix <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></span>
<span class="line">  <span class="token keyword">return</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token function">pre</span><span class="token punctuation">(</span><span class="token parameter">file</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">      file<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token string">&#39;errors&#39;</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token literal-property property">visitor</span><span class="token operator">:</span> <span class="token punctuation">{</span></span>
<span class="line">      <span class="token function">CallExpression</span><span class="token punctuation">(</span><span class="token parameter">path<span class="token punctuation">,</span> state</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">const</span> errors <span class="token operator">=</span> state<span class="token punctuation">.</span>file<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&#39;errors&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">const</span> <span class="token punctuation">{</span> node <span class="token punctuation">}</span> <span class="token operator">=</span> path</span>
<span class="line">        <span class="token keyword">if</span> <span class="token punctuation">(</span>node<span class="token punctuation">.</span>callee<span class="token punctuation">.</span>object <span class="token operator">&amp;&amp;</span> node<span class="token punctuation">.</span>callee<span class="token punctuation">.</span>object<span class="token punctuation">.</span>name <span class="token operator">===</span> <span class="token string">&#39;console&#39;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">          <span class="token comment">//const tmp = Error.stackTraceLimit;//可以修改堆栈信息的深度，默认为10</span></span>
<span class="line">          <span class="token comment">//Error.stackTraceLimit = 0;</span></span>
<span class="line">          errors<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>path<span class="token punctuation">.</span><span class="token function">buildCodeFrameError</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">\`</span><span class="token string">代码中不能出现console语句</span><span class="token template-punctuation string">\`</span></span><span class="token punctuation">,</span> Error<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">          <span class="token comment">//Error.stackTraceLimit = tmp;</span></span>
<span class="line">          <span class="token keyword">if</span> <span class="token punctuation">(</span>fix<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">            path<span class="token punctuation">.</span>parentPath<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">          <span class="token punctuation">}</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">      <span class="token punctuation">}</span></span>
<span class="line">    <span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token function">post</span><span class="token punctuation">(</span><span class="token parameter">file</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token operator">...</span>file<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&#39;errors&#39;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">  <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span><span class="token punctuation">;</span></span>
<span class="line">module<span class="token punctuation">.</span>exports <span class="token operator">=</span> eslintPlugin<span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_5-9-uglify" tabindex="-1"><a class="header-anchor" href="#_5-9-uglify"><span>5.9 uglify</span></a></h3><h4 id="_5-9-1-use-js" tabindex="-1"><a class="header-anchor" href="#_5-9-1-use-js"><span>5.9.1 use.js</span></a></h4><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code class="language-javascript"><span class="line"><span class="token keyword">const</span> <span class="token punctuation">{</span> transformSync <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&#39;@babel/core&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">const</span> uglifyPlugin <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&#39;./uglifyPlugin&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">const</span> sourceCode <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">\`</span><span class="token string"></span>
<span class="line">function getAge(){</span>
<span class="line">  var age = 12;</span>
<span class="line">  console.log(age);</span>
<span class="line">  var name = &#39;&#39;;</span>
<span class="line">  console.log(name);</span>
<span class="line">}</span>
<span class="line"></span><span class="token template-punctuation string">\`</span></span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">const</span> <span class="token punctuation">{</span> code <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">transformSync</span><span class="token punctuation">(</span>sourceCode<span class="token punctuation">,</span> <span class="token punctuation">{</span></span>
<span class="line">  <span class="token literal-property property">plugins</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token function">uglifyPlugin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span></span>
<span class="line"><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>code<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_5-9-2-uglifyplugin-js" tabindex="-1"><a class="header-anchor" href="#_5-9-2-uglifyplugin-js"><span>5.9.2 uglifyPlugin.js</span></a></h4><ul><li><ul><li>[类型别名](https://github.com/babel/babel/blob/main/packages/babel-types/src/ast-types/generated/index.ts</li></ul></li></ul><p>uglifyPlugin.js</p><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code class="language-javascript"><span class="line"><span class="token keyword">const</span> <span class="token function-variable function">uglifyPlugin</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></span>
<span class="line">  <span class="token keyword">return</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token literal-property property">visitor</span><span class="token operator">:</span> <span class="token punctuation">{</span></span>
<span class="line">      <span class="token function">Scopable</span><span class="token punctuation">(</span><span class="token parameter">path</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        Object<span class="token punctuation">.</span><span class="token function">entries</span><span class="token punctuation">(</span>path<span class="token punctuation">.</span>scope<span class="token punctuation">.</span>bindings<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">[</span>key<span class="token punctuation">,</span> binding<span class="token punctuation">]</span></span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></span>
<span class="line">          <span class="token keyword">const</span> newName <span class="token operator">=</span> path<span class="token punctuation">.</span>scope<span class="token punctuation">.</span><span class="token function">generateUid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">          binding<span class="token punctuation">.</span>path<span class="token punctuation">.</span>scope<span class="token punctuation">.</span><span class="token function">rename</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> newName<span class="token punctuation">)</span></span>
<span class="line">        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">      <span class="token punctuation">}</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">  <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span><span class="token punctuation">;</span></span>
<span class="line">module<span class="token punctuation">.</span>exports <span class="token operator">=</span> uglifyPlugin<span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="_6-webpack中使用babel插件" tabindex="-1"><a class="header-anchor" href="#_6-webpack中使用babel插件"><span>6. webpack中使用babel插件</span></a></h2><h3 id="_6-1-实现按需加载" tabindex="-1"><a class="header-anchor" href="#_6-1-实现按需加载"><span>6.1 实现按需加载</span></a></h3><ul><li>[lodashjs](https://www.lodashjs.com/docs/4.17.5.html</li><li><a href="https://babeljs.io/docs/en/babel-core" target="_blank" rel="noopener noreferrer">babel-core</a></li><li><a href="https://www.npmjs.com/package/babel-plugin-import" target="_blank" rel="noopener noreferrer">babel-plugin-import</a></li></ul><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code class="language-javascript"><span class="line"><span class="token keyword">import</span> <span class="token punctuation">{</span> flatten<span class="token punctuation">,</span> concat <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;lodash&quot;</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p><img src="http://img.zhufengpeixun.cn/treeshakingleft.png" alt="treeshakingleft"></p><p>转换为</p><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code class="language-javascript"><span class="line"><span class="token keyword">import</span> flatten <span class="token keyword">from</span> <span class="token string">&quot;lodash/flatten&quot;</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">import</span> concat <span class="token keyword">from</span> <span class="token string">&quot;lodash/flatten&quot;</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div></div></div><p><img src="http://img.zhufengpeixun.cn/treeshakingright.png" alt="treeshakingright"></p><h4 id="_6-1-1-webpack-配置" tabindex="-1"><a class="header-anchor" href="#_6-1-1-webpack-配置"><span>6.1.1 webpack 配置</span></a></h4><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code class="language-javascript"><span class="line">npm i webpack webpack<span class="token operator">-</span>cli babel<span class="token operator">-</span>plugin<span class="token operator">-</span><span class="token keyword">import</span> <span class="token operator">-</span><span class="token constant">D</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code class="language-javascript"><span class="line"><span class="token keyword">const</span> path <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;path&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span></span>
<span class="line">  <span class="token literal-property property">mode</span><span class="token operator">:</span> <span class="token string">&quot;development&quot;</span><span class="token punctuation">,</span></span>
<span class="line">  <span class="token literal-property property">entry</span><span class="token operator">:</span> <span class="token string">&quot;./src/index.js&quot;</span><span class="token punctuation">,</span></span>
<span class="line">  <span class="token literal-property property">output</span><span class="token operator">:</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token literal-property property">path</span><span class="token operator">:</span> path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token string">&quot;dist&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token literal-property property">filename</span><span class="token operator">:</span> <span class="token string">&quot;bundle.js&quot;</span><span class="token punctuation">,</span></span>
<span class="line">  <span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">  <span class="token literal-property property">module</span><span class="token operator">:</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token literal-property property">rules</span><span class="token operator">:</span> <span class="token punctuation">[</span></span>
<span class="line">      <span class="token punctuation">{</span></span>
<span class="line">        <span class="token literal-property property">test</span><span class="token operator">:</span> <span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">\\.js$</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">,</span></span>
<span class="line">        <span class="token literal-property property">use</span><span class="token operator">:</span> <span class="token punctuation">{</span></span>
<span class="line">          <span class="token literal-property property">loader</span><span class="token operator">:</span> <span class="token string">&quot;babel-loader&quot;</span><span class="token punctuation">,</span></span>
<span class="line">          <span class="token literal-property property">options</span><span class="token operator">:</span><span class="token punctuation">{</span></span>
<span class="line">                   <span class="token literal-property property">plugins</span><span class="token operator">:</span><span class="token punctuation">[</span></span>
<span class="line">                     <span class="token punctuation">[</span></span>
<span class="line">                       path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span><span class="token string">&#39;plugins/babel-plugin-import.js&#39;</span><span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line">                       <span class="token punctuation">{</span></span>
<span class="line">                         <span class="token literal-property property">libraryName</span><span class="token operator">:</span><span class="token string">&#39;lodash&#39;</span></span>
<span class="line">                       <span class="token punctuation">}</span></span>
<span class="line">                     <span class="token punctuation">]</span></span>
<span class="line">                   <span class="token punctuation">]</span></span>
<span class="line">                <span class="token punctuation">}</span></span>
<span class="line">        <span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">      <span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token punctuation">]</span><span class="token punctuation">,</span></span>
<span class="line">  <span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line"><span class="token punctuation">}</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><blockquote><p>编译顺序为首先<code>plugins</code>从左往右,然后<code>presets</code>从右往左</p></blockquote><h4 id="_6-1-2-babel-插件" tabindex="-1"><a class="header-anchor" href="#_6-1-2-babel-插件"><span>6.1.2 babel 插件</span></a></h4><p>plugins\\babel-plugin-import.js</p><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code class="language-javascript"><span class="line"><span class="token comment">//babel核心模块</span></span>
<span class="line"><span class="token keyword">const</span> core <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&#39;@babel/core&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token comment">//用来生成或者判断节点的AST语法树的节点</span></span>
<span class="line"><span class="token keyword">let</span> types <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;@babel/types&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">const</span> visitor <span class="token operator">=</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token function">ImportDeclaration</span><span class="token punctuation">(</span><span class="token parameter">path<span class="token punctuation">,</span> state</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">const</span> <span class="token punctuation">{</span> node <span class="token punctuation">}</span> <span class="token operator">=</span> path<span class="token punctuation">;</span><span class="token comment">//获取节点</span></span>
<span class="line">        <span class="token keyword">const</span> <span class="token punctuation">{</span> specifiers <span class="token punctuation">}</span> <span class="token operator">=</span> node<span class="token punctuation">;</span><span class="token comment">//获取批量导入声明数组</span></span>
<span class="line">        <span class="token keyword">const</span> <span class="token punctuation">{</span> libraryName<span class="token punctuation">,</span> libraryDirectory <span class="token operator">=</span> <span class="token string">&#39;lib&#39;</span> <span class="token punctuation">}</span> <span class="token operator">=</span> state<span class="token punctuation">.</span>opts<span class="token punctuation">;</span><span class="token comment">//获取选项中的支持的库的名称</span></span>
<span class="line">        <span class="token comment">//如果当前的节点的模块名称是我们需要的库的名称</span></span>
<span class="line">        <span class="token keyword">if</span> <span class="token punctuation">(</span>node<span class="token punctuation">.</span>source<span class="token punctuation">.</span>value <span class="token operator">===</span> libraryName</span>
<span class="line">            <span class="token comment">//并且导入不是默认导入才会进来</span></span>
<span class="line">            <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>types<span class="token punctuation">.</span><span class="token function">isImportDefaultSpecifier</span><span class="token punctuation">(</span>specifiers<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token comment">//遍历批量导入声明数组</span></span>
<span class="line">            <span class="token keyword">const</span> declarations <span class="token operator">=</span> specifiers<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token parameter">specifier</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></span>
<span class="line">                <span class="token comment">//返回一个importDeclaration节点</span></span>
<span class="line">                <span class="token keyword">return</span> types<span class="token punctuation">.</span><span class="token function">importDeclaration</span><span class="token punctuation">(</span></span>
<span class="line">                    <span class="token comment">//导入声明importDefaultSpecifier flatten</span></span>
<span class="line">                    <span class="token punctuation">[</span>types<span class="token punctuation">.</span><span class="token function">importDefaultSpecifier</span><span class="token punctuation">(</span>specifier<span class="token punctuation">.</span>local<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">,</span></span>
<span class="line">                    <span class="token comment">//导入模块source lodash/flatten</span></span>
<span class="line">                    types<span class="token punctuation">.</span><span class="token function">stringLiteral</span><span class="token punctuation">(</span>libraryDirectory <span class="token operator">?</span> <span class="token template-string"><span class="token template-punctuation string">\`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">\${</span>libraryName<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">/</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">\${</span>libraryDirectory<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">/</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">\${</span>specifier<span class="token punctuation">.</span>imported<span class="token punctuation">.</span>name<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">\`</span></span> <span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">\`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">\${</span>libraryName<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">/</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">\${</span>specifier<span class="token punctuation">.</span>imported<span class="token punctuation">.</span>name<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">\`</span></span><span class="token punctuation">)</span></span>
<span class="line">                <span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">            <span class="token punctuation">}</span><span class="token punctuation">)</span></span>
<span class="line">            path<span class="token punctuation">.</span><span class="token function">replaceWithMultiple</span><span class="token punctuation">(</span>declarations<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//替换当前节点</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line">module<span class="token punctuation">.</span><span class="token function-variable function">exports</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">return</span> <span class="token punctuation">{</span></span>
<span class="line">        visitor</span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="_7-参考" tabindex="-1"><a class="header-anchor" href="#_7-参考"><span>7. 参考</span></a></h2><ul><li>[Babel 插件手册](https://github.com/brigand/babel-plugin-handbook/blob/master/translations/zh-Hans/README.md</li><li><a href="https://github.com/babel/babel/tree/master/packages/babel-types" target="_blank" rel="noopener noreferrer">babel-types</a></li><li><a href="https://astexplorer.net/" target="_blank" rel="noopener noreferrer">不同的 parser 解析 js 代码后得到的 AST</a></li><li><a href="http://resources.jointjs.com/demos/javascript-ast" target="_blank" rel="noopener noreferrer">在线可视化的看到 AST</a></li><li><a href="https://zhuanlan.zhihu.com/p/28143410" target="_blank" rel="noopener noreferrer">babel 从入门到入门的知识归纳</a></li><li><a href="https://octman.com/blog/2016-08-27-babel-notes/" target="_blank" rel="noopener noreferrer">Babel 内部原理分析</a></li><li><a href="https://github.com/chikara-chan/babel-plugin-react-scope-binding" target="_blank" rel="noopener noreferrer">babel-plugin-react-scope-binding</a></li><li><a href="https://www.npmjs.com/package/babel-plugin-transform-runtime" target="_blank" rel="noopener noreferrer">transform-runtime</a> Babel 默认只转换新的 JavaScript 语法，而不转换新的 API。例如，Iterator、Generator、Set、Maps、Proxy、Reflect、Symbol、Promise 等全局对象，以及一些定义在全局对象上的方法（比如 Object.assign）都不会转译,启用插件 <code>babel-plugin-transform-runtime</code> 后，Babel 就会使用 babel-runtime 下的工具函数</li><li><a href="https://github.com/babel/babylon/blob/master/ast/spec.md" target="_blank" rel="noopener noreferrer">ast-spec</a></li><li><a href="https://github.com/jamiebuilds/babel-handbook/blob/master/translations/zh-Hans/README.md" target="_blank" rel="noopener noreferrer">babel-handbook</a></li></ul><h2 id="_5-9-tsc" tabindex="-1"><a class="header-anchor" href="#_5-9-tsc"><span>5.9 tsc</span></a></h2><h3 id="_5-9-1-use-js-1" tabindex="-1"><a class="header-anchor" href="#_5-9-1-use-js-1"><span>5.9.1 use.js</span></a></h3><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code class="language-javascript"><span class="line"><span class="token keyword">const</span> <span class="token punctuation">{</span> transformSync <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&#39;@babel/core&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">const</span> tscCheckPlugin <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&#39;./tscCheckPlugin&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">const</span> sourceCode <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">\`</span><span class="token string"></span>
<span class="line">var age:number=&quot;12&quot;;</span>
<span class="line"></span><span class="token template-punctuation string">\`</span></span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">const</span> <span class="token punctuation">{</span> code <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">transformSync</span><span class="token punctuation">(</span>sourceCode<span class="token punctuation">,</span> <span class="token punctuation">{</span></span>
<span class="line">  <span class="token literal-property property">parserOpts</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token literal-property property">plugins</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">&#39;typescript&#39;</span><span class="token punctuation">]</span> <span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">  <span class="token literal-property property">plugins</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token function">tscCheckPlugin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span></span>
<span class="line"><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>code<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_5-9-2-tsccheckplugin-js" tabindex="-1"><a class="header-anchor" href="#_5-9-2-tsccheckplugin-js"><span>5.9.2 tscCheckPlugin.js</span></a></h3><p>tscCheckPlugin.js</p><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code class="language-javascript"><span class="line"><span class="token keyword">const</span> TypeAnnotationMap <span class="token operator">=</span> <span class="token punctuation">{</span></span>
<span class="line">  <span class="token literal-property property">TSNumberKeyword</span><span class="token operator">:</span> <span class="token string">&quot;NumericLiteral&quot;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"><span class="token keyword">const</span> <span class="token function-variable function">eslintPlugin</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></span>
<span class="line">  <span class="token keyword">return</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token function">pre</span><span class="token punctuation">(</span><span class="token parameter">file</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">      file<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token string">&#39;errors&#39;</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token literal-property property">visitor</span><span class="token operator">:</span> <span class="token punctuation">{</span></span>
<span class="line">      <span class="token function">VariableDeclarator</span><span class="token punctuation">(</span><span class="token parameter">path<span class="token punctuation">,</span> state</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">const</span> errors <span class="token operator">=</span> state<span class="token punctuation">.</span>file<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&#39;errors&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">const</span> <span class="token punctuation">{</span> node <span class="token punctuation">}</span> <span class="token operator">=</span> path<span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">const</span> idType <span class="token operator">=</span> TypeAnnotationMap<span class="token punctuation">[</span>node<span class="token punctuation">.</span>id<span class="token punctuation">.</span>typeAnnotation<span class="token punctuation">.</span>typeAnnotation<span class="token punctuation">.</span>type<span class="token punctuation">]</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">const</span> initType <span class="token operator">=</span> node<span class="token punctuation">.</span>init<span class="token punctuation">.</span>type<span class="token punctuation">;</span></span>
<span class="line">        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>idType<span class="token punctuation">,</span> initType<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">if</span> <span class="token punctuation">(</span>idType <span class="token operator">!==</span> initType<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">          errors<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>path<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&#39;init&#39;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">buildCodeFrameError</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">\`</span><span class="token string">无法把</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">\${</span>initType<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">类型赋值给</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">\${</span>idType<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">类型</span><span class="token template-punctuation string">\`</span></span><span class="token punctuation">,</span> Error<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">      <span class="token punctuation">}</span></span>
<span class="line">    <span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token function">post</span><span class="token punctuation">(</span><span class="token parameter">file</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token operator">...</span>file<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&#39;errors&#39;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">  <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span><span class="token punctuation">;</span></span>
<span class="line">module<span class="token punctuation">.</span>exports <span class="token operator">=</span> eslintPlugin<span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_5-9-3-赋值" tabindex="-1"><a class="header-anchor" href="#_5-9-3-赋值"><span>5.9.3 赋值</span></a></h3><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code class="language-javascript"><span class="line"><span class="token keyword">const</span> babel <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&#39;@babel/core&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">function</span> <span class="token function">transformType</span><span class="token punctuation">(</span><span class="token parameter">type</span><span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">switch</span><span class="token punctuation">(</span>type<span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">case</span> <span class="token string">&#39;TSNumberKeyword&#39;</span><span class="token operator">:</span></span>
<span class="line">        <span class="token keyword">case</span> <span class="token string">&#39;NumberTypeAnnotation&#39;</span><span class="token operator">:</span></span>
<span class="line">            <span class="token keyword">return</span> <span class="token string">&#39;number&#39;</span></span>
<span class="line">        <span class="token keyword">case</span> <span class="token string">&#39;TSStringKeyword&#39;</span><span class="token operator">:</span></span>
<span class="line">        <span class="token keyword">case</span> <span class="token string">&#39;StringTypeAnnotation&#39;</span><span class="token operator">:</span></span>
<span class="line">            <span class="token keyword">return</span> <span class="token string">&#39;string&#39;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"><span class="token keyword">const</span> <span class="token function-variable function">tscCheckPlugin</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">return</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token function">pre</span><span class="token punctuation">(</span><span class="token parameter">file</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">            file<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token string">&#39;errors&#39;</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">        <span class="token literal-property property">visitor</span><span class="token operator">:</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token function">AssignmentExpression</span><span class="token punctuation">(</span><span class="token parameter">path<span class="token punctuation">,</span>state</span><span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line">              <span class="token keyword">const</span> errors <span class="token operator">=</span> state<span class="token punctuation">.</span>file<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&#39;errors&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">              <span class="token keyword">const</span> variable <span class="token operator">=</span> path<span class="token punctuation">.</span>scope<span class="token punctuation">.</span><span class="token function">getBinding</span><span class="token punctuation">(</span>path<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&#39;left&#39;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">              <span class="token keyword">const</span> variableAnnotation <span class="token operator">=</span> variable<span class="token punctuation">.</span>path<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&#39;id&#39;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getTypeAnnotation</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">              <span class="token keyword">const</span> variableType <span class="token operator">=</span> <span class="token function">transformType</span><span class="token punctuation">(</span>variableAnnotation<span class="token punctuation">.</span>typeAnnotation<span class="token punctuation">.</span>type<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">              <span class="token keyword">const</span> valueType <span class="token operator">=</span> <span class="token function">transformType</span><span class="token punctuation">(</span>path<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&#39;right&#39;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getTypeAnnotation</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>type<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">              <span class="token keyword">if</span> <span class="token punctuation">(</span>variableType <span class="token operator">!==</span> valueType<span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line">                  Error<span class="token punctuation">.</span>stackTraceLimit <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span></span>
<span class="line">                  errors<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span></span>
<span class="line">                      path<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&#39;init&#39;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">buildCodeFrameError</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">\`</span><span class="token string">无法把</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">\${</span>valueType<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">赋值给</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">\${</span>variableType<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">\`</span></span><span class="token punctuation">,</span> Error<span class="token punctuation">)</span></span>
<span class="line">                  <span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">              <span class="token punctuation">}</span>  </span>
<span class="line">            <span class="token punctuation">}</span></span>
<span class="line">        <span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">        <span class="token function">post</span><span class="token punctuation">(</span><span class="token parameter">file</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">            console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token operator">...</span>file<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&#39;errors&#39;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">let</span> sourceCode <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">\`</span><span class="token string"></span>
<span class="line">  var age:number;</span>
<span class="line">  age = &quot;12&quot;;</span>
<span class="line"></span><span class="token template-punctuation string">\`</span></span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">const</span> result <span class="token operator">=</span> babel<span class="token punctuation">.</span><span class="token function">transform</span><span class="token punctuation">(</span>sourceCode<span class="token punctuation">,</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token literal-property property">parserOpts</span><span class="token operator">:</span><span class="token punctuation">{</span><span class="token literal-property property">plugins</span><span class="token operator">:</span><span class="token punctuation">[</span><span class="token string">&#39;typescript&#39;</span><span class="token punctuation">]</span><span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token literal-property property">plugins</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token function">tscCheckPlugin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span></span>
<span class="line"><span class="token punctuation">}</span><span class="token punctuation">)</span></span>
<span class="line">console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>result<span class="token punctuation">.</span>code<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_5-9-4-泛型" tabindex="-1"><a class="header-anchor" href="#_5-9-4-泛型"><span>5.9.4 泛型</span></a></h3><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code class="language-javascript"><span class="line"><span class="token keyword">const</span> babel <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&#39;@babel/core&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">function</span> <span class="token function">transformType</span><span class="token punctuation">(</span><span class="token parameter">type</span><span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">switch</span><span class="token punctuation">(</span>type<span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">case</span> <span class="token string">&#39;TSNumberKeyword&#39;</span><span class="token operator">:</span></span>
<span class="line">        <span class="token keyword">case</span> <span class="token string">&#39;NumberTypeAnnotation&#39;</span><span class="token operator">:</span></span>
<span class="line">            <span class="token keyword">return</span> <span class="token string">&#39;number&#39;</span></span>
<span class="line">        <span class="token keyword">case</span> <span class="token string">&#39;TSStringKeyword&#39;</span><span class="token operator">:</span></span>
<span class="line">        <span class="token keyword">case</span> <span class="token string">&#39;StringTypeAnnotation&#39;</span><span class="token operator">:</span></span>
<span class="line">            <span class="token keyword">return</span> <span class="token string">&#39;string&#39;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"><span class="token keyword">const</span> <span class="token function-variable function">tscCheckPlugin</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">return</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token function">pre</span><span class="token punctuation">(</span><span class="token parameter">file</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">            file<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token string">&#39;errors&#39;</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">        <span class="token literal-property property">visitor</span><span class="token operator">:</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token function">CallExpression</span><span class="token punctuation">(</span><span class="token parameter">path<span class="token punctuation">,</span>state</span><span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line">              <span class="token keyword">const</span> errors <span class="token operator">=</span> state<span class="token punctuation">.</span>file<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&#39;errors&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">              <span class="token keyword">const</span> trueTypes <span class="token operator">=</span> path<span class="token punctuation">.</span>node<span class="token punctuation">.</span>typeParameters<span class="token punctuation">.</span>params<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token parameter">param</span><span class="token operator">=&gt;</span><span class="token function">transformType</span><span class="token punctuation">(</span>param<span class="token punctuation">.</span>type<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">              <span class="token keyword">const</span> argumentsTypes <span class="token operator">=</span> path<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&#39;arguments&#39;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token parameter">arg</span><span class="token operator">=&gt;</span><span class="token function">transformType</span><span class="token punctuation">(</span>arg<span class="token punctuation">.</span><span class="token function">getTypeAnnotation</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>type<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">              <span class="token keyword">const</span> calleePath <span class="token operator">=</span> path<span class="token punctuation">.</span>scope<span class="token punctuation">.</span><span class="token function">getBinding</span><span class="token punctuation">(</span>path<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&#39;callee&#39;</span><span class="token punctuation">)</span><span class="token punctuation">.</span>node<span class="token punctuation">.</span>name<span class="token punctuation">)</span><span class="token punctuation">.</span>path<span class="token punctuation">;</span></span>
<span class="line">              <span class="token keyword">const</span> genericMap<span class="token operator">=</span><span class="token keyword">new</span> <span class="token class-name">Map</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  </span>
<span class="line">              calleePath<span class="token punctuation">.</span>node<span class="token punctuation">.</span>typeParameters<span class="token punctuation">.</span>params<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">item<span class="token punctuation">,</span> index</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></span>
<span class="line">                genericMap<span class="token punctuation">[</span>item<span class="token punctuation">.</span>name<span class="token punctuation">]</span> <span class="token operator">=</span> trueTypes<span class="token punctuation">[</span>index<span class="token punctuation">]</span><span class="token punctuation">;</span></span>
<span class="line">              <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">              <span class="token keyword">const</span> paramsTypes <span class="token operator">=</span>  calleePath<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&#39;params&#39;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token parameter">arg</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span></span>
<span class="line">                <span class="token keyword">const</span> typeAnnotation <span class="token operator">=</span> arg<span class="token punctuation">.</span><span class="token function">getTypeAnnotation</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>typeAnnotation<span class="token punctuation">;</span></span>
<span class="line">                <span class="token keyword">if</span><span class="token punctuation">(</span>typeAnnotation<span class="token punctuation">.</span>type <span class="token operator">===</span> <span class="token string">&#39;TSTypeReference&#39;</span><span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line">                    <span class="token keyword">return</span> genericMap<span class="token punctuation">[</span>typeAnnotation<span class="token punctuation">.</span>typeName<span class="token punctuation">.</span>name<span class="token punctuation">]</span><span class="token punctuation">;</span></span>
<span class="line">                <span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{</span></span>
<span class="line">                    <span class="token keyword">return</span> <span class="token function">transformType</span><span class="token punctuation">(</span>type<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">                <span class="token punctuation">}</span></span>
<span class="line">              <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">              Error<span class="token punctuation">.</span>stackTraceLimit <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span></span>
<span class="line">              paramsTypes<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">type<span class="token punctuation">,</span>index</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span></span>
<span class="line">                  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>type<span class="token punctuation">,</span>argumentsTypes<span class="token punctuation">[</span>index<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">                <span class="token keyword">if</span><span class="token punctuation">(</span>type <span class="token operator">!==</span> argumentsTypes<span class="token punctuation">[</span>index<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line">                    errors<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span></span>
<span class="line">                        path<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">\`</span><span class="token string">arguments.</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">\${</span>index<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">\`</span></span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">buildCodeFrameError</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">\`</span><span class="token string">实参</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">\${</span>argumentsTypes<span class="token punctuation">[</span>index<span class="token punctuation">]</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">不能匹配形参</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">\${</span>type<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">\`</span></span><span class="token punctuation">,</span> Error<span class="token punctuation">)</span></span>
<span class="line">                    <span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">                <span class="token punctuation">}</span></span>
<span class="line">              <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span> </span>
<span class="line">            <span class="token punctuation">}</span></span>
<span class="line">        <span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">        <span class="token function">post</span><span class="token punctuation">(</span><span class="token parameter">file</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">            console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token operator">...</span>file<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&#39;errors&#39;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">let</span> sourceCode <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">\`</span><span class="token string"></span>
<span class="line">  function join&lt;T&gt;(a:T,b:T):string{</span>
<span class="line">      return a+b;</span>
<span class="line">  }</span>
<span class="line">  join&lt;number&gt;(1,&#39;2&#39;);</span>
<span class="line"></span><span class="token template-punctuation string">\`</span></span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">const</span> result <span class="token operator">=</span> babel<span class="token punctuation">.</span><span class="token function">transform</span><span class="token punctuation">(</span>sourceCode<span class="token punctuation">,</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token literal-property property">parserOpts</span><span class="token operator">:</span><span class="token punctuation">{</span><span class="token literal-property property">plugins</span><span class="token operator">:</span><span class="token punctuation">[</span><span class="token string">&#39;typescript&#39;</span><span class="token punctuation">]</span><span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token literal-property property">plugins</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token function">tscCheckPlugin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span></span>
<span class="line"><span class="token punctuation">}</span><span class="token punctuation">)</span></span>
<span class="line">console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>result<span class="token punctuation">.</span>code<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_5-9-5-类型别名" tabindex="-1"><a class="header-anchor" href="#_5-9-5-类型别名"><span>5.9.5 类型别名</span></a></h3><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code class="language-javascript"><span class="line"><span class="token keyword">const</span> babel <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&#39;@babel/core&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">function</span> <span class="token function">transformType</span><span class="token punctuation">(</span><span class="token parameter">type</span><span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">switch</span><span class="token punctuation">(</span>type<span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">case</span> <span class="token string">&#39;TSNumberKeyword&#39;</span><span class="token operator">:</span></span>
<span class="line">        <span class="token keyword">case</span> <span class="token string">&#39;NumberTypeAnnotation&#39;</span><span class="token operator">:</span></span>
<span class="line">            <span class="token keyword">return</span> <span class="token string">&#39;number&#39;</span></span>
<span class="line">        <span class="token keyword">case</span> <span class="token string">&#39;TSStringKeyword&#39;</span><span class="token operator">:</span></span>
<span class="line">        <span class="token keyword">case</span> <span class="token string">&#39;StringTypeAnnotation&#39;</span><span class="token operator">:</span></span>
<span class="line">            <span class="token keyword">return</span> <span class="token string">&#39;string&#39;</span></span>
<span class="line">        <span class="token keyword">case</span> <span class="token string">&#39;TSLiteralType&#39;</span><span class="token operator">:</span></span>
<span class="line">            <span class="token keyword">return</span> <span class="token string">&#39;liternal&#39;</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">default</span><span class="token operator">:</span></span>
<span class="line">        <span class="token keyword">return</span> type<span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"><span class="token keyword">const</span> <span class="token function-variable function">tscCheckPlugin</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">return</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token function">pre</span><span class="token punctuation">(</span><span class="token parameter">file</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">            file<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token string">&#39;errors&#39;</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">        <span class="token literal-property property">visitor</span><span class="token operator">:</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token function">TSTypeAliasDeclaration</span><span class="token punctuation">(</span><span class="token parameter">path</span><span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line">                <span class="token keyword">const</span> typeName  <span class="token operator">=</span> path<span class="token punctuation">.</span>node<span class="token punctuation">.</span>id<span class="token punctuation">.</span>name<span class="token punctuation">;</span></span>
<span class="line">                <span class="token keyword">const</span> typeInfo <span class="token operator">=</span> <span class="token punctuation">{</span></span>
<span class="line">                    <span class="token literal-property property">typeParams</span><span class="token operator">:</span>path<span class="token punctuation">.</span>node<span class="token punctuation">.</span>typeParameters<span class="token punctuation">.</span>params<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token parameter">item</span> <span class="token operator">=&gt;</span>item<span class="token punctuation">.</span>name<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token comment">//[&#39;K&#39;]</span></span>
<span class="line">                    <span class="token literal-property property">typeAnnotation</span><span class="token operator">:</span>path<span class="token punctuation">.</span><span class="token function">getTypeAnnotation</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token comment">//{checkType,extendsType,trueType,falseType}</span></span>
<span class="line">                <span class="token punctuation">}</span></span>
<span class="line">                path<span class="token punctuation">.</span>scope<span class="token punctuation">.</span><span class="token function">setData</span><span class="token punctuation">(</span>typeName<span class="token punctuation">,</span>typeInfo<span class="token punctuation">)</span></span>
<span class="line">            <span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">            <span class="token function">CallExpression</span><span class="token punctuation">(</span><span class="token parameter">path<span class="token punctuation">,</span>state</span><span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line">              <span class="token keyword">const</span> errors <span class="token operator">=</span> state<span class="token punctuation">.</span>file<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&#39;errors&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">              <span class="token keyword">const</span> trueTypes <span class="token operator">=</span> path<span class="token punctuation">.</span>node<span class="token punctuation">.</span>typeParameters<span class="token punctuation">.</span>params<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token parameter">param</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span></span>
<span class="line">               <span class="token comment">//TSTypeReference   typeName=Infer  typeParameters=[]</span></span>
<span class="line">                <span class="token keyword">if</span><span class="token punctuation">(</span>param<span class="token punctuation">.</span>type <span class="token operator">===</span> <span class="token string">&#39;TSTypeReference&#39;</span><span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line">                    <span class="token keyword">const</span> name <span class="token operator">=</span> param<span class="token punctuation">.</span>typeName<span class="token punctuation">.</span>name<span class="token punctuation">;</span><span class="token comment">//Infer</span></span>
<span class="line">                    <span class="token keyword">const</span> <span class="token punctuation">{</span>typeParams<span class="token punctuation">,</span>typeAnnotation<span class="token punctuation">}</span> <span class="token operator">=</span> path<span class="token punctuation">.</span>scope<span class="token punctuation">.</span><span class="token function">getData</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//typeParams=[&#39;K&#39;]</span></span>
<span class="line">                    <span class="token keyword">const</span> trueTypeParams <span class="token operator">=</span> typeParams<span class="token punctuation">.</span><span class="token function">reduce</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">memo<span class="token punctuation">,</span> name<span class="token punctuation">,</span> index</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></span>
<span class="line">                        memo<span class="token punctuation">[</span>name<span class="token punctuation">]</span> <span class="token operator">=</span> param<span class="token punctuation">.</span>typeParameters<span class="token punctuation">.</span>params<span class="token punctuation">[</span>index<span class="token punctuation">]</span><span class="token punctuation">.</span>type<span class="token punctuation">;</span><span class="token comment">//TSLiteralType</span></span>
<span class="line">                        <span class="token keyword">return</span> memo<span class="token punctuation">;</span></span>
<span class="line">                    <span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//trueTypeParams={K:&#39;TSLiteralType&#39;}</span></span>
<span class="line">                    <span class="token keyword">const</span> <span class="token punctuation">{</span>checkType<span class="token punctuation">,</span>extendsType<span class="token punctuation">,</span>trueType<span class="token punctuation">,</span>falseType<span class="token punctuation">}</span> <span class="token operator">=</span> typeAnnotation<span class="token punctuation">;</span></span>
<span class="line">                    <span class="token keyword">let</span> check<span class="token operator">=</span>checkType<span class="token punctuation">.</span>type<span class="token punctuation">;</span></span>
<span class="line">                    <span class="token keyword">if</span><span class="token punctuation">(</span>check <span class="token operator">===</span> <span class="token string">&#39;TSTypeReference&#39;</span><span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line">                        check <span class="token operator">=</span> trueTypeParams<span class="token punctuation">[</span>checkType<span class="token punctuation">.</span>typeName<span class="token punctuation">.</span>name<span class="token punctuation">]</span></span>
<span class="line">                    <span class="token punctuation">}</span></span>
<span class="line">                    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">transformType</span><span class="token punctuation">(</span>check<span class="token punctuation">)</span> <span class="token operator">===</span> <span class="token function">transformType</span><span class="token punctuation">(</span>extendsType<span class="token punctuation">.</span>type<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">                        <span class="token keyword">return</span> <span class="token function">transformType</span><span class="token punctuation">(</span>trueType<span class="token punctuation">.</span>type<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">                    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span></span>
<span class="line">                        <span class="token keyword">return</span> <span class="token function">transformType</span><span class="token punctuation">(</span>falseType<span class="token punctuation">.</span>type<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">                    <span class="token punctuation">}</span></span>
<span class="line">                <span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{</span></span>
<span class="line">                    <span class="token keyword">return</span>  <span class="token function">transformType</span><span class="token punctuation">(</span>param<span class="token punctuation">.</span>type<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">                <span class="token punctuation">}</span></span>
<span class="line">              <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">              <span class="token keyword">const</span> argumentsTypes <span class="token operator">=</span> path<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&#39;arguments&#39;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token parameter">arg</span><span class="token operator">=&gt;</span><span class="token function">transformType</span><span class="token punctuation">(</span>arg<span class="token punctuation">.</span><span class="token function">getTypeAnnotation</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>type<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">              <span class="token keyword">const</span> calleePath <span class="token operator">=</span> path<span class="token punctuation">.</span>scope<span class="token punctuation">.</span><span class="token function">getBinding</span><span class="token punctuation">(</span>path<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&#39;callee&#39;</span><span class="token punctuation">)</span><span class="token punctuation">.</span>node<span class="token punctuation">.</span>name<span class="token punctuation">)</span><span class="token punctuation">.</span>path<span class="token punctuation">;</span></span>
<span class="line">              <span class="token keyword">const</span> genericMap<span class="token operator">=</span><span class="token keyword">new</span> <span class="token class-name">Map</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  </span>
<span class="line">              calleePath<span class="token punctuation">.</span>node<span class="token punctuation">.</span>typeParameters<span class="token punctuation">.</span>params<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">item<span class="token punctuation">,</span> index</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></span>
<span class="line">                genericMap<span class="token punctuation">[</span>item<span class="token punctuation">.</span>name<span class="token punctuation">]</span> <span class="token operator">=</span> trueTypes<span class="token punctuation">[</span>index<span class="token punctuation">]</span><span class="token punctuation">;</span></span>
<span class="line">              <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">              <span class="token keyword">const</span> paramsTypes <span class="token operator">=</span>  calleePath<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&#39;params&#39;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token parameter">arg</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span></span>
<span class="line">                <span class="token keyword">const</span> typeAnnotation <span class="token operator">=</span> arg<span class="token punctuation">.</span><span class="token function">getTypeAnnotation</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>typeAnnotation<span class="token punctuation">;</span></span>
<span class="line">                <span class="token keyword">if</span><span class="token punctuation">(</span>typeAnnotation<span class="token punctuation">.</span>type <span class="token operator">===</span> <span class="token string">&#39;TSTypeReference&#39;</span><span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line">                    <span class="token keyword">return</span> genericMap<span class="token punctuation">[</span>typeAnnotation<span class="token punctuation">.</span>typeName<span class="token punctuation">.</span>name<span class="token punctuation">]</span><span class="token punctuation">;</span></span>
<span class="line">                <span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{</span></span>
<span class="line">                    <span class="token keyword">return</span> <span class="token function">transformType</span><span class="token punctuation">(</span>type<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">                <span class="token punctuation">}</span></span>
<span class="line">              <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">              Error<span class="token punctuation">.</span>stackTraceLimit <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span></span>
<span class="line">              paramsTypes<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">type<span class="token punctuation">,</span>index</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span></span>
<span class="line">                <span class="token keyword">if</span><span class="token punctuation">(</span>type <span class="token operator">!==</span> argumentsTypes<span class="token punctuation">[</span>index<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line">                    errors<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span></span>
<span class="line">                        path<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">\`</span><span class="token string">arguments.</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">\${</span>index<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">\`</span></span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">buildCodeFrameError</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">\`</span><span class="token string">实参</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">\${</span>argumentsTypes<span class="token punctuation">[</span>index<span class="token punctuation">]</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">不能匹配形参</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">\${</span>type<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">\`</span></span><span class="token punctuation">,</span> Error<span class="token punctuation">)</span></span>
<span class="line">                    <span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">                <span class="token punctuation">}</span></span>
<span class="line">              <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span> </span>
<span class="line">            <span class="token punctuation">}</span></span>
<span class="line">        <span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">        <span class="token function">post</span><span class="token punctuation">(</span><span class="token parameter">file</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">            console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token operator">...</span>file<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&#39;errors&#39;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">let</span> sourceCode <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">\`</span><span class="token string"></span>
<span class="line">    type Infer&lt;K&gt; = K extends &#39;number&#39; ? number : string;</span>
<span class="line">    function sum&lt;T&gt;(a: T, b: T) {</span>
<span class="line"></span>
<span class="line">    }</span>
<span class="line">    sum&lt;Infer&lt;&#39;number&#39;&gt;&gt;(1, 2);</span>
<span class="line"></span><span class="token template-punctuation string">\`</span></span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">const</span> result <span class="token operator">=</span> babel<span class="token punctuation">.</span><span class="token function">transform</span><span class="token punctuation">(</span>sourceCode<span class="token punctuation">,</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token literal-property property">parserOpts</span><span class="token operator">:</span><span class="token punctuation">{</span><span class="token literal-property property">plugins</span><span class="token operator">:</span><span class="token punctuation">[</span><span class="token string">&#39;typescript&#39;</span><span class="token punctuation">]</span><span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token literal-property property">plugins</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token function">tscCheckPlugin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span></span>
<span class="line"><span class="token punctuation">}</span><span class="token punctuation">)</span></span>
<span class="line">console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>result<span class="token punctuation">.</span>code<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div>`,100)])])}const i=s(e,[["render",o]]),u=JSON.parse('{"path":"/strong/103.3.webpack-ast.html","title":"","lang":"en-US","frontmatter":{},"git":{"updatedTime":1681290319000,"contributors":[{"name":"yutao","username":"yutao","email":"642231346@qq.com","commits":1,"url":"https://github.com/yutao"}],"changelog":[{"hash":"f5ab8c9d34991ec274f7f652439afe5b2afb6147","time":1681290319000,"email":"642231346@qq.com","author":"yutao","message":"modify"}]},"filePathRelative":"strong/103.3.webpack-ast.md"}');export{i as comp,u as data};
