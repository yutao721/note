import{_ as s,c as a,a as p,o as t}from"./app-CD1YpnS1.js";const e={};function o(c,n){return t(),a("div",null,[...n[0]||(n[0]=[p(`<h2 id="_1-初始化项目" tabindex="-1"><a class="header-anchor" href="#_1-初始化项目"><span>1.初始化项目</span></a></h2><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text"><pre><code class="language-text"><span class="line">create-react-app zhufeng_react5</span>
<span class="line">cd zhufeng_react5</span>
<span class="line">cnpm i jquery -S</span>
<span class="line">npm start</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="_2-渲染文本" tabindex="-1"><a class="header-anchor" href="#_2-渲染文本"><span>2. 渲染文本</span></a></h2><h3 id="_2-1-渲染效果" tabindex="-1"><a class="header-anchor" href="#_2-1-渲染效果"><span>2.1 渲染效果</span></a></h3><p><img src="http://img.zhufengpeixun.cn/1.initrenderhtml.png" alt="initrenderhtml"></p><h3 id="_2-2-实现" tabindex="-1"><a class="header-anchor" href="#_2-2-实现"><span>2.2 实现</span></a></h3><h4 id="_2-2-1-index-js" tabindex="-1"><a class="header-anchor" href="#_2-2-1-index-js"><span>2.2.1 index.js</span></a></h4><p>src\\index.js</p><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code class="language-javascript"><span class="line"><span class="token keyword">import</span> React <span class="token keyword">from</span> <span class="token string">&#39;./react&#39;</span><span class="token punctuation">;</span></span>
<span class="line">React<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span><span class="token string">&#39;hello&#39;</span><span class="token punctuation">,</span>document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">&#39;root&#39;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_2-2-2-react-js" tabindex="-1"><a class="header-anchor" href="#_2-2-2-react-js"><span>2.2.2 react.js</span></a></h4><p>src\\react.js</p><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code class="language-javascript"><span class="line"><span class="token keyword">import</span> $ <span class="token keyword">from</span> <span class="token string">&#39;jquery&#39;</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">let</span> React <span class="token operator">=</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token literal-property property">rootIndex</span><span class="token operator">:</span><span class="token number">0</span><span class="token punctuation">,</span></span>
<span class="line">    render</span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"><span class="token keyword">function</span> <span class="token function">render</span><span class="token punctuation">(</span><span class="token parameter">element<span class="token punctuation">,</span>container</span><span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line">   container<span class="token punctuation">.</span>innerHTML <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">\`</span><span class="token string">&lt;span data-reactid=&quot;</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">\${</span>React<span class="token punctuation">.</span>rootIndex<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&quot;&gt;</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">\${</span>element<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&lt;/span&gt;</span><span class="token template-punctuation string">\`</span></span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">export</span> <span class="token keyword">default</span> React<span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="_3-重构" tabindex="-1"><a class="header-anchor" href="#_3-重构"><span>3. 重构</span></a></h2><h3 id="_3-2-类图" tabindex="-1"><a class="header-anchor" href="#_3-2-类图"><span>3.2 类图</span></a></h3><p><img src="http://img.zhufengpeixun.cn/2.rendertext.jpg" alt="2.rendertext"></p><h3 id="_3-3-实现" tabindex="-1"><a class="header-anchor" href="#_3-3-实现"><span>3.3 实现</span></a></h3><h4 id="_3-3-1-index-js" tabindex="-1"><a class="header-anchor" href="#_3-3-1-index-js"><span>3.3.1 index.js</span></a></h4><p>src\\index.js</p><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code class="language-javascript"><span class="line"><span class="token keyword">import</span> React <span class="token keyword">from</span> <span class="token string">&#39;./react&#39;</span><span class="token punctuation">;</span></span>
<span class="line">React<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span><span class="token string">&#39;hello&#39;</span><span class="token punctuation">,</span>document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">&#39;root&#39;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_3-3-2-react-index-js" tabindex="-1"><a class="header-anchor" href="#_3-3-2-react-index-js"><span>3.3.2 react\\index.js</span></a></h4><p>src\\react\\index.js</p><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code class="language-javascript"><span class="line"><span class="token keyword">import</span> $ <span class="token keyword">from</span> <span class="token string">&#39;jquery&#39;</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">import</span> <span class="token punctuation">{</span>createUnit<span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&#39;./unit&#39;</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">let</span> React <span class="token operator">=</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token literal-property property">rootIndex</span><span class="token operator">:</span><span class="token number">0</span><span class="token punctuation">,</span></span>
<span class="line">    render</span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"><span class="token keyword">function</span> <span class="token function">render</span><span class="token punctuation">(</span><span class="token parameter">element<span class="token punctuation">,</span>container</span><span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line">   <span class="token keyword">let</span> unit <span class="token operator">=</span> <span class="token function">createUnit</span><span class="token punctuation">(</span>element<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">   <span class="token keyword">let</span> markup <span class="token operator">=</span> unit<span class="token punctuation">.</span><span class="token function">getMarkUp</span><span class="token punctuation">(</span>React<span class="token punctuation">.</span>rootIndex<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">   <span class="token function">$</span><span class="token punctuation">(</span>container<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">html</span><span class="token punctuation">(</span>markup<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">   <span class="token function">$</span><span class="token punctuation">(</span>document<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">trigger</span><span class="token punctuation">(</span><span class="token string">&#39;mounted&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//componentDidMount</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">export</span> <span class="token keyword">default</span> React<span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_3-3-3-react-unit-js" tabindex="-1"><a class="header-anchor" href="#_3-3-3-react-unit-js"><span>3.3.3 react\\unit.js</span></a></h4><p>src\\react\\unit.js</p><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code class="language-javascript"><span class="line"><span class="token keyword">class</span> <span class="token class-name">Unit</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter">element</span><span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">this</span><span class="token punctuation">.</span>_currentElement <span class="token operator">=</span> element<span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    <span class="token function">getMarkUp</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">&#39;不能调用此方法&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"><span class="token keyword">class</span> <span class="token class-name">TextUnit</span> <span class="token keyword">extends</span> <span class="token class-name">Unit</span><span class="token punctuation">{</span></span>
<span class="line">    <span class="token function">getMarkUp</span><span class="token punctuation">(</span><span class="token parameter">reactid</span><span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line">         <span class="token keyword">this</span><span class="token punctuation">.</span>_reactid <span class="token operator">=</span> reactid<span class="token punctuation">;</span><span class="token comment">//保存记录rootId</span></span>
<span class="line">        <span class="token comment">//返回文本节点对应的HTML字符串</span></span>
<span class="line">        <span class="token keyword">return</span> <span class="token template-string"><span class="token template-punctuation string">\`</span><span class="token string">&lt;span data-reactid=&quot;</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">\${</span>reactid<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&quot;&gt;</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">\${</span><span class="token keyword">this</span><span class="token punctuation">.</span>_currentElement<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&lt;/span&gt;</span><span class="token template-punctuation string">\`</span></span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">function</span> <span class="token function">createUnit</span><span class="token punctuation">(</span><span class="token parameter">element</span><span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line">  <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token keyword">typeof</span> element <span class="token operator">==</span><span class="token string">&#39;string&#39;</span> <span class="token operator">||</span> <span class="token keyword">typeof</span> element <span class="token operator">==</span><span class="token string">&#39;number&#39;</span><span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line">      <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">TextUnit</span><span class="token punctuation">(</span>element<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">  <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">export</span> <span class="token punctuation">{</span></span>
<span class="line">    createUnit</span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="_4-渲染原生dom组件" tabindex="-1"><a class="header-anchor" href="#_4-渲染原生dom组件"><span>4. 渲染原生DOM组件</span></a></h2><ul><li><a href="//https://babeljs.io/repl/" target="_blank" rel="noopener noreferrer">babeljs</a></li></ul><h3 id="_4-1-渲染效果" tabindex="-1"><a class="header-anchor" href="#_4-1-渲染效果"><span>4.1 渲染效果</span></a></h3><p><img src="http://img.zhufengpeixun.cn/3.renderdom.png" alt="renderdom"></p><h3 id="_4-2-类图" tabindex="-1"><a class="header-anchor" href="#_4-2-类图"><span>4.2 类图</span></a></h3><p><img src="http://img.zhufengpeixun.cn/3. rendernativeunit.jpg" alt="20rendernativeunit"></p><h3 id="_4-3-jsx语法" tabindex="-1"><a class="header-anchor" href="#_4-3-jsx语法"><span>4.3 JSX语法</span></a></h3><p><img src="http://img.zhufengpeixun.cn/2.compile.png" alt="compile"></p><h4 id="_4-3-1-jsx" tabindex="-1"><a class="header-anchor" href="#_4-3-1-jsx"><span>4.3.1 JSX</span></a></h4><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code class="language-javascript"><span class="line"><span class="token operator">&lt;</span>button id<span class="token operator">=</span><span class="token string">&quot;sayHello&quot;</span> onClick<span class="token operator">=</span><span class="token punctuation">{</span>sayHello<span class="token punctuation">}</span><span class="token operator">&gt;</span>say<span class="token operator">&lt;</span>b style<span class="token operator">=</span><span class="token punctuation">{</span><span class="token punctuation">{</span><span class="token literal-property property">color</span><span class="token operator">:</span><span class="token string">&#39;red&#39;</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token operator">&gt;</span>Hello<span class="token operator">&lt;</span><span class="token operator">/</span>b<span class="token operator">&gt;</span><span class="token operator">&lt;</span><span class="token operator">/</span>button<span class="token operator">&gt;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><h4 id="_4-3-2-javascript" tabindex="-1"><a class="header-anchor" href="#_4-3-2-javascript"><span>4.3.2 JavaScript</span></a></h4><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code class="language-javascript"><span class="line"><span class="token keyword">let</span> element <span class="token operator">=</span> React<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">&quot;button&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token literal-property property">id</span><span class="token operator">:</span> <span class="token string">&quot;sayHello&quot;</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token literal-property property">onClick</span><span class="token operator">:</span> sayHello</span>
<span class="line">  <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token string">&quot;say&quot;</span><span class="token punctuation">,</span> React<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">&quot;b&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">{</span><span class="token literal-property property">style</span><span class="token operator">:</span><span class="token punctuation">{</span><span class="token literal-property property">color</span><span class="token operator">:</span><span class="token string">&#39;red&#39;</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token string">&quot;Hello&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_4-4-实现" tabindex="-1"><a class="header-anchor" href="#_4-4-实现"><span>4.4 实现</span></a></h3><h4 id="_4-4-1-index-js" tabindex="-1"><a class="header-anchor" href="#_4-4-1-index-js"><span>4.4.1 index.js</span></a></h4><p>src/index.js</p><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code class="language-javascript"><span class="line"><span class="token keyword">import</span> React <span class="token keyword">from</span> <span class="token string">&#39;./react&#39;</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">function</span> <span class="token function">sayHello</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line">  <span class="token function">alert</span><span class="token punctuation">(</span><span class="token string">&#39;hello&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"><span class="token keyword">let</span> element <span class="token operator">=</span> React<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span></span>
<span class="line">    <span class="token string">&#39;button&#39;</span><span class="token punctuation">,</span><span class="token punctuation">{</span><span class="token literal-property property">id</span><span class="token operator">:</span><span class="token string">&#39;sayHello&#39;</span><span class="token punctuation">,</span><span class="token literal-property property">onClick</span><span class="token operator">:</span>sayHello<span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token string">&#39;say&#39;</span><span class="token punctuation">,</span></span>
<span class="line">    React<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">&#39;b&#39;</span><span class="token punctuation">,</span><span class="token punctuation">{</span><span class="token literal-property property">style</span><span class="token operator">:</span><span class="token punctuation">{</span><span class="token literal-property property">color</span><span class="token operator">:</span><span class="token string">&#39;green&#39;</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token string">&#39;hello&#39;</span><span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line"><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">React<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span>element<span class="token punctuation">,</span>document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">&#39;root&#39;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_4-4-2-react-index-js" tabindex="-1"><a class="header-anchor" href="#_4-4-2-react-index-js"><span>4.4.2 react/index.js</span></a></h4><p>src/react/index.js</p><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text"><pre><code class="language-text"><span class="line">import $ from &#39;jquery&#39;;</span>
<span class="line">import {createUnit} from &#39;./unit&#39;;</span>
<span class="line">+import {createElement} from &#39;./element&#39;;</span>
<span class="line">let React = {</span>
<span class="line">    rootIndex:0,</span>
<span class="line">    render,</span>
<span class="line">+    createElement</span>
<span class="line">}</span>
<span class="line">function render(element,container){</span>
<span class="line">   let unit = createUnit(element);</span>
<span class="line">   let markup = unit.getMarkUp(React.rootIndex);</span>
<span class="line">   $(container).html(markup);</span>
<span class="line">   $(document).trigger(&#39;mounted&#39;);//componentDidMount</span>
<span class="line">}</span>
<span class="line"></span>
<span class="line">export default React;</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_4-4-3-react-element-js" tabindex="-1"><a class="header-anchor" href="#_4-4-3-react-element-js"><span>4.4.3 react/element.js</span></a></h4><p>src/react/element.js</p><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code class="language-javascript"><span class="line"><span class="token keyword">class</span> <span class="token class-name">Element</span><span class="token punctuation">{</span></span>
<span class="line">    <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter">type<span class="token punctuation">,</span>props</span><span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">this</span><span class="token punctuation">.</span>type <span class="token operator">=</span> type<span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">this</span><span class="token punctuation">.</span>props <span class="token operator">=</span> props<span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"><span class="token keyword">function</span> <span class="token function">createElement</span><span class="token punctuation">(</span><span class="token parameter">type<span class="token punctuation">,</span>props<span class="token punctuation">,</span><span class="token operator">...</span>children</span><span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line">    props<span class="token operator">=</span>props<span class="token operator">||</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span></span>
<span class="line">    props<span class="token punctuation">.</span>children  <span class="token operator">=</span> children<span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Element</span><span class="token punctuation">(</span>type<span class="token punctuation">,</span>props<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">export</span> <span class="token punctuation">{</span></span>
<span class="line">    createElement</span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_4-4-4-react-unit-js" tabindex="-1"><a class="header-anchor" href="#_4-4-4-react-unit-js"><span>4.4.4 react/unit.js</span></a></h4><p>src/react/unit.js</p><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text"><pre><code class="language-text"><span class="line">+import {Element} from &#39;./element&#39;;</span>
<span class="line">+import $ from &#39;jquery&#39;;</span>
<span class="line">class Unit {</span>
<span class="line">    constructor(element){</span>
<span class="line">        this._currentElement = element;</span>
<span class="line">    }</span>
<span class="line">    getMarkUp(){</span>
<span class="line">        throw new Error(&#39;不能调用此方法&#39;);</span>
<span class="line">    }</span>
<span class="line">}</span>
<span class="line">class TextUnit extends Unit{</span>
<span class="line">    getMarkUp(reactid){</span>
<span class="line">         this._reactid = reactid;//保存记录reactid</span>
<span class="line">        //返回文本节点对应的HTML字符串</span>
<span class="line">        return \`&lt;span data-reactid=&quot;\${reactid}&quot;&gt;\${this._currentElement}&lt;/span&gt;\`;</span>
<span class="line">    }</span>
<span class="line">}</span>
<span class="line">+class NativeUnit extends Unit {</span>
<span class="line">+     getMarkUp(reactid){</span>
<span class="line">+         this._reactid = reactid;//保存记录reactid</span>
<span class="line">+        //返回文本节点对应的HTML字符串</span>
<span class="line">+        let {type,props} = this._currentElement;</span>
<span class="line">+        let tagOpen = \`&lt;\${type} data-reactid=&quot;\${reactid}&quot; \`;</span>
<span class="line">+        let tagClose = \`&lt;/$type&gt;\`;</span>
<span class="line">+        let content = &#39;&#39;;</span>
<span class="line">+        for(let propName in props){</span>
<span class="line">+            if(/^on[A-Z]/.test(propName)){</span>
<span class="line">+                let eventName = propName.slice(2).toLowerCase();</span>
<span class="line">+                $(document).delegate(\`[data-reactid=&quot;\${reactid}&quot;]\`,\`\${eventName}.\${reactid}\`,props[propName]);</span>
<span class="line">+            }else if(propName === &#39;style&#39;){</span>
<span class="line">+                let styleObj = props[propName];</span>
<span class="line">+                let styles = Object.keys(styleObj).map(attr=&gt;\`\${attr}:\${styleObj[attr]}\`).join(&#39;;&#39;);</span>
<span class="line">+                tagOpen += (\` style=&quot;\${styles}&quot; \`);</span>
<span class="line">+            }else if (propName === &#39;children&#39;){</span>
<span class="line">+                let children = props.children||[];</span>
<span class="line">+                children.map((child,index)=&gt;{</span>
<span class="line">+                    let childUnit = createUnit(child);</span>
<span class="line">+                    let childMarkUp = childUnit.getMarkUp(\`\${reactid}.\${index}\`);</span>
<span class="line">+                    content += childMarkUp;</span>
<span class="line">+                });</span>
<span class="line">+            }else{</span>
<span class="line">+                tagOpen += \` \${propName}=\${props[propName]} \`;</span>
<span class="line">+            }</span>
<span class="line">+        }</span>
<span class="line">+        return tagOpen + &#39;&gt;&#39; + content + tagClose;</span>
<span class="line">+    }</span>
<span class="line">+}</span>
<span class="line">function createUnit(element){</span>
<span class="line">  if(typeof element ==&#39;string&#39; || typeof element ==&#39;number&#39;){</span>
<span class="line">      return new TextUnit(element);</span>
<span class="line">  }</span>
<span class="line">+  if(element instanceof Element &amp;&amp; typeof element.type === &#39;string&#39;){</span>
<span class="line">+      return new NativeUnit(element);</span>
<span class="line">+  }</span>
<span class="line">}</span>
<span class="line"></span>
<span class="line">export {</span>
<span class="line">    createUnit</span>
<span class="line">}</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="_5-渲染自定义组件" tabindex="-1"><a class="header-anchor" href="#_5-渲染自定义组件"><span>5. 渲染自定义组件</span></a></h2><h3 id="_5-1-渲染效果" tabindex="-1"><a class="header-anchor" href="#_5-1-渲染效果"><span>5.1 渲染效果</span></a></h3><p><img src="http://img.zhufengpeixun.cn/5.customercomponent.png" alt="customercomponent"></p><h3 id="_5-2-类图" tabindex="-1"><a class="header-anchor" href="#_5-2-类图"><span>5.2 类图</span></a></h3><p><img src="http://img.zhufengpeixun.cn/4. rendercustomerunit.jpg" alt="20rendercustomerunit"></p><h3 id="_5-3-实现" tabindex="-1"><a class="header-anchor" href="#_5-3-实现"><span>5.3 实现</span></a></h3><h4 id="_5-3-1-src-index-js" tabindex="-1"><a class="header-anchor" href="#_5-3-1-src-index-js"><span>5.3.1 src/index.js</span></a></h4><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code class="language-javascript"><span class="line"><span class="token keyword">import</span> React <span class="token keyword">from</span> <span class="token string">&#39;./react&#39;</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">class</span> <span class="token class-name">Counter</span> <span class="token keyword">extends</span> <span class="token class-name">React<span class="token punctuation">.</span>Component</span><span class="token punctuation">{</span></span>
<span class="line">  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter">props</span><span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">super</span><span class="token punctuation">(</span>props<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">this</span><span class="token punctuation">.</span>state <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token literal-property property">number</span><span class="token operator">:</span><span class="token number">0</span><span class="token punctuation">}</span><span class="token punctuation">;</span></span>
<span class="line">  <span class="token punctuation">}</span></span>
<span class="line">  <span class="token function">componentWillMount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line">    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&#39;Counter componentWillMount&#39;</span><span class="token punctuation">)</span></span>
<span class="line">  <span class="token punctuation">}</span></span>
<span class="line">  <span class="token function">componentDidMount</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">     console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&#39;Counter componentDidMount&#39;</span><span class="token punctuation">)</span></span>
<span class="line">  <span class="token punctuation">}</span></span>
<span class="line">  <span class="token function-variable function">handleClick</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">setState</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token literal-property property">number</span><span class="token operator">:</span><span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">.</span>number<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">  <span class="token punctuation">}</span></span>
<span class="line">  <span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">let</span> p <span class="token operator">=</span> React<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">&#39;p&#39;</span><span class="token punctuation">,</span><span class="token punctuation">{</span><span class="token literal-property property">style</span><span class="token operator">:</span><span class="token punctuation">{</span><span class="token literal-property property">color</span><span class="token operator">:</span><span class="token string">&#39;red&#39;</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">.</span>number<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">let</span> button <span class="token operator">=</span> React<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">&#39;button&#39;</span><span class="token punctuation">,</span><span class="token punctuation">{</span><span class="token literal-property property">onClick</span><span class="token operator">:</span><span class="token keyword">this</span><span class="token punctuation">.</span>handleClick<span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token string">&#39;+&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">return</span> React<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">&#39;div&#39;</span><span class="token punctuation">,</span><span class="token punctuation">{</span><span class="token literal-property property">id</span><span class="token operator">:</span><span class="token string">&#39;counter&#39;</span><span class="token punctuation">}</span><span class="token punctuation">,</span>p<span class="token punctuation">,</span>button<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">  <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"><span class="token keyword">let</span> element <span class="token operator">=</span> React<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span>Counter<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">React<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span>element<span class="token punctuation">,</span>document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">&#39;root&#39;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_5-3-2-react-index-js" tabindex="-1"><a class="header-anchor" href="#_5-3-2-react-index-js"><span>5.3.2 react/index.js</span></a></h4><p>src/react/index.js</p><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text"><pre><code class="language-text"><span class="line">import $ from &#39;jquery&#39;;</span>
<span class="line">import {createUnit} from &#39;./unit&#39;;</span>
<span class="line">import {createElement} from &#39;./element&#39;;</span>
<span class="line">+import {Component} from &#39;./component&#39;;</span>
<span class="line">let React = {</span>
<span class="line">    rootIndex:0,</span>
<span class="line">    render,</span>
<span class="line">    createElement,</span>
<span class="line">+    Component</span>
<span class="line">}</span>
<span class="line">function render(element,container){</span>
<span class="line">   let unit = createUnit(element);</span>
<span class="line">   let markup = unit.getMarkUp(React.rootIndex);</span>
<span class="line">   $(container).html(markup);</span>
<span class="line">   $(document).trigger(&#39;mounted&#39;);//componentDidMount</span>
<span class="line">}</span>
<span class="line"></span>
<span class="line">export default React;</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_5-3-3-react-component-js" tabindex="-1"><a class="header-anchor" href="#_5-3-3-react-component-js"><span>5.3.3 react/component.js</span></a></h4><p>src/react/component.js</p><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code class="language-javascript"><span class="line"><span class="token keyword">class</span> <span class="token class-name">Component</span><span class="token punctuation">{</span></span>
<span class="line">    <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter">props</span><span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">this</span><span class="token punctuation">.</span>props <span class="token operator">=</span> props<span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"><span class="token keyword">export</span> <span class="token punctuation">{</span>Component<span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_5-3-4-react-unit-js" tabindex="-1"><a class="header-anchor" href="#_5-3-4-react-unit-js"><span>5.3.4 react/unit.js</span></a></h4><p>src/react/unit.js</p><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code class="language-javascript"><span class="line"><span class="token keyword">import</span> <span class="token punctuation">{</span>Element<span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&#39;./element&#39;</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">import</span> $ <span class="token keyword">from</span> <span class="token string">&#39;jquery&#39;</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">class</span> <span class="token class-name">Unit</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter">element</span><span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">this</span><span class="token punctuation">.</span>_currentElement <span class="token operator">=</span> element<span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    <span class="token function">getMarkUp</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">&#39;不能调用此方法&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"><span class="token keyword">class</span> <span class="token class-name">TextUnit</span> <span class="token keyword">extends</span> <span class="token class-name">Unit</span><span class="token punctuation">{</span></span>
<span class="line">    <span class="token function">getMarkUp</span><span class="token punctuation">(</span><span class="token parameter">reactid</span><span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line">         <span class="token keyword">this</span><span class="token punctuation">.</span>_reactid <span class="token operator">=</span> reactid<span class="token punctuation">;</span><span class="token comment">//保存记录reactid</span></span>
<span class="line">        <span class="token comment">//返回文本节点对应的HTML字符串</span></span>
<span class="line">        <span class="token keyword">return</span> <span class="token template-string"><span class="token template-punctuation string">\`</span><span class="token string">&lt;span data-reactid=&quot;</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">\${</span>reactid<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&quot;&gt;</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">\${</span><span class="token keyword">this</span><span class="token punctuation">.</span>_currentElement<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&lt;/span&gt;</span><span class="token template-punctuation string">\`</span></span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"><span class="token keyword">class</span> <span class="token class-name">NativeUnit</span> <span class="token keyword">extends</span> <span class="token class-name">Unit</span> <span class="token punctuation">{</span></span>
<span class="line">     <span class="token function">getMarkUp</span><span class="token punctuation">(</span><span class="token parameter">reactid</span><span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line">         <span class="token keyword">this</span><span class="token punctuation">.</span>_reactid <span class="token operator">=</span> reactid<span class="token punctuation">;</span><span class="token comment">//保存记录reactid</span></span>
<span class="line">        <span class="token comment">//返回文本节点对应的HTML字符串</span></span>
<span class="line">        <span class="token keyword">let</span> <span class="token punctuation">{</span>type<span class="token punctuation">,</span>props<span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_currentElement<span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">let</span> tagOpen <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">\`</span><span class="token string">&lt;</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">\${</span>type<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> data-reactid=&quot;</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">\${</span>reactid<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&quot; </span><span class="token template-punctuation string">\`</span></span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">let</span> tagClose <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">\`</span><span class="token string">&lt;/$type&gt;</span><span class="token template-punctuation string">\`</span></span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">let</span> content <span class="token operator">=</span> <span class="token string">&#39;&#39;</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">let</span> propName <span class="token keyword">in</span> props<span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line">            <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">^on[A-Z]</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">.</span><span class="token function">test</span><span class="token punctuation">(</span>propName<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line">                <span class="token keyword">let</span> eventName <span class="token operator">=</span> propName<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toLowerCase</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">                <span class="token function">$</span><span class="token punctuation">(</span>document<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">delegate</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">\`</span><span class="token string">[data-reactid=&quot;</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">\${</span>reactid<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&quot;]</span><span class="token template-punctuation string">\`</span></span><span class="token punctuation">,</span><span class="token template-string"><span class="token template-punctuation string">\`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">\${</span>eventName<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">.</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">\${</span>reactid<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">\`</span></span><span class="token punctuation">,</span>props<span class="token punctuation">[</span>propName<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">            <span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>propName <span class="token operator">===</span> <span class="token string">&#39;style&#39;</span><span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line">                <span class="token keyword">let</span> styleObj <span class="token operator">=</span> props<span class="token punctuation">[</span>propName<span class="token punctuation">]</span><span class="token punctuation">;</span></span>
<span class="line">                <span class="token keyword">let</span> styles <span class="token operator">=</span> Object<span class="token punctuation">.</span><span class="token function">keys</span><span class="token punctuation">(</span>styleObj<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token parameter">attr</span><span class="token operator">=&gt;</span><span class="token template-string"><span class="token template-punctuation string">\`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">\${</span>attr<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">:</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">\${</span>styleObj<span class="token punctuation">[</span>attr<span class="token punctuation">]</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">\`</span></span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token string">&#39;;&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">                tagOpen <span class="token operator">+=</span> <span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">\`</span><span class="token string"> style=&quot;</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">\${</span>styles<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&quot; </span><span class="token template-punctuation string">\`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">            <span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>propName <span class="token operator">===</span> <span class="token string">&#39;children&#39;</span><span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line">                <span class="token keyword">let</span> children <span class="token operator">=</span> props<span class="token punctuation">.</span>children<span class="token operator">||</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span></span>
<span class="line">                children<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">child<span class="token punctuation">,</span>index</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span></span>
<span class="line">                    <span class="token keyword">let</span> childUnit <span class="token operator">=</span> <span class="token function">createUnit</span><span class="token punctuation">(</span>child<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">                    <span class="token keyword">let</span> childMarkUp <span class="token operator">=</span> childUnit<span class="token punctuation">.</span><span class="token function">getMarkUp</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">\`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">\${</span>reactid<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">.</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">\${</span>index<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">\`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">                    content <span class="token operator">+=</span> childMarkUp<span class="token punctuation">;</span></span>
<span class="line">                <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">            <span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{</span></span>
<span class="line">                tagOpen <span class="token operator">+=</span> <span class="token template-string"><span class="token template-punctuation string">\`</span><span class="token string"> </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">\${</span>propName<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">=</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">\${</span>props<span class="token punctuation">[</span>propName<span class="token punctuation">]</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> </span><span class="token template-punctuation string">\`</span></span><span class="token punctuation">;</span></span>
<span class="line">            <span class="token punctuation">}</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">        <span class="token keyword">return</span> tagOpen <span class="token operator">+</span> <span class="token string">&#39;&gt;&#39;</span> <span class="token operator">+</span> content <span class="token operator">+</span> tagClose<span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token operator">+</span><span class="token keyword">class</span> <span class="token class-name">CompositeUnit</span> <span class="token keyword">extends</span> <span class="token class-name">Unit</span><span class="token punctuation">{</span></span>
<span class="line"><span class="token operator">+</span>    <span class="token function">getMarkUp</span><span class="token punctuation">(</span><span class="token parameter">reactid</span><span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line"><span class="token operator">+</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>_reactid <span class="token operator">=</span> reactid<span class="token punctuation">;</span></span>
<span class="line"><span class="token operator">+</span>        <span class="token comment">//type是一个自定义组件的类的定义</span></span>
<span class="line"><span class="token operator">+</span>        <span class="token keyword">let</span> <span class="token punctuation">{</span><span class="token literal-property property">type</span><span class="token operator">:</span>Component<span class="token punctuation">,</span>props<span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_currentElement<span class="token punctuation">;</span></span>
<span class="line"><span class="token operator">+</span>        <span class="token comment">//创建Component类的实例</span></span>
<span class="line"><span class="token operator">+</span>        <span class="token keyword">let</span> componentInstance <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Component</span><span class="token punctuation">(</span>props<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token operator">+</span>        <span class="token comment">//组件将要渲染</span></span>
<span class="line"><span class="token operator">+</span>        componentInstance<span class="token punctuation">.</span>componentWillMount<span class="token operator">&amp;&amp;</span>componentInstance<span class="token punctuation">.</span><span class="token function">componentWillMount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token operator">+</span>        <span class="token comment">//执行render方法获得虚拟DOM元素实例</span></span>
<span class="line"><span class="token operator">+</span>        <span class="token keyword">let</span> renderedElement <span class="token operator">=</span> componentInstance<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token operator">+</span>        <span class="token comment">//根据虚拟DOM元素得到unit,可能是TextUnit NativeUnit CompositeUnit</span></span>
<span class="line"><span class="token operator">+</span>        <span class="token keyword">let</span> renderedUnitInstance <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_renderedUnitInstance<span class="token operator">=</span> <span class="token function">createUnit</span><span class="token punctuation">(</span>renderedElement<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token operator">+</span>        <span class="token comment">//获得此unit的HTML标记字符串</span></span>
<span class="line"><span class="token operator">+</span>        <span class="token keyword">let</span> renderedMarkUp <span class="token operator">=</span> renderedUnitInstance<span class="token punctuation">.</span><span class="token function">getMarkUp</span><span class="token punctuation">(</span>reactid<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token operator">+</span>        <span class="token comment">//注册挂载完成的监听，越底层的组件越先监听，越先执行</span></span>
<span class="line"><span class="token operator">+</span>        <span class="token function">$</span><span class="token punctuation">(</span>document<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">&#39;mounted&#39;</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span>componentInstance<span class="token punctuation">.</span>componentDidMount<span class="token operator">&amp;&amp;</span>componentInstance<span class="token punctuation">.</span><span class="token function">componentDidMount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token operator">+</span>        <span class="token keyword">return</span> renderedMarkUp<span class="token punctuation">;</span></span>
<span class="line"><span class="token operator">+</span>    <span class="token punctuation">}</span></span>
<span class="line"><span class="token operator">+</span><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">function</span> <span class="token function">createUnit</span><span class="token punctuation">(</span><span class="token parameter">element</span><span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line">  <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token keyword">typeof</span> element <span class="token operator">==</span><span class="token string">&#39;string&#39;</span> <span class="token operator">||</span> <span class="token keyword">typeof</span> element <span class="token operator">==</span><span class="token string">&#39;number&#39;</span><span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line">      <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">TextUnit</span><span class="token punctuation">(</span>element<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">  <span class="token punctuation">}</span></span>
<span class="line">  <span class="token keyword">if</span><span class="token punctuation">(</span>element <span class="token keyword">instanceof</span> <span class="token class-name">Element</span> <span class="token operator">&amp;&amp;</span> <span class="token keyword">typeof</span> element<span class="token punctuation">.</span>type <span class="token operator">===</span> <span class="token string">&#39;string&#39;</span><span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line">      <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">NativeUnit</span><span class="token punctuation">(</span>element<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">  <span class="token punctuation">}</span></span>
<span class="line"><span class="token operator">+</span>  <span class="token keyword">if</span><span class="token punctuation">(</span>element <span class="token keyword">instanceof</span> <span class="token class-name">Element</span> <span class="token operator">&amp;&amp;</span> <span class="token keyword">typeof</span> element<span class="token punctuation">.</span>type <span class="token operator">===</span> <span class="token string">&#39;function&#39;</span><span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line"><span class="token operator">+</span>      <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">CompositeUnit</span><span class="token punctuation">(</span>element<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token operator">+</span>  <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">export</span> <span class="token punctuation">{</span></span>
<span class="line">    createUnit</span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="_6-实现setstate" tabindex="-1"><a class="header-anchor" href="#_6-实现setstate"><span>6. 实现setState</span></a></h2><h3 id="_6-1-src-index-js" tabindex="-1"><a class="header-anchor" href="#_6-1-src-index-js"><span>6.1 src/index.js</span></a></h3><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code class="language-javascript"><span class="line"><span class="token keyword">import</span> React <span class="token keyword">from</span> <span class="token string">&#39;./react&#39;</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">class</span> <span class="token class-name">Counter</span> <span class="token keyword">extends</span> <span class="token class-name">React<span class="token punctuation">.</span>Component</span><span class="token punctuation">{</span></span>
<span class="line">  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter">props</span><span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">super</span><span class="token punctuation">(</span>props<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">this</span><span class="token punctuation">.</span>state <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token literal-property property">number</span><span class="token operator">:</span><span class="token number">0</span><span class="token punctuation">}</span><span class="token punctuation">;</span></span>
<span class="line">  <span class="token punctuation">}</span></span>
<span class="line">  <span class="token function">componentWillMount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line">    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&#39;Counter componentWillMount&#39;</span><span class="token punctuation">)</span></span>
<span class="line">  <span class="token punctuation">}</span></span>
<span class="line">  <span class="token function">componentDidMount</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">     <span class="token function">setInterval</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></span>
<span class="line">       <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">setState</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token literal-property property">number</span><span class="token operator">:</span><span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">.</span>number<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">     <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">  <span class="token punctuation">}</span></span>
<span class="line">  <span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line">   <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">.</span>number<span class="token punctuation">;</span></span>
<span class="line">  <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"><span class="token keyword">let</span> element <span class="token operator">=</span> React<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span>Counter<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">React<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span>element<span class="token punctuation">,</span>document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">&#39;root&#39;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_6-2-react-component-js" tabindex="-1"><a class="header-anchor" href="#_6-2-react-component-js"><span>6.2 react/component.js</span></a></h3><p>src/react/component.js</p><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code class="language-javascript"><span class="line"><span class="token keyword">class</span> <span class="token class-name">Component</span><span class="token punctuation">{</span></span>
<span class="line">    <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter">props</span><span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">this</span><span class="token punctuation">.</span>props <span class="token operator">=</span> props<span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    <span class="token function">setState</span><span class="token punctuation">(</span><span class="token parameter">partialState</span><span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">this</span><span class="token punctuation">.</span>_currentUnit<span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span>partialState<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"><span class="token keyword">export</span> <span class="token punctuation">{</span>Component<span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_6-3-react-unit-js" tabindex="-1"><a class="header-anchor" href="#_6-3-react-unit-js"><span>6.3 react/unit.js</span></a></h3><p>src/react/unit.js</p><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code class="language-javascript"><span class="line"><span class="token keyword">import</span> <span class="token punctuation">{</span>Element<span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&#39;./element&#39;</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">import</span> $ <span class="token keyword">from</span> <span class="token string">&#39;jquery&#39;</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">class</span> <span class="token class-name">Unit</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter">element</span><span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">this</span><span class="token punctuation">.</span>_currentElement <span class="token operator">=</span> element<span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    <span class="token function">getMarkUp</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">&#39;不能调用此方法&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"><span class="token keyword">class</span> <span class="token class-name">TextUnit</span> <span class="token keyword">extends</span> <span class="token class-name">Unit</span><span class="token punctuation">{</span></span>
<span class="line">    <span class="token function">getMarkUp</span><span class="token punctuation">(</span><span class="token parameter">reactid</span><span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line">         <span class="token keyword">this</span><span class="token punctuation">.</span>_reactid <span class="token operator">=</span> reactid<span class="token punctuation">;</span><span class="token comment">//保存记录reactid</span></span>
<span class="line">        <span class="token comment">//返回文本节点对应的HTML字符串</span></span>
<span class="line">        <span class="token keyword">return</span> <span class="token template-string"><span class="token template-punctuation string">\`</span><span class="token string">&lt;span data-reactid=&quot;</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">\${</span>reactid<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&quot;&gt;</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">\${</span><span class="token keyword">this</span><span class="token punctuation">.</span>_currentElement<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&lt;/span&gt;</span><span class="token template-punctuation string">\`</span></span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"><span class="token operator">+</span>    <span class="token function">update</span><span class="token punctuation">(</span><span class="token parameter">nextElement</span><span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line"><span class="token operator">+</span>        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>_currentElement <span class="token operator">!=</span> nextElement<span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line"><span class="token operator">+</span>            <span class="token keyword">this</span><span class="token punctuation">.</span>_currentElement <span class="token operator">=</span> nextElement<span class="token punctuation">;</span></span>
<span class="line"><span class="token operator">+</span>            <span class="token function">$</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">\`</span><span class="token string">[data-reactid=&quot;</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">\${</span><span class="token keyword">this</span><span class="token punctuation">.</span>_reactid<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&quot;]</span><span class="token template-punctuation string">\`</span></span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">html</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>_currentElement<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token operator">+</span>        <span class="token punctuation">}</span></span>
<span class="line"><span class="token operator">+</span>    <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"><span class="token keyword">class</span> <span class="token class-name">NativeUnit</span> <span class="token keyword">extends</span> <span class="token class-name">Unit</span> <span class="token punctuation">{</span></span>
<span class="line">     <span class="token function">getMarkUp</span><span class="token punctuation">(</span><span class="token parameter">reactid</span><span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line">         <span class="token keyword">this</span><span class="token punctuation">.</span>_reactid <span class="token operator">=</span> reactid<span class="token punctuation">;</span><span class="token comment">//保存记录reactid</span></span>
<span class="line">        <span class="token comment">//返回文本节点对应的HTML字符串</span></span>
<span class="line">        <span class="token keyword">let</span> <span class="token punctuation">{</span>type<span class="token punctuation">,</span>props<span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_currentElement<span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">let</span> tagOpen <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">\`</span><span class="token string">&lt;</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">\${</span>type<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> data-reactid=&quot;</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">\${</span>reactid<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&quot; </span><span class="token template-punctuation string">\`</span></span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">let</span> tagClose <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">\`</span><span class="token string">&lt;/$type&gt;</span><span class="token template-punctuation string">\`</span></span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">let</span> content <span class="token operator">=</span> <span class="token string">&#39;&#39;</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">let</span> propName <span class="token keyword">in</span> props<span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line">            <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">^on[A-Z]</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">.</span><span class="token function">test</span><span class="token punctuation">(</span>propName<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line">                <span class="token keyword">let</span> eventName <span class="token operator">=</span> propName<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toLowerCase</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">                <span class="token function">$</span><span class="token punctuation">(</span>document<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">delegate</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">\`</span><span class="token string">[data-reactid=&quot;</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">\${</span>reactid<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&quot;]</span><span class="token template-punctuation string">\`</span></span><span class="token punctuation">,</span><span class="token template-string"><span class="token template-punctuation string">\`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">\${</span>eventName<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">.</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">\${</span>reactid<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">\`</span></span><span class="token punctuation">,</span>props<span class="token punctuation">[</span>propName<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">            <span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>propName <span class="token operator">===</span> <span class="token string">&#39;style&#39;</span><span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line">                <span class="token keyword">let</span> styleObj <span class="token operator">=</span> props<span class="token punctuation">[</span>propName<span class="token punctuation">]</span><span class="token punctuation">;</span></span>
<span class="line">                <span class="token keyword">let</span> styles <span class="token operator">=</span> Object<span class="token punctuation">.</span><span class="token function">keys</span><span class="token punctuation">(</span>styleObj<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token parameter">attr</span><span class="token operator">=&gt;</span><span class="token template-string"><span class="token template-punctuation string">\`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">\${</span>attr<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">:</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">\${</span>styleObj<span class="token punctuation">[</span>attr<span class="token punctuation">]</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">\`</span></span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token string">&#39;;&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">                tagOpen <span class="token operator">+=</span> <span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">\`</span><span class="token string"> style=&quot;</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">\${</span>styles<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&quot; </span><span class="token template-punctuation string">\`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">            <span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>propName <span class="token operator">===</span> <span class="token string">&#39;children&#39;</span><span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line">                <span class="token keyword">let</span> children <span class="token operator">=</span> props<span class="token punctuation">.</span>children<span class="token operator">||</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span></span>
<span class="line">                children<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">child<span class="token punctuation">,</span>index</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span></span>
<span class="line">                    <span class="token keyword">let</span> childUnit <span class="token operator">=</span> <span class="token function">createUnit</span><span class="token punctuation">(</span>child<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">                    <span class="token keyword">let</span> childMarkUp <span class="token operator">=</span> childUnit<span class="token punctuation">.</span><span class="token function">getMarkUp</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">\`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">\${</span>reactid<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">.</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">\${</span>index<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">\`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">                    content <span class="token operator">+=</span> childMarkUp<span class="token punctuation">;</span></span>
<span class="line">                <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">            <span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{</span></span>
<span class="line">                tagOpen <span class="token operator">+=</span> <span class="token template-string"><span class="token template-punctuation string">\`</span><span class="token string"> </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">\${</span>propName<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">=</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">\${</span>props<span class="token punctuation">[</span>propName<span class="token punctuation">]</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> </span><span class="token template-punctuation string">\`</span></span><span class="token punctuation">;</span></span>
<span class="line">            <span class="token punctuation">}</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">        <span class="token keyword">return</span> tagOpen <span class="token operator">+</span> <span class="token string">&#39;&gt;&#39;</span> <span class="token operator">+</span> content <span class="token operator">+</span> tagClose<span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">class</span> <span class="token class-name">CompositeUnit</span> <span class="token keyword">extends</span> <span class="token class-name">Unit</span><span class="token punctuation">{</span></span>
<span class="line">    <span class="token comment">//接收到新的更新，自定义组件传第二个参数，原生组件和text传处一个参数</span></span>
<span class="line"><span class="token operator">+</span>    <span class="token function">update</span><span class="token punctuation">(</span><span class="token parameter">nextElement<span class="token punctuation">,</span>partialState</span><span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line"><span class="token operator">+</span>        <span class="token comment">//如果传过来了新的元素，则使用新的元素</span></span>
<span class="line"><span class="token operator">+</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>_currentElement <span class="token operator">=</span> nextElement<span class="token operator">||</span><span class="token keyword">this</span><span class="token punctuation">.</span>_currentElement<span class="token punctuation">;</span></span>
<span class="line"><span class="token operator">+</span>        <span class="token comment">//获取新的状态对象和属性对象</span></span>
<span class="line"><span class="token operator">+</span>        <span class="token keyword">let</span> nextState <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_componentInstance<span class="token punctuation">.</span>state<span class="token operator">=</span> Object<span class="token punctuation">.</span><span class="token function">assign</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>_componentInstance<span class="token punctuation">.</span>state<span class="token punctuation">,</span>partialState<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token operator">+</span>        <span class="token keyword">let</span> nextProps <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_currentElement<span class="token punctuation">.</span>props<span class="token punctuation">;</span></span>
<span class="line"><span class="token operator">+</span>        <span class="token comment">//如果shouldComponentUpdate返回了false则不需要继续更新</span></span>
<span class="line"><span class="token operator">+</span>        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>_componentInstance<span class="token punctuation">.</span>shouldComponentUpdate<span class="token operator">&amp;&amp;</span><span class="token keyword">this</span><span class="token punctuation">.</span>_componentInstance<span class="token punctuation">.</span><span class="token function">shouldComponentUpdate</span><span class="token punctuation">(</span>nextProps<span class="token punctuation">,</span>nextState<span class="token punctuation">)</span><span class="token operator">===</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token keyword">return</span><span class="token punctuation">;</span><span class="token punctuation">}</span></span>
<span class="line"><span class="token operator">+</span>        <span class="token comment">//获得上次渲染出来的unit实例 </span></span>
<span class="line"><span class="token operator">+</span>        <span class="token keyword">let</span> prevRenderedUnitInstance <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_renderedUnitInstance<span class="token punctuation">;</span></span>
<span class="line"><span class="token operator">+</span>        <span class="token comment">//从unit实例中获取</span></span>
<span class="line"><span class="token operator">+</span>        <span class="token keyword">let</span> prevRenderedElement <span class="token operator">=</span> prevRenderedUnitInstance<span class="token punctuation">.</span>_currentElement<span class="token punctuation">;</span></span>
<span class="line"><span class="token operator">+</span>        <span class="token comment">//获取新的虚拟DOM</span></span>
<span class="line"><span class="token operator">+</span>        <span class="token keyword">let</span> nextRenderElement <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_componentInstance<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token operator">+</span>        <span class="token comment">//进行domdiff对比</span></span>
<span class="line"><span class="token operator">+</span>        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">shouldDeepCompare</span><span class="token punctuation">(</span>prevRenderedElement<span class="token punctuation">,</span>nextRenderElement<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line"><span class="token operator">+</span>            <span class="token comment">//如果需要更新，则继续调用子节点的upate方法进行更新,传入新的element更新子节点</span></span>
<span class="line"><span class="token operator">+</span>            prevRenderedUnitInstance<span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span>nextRenderElement<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token operator">+</span>            <span class="token keyword">this</span><span class="token punctuation">.</span>_componentInstance<span class="token punctuation">.</span>componentDidUpdate<span class="token operator">&amp;&amp;</span><span class="token keyword">this</span><span class="token punctuation">.</span>_componentInstance<span class="token punctuation">.</span><span class="token function">componentDidUpdate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token operator">+</span>        <span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{</span></span>
<span class="line"><span class="token operator">+</span>            <span class="token comment">//如果发现不需要对比，干脆重新渲染</span></span>
<span class="line"><span class="token operator">+</span>            <span class="token keyword">this</span><span class="token punctuation">.</span>_renderedUnitInstance <span class="token operator">=</span>  <span class="token function">createUnit</span><span class="token punctuation">(</span>nextRenderElement<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token operator">+</span>            <span class="token keyword">let</span> nextMarkUp <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_renderedUnitInstance<span class="token punctuation">.</span><span class="token function">getMarkUp</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>_reactid<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token operator">+</span>            <span class="token comment">//替换整个节点</span></span>
<span class="line"><span class="token operator">+</span>            <span class="token function">$</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">\`</span><span class="token string">[data-reactid=&quot;</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">\${</span><span class="token keyword">this</span><span class="token punctuation">.</span>_reactid<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&quot;]</span><span class="token template-punctuation string">\`</span></span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">replaceWith</span><span class="token punctuation">(</span>nextMarkUp<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token operator">+</span>        <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    <span class="token function">getMarkUp</span><span class="token punctuation">(</span><span class="token parameter">reactid</span><span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">this</span><span class="token punctuation">.</span>_reactid <span class="token operator">=</span> reactid<span class="token punctuation">;</span></span>
<span class="line">        <span class="token comment">//type是一个自定义组件的类的定义</span></span>
<span class="line">        <span class="token keyword">let</span> <span class="token punctuation">{</span><span class="token literal-property property">type</span><span class="token operator">:</span>Component<span class="token punctuation">,</span>props<span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_currentElement<span class="token punctuation">;</span></span>
<span class="line">        <span class="token comment">//创建Component类的实例</span></span>
<span class="line"><span class="token operator">+</span>        <span class="token keyword">let</span> componentInstance <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_componentInstance <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Component</span><span class="token punctuation">(</span>props<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token comment">//组件实例关联上自己的unit实例</span></span>
<span class="line"><span class="token operator">+</span>        componentInstance<span class="token punctuation">.</span>_currentUnit  <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token comment">//组件将要渲染</span></span>
<span class="line">        componentInstance<span class="token punctuation">.</span>componentWillMount<span class="token operator">&amp;&amp;</span>componentInstance<span class="token punctuation">.</span><span class="token function">componentWillMount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token comment">//执行render方法获得虚拟DOM元素实例</span></span>
<span class="line">        <span class="token keyword">let</span> renderedElement <span class="token operator">=</span> componentInstance<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token comment">//根据虚拟DOM元素得到unit,可能是TextUnit NativeUnit CompositeUnit</span></span>
<span class="line">        <span class="token keyword">let</span> renderedUnitInstance <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_renderedUnitInstance<span class="token operator">=</span> <span class="token function">createUnit</span><span class="token punctuation">(</span>renderedElement<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token comment">//获得此unit的HTML标记字符串</span></span>
<span class="line">        <span class="token keyword">let</span> renderedMarkUp <span class="token operator">=</span> renderedUnitInstance<span class="token punctuation">.</span><span class="token function">getMarkUp</span><span class="token punctuation">(</span>reactid<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token comment">//注册挂载完成的监听，越底层的组件越先监听，越先执行</span></span>
<span class="line">        <span class="token function">$</span><span class="token punctuation">(</span>document<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">&#39;mounted&#39;</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span>componentInstance<span class="token punctuation">.</span>componentDidMount<span class="token operator">&amp;&amp;</span>componentInstance<span class="token punctuation">.</span><span class="token function">componentDidMount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">return</span> renderedMarkUp<span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token operator">+</span><span class="token keyword">function</span> <span class="token function">shouldDeepCompare</span><span class="token punctuation">(</span><span class="token parameter">prevElement<span class="token punctuation">,</span>nextElement</span><span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line"><span class="token operator">+</span>   <span class="token keyword">if</span><span class="token punctuation">(</span>prevElement<span class="token operator">!==</span><span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> nextElement<span class="token operator">!=</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line"><span class="token operator">+</span>       <span class="token keyword">let</span> prevType <span class="token operator">=</span> <span class="token keyword">typeof</span> prevElement<span class="token punctuation">;</span></span>
<span class="line"><span class="token operator">+</span>       <span class="token keyword">let</span> nextType <span class="token operator">=</span> <span class="token keyword">typeof</span> nextElement<span class="token punctuation">;</span></span>
<span class="line"><span class="token operator">+</span>       <span class="token comment">//如果新老节点都是文本可以进行比较</span></span>
<span class="line"><span class="token operator">+</span>       <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token punctuation">(</span>prevType <span class="token operator">===</span> <span class="token string">&#39;string&#39;</span> <span class="token operator">||</span>prevType <span class="token operator">===</span> <span class="token string">&#39;number&#39;</span><span class="token punctuation">)</span><span class="token operator">&amp;&amp;</span><span class="token punctuation">(</span>nextType <span class="token operator">===</span> <span class="token string">&#39;string&#39;</span> <span class="token operator">||</span>nextType <span class="token operator">===</span> <span class="token string">&#39;number&#39;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line"><span class="token operator">+</span>           <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token operator">+</span>       <span class="token punctuation">}</span></span>
<span class="line"><span class="token operator">+</span>       <span class="token keyword">if</span><span class="token punctuation">(</span>prevElement <span class="token keyword">instanceof</span> <span class="token class-name">Element</span> <span class="token operator">&amp;&amp;</span> nextElement <span class="token keyword">instanceof</span> <span class="token class-name">Element</span><span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line"><span class="token operator">+</span>           <span class="token keyword">return</span> prevElement<span class="token punctuation">.</span>type <span class="token operator">===</span> nextElement<span class="token punctuation">.</span>type<span class="token punctuation">;</span></span>
<span class="line"><span class="token operator">+</span>       <span class="token punctuation">}</span></span>
<span class="line"><span class="token operator">+</span>   <span class="token punctuation">}</span>  </span>
<span class="line"><span class="token operator">+</span>   <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token operator">+</span><span class="token punctuation">}</span></span>
<span class="line"><span class="token keyword">function</span> <span class="token function">createUnit</span><span class="token punctuation">(</span><span class="token parameter">element</span><span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line">  <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token keyword">typeof</span> element <span class="token operator">==</span><span class="token string">&#39;string&#39;</span> <span class="token operator">||</span> <span class="token keyword">typeof</span> element <span class="token operator">==</span><span class="token string">&#39;number&#39;</span><span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line">      <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">TextUnit</span><span class="token punctuation">(</span>element<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">  <span class="token punctuation">}</span></span>
<span class="line">  <span class="token keyword">if</span><span class="token punctuation">(</span>element <span class="token keyword">instanceof</span> <span class="token class-name">Element</span> <span class="token operator">&amp;&amp;</span> <span class="token keyword">typeof</span> element<span class="token punctuation">.</span>type <span class="token operator">===</span> <span class="token string">&#39;string&#39;</span><span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line">      <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">NativeUnit</span><span class="token punctuation">(</span>element<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">  <span class="token punctuation">}</span></span>
<span class="line">  <span class="token keyword">if</span><span class="token punctuation">(</span>element <span class="token keyword">instanceof</span> <span class="token class-name">Element</span> <span class="token operator">&amp;&amp;</span> <span class="token keyword">typeof</span> element<span class="token punctuation">.</span>type <span class="token operator">===</span> <span class="token string">&#39;function&#39;</span><span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line">      <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">CompositeUnit</span><span class="token punctuation">(</span>element<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">  <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">export</span> <span class="token punctuation">{</span></span>
<span class="line">    createUnit</span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_6-4-react-element-js" tabindex="-1"><a class="header-anchor" href="#_6-4-react-element-js"><span>6.4 react/element.js</span></a></h3><p>src/react/element.js</p><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text"><pre><code class="language-text"><span class="line">class Element{</span>
<span class="line">    constructor(type,props){</span>
<span class="line">        this.type = type;</span>
<span class="line">+       this.key = props.key;</span>
<span class="line">        this.props = props;</span>
<span class="line">    }</span>
<span class="line">}</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="_7-对比属性" tabindex="-1"><a class="header-anchor" href="#_7-对比属性"><span>7. 对比属性</span></a></h2><ul><li>实现点击加1功能</li></ul><h3 id="_7-1-src-index-js" tabindex="-1"><a class="header-anchor" href="#_7-1-src-index-js"><span>7.1 src/index.js</span></a></h3><p>src/index.js</p><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code class="language-javascript"><span class="line"><span class="token keyword">import</span> React <span class="token keyword">from</span> <span class="token string">&#39;./react&#39;</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">class</span> <span class="token class-name">Counter</span> <span class="token keyword">extends</span> <span class="token class-name">React<span class="token punctuation">.</span>Component</span><span class="token punctuation">{</span></span>
<span class="line">  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter">props</span><span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">super</span><span class="token punctuation">(</span>props<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">this</span><span class="token punctuation">.</span>state <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token literal-property property">number</span><span class="token operator">:</span><span class="token number">0</span><span class="token punctuation">}</span><span class="token punctuation">;</span></span>
<span class="line">  <span class="token punctuation">}</span></span>
<span class="line">  <span class="token function">componentWillMount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line">    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&#39;Counter componentWillMount&#39;</span><span class="token punctuation">)</span></span>
<span class="line">  <span class="token punctuation">}</span></span>
<span class="line">  <span class="token function">componentDidMount</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">     console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&#39;Counter componentDidMount&#39;</span><span class="token punctuation">)</span></span>
<span class="line">  <span class="token punctuation">}</span></span>
<span class="line">  <span class="token function-variable function">handleClick</span><span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">setState</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token literal-property property">number</span><span class="token operator">:</span><span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">.</span>number<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">  <span class="token punctuation">}</span></span>
<span class="line">  <span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line">   <span class="token keyword">let</span> p <span class="token operator">=</span> React<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">&#39;p&#39;</span><span class="token punctuation">,</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">.</span>number<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">   <span class="token keyword">let</span> button <span class="token operator">=</span> React<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">&#39;button&#39;</span><span class="token punctuation">,</span><span class="token punctuation">{</span><span class="token literal-property property">onClick</span><span class="token operator">:</span><span class="token keyword">this</span><span class="token punctuation">.</span>handleClick<span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token string">&#39;+&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">   <span class="token keyword">return</span> React<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">&#39;div&#39;</span><span class="token punctuation">,</span><span class="token punctuation">{</span><span class="token literal-property property">id</span><span class="token operator">:</span><span class="token string">&#39;counter&#39;</span><span class="token punctuation">,</span><span class="token literal-property property">style</span><span class="token operator">:</span><span class="token punctuation">{</span><span class="token literal-property property">color</span><span class="token operator">:</span><span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">.</span>number<span class="token operator">%</span><span class="token number">2</span><span class="token operator">===</span><span class="token number">0</span><span class="token operator">?</span><span class="token string">&#39;red&#39;</span><span class="token operator">:</span><span class="token string">&#39;green&#39;</span><span class="token punctuation">,</span><span class="token literal-property property">backgroundColor</span><span class="token operator">:</span><span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">.</span>number<span class="token operator">%</span><span class="token number">2</span><span class="token operator">===</span><span class="token number">0</span><span class="token operator">?</span><span class="token string">&#39;green&#39;</span><span class="token operator">:</span><span class="token string">&#39;red&#39;</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">,</span>p<span class="token punctuation">,</span>button<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">  <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"><span class="token keyword">let</span> element <span class="token operator">=</span> React<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span>Counter<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">React<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span>element<span class="token punctuation">,</span>document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">&#39;root&#39;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_7-2-react-unit-js" tabindex="-1"><a class="header-anchor" href="#_7-2-react-unit-js"><span>7.2 react/unit.js</span></a></h3><p>src/react/unit.js</p><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code class="language-javascript"><span class="line"><span class="token keyword">import</span> <span class="token punctuation">{</span>Element<span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&#39;./element&#39;</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">import</span> $ <span class="token keyword">from</span> <span class="token string">&#39;jquery&#39;</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">class</span> <span class="token class-name">Unit</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter">element</span><span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">this</span><span class="token punctuation">.</span>_currentElement <span class="token operator">=</span> element<span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    <span class="token function">getMarkUp</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">&#39;不能调用此方法&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"><span class="token keyword">class</span> <span class="token class-name">TextUnit</span> <span class="token keyword">extends</span> <span class="token class-name">Unit</span><span class="token punctuation">{</span></span>
<span class="line">    <span class="token function">getMarkUp</span><span class="token punctuation">(</span><span class="token parameter">reactid</span><span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line">         <span class="token keyword">this</span><span class="token punctuation">.</span>_reactid <span class="token operator">=</span> reactid<span class="token punctuation">;</span><span class="token comment">//保存记录reactid</span></span>
<span class="line">        <span class="token comment">//返回文本节点对应的HTML字符串</span></span>
<span class="line">        <span class="token keyword">return</span> <span class="token template-string"><span class="token template-punctuation string">\`</span><span class="token string">&lt;span data-reactid=&quot;</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">\${</span>reactid<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&quot;&gt;</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">\${</span><span class="token keyword">this</span><span class="token punctuation">.</span>_currentElement<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&lt;/span&gt;</span><span class="token template-punctuation string">\`</span></span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    <span class="token function">update</span><span class="token punctuation">(</span><span class="token parameter">nextElement</span><span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>_currentElement <span class="token operator">!=</span> nextElement<span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line">            <span class="token keyword">this</span><span class="token punctuation">.</span>_currentElement <span class="token operator">=</span> nextElement<span class="token punctuation">;</span></span>
<span class="line">            <span class="token function">$</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">\`</span><span class="token string">[data-reactid=&quot;</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">\${</span><span class="token keyword">this</span><span class="token punctuation">.</span>_reactid<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&quot;]</span><span class="token template-punctuation string">\`</span></span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">html</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>_currentElement<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"><span class="token keyword">class</span> <span class="token class-name">NativeUnit</span> <span class="token keyword">extends</span> <span class="token class-name">Unit</span> <span class="token punctuation">{</span></span>
<span class="line">     <span class="token function">getMarkUp</span><span class="token punctuation">(</span><span class="token parameter">reactid</span><span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line">         <span class="token keyword">this</span><span class="token punctuation">.</span>_reactid <span class="token operator">=</span> reactid<span class="token punctuation">;</span><span class="token comment">//保存记录reactid</span></span>
<span class="line">        <span class="token comment">//返回文本节点对应的HTML字符串</span></span>
<span class="line">        <span class="token keyword">let</span> <span class="token punctuation">{</span>type<span class="token punctuation">,</span>props<span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_currentElement<span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">let</span> tagOpen <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">\`</span><span class="token string">&lt;</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">\${</span>type<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> data-reactid=&quot;</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">\${</span>reactid<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&quot; </span><span class="token template-punctuation string">\`</span></span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">let</span> tagClose <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">\`</span><span class="token string">&lt;/$type&gt;</span><span class="token template-punctuation string">\`</span></span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">let</span> content <span class="token operator">=</span> <span class="token string">&#39;&#39;</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">let</span> propName <span class="token keyword">in</span> props<span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line">            <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">^on[A-Z]</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">.</span><span class="token function">test</span><span class="token punctuation">(</span>propName<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line">                <span class="token keyword">let</span> eventName <span class="token operator">=</span> propName<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toLowerCase</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">                <span class="token function">$</span><span class="token punctuation">(</span>document<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">delegate</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">\`</span><span class="token string">[data-reactid=&quot;</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">\${</span>reactid<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&quot;]</span><span class="token template-punctuation string">\`</span></span><span class="token punctuation">,</span><span class="token template-string"><span class="token template-punctuation string">\`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">\${</span>eventName<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">.</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">\${</span>reactid<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">\`</span></span><span class="token punctuation">,</span>props<span class="token punctuation">[</span>propName<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">            <span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>propName <span class="token operator">===</span> <span class="token string">&#39;style&#39;</span><span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line"><span class="token operator">+</span>                <span class="token keyword">let</span> styleObj <span class="token operator">=</span> props<span class="token punctuation">[</span>propName<span class="token punctuation">]</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token operator">+</span>                <span class="token keyword">let</span> styles <span class="token operator">=</span> Object<span class="token punctuation">.</span><span class="token function">keys</span><span class="token punctuation">(</span>styleObj<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token parameter">attr</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span></span>
<span class="line"><span class="token operator">+</span>                    <span class="token keyword">let</span> attrName <span class="token operator">=</span> attr<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">([A-Z])</span><span class="token regex-delimiter">/</span><span class="token regex-flags">g</span></span><span class="token punctuation">,</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">matched<span class="token punctuation">,</span>group</span><span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line"><span class="token operator">+</span>                        <span class="token keyword">return</span> <span class="token template-string"><span class="token template-punctuation string">\`</span><span class="token string">-</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">\${</span>group<span class="token punctuation">.</span><span class="token function">toLowerCase</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">\`</span></span><span class="token punctuation">;</span></span>
<span class="line"><span class="token operator">+</span>                    <span class="token punctuation">}</span><span class="token punctuation">)</span></span>
<span class="line"><span class="token operator">+</span>                    <span class="token keyword">return</span> <span class="token template-string"><span class="token template-punctuation string">\`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">\${</span>attrName<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">:</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">\${</span>styleObj<span class="token punctuation">[</span>attr<span class="token punctuation">]</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">\`</span></span><span class="token punctuation">;</span></span>
<span class="line"><span class="token operator">+</span>                <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token string">&#39;;&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token operator">+</span>                tagOpen <span class="token operator">+=</span> <span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">\`</span><span class="token string"> style=&quot;</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">\${</span>styles<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&quot; </span><span class="token template-punctuation string">\`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">            <span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>propName <span class="token operator">===</span> <span class="token string">&#39;children&#39;</span><span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line">                <span class="token keyword">let</span> children <span class="token operator">=</span> props<span class="token punctuation">.</span>children<span class="token operator">||</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span></span>
<span class="line">                children<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">child<span class="token punctuation">,</span>index</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span></span>
<span class="line">                    <span class="token keyword">let</span> childUnit <span class="token operator">=</span> <span class="token function">createUnit</span><span class="token punctuation">(</span>child<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">                    <span class="token keyword">let</span> childMarkUp <span class="token operator">=</span> childUnit<span class="token punctuation">.</span><span class="token function">getMarkUp</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">\`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">\${</span>reactid<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">.</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">\${</span>index<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">\`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">                    content <span class="token operator">+=</span> childMarkUp<span class="token punctuation">;</span></span>
<span class="line">                <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">            <span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{</span></span>
<span class="line">                tagOpen <span class="token operator">+=</span> <span class="token template-string"><span class="token template-punctuation string">\`</span><span class="token string"> </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">\${</span>propName<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">=</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">\${</span>props<span class="token punctuation">[</span>propName<span class="token punctuation">]</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> </span><span class="token template-punctuation string">\`</span></span><span class="token punctuation">;</span></span>
<span class="line">            <span class="token punctuation">}</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">        <span class="token keyword">return</span> tagOpen <span class="token operator">+</span> <span class="token string">&#39;&gt;&#39;</span> <span class="token operator">+</span> content <span class="token operator">+</span> tagClose<span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"><span class="token operator">+</span>    <span class="token function">update</span><span class="token punctuation">(</span><span class="token parameter">nextElement</span><span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line"><span class="token operator">+</span>        <span class="token keyword">let</span> oldProps <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_currentElement<span class="token punctuation">.</span>props<span class="token punctuation">;</span></span>
<span class="line"><span class="token operator">+</span>        <span class="token keyword">let</span> newProps <span class="token operator">=</span> nextElement<span class="token punctuation">.</span>props<span class="token punctuation">;</span></span>
<span class="line"><span class="token operator">+</span>        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">updateDOMproperties</span><span class="token punctuation">(</span>oldProps<span class="token punctuation">,</span>newProps<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token operator">+</span>        <span class="token comment">//this.updateDOMChildren(nextElement.props.children);</span></span>
<span class="line"><span class="token operator">+</span>    <span class="token punctuation">}</span></span>
<span class="line"><span class="token operator">+</span>    <span class="token function">updateDOMproperties</span><span class="token punctuation">(</span><span class="token parameter">oldProps<span class="token punctuation">,</span>newProps</span><span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line"><span class="token operator">+</span>        <span class="token keyword">let</span> propName<span class="token punctuation">;</span></span>
<span class="line"><span class="token operator">+</span>        <span class="token comment">//把新属性对象上没有属性给删除掉</span></span>
<span class="line"><span class="token operator">+</span>        <span class="token keyword">for</span><span class="token punctuation">(</span>propName <span class="token keyword">in</span> oldProps<span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line"><span class="token operator">+</span>            <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>newProps<span class="token punctuation">.</span><span class="token function">hasOwnProperty</span><span class="token punctuation">(</span>propName<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line"><span class="token operator">+</span>                <span class="token function">$</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">\`</span><span class="token string">[data-reactid=&quot;</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">\${</span><span class="token keyword">this</span><span class="token punctuation">.</span>_reactid<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&quot;]</span><span class="token template-punctuation string">\`</span></span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">removeAttr</span><span class="token punctuation">(</span>propName<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token operator">+</span>            <span class="token punctuation">}</span></span>
<span class="line"><span class="token operator">+</span>            <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">^on[A-Z]</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">.</span><span class="token function">test</span><span class="token punctuation">(</span>propName<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line"><span class="token operator">+</span>                <span class="token function">$</span><span class="token punctuation">(</span>document<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">undelegate</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">\`</span><span class="token string">.</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">\${</span><span class="token keyword">this</span><span class="token punctuation">.</span>reactid<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">\`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token operator">+</span>            <span class="token punctuation">}</span></span>
<span class="line"><span class="token operator">+</span>        <span class="token punctuation">}</span></span>
<span class="line"><span class="token operator">+</span>        <span class="token keyword">for</span><span class="token punctuation">(</span>propName <span class="token keyword">in</span> newProps<span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line"><span class="token operator">+</span>            <span class="token keyword">if</span><span class="token punctuation">(</span>propName <span class="token operator">==</span> <span class="token string">&#39;children&#39;</span><span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line"><span class="token operator">+</span>                </span>
<span class="line"><span class="token operator">+</span>            <span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">^on[A-Z]</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">.</span><span class="token function">test</span><span class="token punctuation">(</span>propName<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line"><span class="token operator">+</span>                <span class="token keyword">let</span> eventName <span class="token operator">=</span> propName<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toLowerCase</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token operator">+</span>                <span class="token function">$</span><span class="token punctuation">(</span>document<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">delegate</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">\`</span><span class="token string">[data-reactid=&quot;</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">\${</span><span class="token keyword">this</span><span class="token punctuation">.</span>_reactid<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&quot;]</span><span class="token template-punctuation string">\`</span></span><span class="token punctuation">,</span><span class="token template-string"><span class="token template-punctuation string">\`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">\${</span>eventName<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">.</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">\${</span><span class="token keyword">this</span><span class="token punctuation">.</span>_reactid<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">\`</span></span><span class="token punctuation">,</span>newProps<span class="token punctuation">[</span>propName<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token operator">+</span>            <span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>propName <span class="token operator">===</span> <span class="token string">&#39;style&#39;</span><span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line"><span class="token operator">+</span>                <span class="token keyword">let</span> styleObj <span class="token operator">=</span> newProps<span class="token punctuation">[</span>propName<span class="token punctuation">]</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token operator">+</span>                Object<span class="token punctuation">.</span><span class="token function">entries</span><span class="token punctuation">(</span>styleObj<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">[</span>attr<span class="token punctuation">,</span>value<span class="token punctuation">]</span></span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span></span>
<span class="line"><span class="token operator">+</span>                  <span class="token function">$</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">\`</span><span class="token string">[data-reactid=&quot;</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">\${</span><span class="token keyword">this</span><span class="token punctuation">.</span>_reactid<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&quot;]</span><span class="token template-punctuation string">\`</span></span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">css</span><span class="token punctuation">(</span>attr<span class="token punctuation">,</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token operator">+</span>                <span class="token punctuation">}</span><span class="token punctuation">)</span></span>
<span class="line"><span class="token operator">+</span>            <span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{</span></span>
<span class="line"><span class="token operator">+</span>                <span class="token function">$</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">\`</span><span class="token string">[data-reactid=&quot;</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">\${</span><span class="token keyword">this</span><span class="token punctuation">.</span>_reactid<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&quot;]</span><span class="token template-punctuation string">\`</span></span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">prop</span><span class="token punctuation">(</span>propName<span class="token punctuation">,</span>newProps<span class="token punctuation">[</span>propName<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token operator">+</span>            <span class="token punctuation">}</span></span>
<span class="line"><span class="token operator">+</span>        <span class="token punctuation">}</span></span>
<span class="line"><span class="token operator">+</span>    <span class="token punctuation">}</span></span>
<span class="line"><span class="token operator">+</span><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">class</span> <span class="token class-name">CompositeUnit</span> <span class="token keyword">extends</span> <span class="token class-name">Unit</span><span class="token punctuation">{</span></span>
<span class="line">    <span class="token comment">//接收到新的更新，自定义组件传第二个参数，原生组件和text传处一个参数</span></span>
<span class="line">    <span class="token function">update</span><span class="token punctuation">(</span><span class="token parameter">nextElement<span class="token punctuation">,</span>partialState</span><span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line">        <span class="token comment">//如果传过来了新的元素，则使用新的元素</span></span>
<span class="line">        <span class="token keyword">this</span><span class="token punctuation">.</span>_currentElement <span class="token operator">=</span> nextElement<span class="token operator">||</span><span class="token keyword">this</span><span class="token punctuation">.</span>_currentElement<span class="token punctuation">;</span></span>
<span class="line">        <span class="token comment">//获取新的状态对象和属性对象</span></span>
<span class="line">        <span class="token keyword">let</span> nextState <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_componentInstance<span class="token punctuation">.</span>state<span class="token operator">=</span> Object<span class="token punctuation">.</span><span class="token function">assign</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>_componentInstance<span class="token punctuation">.</span>state<span class="token punctuation">,</span>partialState<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">let</span> nextProps <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_currentElement<span class="token punctuation">.</span>props<span class="token punctuation">;</span></span>
<span class="line">        <span class="token comment">//如果shouldComponentUpdate返回了false则不需要继续更新</span></span>
<span class="line">        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>_componentInstance<span class="token punctuation">.</span>shouldComponentUpdate<span class="token operator">&amp;&amp;</span><span class="token keyword">this</span><span class="token punctuation">.</span>_componentInstance<span class="token punctuation">.</span><span class="token function">shouldComponentUpdate</span><span class="token punctuation">(</span>nextProps<span class="token punctuation">,</span>nextState<span class="token punctuation">)</span><span class="token operator">===</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token keyword">return</span><span class="token punctuation">;</span><span class="token punctuation">}</span></span>
<span class="line">        <span class="token comment">//获得上次渲染出来的unit实例 </span></span>
<span class="line">        <span class="token keyword">let</span> prevRenderedUnitInstance <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_renderedUnitInstance<span class="token punctuation">;</span></span>
<span class="line">        <span class="token comment">//从unit实例中获取</span></span>
<span class="line">        <span class="token keyword">let</span> prevRenderedElement <span class="token operator">=</span> prevRenderedUnitInstance<span class="token punctuation">.</span>_currentElement<span class="token punctuation">;</span></span>
<span class="line">        <span class="token comment">//获取新的虚拟DOM</span></span>
<span class="line">        <span class="token keyword">let</span> nextRenderElement <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_componentInstance<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token comment">//进行domdiff对比</span></span>
<span class="line">        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">shouldDeepCompare</span><span class="token punctuation">(</span>prevRenderedElement<span class="token punctuation">,</span>nextRenderElement<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line">            <span class="token comment">//如果需要更新，则继续调用子节点的upate方法进行更新,传入新的element更新子节点</span></span>
<span class="line">            prevRenderedUnitInstance<span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span>nextRenderElement<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">            <span class="token keyword">this</span><span class="token punctuation">.</span>_componentInstance<span class="token punctuation">.</span>componentDidUpdate<span class="token operator">&amp;&amp;</span><span class="token keyword">this</span><span class="token punctuation">.</span>_componentInstance<span class="token punctuation">.</span><span class="token function">componentDidUpdate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{</span></span>
<span class="line">            <span class="token comment">//如果发现不需要对比，干脆重新渲染</span></span>
<span class="line">            <span class="token keyword">this</span><span class="token punctuation">.</span>_renderedUnitInstance <span class="token operator">=</span>  <span class="token function">createUnit</span><span class="token punctuation">(</span>nextRenderElement<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">            <span class="token keyword">let</span> nextMarkUp <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_renderedUnitInstance<span class="token punctuation">.</span><span class="token function">getMarkUp</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>_reactid<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">            <span class="token comment">//替换整个节点</span></span>
<span class="line">            <span class="token function">$</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">\`</span><span class="token string">[data-reactid=&quot;</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">\${</span><span class="token keyword">this</span><span class="token punctuation">.</span>_reactid<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&quot;]</span><span class="token template-punctuation string">\`</span></span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">replaceWith</span><span class="token punctuation">(</span>nextMarkUp<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    <span class="token function">getMarkUp</span><span class="token punctuation">(</span><span class="token parameter">reactid</span><span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">this</span><span class="token punctuation">.</span>_reactid <span class="token operator">=</span> reactid<span class="token punctuation">;</span></span>
<span class="line">        <span class="token comment">//type是一个自定义组件的类的定义</span></span>
<span class="line">        <span class="token keyword">let</span> <span class="token punctuation">{</span><span class="token literal-property property">type</span><span class="token operator">:</span>Component<span class="token punctuation">,</span>props<span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_currentElement<span class="token punctuation">;</span></span>
<span class="line">        <span class="token comment">//创建Component类的实例</span></span>
<span class="line">        <span class="token keyword">let</span> componentInstance <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_componentInstance <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Component</span><span class="token punctuation">(</span>props<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token comment">//组件实例关联上自己的unit实例</span></span>
<span class="line">        componentInstance<span class="token punctuation">.</span>_currentUnit  <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token comment">//组件将要渲染</span></span>
<span class="line">        componentInstance<span class="token punctuation">.</span>componentWillMount<span class="token operator">&amp;&amp;</span>componentInstance<span class="token punctuation">.</span><span class="token function">componentWillMount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token comment">//执行render方法获得虚拟DOM元素实例</span></span>
<span class="line">        <span class="token keyword">let</span> renderedElement <span class="token operator">=</span> componentInstance<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token comment">//根据虚拟DOM元素得到unit,可能是TextUnit NativeUnit CompositeUnit</span></span>
<span class="line">        <span class="token keyword">let</span> renderedUnitInstance <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_renderedUnitInstance<span class="token operator">=</span> <span class="token function">createUnit</span><span class="token punctuation">(</span>renderedElement<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token comment">//获得此unit的HTML标记字符串</span></span>
<span class="line">        <span class="token keyword">let</span> renderedMarkUp <span class="token operator">=</span> renderedUnitInstance<span class="token punctuation">.</span><span class="token function">getMarkUp</span><span class="token punctuation">(</span>reactid<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token comment">//注册挂载完成的监听，越底层的组件越先监听，越先执行</span></span>
<span class="line">        <span class="token function">$</span><span class="token punctuation">(</span>document<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">&#39;mounted&#39;</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span>componentInstance<span class="token punctuation">.</span>componentDidMount<span class="token operator">&amp;&amp;</span>componentInstance<span class="token punctuation">.</span><span class="token function">componentDidMount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">return</span> renderedMarkUp<span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">function</span> <span class="token function">shouldDeepCompare</span><span class="token punctuation">(</span><span class="token parameter">prevElement<span class="token punctuation">,</span>nextElement</span><span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line">   <span class="token keyword">if</span><span class="token punctuation">(</span>prevElement<span class="token operator">!==</span><span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> nextElement<span class="token operator">!=</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line">       <span class="token keyword">let</span> prevType <span class="token operator">=</span> <span class="token keyword">typeof</span> prevElement<span class="token punctuation">;</span></span>
<span class="line">       <span class="token keyword">let</span> nextType <span class="token operator">=</span> <span class="token keyword">typeof</span> nextElement<span class="token punctuation">;</span></span>
<span class="line">       <span class="token comment">//如果新老节点都是文本可以进行比较</span></span>
<span class="line">       <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token punctuation">(</span>prevType <span class="token operator">===</span> <span class="token string">&#39;string&#39;</span> <span class="token operator">||</span>prevType <span class="token operator">===</span> <span class="token string">&#39;number&#39;</span><span class="token punctuation">)</span><span class="token operator">&amp;&amp;</span><span class="token punctuation">(</span>nextType <span class="token operator">===</span> <span class="token string">&#39;string&#39;</span> <span class="token operator">||</span>nextType <span class="token operator">===</span> <span class="token string">&#39;number&#39;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line">           <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span></span>
<span class="line">       <span class="token punctuation">}</span></span>
<span class="line">       <span class="token keyword">if</span><span class="token punctuation">(</span>prevElement <span class="token keyword">instanceof</span> <span class="token class-name">Element</span> <span class="token operator">&amp;&amp;</span> nextElement <span class="token keyword">instanceof</span> <span class="token class-name">Element</span><span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line">           <span class="token keyword">return</span> prevElement<span class="token punctuation">.</span>type <span class="token operator">===</span> nextElement<span class="token punctuation">.</span>type<span class="token punctuation">;</span></span>
<span class="line">       <span class="token punctuation">}</span></span>
<span class="line">   <span class="token punctuation">}</span>  </span>
<span class="line">   <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"><span class="token keyword">function</span> <span class="token function">createUnit</span><span class="token punctuation">(</span><span class="token parameter">element</span><span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line">  <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token keyword">typeof</span> element <span class="token operator">==</span><span class="token string">&#39;string&#39;</span> <span class="token operator">||</span> <span class="token keyword">typeof</span> element <span class="token operator">==</span><span class="token string">&#39;number&#39;</span><span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line">      <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">TextUnit</span><span class="token punctuation">(</span>element<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">  <span class="token punctuation">}</span></span>
<span class="line">  <span class="token keyword">if</span><span class="token punctuation">(</span>element <span class="token keyword">instanceof</span> <span class="token class-name">Element</span> <span class="token operator">&amp;&amp;</span> <span class="token keyword">typeof</span> element<span class="token punctuation">.</span>type <span class="token operator">===</span> <span class="token string">&#39;string&#39;</span><span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line">      <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">NativeUnit</span><span class="token punctuation">(</span>element<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">  <span class="token punctuation">}</span></span>
<span class="line">  <span class="token keyword">if</span><span class="token punctuation">(</span>element <span class="token keyword">instanceof</span> <span class="token class-name">Element</span> <span class="token operator">&amp;&amp;</span> <span class="token keyword">typeof</span> element<span class="token punctuation">.</span>type <span class="token operator">===</span> <span class="token string">&#39;function&#39;</span><span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line">      <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">CompositeUnit</span><span class="token punctuation">(</span>element<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">  <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">export</span> <span class="token punctuation">{</span></span>
<span class="line">    createUnit</span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="_8-对比子元素" tabindex="-1"><a class="header-anchor" href="#_8-对比子元素"><span>8. 对比子元素</span></a></h2><h3 id="_8-1-src-unit-js" tabindex="-1"><a class="header-anchor" href="#_8-1-src-unit-js"><span>8.1 src/unit.js</span></a></h3><p>src\\unit.js</p><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code class="language-javascript"><span class="line"><span class="token keyword">import</span> <span class="token punctuation">{</span>Element<span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&#39;./element&#39;</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">import</span> $ <span class="token keyword">from</span> <span class="token string">&#39;jquery&#39;</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token operator">+</span> <span class="token keyword">let</span> diffQueue <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">class</span> <span class="token class-name">Unit</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter">element</span><span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">this</span><span class="token punctuation">.</span>_currentElement <span class="token operator">=</span> element<span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    <span class="token function">getMarkUp</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">&#39;不能调用此方法&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"><span class="token keyword">class</span> <span class="token class-name">TextUnit</span> <span class="token keyword">extends</span> <span class="token class-name">Unit</span><span class="token punctuation">{</span></span>
<span class="line">    <span class="token function">getMarkUp</span><span class="token punctuation">(</span><span class="token parameter">reactid</span><span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line">         <span class="token keyword">this</span><span class="token punctuation">.</span>_reactid <span class="token operator">=</span> reactid<span class="token punctuation">;</span><span class="token comment">//保存记录reactid</span></span>
<span class="line">        <span class="token comment">//返回文本节点对应的HTML字符串</span></span>
<span class="line">        <span class="token keyword">return</span> <span class="token template-string"><span class="token template-punctuation string">\`</span><span class="token string">&lt;span data-reactid=&quot;</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">\${</span>reactid<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&quot;&gt;</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">\${</span><span class="token keyword">this</span><span class="token punctuation">.</span>_currentElement<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&lt;/span&gt;</span><span class="token template-punctuation string">\`</span></span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    <span class="token function">update</span><span class="token punctuation">(</span><span class="token parameter">nextElement</span><span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>_currentElement <span class="token operator">!=</span> nextElement<span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line">            <span class="token keyword">this</span><span class="token punctuation">.</span>_currentElement <span class="token operator">=</span> nextElement<span class="token punctuation">;</span></span>
<span class="line">            <span class="token function">$</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">\`</span><span class="token string">[data-reactid=&quot;</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">\${</span><span class="token keyword">this</span><span class="token punctuation">.</span>_reactid<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&quot;]</span><span class="token template-punctuation string">\`</span></span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">html</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>_currentElement<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"><span class="token keyword">class</span> <span class="token class-name">NativeUnit</span> <span class="token keyword">extends</span> <span class="token class-name">Unit</span> <span class="token punctuation">{</span></span>
<span class="line">     <span class="token function">getMarkUp</span><span class="token punctuation">(</span><span class="token parameter">reactid</span><span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line">         <span class="token keyword">this</span><span class="token punctuation">.</span>_reactid <span class="token operator">=</span> reactid<span class="token punctuation">;</span><span class="token comment">//保存记录reactid</span></span>
<span class="line">        <span class="token comment">//返回文本节点对应的HTML字符串</span></span>
<span class="line">        <span class="token keyword">let</span> <span class="token punctuation">{</span>type<span class="token punctuation">,</span>props<span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_currentElement<span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">let</span> tagOpen <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">\`</span><span class="token string">&lt;</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">\${</span>type<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> data-reactid=&quot;</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">\${</span>reactid<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&quot; </span><span class="token template-punctuation string">\`</span></span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">let</span> tagClose <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">\`</span><span class="token string">&lt;/$type&gt;</span><span class="token template-punctuation string">\`</span></span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">let</span> content <span class="token operator">=</span> <span class="token string">&#39;&#39;</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token operator">+</span>        <span class="token keyword">let</span> renderedChildUnits<span class="token operator">=</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">let</span> propName <span class="token keyword">in</span> props<span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line">            <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">^on[A-Z]</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">.</span><span class="token function">test</span><span class="token punctuation">(</span>propName<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line">                <span class="token keyword">let</span> eventName <span class="token operator">=</span> propName<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toLowerCase</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">                <span class="token function">$</span><span class="token punctuation">(</span>document<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">delegate</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">\`</span><span class="token string">[data-reactid=&quot;</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">\${</span>reactid<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&quot;]</span><span class="token template-punctuation string">\`</span></span><span class="token punctuation">,</span><span class="token template-string"><span class="token template-punctuation string">\`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">\${</span>eventName<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">.</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">\${</span>reactid<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">\`</span></span><span class="token punctuation">,</span>props<span class="token punctuation">[</span>propName<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">            <span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>propName <span class="token operator">===</span> <span class="token string">&#39;style&#39;</span><span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line">                <span class="token keyword">let</span> styleObj <span class="token operator">=</span> props<span class="token punctuation">[</span>propName<span class="token punctuation">]</span><span class="token punctuation">;</span></span>
<span class="line">                <span class="token keyword">let</span> styles <span class="token operator">=</span> Object<span class="token punctuation">.</span><span class="token function">keys</span><span class="token punctuation">(</span>styleObj<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token parameter">attr</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span></span>
<span class="line">                    <span class="token keyword">let</span> attrName <span class="token operator">=</span> attr<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">([A-Z])</span><span class="token regex-delimiter">/</span><span class="token regex-flags">g</span></span><span class="token punctuation">,</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">matched<span class="token punctuation">,</span>group</span><span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line">                        <span class="token keyword">return</span> <span class="token template-string"><span class="token template-punctuation string">\`</span><span class="token string">-</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">\${</span>group<span class="token punctuation">.</span><span class="token function">toLowerCase</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">\`</span></span><span class="token punctuation">;</span></span>
<span class="line">                    <span class="token punctuation">}</span><span class="token punctuation">)</span></span>
<span class="line">                    <span class="token keyword">return</span> <span class="token template-string"><span class="token template-punctuation string">\`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">\${</span>attrName<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">:</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">\${</span>styleObj<span class="token punctuation">[</span>attr<span class="token punctuation">]</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">\`</span></span><span class="token punctuation">;</span></span>
<span class="line">                <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token string">&#39;;&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">                tagOpen <span class="token operator">+=</span> <span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">\`</span><span class="token string"> style=&quot;</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">\${</span>styles<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&quot; </span><span class="token template-punctuation string">\`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">            <span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>propName <span class="token operator">===</span> <span class="token string">&#39;children&#39;</span><span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line">                <span class="token keyword">let</span> children <span class="token operator">=</span> props<span class="token punctuation">.</span>children<span class="token operator">||</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span></span>
<span class="line">                children<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">child<span class="token punctuation">,</span>index</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span></span>
<span class="line">                    <span class="token keyword">let</span> childUnit <span class="token operator">=</span> <span class="token function">createUnit</span><span class="token punctuation">(</span>child<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token operator">+</span>                    renderedChildUnits<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>childUnit<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">                    <span class="token keyword">let</span> childMarkUp <span class="token operator">=</span> childUnit<span class="token punctuation">.</span><span class="token function">getMarkUp</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">\`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">\${</span>reactid<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">.</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">\${</span>index<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">\`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">                    content <span class="token operator">+=</span> childMarkUp<span class="token punctuation">;</span></span>
<span class="line">                <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">            <span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{</span></span>
<span class="line">                tagOpen <span class="token operator">+=</span> <span class="token template-string"><span class="token template-punctuation string">\`</span><span class="token string"> </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">\${</span>propName<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">=</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">\${</span>props<span class="token punctuation">[</span>propName<span class="token punctuation">]</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> </span><span class="token template-punctuation string">\`</span></span><span class="token punctuation">;</span></span>
<span class="line">            <span class="token punctuation">}</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line"><span class="token operator">+</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>_renderedChildUnits <span class="token operator">=</span> renderedChildUnits<span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">return</span> tagOpen <span class="token operator">+</span> <span class="token string">&#39;&gt;&#39;</span> <span class="token operator">+</span> content <span class="token operator">+</span> tagClose<span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    <span class="token function">update</span><span class="token punctuation">(</span><span class="token parameter">nextElement</span><span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">let</span> oldProps <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_currentElement<span class="token punctuation">.</span>props<span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">let</span> newProps <span class="token operator">=</span> nextElement<span class="token punctuation">.</span>props<span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">updateDOMproperties</span><span class="token punctuation">(</span>oldProps<span class="token punctuation">,</span>newProps<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token operator">+</span>        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">updateDOMChildren</span><span class="token punctuation">(</span>nextElement<span class="token punctuation">.</span>props<span class="token punctuation">.</span>children<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"><span class="token operator">+</span>    <span class="token comment">//对比子元素</span></span>
<span class="line"><span class="token operator">+</span>    <span class="token function">updateDOMChildren</span><span class="token punctuation">(</span><span class="token parameter">newChildrenElements</span><span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line"><span class="token operator">+</span>        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">diff</span><span class="token punctuation">(</span>diffQueue<span class="token punctuation">,</span>newChildrenElements<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token operator">+</span>    <span class="token punctuation">}</span></span>
<span class="line"><span class="token operator">+</span>    <span class="token function">diff</span><span class="token punctuation">(</span><span class="token parameter">diffQueue<span class="token punctuation">,</span>newChildrenElements</span><span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line"><span class="token operator">+</span>        <span class="token keyword">let</span> oldChildUnitsMap <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getChildrenMap</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>_renderedChildUnits<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token operator">+</span>        <span class="token keyword">let</span> newChildren <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getNewChildren</span><span class="token punctuation">(</span>oldChildUnitsMap<span class="token punctuation">,</span>newChildrenElements<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token operator">+</span>    <span class="token punctuation">}</span></span>
<span class="line"><span class="token operator">+</span>    <span class="token function">getNewChildren</span><span class="token punctuation">(</span><span class="token parameter">oldChildUnitsMap<span class="token punctuation">,</span>newChildrenElements</span><span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line"><span class="token operator">+</span>        <span class="token keyword">let</span> newChildren <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token operator">+</span>        newChildrenElements<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">newElement<span class="token punctuation">,</span>index</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span></span>
<span class="line"><span class="token operator">+</span>            <span class="token keyword">let</span> newKey <span class="token operator">=</span> newElement<span class="token punctuation">.</span>key<span class="token operator">||</span>index<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token operator">+</span>            <span class="token keyword">let</span> oldUnit <span class="token operator">=</span> oldChildUnitsMap<span class="token punctuation">[</span>newKey<span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token comment">//获得老的unit</span></span>
<span class="line"><span class="token operator">+</span>            <span class="token keyword">let</span> oldElement <span class="token operator">=</span> oldUnit<span class="token operator">&amp;&amp;</span>oldUnit<span class="token punctuation">.</span>_currentElement<span class="token punctuation">;</span><span class="token comment">//获得老的element</span></span>
<span class="line"><span class="token operator">+</span>            <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">shouldDeepCompare</span><span class="token punctuation">(</span>oldElement<span class="token punctuation">,</span>newElement<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token comment">//如果可以更进一步深比较</span></span>
<span class="line"><span class="token operator">+</span>                oldUnit<span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span>newElement<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token operator">+</span>                newChildren<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>oldUnit<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token operator">+</span>            <span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{</span></span>
<span class="line"><span class="token operator">+</span>                <span class="token keyword">let</span> newChildUnit <span class="token operator">=</span> <span class="token function">createUnit</span><span class="token punctuation">(</span>newElement<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//如果不需要深比较则直接创建新的unit</span></span>
<span class="line"><span class="token operator">+</span>                newChildren<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>newChildUnit<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token operator">+</span>            <span class="token punctuation">}</span></span>
<span class="line"><span class="token operator">+</span>        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token operator">+</span>        <span class="token keyword">return</span> newChildren<span class="token punctuation">;</span></span>
<span class="line"><span class="token operator">+</span>    <span class="token punctuation">}</span></span>
<span class="line"><span class="token operator">+</span>    <span class="token function">getChildrenMap</span><span class="token punctuation">(</span><span class="token parameter">childUnits<span class="token operator">=</span><span class="token punctuation">[</span><span class="token punctuation">]</span></span><span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line"><span class="token operator">+</span>        <span class="token keyword">let</span> map <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token operator">+</span>        <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">let</span> i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>i<span class="token operator">&lt;</span>childUnits<span class="token punctuation">.</span>length<span class="token punctuation">;</span>i<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line"><span class="token operator">+</span>            <span class="token keyword">let</span> key <span class="token operator">=</span> childUnits<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>key<span class="token operator">||</span>i<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token operator">+</span>            map<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token operator">=</span>childUnits<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token operator">+</span>        <span class="token punctuation">}</span></span>
<span class="line"><span class="token operator">+</span>        <span class="token keyword">return</span> map<span class="token punctuation">;</span></span>
<span class="line"><span class="token operator">+</span>    <span class="token punctuation">}</span></span>
<span class="line">    <span class="token function">updateDOMproperties</span><span class="token punctuation">(</span><span class="token parameter">oldProps<span class="token punctuation">,</span>newProps</span><span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">let</span> propName<span class="token punctuation">;</span></span>
<span class="line">        <span class="token comment">//把新属性对象上没有属性给删除掉</span></span>
<span class="line">        <span class="token keyword">for</span><span class="token punctuation">(</span>propName <span class="token keyword">in</span> oldProps<span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line">            <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>newProps<span class="token punctuation">.</span><span class="token function">hasOwnProperty</span><span class="token punctuation">(</span>propName<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line">                <span class="token function">$</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">\`</span><span class="token string">[data-reactid=&quot;</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">\${</span><span class="token keyword">this</span><span class="token punctuation">.</span>_reactid<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&quot;]</span><span class="token template-punctuation string">\`</span></span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">removeAttr</span><span class="token punctuation">(</span>propName<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">            <span class="token punctuation">}</span></span>
<span class="line">            <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">^on[A-Z]</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">.</span><span class="token function">test</span><span class="token punctuation">(</span>propName<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line">                <span class="token function">$</span><span class="token punctuation">(</span>document<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">undelegate</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">\`</span><span class="token string">.</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">\${</span><span class="token keyword">this</span><span class="token punctuation">.</span>_reactid<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">\`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">            <span class="token punctuation">}</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">        <span class="token keyword">for</span><span class="token punctuation">(</span>propName <span class="token keyword">in</span> newProps<span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line">            <span class="token keyword">if</span><span class="token punctuation">(</span>propName <span class="token operator">==</span> <span class="token string">&#39;children&#39;</span><span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line"></span>
<span class="line">            <span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">^on[A-Z]</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">.</span><span class="token function">test</span><span class="token punctuation">(</span>propName<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line">                <span class="token keyword">let</span> eventName <span class="token operator">=</span> propName<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toLowerCase</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">                <span class="token function">$</span><span class="token punctuation">(</span>document<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">undelegate</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">\`</span><span class="token string">.</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">\${</span><span class="token keyword">this</span><span class="token punctuation">.</span>_reactid<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">\`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">                <span class="token function">$</span><span class="token punctuation">(</span>document<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">delegate</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">\`</span><span class="token string">[data-reactid=&quot;</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">\${</span><span class="token keyword">this</span><span class="token punctuation">.</span>_reactid<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&quot;]</span><span class="token template-punctuation string">\`</span></span><span class="token punctuation">,</span><span class="token template-string"><span class="token template-punctuation string">\`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">\${</span>eventName<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">.</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">\${</span><span class="token keyword">this</span><span class="token punctuation">.</span>_reactid<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">\`</span></span><span class="token punctuation">,</span>newProps<span class="token punctuation">[</span>propName<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">            <span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>propName <span class="token operator">===</span> <span class="token string">&#39;style&#39;</span><span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line">                <span class="token keyword">let</span> styleObj <span class="token operator">=</span> newProps<span class="token punctuation">[</span>propName<span class="token punctuation">]</span><span class="token punctuation">;</span></span>
<span class="line">                Object<span class="token punctuation">.</span><span class="token function">entries</span><span class="token punctuation">(</span>styleObj<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">[</span>attr<span class="token punctuation">,</span>value<span class="token punctuation">]</span></span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span></span>
<span class="line">                  <span class="token function">$</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">\`</span><span class="token string">[data-reactid=&quot;</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">\${</span><span class="token keyword">this</span><span class="token punctuation">.</span>_reactid<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&quot;]</span><span class="token template-punctuation string">\`</span></span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">css</span><span class="token punctuation">(</span>attr<span class="token punctuation">,</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">                <span class="token punctuation">}</span><span class="token punctuation">)</span></span>
<span class="line">            <span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{</span></span>
<span class="line">                <span class="token function">$</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">\`</span><span class="token string">[data-reactid=&quot;</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">\${</span><span class="token keyword">this</span><span class="token punctuation">.</span>_reactid<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&quot;]</span><span class="token template-punctuation string">\`</span></span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">prop</span><span class="token punctuation">(</span>propName<span class="token punctuation">,</span>newProps<span class="token punctuation">[</span>propName<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">            <span class="token punctuation">}</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">class</span> <span class="token class-name">CompositeUnit</span> <span class="token keyword">extends</span> <span class="token class-name">Unit</span><span class="token punctuation">{</span></span>
<span class="line">    <span class="token comment">//接收到新的更新，自定义组件传第二个参数，原生组件和text传处一个参数</span></span>
<span class="line">    <span class="token function">update</span><span class="token punctuation">(</span><span class="token parameter">nextElement<span class="token punctuation">,</span>partialState</span><span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line">        <span class="token comment">//如果传过来了新的元素，则使用新的元素</span></span>
<span class="line">        <span class="token keyword">this</span><span class="token punctuation">.</span>_currentElement <span class="token operator">=</span> nextElement<span class="token operator">||</span><span class="token keyword">this</span><span class="token punctuation">.</span>_currentElement<span class="token punctuation">;</span></span>
<span class="line">        <span class="token comment">//获取新的状态对象和属性对象</span></span>
<span class="line">        <span class="token keyword">let</span> nextState <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_componentInstance<span class="token punctuation">.</span>state<span class="token operator">=</span> Object<span class="token punctuation">.</span><span class="token function">assign</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>_componentInstance<span class="token punctuation">.</span>state<span class="token punctuation">,</span>partialState<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">let</span> nextProps <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_currentElement<span class="token punctuation">.</span>props<span class="token punctuation">;</span></span>
<span class="line">        <span class="token comment">//如果shouldComponentUpdate返回了false则不需要继续更新</span></span>
<span class="line">        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>_componentInstance<span class="token punctuation">.</span>shouldComponentUpdate<span class="token operator">&amp;&amp;</span><span class="token keyword">this</span><span class="token punctuation">.</span>_componentInstance<span class="token punctuation">.</span><span class="token function">shouldComponentUpdate</span><span class="token punctuation">(</span>nextProps<span class="token punctuation">,</span>nextState<span class="token punctuation">)</span><span class="token operator">===</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token keyword">return</span><span class="token punctuation">;</span><span class="token punctuation">}</span></span>
<span class="line">        <span class="token comment">//获得上次渲染出来的unit实例 </span></span>
<span class="line">        <span class="token keyword">let</span> prevRenderedUnitInstance <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_renderedUnitInstance<span class="token punctuation">;</span></span>
<span class="line">        <span class="token comment">//从unit实例中获取</span></span>
<span class="line">        <span class="token keyword">let</span> prevRenderedElement <span class="token operator">=</span> prevRenderedUnitInstance<span class="token punctuation">.</span>_currentElement<span class="token punctuation">;</span></span>
<span class="line">        <span class="token comment">//获取新的虚拟DOM</span></span>
<span class="line">        <span class="token keyword">let</span> nextRenderElement <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_componentInstance<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token comment">//进行domdiff对比</span></span>
<span class="line">        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">shouldDeepCompare</span><span class="token punctuation">(</span>prevRenderedElement<span class="token punctuation">,</span>nextRenderElement<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line">            <span class="token comment">//如果需要更新，则继续调用子节点的upate方法进行更新,传入新的element更新子节点</span></span>
<span class="line">            prevRenderedUnitInstance<span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span>nextRenderElement<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">            <span class="token keyword">this</span><span class="token punctuation">.</span>_componentInstance<span class="token punctuation">.</span>componentDidUpdate<span class="token operator">&amp;&amp;</span><span class="token keyword">this</span><span class="token punctuation">.</span>_componentInstance<span class="token punctuation">.</span><span class="token function">componentDidUpdate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{</span></span>
<span class="line">            <span class="token comment">//如果发现不需要对比，干脆重新渲染</span></span>
<span class="line">            <span class="token keyword">this</span><span class="token punctuation">.</span>_renderedUnitInstance <span class="token operator">=</span>  <span class="token function">createUnit</span><span class="token punctuation">(</span>nextRenderElement<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">            <span class="token keyword">let</span> nextMarkUp <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_renderedUnitInstance<span class="token punctuation">.</span><span class="token function">getMarkUp</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>_reactid<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">            <span class="token comment">//替换整个节点</span></span>
<span class="line">            <span class="token function">$</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">\`</span><span class="token string">[data-reactid=&quot;</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">\${</span><span class="token keyword">this</span><span class="token punctuation">.</span>_reactid<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&quot;]</span><span class="token template-punctuation string">\`</span></span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">replaceWith</span><span class="token punctuation">(</span>nextMarkUp<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    <span class="token function">getMarkUp</span><span class="token punctuation">(</span><span class="token parameter">reactid</span><span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">this</span><span class="token punctuation">.</span>_reactid <span class="token operator">=</span> reactid<span class="token punctuation">;</span></span>
<span class="line">        <span class="token comment">//type是一个自定义组件的类的定义</span></span>
<span class="line">        <span class="token keyword">let</span> <span class="token punctuation">{</span><span class="token literal-property property">type</span><span class="token operator">:</span>Component<span class="token punctuation">,</span>props<span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_currentElement<span class="token punctuation">;</span></span>
<span class="line">        <span class="token comment">//创建Component类的实例</span></span>
<span class="line">        <span class="token keyword">let</span> componentInstance <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_componentInstance <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Component</span><span class="token punctuation">(</span>props<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token comment">//组件实例关联上自己的unit实例</span></span>
<span class="line">        componentInstance<span class="token punctuation">.</span>_currentUnit  <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token comment">//组件将要渲染</span></span>
<span class="line">        componentInstance<span class="token punctuation">.</span>componentWillMount<span class="token operator">&amp;&amp;</span>componentInstance<span class="token punctuation">.</span><span class="token function">componentWillMount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token comment">//执行render方法获得虚拟DOM元素实例</span></span>
<span class="line">        <span class="token keyword">let</span> renderedElement <span class="token operator">=</span> componentInstance<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token comment">//根据虚拟DOM元素得到unit,可能是TextUnit NativeUnit CompositeUnit</span></span>
<span class="line">        <span class="token keyword">let</span> renderedUnitInstance <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_renderedUnitInstance<span class="token operator">=</span> <span class="token function">createUnit</span><span class="token punctuation">(</span>renderedElement<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token comment">//获得此unit的HTML标记字符串</span></span>
<span class="line">        <span class="token keyword">let</span> renderedMarkUp <span class="token operator">=</span> renderedUnitInstance<span class="token punctuation">.</span><span class="token function">getMarkUp</span><span class="token punctuation">(</span>reactid<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token comment">//注册挂载完成的监听，越底层的组件越先监听，越先执行</span></span>
<span class="line">        <span class="token function">$</span><span class="token punctuation">(</span>document<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">&#39;mounted&#39;</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span>componentInstance<span class="token punctuation">.</span>componentDidMount<span class="token operator">&amp;&amp;</span>componentInstance<span class="token punctuation">.</span><span class="token function">componentDidMount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">return</span> renderedMarkUp<span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">function</span> <span class="token function">shouldDeepCompare</span><span class="token punctuation">(</span><span class="token parameter">prevElement<span class="token punctuation">,</span>nextElement</span><span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line">   <span class="token keyword">if</span><span class="token punctuation">(</span>prevElement<span class="token operator">!==</span><span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> nextElement<span class="token operator">!=</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line">       <span class="token keyword">let</span> prevType <span class="token operator">=</span> <span class="token keyword">typeof</span> prevElement<span class="token punctuation">;</span></span>
<span class="line">       <span class="token keyword">let</span> nextType <span class="token operator">=</span> <span class="token keyword">typeof</span> nextElement<span class="token punctuation">;</span></span>
<span class="line">       <span class="token comment">//如果新老节点都是文本可以进行比较</span></span>
<span class="line">       <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token punctuation">(</span>prevType <span class="token operator">===</span> <span class="token string">&#39;string&#39;</span> <span class="token operator">||</span>prevType <span class="token operator">===</span> <span class="token string">&#39;number&#39;</span><span class="token punctuation">)</span><span class="token operator">&amp;&amp;</span><span class="token punctuation">(</span>nextType <span class="token operator">===</span> <span class="token string">&#39;string&#39;</span> <span class="token operator">||</span>nextType <span class="token operator">===</span> <span class="token string">&#39;number&#39;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line">           <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span></span>
<span class="line">       <span class="token punctuation">}</span></span>
<span class="line">       <span class="token keyword">if</span><span class="token punctuation">(</span>prevElement <span class="token keyword">instanceof</span> <span class="token class-name">Element</span> <span class="token operator">&amp;&amp;</span> nextElement <span class="token keyword">instanceof</span> <span class="token class-name">Element</span><span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line">           <span class="token keyword">return</span> prevElement<span class="token punctuation">.</span>type <span class="token operator">===</span> nextElement<span class="token punctuation">.</span>type<span class="token punctuation">;</span></span>
<span class="line">       <span class="token punctuation">}</span></span>
<span class="line">   <span class="token punctuation">}</span>  </span>
<span class="line">   <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"><span class="token keyword">function</span> <span class="token function">createUnit</span><span class="token punctuation">(</span><span class="token parameter">element</span><span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line">  <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token keyword">typeof</span> element <span class="token operator">==</span><span class="token string">&#39;string&#39;</span> <span class="token operator">||</span> <span class="token keyword">typeof</span> element <span class="token operator">==</span><span class="token string">&#39;number&#39;</span><span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line">      <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">TextUnit</span><span class="token punctuation">(</span>element<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">  <span class="token punctuation">}</span></span>
<span class="line">  <span class="token keyword">if</span><span class="token punctuation">(</span>element <span class="token keyword">instanceof</span> <span class="token class-name">Element</span> <span class="token operator">&amp;&amp;</span> <span class="token keyword">typeof</span> element<span class="token punctuation">.</span>type <span class="token operator">===</span> <span class="token string">&#39;string&#39;</span><span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line">      <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">NativeUnit</span><span class="token punctuation">(</span>element<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">  <span class="token punctuation">}</span></span>
<span class="line">  <span class="token keyword">if</span><span class="token punctuation">(</span>element <span class="token keyword">instanceof</span> <span class="token class-name">Element</span> <span class="token operator">&amp;&amp;</span> <span class="token keyword">typeof</span> element<span class="token punctuation">.</span>type <span class="token operator">===</span> <span class="token string">&#39;function&#39;</span><span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line">      <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">CompositeUnit</span><span class="token punctuation">(</span>element<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">  <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">export</span> <span class="token punctuation">{</span></span>
<span class="line">    createUnit</span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="_9-获得补丁数组" tabindex="-1"><a class="header-anchor" href="#_9-获得补丁数组"><span>9. 获得补丁数组</span></a></h2><p><img src="http://img.zhufengpeixun.cn/diffold.png" alt="diffold"></p><p><img src="http://img.zhufengpeixun.cn/diffnew.png" alt="diffnew"></p><p><img src="http://img.zhufengpeixun.cn/domdiff2.gif" alt="domdiff2"></p><h3 id="_9-1-src-index-js" tabindex="-1"><a class="header-anchor" href="#_9-1-src-index-js"><span>9.1 src/index.js</span></a></h3><p>src/index.js</p><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code class="language-javascript"><span class="line"><span class="token keyword">import</span> React <span class="token keyword">from</span> <span class="token string">&#39;./react&#39;</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">class</span> <span class="token class-name">Counter</span> <span class="token keyword">extends</span> <span class="token class-name">React<span class="token punctuation">.</span>Component</span><span class="token punctuation">{</span></span>
<span class="line">  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter">props</span><span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">super</span><span class="token punctuation">(</span>props<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">this</span><span class="token punctuation">.</span>state <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token literal-property property">odd</span><span class="token operator">:</span><span class="token boolean">true</span><span class="token punctuation">}</span><span class="token punctuation">;</span></span>
<span class="line">  <span class="token punctuation">}</span></span>
<span class="line">  <span class="token function">componentDidMount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line">   <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">setState</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token literal-property property">odd</span><span class="token operator">:</span><span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">.</span>odd<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">   <span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">  <span class="token punctuation">}</span></span>
<span class="line">  <span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">.</span>odd<span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line">      <span class="token keyword">return</span> React<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">&#39;ul&#39;</span><span class="token punctuation">,</span><span class="token punctuation">{</span><span class="token literal-property property">key</span><span class="token operator">:</span><span class="token string">&#39;wrapper&#39;</span><span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">        React<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">&#39;li&#39;</span><span class="token punctuation">,</span><span class="token punctuation">{</span><span class="token literal-property property">key</span><span class="token operator">:</span><span class="token string">&#39;A&#39;</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token string">&#39;A&#39;</span><span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line">        React<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">&#39;li&#39;</span><span class="token punctuation">,</span><span class="token punctuation">{</span><span class="token literal-property property">key</span><span class="token operator">:</span><span class="token string">&#39;B&#39;</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token string">&#39;B&#39;</span><span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line">        React<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">&#39;li&#39;</span><span class="token punctuation">,</span><span class="token punctuation">{</span><span class="token literal-property property">key</span><span class="token operator">:</span><span class="token string">&#39;C&#39;</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token string">&#39;C&#39;</span><span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line">        React<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">&#39;li&#39;</span><span class="token punctuation">,</span><span class="token punctuation">{</span><span class="token literal-property property">key</span><span class="token operator">:</span><span class="token string">&#39;D&#39;</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token string">&#39;D&#39;</span><span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line">      <span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    <span class="token keyword">return</span> React<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">&#39;ul&#39;</span><span class="token punctuation">,</span><span class="token punctuation">{</span><span class="token literal-property property">key</span><span class="token operator">:</span><span class="token string">&#39;wrapper&#39;</span><span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">      React<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">&#39;li&#39;</span><span class="token punctuation">,</span><span class="token punctuation">{</span><span class="token literal-property property">key</span><span class="token operator">:</span><span class="token string">&#39;A&#39;</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token string">&#39;A1&#39;</span><span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line">      React<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">&#39;li&#39;</span><span class="token punctuation">,</span><span class="token punctuation">{</span><span class="token literal-property property">key</span><span class="token operator">:</span><span class="token string">&#39;C&#39;</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token string">&#39;C1&#39;</span><span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line">      React<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">&#39;li&#39;</span><span class="token punctuation">,</span><span class="token punctuation">{</span><span class="token literal-property property">key</span><span class="token operator">:</span><span class="token string">&#39;B&#39;</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token string">&#39;B1&#39;</span><span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line">      React<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">&#39;li&#39;</span><span class="token punctuation">,</span><span class="token punctuation">{</span><span class="token literal-property property">key</span><span class="token operator">:</span><span class="token string">&#39;E&#39;</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token string">&#39;E1&#39;</span><span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line">      React<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">&#39;li&#39;</span><span class="token punctuation">,</span><span class="token punctuation">{</span><span class="token literal-property property">key</span><span class="token operator">:</span><span class="token string">&#39;F&#39;</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token string">&#39;F1&#39;</span><span class="token punctuation">)</span></span>
<span class="line">      <span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">  <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"><span class="token keyword">let</span> element <span class="token operator">=</span> React<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span>Counter<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">React<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span>element<span class="token punctuation">,</span>document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">&#39;root&#39;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_9-2-src-react-unit-js" tabindex="-1"><a class="header-anchor" href="#_9-2-src-react-unit-js"><span>9.2 src/react/unit.js</span></a></h3><p>src/react/unit.js</p><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code class="language-javascript"><span class="line"><span class="token keyword">import</span> <span class="token punctuation">{</span>Element<span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&#39;./element&#39;</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">import</span> $ <span class="token keyword">from</span> <span class="token string">&#39;jquery&#39;</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token operator">+</span><span class="token keyword">import</span> types <span class="token keyword">from</span> <span class="token string">&#39;./types&#39;</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token operator">+</span><span class="token keyword">let</span> diffQueue <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token operator">+</span><span class="token keyword">let</span> updateDepth<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">class</span> <span class="token class-name">Unit</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter">element</span><span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">this</span><span class="token punctuation">.</span>_currentElement <span class="token operator">=</span> element<span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    <span class="token function">getMarkUp</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">&#39;不能调用此方法&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"><span class="token keyword">class</span> <span class="token class-name">TextUnit</span> <span class="token keyword">extends</span> <span class="token class-name">Unit</span><span class="token punctuation">{</span></span>
<span class="line">    <span class="token function">getMarkUp</span><span class="token punctuation">(</span><span class="token parameter">reactid</span><span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line">         <span class="token keyword">this</span><span class="token punctuation">.</span>_reactid <span class="token operator">=</span> reactid<span class="token punctuation">;</span><span class="token comment">//保存记录reactid</span></span>
<span class="line">        <span class="token comment">//返回文本节点对应的HTML字符串</span></span>
<span class="line">        <span class="token keyword">return</span> <span class="token template-string"><span class="token template-punctuation string">\`</span><span class="token string">&lt;span data-reactid=&quot;</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">\${</span>reactid<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&quot;&gt;</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">\${</span><span class="token keyword">this</span><span class="token punctuation">.</span>_currentElement<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&lt;/span&gt;</span><span class="token template-punctuation string">\`</span></span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    <span class="token function">update</span><span class="token punctuation">(</span><span class="token parameter">nextElement</span><span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>_currentElement <span class="token operator">!=</span> nextElement<span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line">            <span class="token keyword">this</span><span class="token punctuation">.</span>_currentElement <span class="token operator">=</span> nextElement<span class="token punctuation">;</span></span>
<span class="line">            <span class="token function">$</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">\`</span><span class="token string">[data-reactid=&quot;</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">\${</span><span class="token keyword">this</span><span class="token punctuation">.</span>_reactid<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&quot;]</span><span class="token template-punctuation string">\`</span></span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">html</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>_currentElement<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"><span class="token keyword">class</span> <span class="token class-name">NativeUnit</span> <span class="token keyword">extends</span> <span class="token class-name">Unit</span> <span class="token punctuation">{</span></span>
<span class="line">     <span class="token function">getMarkUp</span><span class="token punctuation">(</span><span class="token parameter">reactid</span><span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line">         <span class="token keyword">this</span><span class="token punctuation">.</span>_reactid <span class="token operator">=</span> reactid<span class="token punctuation">;</span><span class="token comment">//保存记录reactid</span></span>
<span class="line">        <span class="token comment">//返回文本节点对应的HTML字符串</span></span>
<span class="line">        <span class="token keyword">let</span> <span class="token punctuation">{</span>type<span class="token punctuation">,</span>props<span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_currentElement<span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">let</span> tagOpen <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">\`</span><span class="token string">&lt;</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">\${</span>type<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> data-reactid=&quot;</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">\${</span>reactid<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&quot; </span><span class="token template-punctuation string">\`</span></span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">let</span> tagClose <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">\`</span><span class="token string">&lt;/$type&gt;</span><span class="token template-punctuation string">\`</span></span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">let</span> content <span class="token operator">=</span> <span class="token string">&#39;&#39;</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">let</span> renderedChildUnits<span class="token operator">=</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">let</span> propName <span class="token keyword">in</span> props<span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line">            <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">^on[A-Z]</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">.</span><span class="token function">test</span><span class="token punctuation">(</span>propName<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line">                <span class="token keyword">let</span> eventName <span class="token operator">=</span> propName<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toLowerCase</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">                <span class="token function">$</span><span class="token punctuation">(</span>document<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">delegate</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">\`</span><span class="token string">[data-reactid=&quot;</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">\${</span>reactid<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&quot;]</span><span class="token template-punctuation string">\`</span></span><span class="token punctuation">,</span><span class="token template-string"><span class="token template-punctuation string">\`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">\${</span>eventName<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">.</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">\${</span>reactid<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">\`</span></span><span class="token punctuation">,</span>props<span class="token punctuation">[</span>propName<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">            <span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>propName <span class="token operator">===</span> <span class="token string">&#39;style&#39;</span><span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line">                <span class="token keyword">let</span> styleObj <span class="token operator">=</span> props<span class="token punctuation">[</span>propName<span class="token punctuation">]</span><span class="token punctuation">;</span></span>
<span class="line">                <span class="token keyword">let</span> styles <span class="token operator">=</span> Object<span class="token punctuation">.</span><span class="token function">keys</span><span class="token punctuation">(</span>styleObj<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token parameter">attr</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span></span>
<span class="line">                    <span class="token keyword">let</span> attrName <span class="token operator">=</span> attr<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">([A-Z])</span><span class="token regex-delimiter">/</span><span class="token regex-flags">g</span></span><span class="token punctuation">,</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">matched<span class="token punctuation">,</span>group</span><span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line">                        <span class="token keyword">return</span> <span class="token template-string"><span class="token template-punctuation string">\`</span><span class="token string">-</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">\${</span>group<span class="token punctuation">.</span><span class="token function">toLowerCase</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">\`</span></span><span class="token punctuation">;</span></span>
<span class="line">                    <span class="token punctuation">}</span><span class="token punctuation">)</span></span>
<span class="line">                    <span class="token keyword">return</span> <span class="token template-string"><span class="token template-punctuation string">\`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">\${</span>attrName<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">:</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">\${</span>styleObj<span class="token punctuation">[</span>attr<span class="token punctuation">]</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">\`</span></span><span class="token punctuation">;</span></span>
<span class="line">                <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token string">&#39;;&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">                tagOpen <span class="token operator">+=</span> <span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">\`</span><span class="token string"> style=&quot;</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">\${</span>styles<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&quot; </span><span class="token template-punctuation string">\`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">            <span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>propName <span class="token operator">===</span> <span class="token string">&#39;children&#39;</span><span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line">                <span class="token keyword">let</span> children <span class="token operator">=</span> props<span class="token punctuation">.</span>children<span class="token operator">||</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span></span>
<span class="line">                children<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">child<span class="token punctuation">,</span>index</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span></span>
<span class="line">                    <span class="token keyword">let</span> childUnit <span class="token operator">=</span> <span class="token function">createUnit</span><span class="token punctuation">(</span>child<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">                    childUnit<span class="token punctuation">.</span>_mountIndex <span class="token operator">=</span> index<span class="token punctuation">;</span></span>
<span class="line">                    renderedChildUnits<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>childUnit<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">                    <span class="token keyword">let</span> childMarkUp <span class="token operator">=</span> childUnit<span class="token punctuation">.</span><span class="token function">getMarkUp</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">\`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">\${</span>reactid<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">.</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">\${</span>index<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">\`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">                    content <span class="token operator">+=</span> childMarkUp<span class="token punctuation">;</span></span>
<span class="line">                <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">            <span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{</span></span>
<span class="line">                tagOpen <span class="token operator">+=</span> <span class="token template-string"><span class="token template-punctuation string">\`</span><span class="token string"> </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">\${</span>propName<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">=</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">\${</span>props<span class="token punctuation">[</span>propName<span class="token punctuation">]</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> </span><span class="token template-punctuation string">\`</span></span><span class="token punctuation">;</span></span>
<span class="line">            <span class="token punctuation">}</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">        <span class="token keyword">this</span><span class="token punctuation">.</span>_renderedChildUnits <span class="token operator">=</span> renderedChildUnits<span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">return</span> tagOpen <span class="token operator">+</span> <span class="token string">&#39;&gt;&#39;</span> <span class="token operator">+</span> content <span class="token operator">+</span> tagClose<span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    <span class="token function">update</span><span class="token punctuation">(</span><span class="token parameter">nextElement</span><span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">let</span> oldProps <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_currentElement<span class="token punctuation">.</span>props<span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">let</span> newProps <span class="token operator">=</span> nextElement<span class="token punctuation">.</span>props<span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">updateDOMproperties</span><span class="token punctuation">(</span>oldProps<span class="token punctuation">,</span>newProps<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">updateDOMChildren</span><span class="token punctuation">(</span>nextElement<span class="token punctuation">.</span>props<span class="token punctuation">.</span>children<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    <span class="token comment">//对比子元素</span></span>
<span class="line"><span class="token operator">+</span>    <span class="token function">updateDOMChildren</span><span class="token punctuation">(</span><span class="token parameter">newChildrenElements</span><span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line"><span class="token operator">+</span>        updateDepth<span class="token operator">++</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token operator">+</span>        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">diff</span><span class="token punctuation">(</span>diffQueue<span class="token punctuation">,</span>newChildrenElements<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token operator">+</span>        updateDepth<span class="token operator">--</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token operator">+</span>        <span class="token keyword">if</span><span class="token punctuation">(</span>updateDepth<span class="token operator">===</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line"><span class="token operator">+</span>            console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&#39;diffQueue&#39;</span><span class="token punctuation">,</span>diffQueue<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token operator">+</span>            diffQueue<span class="token operator">=</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token operator">+</span>        <span class="token punctuation">}</span></span>
<span class="line"><span class="token operator">+</span>    <span class="token punctuation">}</span></span>
<span class="line"><span class="token operator">+</span>    <span class="token function">diff</span><span class="token punctuation">(</span><span class="token parameter">diffQueue<span class="token punctuation">,</span>newChildrenElements</span><span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line"><span class="token operator">+</span>        <span class="token keyword">let</span> oldChildUnitsMap <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getChildrenMap</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>_renderedChildUnits<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token operator">+</span>        <span class="token keyword">let</span> <span class="token punctuation">{</span>newChildrenMap<span class="token punctuation">,</span>newChildren<span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getNewChildren</span><span class="token punctuation">(</span>oldChildUnitsMap<span class="token punctuation">,</span>newChildrenElements<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token operator">+</span>        <span class="token comment">// lastIndex里存放着被复用的子元素的最大索引</span></span>
<span class="line"><span class="token operator">+</span>        <span class="token keyword">let</span> lastIndex <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token operator">+</span>        <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">let</span> i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>i<span class="token operator">&lt;</span>newChildren<span class="token punctuation">.</span>length<span class="token punctuation">;</span>i<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line"><span class="token operator">+</span>            <span class="token keyword">let</span> newChild <span class="token operator">=</span> newChildren<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token comment">//取得新元素</span></span>
<span class="line"><span class="token operator">+</span>            <span class="token keyword">let</span> newKey <span class="token operator">=</span> <span class="token punctuation">(</span>newChild<span class="token punctuation">.</span>_currentElement<span class="token punctuation">.</span>props<span class="token operator">&amp;&amp;</span>newChild<span class="token punctuation">.</span>_currentElement<span class="token punctuation">.</span>key<span class="token punctuation">)</span><span class="token operator">||</span>i<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//取得新key</span></span>
<span class="line"><span class="token operator">+</span>            <span class="token keyword">let</span> oldChild <span class="token operator">=</span> oldChildUnitsMap<span class="token punctuation">[</span>newKey<span class="token punctuation">]</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token operator">+</span>            <span class="token keyword">if</span><span class="token punctuation">(</span>oldChild <span class="token operator">===</span> newChild<span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line"><span class="token operator">+</span>                <span class="token keyword">if</span><span class="token punctuation">(</span>oldChild<span class="token punctuation">.</span>_mountIndex <span class="token operator">&lt;</span> lastIndex<span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line"><span class="token operator">+</span>                    diffQueue<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token punctuation">{</span></span>
<span class="line"><span class="token operator">+</span>                        parentId<span class="token operator">:</span><span class="token keyword">this</span><span class="token punctuation">.</span>_reactid<span class="token punctuation">,</span></span>
<span class="line"><span class="token operator">+</span>                        parentNode<span class="token operator">:</span><span class="token function">$</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">\`</span><span class="token string">[data-reactid=&quot;</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">\${</span><span class="token keyword">this</span><span class="token punctuation">.</span>_reactid<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&quot;]</span><span class="token template-punctuation string">\`</span></span><span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line"><span class="token operator">+</span>                        type<span class="token operator">:</span>types<span class="token punctuation">.</span><span class="token constant">MOVE</span><span class="token punctuation">,</span></span>
<span class="line"><span class="token operator">+</span>                        fromIndex<span class="token operator">:</span>oldChild<span class="token punctuation">.</span>_mountIndex<span class="token punctuation">,</span></span>
<span class="line"><span class="token operator">+</span>                        toIndex<span class="token operator">:</span>i</span>
<span class="line"><span class="token operator">+</span>                    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token operator">+</span>                <span class="token punctuation">}</span></span>
<span class="line"><span class="token operator">+</span>                lastIndex <span class="token operator">=</span> Math<span class="token punctuation">.</span><span class="token function">max</span><span class="token punctuation">(</span>oldChild<span class="token punctuation">.</span>_mountIndex<span class="token punctuation">,</span>lastIndex<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token operator">+</span>                <span class="token comment">//否则根本不用移动，直接修改挂载索引为新索引i即可</span></span>
<span class="line"><span class="token operator">+</span>            <span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{</span></span>
<span class="line"><span class="token operator">+</span>                <span class="token keyword">if</span><span class="token punctuation">(</span>oldChild<span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line"><span class="token operator">+</span>                    diffQueue<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token punctuation">{</span></span>
<span class="line"><span class="token operator">+</span>                        parentId<span class="token operator">:</span><span class="token keyword">this</span><span class="token punctuation">.</span>_reactid<span class="token punctuation">,</span></span>
<span class="line"><span class="token operator">+</span>                        parentNode<span class="token operator">:</span><span class="token function">$</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">\`</span><span class="token string">[data-reactid=&quot;</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">\${</span><span class="token keyword">this</span><span class="token punctuation">.</span>_reactid<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&quot;]</span><span class="token template-punctuation string">\`</span></span><span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line"><span class="token operator">+</span>                        type<span class="token operator">:</span>types<span class="token punctuation">.</span><span class="token constant">REMOVE</span><span class="token punctuation">,</span></span>
<span class="line"><span class="token operator">+</span>                        fromIndex<span class="token operator">:</span>oldChild<span class="token punctuation">.</span>_mountIndex</span>
<span class="line"><span class="token operator">+</span>                    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token operator">+</span>                    <span class="token function">$</span><span class="token punctuation">(</span>document<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">undelegate</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">\`</span><span class="token string">.</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">\${</span>oldChild<span class="token punctuation">.</span>_reactid<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">\`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token operator">+</span>                <span class="token punctuation">}</span></span>
<span class="line"><span class="token operator">+</span>                 diffQueue<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token punctuation">{</span></span>
<span class="line"><span class="token operator">+</span>                        parentId<span class="token operator">:</span><span class="token keyword">this</span><span class="token punctuation">.</span>_reactid<span class="token punctuation">,</span></span>
<span class="line"><span class="token operator">+</span>                        parentNode<span class="token operator">:</span><span class="token function">$</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">\`</span><span class="token string">[data-reactid=&quot;</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">\${</span><span class="token keyword">this</span><span class="token punctuation">.</span>_reactid<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&quot;]</span><span class="token template-punctuation string">\`</span></span><span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line"><span class="token operator">+</span>                        type<span class="token operator">:</span>types<span class="token punctuation">.</span><span class="token constant">INSERT</span><span class="token punctuation">,</span></span>
<span class="line"><span class="token operator">+</span>                        toIndex<span class="token operator">:</span>i<span class="token punctuation">,</span></span>
<span class="line"><span class="token operator">+</span>                        markUp<span class="token operator">:</span>newChild<span class="token punctuation">.</span><span class="token function">getMarkUp</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">\`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">\${</span><span class="token keyword">this</span><span class="token punctuation">.</span>_reactid<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">.</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">\${</span>i<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">\`</span></span><span class="token punctuation">)</span></span>
<span class="line"><span class="token operator">+</span>                <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token operator">+</span>            <span class="token punctuation">}</span></span>
<span class="line"><span class="token operator">+</span>            newChild<span class="token punctuation">.</span>_mountIndex <span class="token operator">=</span> i<span class="token punctuation">;</span></span>
<span class="line"><span class="token operator">+</span>        <span class="token punctuation">}</span></span>
<span class="line"><span class="token operator">+</span>        <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">let</span> oldKey <span class="token keyword">in</span> oldChildUnitsMap<span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line"><span class="token operator">+</span>            <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>newChildrenMap<span class="token punctuation">.</span><span class="token function">hasOwnProperty</span><span class="token punctuation">(</span>oldKey<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line"><span class="token operator">+</span>                <span class="token keyword">let</span> oldChild <span class="token operator">=</span> oldChildUnitsMap<span class="token punctuation">[</span>oldKey<span class="token punctuation">]</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token operator">+</span>                diffQueue<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token punctuation">{</span></span>
<span class="line"><span class="token operator">+</span>                        parentId<span class="token operator">:</span><span class="token keyword">this</span><span class="token punctuation">.</span>_reactid<span class="token punctuation">,</span></span>
<span class="line"><span class="token operator">+</span>                        parentNode<span class="token operator">:</span><span class="token function">$</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">\`</span><span class="token string">[data-reactid=&quot;</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">\${</span><span class="token keyword">this</span><span class="token punctuation">.</span>_reactid<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&quot;]</span><span class="token template-punctuation string">\`</span></span><span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line"><span class="token operator">+</span>                        type<span class="token operator">:</span>types<span class="token punctuation">.</span><span class="token constant">REMOVE</span><span class="token punctuation">,</span></span>
<span class="line"><span class="token operator">+</span>                        fromIndex<span class="token operator">:</span>oldChild<span class="token punctuation">.</span>_mountIndex</span>
<span class="line"><span class="token operator">+</span>                <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token operator">+</span>            <span class="token punctuation">}</span></span>
<span class="line"><span class="token operator">+</span>        <span class="token punctuation">}</span></span>
<span class="line"><span class="token operator">+</span>    <span class="token punctuation">}</span></span>
<span class="line"><span class="token operator">+</span>    <span class="token function">getNewChildren</span><span class="token punctuation">(</span><span class="token parameter">oldChildUnitsMap<span class="token punctuation">,</span>newChildrenElements</span><span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line"><span class="token operator">+</span>        <span class="token keyword">let</span> newChildren <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token operator">+</span>        <span class="token keyword">let</span> newChildrenMap<span class="token operator">=</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token operator">+</span>        newChildrenElements<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">newElement<span class="token punctuation">,</span>index</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span></span>
<span class="line"><span class="token operator">+</span>            <span class="token keyword">let</span> newKey <span class="token operator">=</span> newElement<span class="token punctuation">.</span>key<span class="token operator">||</span>index<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token operator">+</span>            <span class="token keyword">let</span> oldUnit <span class="token operator">=</span> oldChildUnitsMap<span class="token punctuation">[</span>newKey<span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token comment">//获得老的unit</span></span>
<span class="line"><span class="token operator">+</span>            <span class="token keyword">let</span> oldElement <span class="token operator">=</span> oldUnit<span class="token operator">&amp;&amp;</span>oldUnit<span class="token punctuation">.</span>_currentElement<span class="token punctuation">;</span><span class="token comment">//获得老的element</span></span>
<span class="line"><span class="token operator">+</span>            <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">shouldDeepCompare</span><span class="token punctuation">(</span>oldElement<span class="token punctuation">,</span>newElement<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token comment">//如果可以更进一步深比较</span></span>
<span class="line"><span class="token operator">+</span>                oldUnit<span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span>newElement<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token operator">+</span>                newChildren<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>oldUnit<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token operator">+</span>                newChildrenMap<span class="token punctuation">[</span>newKey<span class="token punctuation">]</span><span class="token operator">=</span>oldUnit<span class="token punctuation">;</span></span>
<span class="line"><span class="token operator">+</span>            <span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{</span></span>
<span class="line"><span class="token operator">+</span>                <span class="token keyword">let</span> newChildUnit <span class="token operator">=</span> <span class="token function">createUnit</span><span class="token punctuation">(</span>newElement<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//如果不需要深比较则直接创建新的unit</span></span>
<span class="line"><span class="token operator">+</span>                newChildren<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>newChildUnit<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token operator">+</span>                 newChildrenMap<span class="token punctuation">[</span>newKey<span class="token punctuation">]</span><span class="token operator">=</span>newChildUnit<span class="token punctuation">;</span></span>
<span class="line"><span class="token operator">+</span>            <span class="token punctuation">}</span></span>
<span class="line"><span class="token operator">+</span>        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token operator">+</span>        <span class="token keyword">return</span> <span class="token punctuation">{</span>newChildrenMap<span class="token punctuation">,</span>newChildren<span class="token punctuation">}</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token operator">+</span>    <span class="token punctuation">}</span></span>
<span class="line"><span class="token operator">+</span>    <span class="token function">getChildrenMap</span><span class="token punctuation">(</span><span class="token parameter">childUnits<span class="token operator">=</span><span class="token punctuation">[</span><span class="token punctuation">]</span></span><span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line"><span class="token operator">+</span>        <span class="token keyword">let</span> map <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token operator">+</span>        <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">let</span> i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>i<span class="token operator">&lt;</span>childUnits<span class="token punctuation">.</span>length<span class="token punctuation">;</span>i<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line"><span class="token operator">+</span>            <span class="token keyword">let</span> key <span class="token operator">=</span> <span class="token punctuation">(</span>childUnits<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>_currentElement<span class="token punctuation">.</span>props<span class="token operator">&amp;&amp;</span>childUnits<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>_currentElement<span class="token punctuation">.</span>props<span class="token punctuation">.</span>key<span class="token punctuation">)</span><span class="token operator">||</span>i<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token operator">+</span>            map<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token operator">=</span>childUnits<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token operator">+</span>        <span class="token punctuation">}</span></span>
<span class="line"><span class="token operator">+</span>        <span class="token keyword">return</span> map<span class="token punctuation">;</span></span>
<span class="line"><span class="token operator">+</span>    <span class="token punctuation">}</span></span>
<span class="line"><span class="token operator">+</span>    <span class="token function">updateDOMproperties</span><span class="token punctuation">(</span><span class="token parameter">oldProps<span class="token punctuation">,</span>newProps</span><span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line"><span class="token operator">+</span>        <span class="token keyword">let</span> propName<span class="token punctuation">;</span></span>
<span class="line"><span class="token operator">+</span>        <span class="token comment">//把新属性对象上没有属性给删除掉</span></span>
<span class="line"><span class="token operator">+</span>        <span class="token keyword">for</span><span class="token punctuation">(</span>propName <span class="token keyword">in</span> oldProps<span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line"><span class="token operator">+</span>            <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>newProps<span class="token punctuation">.</span><span class="token function">hasOwnProperty</span><span class="token punctuation">(</span>propName<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line"><span class="token operator">+</span>                <span class="token function">$</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">\`</span><span class="token string">[data-reactid=&quot;</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">\${</span><span class="token keyword">this</span><span class="token punctuation">.</span>_reactid<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&quot;]</span><span class="token template-punctuation string">\`</span></span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">removeAttr</span><span class="token punctuation">(</span>propName<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token operator">+</span>            <span class="token punctuation">}</span></span>
<span class="line"><span class="token operator">+</span>            <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">^on[A-Z]</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">.</span><span class="token function">test</span><span class="token punctuation">(</span>propName<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line"><span class="token operator">+</span>                <span class="token function">$</span><span class="token punctuation">(</span>document<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">undelegate</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">\`</span><span class="token string">.</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">\${</span><span class="token keyword">this</span><span class="token punctuation">.</span>_reactid<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">\`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token operator">+</span>            <span class="token punctuation">}</span></span>
<span class="line"><span class="token operator">+</span>        <span class="token punctuation">}</span></span>
<span class="line"><span class="token operator">+</span>        <span class="token keyword">for</span><span class="token punctuation">(</span>propName <span class="token keyword">in</span> newProps<span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line"><span class="token operator">+</span>            <span class="token keyword">if</span><span class="token punctuation">(</span>propName <span class="token operator">==</span> <span class="token string">&#39;children&#39;</span><span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line"><span class="token operator">+</span>                </span>
<span class="line"><span class="token operator">+</span>            <span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">^on[A-Z]</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">.</span><span class="token function">test</span><span class="token punctuation">(</span>propName<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line"><span class="token operator">+</span>                <span class="token keyword">let</span> eventName <span class="token operator">=</span> propName<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toLowerCase</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token operator">+</span>                <span class="token function">$</span><span class="token punctuation">(</span>document<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">undelegate</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">\`</span><span class="token string">.</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">\${</span><span class="token keyword">this</span><span class="token punctuation">.</span>_reactid<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">\`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token operator">+</span>                <span class="token function">$</span><span class="token punctuation">(</span>document<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">delegate</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">\`</span><span class="token string">[data-reactid=&quot;</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">\${</span><span class="token keyword">this</span><span class="token punctuation">.</span>_reactid<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&quot;]</span><span class="token template-punctuation string">\`</span></span><span class="token punctuation">,</span><span class="token template-string"><span class="token template-punctuation string">\`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">\${</span>eventName<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">.</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">\${</span><span class="token keyword">this</span><span class="token punctuation">.</span>_reactid<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">\`</span></span><span class="token punctuation">,</span>newProps<span class="token punctuation">[</span>propName<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token operator">+</span>            <span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>propName <span class="token operator">===</span> <span class="token string">&#39;style&#39;</span><span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line"><span class="token operator">+</span>                <span class="token keyword">let</span> styleObj <span class="token operator">=</span> newProps<span class="token punctuation">[</span>propName<span class="token punctuation">]</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token operator">+</span>                Object<span class="token punctuation">.</span><span class="token function">entries</span><span class="token punctuation">(</span>styleObj<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">[</span>attr<span class="token punctuation">,</span>value<span class="token punctuation">]</span></span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span></span>
<span class="line"><span class="token operator">+</span>                  <span class="token function">$</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">\`</span><span class="token string">[data-reactid=&quot;</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">\${</span><span class="token keyword">this</span><span class="token punctuation">.</span>_reactid<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&quot;]</span><span class="token template-punctuation string">\`</span></span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">css</span><span class="token punctuation">(</span>attr<span class="token punctuation">,</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token operator">+</span>                <span class="token punctuation">}</span><span class="token punctuation">)</span></span>
<span class="line"><span class="token operator">+</span>            <span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{</span></span>
<span class="line"><span class="token operator">+</span>                <span class="token function">$</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">\`</span><span class="token string">[data-reactid=&quot;</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">\${</span><span class="token keyword">this</span><span class="token punctuation">.</span>_reactid<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&quot;]</span><span class="token template-punctuation string">\`</span></span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">prop</span><span class="token punctuation">(</span>propName<span class="token punctuation">,</span>newProps<span class="token punctuation">[</span>propName<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token operator">+</span>            <span class="token punctuation">}</span></span>
<span class="line"><span class="token operator">+</span>        <span class="token punctuation">}</span></span>
<span class="line"><span class="token operator">+</span>    <span class="token punctuation">}</span></span>
<span class="line"><span class="token operator">+</span><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">class</span> <span class="token class-name">CompositeUnit</span> <span class="token keyword">extends</span> <span class="token class-name">Unit</span><span class="token punctuation">{</span></span>
<span class="line">    <span class="token comment">//接收到新的更新，自定义组件传第二个参数，原生组件和text传处一个参数</span></span>
<span class="line">    <span class="token function">update</span><span class="token punctuation">(</span><span class="token parameter">nextElement<span class="token punctuation">,</span>partialState</span><span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line">        <span class="token comment">//如果传过来了新的元素，则使用新的元素</span></span>
<span class="line">        <span class="token keyword">this</span><span class="token punctuation">.</span>_currentElement <span class="token operator">=</span> nextElement<span class="token operator">||</span><span class="token keyword">this</span><span class="token punctuation">.</span>_currentElement<span class="token punctuation">;</span></span>
<span class="line">        <span class="token comment">//获取新的状态对象和属性对象</span></span>
<span class="line">        <span class="token keyword">let</span> nextState <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_componentInstance<span class="token punctuation">.</span>state<span class="token operator">=</span> Object<span class="token punctuation">.</span><span class="token function">assign</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>_componentInstance<span class="token punctuation">.</span>state<span class="token punctuation">,</span>partialState<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">let</span> nextProps <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_currentElement<span class="token punctuation">.</span>props<span class="token punctuation">;</span></span>
<span class="line">        <span class="token comment">//如果shouldComponentUpdate返回了false则不需要继续更新</span></span>
<span class="line">        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>_componentInstance<span class="token punctuation">.</span>shouldComponentUpdate<span class="token operator">&amp;&amp;</span><span class="token keyword">this</span><span class="token punctuation">.</span>_componentInstance<span class="token punctuation">.</span><span class="token function">shouldComponentUpdate</span><span class="token punctuation">(</span>nextProps<span class="token punctuation">,</span>nextState<span class="token punctuation">)</span><span class="token operator">===</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token keyword">return</span><span class="token punctuation">;</span><span class="token punctuation">}</span></span>
<span class="line">        <span class="token comment">//获得上次渲染出来的unit实例 </span></span>
<span class="line">        <span class="token keyword">let</span> prevRenderedUnitInstance <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_renderedUnitInstance<span class="token punctuation">;</span></span>
<span class="line">        <span class="token comment">//从unit实例中获取</span></span>
<span class="line">        <span class="token keyword">let</span> prevRenderedElement <span class="token operator">=</span> prevRenderedUnitInstance<span class="token punctuation">.</span>_currentElement<span class="token punctuation">;</span></span>
<span class="line">        <span class="token comment">//获取新的虚拟DOM</span></span>
<span class="line">        <span class="token keyword">let</span> nextRenderElement <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_componentInstance<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token comment">//进行domdiff对比</span></span>
<span class="line">        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">shouldDeepCompare</span><span class="token punctuation">(</span>prevRenderedElement<span class="token punctuation">,</span>nextRenderElement<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line">            <span class="token comment">//如果需要更新，则继续调用子节点的upate方法进行更新,传入新的element更新子节点</span></span>
<span class="line">            prevRenderedUnitInstance<span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span>nextRenderElement<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">            <span class="token keyword">this</span><span class="token punctuation">.</span>_componentInstance<span class="token punctuation">.</span>componentDidUpdate<span class="token operator">&amp;&amp;</span><span class="token keyword">this</span><span class="token punctuation">.</span>_componentInstance<span class="token punctuation">.</span><span class="token function">componentDidUpdate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{</span></span>
<span class="line">            <span class="token comment">//如果发现不需要对比，干脆重新渲染</span></span>
<span class="line">            <span class="token keyword">this</span><span class="token punctuation">.</span>_renderedUnitInstance <span class="token operator">=</span>  <span class="token function">createUnit</span><span class="token punctuation">(</span>nextRenderElement<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">            <span class="token keyword">let</span> nextMarkUp <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_renderedUnitInstance<span class="token punctuation">.</span><span class="token function">getMarkUp</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>_reactid<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">            <span class="token comment">//替换整个节点</span></span>
<span class="line">            <span class="token function">$</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">\`</span><span class="token string">[data-reactid=&quot;</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">\${</span><span class="token keyword">this</span><span class="token punctuation">.</span>_reactid<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&quot;]</span><span class="token template-punctuation string">\`</span></span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">replaceWith</span><span class="token punctuation">(</span>nextMarkUp<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    <span class="token function">getMarkUp</span><span class="token punctuation">(</span><span class="token parameter">reactid</span><span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">this</span><span class="token punctuation">.</span>_reactid <span class="token operator">=</span> reactid<span class="token punctuation">;</span></span>
<span class="line">        <span class="token comment">//type是一个自定义组件的类的定义</span></span>
<span class="line">        <span class="token keyword">let</span> <span class="token punctuation">{</span><span class="token literal-property property">type</span><span class="token operator">:</span>Component<span class="token punctuation">,</span>props<span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_currentElement<span class="token punctuation">;</span></span>
<span class="line">        <span class="token comment">//创建Component类的实例</span></span>
<span class="line">        <span class="token keyword">let</span> componentInstance <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_componentInstance <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Component</span><span class="token punctuation">(</span>props<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token comment">//组件实例关联上自己的unit实例</span></span>
<span class="line">        componentInstance<span class="token punctuation">.</span>_currentUnit  <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token comment">//组件将要渲染</span></span>
<span class="line">        componentInstance<span class="token punctuation">.</span>componentWillMount<span class="token operator">&amp;&amp;</span>componentInstance<span class="token punctuation">.</span><span class="token function">componentWillMount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token comment">//执行render方法获得虚拟DOM元素实例</span></span>
<span class="line">        <span class="token keyword">let</span> renderedElement <span class="token operator">=</span> componentInstance<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token comment">//根据虚拟DOM元素得到unit,可能是TextUnit NativeUnit CompositeUnit</span></span>
<span class="line">        <span class="token keyword">let</span> renderedUnitInstance <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_renderedUnitInstance<span class="token operator">=</span> <span class="token function">createUnit</span><span class="token punctuation">(</span>renderedElement<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token comment">//获得此unit的HTML标记字符串</span></span>
<span class="line">        <span class="token keyword">let</span> renderedMarkUp <span class="token operator">=</span> renderedUnitInstance<span class="token punctuation">.</span><span class="token function">getMarkUp</span><span class="token punctuation">(</span>reactid<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token comment">//注册挂载完成的监听，越底层的组件越先监听，越先执行</span></span>
<span class="line">        <span class="token function">$</span><span class="token punctuation">(</span>document<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">&#39;mounted&#39;</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span>componentInstance<span class="token punctuation">.</span>componentDidMount<span class="token operator">&amp;&amp;</span>componentInstance<span class="token punctuation">.</span><span class="token function">componentDidMount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">return</span> renderedMarkUp<span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">function</span> <span class="token function">shouldDeepCompare</span><span class="token punctuation">(</span><span class="token parameter">prevElement<span class="token punctuation">,</span>nextElement</span><span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line">   <span class="token keyword">if</span><span class="token punctuation">(</span>prevElement<span class="token operator">!==</span><span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> nextElement<span class="token operator">!=</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line">       <span class="token keyword">let</span> prevType <span class="token operator">=</span> <span class="token keyword">typeof</span> prevElement<span class="token punctuation">;</span></span>
<span class="line">       <span class="token keyword">let</span> nextType <span class="token operator">=</span> <span class="token keyword">typeof</span> nextElement<span class="token punctuation">;</span></span>
<span class="line">       <span class="token comment">//如果新老节点都是文本可以进行比较</span></span>
<span class="line">       <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token punctuation">(</span>prevType <span class="token operator">===</span> <span class="token string">&#39;string&#39;</span> <span class="token operator">||</span>prevType <span class="token operator">===</span> <span class="token string">&#39;number&#39;</span><span class="token punctuation">)</span><span class="token operator">&amp;&amp;</span><span class="token punctuation">(</span>nextType <span class="token operator">===</span> <span class="token string">&#39;string&#39;</span> <span class="token operator">||</span>nextType <span class="token operator">===</span> <span class="token string">&#39;number&#39;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line">           <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span></span>
<span class="line">       <span class="token punctuation">}</span></span>
<span class="line">       <span class="token keyword">if</span><span class="token punctuation">(</span>prevElement <span class="token keyword">instanceof</span> <span class="token class-name">Element</span> <span class="token operator">&amp;&amp;</span> nextElement <span class="token keyword">instanceof</span> <span class="token class-name">Element</span><span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line">           <span class="token keyword">return</span> prevElement<span class="token punctuation">.</span>type <span class="token operator">===</span> nextElement<span class="token punctuation">.</span>type<span class="token punctuation">;</span></span>
<span class="line">       <span class="token punctuation">}</span></span>
<span class="line">   <span class="token punctuation">}</span>  </span>
<span class="line">   <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"><span class="token keyword">function</span> <span class="token function">createUnit</span><span class="token punctuation">(</span><span class="token parameter">element</span><span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line">  <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token keyword">typeof</span> element <span class="token operator">==</span><span class="token string">&#39;string&#39;</span> <span class="token operator">||</span> <span class="token keyword">typeof</span> element <span class="token operator">==</span><span class="token string">&#39;number&#39;</span><span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line">      <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">TextUnit</span><span class="token punctuation">(</span>element<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">  <span class="token punctuation">}</span></span>
<span class="line">  <span class="token keyword">if</span><span class="token punctuation">(</span>element <span class="token keyword">instanceof</span> <span class="token class-name">Element</span> <span class="token operator">&amp;&amp;</span> <span class="token keyword">typeof</span> element<span class="token punctuation">.</span>type <span class="token operator">===</span> <span class="token string">&#39;string&#39;</span><span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line">      <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">NativeUnit</span><span class="token punctuation">(</span>element<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">  <span class="token punctuation">}</span></span>
<span class="line">  <span class="token keyword">if</span><span class="token punctuation">(</span>element <span class="token keyword">instanceof</span> <span class="token class-name">Element</span> <span class="token operator">&amp;&amp;</span> <span class="token keyword">typeof</span> element<span class="token punctuation">.</span>type <span class="token operator">===</span> <span class="token string">&#39;function&#39;</span><span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line">      <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">CompositeUnit</span><span class="token punctuation">(</span>element<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">  <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">export</span> <span class="token punctuation">{</span></span>
<span class="line">    createUnit</span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_9-3-types-js" tabindex="-1"><a class="header-anchor" href="#_9-3-types-js"><span>9.3 types.js</span></a></h3><p>src\\types.js</p><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code class="language-javascript"><span class="line"><span class="token keyword">export</span> <span class="token keyword">default</span>  <span class="token punctuation">{</span></span>
<span class="line">    <span class="token constant">MOVE</span><span class="token operator">:</span><span class="token string">&#39;MOVE&#39;</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token constant">INSERT</span><span class="token operator">:</span><span class="token string">&quot;INSERT&quot;</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token constant">REMOVE</span><span class="token operator">:</span><span class="token string">&quot;REMOVE&quot;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="_10-打补丁" tabindex="-1"><a class="header-anchor" href="#_10-打补丁"><span>10. 打补丁</span></a></h2><h3 id="_10-1-src-index-js" tabindex="-1"><a class="header-anchor" href="#_10-1-src-index-js"><span>10.1 src/index.js</span></a></h3><p>src/index.js</p><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code class="language-javascript"><span class="line"><span class="token keyword">import</span> React <span class="token keyword">from</span> <span class="token string">&#39;./react&#39;</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">class</span> <span class="token class-name">Counter</span> <span class="token keyword">extends</span> <span class="token class-name">React<span class="token punctuation">.</span>Component</span><span class="token punctuation">{</span></span>
<span class="line">  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter">props</span><span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">super</span><span class="token punctuation">(</span>props<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">this</span><span class="token punctuation">.</span>state <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token literal-property property">odd</span><span class="token operator">:</span><span class="token boolean">true</span><span class="token punctuation">}</span><span class="token punctuation">;</span></span>
<span class="line">  <span class="token punctuation">}</span></span>
<span class="line">  <span class="token function">componentDidMount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line">   <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">setState</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token literal-property property">odd</span><span class="token operator">:</span><span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">.</span>odd<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">   <span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token number">5000</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">  <span class="token punctuation">}</span></span>
<span class="line">  <span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">.</span>odd<span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line">      <span class="token keyword">return</span> React<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">&#39;ul&#39;</span><span class="token punctuation">,</span><span class="token punctuation">{</span><span class="token literal-property property">key</span><span class="token operator">:</span><span class="token string">&#39;wrapper&#39;</span><span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">        React<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">&#39;li&#39;</span><span class="token punctuation">,</span><span class="token punctuation">{</span><span class="token literal-property property">key</span><span class="token operator">:</span><span class="token string">&#39;A&#39;</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token string">&#39;A&#39;</span><span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line">        React<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">&#39;li&#39;</span><span class="token punctuation">,</span><span class="token punctuation">{</span><span class="token literal-property property">key</span><span class="token operator">:</span><span class="token string">&#39;B&#39;</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token string">&#39;B&#39;</span><span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line">        React<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">&#39;li&#39;</span><span class="token punctuation">,</span><span class="token punctuation">{</span><span class="token literal-property property">key</span><span class="token operator">:</span><span class="token string">&#39;C&#39;</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token string">&#39;C&#39;</span><span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line">        React<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">&#39;li&#39;</span><span class="token punctuation">,</span><span class="token punctuation">{</span><span class="token literal-property property">key</span><span class="token operator">:</span><span class="token string">&#39;D&#39;</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token string">&#39;D&#39;</span><span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line">      <span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    <span class="token keyword">return</span> React<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">&#39;ul&#39;</span><span class="token punctuation">,</span><span class="token punctuation">{</span><span class="token literal-property property">key</span><span class="token operator">:</span><span class="token string">&#39;wrapper&#39;</span><span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">      React<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">&#39;li&#39;</span><span class="token punctuation">,</span><span class="token punctuation">{</span><span class="token literal-property property">key</span><span class="token operator">:</span><span class="token string">&#39;A&#39;</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token string">&#39;A&#39;</span><span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line">      React<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">&#39;li&#39;</span><span class="token punctuation">,</span><span class="token punctuation">{</span><span class="token literal-property property">key</span><span class="token operator">:</span><span class="token string">&#39;C&#39;</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token string">&#39;C1&#39;</span><span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line">      React<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">&#39;li&#39;</span><span class="token punctuation">,</span><span class="token punctuation">{</span><span class="token literal-property property">key</span><span class="token operator">:</span><span class="token string">&#39;B&#39;</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token string">&#39;B1&#39;</span><span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line">      React<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">&#39;li&#39;</span><span class="token punctuation">,</span><span class="token punctuation">{</span><span class="token literal-property property">key</span><span class="token operator">:</span><span class="token string">&#39;E&#39;</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token string">&#39;E1&#39;</span><span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line">      React<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">&#39;li&#39;</span><span class="token punctuation">,</span><span class="token punctuation">{</span><span class="token literal-property property">key</span><span class="token operator">:</span><span class="token string">&#39;F&#39;</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token string">&#39;F1&#39;</span><span class="token punctuation">)</span></span>
<span class="line">      <span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">  <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"><span class="token keyword">let</span> element <span class="token operator">=</span> React<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span>Counter<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">React<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span>element<span class="token punctuation">,</span>document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">&#39;root&#39;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_10-2-react-unit-js" tabindex="-1"><a class="header-anchor" href="#_10-2-react-unit-js"><span>10.2 react/unit.js</span></a></h3><p>src/react/unit.js</p><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code class="language-javascript"><span class="line"><span class="token keyword">import</span> <span class="token punctuation">{</span>Element<span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&#39;./element&#39;</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">import</span> $ <span class="token keyword">from</span> <span class="token string">&#39;jquery&#39;</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">import</span> types <span class="token keyword">from</span> <span class="token string">&#39;./types&#39;</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">let</span> diffQueue <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">let</span> updateDepth<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">class</span> <span class="token class-name">Unit</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter">element</span><span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">this</span><span class="token punctuation">.</span>_currentElement <span class="token operator">=</span> element<span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    <span class="token function">getMarkUp</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">&#39;不能调用此方法&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"><span class="token keyword">class</span> <span class="token class-name">TextUnit</span> <span class="token keyword">extends</span> <span class="token class-name">Unit</span><span class="token punctuation">{</span></span>
<span class="line">    <span class="token function">getMarkUp</span><span class="token punctuation">(</span><span class="token parameter">reactid</span><span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line">         <span class="token keyword">this</span><span class="token punctuation">.</span>_reactid <span class="token operator">=</span> reactid<span class="token punctuation">;</span><span class="token comment">//保存记录reactid</span></span>
<span class="line">        <span class="token comment">//返回文本节点对应的HTML字符串</span></span>
<span class="line">        <span class="token keyword">return</span> <span class="token template-string"><span class="token template-punctuation string">\`</span><span class="token string">&lt;span data-reactid=&quot;</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">\${</span>reactid<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&quot;&gt;</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">\${</span><span class="token keyword">this</span><span class="token punctuation">.</span>_currentElement<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&lt;/span&gt;</span><span class="token template-punctuation string">\`</span></span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    <span class="token function">update</span><span class="token punctuation">(</span><span class="token parameter">nextElement</span><span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>_currentElement <span class="token operator">!=</span> nextElement<span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line">            <span class="token keyword">this</span><span class="token punctuation">.</span>_currentElement <span class="token operator">=</span> nextElement<span class="token punctuation">;</span></span>
<span class="line">            <span class="token function">$</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">\`</span><span class="token string">[data-reactid=&quot;</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">\${</span><span class="token keyword">this</span><span class="token punctuation">.</span>_reactid<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&quot;]</span><span class="token template-punctuation string">\`</span></span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">html</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>_currentElement<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"><span class="token keyword">class</span> <span class="token class-name">NativeUnit</span> <span class="token keyword">extends</span> <span class="token class-name">Unit</span> <span class="token punctuation">{</span></span>
<span class="line">     <span class="token function">getMarkUp</span><span class="token punctuation">(</span><span class="token parameter">reactid</span><span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line">         <span class="token keyword">this</span><span class="token punctuation">.</span>_reactid <span class="token operator">=</span> reactid<span class="token punctuation">;</span><span class="token comment">//保存记录reactid</span></span>
<span class="line">        <span class="token comment">//返回文本节点对应的HTML字符串</span></span>
<span class="line">        <span class="token keyword">let</span> <span class="token punctuation">{</span>type<span class="token punctuation">,</span>props<span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_currentElement<span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">let</span> tagOpen <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">\`</span><span class="token string">&lt;</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">\${</span>type<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> data-reactid=&quot;</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">\${</span>reactid<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&quot; </span><span class="token template-punctuation string">\`</span></span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">let</span> tagClose <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">\`</span><span class="token string">&lt;/$type&gt;</span><span class="token template-punctuation string">\`</span></span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">let</span> content <span class="token operator">=</span> <span class="token string">&#39;&#39;</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">let</span> renderedChildUnits<span class="token operator">=</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">let</span> propName <span class="token keyword">in</span> props<span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line">            <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">^on[A-Z]</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">.</span><span class="token function">test</span><span class="token punctuation">(</span>propName<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line">                <span class="token keyword">let</span> eventName <span class="token operator">=</span> propName<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toLowerCase</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">                <span class="token function">$</span><span class="token punctuation">(</span>document<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">delegate</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">\`</span><span class="token string">[data-reactid=&quot;</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">\${</span>reactid<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&quot;]</span><span class="token template-punctuation string">\`</span></span><span class="token punctuation">,</span><span class="token template-string"><span class="token template-punctuation string">\`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">\${</span>eventName<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">.</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">\${</span>reactid<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">\`</span></span><span class="token punctuation">,</span>props<span class="token punctuation">[</span>propName<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">            <span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>propName <span class="token operator">===</span> <span class="token string">&#39;style&#39;</span><span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line">                <span class="token keyword">let</span> styleObj <span class="token operator">=</span> props<span class="token punctuation">[</span>propName<span class="token punctuation">]</span><span class="token punctuation">;</span></span>
<span class="line">                <span class="token keyword">let</span> styles <span class="token operator">=</span> Object<span class="token punctuation">.</span><span class="token function">keys</span><span class="token punctuation">(</span>styleObj<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token parameter">attr</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span></span>
<span class="line">                    <span class="token keyword">let</span> attrName <span class="token operator">=</span> attr<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">([A-Z])</span><span class="token regex-delimiter">/</span><span class="token regex-flags">g</span></span><span class="token punctuation">,</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">matched<span class="token punctuation">,</span>group</span><span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line">                        <span class="token keyword">return</span> <span class="token template-string"><span class="token template-punctuation string">\`</span><span class="token string">-</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">\${</span>group<span class="token punctuation">.</span><span class="token function">toLowerCase</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">\`</span></span><span class="token punctuation">;</span></span>
<span class="line">                    <span class="token punctuation">}</span><span class="token punctuation">)</span></span>
<span class="line">                    <span class="token keyword">return</span> <span class="token template-string"><span class="token template-punctuation string">\`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">\${</span>attrName<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">:</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">\${</span>styleObj<span class="token punctuation">[</span>attr<span class="token punctuation">]</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">\`</span></span><span class="token punctuation">;</span></span>
<span class="line">                <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token string">&#39;;&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">                tagOpen <span class="token operator">+=</span> <span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">\`</span><span class="token string"> style=&quot;</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">\${</span>styles<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&quot; </span><span class="token template-punctuation string">\`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">            <span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>propName <span class="token operator">===</span> <span class="token string">&#39;children&#39;</span><span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line">                <span class="token keyword">let</span> children <span class="token operator">=</span> props<span class="token punctuation">.</span>children<span class="token operator">||</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span></span>
<span class="line">                children<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">child<span class="token punctuation">,</span>index</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span></span>
<span class="line">                    <span class="token keyword">let</span> childUnit <span class="token operator">=</span> <span class="token function">createUnit</span><span class="token punctuation">(</span>child<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">                    childUnit<span class="token punctuation">.</span>_mountIndex <span class="token operator">=</span> index<span class="token punctuation">;</span></span>
<span class="line">                    renderedChildUnits<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>childUnit<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">                    <span class="token keyword">let</span> childMarkUp <span class="token operator">=</span> childUnit<span class="token punctuation">.</span><span class="token function">getMarkUp</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">\`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">\${</span>reactid<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">.</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">\${</span>index<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">\`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">                    content <span class="token operator">+=</span> childMarkUp<span class="token punctuation">;</span></span>
<span class="line">                <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">            <span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{</span></span>
<span class="line">                tagOpen <span class="token operator">+=</span> <span class="token template-string"><span class="token template-punctuation string">\`</span><span class="token string"> </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">\${</span>propName<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">=</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">\${</span>props<span class="token punctuation">[</span>propName<span class="token punctuation">]</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> </span><span class="token template-punctuation string">\`</span></span><span class="token punctuation">;</span></span>
<span class="line">            <span class="token punctuation">}</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">        <span class="token keyword">this</span><span class="token punctuation">.</span>_renderedChildUnits <span class="token operator">=</span> renderedChildUnits<span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">return</span> tagOpen <span class="token operator">+</span> <span class="token string">&#39;&gt;&#39;</span> <span class="token operator">+</span> content <span class="token operator">+</span> tagClose<span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    <span class="token function">update</span><span class="token punctuation">(</span><span class="token parameter">nextElement</span><span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">let</span> oldProps <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_currentElement<span class="token punctuation">.</span>props<span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">let</span> newProps <span class="token operator">=</span> nextElement<span class="token punctuation">.</span>props<span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">updateDOMproperties</span><span class="token punctuation">(</span>oldProps<span class="token punctuation">,</span>newProps<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">updateDOMChildren</span><span class="token punctuation">(</span>nextElement<span class="token punctuation">.</span>props<span class="token punctuation">.</span>children<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    <span class="token comment">//对比子元素</span></span>
<span class="line">    <span class="token function">updateDOMChildren</span><span class="token punctuation">(</span><span class="token parameter">newChildrenElements</span><span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line">        updateDepth<span class="token operator">++</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">diff</span><span class="token punctuation">(</span>diffQueue<span class="token punctuation">,</span>newChildrenElements<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        updateDepth<span class="token operator">--</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">if</span><span class="token punctuation">(</span>updateDepth<span class="token operator">===</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line">            console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&#39;diffQueue&#39;</span><span class="token punctuation">,</span>diffQueue<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token operator">+</span>            <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">patch</span><span class="token punctuation">(</span>diffQueue<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">            diffQueue<span class="token operator">=</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"><span class="token operator">+</span>    <span class="token function">patch</span><span class="token punctuation">(</span><span class="token parameter">diffQueue</span><span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line"><span class="token operator">+</span>        <span class="token keyword">let</span> deleteChildren <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token operator">+</span>        <span class="token keyword">let</span> deleteMap<span class="token operator">=</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token operator">+</span>        <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">let</span> i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>i<span class="token operator">&lt;</span>diffQueue<span class="token punctuation">.</span>length<span class="token punctuation">;</span>i<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line"><span class="token operator">+</span>            <span class="token keyword">let</span> difference <span class="token operator">=</span> diffQueue<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token operator">+</span>            <span class="token keyword">if</span><span class="token punctuation">(</span>difference<span class="token punctuation">.</span>type<span class="token operator">===</span>types<span class="token punctuation">.</span><span class="token constant">MOVE</span> <span class="token operator">||</span> difference<span class="token punctuation">.</span>type<span class="token operator">===</span>types<span class="token punctuation">.</span><span class="token constant">REMOVE</span><span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line"><span class="token operator">+</span>                <span class="token keyword">let</span> fromIndex <span class="token operator">=</span> difference<span class="token punctuation">.</span>fromIndex<span class="token punctuation">;</span></span>
<span class="line"><span class="token operator">+</span>                <span class="token keyword">let</span> oldChild <span class="token operator">=</span> <span class="token function">$</span><span class="token punctuation">(</span>difference<span class="token punctuation">.</span>parentNode<span class="token punctuation">.</span><span class="token function">children</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>fromIndex<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token operator">+</span>                deleteMap<span class="token punctuation">[</span>fromIndex<span class="token punctuation">]</span><span class="token operator">=</span>oldChild<span class="token punctuation">;</span></span>
<span class="line"><span class="token operator">+</span>                deleteChildren<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>oldChild<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token operator">+</span>            <span class="token punctuation">}</span></span>
<span class="line"><span class="token operator">+</span>        <span class="token punctuation">}</span></span>
<span class="line"><span class="token operator">+</span>        $<span class="token punctuation">.</span><span class="token function">each</span><span class="token punctuation">(</span>deleteChildren<span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token parameter">idx<span class="token punctuation">,</span>child</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span></span>
<span class="line"><span class="token operator">+</span>            <span class="token function">$</span><span class="token punctuation">(</span>child<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token operator">+</span>        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token operator">+</span>        <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">let</span> k<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>k<span class="token operator">&lt;</span>diffQueue<span class="token punctuation">.</span>length<span class="token punctuation">;</span>k<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line"><span class="token operator">+</span>            <span class="token keyword">let</span> difference <span class="token operator">=</span> diffQueue<span class="token punctuation">[</span>k<span class="token punctuation">]</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token operator">+</span>            <span class="token keyword">switch</span><span class="token punctuation">(</span>difference<span class="token punctuation">.</span>type<span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line"><span class="token operator">+</span>              <span class="token keyword">case</span> types<span class="token punctuation">.</span><span class="token constant">INSERT</span><span class="token operator">:</span></span>
<span class="line"><span class="token operator">+</span>                <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">insertChildAt</span><span class="token punctuation">(</span>difference<span class="token punctuation">.</span>parentNode<span class="token punctuation">,</span><span class="token function">$</span><span class="token punctuation">(</span>difference<span class="token punctuation">.</span>markUp<span class="token punctuation">)</span><span class="token punctuation">,</span>difference<span class="token punctuation">.</span>toIndex<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token operator">+</span>                <span class="token keyword">break</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token operator">+</span>              <span class="token keyword">case</span> types<span class="token punctuation">.</span><span class="token constant">MOVE</span><span class="token operator">:</span></span>
<span class="line"><span class="token operator">+</span>                <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">insertChildAt</span><span class="token punctuation">(</span>difference<span class="token punctuation">.</span>parentNode<span class="token punctuation">,</span>deleteMap<span class="token punctuation">[</span>difference<span class="token punctuation">.</span>fromIndex<span class="token punctuation">]</span><span class="token punctuation">,</span>difference<span class="token punctuation">.</span>toIndex<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token operator">+</span>                <span class="token keyword">break</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token operator">+</span>              <span class="token keyword">default</span><span class="token operator">:</span></span>
<span class="line"><span class="token operator">+</span>               <span class="token keyword">break</span><span class="token punctuation">;</span>   </span>
<span class="line"><span class="token operator">+</span>            <span class="token punctuation">}</span></span>
<span class="line"><span class="token operator">+</span>        <span class="token punctuation">}</span></span>
<span class="line"><span class="token operator">+</span>    <span class="token punctuation">}</span></span>
<span class="line"><span class="token operator">+</span>    <span class="token function">insertChildAt</span><span class="token punctuation">(</span><span class="token parameter">parentNode<span class="token punctuation">,</span>childNode<span class="token punctuation">,</span>index</span><span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line"><span class="token operator">+</span>        <span class="token keyword">let</span> oldChild <span class="token operator">=</span> parentNode<span class="token punctuation">.</span><span class="token function">children</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>index<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token operator">+</span>        oldChild<span class="token operator">?</span>childNode<span class="token punctuation">.</span><span class="token function">insertBefore</span><span class="token punctuation">(</span>oldChild<span class="token punctuation">)</span><span class="token operator">:</span>childNode<span class="token punctuation">.</span><span class="token function">appendTo</span><span class="token punctuation">(</span>parentNode<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token operator">+</span>    <span class="token punctuation">}</span></span>
<span class="line">    <span class="token function">diff</span><span class="token punctuation">(</span><span class="token parameter">diffQueue<span class="token punctuation">,</span>newChildrenElements</span><span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">let</span> oldChildUnitsMap <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getChildrenMap</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>_renderedChildUnits<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">let</span> <span class="token punctuation">{</span>newChildrenMap<span class="token punctuation">,</span>newChildren<span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getNewChildren</span><span class="token punctuation">(</span>oldChildUnitsMap<span class="token punctuation">,</span>newChildrenElements<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token comment">// lastIndex里存放着被复用的子元素的最大索引</span></span>
<span class="line">        <span class="token keyword">let</span> lastIndex <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">let</span> i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>i<span class="token operator">&lt;</span>newChildren<span class="token punctuation">.</span>length<span class="token punctuation">;</span>i<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line">            <span class="token keyword">let</span> newChild <span class="token operator">=</span> newChildren<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token comment">//取得新元素</span></span>
<span class="line">            <span class="token keyword">let</span> newKey <span class="token operator">=</span> <span class="token punctuation">(</span>newChild<span class="token punctuation">.</span>_currentElement<span class="token punctuation">.</span>props<span class="token operator">&amp;&amp;</span>newChild<span class="token punctuation">.</span>_currentElement<span class="token punctuation">.</span>key<span class="token punctuation">)</span><span class="token operator">||</span>i<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//取得新key</span></span>
<span class="line">            <span class="token keyword">let</span> oldChild <span class="token operator">=</span> oldChildUnitsMap<span class="token punctuation">[</span>newKey<span class="token punctuation">]</span><span class="token punctuation">;</span></span>
<span class="line">            <span class="token keyword">if</span><span class="token punctuation">(</span>oldChild <span class="token operator">===</span> newChild<span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line">                <span class="token keyword">if</span><span class="token punctuation">(</span>oldChild<span class="token punctuation">.</span>_mountIndex <span class="token operator">&lt;</span> lastIndex<span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line">                    diffQueue<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token punctuation">{</span></span>
<span class="line">                        <span class="token literal-property property">parentId</span><span class="token operator">:</span><span class="token keyword">this</span><span class="token punctuation">.</span>_reactid<span class="token punctuation">,</span></span>
<span class="line">                        <span class="token literal-property property">parentNode</span><span class="token operator">:</span><span class="token function">$</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">\`</span><span class="token string">[data-reactid=&quot;</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">\${</span><span class="token keyword">this</span><span class="token punctuation">.</span>_reactid<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&quot;]</span><span class="token template-punctuation string">\`</span></span><span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line">                        <span class="token literal-property property">type</span><span class="token operator">:</span>types<span class="token punctuation">.</span><span class="token constant">MOVE</span><span class="token punctuation">,</span></span>
<span class="line">                        <span class="token literal-property property">fromIndex</span><span class="token operator">:</span>oldChild<span class="token punctuation">.</span>_mountIndex<span class="token punctuation">,</span></span>
<span class="line">                        <span class="token literal-property property">toIndex</span><span class="token operator">:</span>i</span>
<span class="line">                    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">                <span class="token punctuation">}</span></span>
<span class="line">                lastIndex <span class="token operator">=</span> Math<span class="token punctuation">.</span><span class="token function">max</span><span class="token punctuation">(</span>oldChild<span class="token punctuation">.</span>_mountIndex<span class="token punctuation">,</span>lastIndex<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">                <span class="token comment">//否则根本不用移动，直接修改挂载索引为新索引i即可</span></span>
<span class="line">            <span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{</span></span>
<span class="line">                <span class="token keyword">if</span><span class="token punctuation">(</span>oldChild<span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line">                    diffQueue<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token punctuation">{</span></span>
<span class="line">                        <span class="token literal-property property">parentId</span><span class="token operator">:</span><span class="token keyword">this</span><span class="token punctuation">.</span>_reactid<span class="token punctuation">,</span></span>
<span class="line">                        <span class="token literal-property property">parentNode</span><span class="token operator">:</span><span class="token function">$</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">\`</span><span class="token string">[data-reactid=&quot;</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">\${</span><span class="token keyword">this</span><span class="token punctuation">.</span>_reactid<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&quot;]</span><span class="token template-punctuation string">\`</span></span><span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line">                        <span class="token literal-property property">type</span><span class="token operator">:</span>types<span class="token punctuation">.</span><span class="token constant">REMOVE</span><span class="token punctuation">,</span></span>
<span class="line">                        <span class="token literal-property property">fromIndex</span><span class="token operator">:</span>oldChild<span class="token punctuation">.</span>_mountIndex</span>
<span class="line">                    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">                    <span class="token function">$</span><span class="token punctuation">(</span>document<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">undelegate</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">\`</span><span class="token string">.</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">\${</span>oldChild<span class="token punctuation">.</span>_reactid<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">\`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">                <span class="token punctuation">}</span></span>
<span class="line">                 diffQueue<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token punctuation">{</span></span>
<span class="line">                        <span class="token literal-property property">parentId</span><span class="token operator">:</span><span class="token keyword">this</span><span class="token punctuation">.</span>_reactid<span class="token punctuation">,</span></span>
<span class="line">                        <span class="token literal-property property">parentNode</span><span class="token operator">:</span><span class="token function">$</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">\`</span><span class="token string">[data-reactid=&quot;</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">\${</span><span class="token keyword">this</span><span class="token punctuation">.</span>_reactid<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&quot;]</span><span class="token template-punctuation string">\`</span></span><span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line">                        <span class="token literal-property property">type</span><span class="token operator">:</span>types<span class="token punctuation">.</span><span class="token constant">INSERT</span><span class="token punctuation">,</span></span>
<span class="line">                        <span class="token literal-property property">toIndex</span><span class="token operator">:</span>i<span class="token punctuation">,</span></span>
<span class="line">                        <span class="token literal-property property">markUp</span><span class="token operator">:</span>newChild<span class="token punctuation">.</span><span class="token function">getMarkUp</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">\`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">\${</span><span class="token keyword">this</span><span class="token punctuation">.</span>_reactid<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">.</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">\${</span>i<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">\`</span></span><span class="token punctuation">)</span></span>
<span class="line">                <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">            <span class="token punctuation">}</span></span>
<span class="line">            newChild<span class="token punctuation">.</span>_mountIndex <span class="token operator">=</span> i<span class="token punctuation">;</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">        <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">let</span> oldKey <span class="token keyword">in</span> oldChildUnitsMap<span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line">            <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>newChildrenMap<span class="token punctuation">.</span><span class="token function">hasOwnProperty</span><span class="token punctuation">(</span>oldKey<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line">                <span class="token keyword">let</span> oldChild <span class="token operator">=</span> oldChildUnitsMap<span class="token punctuation">[</span>oldKey<span class="token punctuation">]</span><span class="token punctuation">;</span></span>
<span class="line">                diffQueue<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token punctuation">{</span></span>
<span class="line">                        <span class="token literal-property property">parentId</span><span class="token operator">:</span><span class="token keyword">this</span><span class="token punctuation">.</span>_reactid<span class="token punctuation">,</span></span>
<span class="line">                        <span class="token literal-property property">parentNode</span><span class="token operator">:</span><span class="token function">$</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">\`</span><span class="token string">[data-reactid=&quot;</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">\${</span><span class="token keyword">this</span><span class="token punctuation">.</span>_reactid<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&quot;]</span><span class="token template-punctuation string">\`</span></span><span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line">                        <span class="token literal-property property">type</span><span class="token operator">:</span>types<span class="token punctuation">.</span><span class="token constant">REMOVE</span><span class="token punctuation">,</span></span>
<span class="line">                        <span class="token literal-property property">fromIndex</span><span class="token operator">:</span>oldChild<span class="token punctuation">.</span>_mountIndex</span>
<span class="line">                <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">            <span class="token punctuation">}</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    <span class="token function">getNewChildren</span><span class="token punctuation">(</span><span class="token parameter">oldChildUnitsMap<span class="token punctuation">,</span>newChildrenElements</span><span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">let</span> newChildren <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">let</span> newChildrenMap<span class="token operator">=</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span></span>
<span class="line">        newChildrenElements<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">newElement<span class="token punctuation">,</span>index</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span></span>
<span class="line">            <span class="token keyword">let</span> newKey <span class="token operator">=</span> newElement<span class="token punctuation">.</span>key<span class="token operator">||</span>index<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">            <span class="token keyword">let</span> oldUnit <span class="token operator">=</span> oldChildUnitsMap<span class="token punctuation">[</span>newKey<span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token comment">//获得老的unit</span></span>
<span class="line">            <span class="token keyword">let</span> oldElement <span class="token operator">=</span> oldUnit<span class="token operator">&amp;&amp;</span>oldUnit<span class="token punctuation">.</span>_currentElement<span class="token punctuation">;</span><span class="token comment">//获得老的element</span></span>
<span class="line">            <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">shouldDeepCompare</span><span class="token punctuation">(</span>oldElement<span class="token punctuation">,</span>newElement<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token comment">//如果可以更进一步深比较</span></span>
<span class="line">                oldUnit<span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span>newElement<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">                newChildren<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>oldUnit<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">                newChildrenMap<span class="token punctuation">[</span>newKey<span class="token punctuation">]</span><span class="token operator">=</span>oldUnit<span class="token punctuation">;</span></span>
<span class="line">            <span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{</span></span>
<span class="line">                <span class="token keyword">let</span> newChildUnit <span class="token operator">=</span> <span class="token function">createUnit</span><span class="token punctuation">(</span>newElement<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//如果不需要深比较则直接创建新的unit</span></span>
<span class="line">                newChildren<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>newChildUnit<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">                 newChildrenMap<span class="token punctuation">[</span>newKey<span class="token punctuation">]</span><span class="token operator">=</span>newChildUnit<span class="token punctuation">;</span></span>
<span class="line">            <span class="token punctuation">}</span></span>
<span class="line">        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">return</span> <span class="token punctuation">{</span>newChildrenMap<span class="token punctuation">,</span>newChildren<span class="token punctuation">}</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    <span class="token function">getChildrenMap</span><span class="token punctuation">(</span><span class="token parameter">childUnits<span class="token operator">=</span><span class="token punctuation">[</span><span class="token punctuation">]</span></span><span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">let</span> map <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">let</span> i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>i<span class="token operator">&lt;</span>childUnits<span class="token punctuation">.</span>length<span class="token punctuation">;</span>i<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line">            <span class="token keyword">let</span> key <span class="token operator">=</span> <span class="token punctuation">(</span>childUnits<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>_currentElement<span class="token punctuation">.</span>props<span class="token operator">&amp;&amp;</span>childUnits<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>_currentElement<span class="token punctuation">.</span>props<span class="token punctuation">.</span>key<span class="token punctuation">)</span><span class="token operator">||</span>i<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">            map<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token operator">=</span>childUnits<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">        <span class="token keyword">return</span> map<span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    <span class="token function">updateDOMproperties</span><span class="token punctuation">(</span><span class="token parameter">oldProps<span class="token punctuation">,</span>newProps</span><span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">let</span> propName<span class="token punctuation">;</span></span>
<span class="line">        <span class="token comment">//把新属性对象上没有属性给删除掉</span></span>
<span class="line">        <span class="token keyword">for</span><span class="token punctuation">(</span>propName <span class="token keyword">in</span> oldProps<span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line">            <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>newProps<span class="token punctuation">.</span><span class="token function">hasOwnProperty</span><span class="token punctuation">(</span>propName<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line">                <span class="token function">$</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">\`</span><span class="token string">[data-reactid=&quot;</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">\${</span><span class="token keyword">this</span><span class="token punctuation">.</span>_reactid<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&quot;]</span><span class="token template-punctuation string">\`</span></span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">removeAttr</span><span class="token punctuation">(</span>propName<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">            <span class="token punctuation">}</span></span>
<span class="line">            <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">^on[A-Z]</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">.</span><span class="token function">test</span><span class="token punctuation">(</span>propName<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line">                <span class="token function">$</span><span class="token punctuation">(</span>document<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">undelegate</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">\`</span><span class="token string">.</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">\${</span><span class="token keyword">this</span><span class="token punctuation">.</span>_reactid<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">\`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">            <span class="token punctuation">}</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">        <span class="token keyword">for</span><span class="token punctuation">(</span>propName <span class="token keyword">in</span> newProps<span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line">            <span class="token keyword">if</span><span class="token punctuation">(</span>propName <span class="token operator">==</span> <span class="token string">&#39;children&#39;</span><span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line"></span>
<span class="line">            <span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">^on[A-Z]</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">.</span><span class="token function">test</span><span class="token punctuation">(</span>propName<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line">                <span class="token keyword">let</span> eventName <span class="token operator">=</span> propName<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toLowerCase</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">                <span class="token function">$</span><span class="token punctuation">(</span>document<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">undelegate</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">\`</span><span class="token string">.</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">\${</span><span class="token keyword">this</span><span class="token punctuation">.</span>_reactid<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">\`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">                <span class="token function">$</span><span class="token punctuation">(</span>document<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">delegate</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">\`</span><span class="token string">[data-reactid=&quot;</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">\${</span><span class="token keyword">this</span><span class="token punctuation">.</span>_reactid<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&quot;]</span><span class="token template-punctuation string">\`</span></span><span class="token punctuation">,</span><span class="token template-string"><span class="token template-punctuation string">\`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">\${</span>eventName<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">.</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">\${</span><span class="token keyword">this</span><span class="token punctuation">.</span>_reactid<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">\`</span></span><span class="token punctuation">,</span>newProps<span class="token punctuation">[</span>propName<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">            <span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>propName <span class="token operator">===</span> <span class="token string">&#39;style&#39;</span><span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line">                <span class="token keyword">let</span> styleObj <span class="token operator">=</span> newProps<span class="token punctuation">[</span>propName<span class="token punctuation">]</span><span class="token punctuation">;</span></span>
<span class="line">                Object<span class="token punctuation">.</span><span class="token function">entries</span><span class="token punctuation">(</span>styleObj<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">[</span>attr<span class="token punctuation">,</span>value<span class="token punctuation">]</span></span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span></span>
<span class="line">                  <span class="token function">$</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">\`</span><span class="token string">[data-reactid=&quot;</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">\${</span><span class="token keyword">this</span><span class="token punctuation">.</span>_reactid<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&quot;]</span><span class="token template-punctuation string">\`</span></span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">css</span><span class="token punctuation">(</span>attr<span class="token punctuation">,</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">                <span class="token punctuation">}</span><span class="token punctuation">)</span></span>
<span class="line">            <span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{</span></span>
<span class="line">                <span class="token function">$</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">\`</span><span class="token string">[data-reactid=&quot;</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">\${</span><span class="token keyword">this</span><span class="token punctuation">.</span>_reactid<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&quot;]</span><span class="token template-punctuation string">\`</span></span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">prop</span><span class="token punctuation">(</span>propName<span class="token punctuation">,</span>newProps<span class="token punctuation">[</span>propName<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">            <span class="token punctuation">}</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">class</span> <span class="token class-name">CompositeUnit</span> <span class="token keyword">extends</span> <span class="token class-name">Unit</span><span class="token punctuation">{</span></span>
<span class="line">    <span class="token comment">//接收到新的更新，自定义组件传第二个参数，原生组件和text传处一个参数</span></span>
<span class="line">    <span class="token function">update</span><span class="token punctuation">(</span><span class="token parameter">nextElement<span class="token punctuation">,</span>partialState</span><span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line">        <span class="token comment">//如果传过来了新的元素，则使用新的元素</span></span>
<span class="line">        <span class="token keyword">this</span><span class="token punctuation">.</span>_currentElement <span class="token operator">=</span> nextElement<span class="token operator">||</span><span class="token keyword">this</span><span class="token punctuation">.</span>_currentElement<span class="token punctuation">;</span></span>
<span class="line">        <span class="token comment">//获取新的状态对象和属性对象</span></span>
<span class="line">        <span class="token keyword">let</span> nextState <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_componentInstance<span class="token punctuation">.</span>state<span class="token operator">=</span> Object<span class="token punctuation">.</span><span class="token function">assign</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>_componentInstance<span class="token punctuation">.</span>state<span class="token punctuation">,</span>partialState<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">let</span> nextProps <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_currentElement<span class="token punctuation">.</span>props<span class="token punctuation">;</span></span>
<span class="line">        <span class="token comment">//如果shouldComponentUpdate返回了false则不需要继续更新</span></span>
<span class="line">        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>_componentInstance<span class="token punctuation">.</span>shouldComponentUpdate<span class="token operator">&amp;&amp;</span><span class="token keyword">this</span><span class="token punctuation">.</span>_componentInstance<span class="token punctuation">.</span><span class="token function">shouldComponentUpdate</span><span class="token punctuation">(</span>nextProps<span class="token punctuation">,</span>nextState<span class="token punctuation">)</span><span class="token operator">===</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token keyword">return</span><span class="token punctuation">;</span><span class="token punctuation">}</span></span>
<span class="line">        <span class="token comment">//获得上次渲染出来的unit实例 </span></span>
<span class="line">        <span class="token keyword">let</span> prevRenderedUnitInstance <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_renderedUnitInstance<span class="token punctuation">;</span></span>
<span class="line">        <span class="token comment">//从unit实例中获取</span></span>
<span class="line">        <span class="token keyword">let</span> prevRenderedElement <span class="token operator">=</span> prevRenderedUnitInstance<span class="token punctuation">.</span>_currentElement<span class="token punctuation">;</span></span>
<span class="line">        <span class="token comment">//获取新的虚拟DOM</span></span>
<span class="line">        <span class="token keyword">let</span> nextRenderElement <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_componentInstance<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token comment">//进行domdiff对比</span></span>
<span class="line">        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">shouldDeepCompare</span><span class="token punctuation">(</span>prevRenderedElement<span class="token punctuation">,</span>nextRenderElement<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line">            <span class="token comment">//如果需要更新，则继续调用子节点的upate方法进行更新,传入新的element更新子节点</span></span>
<span class="line">            prevRenderedUnitInstance<span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span>nextRenderElement<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">            <span class="token keyword">this</span><span class="token punctuation">.</span>_componentInstance<span class="token punctuation">.</span>componentDidUpdate<span class="token operator">&amp;&amp;</span><span class="token keyword">this</span><span class="token punctuation">.</span>_componentInstance<span class="token punctuation">.</span><span class="token function">componentDidUpdate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{</span></span>
<span class="line">            <span class="token comment">//如果发现不需要对比，干脆重新渲染</span></span>
<span class="line">            <span class="token keyword">this</span><span class="token punctuation">.</span>_renderedUnitInstance <span class="token operator">=</span>  <span class="token function">createUnit</span><span class="token punctuation">(</span>nextRenderElement<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">            <span class="token keyword">let</span> nextMarkUp <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_renderedUnitInstance<span class="token punctuation">.</span><span class="token function">getMarkUp</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>_reactid<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">            <span class="token comment">//替换整个节点</span></span>
<span class="line">            <span class="token function">$</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">\`</span><span class="token string">[data-reactid=&quot;</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">\${</span><span class="token keyword">this</span><span class="token punctuation">.</span>_reactid<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&quot;]</span><span class="token template-punctuation string">\`</span></span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">replaceWith</span><span class="token punctuation">(</span>nextMarkUp<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    <span class="token function">getMarkUp</span><span class="token punctuation">(</span><span class="token parameter">reactid</span><span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">this</span><span class="token punctuation">.</span>_reactid <span class="token operator">=</span> reactid<span class="token punctuation">;</span></span>
<span class="line">        <span class="token comment">//type是一个自定义组件的类的定义</span></span>
<span class="line">        <span class="token keyword">let</span> <span class="token punctuation">{</span><span class="token literal-property property">type</span><span class="token operator">:</span>Component<span class="token punctuation">,</span>props<span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_currentElement<span class="token punctuation">;</span></span>
<span class="line">        <span class="token comment">//创建Component类的实例</span></span>
<span class="line">        <span class="token keyword">let</span> componentInstance <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_componentInstance <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Component</span><span class="token punctuation">(</span>props<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token comment">//组件实例关联上自己的unit实例</span></span>
<span class="line">        componentInstance<span class="token punctuation">.</span>_currentUnit  <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token comment">//组件将要渲染</span></span>
<span class="line">        componentInstance<span class="token punctuation">.</span>componentWillMount<span class="token operator">&amp;&amp;</span>componentInstance<span class="token punctuation">.</span><span class="token function">componentWillMount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token comment">//执行render方法获得虚拟DOM元素实例</span></span>
<span class="line">        <span class="token keyword">let</span> renderedElement <span class="token operator">=</span> componentInstance<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token comment">//根据虚拟DOM元素得到unit,可能是TextUnit NativeUnit CompositeUnit</span></span>
<span class="line">        <span class="token keyword">let</span> renderedUnitInstance <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_renderedUnitInstance<span class="token operator">=</span> <span class="token function">createUnit</span><span class="token punctuation">(</span>renderedElement<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token comment">//获得此unit的HTML标记字符串</span></span>
<span class="line">        <span class="token keyword">let</span> renderedMarkUp <span class="token operator">=</span> renderedUnitInstance<span class="token punctuation">.</span><span class="token function">getMarkUp</span><span class="token punctuation">(</span>reactid<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token comment">//注册挂载完成的监听，越底层的组件越先监听，越先执行</span></span>
<span class="line">        <span class="token function">$</span><span class="token punctuation">(</span>document<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">&#39;mounted&#39;</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span>componentInstance<span class="token punctuation">.</span>componentDidMount<span class="token operator">&amp;&amp;</span>componentInstance<span class="token punctuation">.</span><span class="token function">componentDidMount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">return</span> renderedMarkUp<span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">function</span> <span class="token function">shouldDeepCompare</span><span class="token punctuation">(</span><span class="token parameter">prevElement<span class="token punctuation">,</span>nextElement</span><span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line">   <span class="token keyword">if</span><span class="token punctuation">(</span>prevElement<span class="token operator">!==</span><span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> nextElement<span class="token operator">!=</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line">       <span class="token keyword">let</span> prevType <span class="token operator">=</span> <span class="token keyword">typeof</span> prevElement<span class="token punctuation">;</span></span>
<span class="line">       <span class="token keyword">let</span> nextType <span class="token operator">=</span> <span class="token keyword">typeof</span> nextElement<span class="token punctuation">;</span></span>
<span class="line">       <span class="token comment">//如果新老节点都是文本可以进行比较</span></span>
<span class="line">       <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token punctuation">(</span>prevType <span class="token operator">===</span> <span class="token string">&#39;string&#39;</span> <span class="token operator">||</span>prevType <span class="token operator">===</span> <span class="token string">&#39;number&#39;</span><span class="token punctuation">)</span><span class="token operator">&amp;&amp;</span><span class="token punctuation">(</span>nextType <span class="token operator">===</span> <span class="token string">&#39;string&#39;</span> <span class="token operator">||</span>nextType <span class="token operator">===</span> <span class="token string">&#39;number&#39;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line">           <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span></span>
<span class="line">       <span class="token punctuation">}</span></span>
<span class="line">       <span class="token keyword">if</span><span class="token punctuation">(</span>prevElement <span class="token keyword">instanceof</span> <span class="token class-name">Element</span> <span class="token operator">&amp;&amp;</span> nextElement <span class="token keyword">instanceof</span> <span class="token class-name">Element</span><span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line">           <span class="token keyword">return</span> prevElement<span class="token punctuation">.</span>type <span class="token operator">===</span> nextElement<span class="token punctuation">.</span>type<span class="token punctuation">;</span></span>
<span class="line">       <span class="token punctuation">}</span></span>
<span class="line">   <span class="token punctuation">}</span>  </span>
<span class="line">   <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"><span class="token keyword">function</span> <span class="token function">createUnit</span><span class="token punctuation">(</span><span class="token parameter">element</span><span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line">  <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token keyword">typeof</span> element <span class="token operator">==</span><span class="token string">&#39;string&#39;</span> <span class="token operator">||</span> <span class="token keyword">typeof</span> element <span class="token operator">==</span><span class="token string">&#39;number&#39;</span><span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line">      <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">TextUnit</span><span class="token punctuation">(</span>element<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">  <span class="token punctuation">}</span></span>
<span class="line">  <span class="token keyword">if</span><span class="token punctuation">(</span>element <span class="token keyword">instanceof</span> <span class="token class-name">Element</span> <span class="token operator">&amp;&amp;</span> <span class="token keyword">typeof</span> element<span class="token punctuation">.</span>type <span class="token operator">===</span> <span class="token string">&#39;string&#39;</span><span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line">      <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">NativeUnit</span><span class="token punctuation">(</span>element<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">  <span class="token punctuation">}</span></span>
<span class="line">  <span class="token keyword">if</span><span class="token punctuation">(</span>element <span class="token keyword">instanceof</span> <span class="token class-name">Element</span> <span class="token operator">&amp;&amp;</span> <span class="token keyword">typeof</span> element<span class="token punctuation">.</span>type <span class="token operator">===</span> <span class="token string">&#39;function&#39;</span><span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line">      <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">CompositeUnit</span><span class="token punctuation">(</span>element<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">  <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">export</span> <span class="token punctuation">{</span></span>
<span class="line">    createUnit</span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="_11-todos" tabindex="-1"><a class="header-anchor" href="#_11-todos"><span>11. todos</span></a></h2><p><a href="https://gitee.com/zhufengpeixun/zhufeng_react2/commit/466915a20e4bb8d0d019b3325ad47867a3891fae" target="_blank" rel="noopener noreferrer">commit</a></p><h3 id="_11-1-src-index-js" tabindex="-1"><a class="header-anchor" href="#_11-1-src-index-js"><span>11.1 src/index.js</span></a></h3><p>src/index.js</p><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code class="language-javascript"><span class="line"><span class="token keyword">import</span> React <span class="token keyword">from</span> <span class="token string">&#39;./react&#39;</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">class</span> <span class="token class-name">Todos</span> <span class="token keyword">extends</span> <span class="token class-name">React<span class="token punctuation">.</span>Component</span><span class="token punctuation">{</span></span>
<span class="line">    <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter">props</span><span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">super</span><span class="token punctuation">(</span>props<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">this</span><span class="token punctuation">.</span>state <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token literal-property property">list</span><span class="token operator">:</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token literal-property property">text</span><span class="token operator">:</span><span class="token string">&#39;&#39;</span><span class="token punctuation">}</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    <span class="token function">add</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line">      <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">.</span>text <span class="token operator">&amp;&amp;</span> <span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">.</span>text<span class="token punctuation">.</span>length<span class="token operator">&gt;</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">setState</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token literal-property property">list</span><span class="token operator">:</span><span class="token punctuation">[</span><span class="token operator">...</span><span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">.</span>list<span class="token punctuation">,</span><span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">.</span>text<span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token literal-property property">text</span><span class="token operator">:</span><span class="token string">&#39;&#39;</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">      <span class="token punctuation">}</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    <span class="token function">onChange</span><span class="token punctuation">(</span><span class="token parameter">event</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">setState</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token literal-property property">text</span><span class="token operator">:</span> event<span class="token punctuation">.</span>target<span class="token punctuation">.</span>value<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    <span class="token function">onDel</span><span class="token punctuation">(</span><span class="token parameter">index</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">.</span>list<span class="token punctuation">.</span><span class="token function">splice</span><span class="token punctuation">(</span>index<span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">setState</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token literal-property property">list</span><span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">.</span>list<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    <span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">var</span> <span class="token function-variable function">createItem</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">itemText<span class="token punctuation">,</span>index</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token keyword">return</span> React<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">&quot;div&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> itemText<span class="token punctuation">,</span>React<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">&#39;button&#39;</span><span class="token punctuation">,</span><span class="token punctuation">{</span><span class="token literal-property property">onClick</span><span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">onDel</span><span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span>index<span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token string">&#39;X&#39;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token punctuation">}</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">        <span class="token keyword">var</span> lists <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">.</span>list<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>createItem<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">var</span> input <span class="token operator">=</span> React<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">&quot;input&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">{</span><span class="token literal-property property">onKeyup</span><span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">onChange</span><span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token literal-property property">value</span><span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">.</span>text<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">var</span> button <span class="token operator">=</span> React<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">&quot;button&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">{</span><span class="token literal-property property">onClick</span><span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token string">&#39;Add&#39;</span><span class="token punctuation">)</span></span>
<span class="line">        <span class="token keyword">return</span> React<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">&#39;div&#39;</span><span class="token punctuation">,</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>input<span class="token punctuation">,</span>button<span class="token punctuation">,</span><span class="token operator">...</span>lists<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"><span class="token keyword">let</span> todos <span class="token operator">=</span> React<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span>Todos<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">React<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span>todos<span class="token punctuation">,</span>document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">&#39;root&#39;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_11-2-react-unit-js" tabindex="-1"><a class="header-anchor" href="#_11-2-react-unit-js"><span>11.2 react/unit.js</span></a></h3><p>src/react/unit.js</p><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code class="language-javascript"><span class="line"><span class="token keyword">import</span> <span class="token punctuation">{</span>Element<span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&#39;./element&#39;</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">import</span> $ <span class="token keyword">from</span> <span class="token string">&#39;jquery&#39;</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">import</span> types <span class="token keyword">from</span> <span class="token string">&#39;./types&#39;</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">let</span> diffQueue <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">let</span> updateDepth<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">class</span> <span class="token class-name">Unit</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter">element</span><span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">this</span><span class="token punctuation">.</span>_currentElement <span class="token operator">=</span> element<span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    <span class="token function">getMarkUp</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">&#39;不能调用此方法&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"><span class="token keyword">class</span> <span class="token class-name">TextUnit</span> <span class="token keyword">extends</span> <span class="token class-name">Unit</span><span class="token punctuation">{</span></span>
<span class="line">    <span class="token function">getMarkUp</span><span class="token punctuation">(</span><span class="token parameter">reactid</span><span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line">         <span class="token keyword">this</span><span class="token punctuation">.</span>_reactid <span class="token operator">=</span> reactid<span class="token punctuation">;</span><span class="token comment">//保存记录reactid</span></span>
<span class="line">        <span class="token comment">//返回文本节点对应的HTML字符串</span></span>
<span class="line">        <span class="token keyword">return</span> <span class="token template-string"><span class="token template-punctuation string">\`</span><span class="token string">&lt;span data-reactid=&quot;</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">\${</span>reactid<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&quot;&gt;</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">\${</span><span class="token keyword">this</span><span class="token punctuation">.</span>_currentElement<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&lt;/span&gt;</span><span class="token template-punctuation string">\`</span></span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    <span class="token function">update</span><span class="token punctuation">(</span><span class="token parameter">nextElement</span><span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>_currentElement <span class="token operator">!=</span> nextElement<span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line">            <span class="token keyword">this</span><span class="token punctuation">.</span>_currentElement <span class="token operator">=</span> nextElement<span class="token punctuation">;</span></span>
<span class="line">            <span class="token function">$</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">\`</span><span class="token string">[data-reactid=&quot;</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">\${</span><span class="token keyword">this</span><span class="token punctuation">.</span>_reactid<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&quot;]</span><span class="token template-punctuation string">\`</span></span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">html</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>_currentElement<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"><span class="token keyword">class</span> <span class="token class-name">NativeUnit</span> <span class="token keyword">extends</span> <span class="token class-name">Unit</span> <span class="token punctuation">{</span></span>
<span class="line">     <span class="token function">getMarkUp</span><span class="token punctuation">(</span><span class="token parameter">reactid</span><span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line">         <span class="token keyword">this</span><span class="token punctuation">.</span>_reactid <span class="token operator">=</span> reactid<span class="token punctuation">;</span><span class="token comment">//保存记录reactid</span></span>
<span class="line">        <span class="token comment">//返回文本节点对应的HTML字符串</span></span>
<span class="line">        <span class="token keyword">let</span> <span class="token punctuation">{</span>type<span class="token punctuation">,</span>props<span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_currentElement<span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">let</span> tagOpen <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">\`</span><span class="token string">&lt;</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">\${</span>type<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> data-reactid=&quot;</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">\${</span>reactid<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&quot; </span><span class="token template-punctuation string">\`</span></span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">let</span> tagClose <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">\`</span><span class="token string">&lt;/$type&gt;</span><span class="token template-punctuation string">\`</span></span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">let</span> content <span class="token operator">=</span> <span class="token string">&#39;&#39;</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">let</span> renderedChildUnits<span class="token operator">=</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">let</span> propName <span class="token keyword">in</span> props<span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line">            <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">^on[A-Z]</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">.</span><span class="token function">test</span><span class="token punctuation">(</span>propName<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line">                <span class="token keyword">let</span> eventName <span class="token operator">=</span> propName<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toLowerCase</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">                <span class="token function">$</span><span class="token punctuation">(</span>document<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">delegate</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">\`</span><span class="token string">[data-reactid=&quot;</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">\${</span>reactid<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&quot;]</span><span class="token template-punctuation string">\`</span></span><span class="token punctuation">,</span><span class="token template-string"><span class="token template-punctuation string">\`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">\${</span>eventName<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">.</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">\${</span>reactid<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">\`</span></span><span class="token punctuation">,</span>props<span class="token punctuation">[</span>propName<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">            <span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>propName <span class="token operator">===</span> <span class="token string">&#39;style&#39;</span><span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line">                <span class="token keyword">let</span> styleObj <span class="token operator">=</span> props<span class="token punctuation">[</span>propName<span class="token punctuation">]</span><span class="token punctuation">;</span></span>
<span class="line">                <span class="token keyword">let</span> styles <span class="token operator">=</span> Object<span class="token punctuation">.</span><span class="token function">keys</span><span class="token punctuation">(</span>styleObj<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token parameter">attr</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span></span>
<span class="line">                    <span class="token keyword">let</span> attrName <span class="token operator">=</span> attr<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">([A-Z])</span><span class="token regex-delimiter">/</span><span class="token regex-flags">g</span></span><span class="token punctuation">,</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">matched<span class="token punctuation">,</span>group</span><span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line">                        <span class="token keyword">return</span> <span class="token template-string"><span class="token template-punctuation string">\`</span><span class="token string">-</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">\${</span>group<span class="token punctuation">.</span><span class="token function">toLowerCase</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">\`</span></span><span class="token punctuation">;</span></span>
<span class="line">                    <span class="token punctuation">}</span><span class="token punctuation">)</span></span>
<span class="line">                    <span class="token keyword">return</span> <span class="token template-string"><span class="token template-punctuation string">\`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">\${</span>attrName<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">:</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">\${</span>styleObj<span class="token punctuation">[</span>attr<span class="token punctuation">]</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">\`</span></span><span class="token punctuation">;</span></span>
<span class="line">                <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token string">&#39;;&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">                tagOpen <span class="token operator">+=</span> <span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">\`</span><span class="token string"> style=&quot;</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">\${</span>styles<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&quot; </span><span class="token template-punctuation string">\`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">            <span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>propName <span class="token operator">===</span> <span class="token string">&#39;children&#39;</span><span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line">                <span class="token keyword">let</span> children <span class="token operator">=</span> props<span class="token punctuation">.</span>children<span class="token operator">||</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span></span>
<span class="line">                children<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">child<span class="token punctuation">,</span>index</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span></span>
<span class="line">                    <span class="token keyword">let</span> childUnit <span class="token operator">=</span> <span class="token function">createUnit</span><span class="token punctuation">(</span>child<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">                    childUnit<span class="token punctuation">.</span>_mountIndex <span class="token operator">=</span> index<span class="token punctuation">;</span></span>
<span class="line">                    renderedChildUnits<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>childUnit<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">                    <span class="token keyword">let</span> childMarkUp <span class="token operator">=</span> childUnit<span class="token punctuation">.</span><span class="token function">getMarkUp</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">\`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">\${</span>reactid<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">.</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">\${</span>index<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">\`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">                    content <span class="token operator">+=</span> childMarkUp<span class="token punctuation">;</span></span>
<span class="line">                <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">            <span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{</span></span>
<span class="line">                tagOpen <span class="token operator">+=</span> <span class="token template-string"><span class="token template-punctuation string">\`</span><span class="token string"> </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">\${</span>propName<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">=</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">\${</span>props<span class="token punctuation">[</span>propName<span class="token punctuation">]</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> </span><span class="token template-punctuation string">\`</span></span><span class="token punctuation">;</span></span>
<span class="line">            <span class="token punctuation">}</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">        <span class="token keyword">this</span><span class="token punctuation">.</span>_renderedChildUnits <span class="token operator">=</span> renderedChildUnits<span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">return</span> tagOpen <span class="token operator">+</span> <span class="token string">&#39;&gt;&#39;</span> <span class="token operator">+</span> content <span class="token operator">+</span> tagClose<span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    <span class="token function">update</span><span class="token punctuation">(</span><span class="token parameter">nextElement</span><span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">let</span> oldProps <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_currentElement<span class="token punctuation">.</span>props<span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">let</span> newProps <span class="token operator">=</span> nextElement<span class="token punctuation">.</span>props<span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">updateDOMproperties</span><span class="token punctuation">(</span>oldProps<span class="token punctuation">,</span>newProps<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">updateDOMChildren</span><span class="token punctuation">(</span>nextElement<span class="token punctuation">.</span>props<span class="token punctuation">.</span>children<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    <span class="token comment">//对比子元素</span></span>
<span class="line">    <span class="token function">updateDOMChildren</span><span class="token punctuation">(</span><span class="token parameter">newChildrenElements</span><span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line">        updateDepth<span class="token operator">++</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">diff</span><span class="token punctuation">(</span>diffQueue<span class="token punctuation">,</span>newChildrenElements<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        updateDepth<span class="token operator">--</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">if</span><span class="token punctuation">(</span>updateDepth<span class="token operator">===</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line">            console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&#39;diffQueue&#39;</span><span class="token punctuation">,</span>diffQueue<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">            <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">patch</span><span class="token punctuation">(</span>diffQueue<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">            diffQueue<span class="token operator">=</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    <span class="token function">patch</span><span class="token punctuation">(</span><span class="token parameter">diffQueue</span><span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">let</span> deleteChildren <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">let</span> deleteMap<span class="token operator">=</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">let</span> i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>i<span class="token operator">&lt;</span>diffQueue<span class="token punctuation">.</span>length<span class="token punctuation">;</span>i<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line">            <span class="token keyword">let</span> difference <span class="token operator">=</span> diffQueue<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span></span>
<span class="line">            <span class="token keyword">if</span><span class="token punctuation">(</span>difference<span class="token punctuation">.</span>type<span class="token operator">===</span>types<span class="token punctuation">.</span><span class="token constant">MOVE</span> <span class="token operator">||</span> difference<span class="token punctuation">.</span>type<span class="token operator">===</span>types<span class="token punctuation">.</span><span class="token constant">REMOVE</span><span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line">                <span class="token keyword">let</span> fromIndex <span class="token operator">=</span> difference<span class="token punctuation">.</span>fromIndex<span class="token punctuation">;</span></span>
<span class="line"><span class="token operator">+</span>                <span class="token keyword">let</span> parentId <span class="token operator">=</span> difference<span class="token punctuation">.</span>parentId<span class="token punctuation">;</span></span>
<span class="line"><span class="token operator">+</span>                <span class="token keyword">let</span> oldChild <span class="token operator">=</span> <span class="token function">$</span><span class="token punctuation">(</span>difference<span class="token punctuation">.</span>parentNode<span class="token punctuation">.</span><span class="token function">children</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>fromIndex<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token operator">+</span>                deleteMap<span class="token punctuation">[</span>parentId<span class="token punctuation">]</span><span class="token operator">=</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token operator">+</span>                deleteMap<span class="token punctuation">[</span>parentId<span class="token punctuation">]</span><span class="token punctuation">[</span>fromIndex<span class="token punctuation">]</span><span class="token operator">=</span>oldChild<span class="token punctuation">;</span></span>
<span class="line">                deleteChildren<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>oldChild<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">            <span class="token punctuation">}</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">        $<span class="token punctuation">.</span><span class="token function">each</span><span class="token punctuation">(</span>deleteChildren<span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token parameter">idx<span class="token punctuation">,</span>child</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span></span>
<span class="line">            <span class="token function">$</span><span class="token punctuation">(</span>child<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">        <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">let</span> k<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>k<span class="token operator">&lt;</span>diffQueue<span class="token punctuation">.</span>length<span class="token punctuation">;</span>k<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line">            <span class="token keyword">let</span> difference <span class="token operator">=</span> diffQueue<span class="token punctuation">[</span>k<span class="token punctuation">]</span><span class="token punctuation">;</span></span>
<span class="line">            <span class="token keyword">switch</span><span class="token punctuation">(</span>difference<span class="token punctuation">.</span>type<span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line">              <span class="token keyword">case</span> types<span class="token punctuation">.</span><span class="token constant">INSERT</span><span class="token operator">:</span></span>
<span class="line">                <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">insertChildAt</span><span class="token punctuation">(</span>difference<span class="token punctuation">.</span>parentNode<span class="token punctuation">,</span><span class="token function">$</span><span class="token punctuation">(</span>difference<span class="token punctuation">.</span>markUp<span class="token punctuation">)</span><span class="token punctuation">,</span>difference<span class="token punctuation">.</span>toIndex<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">                <span class="token keyword">break</span><span class="token punctuation">;</span></span>
<span class="line">              <span class="token keyword">case</span> types<span class="token punctuation">.</span><span class="token constant">MOVE</span><span class="token operator">:</span></span>
<span class="line"><span class="token operator">+</span>                <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">insertChildAt</span><span class="token punctuation">(</span>difference<span class="token punctuation">.</span>parentNode<span class="token punctuation">,</span>deleteMap<span class="token punctuation">[</span>difference<span class="token punctuation">.</span>parentId<span class="token punctuation">]</span><span class="token punctuation">[</span>difference<span class="token punctuation">.</span>fromIndex<span class="token punctuation">]</span><span class="token punctuation">,</span>difference<span class="token punctuation">.</span>toIndex<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">                <span class="token keyword">break</span><span class="token punctuation">;</span></span>
<span class="line">              <span class="token keyword">default</span><span class="token operator">:</span></span>
<span class="line">               <span class="token keyword">break</span><span class="token punctuation">;</span>   </span>
<span class="line">            <span class="token punctuation">}</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    <span class="token function">insertChildAt</span><span class="token punctuation">(</span><span class="token parameter">parentNode<span class="token punctuation">,</span>childNode<span class="token punctuation">,</span>index</span><span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">let</span> oldChild <span class="token operator">=</span> parentNode<span class="token punctuation">.</span><span class="token function">children</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>index<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        oldChild<span class="token operator">?</span>childNode<span class="token punctuation">.</span><span class="token function">insertBefore</span><span class="token punctuation">(</span>oldChild<span class="token punctuation">)</span><span class="token operator">:</span>childNode<span class="token punctuation">.</span><span class="token function">appendTo</span><span class="token punctuation">(</span>parentNode<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    <span class="token function">diff</span><span class="token punctuation">(</span><span class="token parameter">diffQueue<span class="token punctuation">,</span>newChildrenElements</span><span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">let</span> oldChildUnitsMap <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getChildrenMap</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>_renderedChildUnits<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">let</span> <span class="token punctuation">{</span>newChildrenMap<span class="token punctuation">,</span>newChildren<span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getNewChildren</span><span class="token punctuation">(</span>oldChildUnitsMap<span class="token punctuation">,</span>newChildrenElements<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token comment">// lastIndex里存放着被复用的子元素的最大索引</span></span>
<span class="line">        <span class="token keyword">let</span> lastIndex <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">let</span> i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>i<span class="token operator">&lt;</span>newChildren<span class="token punctuation">.</span>length<span class="token punctuation">;</span>i<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line">            <span class="token keyword">let</span> newChild <span class="token operator">=</span> newChildren<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token comment">//取得新元素</span></span>
<span class="line">            <span class="token keyword">let</span> newKey <span class="token operator">=</span> <span class="token punctuation">(</span>newChild<span class="token punctuation">.</span>_currentElement<span class="token punctuation">.</span>props<span class="token operator">&amp;&amp;</span>newChild<span class="token punctuation">.</span>_currentElement<span class="token punctuation">.</span>key<span class="token punctuation">)</span><span class="token operator">||</span>i<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//取得新key</span></span>
<span class="line">            <span class="token keyword">let</span> oldChild <span class="token operator">=</span> oldChildUnitsMap<span class="token punctuation">[</span>newKey<span class="token punctuation">]</span><span class="token punctuation">;</span></span>
<span class="line">            <span class="token keyword">if</span><span class="token punctuation">(</span>oldChild <span class="token operator">===</span> newChild<span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line">                <span class="token keyword">if</span><span class="token punctuation">(</span>oldChild<span class="token punctuation">.</span>_mountIndex <span class="token operator">&lt;</span> lastIndex<span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line">                    diffQueue<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token punctuation">{</span></span>
<span class="line">                        <span class="token literal-property property">parentId</span><span class="token operator">:</span><span class="token keyword">this</span><span class="token punctuation">.</span>_reactid<span class="token punctuation">,</span></span>
<span class="line">                        <span class="token literal-property property">parentNode</span><span class="token operator">:</span><span class="token function">$</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">\`</span><span class="token string">[data-reactid=&quot;</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">\${</span><span class="token keyword">this</span><span class="token punctuation">.</span>_reactid<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&quot;]</span><span class="token template-punctuation string">\`</span></span><span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line">                        <span class="token literal-property property">type</span><span class="token operator">:</span>types<span class="token punctuation">.</span><span class="token constant">MOVE</span><span class="token punctuation">,</span></span>
<span class="line">                        <span class="token literal-property property">fromIndex</span><span class="token operator">:</span>oldChild<span class="token punctuation">.</span>_mountIndex<span class="token punctuation">,</span></span>
<span class="line">                        <span class="token literal-property property">toIndex</span><span class="token operator">:</span>i</span>
<span class="line">                    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">                <span class="token punctuation">}</span></span>
<span class="line">                lastIndex <span class="token operator">=</span> Math<span class="token punctuation">.</span><span class="token function">max</span><span class="token punctuation">(</span>oldChild<span class="token punctuation">.</span>_mountIndex<span class="token punctuation">,</span>lastIndex<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">                <span class="token comment">//否则根本不用移动，直接修改挂载索引为新索引i即可</span></span>
<span class="line">            <span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{</span></span>
<span class="line">                <span class="token keyword">if</span><span class="token punctuation">(</span>oldChild<span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line">                    diffQueue<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token punctuation">{</span></span>
<span class="line">                        <span class="token literal-property property">parentId</span><span class="token operator">:</span><span class="token keyword">this</span><span class="token punctuation">.</span>_reactid<span class="token punctuation">,</span></span>
<span class="line">                        <span class="token literal-property property">parentNode</span><span class="token operator">:</span><span class="token function">$</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">\`</span><span class="token string">[data-reactid=&quot;</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">\${</span><span class="token keyword">this</span><span class="token punctuation">.</span>_reactid<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&quot;]</span><span class="token template-punctuation string">\`</span></span><span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line">                        <span class="token literal-property property">type</span><span class="token operator">:</span>types<span class="token punctuation">.</span><span class="token constant">REMOVE</span><span class="token punctuation">,</span></span>
<span class="line">                        <span class="token literal-property property">fromIndex</span><span class="token operator">:</span>oldChild<span class="token punctuation">.</span>_mountIndex</span>
<span class="line">                    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">                    <span class="token function">$</span><span class="token punctuation">(</span>document<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">undelegate</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">\`</span><span class="token string">.</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">\${</span>oldChild<span class="token punctuation">.</span>_reactid<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">\`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">                <span class="token punctuation">}</span></span>
<span class="line">                 diffQueue<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token punctuation">{</span></span>
<span class="line">                        <span class="token literal-property property">parentId</span><span class="token operator">:</span><span class="token keyword">this</span><span class="token punctuation">.</span>_reactid<span class="token punctuation">,</span></span>
<span class="line">                        <span class="token literal-property property">parentNode</span><span class="token operator">:</span><span class="token function">$</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">\`</span><span class="token string">[data-reactid=&quot;</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">\${</span><span class="token keyword">this</span><span class="token punctuation">.</span>_reactid<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&quot;]</span><span class="token template-punctuation string">\`</span></span><span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line">                        <span class="token literal-property property">type</span><span class="token operator">:</span>types<span class="token punctuation">.</span><span class="token constant">INSERT</span><span class="token punctuation">,</span></span>
<span class="line">                        <span class="token literal-property property">toIndex</span><span class="token operator">:</span>i<span class="token punctuation">,</span></span>
<span class="line">                        <span class="token literal-property property">markUp</span><span class="token operator">:</span>newChild<span class="token punctuation">.</span><span class="token function">getMarkUp</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">\`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">\${</span><span class="token keyword">this</span><span class="token punctuation">.</span>_reactid<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">.</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">\${</span>i<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">\`</span></span><span class="token punctuation">)</span></span>
<span class="line">                <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">            <span class="token punctuation">}</span></span>
<span class="line">            newChild<span class="token punctuation">.</span>_mountIndex <span class="token operator">=</span> i<span class="token punctuation">;</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">        <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">let</span> oldKey <span class="token keyword">in</span> oldChildUnitsMap<span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line">            <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>newChildrenMap<span class="token punctuation">.</span><span class="token function">hasOwnProperty</span><span class="token punctuation">(</span>oldKey<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line">                <span class="token keyword">let</span> oldChild <span class="token operator">=</span> oldChildUnitsMap<span class="token punctuation">[</span>oldKey<span class="token punctuation">]</span><span class="token punctuation">;</span></span>
<span class="line">                diffQueue<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token punctuation">{</span></span>
<span class="line">                        <span class="token literal-property property">parentId</span><span class="token operator">:</span><span class="token keyword">this</span><span class="token punctuation">.</span>_reactid<span class="token punctuation">,</span></span>
<span class="line">                        <span class="token literal-property property">parentNode</span><span class="token operator">:</span><span class="token function">$</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">\`</span><span class="token string">[data-reactid=&quot;</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">\${</span><span class="token keyword">this</span><span class="token punctuation">.</span>_reactid<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&quot;]</span><span class="token template-punctuation string">\`</span></span><span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line">                        <span class="token literal-property property">type</span><span class="token operator">:</span>types<span class="token punctuation">.</span><span class="token constant">REMOVE</span><span class="token punctuation">,</span></span>
<span class="line">                        <span class="token literal-property property">fromIndex</span><span class="token operator">:</span>oldChild<span class="token punctuation">.</span>_mountIndex</span>
<span class="line">                <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token operator">+</span>                <span class="token keyword">this</span><span class="token punctuation">.</span>_renderedChildUnits <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_renderedChildUnits<span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span><span class="token parameter">item</span><span class="token operator">=&gt;</span>item <span class="token operator">!=</span> oldChild<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token operator">+</span>                <span class="token function">$</span><span class="token punctuation">(</span>document<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">undelegate</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">\`</span><span class="token string">.</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">\${</span>oldChild<span class="token punctuation">.</span>_reactid<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">\`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">            <span class="token punctuation">}</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    <span class="token function">getNewChildren</span><span class="token punctuation">(</span><span class="token parameter">oldChildUnitsMap<span class="token punctuation">,</span>newChildrenElements</span><span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">let</span> newChildren <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">let</span> newChildrenMap<span class="token operator">=</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span></span>
<span class="line">        newChildrenElements<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">newElement<span class="token punctuation">,</span>index</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span></span>
<span class="line">            <span class="token keyword">let</span> newKey <span class="token operator">=</span> newElement<span class="token punctuation">.</span>key<span class="token operator">||</span>index<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">            <span class="token keyword">let</span> oldUnit <span class="token operator">=</span> oldChildUnitsMap<span class="token punctuation">[</span>newKey<span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token comment">//获得老的unit</span></span>
<span class="line">            <span class="token keyword">let</span> oldElement <span class="token operator">=</span> oldUnit<span class="token operator">&amp;&amp;</span>oldUnit<span class="token punctuation">.</span>_currentElement<span class="token punctuation">;</span><span class="token comment">//获得老的element</span></span>
<span class="line">            <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">shouldDeepCompare</span><span class="token punctuation">(</span>oldElement<span class="token punctuation">,</span>newElement<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token comment">//如果可以更进一步深比较</span></span>
<span class="line">                oldUnit<span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span>newElement<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">                newChildren<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>oldUnit<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">                newChildrenMap<span class="token punctuation">[</span>newKey<span class="token punctuation">]</span><span class="token operator">=</span>oldUnit<span class="token punctuation">;</span></span>
<span class="line">            <span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{</span></span>
<span class="line">                <span class="token keyword">let</span> newChildUnit <span class="token operator">=</span> <span class="token function">createUnit</span><span class="token punctuation">(</span>newElement<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//如果不需要深比较则直接创建新的unit</span></span>
<span class="line">                newChildren<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>newChildUnit<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">                newChildrenMap<span class="token punctuation">[</span>newKey<span class="token punctuation">]</span><span class="token operator">=</span>newChildUnit<span class="token punctuation">;</span></span>
<span class="line">                <span class="token keyword">this</span><span class="token punctuation">.</span>_renderedChildUnits<span class="token punctuation">[</span>index<span class="token punctuation">]</span><span class="token operator">=</span>newChildUnit<span class="token punctuation">;</span></span>
<span class="line">            <span class="token punctuation">}</span></span>
<span class="line">        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">return</span> <span class="token punctuation">{</span>newChildrenMap<span class="token punctuation">,</span>newChildren<span class="token punctuation">}</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    <span class="token function">getChildrenMap</span><span class="token punctuation">(</span><span class="token parameter">childUnits<span class="token operator">=</span><span class="token punctuation">[</span><span class="token punctuation">]</span></span><span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">let</span> map <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">let</span> i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>i<span class="token operator">&lt;</span>childUnits<span class="token punctuation">.</span>length<span class="token punctuation">;</span>i<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line">            <span class="token keyword">let</span> key <span class="token operator">=</span> <span class="token punctuation">(</span>childUnits<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>_currentElement<span class="token punctuation">.</span>props<span class="token operator">&amp;&amp;</span>childUnits<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>_currentElement<span class="token punctuation">.</span>props<span class="token punctuation">.</span>key<span class="token punctuation">)</span><span class="token operator">||</span>i<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">            map<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token operator">=</span>childUnits<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">        <span class="token keyword">return</span> map<span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    <span class="token function">updateDOMproperties</span><span class="token punctuation">(</span><span class="token parameter">oldProps<span class="token punctuation">,</span>newProps</span><span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">let</span> propName<span class="token punctuation">;</span></span>
<span class="line">        <span class="token comment">//把新属性对象上没有属性给删除掉</span></span>
<span class="line">        <span class="token keyword">for</span><span class="token punctuation">(</span>propName <span class="token keyword">in</span> oldProps<span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line">            <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>newProps<span class="token punctuation">.</span><span class="token function">hasOwnProperty</span><span class="token punctuation">(</span>propName<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line">                <span class="token function">$</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">\`</span><span class="token string">[data-reactid=&quot;</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">\${</span><span class="token keyword">this</span><span class="token punctuation">.</span>_reactid<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&quot;]</span><span class="token template-punctuation string">\`</span></span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">removeAttr</span><span class="token punctuation">(</span>propName<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">            <span class="token punctuation">}</span></span>
<span class="line">            <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">^on[A-Z]</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">.</span><span class="token function">test</span><span class="token punctuation">(</span>propName<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line">                <span class="token function">$</span><span class="token punctuation">(</span>document<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">undelegate</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">\`</span><span class="token string">.</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">\${</span><span class="token keyword">this</span><span class="token punctuation">.</span>_reactid<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">\`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">            <span class="token punctuation">}</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">        <span class="token keyword">for</span><span class="token punctuation">(</span>propName <span class="token keyword">in</span> newProps<span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line">            <span class="token keyword">if</span><span class="token punctuation">(</span>propName <span class="token operator">==</span> <span class="token string">&#39;children&#39;</span><span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line"></span>
<span class="line">            <span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">^on[A-Z]</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">.</span><span class="token function">test</span><span class="token punctuation">(</span>propName<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line">                <span class="token keyword">let</span> eventName <span class="token operator">=</span> propName<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toLowerCase</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">                <span class="token function">$</span><span class="token punctuation">(</span>document<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">undelegate</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">\`</span><span class="token string">.</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">\${</span><span class="token keyword">this</span><span class="token punctuation">.</span>_reactid<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">\`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">                <span class="token function">$</span><span class="token punctuation">(</span>document<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">delegate</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">\`</span><span class="token string">[data-reactid=&quot;</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">\${</span><span class="token keyword">this</span><span class="token punctuation">.</span>_reactid<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&quot;]</span><span class="token template-punctuation string">\`</span></span><span class="token punctuation">,</span><span class="token template-string"><span class="token template-punctuation string">\`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">\${</span>eventName<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">.</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">\${</span><span class="token keyword">this</span><span class="token punctuation">.</span>_reactid<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">\`</span></span><span class="token punctuation">,</span>newProps<span class="token punctuation">[</span>propName<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">            <span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>propName <span class="token operator">===</span> <span class="token string">&#39;style&#39;</span><span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line">                <span class="token keyword">let</span> styleObj <span class="token operator">=</span> newProps<span class="token punctuation">[</span>propName<span class="token punctuation">]</span><span class="token punctuation">;</span></span>
<span class="line">                Object<span class="token punctuation">.</span><span class="token function">entries</span><span class="token punctuation">(</span>styleObj<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">[</span>attr<span class="token punctuation">,</span>value<span class="token punctuation">]</span></span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span></span>
<span class="line">                  <span class="token function">$</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">\`</span><span class="token string">[data-reactid=&quot;</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">\${</span><span class="token keyword">this</span><span class="token punctuation">.</span>_reactid<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&quot;]</span><span class="token template-punctuation string">\`</span></span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">css</span><span class="token punctuation">(</span>attr<span class="token punctuation">,</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">                <span class="token punctuation">}</span><span class="token punctuation">)</span></span>
<span class="line">            <span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{</span></span>
<span class="line">                <span class="token function">$</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">\`</span><span class="token string">[data-reactid=&quot;</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">\${</span><span class="token keyword">this</span><span class="token punctuation">.</span>_reactid<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&quot;]</span><span class="token template-punctuation string">\`</span></span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">prop</span><span class="token punctuation">(</span>propName<span class="token punctuation">,</span>newProps<span class="token punctuation">[</span>propName<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">            <span class="token punctuation">}</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">class</span> <span class="token class-name">CompositeUnit</span> <span class="token keyword">extends</span> <span class="token class-name">Unit</span><span class="token punctuation">{</span></span>
<span class="line">    <span class="token comment">//接收到新的更新，自定义组件传第二个参数，原生组件和text传处一个参数</span></span>
<span class="line">    <span class="token function">update</span><span class="token punctuation">(</span><span class="token parameter">nextElement<span class="token punctuation">,</span>partialState</span><span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line">        <span class="token comment">//如果传过来了新的元素，则使用新的元素</span></span>
<span class="line">        <span class="token keyword">this</span><span class="token punctuation">.</span>_currentElement <span class="token operator">=</span> nextElement<span class="token operator">||</span><span class="token keyword">this</span><span class="token punctuation">.</span>_currentElement<span class="token punctuation">;</span></span>
<span class="line">        <span class="token comment">//获取新的状态对象和属性对象</span></span>
<span class="line">        <span class="token keyword">let</span> nextState <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_componentInstance<span class="token punctuation">.</span>state<span class="token operator">=</span> Object<span class="token punctuation">.</span><span class="token function">assign</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>_componentInstance<span class="token punctuation">.</span>state<span class="token punctuation">,</span>partialState<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">let</span> nextProps <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_currentElement<span class="token punctuation">.</span>props<span class="token punctuation">;</span></span>
<span class="line">        <span class="token comment">//如果shouldComponentUpdate返回了false则不需要继续更新</span></span>
<span class="line">        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>_componentInstance<span class="token punctuation">.</span>shouldComponentUpdate<span class="token operator">&amp;&amp;</span><span class="token keyword">this</span><span class="token punctuation">.</span>_componentInstance<span class="token punctuation">.</span><span class="token function">shouldComponentUpdate</span><span class="token punctuation">(</span>nextProps<span class="token punctuation">,</span>nextState<span class="token punctuation">)</span><span class="token operator">===</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token keyword">return</span><span class="token punctuation">;</span><span class="token punctuation">}</span></span>
<span class="line">        <span class="token comment">//获得上次渲染出来的unit实例 </span></span>
<span class="line">        <span class="token keyword">let</span> prevRenderedUnitInstance <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_renderedUnitInstance<span class="token punctuation">;</span></span>
<span class="line">        <span class="token comment">//从unit实例中获取</span></span>
<span class="line">        <span class="token keyword">let</span> prevRenderedElement <span class="token operator">=</span> prevRenderedUnitInstance<span class="token punctuation">.</span>_currentElement<span class="token punctuation">;</span></span>
<span class="line">        <span class="token comment">//获取新的虚拟DOM</span></span>
<span class="line">        <span class="token keyword">let</span> nextRenderElement <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_componentInstance<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token comment">//进行domdiff对比</span></span>
<span class="line">        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">shouldDeepCompare</span><span class="token punctuation">(</span>prevRenderedElement<span class="token punctuation">,</span>nextRenderElement<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line">            <span class="token comment">//如果需要更新，则继续调用子节点的upate方法进行更新,传入新的element更新子节点</span></span>
<span class="line">            prevRenderedUnitInstance<span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span>nextRenderElement<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">            <span class="token keyword">this</span><span class="token punctuation">.</span>_componentInstance<span class="token punctuation">.</span>componentDidUpdate<span class="token operator">&amp;&amp;</span><span class="token keyword">this</span><span class="token punctuation">.</span>_componentInstance<span class="token punctuation">.</span><span class="token function">componentDidUpdate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{</span></span>
<span class="line">            <span class="token comment">//如果发现不需要对比，干脆重新渲染</span></span>
<span class="line">            <span class="token keyword">this</span><span class="token punctuation">.</span>_renderedUnitInstance <span class="token operator">=</span>  <span class="token function">createUnit</span><span class="token punctuation">(</span>nextRenderElement<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">            <span class="token keyword">let</span> nextMarkUp <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_renderedUnitInstance<span class="token punctuation">.</span><span class="token function">getMarkUp</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>_reactid<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">            <span class="token comment">//替换整个节点</span></span>
<span class="line">            <span class="token function">$</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">\`</span><span class="token string">[data-reactid=&quot;</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">\${</span><span class="token keyword">this</span><span class="token punctuation">.</span>_reactid<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&quot;]</span><span class="token template-punctuation string">\`</span></span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">replaceWith</span><span class="token punctuation">(</span>nextMarkUp<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    <span class="token function">getMarkUp</span><span class="token punctuation">(</span><span class="token parameter">reactid</span><span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">this</span><span class="token punctuation">.</span>_reactid <span class="token operator">=</span> reactid<span class="token punctuation">;</span></span>
<span class="line">        <span class="token comment">//type是一个自定义组件的类的定义</span></span>
<span class="line">        <span class="token keyword">let</span> <span class="token punctuation">{</span><span class="token literal-property property">type</span><span class="token operator">:</span>Component<span class="token punctuation">,</span>props<span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_currentElement<span class="token punctuation">;</span></span>
<span class="line">        <span class="token comment">//创建Component类的实例</span></span>
<span class="line">        <span class="token keyword">let</span> componentInstance <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_componentInstance <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Component</span><span class="token punctuation">(</span>props<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token comment">//组件实例关联上自己的unit实例</span></span>
<span class="line">        componentInstance<span class="token punctuation">.</span>_currentUnit  <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token comment">//组件将要渲染</span></span>
<span class="line">        componentInstance<span class="token punctuation">.</span>componentWillMount<span class="token operator">&amp;&amp;</span>componentInstance<span class="token punctuation">.</span><span class="token function">componentWillMount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token comment">//执行render方法获得虚拟DOM元素实例</span></span>
<span class="line">        <span class="token keyword">let</span> renderedElement <span class="token operator">=</span> componentInstance<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token comment">//根据虚拟DOM元素得到unit,可能是TextUnit NativeUnit CompositeUnit</span></span>
<span class="line">        <span class="token keyword">let</span> renderedUnitInstance <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_renderedUnitInstance<span class="token operator">=</span> <span class="token function">createUnit</span><span class="token punctuation">(</span>renderedElement<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token comment">//获得此unit的HTML标记字符串</span></span>
<span class="line">        <span class="token keyword">let</span> renderedMarkUp <span class="token operator">=</span> renderedUnitInstance<span class="token punctuation">.</span><span class="token function">getMarkUp</span><span class="token punctuation">(</span>reactid<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token comment">//注册挂载完成的监听，越底层的组件越先监听，越先执行</span></span>
<span class="line">        <span class="token function">$</span><span class="token punctuation">(</span>document<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">&#39;mounted&#39;</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span>componentInstance<span class="token punctuation">.</span>componentDidMount<span class="token operator">&amp;&amp;</span>componentInstance<span class="token punctuation">.</span><span class="token function">componentDidMount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">return</span> renderedMarkUp<span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">function</span> <span class="token function">shouldDeepCompare</span><span class="token punctuation">(</span><span class="token parameter">prevElement<span class="token punctuation">,</span>nextElement</span><span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line">   <span class="token keyword">if</span><span class="token punctuation">(</span>prevElement<span class="token operator">!==</span><span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> nextElement<span class="token operator">!=</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line">       <span class="token keyword">let</span> prevType <span class="token operator">=</span> <span class="token keyword">typeof</span> prevElement<span class="token punctuation">;</span></span>
<span class="line">       <span class="token keyword">let</span> nextType <span class="token operator">=</span> <span class="token keyword">typeof</span> nextElement<span class="token punctuation">;</span></span>
<span class="line">       <span class="token comment">//如果新老节点都是文本可以进行比较</span></span>
<span class="line">       <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token punctuation">(</span>prevType <span class="token operator">===</span> <span class="token string">&#39;string&#39;</span> <span class="token operator">||</span>prevType <span class="token operator">===</span> <span class="token string">&#39;number&#39;</span><span class="token punctuation">)</span><span class="token operator">&amp;&amp;</span><span class="token punctuation">(</span>nextType <span class="token operator">===</span> <span class="token string">&#39;string&#39;</span> <span class="token operator">||</span>nextType <span class="token operator">===</span> <span class="token string">&#39;number&#39;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line">           <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span></span>
<span class="line">       <span class="token punctuation">}</span></span>
<span class="line">       <span class="token keyword">if</span><span class="token punctuation">(</span>prevElement <span class="token keyword">instanceof</span> <span class="token class-name">Element</span> <span class="token operator">&amp;&amp;</span> nextElement <span class="token keyword">instanceof</span> <span class="token class-name">Element</span><span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line">           <span class="token keyword">return</span> prevElement<span class="token punctuation">.</span>type <span class="token operator">===</span> nextElement<span class="token punctuation">.</span>type<span class="token punctuation">;</span></span>
<span class="line">       <span class="token punctuation">}</span></span>
<span class="line">   <span class="token punctuation">}</span>  </span>
<span class="line">   <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"><span class="token keyword">function</span> <span class="token function">createUnit</span><span class="token punctuation">(</span><span class="token parameter">element</span><span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line">  <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token keyword">typeof</span> element <span class="token operator">==</span><span class="token string">&#39;string&#39;</span> <span class="token operator">||</span> <span class="token keyword">typeof</span> element <span class="token operator">==</span><span class="token string">&#39;number&#39;</span><span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line">      <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">TextUnit</span><span class="token punctuation">(</span>element<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">  <span class="token punctuation">}</span></span>
<span class="line">  <span class="token keyword">if</span><span class="token punctuation">(</span>element <span class="token keyword">instanceof</span> <span class="token class-name">Element</span> <span class="token operator">&amp;&amp;</span> <span class="token keyword">typeof</span> element<span class="token punctuation">.</span>type <span class="token operator">===</span> <span class="token string">&#39;string&#39;</span><span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line">      <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">NativeUnit</span><span class="token punctuation">(</span>element<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">  <span class="token punctuation">}</span></span>
<span class="line">  <span class="token keyword">if</span><span class="token punctuation">(</span>element <span class="token keyword">instanceof</span> <span class="token class-name">Element</span> <span class="token operator">&amp;&amp;</span> <span class="token keyword">typeof</span> element<span class="token punctuation">.</span>type <span class="token operator">===</span> <span class="token string">&#39;function&#39;</span><span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line">      <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">CompositeUnit</span><span class="token punctuation">(</span>element<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">  <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">export</span> <span class="token punctuation">{</span></span>
<span class="line">    createUnit</span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="_10-diff-策略" tabindex="-1"><a class="header-anchor" href="#_10-diff-策略"><span>10. diff 策略</span></a></h2><ul><li>Web UI 中 DOM 节点跨层级的移动操作特别少，可以忽略不计。</li><li>拥有相同类的两个组件将会生成相似的树形结构，拥有不同类的两个组件将会生成不同的树形结构。</li><li>对于同一层级的一组子节点，它们可以通过唯一<code>key</code>进行区分。</li></ul><h3 id="_10-1-tree-diff" tabindex="-1"><a class="header-anchor" href="#_10-1-tree-diff"><span>10.1 tree diff</span></a></h3><ul><li>React 对树的算法进行了简洁明了的优化，即对树进行分层比较，两棵树只会对同一层次的节点进行比较</li></ul><p><img src="http://img.zhufengpeixun.cn/sametree.png" alt="sametree"></p><ul><li>当出现节点跨层级移动时，并不会出现想象中的移动操作，而是以 A 为根节点的树被整个重新创建</li></ul><p><img src="http://img.zhufengpeixun.cn/movemytree.png" alt="movemytree"></p><h3 id="_10-2-component-diff" tabindex="-1"><a class="header-anchor" href="#_10-2-component-diff"><span>10.2 component diff</span></a></h3><ul><li>如果是同一类型的组件，按照原策略继续比较 <code>virtual DOM tree</code></li><li>如果不是，则将该组件判断为<code>dirty component</code>,从而替换整个组件下的所有子节点</li></ul><p><img src="http://img.zhufengpeixun.cn/deleteall.png" alt="deleteall"></p><h3 id="_10-3-element-diff" tabindex="-1"><a class="header-anchor" href="#_10-3-element-diff"><span>10.3 element diff</span></a></h3><ul><li>当节点处于同一层级时，React diff 提供了三种节点操作,分别为：INSERT(插入)、MOVE(移动)和 REMOVE(删除)</li><li>INSERT 新的 component 类型不在老集合里， 即是全新的节点，需要对新节点执行插入操作</li><li>MOVE 在老集合有新 component 类型，就需要做移动操作，可以复用以前的 DOM 节点</li><li>REMOVE 老 component 不在新集合里的，也需要执行删除操作</li></ul><h3 id="_10-4-key" tabindex="-1"><a class="header-anchor" href="#_10-4-key"><span>10.4 key</span></a></h3><p><img src="http://img.zhufengpeixun.cn/oldnewmove.png" alt="oldnewmove"></p><p><img src="http://img.zhufengpeixun.cn/oldnewmove2.png" alt="oldnewmove2"></p><p><img src="http://img.zhufengpeixun.cn/oldnewmove3.png" alt="oldnewmove3"></p><h2 id="_11-delegate" tabindex="-1"><a class="header-anchor" href="#_11-delegate"><span>11.delegate</span></a></h2><ul><li>delegate() 方法为指定的元素(属于被选元素的子元素)添加一个或多个事件处理程序，并规定当这些事件发生时运行的函数，使用 delegate() 方法的事件处理程序适用于当前或未来的元素(比如由脚本创建的新元素)</li></ul><table><thead><tr><th style="text-align:left;">参数名称</th><th style="text-align:left;">参数含义</th></tr></thead><tbody><tr><td style="text-align:left;">childSelector</td><td style="text-align:left;">必需,规定要附加事件处理程序的一个或多个子元素</td></tr><tr><td style="text-align:left;">event</td><td style="text-align:left;">必需,规定附加到元素的一个或多个事件,由空格分隔多个事件值。必须是有效的事件</td></tr><tr><td style="text-align:left;">data</td><td style="text-align:left;">可选,规定传递到函数的额外数据</td></tr><tr><td style="text-align:left;">function</td><td style="text-align:left;">必需,规定当事件发生时运行的函数</td></tr></tbody></table><ul><li><p><a href="https://api.jquery.com/delegate/" target="_blank" rel="noopener noreferrer">delegate</a></p></li><li><p><a href="http://api.jquery.com/undelegate/" target="_blank" rel="noopener noreferrer">undelegate</a></p></li><li><p>参数<code>events</code>还支持为事件类型附加额外的命名空间</p></li><li><p>当为同一元素绑定多个相同类型的事件处理函数时。使用命名空间，可以在触发事件、移除事件时限定触发或移除的范围。</p></li></ul><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code class="language-javascript"><span class="line"><span class="token keyword">var</span> $document <span class="token operator">=</span> <span class="token function">$</span><span class="token punctuation">(</span>document<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"> <span class="token comment">//为</span></span>
<span class="line"> $document<span class="token punctuation">.</span><span class="token function">delegate</span><span class="token punctuation">(</span>&quot;</span>
<span class="line">    <span class="token function">alert</span><span class="token punctuation">(</span><span class="token string">&quot;click-1&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"> <span class="token comment">//为</span></span>
<span class="line"> $document<span class="token punctuation">.</span><span class="token function">delegate</span><span class="token punctuation">(</span>&quot;</span>
<span class="line">    <span class="token function">alert</span><span class="token punctuation">(</span><span class="token string">&quot;click-2&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"> <span class="token comment">//为</span></span>
<span class="line"> $document<span class="token punctuation">.</span><span class="token function">delegate</span><span class="token punctuation">(</span>&quot;</span>
<span class="line">    <span class="token function">alert</span><span class="token punctuation">(</span><span class="token string">&quot;click-3&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span class="token comment">// 触发所有click事件</span></span>
<span class="line">$btn1<span class="token punctuation">.</span><span class="token function">trigger</span><span class="token punctuation">(</span><span class="token string">&quot;click&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 触发A和B (event.namespace = &quot;&quot;)</span></span>
<span class="line"><span class="token comment">// 触发定义在foo命名空间下的click事件</span></span>
<span class="line">$btn1<span class="token punctuation">.</span><span class="token function">trigger</span><span class="token punctuation">(</span><span class="token string">&quot;click.foo&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 触发A (event.namespace = &quot;foo&quot;)</span></span>
<span class="line"><span class="token comment">// 触发定义在bar命名空间下的click事件</span></span>
<span class="line">$btn1<span class="token punctuation">.</span><span class="token function">trigger</span><span class="token punctuation">(</span><span class="token string">&quot;click.bar&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 触发A (event.namespace = &quot;bar&quot;)</span></span>
<span class="line"><span class="token comment">// 移除所有btn1元素定义在foo命名空间下的click事件处理函数</span></span>
<span class="line">$btn1<span class="token punctuation">.</span><span class="token function">undelegate</span><span class="token punctuation">(</span> <span class="token string">&quot;click.foo&quot;</span> <span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 移除A</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">// $document.undelegate(&quot;.test&quot;); // 移除click-2、click-3</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">// $document.undelegate(&quot;.foo&quot;);  // 移除click-1、click-3</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">// $document.undelegate(&quot;.foo.bar&quot;);  // 移除click-1</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div>`,140)])])}const i=s(e,[["render",o]]),u=JSON.parse('{"path":"/strong/62.8.react-source.html","title":"","lang":"en-US","frontmatter":{},"git":{"updatedTime":1681290319000,"contributors":[{"name":"yutao","username":"yutao","email":"642231346@qq.com","commits":1,"url":"https://github.com/yutao"}],"changelog":[{"hash":"f5ab8c9d34991ec274f7f652439afe5b2afb6147","time":1681290319000,"email":"642231346@qq.com","author":"yutao","message":"modify"}]},"filePathRelative":"strong/62.8.react-source.md"}');export{i as comp,u as data};
