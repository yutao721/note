import{_ as s,c as a,a as p,o as t}from"./app-CD1YpnS1.js";const e={};function o(c,n){return t(),a("div",null,[...n[0]||(n[0]=[p(`<h2 id="_1-微信支付" tabindex="-1"><a class="header-anchor" href="#_1-微信支付"><span>1. 微信支付</span></a></h2><ul><li>扫码支付是指商户系统按微信支付协议生成支付二维码，用户再用微信“扫一扫”来完成支付。</li><li>适用于PC网站支付、实体店单品等场景。</li></ul><p><img src="http://file.service.qq.com/user-files/uploads/201808/8f41fd93e1f52c38fbd067b9d09f11ed.jpg" alt="qcode"></p><h2 id="_2-申请流程" tabindex="-1"><a class="header-anchor" href="#_2-申请流程"><span>2. 申请流程</span></a></h2><h3 id="_2-1-注册公众号" tabindex="-1"><a class="header-anchor" href="#_2-1-注册公众号"><span>2.1 注册公众号</span></a></h3><p>请根据营业执照类型选择以下主体注册：</p><ul><li><a href="http://kf.qq.com/faq/120911VrYVrA151009JB3i2Q.html" target="_blank" rel="noopener noreferrer">个体工商户</a></li><li><a href="http://kf.qq.com/faq/120911VrYVrA151013MfYvYV.html" target="_blank" rel="noopener noreferrer">企业/公司</a></li><li><a href="http://kf.qq.com/faq/120911VrYVrA15100973ABZz.html" target="_blank" rel="noopener noreferrer">政府</a></li><li><a href="http://kf.qq.com/faq/120911VrYVrA151013aMNfeQ.html" target="_blank" rel="noopener noreferrer">媒体</a></li><li><a href="http://kf.qq.com/faq/120911VrYVrA151013nYFZ7Z.html" target="_blank" rel="noopener noreferrer">其他类型</a>|</li></ul><h3 id="_2-2-认证公众号" tabindex="-1"><a class="header-anchor" href="#_2-2-认证公众号"><span>2.2 认证公众号</span></a></h3><p>公众号认证后才可申请微信支付，认证费：300元/次 查看[认证流程](http://kf.qq.com/product/weixinmp.html</p><h3 id="_2-3-提交资料申请微信支付" tabindex="-1"><a class="header-anchor" href="#_2-3-提交资料申请微信支付"><span>2.3 提交资料申请微信支付</span></a></h3><p>登录公众平台，点击左侧菜单【微信支付】，开始填写资料等待审核，审核时间为48小时内。</p><h3 id="_2-4-开户成功-进行账户验证" tabindex="-1"><a class="header-anchor" href="#_2-4-开户成功-进行账户验证"><span>2.4 开户成功，进行账户验证</span></a></h3><p>资料审核通过后，开户信息会通过邮件、公众号发送给联系人，请按照指引填写财付通备付金汇入的随机金额，完成账户验证。（查看验证方法）</p><h3 id="_2-5-在线签署协议" tabindex="-1"><a class="header-anchor" href="#_2-5-在线签署协议"><span>2.5 在线签署协议</span></a></h3><p>本协议为线上电子协议，签署后方可进行交易及资金结算，签署完立即生效。点此提前预览协议内容。</p><h3 id="_2-6-启动设计和开发" tabindex="-1"><a class="header-anchor" href="#_2-6-启动设计和开发"><span>2.6 启动设计和开发</span></a></h3><p>支付接口已获得，可根据<a href="https://pay.weixin.qq.com/wiki/doc/api/index.html" target="_blank" rel="noopener noreferrer">开发文档</a>进行开发，也可了解成功案例界面示意及素材。</p><h2 id="_3-准备素材" tabindex="-1"><a class="header-anchor" href="#_3-准备素材"><span>3. 准备素材</span></a></h2><ul><li><a href="https://pay.weixin.qq.com/wiki/doc/api/native.php?chapter=6_1" target="_blank" rel="noopener noreferrer">扫码支付</a></li><li>APPID <a href="https://mp.weixin.qq.com" target="_blank" rel="noopener noreferrer">公众平台</a>(1959583119)-&gt;右上角-&gt;开发者ID-&gt;AppID</li><li>商户号码和配置回调链接 <a href="https://pay.weixin.qq.com" target="_blank" rel="noopener noreferrer">商户平台</a>-&gt;产品中心-&gt;开发配置-&gt;商户信息-&gt;商户号</li><li>配置APPID <a href="https://pay.weixin.qq.com" target="_blank" rel="noopener noreferrer">商户平台</a>-&gt;产品中心-&gt;APPID授权管理</li><li>API密钥 <a href="https://pay.weixin.qq.com" target="_blank" rel="noopener noreferrer">商户平台</a>-&gt;账户中心-&gt;API安全-&gt;设置API密钥</li></ul><h2 id="_4-接入流程" tabindex="-1"><a class="header-anchor" href="#_4-接入流程"><span>4.接入流程</span></a></h2><ul><li>商户后台系统先调用微信支付的统一下单接口</li><li>微信后台系统返回链接参数code_url</li><li>商户后台系统将code_url值生成二维码图片</li><li>用户使用微信客户端扫码后发起支付</li><li>注意：code_url有效期为2小时，过期后扫码不能再发起支付。</li></ul><p><img src="https://pay.weixin.qq.com/wiki/doc/api/img/chapter6_5_1.png" alt="接入流程"></p><p>业务流程说明：</p><ul><li>1）商户后台系统根据用户选购的商品生成订单。</li><li>2）用户确认支付后调用微信支付<a href="https://pay.weixin.qq.com/wiki/doc/api/native.php?chapter=9_1" target="_blank" rel="noopener noreferrer">统一下单API</a>生成预支付交易；</li><li>3）微信支付系统收到请求后生成预支付交易单，并返回交易会话的二维码链接code_url。</li><li>4）商户后台系统根据返回的code_url生成二维码。</li><li>5）用户打开微信“扫一扫”扫描二维码，微信客户端将扫码内容发送到微信支付系统。</li><li>6）微信支付系统收到客户端请求，验证链接有效性后发起用户支付，要求用户授权。</li><li>7）用户在微信客户端输入密码，确认支付后，微信客户端提交授权。</li><li>8）微信支付系统根据用户授权完成支付交易。</li><li>9）微信支付系统完成支付交易后给微信客户端返回交易结果，并将交易结果通过短信、微信消息提示用户。微信客户端展示支付交易结果页面。</li><li>10）微信支付系统通过发送异步消息通知商户后台系统支付结果。商户后台系统需回复接收情况，通知微信后台系统不再发送该单的支付通知。</li><li>11）未收到支付通知的情况，商户后台系统调用<a href="https://pay.weixin.qq.com/wiki/doc/api/native.php?chapter=9_2" target="_blank" rel="noopener noreferrer">查询订单API</a></li><li>12）商户确认订单已支付后给用户发货。</li></ul><h2 id="_5-绘制页面" tabindex="-1"><a class="header-anchor" href="#_5-绘制页面"><span>5.绘制页面</span></a></h2><h3 id="_5-1-生成项目" tabindex="-1"><a class="header-anchor" href="#_5-1-生成项目"><span>5.1 生成项目</span></a></h3><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code class="language-javascript"><span class="line">$ npm i egg<span class="token operator">-</span>init <span class="token operator">-</span>g</span>
<span class="line">$ egg<span class="token operator">-</span>init zhufeng<span class="token operator">-</span>wxpay <span class="token operator">--</span>type<span class="token operator">=</span>simple</span>
<span class="line">$ cd zhufeng<span class="token operator">-</span>wxpay</span>
<span class="line">$ npm i</span>
<span class="line">$ npm run dev</span>
<span class="line">$ open localhost<span class="token operator">:</span><span class="token number">7001</span></span>
<span class="line"></span>
<span class="line">ssh <span class="token operator">-</span>vnNT <span class="token operator">-</span><span class="token constant">R</span> <span class="token number">7689</span><span class="token operator">:</span>localhost<span class="token operator">:</span><span class="token number">7001</span> root@<span class="token number">47.105</span><span class="token number">.88</span><span class="token number">.180</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_5-2-支持模版" tabindex="-1"><a class="header-anchor" href="#_5-2-支持模版"><span>5.2 支持模版</span></a></h3><h4 id="_5-2-1-package-json" tabindex="-1"><a class="header-anchor" href="#_5-2-1-package-json"><span>5.2.1 package.json</span></a></h4><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text"><pre><code class="language-text"><span class="line">yarn add egg-view-ejs</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><h4 id="_5-2-2-app-controller-home-js" tabindex="-1"><a class="header-anchor" href="#_5-2-2-app-controller-home-js"><span>5.2.2 app/controller/home.js</span></a></h4><p>app/controller/home.js</p><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text"><pre><code class="language-text"><span class="line">   async checkout() {</span>
<span class="line">-      </span>
<span class="line">+      const { ctx, app } = this;</span>
<span class="line">+      await ctx.render(&#39;checkout&#39;);</span>
<span class="line">   }</span>
<span class="line"> }</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_5-2-3-checkout-html" tabindex="-1"><a class="header-anchor" href="#_5-2-3-checkout-html"><span>5.2.3 checkout.html</span></a></h4><p>app/view/checkout.html</p><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code class="language-javascript"><span class="line"><span class="token operator">&lt;</span><span class="token operator">!</span><span class="token constant">DOCTYPE</span> html<span class="token operator">&gt;</span></span>
<span class="line"><span class="token operator">&lt;</span>html lang<span class="token operator">=</span><span class="token string">&quot;en&quot;</span><span class="token operator">&gt;</span></span>
<span class="line"><span class="token operator">&lt;</span>head<span class="token operator">&gt;</span></span>
<span class="line">    <span class="token operator">&lt;</span>meta charset<span class="token operator">=</span><span class="token string">&quot;UTF-8&quot;</span><span class="token operator">&gt;</span></span>
<span class="line">    <span class="token operator">&lt;</span>meta name<span class="token operator">=</span><span class="token string">&quot;viewport&quot;</span> content<span class="token operator">=</span><span class="token string">&quot;width=device-width, initial-scale=1.0&quot;</span><span class="token operator">&gt;</span></span>
<span class="line">    <span class="token operator">&lt;</span>meta http<span class="token operator">-</span>equiv<span class="token operator">=</span><span class="token string">&quot;X-UA-Compatible&quot;</span> content<span class="token operator">=</span><span class="token string">&quot;ie=edge&quot;</span><span class="token operator">&gt;</span></span>
<span class="line">    <span class="token operator">&lt;</span>link rel<span class="token operator">=</span><span class="token string">&quot;stylesheet&quot;</span> href<span class="token operator">=</span><span class="token string">&quot;https://cdn.bootcss.com/bootstrap/4.0.0/css/bootstrap.min.css&quot;</span> integrity<span class="token operator">=</span><span class="token string">&quot;sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm&quot;</span> crossorigin<span class="token operator">=</span><span class="token string">&quot;anonymous&quot;</span><span class="token operator">&gt;</span></span>
<span class="line">    <span class="token operator">&lt;</span>script src<span class="token operator">=</span><span class="token string">&quot;https://cdn.bootcss.com/jquery/3.2.1/jquery.slim.min.js&quot;</span> integrity<span class="token operator">=</span><span class="token string">&quot;sha384-KJ3o2DKtIkvYIK3UENzmM7KCkRr/rE9/Qpg6aAZGJwFDMVNA/GpGFF93hXpG5KkN&quot;</span> crossorigin<span class="token operator">=</span><span class="token string">&quot;anonymous&quot;</span><span class="token operator">&gt;</span><span class="token operator">&lt;</span><span class="token operator">/</span>script<span class="token operator">&gt;</span></span>
<span class="line">    <span class="token operator">&lt;</span>script src<span class="token operator">=</span><span class="token string">&quot;https://cdn.bootcss.com/popper.js/1.12.9/umd/popper.min.js&quot;</span> integrity<span class="token operator">=</span><span class="token string">&quot;sha384-ApNbgh9B+Y1QKtv3Rn7W3mgPxhU9K/ScQsAP7hUibX39j7fakFPskvXusvfa0b4Q&quot;</span> crossorigin<span class="token operator">=</span><span class="token string">&quot;anonymous&quot;</span><span class="token operator">&gt;</span><span class="token operator">&lt;</span><span class="token operator">/</span>script<span class="token operator">&gt;</span></span>
<span class="line">    <span class="token operator">&lt;</span>script src<span class="token operator">=</span><span class="token string">&quot;https://cdn.bootcss.com/bootstrap/4.0.0/js/bootstrap.min.js&quot;</span> integrity<span class="token operator">=</span><span class="token string">&quot;sha384-JZR6Spejh4U02d8jOt6vLEHfe/JQGiRRSQQxSfFWpi1MquVdAyjUar5+76PVCmYl&quot;</span> crossorigin<span class="token operator">=</span><span class="token string">&quot;anonymous&quot;</span><span class="token operator">&gt;</span><span class="token operator">&lt;</span><span class="token operator">/</span>script<span class="token operator">&gt;</span></span>
<span class="line">    <span class="token operator">&lt;</span>title<span class="token operator">&gt;</span>微信支付<span class="token operator">&lt;</span><span class="token operator">/</span>title<span class="token operator">&gt;</span></span>
<span class="line"><span class="token operator">&lt;</span><span class="token operator">/</span>head<span class="token operator">&gt;</span></span>
<span class="line"><span class="token operator">&lt;</span>body<span class="token operator">&gt;</span></span>
<span class="line">        <span class="token operator">&lt;</span>div <span class="token keyword">class</span><span class="token operator">=</span><span class="token string">&quot;container&quot;</span><span class="token operator">&gt;</span></span>
<span class="line">            <span class="token operator">&lt;</span>div <span class="token keyword">class</span><span class="token operator">=</span><span class="token string">&quot;row justify-content-center&quot;</span><span class="token operator">&gt;</span></span>
<span class="line">                <span class="token operator">&lt;</span>div <span class="token keyword">class</span><span class="token operator">=</span><span class="token string">&quot;col-4&quot;</span><span class="token operator">&gt;</span></span>
<span class="line">                    <span class="token operator">&lt;</span>div <span class="token keyword">class</span><span class="token operator">=</span><span class="token string">&quot;card text-center mt-5&quot;</span><span class="token operator">&gt;</span></span>
<span class="line">                        <span class="token operator">&lt;</span>div <span class="token keyword">class</span><span class="token operator">=</span><span class="token string">&quot;card-header&quot;</span><span class="token operator">&gt;</span></span>
<span class="line">                        <span class="token operator">&lt;</span>h3<span class="token operator">&gt;</span>微信支付<span class="token operator">&lt;</span><span class="token operator">/</span>h3<span class="token operator">&gt;</span></span>
<span class="line">                        <span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">&gt;</span></span>
<span class="line">                        <span class="token operator">&lt;</span>img src<span class="token operator">=</span><span class="token string">&quot;/public/images/qrcode.png&quot;</span> <span class="token keyword">class</span><span class="token operator">=</span><span class="token string">&quot;card-img-top&quot;</span><span class="token operator">&gt;</span></span>
<span class="line">                        <span class="token operator">&lt;</span>div <span class="token keyword">class</span><span class="token operator">=</span><span class="token string">&quot;card-body&quot;</span><span class="token operator">&gt;</span></span>
<span class="line">                            <span class="token operator">&lt;</span>img src<span class="token operator">=</span><span class="token string">&quot;/public/images/scan.png&quot;</span> alt<span class="token operator">=</span><span class="token string">&quot;&quot;</span> <span class="token keyword">class</span><span class="token operator">=</span><span class="token string">&quot;w-100&quot;</span><span class="token operator">&gt;</span></span>
<span class="line">                        <span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">&gt;</span></span>
<span class="line">                    <span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">&gt;</span></span>
<span class="line">                <span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">&gt;</span></span>
<span class="line">            <span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">&gt;</span></span>
<span class="line">        <span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">&gt;</span></span>
<span class="line"><span class="token operator">&lt;</span><span class="token operator">/</span>body<span class="token operator">&gt;</span></span>
<span class="line"><span class="token operator">&lt;</span><span class="token operator">/</span>html<span class="token operator">&gt;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_5-2-4-config-default-js" tabindex="-1"><a class="header-anchor" href="#_5-2-4-config-default-js"><span>5.2.4 config.default.js</span></a></h4><p>config/config.default.js</p><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code class="language-javascript"><span class="line">  config<span class="token punctuation">.</span>view<span class="token operator">=</span><span class="token punctuation">{</span></span>
<span class="line">    <span class="token literal-property property">defaultViewEngine</span><span class="token operator">:</span> <span class="token string">&#39;ejs&#39;</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token literal-property property">defaultExtension</span><span class="token operator">:</span><span class="token string">&#39;.html&#39;</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token literal-property property">mapping</span><span class="token operator">:</span> <span class="token punctuation">{</span></span>
<span class="line">       <span class="token string-property property">&#39;.html&#39;</span><span class="token operator">:</span><span class="token string">&#39;ejs&#39;</span></span>
<span class="line">    <span class="token punctuation">}</span> </span>
<span class="line">  <span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_5-2-5-plugin-js" tabindex="-1"><a class="header-anchor" href="#_5-2-5-plugin-js"><span>5.2.5 plugin.js</span></a></h4><p>config/plugin.js</p><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code class="language-javascript"><span class="line">exports<span class="token punctuation">.</span>ejs <span class="token operator">=</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token literal-property property">enable</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token keyword">package</span><span class="token operator">:</span> <span class="token string">&#39;egg-view-ejs&#39;</span><span class="token punctuation">,</span></span>
<span class="line"><span class="token punctuation">}</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_5-3-支付和通知" tabindex="-1"><a class="header-anchor" href="#_5-3-支付和通知"><span>5.3 支付和通知</span></a></h3><h4 id="_5-3-1-package-json" tabindex="-1"><a class="header-anchor" href="#_5-3-1-package-json"><span>5.3.1 package.json</span></a></h4><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text"><pre><code class="language-text"><span class="line">   &quot;dependencies&quot;: {</span>
<span class="line">+    &quot;axios&quot;: &quot;^0.18.0&quot;,</span>
<span class="line">+    &quot;moment&quot;: &quot;^2.22.2&quot;,</span>
<span class="line">+    &quot;qrcode&quot;: &quot;^1.2.2&quot;,</span>
<span class="line">+    &quot;randomstring&quot;: &quot;^1.1.5&quot;,</span>
<span class="line">+    &quot;uuid&quot;: &quot;^3.3.2&quot;,</span>
<span class="line">+    &quot;xml-js&quot;: &quot;^1.6.7&quot;</span>
<span class="line">   }</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_5-3-2-app-router-js" tabindex="-1"><a class="header-anchor" href="#_5-3-2-app-router-js"><span>5.3.2 app/router.js</span></a></h4><p>app/router.js</p><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code class="language-javascript"><span class="line">  router<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span><span class="token string">&#39;/wxpay/notify&#39;</span><span class="token punctuation">,</span>controller<span class="token punctuation">.</span>home<span class="token punctuation">.</span>notify<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><h4 id="_5-3-3-home-js" tabindex="-1"><a class="header-anchor" href="#_5-3-3-home-js"><span>5.3.3 home.js</span></a></h4><p>app/controller/home.js</p><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code class="language-javascript"><span class="line"><span class="token keyword">const</span> Controller <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&#39;egg&#39;</span><span class="token punctuation">)</span><span class="token punctuation">.</span>Controller<span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">const</span> moment <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&#39;moment&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">const</span> randomstring <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&#39;randomstring&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">const</span> querystring <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&#39;querystring&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">const</span> crypto <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&#39;crypto&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">const</span> xmljs <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&#39;xml-js&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">const</span> axios <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&#39;axios&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">const</span> qrcode <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&#39;qrcode&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">class</span> <span class="token class-name">HomeController</span> <span class="token keyword">extends</span> <span class="token class-name">Controller</span> <span class="token punctuation">{</span></span>
<span class="line">  <span class="token keyword">async</span> <span class="token function">index</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">this</span><span class="token punctuation">.</span>ctx<span class="token punctuation">.</span>body <span class="token operator">=</span> <span class="token string">&#39;hi, egg&#39;</span><span class="token punctuation">;</span></span>
<span class="line">  <span class="token punctuation">}</span></span>
<span class="line">  <span class="token function">wxSign</span><span class="token punctuation">(</span><span class="token parameter">order<span class="token punctuation">,</span> key<span class="token punctuation">,</span>logger</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token comment">//对参数进行排序  </span></span>
<span class="line">    <span class="token keyword">let</span> sortedOrder <span class="token operator">=</span> Object<span class="token punctuation">.</span><span class="token function">keys</span><span class="token punctuation">(</span>order<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">sort</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">reduce</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">memo<span class="token punctuation">,</span> key</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></span>
<span class="line">      memo<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">=</span> order<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">;</span></span>
<span class="line">      <span class="token keyword">return</span> memo<span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    logger<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&#39;排过序的订单&#39;</span><span class="token punctuation">,</span> sortedOrder<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token comment">//转化成字符串  </span></span>
<span class="line">    <span class="token keyword">const</span> stringifiedOrder <span class="token operator">=</span> querystring<span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>sortedOrder<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token punctuation">{</span></span>
<span class="line">      <span class="token literal-property property">encodeURIComponent</span><span class="token operator">:</span> querystring<span class="token punctuation">.</span>unescape</span>
<span class="line">    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    logger<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&#39;不带key的订单字符串&#39;</span><span class="token punctuation">,</span> stringifiedOrder<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token comment">//加上密钥  </span></span>
<span class="line">    <span class="token keyword">const</span> stringifiedOrderWithKey <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">\`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">\${</span>stringifiedOrder<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&amp;key=</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">\${</span>key<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">\`</span></span><span class="token punctuation">;</span></span>
<span class="line">    logger<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&#39;带key的订单字符串&#39;</span><span class="token punctuation">,</span> stringifiedOrderWithKey<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token comment">//计算出签名</span></span>
<span class="line">    <span class="token keyword">const</span> sign <span class="token operator">=</span> crypto<span class="token punctuation">.</span><span class="token function">createHash</span><span class="token punctuation">(</span><span class="token string">&#39;md5&#39;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span>stringifiedOrderWithKey<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">digest</span><span class="token punctuation">(</span><span class="token string">&#39;hex&#39;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toUpperCase</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">return</span> sign<span class="token punctuation">;</span></span>
<span class="line">  <span class="token punctuation">}</span></span>
<span class="line">  <span class="token keyword">async</span> <span class="token function">checkout</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">const</span> <span class="token punctuation">{</span></span>
<span class="line">      ctx<span class="token punctuation">,</span></span>
<span class="line">      app</span>
<span class="line">    <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">const</span> <span class="token punctuation">{</span></span>
<span class="line">      logger</span>
<span class="line">    <span class="token punctuation">}</span> <span class="token operator">=</span> ctx<span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">const</span> <span class="token punctuation">{</span></span>
<span class="line">      wxpay <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span></span>
<span class="line">    <span class="token punctuation">}</span> <span class="token operator">=</span> app<span class="token punctuation">.</span>config<span class="token punctuation">;</span></span>
<span class="line">    <span class="token comment">//公众账号ID</span></span>
<span class="line">    <span class="token keyword">const</span> appid <span class="token operator">=</span> wxpay<span class="token punctuation">.</span>appid<span class="token punctuation">;</span></span>
<span class="line">    <span class="token comment">//商户号码 商户平台(https://pay.weixin.qq.com)-&gt;产品中心-&gt;开发配置-&gt;商户信息-&gt;商户号</span></span>
<span class="line">    <span class="token comment">//APPID授权管理 商户平台(https://pay.weixin.qq.com)-&gt;产品中心-&gt;开发配置-&gt;商户信息-&gt;商户号</span></span>
<span class="line">    <span class="token keyword">const</span> mch_id <span class="token operator">=</span> wxpay<span class="token punctuation">.</span>mch_id<span class="token punctuation">;</span></span>
<span class="line">    <span class="token comment">//回调通知url</span></span>
<span class="line">    <span class="token keyword">const</span> notify_url <span class="token operator">=</span> wxpay<span class="token punctuation">.</span>notify_url<span class="token punctuation">;</span></span>
<span class="line">    <span class="token comment">//密钥</span></span>
<span class="line">    <span class="token keyword">const</span> key <span class="token operator">=</span> wxpay<span class="token punctuation">.</span>key<span class="token punctuation">;</span></span>
<span class="line">    <span class="token comment">//统一下单接口</span></span>
<span class="line">    <span class="token keyword">const</span> unifiedorder <span class="token operator">=</span> wxpay<span class="token punctuation">.</span>unifiedorder<span class="token punctuation">;</span></span>
<span class="line">    <span class="token comment">//商户订单号</span></span>
<span class="line">    <span class="token keyword">const</span> out_trade_no <span class="token operator">=</span> <span class="token function">moment</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">local</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token string">&#39;YYYYMMDDhhmmss&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token comment">//商品描述</span></span>
<span class="line">    <span class="token keyword">const</span> body <span class="token operator">=</span> <span class="token string">&#39;珠峰培训&#39;</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token comment">//商品价格</span></span>
<span class="line">    <span class="token keyword">const</span> total_fee <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token comment">//支付类型</span></span>
<span class="line">    <span class="token keyword">const</span> trade_type <span class="token operator">=</span> <span class="token string">&#39;NATIVE&#39;</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token comment">//商品ID</span></span>
<span class="line">    <span class="token keyword">const</span> product_id <span class="token operator">=</span> <span class="token number">100</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token comment">//随机字符串</span></span>
<span class="line">    <span class="token keyword">const</span> nonce_str <span class="token operator">=</span> randomstring<span class="token punctuation">.</span><span class="token function">generate</span><span class="token punctuation">(</span><span class="token number">32</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token comment">//构建订单  </span></span>
<span class="line">    <span class="token keyword">let</span> order <span class="token operator">=</span> <span class="token punctuation">{</span></span>
<span class="line">      appid<span class="token punctuation">,</span></span>
<span class="line">      mch_id<span class="token punctuation">,</span></span>
<span class="line">      out_trade_no<span class="token punctuation">,</span></span>
<span class="line">      body<span class="token punctuation">,</span></span>
<span class="line">      total_fee<span class="token punctuation">,</span></span>
<span class="line">      product_id<span class="token punctuation">,</span></span>
<span class="line">      notify_url<span class="token punctuation">,</span></span>
<span class="line">      nonce_str<span class="token punctuation">,</span></span>
<span class="line">      trade_type</span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    <span class="token keyword">const</span> sign <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">wxSign</span><span class="token punctuation">(</span>order<span class="token punctuation">,</span> key<span class="token punctuation">,</span>logger<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    logger<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&#39;签名&#39;</span><span class="token punctuation">,</span> sign<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token comment">//转换成XML格式    </span></span>
<span class="line">    <span class="token keyword">const</span> xmlOrder <span class="token operator">=</span> xmljs<span class="token punctuation">.</span><span class="token function">js2xml</span><span class="token punctuation">(</span><span class="token punctuation">{</span></span>
<span class="line">      <span class="token literal-property property">xml</span><span class="token operator">:</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token operator">...</span>order<span class="token punctuation">,</span></span>
<span class="line">        sign</span>
<span class="line">      <span class="token punctuation">}</span></span>
<span class="line">    <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{</span></span>
<span class="line">      <span class="token literal-property property">compact</span><span class="token operator">:</span> <span class="token boolean">true</span></span>
<span class="line">    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    logger<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&#39;XML订单&#39;</span><span class="token punctuation">,</span> xmlOrder<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token comment">//请求统一下单接口</span></span>
<span class="line">    <span class="token keyword">const</span> unifiedorderResponse <span class="token operator">=</span> <span class="token keyword">await</span> axios<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span>unifiedorder<span class="token punctuation">,</span> xmlOrder<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    logger<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&#39;统一下单响应&#39;</span><span class="token punctuation">,</span> unifiedorderResponse<span class="token punctuation">.</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">    <span class="token keyword">const</span> _prepay <span class="token operator">=</span> xmljs<span class="token punctuation">.</span><span class="token function">xml2js</span><span class="token punctuation">(</span>unifiedorderResponse<span class="token punctuation">.</span>data<span class="token punctuation">,</span> <span class="token punctuation">{</span></span>
<span class="line">      <span class="token literal-property property">compact</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span></span>
<span class="line">      <span class="token literal-property property">cdataKey</span><span class="token operator">:</span> <span class="token string">&#39;value&#39;</span><span class="token punctuation">,</span></span>
<span class="line">      <span class="token literal-property property">textKey</span><span class="token operator">:</span><span class="token string">&#39;value&#39;</span></span>
<span class="line">    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    logger<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&#39;_prepay&#39;</span><span class="token punctuation">,</span> _prepay<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">    <span class="token keyword">const</span> prepay <span class="token operator">=</span> Object<span class="token punctuation">.</span><span class="token function">entries</span><span class="token punctuation">(</span>_prepay<span class="token punctuation">.</span>xml<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">reduce</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">memo<span class="token punctuation">,</span> <span class="token punctuation">[</span>key<span class="token punctuation">,</span> value<span class="token punctuation">]</span></span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></span>
<span class="line">      memo<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token operator">=</span>value<span class="token punctuation">.</span>value<span class="token punctuation">;</span></span>
<span class="line">      <span class="token keyword">return</span> memo<span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">    logger<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&#39;prepay&#39;</span><span class="token punctuation">,</span> prepay<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">const</span> <span class="token punctuation">{</span></span>
<span class="line">      code_url</span>
<span class="line">    <span class="token punctuation">}</span> <span class="token operator">=</span> prepay<span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">const</span> qrcodeUrl <span class="token operator">=</span> <span class="token keyword">await</span> qrcode<span class="token punctuation">.</span><span class="token function">toDataURL</span><span class="token punctuation">(</span>code_url<span class="token punctuation">,</span> <span class="token punctuation">{</span></span>
<span class="line">      <span class="token literal-property property">width</span><span class="token operator">:</span> <span class="token number">300</span></span>
<span class="line">    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">await</span> ctx<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span><span class="token string">&#39;checkout&#39;</span><span class="token punctuation">,</span> <span class="token punctuation">{</span></span>
<span class="line">      qrcodeUrl</span>
<span class="line">    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">  <span class="token punctuation">}</span></span>
<span class="line">  <span class="token function">parseXML</span><span class="token punctuation">(</span><span class="token parameter">req</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">      <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span>reject</span><span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line">          <span class="token keyword">let</span> buffers <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span></span>
<span class="line">          req<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">&#39;data&#39;</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">data</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">              buffers<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">          <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">          req<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">&#39;end&#39;</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">              <span class="token keyword">let</span> ret <span class="token operator">=</span> Buffer<span class="token punctuation">.</span><span class="token function">concat</span><span class="token punctuation">(</span>buffers<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">              <span class="token function">resolve</span><span class="token punctuation">(</span>ret<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">          <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">  <span class="token punctuation">}</span></span>
<span class="line">  <span class="token keyword">async</span> <span class="token function">notify</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">const</span> <span class="token punctuation">{</span>ctx<span class="token punctuation">,</span>app<span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">;</span></span>
<span class="line">      <span class="token keyword">const</span> <span class="token punctuation">{</span> logger <span class="token punctuation">}</span> <span class="token operator">=</span> ctx<span class="token punctuation">;</span></span>
<span class="line">      <span class="token keyword">const</span> <span class="token punctuation">{</span></span>
<span class="line">        wxpay <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span></span>
<span class="line">      <span class="token punctuation">}</span> <span class="token operator">=</span> app<span class="token punctuation">.</span>config<span class="token punctuation">;</span></span>
<span class="line">      <span class="token keyword">const</span> key <span class="token operator">=</span> wxpay<span class="token punctuation">.</span>key<span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">let</span> body <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">parseXML</span><span class="token punctuation">(</span>ctx<span class="token punctuation">.</span>req<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    logger<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">&#39;request&#39;</span><span class="token punctuation">,</span>body<span class="token punctuation">)</span><span class="token punctuation">;</span>  </span>
<span class="line">    <span class="token keyword">const</span> _payment <span class="token operator">=</span> xmljs<span class="token punctuation">.</span><span class="token function">xml2js</span><span class="token punctuation">(</span>body<span class="token punctuation">,</span> <span class="token punctuation">{</span></span>
<span class="line">      <span class="token literal-property property">compact</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span></span>
<span class="line">      <span class="token literal-property property">cdataKey</span><span class="token operator">:</span> <span class="token string">&#39;value&#39;</span><span class="token punctuation">,</span></span>
<span class="line">      <span class="token literal-property property">textKey</span><span class="token operator">:</span><span class="token string">&#39;value&#39;</span></span>
<span class="line">    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    logger<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&#39;_payment&#39;</span><span class="token punctuation">,</span> _payment<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">const</span> payment <span class="token operator">=</span> Object<span class="token punctuation">.</span><span class="token function">entries</span><span class="token punctuation">(</span>_payment<span class="token punctuation">.</span>xml<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">reduce</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">memo<span class="token punctuation">,</span> <span class="token punctuation">[</span>key<span class="token punctuation">,</span> value<span class="token punctuation">]</span></span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></span>
<span class="line">      memo<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">=</span> value<span class="token punctuation">.</span>value<span class="token punctuation">;</span></span>
<span class="line">      <span class="token keyword">return</span> memo<span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    logger<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&#39;payment&#39;</span><span class="token punctuation">,</span> payment<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">const</span> paymentSign <span class="token operator">=</span> payment<span class="token punctuation">.</span>sign<span class="token punctuation">;</span></span>
<span class="line">    logger<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">&#39;paymentSign&#39;</span><span class="token punctuation">,</span> paymentSign<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">delete</span> payment<span class="token punctuation">.</span>sign<span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">const</span> mySign <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">wxSign</span><span class="token punctuation">(</span>payment<span class="token punctuation">,</span> key<span class="token punctuation">,</span>logger<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    logger<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">&#39;mySign&#39;</span><span class="token punctuation">,</span> mySign<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">const</span> return_code <span class="token operator">=</span> paymentSign <span class="token operator">===</span> mySign <span class="token operator">?</span> <span class="token string">&#39;SUCCESS&#39;</span> <span class="token operator">:</span> <span class="token string">&quot;FAIL&quot;</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">const</span> reply <span class="token operator">=</span> <span class="token punctuation">{</span></span>
<span class="line">      <span class="token literal-property property">xml</span><span class="token operator">:</span> <span class="token punctuation">{</span></span>
<span class="line">        return_code</span>
<span class="line">      <span class="token punctuation">}</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    <span class="token keyword">const</span> ret <span class="token operator">=</span> xmljs<span class="token punctuation">.</span><span class="token function">js2xml</span><span class="token punctuation">(</span>reply<span class="token punctuation">,</span> <span class="token punctuation">{</span></span>
<span class="line">      <span class="token literal-property property">compact</span><span class="token operator">:</span> <span class="token boolean">true</span></span>
<span class="line">    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    logger<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">&#39;通知返回&#39;</span><span class="token punctuation">,</span> ret<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    ctx<span class="token punctuation">.</span>body <span class="token operator">=</span> ret<span class="token punctuation">;</span></span>
<span class="line">  <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">module<span class="token punctuation">.</span>exports <span class="token operator">=</span> HomeController<span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_5-3-4-checkout-html" tabindex="-1"><a class="header-anchor" href="#_5-3-4-checkout-html"><span>5.3.4 checkout.html</span></a></h4><p>app/view/checkout.html</p><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text"><pre><code class="language-text"><span class="line">-    &lt;img src=&quot;/public/images/qrcode.png&quot; class=&quot;card-img-top&quot;&gt;</span>
<span class="line">+    &lt;img src=&quot;&lt;%=qrcodeUrl%&gt;&quot; class=&quot;card-img-top&quot;&gt;</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_5-3-5-config-default-js" tabindex="-1"><a class="header-anchor" href="#_5-3-5-config-default-js"><span>5.3.5 config.default.js</span></a></h4><p>config/config.default.js</p><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code class="language-javascript"><span class="line">  config<span class="token punctuation">.</span>logger<span class="token operator">=</span><span class="token punctuation">{</span></span>
<span class="line">    <span class="token literal-property property">level</span><span class="token operator">:</span> <span class="token string">&#39;DEBUG&#39;</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token literal-property property">allowDebugAtProd</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token literal-property property">consoleLevel</span><span class="token operator">:</span> <span class="token string">&#39;DEBUG&#39;</span></span>
<span class="line">  <span class="token punctuation">}</span></span>
<span class="line">  exports<span class="token punctuation">.</span>security <span class="token operator">=</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token literal-property property">csrf</span><span class="token operator">:</span> <span class="token punctuation">{</span></span>
<span class="line">      <span class="token literal-property property">enable</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span></span>
<span class="line">      <span class="token literal-property property">ignoreJSON</span><span class="token operator">:</span> <span class="token boolean">true</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">  <span class="token punctuation">}</span><span class="token punctuation">;</span></span>
<span class="line">  config<span class="token punctuation">.</span>wxpay<span class="token operator">=</span><span class="token punctuation">{</span></span>
<span class="line">    <span class="token literal-property property">appid</span><span class="token operator">:</span> <span class="token string">&#39;&#39;</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token literal-property property">mch_id</span><span class="token operator">:</span> <span class="token string">&#39;&#39;</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token literal-property property">key</span><span class="token operator">:</span> <span class="token string">&#39;&#39;</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token literal-property property">notify_url</span><span class="token operator">:</span> <span class="token string">&#39;http://front.zhufengpeixun.cn/wxpay/notify&#39;</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token literal-property property">unifiedorder</span><span class="token operator">:</span><span class="token string">&#39;https://api.mch.weixin.qq.com/pay/unifiedorder&#39;</span></span>
<span class="line">  <span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_5-4-查询结果" tabindex="-1"><a class="header-anchor" href="#_5-4-查询结果"><span>5.4 查询结果</span></a></h3><h4 id="_5-4-1-app-router-js" tabindex="-1"><a class="header-anchor" href="#_5-4-1-app-router-js"><span>5.4.1 app/router.js</span></a></h4><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code class="language-javascript"><span class="line">router<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&#39;/wxpay/query&#39;</span><span class="token punctuation">,</span>controller<span class="token punctuation">.</span>home<span class="token punctuation">.</span>query<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><h4 id="_5-4-2-result-html" tabindex="-1"><a class="header-anchor" href="#_5-4-2-result-html"><span>5.4.2 result.html</span></a></h4><p>app/view/result.html</p><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code class="language-javascript"><span class="line"><span class="token operator">&lt;</span>body<span class="token operator">&gt;</span></span>
<span class="line">    <span class="token operator">&lt;</span>div <span class="token keyword">class</span><span class="token operator">=</span><span class="token string">&quot;container&quot;</span><span class="token operator">&gt;</span></span>
<span class="line">        <span class="token operator">&lt;</span>div <span class="token keyword">class</span><span class="token operator">=</span><span class="token string">&quot;jumbotron mt-5 text-center&quot;</span><span class="token operator">&gt;</span></span>
<span class="line">            <span class="token operator">&lt;</span>h1<span class="token operator">&gt;</span><span class="token operator">&lt;</span><span class="token operator">%=</span>trade_state_desc<span class="token operator">%</span><span class="token operator">&gt;</span><span class="token operator">&lt;</span><span class="token operator">/</span>h1<span class="token operator">&gt;</span></span>
<span class="line">        <span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">&gt;</span></span>
<span class="line">    <span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">&gt;</span></span>
<span class="line"><span class="token operator">&lt;</span><span class="token operator">/</span>body<span class="token operator">&gt;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_5-4-3-config-default-js" tabindex="-1"><a class="header-anchor" href="#_5-4-3-config-default-js"><span>5.4.3 config.default.js</span></a></h4><p>config/config.default.js</p><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text"><pre><code class="language-text"><span class="line">+    unifiedorder: &#39;https://api.mch.weixin.qq.com/pay/unifiedorder&#39;,</span>
<span class="line">+    orderquery:&#39;https://api.mch.weixin.qq.com/pay/orderquery&#39;</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_5-4-4-app-controller-home-js" tabindex="-1"><a class="header-anchor" href="#_5-4-4-app-controller-home-js"><span>5.4.4 app/controller/home.js</span></a></h4><p>home.js</p><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code class="language-javascript"><span class="line"><span class="token string">&#39;use strict&#39;</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">const</span> Controller <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&#39;egg&#39;</span><span class="token punctuation">)</span><span class="token punctuation">.</span>Controller<span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">const</span> moment <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&#39;moment&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">const</span> randomstring <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&#39;randomstring&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">const</span> querystring <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&#39;querystring&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">const</span> crypto <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&#39;crypto&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">const</span> transformer <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&#39;xml-js&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">const</span> axios <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&#39;axios&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">const</span> qrcode <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&#39;qrcode&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">class</span> <span class="token class-name">HomeController</span> <span class="token keyword">extends</span> <span class="token class-name">Controller</span> <span class="token punctuation">{</span></span>
<span class="line">  <span class="token keyword">async</span> <span class="token function">index</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">this</span><span class="token punctuation">.</span>ctx<span class="token punctuation">.</span>body <span class="token operator">=</span> <span class="token string">&#39;hi, egg&#39;</span><span class="token punctuation">;</span></span>
<span class="line">  <span class="token punctuation">}</span></span>
<span class="line">  <span class="token function">wxSign</span><span class="token punctuation">(</span><span class="token parameter">order<span class="token punctuation">,</span> key<span class="token punctuation">,</span>logger</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token comment">//对参数进行排序  </span></span>
<span class="line">    <span class="token keyword">let</span> sortedOrder <span class="token operator">=</span> Object<span class="token punctuation">.</span><span class="token function">keys</span><span class="token punctuation">(</span>order<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">sort</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">reduce</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">memo<span class="token punctuation">,</span> key</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></span>
<span class="line">      memo<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">=</span> order<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">;</span></span>
<span class="line">      <span class="token keyword">return</span> memo<span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    logger<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&#39;排过序的订单&#39;</span><span class="token punctuation">,</span> sortedOrder<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token comment">//转化成字符串  </span></span>
<span class="line">    <span class="token keyword">const</span> stringifiedOrder <span class="token operator">=</span> querystring<span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>sortedOrder<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token punctuation">{</span></span>
<span class="line">      <span class="token literal-property property">encodeURIComponent</span><span class="token operator">:</span> querystring<span class="token punctuation">.</span>unescape</span>
<span class="line">    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    logger<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&#39;不带key的订单字符串&#39;</span><span class="token punctuation">,</span> stringifiedOrder<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token comment">//加上密钥  </span></span>
<span class="line">    <span class="token keyword">const</span> stringifiedOrderWithKey <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">\`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">\${</span>stringifiedOrder<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&amp;key=</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">\${</span>key<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">\`</span></span><span class="token punctuation">;</span></span>
<span class="line">    logger<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&#39;带key的订单字符串&#39;</span><span class="token punctuation">,</span> stringifiedOrderWithKey<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token comment">//计算出签名</span></span>
<span class="line">    <span class="token keyword">const</span> sign <span class="token operator">=</span> crypto<span class="token punctuation">.</span><span class="token function">createHash</span><span class="token punctuation">(</span><span class="token string">&#39;md5&#39;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span>stringifiedOrderWithKey<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">digest</span><span class="token punctuation">(</span><span class="token string">&#39;hex&#39;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toUpperCase</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">return</span> sign<span class="token punctuation">;</span></span>
<span class="line">  <span class="token punctuation">}</span></span>
<span class="line">  <span class="token function">xml2js</span><span class="token punctuation">(</span><span class="token parameter">data<span class="token punctuation">,</span>logger</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">const</span> _result <span class="token operator">=</span> transformer<span class="token punctuation">.</span><span class="token function">xml2js</span><span class="token punctuation">(</span>data<span class="token punctuation">,</span> <span class="token punctuation">{</span></span>
<span class="line">      <span class="token literal-property property">compact</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span></span>
<span class="line">      <span class="token literal-property property">cdataKey</span><span class="token operator">:</span> <span class="token string">&#39;value&#39;</span><span class="token punctuation">,</span></span>
<span class="line">      <span class="token literal-property property">textKey</span><span class="token operator">:</span><span class="token string">&#39;value&#39;</span></span>
<span class="line">    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    logger<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&#39;_result&#39;</span><span class="token punctuation">,</span> _result<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">    <span class="token keyword">const</span> result <span class="token operator">=</span> Object<span class="token punctuation">.</span><span class="token function">entries</span><span class="token punctuation">(</span>_result<span class="token punctuation">.</span>xml<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">reduce</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">memo<span class="token punctuation">,</span> <span class="token punctuation">[</span>key<span class="token punctuation">,</span> value<span class="token punctuation">]</span></span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></span>
<span class="line">      memo<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token operator">=</span>value<span class="token punctuation">.</span>value<span class="token punctuation">;</span></span>
<span class="line">      <span class="token keyword">return</span> memo<span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    logger<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&#39;result&#39;</span><span class="token punctuation">,</span> result<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">return</span> result<span class="token punctuation">;</span></span>
<span class="line">  <span class="token punctuation">}</span></span>
<span class="line">  <span class="token keyword">async</span> <span class="token function">checkout</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">const</span> <span class="token punctuation">{</span></span>
<span class="line">      ctx<span class="token punctuation">,</span></span>
<span class="line">      app</span>
<span class="line">    <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">const</span> <span class="token punctuation">{</span></span>
<span class="line">      logger</span>
<span class="line">    <span class="token punctuation">}</span> <span class="token operator">=</span> ctx<span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">const</span> <span class="token punctuation">{</span></span>
<span class="line">      wxpay <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span></span>
<span class="line">    <span class="token punctuation">}</span> <span class="token operator">=</span> app<span class="token punctuation">.</span>config<span class="token punctuation">;</span></span>
<span class="line">    <span class="token comment">//公众账号ID</span></span>
<span class="line">    <span class="token keyword">const</span> appid <span class="token operator">=</span> wxpay<span class="token punctuation">.</span>appid<span class="token punctuation">;</span></span>
<span class="line">    <span class="token comment">//商户号码 商户平台(https://pay.weixin.qq.com)-&gt;产品中心-&gt;开发配置-&gt;商户信息-&gt;商户号</span></span>
<span class="line">    <span class="token comment">//APPID授权管理 商户平台(https://pay.weixin.qq.com)-&gt;产品中心-&gt;开发配置-&gt;商户信息-&gt;商户号</span></span>
<span class="line">    <span class="token keyword">const</span> mch_id <span class="token operator">=</span> wxpay<span class="token punctuation">.</span>mch_id<span class="token punctuation">;</span></span>
<span class="line">    <span class="token comment">//回调通知url</span></span>
<span class="line">    <span class="token keyword">const</span> notify_url <span class="token operator">=</span> wxpay<span class="token punctuation">.</span>notify_url<span class="token punctuation">;</span></span>
<span class="line">    <span class="token comment">//密钥</span></span>
<span class="line">    <span class="token keyword">const</span> key <span class="token operator">=</span> wxpay<span class="token punctuation">.</span>key<span class="token punctuation">;</span></span>
<span class="line">    <span class="token comment">//统一下单接口</span></span>
<span class="line">    <span class="token keyword">const</span> unifiedorder <span class="token operator">=</span> wxpay<span class="token punctuation">.</span>unifiedorder<span class="token punctuation">;</span></span>
<span class="line">    <span class="token comment">//商户订单号</span></span>
<span class="line">    <span class="token keyword">const</span> out_trade_no<span class="token operator">=</span><span class="token function">moment</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">local</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token string">&#39;YYYYMMDDhhmmss&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    ctx<span class="token punctuation">.</span>session<span class="token punctuation">.</span>out_trade_no<span class="token operator">=</span>out_trade_no<span class="token punctuation">;</span></span>
<span class="line">    <span class="token comment">//商品描述</span></span>
<span class="line">    <span class="token keyword">const</span> body <span class="token operator">=</span> <span class="token string">&#39;珠峰培训&#39;</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token comment">//商品价格</span></span>
<span class="line">    <span class="token keyword">const</span> total_fee <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token comment">//支付类型</span></span>
<span class="line">    <span class="token keyword">const</span> trade_type <span class="token operator">=</span> <span class="token string">&#39;NATIVE&#39;</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token comment">//商品ID</span></span>
<span class="line">    <span class="token keyword">const</span> product_id <span class="token operator">=</span> <span class="token number">100</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token comment">//随机字符串</span></span>
<span class="line">    <span class="token keyword">const</span> nonce_str <span class="token operator">=</span> randomstring<span class="token punctuation">.</span><span class="token function">generate</span><span class="token punctuation">(</span><span class="token number">32</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token comment">//构建订单  </span></span>
<span class="line">    <span class="token keyword">let</span> order <span class="token operator">=</span> <span class="token punctuation">{</span></span>
<span class="line">      appid<span class="token punctuation">,</span></span>
<span class="line">      mch_id<span class="token punctuation">,</span></span>
<span class="line">      out_trade_no<span class="token punctuation">,</span></span>
<span class="line">      body<span class="token punctuation">,</span></span>
<span class="line">      total_fee<span class="token punctuation">,</span></span>
<span class="line">      product_id<span class="token punctuation">,</span></span>
<span class="line">      notify_url<span class="token punctuation">,</span></span>
<span class="line">      nonce_str<span class="token punctuation">,</span></span>
<span class="line">      trade_type</span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    <span class="token keyword">const</span> sign <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">wxSign</span><span class="token punctuation">(</span>order<span class="token punctuation">,</span> key<span class="token punctuation">,</span>logger<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    logger<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&#39;签名&#39;</span><span class="token punctuation">,</span> sign<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token comment">//转换成XML格式    </span></span>
<span class="line">    <span class="token keyword">const</span> xmlOrder <span class="token operator">=</span> transformer<span class="token punctuation">.</span><span class="token function">js2xml</span><span class="token punctuation">(</span><span class="token punctuation">{</span></span>
<span class="line">      <span class="token literal-property property">xml</span><span class="token operator">:</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token operator">...</span>order<span class="token punctuation">,</span></span>
<span class="line">        sign</span>
<span class="line">      <span class="token punctuation">}</span></span>
<span class="line">    <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{</span></span>
<span class="line">      <span class="token literal-property property">compact</span><span class="token operator">:</span> <span class="token boolean">true</span></span>
<span class="line">    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    logger<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&#39;XML订单&#39;</span><span class="token punctuation">,</span> xmlOrder<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token comment">//请求统一下单接口</span></span>
<span class="line">    <span class="token keyword">const</span> unifiedorderResponse <span class="token operator">=</span> <span class="token keyword">await</span> axios<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span>unifiedorder<span class="token punctuation">,</span> xmlOrder<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    logger<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&#39;统一下单响应&#39;</span><span class="token punctuation">,</span> unifiedorderResponse<span class="token punctuation">.</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">const</span> prepay<span class="token operator">=</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">xml2js</span><span class="token punctuation">(</span>unifiedorderResponse<span class="token punctuation">.</span>data<span class="token punctuation">,</span>logger<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    logger<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&#39;prepay&#39;</span><span class="token punctuation">,</span> prepay<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">const</span> <span class="token punctuation">{</span></span>
<span class="line">      code_url</span>
<span class="line">    <span class="token punctuation">}</span> <span class="token operator">=</span> prepay<span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">const</span> qrcodeUrl <span class="token operator">=</span> <span class="token keyword">await</span> qrcode<span class="token punctuation">.</span><span class="token function">toDataURL</span><span class="token punctuation">(</span>code_url<span class="token punctuation">,</span> <span class="token punctuation">{</span></span>
<span class="line">      <span class="token literal-property property">width</span><span class="token operator">:</span> <span class="token number">300</span></span>
<span class="line">    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">await</span> ctx<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span><span class="token string">&#39;checkout&#39;</span><span class="token punctuation">,</span> <span class="token punctuation">{</span></span>
<span class="line">      qrcodeUrl</span>
<span class="line">    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">  <span class="token punctuation">}</span></span>
<span class="line">  <span class="token function">parseXML</span><span class="token punctuation">(</span><span class="token parameter">req</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">      <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span>reject</span><span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line">          <span class="token keyword">let</span> buffers <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span></span>
<span class="line">          req<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">&#39;data&#39;</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">data</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">              buffers<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">          <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">          req<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">&#39;end&#39;</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">              <span class="token keyword">let</span> ret <span class="token operator">=</span> Buffer<span class="token punctuation">.</span><span class="token function">concat</span><span class="token punctuation">(</span>buffers<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">              <span class="token function">resolve</span><span class="token punctuation">(</span>ret<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">          <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">  <span class="token punctuation">}</span></span>
<span class="line">  <span class="token keyword">async</span> <span class="token function">notify</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">const</span> <span class="token punctuation">{</span>ctx<span class="token punctuation">,</span>app<span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">;</span></span>
<span class="line">      <span class="token keyword">const</span> <span class="token punctuation">{</span> logger <span class="token punctuation">}</span> <span class="token operator">=</span> ctx<span class="token punctuation">;</span></span>
<span class="line">      <span class="token keyword">const</span> <span class="token punctuation">{</span></span>
<span class="line">        wxpay <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span></span>
<span class="line">      <span class="token punctuation">}</span> <span class="token operator">=</span> app<span class="token punctuation">.</span>config<span class="token punctuation">;</span></span>
<span class="line">      <span class="token keyword">const</span> key <span class="token operator">=</span> wxpay<span class="token punctuation">.</span>key<span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">let</span> body <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">parseXML</span><span class="token punctuation">(</span>ctx<span class="token punctuation">.</span>req<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    logger<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">&#39;request&#39;</span><span class="token punctuation">,</span>body<span class="token punctuation">)</span><span class="token punctuation">;</span>  </span>
<span class="line">    <span class="token keyword">const</span> payment<span class="token operator">=</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">xml2js</span><span class="token punctuation">(</span>body<span class="token punctuation">,</span>logger<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    logger<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&#39;payment&#39;</span><span class="token punctuation">,</span> payment<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">const</span> paymentSign <span class="token operator">=</span> payment<span class="token punctuation">.</span>sign<span class="token punctuation">;</span></span>
<span class="line">    logger<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">&#39;paymentSign&#39;</span><span class="token punctuation">,</span> paymentSign<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">delete</span> payment<span class="token punctuation">.</span>sign<span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">const</span> mySign <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">wxSign</span><span class="token punctuation">(</span>payment<span class="token punctuation">,</span> key<span class="token punctuation">,</span>logger<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    logger<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">&#39;mySign&#39;</span><span class="token punctuation">,</span> mySign<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">const</span> return_code <span class="token operator">=</span> paymentSign <span class="token operator">===</span> mySign <span class="token operator">?</span> <span class="token string">&#39;SUCCESS&#39;</span> <span class="token operator">:</span> <span class="token string">&quot;FAIL&quot;</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">const</span> reply <span class="token operator">=</span> <span class="token punctuation">{</span></span>
<span class="line">      <span class="token literal-property property">xml</span><span class="token operator">:</span> <span class="token punctuation">{</span></span>
<span class="line">        return_code</span>
<span class="line">      <span class="token punctuation">}</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    <span class="token keyword">const</span> ret <span class="token operator">=</span> transformer<span class="token punctuation">.</span><span class="token function">js2xml</span><span class="token punctuation">(</span>reply<span class="token punctuation">,</span> <span class="token punctuation">{</span></span>
<span class="line">      <span class="token literal-property property">compact</span><span class="token operator">:</span> <span class="token boolean">true</span></span>
<span class="line">    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    logger<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">&#39;通知返回&#39;</span><span class="token punctuation">,</span> ret<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    ctx<span class="token punctuation">.</span>body <span class="token operator">=</span> ret<span class="token punctuation">;</span></span>
<span class="line">  <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">  <span class="token keyword">async</span> <span class="token function">query</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">const</span> <span class="token punctuation">{</span></span>
<span class="line">      ctx<span class="token punctuation">,</span></span>
<span class="line">      app</span>
<span class="line">    <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">const</span> <span class="token punctuation">{</span></span>
<span class="line">      logger</span>
<span class="line">    <span class="token punctuation">}</span> <span class="token operator">=</span> ctx<span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">const</span> <span class="token punctuation">{</span></span>
<span class="line">      wxpay <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span></span>
<span class="line">    <span class="token punctuation">}</span> <span class="token operator">=</span> app<span class="token punctuation">.</span>config<span class="token punctuation">;</span></span>
<span class="line">    <span class="token comment">//公众账号ID</span></span>
<span class="line">    <span class="token keyword">const</span> appid <span class="token operator">=</span> wxpay<span class="token punctuation">.</span>appid<span class="token punctuation">;</span></span>
<span class="line">    <span class="token comment">//商户号码 </span></span>
<span class="line">    <span class="token keyword">const</span> mch_id <span class="token operator">=</span> wxpay<span class="token punctuation">.</span>mch_id<span class="token punctuation">;</span></span>
<span class="line">    <span class="token comment">//密钥</span></span>
<span class="line">    <span class="token keyword">const</span> key <span class="token operator">=</span> wxpay<span class="token punctuation">.</span>key<span class="token punctuation">;</span></span>
<span class="line">    <span class="token comment">//统一下单接口</span></span>
<span class="line">    <span class="token keyword">const</span> orderquery<span class="token operator">=</span>wxpay<span class="token punctuation">.</span>orderquery<span class="token punctuation">;</span></span>
<span class="line">    <span class="token comment">//随机字符串</span></span>
<span class="line">    <span class="token keyword">const</span> nonce_str <span class="token operator">=</span> randomstring<span class="token punctuation">.</span><span class="token function">generate</span><span class="token punctuation">(</span><span class="token number">32</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">let</span> query<span class="token operator">=</span><span class="token punctuation">{</span></span>
<span class="line">      appid<span class="token punctuation">,</span></span>
<span class="line">      mch_id<span class="token punctuation">,</span></span>
<span class="line">      <span class="token literal-property property">out_trade_no</span><span class="token operator">:</span> ctx<span class="token punctuation">.</span>session<span class="token punctuation">.</span>out_trade_no<span class="token punctuation">,</span></span>
<span class="line">      nonce_str</span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">    <span class="token keyword">let</span> sign<span class="token operator">=</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">wxSign</span><span class="token punctuation">(</span>query<span class="token punctuation">,</span>key<span class="token punctuation">,</span>logger<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    logger<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&#39;签名&#39;</span><span class="token punctuation">,</span> sign<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token comment">//转换成XML格式    </span></span>
<span class="line">    <span class="token keyword">const</span> xmlQuery <span class="token operator">=</span> transformer<span class="token punctuation">.</span><span class="token function">js2xml</span><span class="token punctuation">(</span><span class="token punctuation">{</span></span>
<span class="line">      <span class="token literal-property property">xml</span><span class="token operator">:</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token operator">...</span>query<span class="token punctuation">,</span></span>
<span class="line">        sign</span>
<span class="line">      <span class="token punctuation">}</span></span>
<span class="line">    <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{</span></span>
<span class="line">      <span class="token literal-property property">compact</span><span class="token operator">:</span> <span class="token boolean">true</span></span>
<span class="line">    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    logger<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&#39;XML查询条件&#39;</span><span class="token punctuation">,</span> xmlQuery<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token comment">//请求统一下单接口</span></span>
<span class="line">    <span class="token keyword">const</span> orderqueryResponse <span class="token operator">=</span> <span class="token keyword">await</span> axios<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span>orderquery<span class="token punctuation">,</span> xmlQuery<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    logger<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&#39;订单查询响应&#39;</span><span class="token punctuation">,</span>orderqueryResponse<span class="token punctuation">.</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">const</span> queryResult <span class="token operator">=</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">xml2js</span><span class="token punctuation">(</span>orderqueryResponse<span class="token punctuation">.</span>data<span class="token punctuation">,</span>logger<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    logger<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&#39;queryResult&#39;</span><span class="token punctuation">,</span>queryResult<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">await</span> ctx<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span><span class="token string">&#39;result&#39;</span><span class="token punctuation">,</span>queryResult<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">  <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line">module<span class="token punctuation">.</span>exports <span class="token operator">=</span> HomeController<span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="参考资料" tabindex="-1"><a class="header-anchor" href="#参考资料"><span>参考资料</span></a></h2><ul><li><a href="http://kf.qq.com/faq/170116AziqYV1701162eyAzA.html" target="_blank" rel="noopener noreferrer">扫码支付接入方法指引</a></li><li><a href="https://pay.weixin.qq.com" target="_blank" rel="noopener noreferrer">登录微信支付</a></li><li><a href="https://pay.weixin.qq.com/wiki/doc/api/index.html" target="_blank" rel="noopener noreferrer">微信支付WIKI</a></li><li><a href="http://kf.qq.com/product/weixinmp.html" target="_blank" rel="noopener noreferrer">微信帮助文档</a></li><li><a href="https://mp.weixin.qq.com" target="_blank" rel="noopener noreferrer">登录微信公众账号</a></li><li><a href="https://jz.fkw.com/blog/660" target="_blank" rel="noopener noreferrer">微信支付接入教程</a></li><li><a href="https://pay.weixin.qq.com/wiki/doc/api/native.php?chapter=9_1" target="_blank" rel="noopener noreferrer">统一下单API</a></li><li><a href="https://pay.weixin.qq.com/wiki/doc/api/native.php?chapter=9_2" target="_blank" rel="noopener noreferrer">查询订单API</a></li><li><a href="https://www.npmjs.com/package/xml-js" target="_blank" rel="noopener noreferrer">xml-js</a></li></ul>`,71)])])}const i=s(e,[["render",o]]),u=JSON.parse('{"path":"/strong/48.wxpay.html","title":"","lang":"en-US","frontmatter":{},"git":{"updatedTime":1681290319000,"contributors":[{"name":"yutao","username":"yutao","email":"642231346@qq.com","commits":1,"url":"https://github.com/yutao"}],"changelog":[{"hash":"f5ab8c9d34991ec274f7f652439afe5b2afb6147","time":1681290319000,"email":"642231346@qq.com","author":"yutao","message":"modify"}]},"filePathRelative":"strong/48.wxpay.md"}');export{i as comp,u as data};
