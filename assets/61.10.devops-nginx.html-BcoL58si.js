import{_ as n,c as e,a,o as t}from"./app-CD1YpnS1.js";const l={};function i(p,s){return t(),e("div",null,[...s[0]||(s[0]=[a(`<h2 id="_1-nginx应用场景" tabindex="-1"><a class="header-anchor" href="#_1-nginx应用场景"><span>1.nginx应用场景</span></a></h2><ul><li>静态资源服务器</li><li>反向代理服务</li><li>API接口服务(Lua&amp;Javascript)</li></ul><p><img src="http://img.zhufengpeixun.cn/nginx2.jpg" alt="nginx2"></p><h2 id="_2-nginx优势" tabindex="-1"><a class="header-anchor" href="#_2-nginx优势"><span>2.nginx优势</span></a></h2><ul><li>高并发高性能</li><li>可扩展性好</li><li>高可靠性</li><li>热布署</li><li>开源许可证</li></ul><h2 id="_3-学习环境" tabindex="-1"><a class="header-anchor" href="#_3-学习环境"><span>3. 学习环境</span></a></h2><h3 id="_3-1-操作系统" tabindex="-1"><a class="header-anchor" href="#_3-1-操作系统"><span>3.1 操作系统</span></a></h3><p><a href="http://59.80.44.49/isoredirect.centos.org/centos/7/isos/x86_64/CentOS-7-x86_64-DVD-1810.iso" target="_blank" rel="noopener noreferrer">centos764位</a></p><h3 id="_3-2-环境确认" tabindex="-1"><a class="header-anchor" href="#_3-2-环境确认"><span>3.2 环境确认</span></a></h3><h4 id="_3-2-1-启用网卡" tabindex="-1"><a class="header-anchor" href="#_3-2-1-启用网卡"><span>3.2.1 启用网卡</span></a></h4><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text"><pre><code class="language-text"><span class="line">vi /etc/sysconfig/network-scripts/ifcfg-ens33</span>
<span class="line">ONBOOT=yes 是否随网络服务启动，ens33生效</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_3-2-2-关闭防火墙" tabindex="-1"><a class="header-anchor" href="#_3-2-2-关闭防火墙"><span>3.2.2 关闭防火墙</span></a></h4><table><thead><tr><th style="text-align:left;">功能</th><th style="text-align:left;">命令</th></tr></thead><tbody><tr><td style="text-align:left;">停止防火墙</td><td style="text-align:left;">systemctl stop firewalld.service</td></tr><tr><td style="text-align:left;">永久关闭防火墙</td><td style="text-align:left;">systemctl disable firewalld.service</td></tr></tbody></table><h4 id="_3-2-3-确认停用-selinux" tabindex="-1"><a class="header-anchor" href="#_3-2-3-确认停用-selinux"><span>3.2.3 确认停用 selinux</span></a></h4><ul><li>安全增强型 Linux（Security-Enhanced Linux）简称 SELinux，它是一个 Linux 内核模块，也是 Linux 的一个安全子系统。</li><li>SELinux 主要作用就是最大限度地减小系统中服务进程可访问的资源（最小权限原则）。</li></ul><table><thead><tr><th style="text-align:left;">功能</th><th style="text-align:left;">命令</th></tr></thead><tbody><tr><td style="text-align:left;">检查状态</td><td style="text-align:left;">getenforce</td></tr><tr><td style="text-align:left;">检查状态</td><td style="text-align:left;">/usr/sbin/sestatus -v</td></tr><tr><td style="text-align:left;">临时关闭</td><td style="text-align:left;">setenforce 0</td></tr><tr><td style="text-align:left;">永久关闭</td><td style="text-align:left;">/etc/selinux/config SELINUX=<code>enforcing</code> 改为SELINUX=<code>disabled</code></td></tr></tbody></table><h4 id="_3-2-4-安装依赖模块" tabindex="-1"><a class="header-anchor" href="#_3-2-4-安装依赖模块"><span>3.2.4 安装依赖模块</span></a></h4><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text"><pre><code class="language-text"><span class="line">yum  -y install gcc gcc-c++ autoconf pcre pcre-devel make automake</span>
<span class="line">yum  -y install wget httpd-tools vim</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div></div></div><table><thead><tr><th style="text-align:left;">软件包</th><th style="text-align:left;">描述</th></tr></thead><tbody><tr><td style="text-align:left;">gcc</td><td style="text-align:left;">gcc是指整个gcc的这一套工具集合，它分为gcc前端和gcc后端（我个人理解为gcc外壳和gcc引擎），gcc前端对应各种特定语言（如c++/go等）的处理（对c++/go等特定语言进行对应的语法检查, 将c++/go等语言的代码转化为c代码等），gcc后端对应把前端的c代码转为跟你的电脑硬件相关的汇编或机器码</td></tr><tr><td style="text-align:left;">gcc-c++</td><td style="text-align:left;">而就软件程序包而言，gcc.rpm就是那个gcc后端，而gcc-c++.rpm就是针对c++这个特定语言的gcc前端</td></tr><tr><td style="text-align:left;">autoconf</td><td style="text-align:left;">autoconf是一个软件包，以适应多种Unix类系统的shell脚本的工具</td></tr><tr><td style="text-align:left;">pcre</td><td style="text-align:left;">PCRE(Perl Compatible Regular Expressions)是一个Perl库，包括 perl 兼容的正则表达式库</td></tr><tr><td style="text-align:left;">pcre-devel</td><td style="text-align:left;">devel 包主要是供开发用,包含头文件和链接库</td></tr><tr><td style="text-align:left;">make</td><td style="text-align:left;">常指一条计算机指令，是在安装有GNU Make的计算机上的可执行指令。该指令是读入一个名为makefile的文件，然后执行这个文件中指定的指令</td></tr><tr><td style="text-align:left;">automake</td><td style="text-align:left;">automake可以用来帮助我们自动地生成符合自由软件惯例的Makefile</td></tr><tr><td style="text-align:left;">wget</td><td style="text-align:left;">wget 是一个从网络上自动下载文件的自由工具，支持通过 HTTP、HTTPS、FTP 三个最常见的 TCP/IP协议 下载，并可以使用 HTTP 代理</td></tr><tr><td style="text-align:left;">httpd-tools</td><td style="text-align:left;">apace压力测试</td></tr><tr><td style="text-align:left;">vim</td><td style="text-align:left;">Vim是一个类似于Vi的著名的功能强大、高度可定制的文本编辑器</td></tr></tbody></table><p>|目录名| |:---|:---| |app|存放代码和应用| |backup|存放备份的文件| |download|下载下来的代码和安装包| |logs|放日志的| |work|工作目录|</p><h2 id="_4-nginx的架构" tabindex="-1"><a class="header-anchor" href="#_4-nginx的架构"><span>4. nginx的架构</span></a></h2><h3 id="_4-1-轻量" tabindex="-1"><a class="header-anchor" href="#_4-1-轻量"><span>4.1 轻量</span></a></h3><ul><li>源代码只包含核心模块</li><li>其它非核心功能都是通过模块实现，可以自由选择</li></ul><h3 id="_4-2-架构" tabindex="-1"><a class="header-anchor" href="#_4-2-架构"><span>4.2 架构</span></a></h3><ul><li>Nginx 采用的是多进程(单线程)和多路IO复用模型</li></ul><h4 id="_4-2-1-工作流程" tabindex="-1"><a class="header-anchor" href="#_4-2-1-工作流程"><span>4.2.1 工作流程</span></a></h4><ol><li>Nginx 在启动后，会有一个 <code>master</code> 进程和多个相互独立的 <code>worker</code> 进程。</li><li>接收来自外界的信号,向各<code>worker</code>进程发送信号,每个进程都有可能来处理这个连接。</li><li>master 进程能监控 worker 进程的运行状态，当 worker 进程退出后(异常情况下)，会自动启动新的 worker 进程。</li></ol><p><img src="http://img.zhufengpeixun.cn/nginxcomplex.png" alt="nginx架构"></p><ul><li>worker 进程数，一般会设置成机器 cpu 核数。因为更多的worker 数，只会导致进程相互竞争 cpu，从而带来不必要的上下文切换</li><li>使用多进程模式，不仅能提高并发率，而且进程之间相互独立，一个 worker 进程挂了不会影响到其他 worker 进程</li></ul><h4 id="_4-2-2-io多路复用" tabindex="-1"><a class="header-anchor" href="#_4-2-2-io多路复用"><span>4.2.2 IO多路复用</span></a></h4><ul><li>多个文件描述符的IO操作都能在一个线程里并发交替顺序完成，复用线程</li></ul><p><img src="http://img.zhufengpeixun.cn/iomulti.jpg" alt="iomulti"></p><h4 id="_4-2-3-cpu亲和" tabindex="-1"><a class="header-anchor" href="#_4-2-3-cpu亲和"><span>4.2.3 CPU亲和</span></a></h4><ul><li>把CPU内核和nginx的工作进程绑定在一起，让每个worker进程固定在一个CPU上执行，从而减少CPU的切换并提高缓存命中率，提高 性能</li></ul><h4 id="_4-2-4-sendfile" tabindex="-1"><a class="header-anchor" href="#_4-2-4-sendfile"><span>4.2.4 sendfile</span></a></h4><ul><li>sendfile 零拷贝传输模式</li></ul><p><img src="http://img.zhufengpeixun.cn/sendfile.jpg" alt="sendfile"></p><h2 id="_5-nginx安装" tabindex="-1"><a class="header-anchor" href="#_5-nginx安装"><span>5. nginx安装</span></a></h2><h3 id="_5-1-版本分类" tabindex="-1"><a class="header-anchor" href="#_5-1-版本分类"><span>5.1 版本分类</span></a></h3><ul><li>Mainline version 开发版</li><li>Stable version 稳定版</li><li>Legacy versions 历史版本</li></ul><h3 id="_5-2-下载地址" tabindex="-1"><a class="header-anchor" href="#_5-2-下载地址"><span>5.2 下载地址</span></a></h3><ul><li><a href="http://nginx.org/en/download.html" target="_blank" rel="noopener noreferrer">nginx</a></li><li>[linux_packages](http://nginx.org/en/linux_packages.html</li></ul><h3 id="_5-3-centos下yum安装" tabindex="-1"><a class="header-anchor" href="#_5-3-centos下yum安装"><span>5.3 CentOS下YUM安装</span></a></h3><p>vi /etc/yum.repos.d/nginx.repo</p><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code class="language-javascript"><span class="line"><span class="token punctuation">[</span>nginx<span class="token punctuation">]</span></span>
<span class="line">name<span class="token operator">=</span>nginx repo</span>
<span class="line">baseurl<span class="token operator">=</span>http<span class="token operator">:</span><span class="token operator">/</span><span class="token operator">/</span>nginx<span class="token punctuation">.</span>org<span class="token operator">/</span>packages<span class="token operator">/</span>centos<span class="token operator">/</span><span class="token number">7</span><span class="token operator">/</span>$basearch<span class="token operator">/</span></span>
<span class="line">gpgcheck<span class="token operator">=</span><span class="token number">0</span></span>
<span class="line">enabled<span class="token operator">=</span><span class="token number">1</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text"><pre><code class="language-text"><span class="line">yum install nginx -y 安装nginx</span>
<span class="line">nginx -v 查看安装的版本</span>
<span class="line">nginx -V 查看编译时的参数</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="_6-目录" tabindex="-1"><a class="header-anchor" href="#_6-目录"><span>6. 目录</span></a></h2><h3 id="_6-1-安装目录" tabindex="-1"><a class="header-anchor" href="#_6-1-安装目录"><span>6.1 安装目录</span></a></h3><p>查看nginx安装的配置文件和目录</p><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text"><pre><code class="language-text"><span class="line">rpm -ql nginx</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><h3 id="_6-2-日志切割文件" tabindex="-1"><a class="header-anchor" href="#_6-2-日志切割文件"><span>6.2 日志切割文件</span></a></h3><p>/etc/logrotate.d/nginx</p><ul><li>对访问日志进行切割<div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code class="language-javascript"><span class="line"><span class="token operator">/</span><span class="token keyword">var</span><span class="token operator">/</span>log<span class="token operator">/</span>nginx<span class="token comment">/*.log {</span>
<span class="line">      daily</span>
<span class="line">}</span>
<span class="line"></span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></li></ul><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code class="language-javascript"><span class="line">ls <span class="token operator">/</span><span class="token keyword">var</span><span class="token operator">/</span>log<span class="token operator">/</span>nginx<span class="token comment">/*.log </span>
<span class="line">/var/log/nginx/access.log  /var/log/nginx/error.log</span>
<span class="line"></span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_6-3-主配置文件" tabindex="-1"><a class="header-anchor" href="#_6-3-主配置文件"><span>6.3 主配置文件</span></a></h3><table><thead><tr><th style="text-align:left;">路径</th><th style="text-align:left;">用途</th></tr></thead><tbody><tr><td style="text-align:left;">/etc/nginx/nginx.conf</td><td style="text-align:left;">核心配置文件</td></tr><tr><td style="text-align:left;">/etc/nginx/conf.d/default.conf</td><td style="text-align:left;">默认http服务器配置文件</td></tr></tbody></table><h3 id="_6-4-cgi配置" tabindex="-1"><a class="header-anchor" href="#_6-4-cgi配置"><span>6.4 cgi配置</span></a></h3><ul><li>CGI是common gateway interface(通用网关接口)</li><li>Web Server 通过cgi协议可以把动态的请求传递给如php、jsp、python和perl等应用程序</li><li>FastCGI 实际上是增加了一些扩展功能的 CGI ,是 CGI 的改进，描述了客户端和Web服务器程序之间传输数据的一种标准。</li><li>SCGI协议是一个CGI（通用网关接口）协议的替代品· 它是一个应用与HTTP服务器的接口标准，类似于FastCGI,但是它设计得更为容易实现</li><li>uwsgi是一个Web服务器，它实现了WSGI协议、uwsgi、http等协议</li></ul><p><img src="http://img.zhufengpeixun.cn/fastcgi.png" alt="fastcgi"></p><table><thead><tr><th style="text-align:left;">路径</th><th style="text-align:left;">用途</th></tr></thead><tbody><tr><td style="text-align:left;">/etc/nginx/fastcgi_params</td><td style="text-align:left;">fastcgi配置</td></tr><tr><td style="text-align:left;">/etc/nginx/scgi_params</td><td style="text-align:left;">scgi配置</td></tr><tr><td style="text-align:left;">/etc/nginx/uwsgi_params</td><td style="text-align:left;">uwsgi配置</td></tr></tbody></table><h3 id="_6-5-编码转换映射转化文件" tabindex="-1"><a class="header-anchor" href="#_6-5-编码转换映射转化文件"><span>6.5 编码转换映射转化文件</span></a></h3><ul><li>这三个文件都是与编码转换映射文件，用于在输出内容到客户端时，将一种编码转换到另一种编码</li><li><code>koi8-r</code>是斯拉夫文字8位元编码，供俄语及保加利亚语使用。在Unicode未流行之前，KOI8-R 是最为广泛使用的俄语编码，使用率甚至起ISO/IEC 8859-5还高。这3个文件存在是因为作者是俄国人的原因。</li></ul><table><thead><tr><th style="text-align:left;">路径</th><th style="text-align:left;">用途</th></tr></thead><tbody><tr><td style="text-align:left;">/etc/nginx/koi-utf</td><td style="text-align:left;">koi8-r &lt;--&gt; utf-8</td></tr><tr><td style="text-align:left;">/etc/nginx/koi-win</td><td style="text-align:left;">koi8-r &lt;--&gt; windows-1251</td></tr><tr><td style="text-align:left;">/etc/nginx/win-utf</td><td style="text-align:left;">windows-1251 &lt; -- &gt; utf-8</td></tr></tbody></table><h3 id="_6-6-扩展名文件" tabindex="-1"><a class="header-anchor" href="#_6-6-扩展名文件"><span>6.6 扩展名文件</span></a></h3><p>/etc/nginx/mime.types</p><table><thead><tr><th style="text-align:left;">路径</th><th style="text-align:left;">用途</th></tr></thead><tbody><tr><td style="text-align:left;">配置文件</td><td style="text-align:left;">/etc/nginx/mime.types</td></tr></tbody></table><h3 id="_6-7-守护进程管理" tabindex="-1"><a class="header-anchor" href="#_6-7-守护进程管理"><span>6.7 守护进程管理</span></a></h3><ul><li>用于配置系统守护进程管理器管理方式</li></ul><table><thead><tr><th style="text-align:left;">路径</th><th style="text-align:left;">用途</th></tr></thead><tbody><tr><td style="text-align:left;">/usr/lib/systemd/system/nginx-debug.service</td><td style="text-align:left;"></td></tr><tr><td style="text-align:left;">/usr/lib/systemd/system/nginx.service</td><td style="text-align:left;"></td></tr><tr><td style="text-align:left;">/etc/sysconfig/nginx</td><td style="text-align:left;"></td></tr><tr><td style="text-align:left;">/etc/sysconfig/nginx-debug</td><td style="text-align:left;"></td></tr></tbody></table><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text"><pre><code class="language-text"><span class="line">systemctl restart nginx.service</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><h3 id="_6-8-nginx模块目录" tabindex="-1"><a class="header-anchor" href="#_6-8-nginx模块目录"><span>6.8 nginx模块目录</span></a></h3><ul><li>nginx安装的模块</li></ul><table><thead><tr><th style="text-align:left;">路径</th><th style="text-align:left;">用途</th></tr></thead><tbody><tr><td style="text-align:left;">/etc/nginx/modules</td><td style="text-align:left;">最基本的共享库和内核模块,</td></tr></tbody></table><p>目的是存放用于启动系统和执行root文件系统的命令的如<code>/bin</code>和<code>/sbin</code>的二进制文件的共享库，或者存放32位，或者64位(file命令查看)| | /usr/lib64/nginx/modules |64位共享库|</p><h3 id="_6-9-文档" tabindex="-1"><a class="header-anchor" href="#_6-9-文档"><span>6.9 文档</span></a></h3><ul><li>nginx的手册和帮助文件</li></ul><table><thead><tr><th style="text-align:left;">路径</th><th style="text-align:left;">用途</th></tr></thead><tbody><tr><td style="text-align:left;">/usr/share/doc/nginx-1.14.2</td><td style="text-align:left;">帮助文档</td></tr><tr><td style="text-align:left;">/usr/share/doc/nginx-1.14.0/COPYRIGHT</td><td style="text-align:left;">版权声明</td></tr><tr><td style="text-align:left;">/usr/share/man/man8/nginx.8.gz</td><td style="text-align:left;">手册</td></tr></tbody></table><h3 id="_6-10-缓存目录" tabindex="-1"><a class="header-anchor" href="#_6-10-缓存目录"><span>6.10 缓存目录</span></a></h3><table><thead><tr><th style="text-align:left;">路径</th><th style="text-align:left;">用途</th></tr></thead><tbody><tr><td style="text-align:left;">/var/cache/nginx</td><td style="text-align:left;">nginx的缓存目录</td></tr></tbody></table><h3 id="_6-11-日志目录" tabindex="-1"><a class="header-anchor" href="#_6-11-日志目录"><span>6.11 日志目录</span></a></h3><table><thead><tr><th style="text-align:left;">路径</th><th style="text-align:left;">用途</th></tr></thead><tbody><tr><td style="text-align:left;">/var/log/nginx</td><td style="text-align:left;">nginx的日志目录</td></tr></tbody></table><h3 id="_6-12-可执行命令" tabindex="-1"><a class="header-anchor" href="#_6-12-可执行命令"><span>6.12 可执行命令</span></a></h3><ul><li>nginx服务的启动管理的可执行文件</li></ul><table><thead><tr><th style="text-align:left;">路径</th><th style="text-align:left;">用途</th></tr></thead><tbody><tr><td style="text-align:left;">/usr/sbin/nginx</td><td style="text-align:left;">可执行命令</td></tr><tr><td style="text-align:left;">/usr/sbin/nginx-debug</td><td style="text-align:left;">调试执行可执行命令</td></tr></tbody></table><h2 id="_7-编译参数" tabindex="-1"><a class="header-anchor" href="#_7-编译参数"><span>7. 编译参数</span></a></h2><h3 id="_7-1-安装目录和路径" tabindex="-1"><a class="header-anchor" href="#_7-1-安装目录和路径"><span>7.1 安装目录和路径</span></a></h3><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text"><pre><code class="language-text"><span class="line"> --prefix=/etc/nginx </span>
<span class="line"> --sbin-path=/usr/sbin/nginx </span>
<span class="line"> --modules-path=/usr/lib64/nginx/modules </span>
<span class="line"> --conf-path=/etc/nginx/nginx.conf  </span>
<span class="line"> --error-log-path=/var/log/nginx/error.log  </span>
<span class="line"> --http-log-path=/var/log/nginx/access.log  </span>
<span class="line"> --pid-path=/var/run/nginx.pid </span>
<span class="line"> --lock-path=/var/run/nginx.lock </span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_7-2-临时性文件" tabindex="-1"><a class="header-anchor" href="#_7-2-临时性文件"><span>7.2 临时性文件</span></a></h3><ul><li>执行对应模块时nginx所保留的临时性文件</li></ul><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text"><pre><code class="language-text"><span class="line"> --http-client-body-temp-path=/var/cache/nginx/client_temp </span>
<span class="line"> --http-proxy-temp-path=/var/cache/nginx/proxy_temp </span>
<span class="line">--http-fastcgi-temp-path=/var/cache/nginx/fastcgi_temp </span>
<span class="line">--http-uwsgi-temp-path=/var/cache/nginx/uwsgi_temp </span>
<span class="line">--http-scgi-temp-path=/var/cache/nginx/scgi_temp </span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_7-3-指定用户" tabindex="-1"><a class="header-anchor" href="#_7-3-指定用户"><span>7.3 指定用户</span></a></h3><ul><li>设置nginx进程启动的用户和用户组</li></ul><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text"><pre><code class="language-text"><span class="line"> --user=nginx   </span>
<span class="line"> --group=nginx  </span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_7-4-设置额外参数" tabindex="-1"><a class="header-anchor" href="#_7-4-设置额外参数"><span>7.4 设置额外参数</span></a></h3><ul><li>设置额外的参数将被添加到<code>CFLAGS</code>变量</li><li><code>CFLAGS</code>变量用来存放C语言编译时的优化参数</li></ul><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text"><pre><code class="language-text"><span class="line">--with-cc-opt=&#39;-O2 -g -pipe -Wall -Wp,-D_FORTIFY_SOURCE=2 -fexceptions -fstack-protector-strong </span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><h3 id="_7-5-设置链接文件参数" tabindex="-1"><a class="header-anchor" href="#_7-5-设置链接文件参数"><span>7.5 设置链接文件参数</span></a></h3><ul><li>定义要传递到C链接器命令行的其他选项</li><li>PCRE库，需要指定–with-ld-opt=&quot;-L /usr/local/lib&quot;</li></ul><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code class="language-javascript"><span class="line"><span class="token operator">--</span><span class="token keyword">with</span><span class="token operator">-</span>ld<span class="token operator">-</span>opt<span class="token operator">=</span><span class="token string">&#39;-Wl,-z,relro -Wl,-z,now -pie&#39;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><h3 id="_7-6-其它参数" tabindex="-1"><a class="header-anchor" href="#_7-6-其它参数"><span>7.6 其它参数</span></a></h3><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text"><pre><code class="language-text"><span class="line">--with-compat </span>
<span class="line">--with-file-aio </span>
<span class="line">--with-threads </span>
<span class="line">--with-http_addition_module </span>
<span class="line">--with-http_auth_request_module </span>
<span class="line">--with-http_dav_module </span>
<span class="line">--with-http_flv_module </span>
<span class="line">--with-http_gunzip_module </span>
<span class="line">--with-http_gzip_static_module </span>
<span class="line">--with-http_mp4_module </span>
<span class="line">--with-http_random_index_module </span>
<span class="line">--with-http_realip_module </span>
<span class="line">--with-http_secure_link_module </span>
<span class="line">--with-http_slice_module </span>
<span class="line">--with-http_ssl_module </span>
<span class="line">--with-http_stub_status_module </span>
<span class="line">--with-http_sub_module </span>
<span class="line">--with-http_v2_module </span>
<span class="line">--with-mail </span>
<span class="line">--with-mail_ssl_module </span>
<span class="line">--with-stream </span>
<span class="line">--with-stream_realip_module </span>
<span class="line">--with-stream_ssl_module </span>
<span class="line">--with-stream_ssl_preread_module </span>
<span class="line">--param=ssp-buffer-size=4 -grecord-gcc-switches -m64 -mtune=generic -fPIC&#39; </span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="_8-配置文件" tabindex="-1"><a class="header-anchor" href="#_8-配置文件"><span>8. 配置文件</span></a></h2><ul><li>/etc/nginx/nginx.conf</li><li>/etc/nginx/conf.d/*.conf</li><li>/etc/nginx/conf.d/default.conf</li></ul><h3 id="_8-1-nginx配置语法" tabindex="-1"><a class="header-anchor" href="#_8-1-nginx配置语法"><span>8.1 nginx配置语法</span></a></h3><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text"><pre><code class="language-text"><span class="line"> # 使用</span>
<span class="line"> </span>
<span class="line">http {</span>
<span class="line"> </span>
<span class="line">    include       mime.types;</span>
<span class="line"> </span>
<span class="line">    default_type  application/octet-stream;</span>
<span class="line">    sendfile        on;</span>
<span class="line">    keepalive_timeout  65;</span>
<span class="line">    server {</span>
<span class="line">        listen       80;</span>
<span class="line">        server_name  localhost;</span>
<span class="line"> </span>
<span class="line">        location / {</span>
<span class="line">            root   html;</span>
<span class="line">            index  index.html index.htm;</span>
<span class="line">        }</span>
<span class="line">        error_page   500 502 503 504  /50x.html;</span>
<span class="line">        location = /50x.html {</span>
<span class="line">            root   html;</span>
<span class="line">        }</span>
<span class="line">    }</span>
<span class="line">}</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_8-2-全局配置" tabindex="-1"><a class="header-anchor" href="#_8-2-全局配置"><span>8.2 全局配置</span></a></h3><table><thead><tr><th style="text-align:left;">分类</th><th style="text-align:left;">配置项</th><th style="text-align:left;">作用</th></tr></thead><tbody><tr><td style="text-align:left;">全局</td><td style="text-align:left;">user</td><td style="text-align:left;">设置nginx服务的系统使用用户</td></tr><tr><td style="text-align:left;">全局</td><td style="text-align:left;">worker_processes</td><td style="text-align:left;">工作进程数,一般和CPU数量相同</td></tr><tr><td style="text-align:left;">全局</td><td style="text-align:left;">error_log</td><td style="text-align:left;">nginx的错误日志</td></tr><tr><td style="text-align:left;">全局</td><td style="text-align:left;">pid</td><td style="text-align:left;">nginx服务启动时的pid</td></tr></tbody></table><h3 id="_8-3-事件配置" tabindex="-1"><a class="header-anchor" href="#_8-3-事件配置"><span>8.3 事件配置</span></a></h3><table><thead><tr><th style="text-align:left;">分类</th><th style="text-align:left;">配置项</th><th style="text-align:left;">作用</th></tr></thead><tbody><tr><td style="text-align:left;">events</td><td style="text-align:left;">worker_connections</td><td style="text-align:left;">每个进程允许的最大连接数 10000</td></tr><tr><td style="text-align:left;">events</td><td style="text-align:left;">use</td><td style="text-align:left;">指定使用哪种模型(select/poll/epoll),建议让nginx自动选择,linux内核2.6以上一般能使用epoll可以提高性能</td></tr></tbody></table><h3 id="_8-4-http配置" tabindex="-1"><a class="header-anchor" href="#_8-4-http配置"><span>8.4 http配置</span></a></h3><ul><li>/etc/nginx/nginx.conf</li><li>一个HTTP下面可以配置多个server</li></ul><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text"><pre><code class="language-text"><span class="line">user  nginx;   设置nginx服务的系统使用用户  </span>
<span class="line">worker_processes  1;  工作进程数,一般和CPU数量相同 </span>
<span class="line"></span>
<span class="line">error_log  /var/log/nginx/error.log warn;   nginx的错误日志  </span>
<span class="line">pid        /var/run/nginx.pid;   nginx服务启动时的pid</span>
<span class="line"></span>
<span class="line">events {</span>
<span class="line">    worker_connections  1024;每个进程允许的最大连接数 10000</span>
<span class="line">}</span>
<span class="line"></span>
<span class="line">http {</span>
<span class="line">    include       /etc/nginx/mime.types;//文件后缀和类型类型的对应关系</span>
<span class="line">    default_type  application/octet-stream;//默认content-type</span>
<span class="line"></span>
<span class="line">    log_format  main  &#39;$remote_addr - $remote_user [$time_local] &quot;$request&quot; &#39;</span>
<span class="line">                      &#39;$status $body_bytes_sent &quot;$http_referer&quot; &#39;</span>
<span class="line">                      &#39;&quot;$http_user_agent&quot; &quot;$http_x_forwarded_for&quot;&#39;;  //日志记录格式</span>
<span class="line"></span>
<span class="line">    access_log  /var/log/nginx/access.log  main;//默认访问日志</span>
<span class="line"></span>
<span class="line">    sendfile        on;//启用sendfile</span>
<span class="line">     </span>
<span class="line"></span>
<span class="line">    keepalive_timeout  65;//超时时间是65秒</span>
<span class="line"></span>
<span class="line">     #gzip  on; </span>
<span class="line"></span>
<span class="line">    include /etc/nginx/conf.d/*.conf;//包含的子配置文件</span>
<span class="line">}</span>
<span class="line"></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_8-5-server" tabindex="-1"><a class="header-anchor" href="#_8-5-server"><span>8.5 server</span></a></h3><ul><li>/etc/nginx/conf.d/default.conf</li><li>一个server下面可以配置多个<code>location</code></li></ul><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text"><pre><code class="language-text"><span class="line">server {</span>
<span class="line">    listen       80;  //监听的端口号</span>
<span class="line">    server_name  localhost;  //用域名方式访问的地址</span>
<span class="line"></span>
<span class="line">     </span>
<span class="line">     </span>
<span class="line"></span>
<span class="line">    location / {</span>
<span class="line">        root   /usr/share/nginx/html;  //静态文件根目录</span>
<span class="line">        index  index.html index.htm;  //首页的索引文件</span>
<span class="line">    }</span>
<span class="line"></span>
<span class="line">     </span>
<span class="line"></span>
<span class="line">     </span>
<span class="line">     </span>
<span class="line">    error_page   500 502 503 504  /50x.html; </span>
<span class="line">    location = /50x.html {</span>
<span class="line">        root   /usr/share/nginx/html;</span>
<span class="line">    }</span>
<span class="line"></span>
<span class="line">     </span>
<span class="line">     </span>
<span class="line">     </span>
<span class="line">     </span>
<span class="line">     </span>
<span class="line"></span>
<span class="line">     </span>
<span class="line">     </span>
<span class="line">     </span>
<span class="line">     </span>
<span class="line">     </span>
<span class="line">     </span>
<span class="line">     </span>
<span class="line">     </span>
<span class="line">     </span>
<span class="line"></span>
<span class="line">     </span>
<span class="line">     </span>
<span class="line">     </span>
<span class="line">     </span>
<span class="line">     </span>
<span class="line">     </span>
<span class="line">}</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_8-6-systemd" tabindex="-1"><a class="header-anchor" href="#_8-6-systemd"><span>8.6 Systemd</span></a></h3><ul><li>系统启动和服务器守护进程管理器，负责在系统启动或运行时，激活系统资源，服务器进程和其他进程，根据管理，字母d是守护进程（daemon）的缩写</li></ul><h4 id="_8-6-1-配置目录" tabindex="-1"><a class="header-anchor" href="#_8-6-1-配置目录"><span>8.6.1 配置目录</span></a></h4><table><thead><tr><th style="text-align:left;">配置目录</th><th style="text-align:left;">用途</th></tr></thead><tbody><tr><td style="text-align:left;">/usr/lib/systemd/system</td><td style="text-align:left;">每个服务最主要的启动脚本设置，类似于之前的/etc/initd.d</td></tr><tr><td style="text-align:left;">/run/system/system</td><td style="text-align:left;">系统执行过程中所产生的服务脚本，比上面的目录优先运行</td></tr><tr><td style="text-align:left;">/etc/system/system</td><td style="text-align:left;">管理员建立的执行脚本，类似于/etc/rc.d/rcN.d/Sxx类的功能，比上面目录优先运行，在三者之中，此目录优先级最高</td></tr></tbody></table><h4 id="_8-6-2-systemctl" tabindex="-1"><a class="header-anchor" href="#_8-6-2-systemctl"><span>8.6.2 systemctl</span></a></h4><ul><li>监视和控制systemd的主要命令是systemctl</li><li>该命令可用于查看系统状态和管理系统及服务</li></ul><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text"><pre><code class="language-text"><span class="line">命令：systemctl  command name.service</span>
<span class="line">启动：service name start –&gt;systemctl start name.service</span>
<span class="line">停止：service name stop –&gt;systemctl stop name.service</span>
<span class="line">重启：service name restart–&gt;systemctl restart name.service</span>
<span class="line">状态：service name status–&gt;systemctl status name.service</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_8-7-启动和重新加载" tabindex="-1"><a class="header-anchor" href="#_8-7-启动和重新加载"><span>8.7 启动和重新加载</span></a></h3><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text"><pre><code class="language-text"><span class="line">systemctl restart nginx.service</span>
<span class="line">systemctl reload nginx.service</span>
<span class="line">nginx -s reload</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_8-8-日志类型" tabindex="-1"><a class="header-anchor" href="#_8-8-日志类型"><span>8.8 日志类型</span></a></h3><ul><li>curl -v <a href="http://localhost" target="_blank" rel="noopener noreferrer">http://localhost</a></li></ul><h4 id="_8-8-1-日志类型" tabindex="-1"><a class="header-anchor" href="#_8-8-1-日志类型"><span>8.8.1 日志类型</span></a></h4><ul><li>/var/log/nginx/access.log 访问日志</li><li>/var/log/nginx/error.log 错误日志</li></ul><h4 id="_8-8-2-log-format" tabindex="-1"><a class="header-anchor" href="#_8-8-2-log-format"><span>8.8.2 log_format</span></a></h4><table><thead><tr><th style="text-align:left;">类型</th><th style="text-align:left;">用法</th></tr></thead><tbody><tr><td style="text-align:left;">语法</td><td style="text-align:left;">log_format name [escape=default[json] string]</td></tr><tr><td style="text-align:left;">默认</td><td style="text-align:left;">log_format combined &quot; &quot;</td></tr><tr><td style="text-align:left;">Context</td><td style="text-align:left;">http</td></tr></tbody></table><h5 id="_8-8-2-1-内置变量" tabindex="-1"><a class="header-anchor" href="#_8-8-2-1-内置变量"><span>8.8.2.1 内置变量</span></a></h5><p><a href="http://nginx.org/en/docs/http/ngx_http_log_module.html" target="_blank" rel="noopener noreferrer">ngx_http_log_module</a> [log_format](http://nginx.org/en/docs/http/ngx_http_log_module.html</p><table><thead><tr><th style="text-align:left;">名称</th><th style="text-align:left;">含义</th></tr></thead><tbody><tr><td style="text-align:left;">$remote_addr</td><td style="text-align:left;">客户端地址</td></tr><tr><td style="text-align:left;">$remote_user</td><td style="text-align:left;">客户端用户名称</td></tr><tr><td style="text-align:left;">$time_local</td><td style="text-align:left;">访问时间和时区</td></tr><tr><td style="text-align:left;">$request</td><td style="text-align:left;">请求行</td></tr><tr><td style="text-align:left;">$status</td><td style="text-align:left;">HTTP请求状态</td></tr><tr><td style="text-align:left;">$body_bytes_sent</td><td style="text-align:left;">发送给客户端文件内容大小</td></tr></tbody></table><h5 id="_8-8-2-2-http请求变量" tabindex="-1"><a class="header-anchor" href="#_8-8-2-2-http请求变量"><span>8.8.2.2 HTTP请求变量</span></a></h5><ul><li>注意要把<code>-</code>转成下划线,比如<code>User-Agent</code>对应于<code>$http_user_agent</code></li></ul><table><thead><tr><th style="text-align:left;">名称</th><th style="text-align:left;">含义</th><th style="text-align:left;">例子</th></tr></thead><tbody><tr><td style="text-align:left;">arg_PARAMETER</td><td style="text-align:left;">请求参数</td><td style="text-align:left;">$arg_name</td></tr><tr><td style="text-align:left;">http_HEADER</td><td style="text-align:left;">请求头</td><td style="text-align:left;">$http_referer $http_host $http_user_agent $http_x_forwarded_for(代理过程)</td></tr><tr><td style="text-align:left;">sent_http_HEADER</td><td style="text-align:left;">响应头</td><td style="text-align:left;">sent_http_cookie</td></tr></tbody></table><blockquote><p>IP1-&gt;IP2(代理)-&gt;IP3 会记录IP地址的代理过程</p><ul><li>http_x_forwarded_for=Client IP,Proxy(1) IP,Proxy(2) IP</li></ul></blockquote><h4 id="_8-8-3-示例" tabindex="-1"><a class="header-anchor" href="#_8-8-3-示例"><span>8.8.3 示例</span></a></h4><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text"><pre><code class="language-text"><span class="line">  </span>
<span class="line"> log_format  main  &#39;$remote_addr - $remote_user [$time_local] &quot;$request&quot; &#39;</span>
<span class="line">                      &#39;$status $body_bytes_sent &quot;$http_referer&quot; &#39;</span>
<span class="line">                      &#39;&quot;$http_user_agent&quot; &quot;$http_x_forwarded_for&quot;&#39;;</span>
<span class="line"></span>
<span class="line"> log_format  zfpx  &#39;$arg_name $http_referer sent_http_date&quot;&#39;;</span>
<span class="line">  </span>
<span class="line"> access_log  /var/log/nginx/access.log  main;    </span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code class="language-javascript"><span class="line">tail <span class="token operator">-</span>f <span class="token operator">/</span><span class="token keyword">var</span><span class="token operator">/</span>log<span class="token operator">/</span>nginx<span class="token operator">/</span>access<span class="token punctuation">.</span>log</span>
<span class="line"></span>
<span class="line"><span class="token number">221.216</span><span class="token number">.143</span><span class="token number">.110</span> <span class="token operator">-</span> <span class="token operator">-</span> <span class="token punctuation">[</span><span class="token number">09</span><span class="token operator">/</span>Jun<span class="token operator">/</span><span class="token number">2018</span><span class="token operator">:</span><span class="token number">22</span><span class="token operator">:</span><span class="token number">41</span><span class="token operator">:</span><span class="token number">18</span> <span class="token operator">+</span><span class="token number">0800</span><span class="token punctuation">]</span> <span class="token string">&quot;GET / HTTP/1.1&quot;</span> <span class="token number">200</span> <span class="token number">612</span> <span class="token string">&quot;-&quot;</span> <span class="token string">&quot;Mozilla/5.0 (Windows NT 6.1; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/62.0.3202.94 Safari/537.36&quot;</span> <span class="token string">&quot;-&quot;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="_9-核心模块" tabindex="-1"><a class="header-anchor" href="#_9-核心模块"><span>9. 核心模块</span></a></h2><h3 id="_9-1-监控nginx客户端的状态" tabindex="-1"><a class="header-anchor" href="#_9-1-监控nginx客户端的状态"><span>9.1 监控nginx客户端的状态</span></a></h3><h4 id="_9-1-1-模块名" tabindex="-1"><a class="header-anchor" href="#_9-1-1-模块名"><span>9.1.1 模块名</span></a></h4><ul><li>--with-http_stub_status_module 监控nginx客户端的状态</li></ul><h4 id="_9-1-2-语法" tabindex="-1"><a class="header-anchor" href="#_9-1-2-语法"><span>9.1.2 语法</span></a></h4><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text"><pre><code class="language-text"><span class="line">Syntax: stub_status on/off;</span>
<span class="line">Default: -</span>
<span class="line">Context: server-&gt;location</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_9-1-3-实战" tabindex="-1"><a class="header-anchor" href="#_9-1-3-实战"><span>9.1.3 实战</span></a></h4><p>/etc/nginx/conf.d/default.conf</p><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text"><pre><code class="language-text"><span class="line">server {</span>
<span class="line">+    location /status{</span>
<span class="line">+       stub_status  on;</span>
<span class="line">+    }</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code class="language-javascript"><span class="line">systemctl reload nginx<span class="token punctuation">.</span>service</span>
<span class="line"></span>
<span class="line"><span class="token literal-property property">http</span><span class="token operator">:</span><span class="token operator">/</span><span class="token operator">/</span><span class="token number">192.171</span><span class="token number">.207</span><span class="token number">.104</span><span class="token operator">/</span>status</span>
<span class="line"></span>
<span class="line">Active connections<span class="token operator">:</span> <span class="token number">2</span>            </span>
<span class="line">server accepts handled requests  </span>
<span class="line"> <span class="token number">3</span> <span class="token number">3</span> <span class="token number">10</span> </span>
<span class="line"><span class="token literal-property property">Reading</span><span class="token operator">:</span> <span class="token number">0</span> <span class="token literal-property property">Writing</span><span class="token operator">:</span> <span class="token number">1</span> <span class="token literal-property property">Waiting</span><span class="token operator">:</span> <span class="token number">1</span> </span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><table><thead><tr><th style="text-align:left;">参数</th><th style="text-align:left;">含义</th></tr></thead><tbody><tr><td style="text-align:left;">Active connections</td><td style="text-align:left;">当前nginx正在处理的活动连接数</td></tr><tr><td style="text-align:left;">accepts</td><td style="text-align:left;">总共处理的连接数</td></tr><tr><td style="text-align:left;">handled</td><td style="text-align:left;">成功创建握手数</td></tr><tr><td style="text-align:left;">requests</td><td style="text-align:left;">总共处理请求数</td></tr><tr><td style="text-align:left;">Reading</td><td style="text-align:left;">读取到客户端的Header信息数</td></tr><tr><td style="text-align:left;">Writing</td><td style="text-align:left;">返回给客户端的Header信息数</td></tr><tr><td style="text-align:left;">Waiting</td><td style="text-align:left;">开启keep-alive的情况下,这个值等于 active – (reading + writing)</td></tr></tbody></table><h3 id="_9-2-随机主页" tabindex="-1"><a class="header-anchor" href="#_9-2-随机主页"><span>9.2 随机主页</span></a></h3><h4 id="_9-2-1-模块名" tabindex="-1"><a class="header-anchor" href="#_9-2-1-模块名"><span>9.2.1 模块名</span></a></h4><ul><li>--with-http_random_index_module 在根目录里随机选择一个主页显示</li></ul><h4 id="_9-2-2-语法" tabindex="-1"><a class="header-anchor" href="#_9-2-2-语法"><span>9.2.2 语法</span></a></h4><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text"><pre><code class="language-text"><span class="line">Syntax: random_index on/off;</span>
<span class="line">Default: off</span>
<span class="line">Context: location</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_9-2-3-实战" tabindex="-1"><a class="header-anchor" href="#_9-2-3-实战"><span>9.2.3 实战</span></a></h4><p>/etc/nginx/conf.d/default.conf</p><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text"><pre><code class="language-text"><span class="line">+    location / {</span>
<span class="line">+       root /opt/app;</span>
<span class="line">+       random_index on;</span>
<span class="line">+    }</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_9-3-内容替换" tabindex="-1"><a class="header-anchor" href="#_9-3-内容替换"><span>9.3 内容替换</span></a></h3><h4 id="_9-3-1-模块名" tabindex="-1"><a class="header-anchor" href="#_9-3-1-模块名"><span>9.3.1 模块名</span></a></h4><ul><li>--with-http_sub_module 内容替换</li></ul><h4 id="_9-3-2-语法" tabindex="-1"><a class="header-anchor" href="#_9-3-2-语法"><span>9.3.2 语法</span></a></h4><h5 id="_9-3-2-1-文本替换" tabindex="-1"><a class="header-anchor" href="#_9-3-2-1-文本替换"><span>9.3.2.1 文本替换</span></a></h5><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text"><pre><code class="language-text"><span class="line">Syntax: sub_filter string replacement;</span>
<span class="line">Default: --</span>
<span class="line">Context: http,service,location</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h5 id="_9-3-2-2-只匹配一次" tabindex="-1"><a class="header-anchor" href="#_9-3-2-2-只匹配一次"><span>9.3.2.2 只匹配一次</span></a></h5><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text"><pre><code class="language-text"><span class="line">Syntax: sub_filter_once on|off;</span>
<span class="line">Default: off</span>
<span class="line">Context: http,service,location</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_9-3-3-实战" tabindex="-1"><a class="header-anchor" href="#_9-3-3-实战"><span>9.3.3 实战</span></a></h4><p>/etc/nginx/conf.d/default.conf</p><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text"><pre><code class="language-text"><span class="line">location / {</span>
<span class="line">        root   /usr/share/nginx/html;</span>
<span class="line">        index  index.html index.htm;</span>
<span class="line">+        sub_filter &#39;world&#39; &#39;zhufeng&#39;;</span>
<span class="line">+        sub_filter_once off;</span>
<span class="line">    }</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_9-4-请求限制" tabindex="-1"><a class="header-anchor" href="#_9-4-请求限制"><span>9.4 请求限制</span></a></h3><h4 id="_9-4-1-模块名" tabindex="-1"><a class="header-anchor" href="#_9-4-1-模块名"><span>9.4.1 模块名</span></a></h4><ul><li>--with-limit_conn_module 连接频率限制</li><li>--with-limit_req_module 请求频率限制</li><li>一次TCP请求至少产生一个HTTP请求</li><li>SYN &gt; SYN,ACK-&gt;ACK-&gt;REQUEST-&gt;RESPONSE-&gt;FIN-&gt;ACK-&gt;FIN-&gt;ACK</li></ul><h4 id="_9-4-2-ab" tabindex="-1"><a class="header-anchor" href="#_9-4-2-ab"><span>9.4.2 ab</span></a></h4><ul><li>Apache的ab命令模拟多线程并发请求，测试服务器负载压力，也可以测试nginx、lighthttp、IIS等其它Web服务器的压力 <ul><li>-n 总共的请求数</li><li>-c 并发的请求数</li></ul></li></ul><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code class="language-javascript"><span class="line">ab <span class="token operator">-</span>n <span class="token number">40</span> <span class="token operator">-</span>c <span class="token number">20</span> <span class="token literal-property property">http</span><span class="token operator">:</span><span class="token operator">/</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">127.0.0.1</span><span class="token regex-delimiter">/</span></span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><h4 id="_9-4-3-请求限制" tabindex="-1"><a class="header-anchor" href="#_9-4-3-请求限制"><span>9.4.3 请求限制</span></a></h4><h5 id="_9-4-3-1-语法" tabindex="-1"><a class="header-anchor" href="#_9-4-3-1-语法"><span>9.4.3.1 语法</span></a></h5><p>limit_req_zone</p><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text"><pre><code class="language-text"><span class="line"> </span>
<span class="line">Syntax: limit_req_zone key zone=name:size rate=rate;   </span>
<span class="line">Default: --</span>
<span class="line">Context: http(定义在server以外)</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>limit_req</p><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text"><pre><code class="language-text"><span class="line"> </span>
<span class="line">Syntax: limit_req  zone=name [burst=number] [nodelay];</span>
<span class="line">Default: --</span>
<span class="line">Context: http,server,location</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h5 id="_9-4-3-2-案例" tabindex="-1"><a class="header-anchor" href="#_9-4-3-2-案例"><span>9.4.3.2 案例</span></a></h5><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text"><pre><code class="language-text"><span class="line">limit_req_zone $binary_remote_addr zone=req_zone:1m rate=1r/s;</span>
<span class="line">server {</span>
<span class="line">  location /{</span>
<span class="line">      limit_req req_zone;</span>
<span class="line">       </span>
<span class="line">      limit_req zone=req_zone burst=3 nodelay;</span>
<span class="line">  }</span>
<span class="line">}</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li><p>$binary_remote_addr 表示远程的IP地址</p></li><li><p>zone=req_zone:10m 表示一个内存区域大小为10m,并且设定了名称为<code>req_zone</code></p></li><li><p>rate=1r/s 表示请求的速率是1秒1个请求</p></li><li><p>zone=req_zone 表示这个参数对应的全局设置就是req_zone的那个内存区域</p></li><li><p>burst=3 表示请求队列的长度</p></li><li><p>nodelay 表示不延时</p></li></ul><h4 id="_9-4-4-连接限制" tabindex="-1"><a class="header-anchor" href="#_9-4-4-连接限制"><span>9.4.4 连接限制</span></a></h4><h5 id="_9-4-4-1-语法" tabindex="-1"><a class="header-anchor" href="#_9-4-4-1-语法"><span>9.4.4.1 语法</span></a></h5><p>limit_conn_zone</p><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text"><pre><code class="language-text"><span class="line"> </span>
<span class="line">Syntax: limit_conn_zone key zone=name:size;   </span>
<span class="line">Default: --</span>
<span class="line">Context: http(定义在server以外)</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>limit_conn</p><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text"><pre><code class="language-text"><span class="line"> </span>
<span class="line">Syntax: limit_conn  zone number;</span>
<span class="line">Default: --</span>
<span class="line">Context: http,server,location</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h5 id="_9-4-4-2-案例" tabindex="-1"><a class="header-anchor" href="#_9-4-4-2-案例"><span>9.4.4.2 案例</span></a></h5><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code class="language-javascript"><span class="line">limit_conn_zone $binanry_remote_addr zone<span class="token operator">=</span>conn_zone<span class="token operator">:</span>1m<span class="token punctuation">;</span></span>
<span class="line">server <span class="token punctuation">{</span></span>
<span class="line">  location <span class="token operator">/</span><span class="token punctuation">{</span></span>
<span class="line">      limit_conn conn_zone <span class="token number">1</span><span class="token punctuation">;</span></span>
<span class="line">  <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li>表明以ip为key，来限制每个ip访问文件时候，最多只能有一个在线，否则其余的都要返回不可用</li></ul><h3 id="_9-5-访问控制" tabindex="-1"><a class="header-anchor" href="#_9-5-访问控制"><span>9.5 访问控制</span></a></h3><ul><li>基于IP的访问控制 -http_access_module</li><li>基于用户的信任登录 -http_auth_basic_module</li></ul><h4 id="_9-5-1-http-access-module" tabindex="-1"><a class="header-anchor" href="#_9-5-1-http-access-module"><span>9.5.1 http_access_module</span></a></h4><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text"><pre><code class="language-text"><span class="line">Syntax: allow address|all;</span>
<span class="line">Default: --</span>
<span class="line">Context: http,server,location,limit_except</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text"><pre><code class="language-text"><span class="line">Syntax: deny address|CIDR|all;</span>
<span class="line">Default: --</span>
<span class="line">Context: http,server,location,limit_except</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text"><pre><code class="language-text"><span class="line">server {</span>
<span class="line">+ location ~ ^/admin.html{</span>
<span class="line">+      deny 192.171.207.100;</span>
<span class="line">+      allow all;</span>
<span class="line">+    }</span>
<span class="line">}    </span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text"><pre><code class="language-text"><span class="line">server {</span>
<span class="line">+ location ~ ^/admin.html{</span>
<span class="line">+    if ($http_x_forwarded_for !~* &quot;^8\\.8\\.8\\.8&quot;) {</span>
<span class="line">+       return 403;</span>
<span class="line">+    }</span>
<span class="line">}    </span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><table><thead><tr><th style="text-align:left;">符号</th><th style="text-align:left;">含义</th></tr></thead><tbody><tr><td style="text-align:left;">=</td><td style="text-align:left;">严格匹配。如果这个查询匹配，那么将停止搜索并立即处理此请求。</td></tr><tr><td style="text-align:left;">~</td><td style="text-align:left;">为区分大小写匹配(可用正则表达式)</td></tr><tr><td style="text-align:left;">!~</td><td style="text-align:left;">为区分大小写不匹配</td></tr><tr><td style="text-align:left;">~*</td><td style="text-align:left;">为不区分大小写匹配(可用正则表达式)</td></tr><tr><td style="text-align:left;">!~*</td><td style="text-align:left;">为不区分大小写不匹配</td></tr><tr><td style="text-align:left;">^~</td><td style="text-align:left;">如果把这个前缀用于一个常规字符串,那么告诉nginx 如果路径匹配那么不测试正则表达式。</td></tr></tbody></table><h4 id="_9-5-2-http-auth-basic-module" tabindex="-1"><a class="header-anchor" href="#_9-5-2-http-auth-basic-module"><span>9.5.2 http_auth_basic_module</span></a></h4><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text"><pre><code class="language-text"><span class="line">Syntax: auth_basic string|off;</span>
<span class="line">Default: auth_basic off;</span>
<span class="line">Context: http,server,location,limit_except</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text"><pre><code class="language-text"><span class="line">Syntax: auth_basic_user_file file;</span>
<span class="line">Default: -;</span>
<span class="line">Context: http,server,location,limit_except</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text"><pre><code class="language-text"><span class="line">htpasswd -c /etc/nginx/users.conf zhangsan</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text"><pre><code class="language-text"><span class="line">server {</span>
<span class="line">+    auth_basic &#39;请登录&#39;;</span>
<span class="line">+    auth_basic_user_file /etc/nginx/users.conf;</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="_10-静态资源web服务" tabindex="-1"><a class="header-anchor" href="#_10-静态资源web服务"><span>10 静态资源Web服务</span></a></h2><h3 id="_10-1-静态和动态资源" tabindex="-1"><a class="header-anchor" href="#_10-1-静态和动态资源"><span>10.1 静态和动态资源</span></a></h3><ul><li>静态资源：一般客户端发送请求到web服务器，web服务器从内存在取到相应的文件，返回给客户端，客户端解析并渲染显示出来。</li><li>动态资源：一般客户端请求的动态资源，先将请求交于web容器，web容器连接数据库，数据库处理数据之后，将内容交给web服务器，web服务器返回给客户端解析渲染处理。</li></ul><table><thead><tr><th style="text-align:left;">类型</th><th style="text-align:left;">种类</th></tr></thead><tbody><tr><td style="text-align:left;">浏览器渲染</td><td style="text-align:left;">HTML、CSS、JS</td></tr><tr><td style="text-align:left;">图片</td><td style="text-align:left;">JPEG、GIF、PNG</td></tr><tr><td style="text-align:left;">视频</td><td style="text-align:left;">FLV、MPEG</td></tr><tr><td style="text-align:left;">下载文件</td><td style="text-align:left;">Word、Excel</td></tr></tbody></table><h3 id="_10-2-cdn" tabindex="-1"><a class="header-anchor" href="#_10-2-cdn"><span>10.2 CDN</span></a></h3><ul><li>CDN的全称是Content Delivery Network，即内容分发网络。</li><li>CDN系统能够实时地根据网络流量和各节点的连接、负载状况以及到用户的距离和响应时间等综合信息将用户的请求重新导向离用户最近的服务节点上。其目的是使用户可就近取得所需内容，解决 Internet网络拥挤的状况，提高用户访问网站的响应速度。</li></ul><p><a href="http://img.zhufengpeixun.cn/cdn.jpg" target="_blank" rel="noopener noreferrer">cdn</a></p><h3 id="_10-3-配置语法" tabindex="-1"><a class="header-anchor" href="#_10-3-配置语法"><span>10.3 配置语法</span></a></h3><h4 id="_10-3-1-sendfile" tabindex="-1"><a class="header-anchor" href="#_10-3-1-sendfile"><span>10.3.1 sendfile</span></a></h4><ul><li>不经过用户内核发送文件</li></ul><table><thead><tr><th style="text-align:left;">类型</th><th style="text-align:left;">种类</th></tr></thead><tbody><tr><td style="text-align:left;">语法</td><td style="text-align:left;">sendfile on / off</td></tr><tr><td style="text-align:left;">默认</td><td style="text-align:left;">sendfile off;</td></tr><tr><td style="text-align:left;">上下文</td><td style="text-align:left;">http,server,location,if in location</td></tr></tbody></table><h4 id="_10-3-2-tcp-nopush" tabindex="-1"><a class="header-anchor" href="#_10-3-2-tcp-nopush"><span>10.3.2 tcp_nopush</span></a></h4><ul><li>在sendfile开启的情况下，合并多个数据包，提高网络包的传输效率</li></ul><table><thead><tr><th style="text-align:left;">类型</th><th style="text-align:left;">种类</th></tr></thead><tbody><tr><td style="text-align:left;">语法</td><td style="text-align:left;">tcp_nopush on / off</td></tr><tr><td style="text-align:left;">默认</td><td style="text-align:left;">tcp_nopush off;</td></tr><tr><td style="text-align:left;">上下文</td><td style="text-align:left;">http,server,location</td></tr></tbody></table><h4 id="_10-3-3-tcp-nodelay" tabindex="-1"><a class="header-anchor" href="#_10-3-3-tcp-nodelay"><span>10.3.3 tcp_nodelay</span></a></h4><ul><li>在keepalive连接下，提高网络包的传输实时性</li></ul><table><thead><tr><th style="text-align:left;">类型</th><th style="text-align:left;">种类</th></tr></thead><tbody><tr><td style="text-align:left;">语法</td><td style="text-align:left;">tcp_nodelay on / off</td></tr><tr><td style="text-align:left;">默认</td><td style="text-align:left;">tcp_nodelay on;</td></tr><tr><td style="text-align:left;">上下文</td><td style="text-align:left;">http,server,location</td></tr></tbody></table><h4 id="_10-3-4-gzip" tabindex="-1"><a class="header-anchor" href="#_10-3-4-gzip"><span>10.3.4 gzip</span></a></h4><ul><li>压缩文件可以节约带宽和提高网络传输效率</li></ul><table><thead><tr><th style="text-align:left;">类型</th><th style="text-align:left;">种类</th></tr></thead><tbody><tr><td style="text-align:left;">语法</td><td style="text-align:left;">gzip on / off</td></tr><tr><td style="text-align:left;">默认</td><td style="text-align:left;">gzip off;</td></tr><tr><td style="text-align:left;">上下文</td><td style="text-align:left;">http,server,location</td></tr></tbody></table><h4 id="_10-3-5-gzip-comp-level" tabindex="-1"><a class="header-anchor" href="#_10-3-5-gzip-comp-level"><span>10.3.5 gzip_comp_level</span></a></h4><ul><li>压缩比率越高，文件被压缩的体积越小</li></ul><table><thead><tr><th style="text-align:left;">类型</th><th style="text-align:left;">种类</th></tr></thead><tbody><tr><td style="text-align:left;">语法</td><td style="text-align:left;">gzip_comp_level level</td></tr><tr><td style="text-align:left;">默认</td><td style="text-align:left;">gzip_comp_level 1;</td></tr><tr><td style="text-align:left;">上下文</td><td style="text-align:left;">http,server,location</td></tr></tbody></table><h4 id="_10-3-6-gzip-http-version" tabindex="-1"><a class="header-anchor" href="#_10-3-6-gzip-http-version"><span>10.3.6 gzip_http_version</span></a></h4><ul><li>压缩版本</li></ul><table><thead><tr><th style="text-align:left;">类型</th><th style="text-align:left;">种类</th></tr></thead><tbody><tr><td style="text-align:left;">语法</td><td style="text-align:left;">gzip_http_version 1.0/1.1</td></tr><tr><td style="text-align:left;">默认</td><td style="text-align:left;">gzip_http_version 1.1;</td></tr><tr><td style="text-align:left;">上下文</td><td style="text-align:left;">http,server,location</td></tr></tbody></table><h4 id="_10-3-7-http-gzip-static-module" tabindex="-1"><a class="header-anchor" href="#_10-3-7-http-gzip-static-module"><span>10.3.7 http_gzip-static_module</span></a></h4><ul><li>先找磁盘上找同名的<code>.gz</code>这个文件是否存在,节约CPU的压缩时间和性能损耗</li><li>http_gzip_static_module 预计gzip模块</li><li>http_gunzip_module 应用支持gunzip的压缩方式</li></ul><table><thead><tr><th style="text-align:left;">类型</th><th style="text-align:left;">种类</th></tr></thead><tbody><tr><td style="text-align:left;">语法</td><td style="text-align:left;">gzip_static on/off</td></tr><tr><td style="text-align:left;">默认</td><td style="text-align:left;">gzip_static off;</td></tr><tr><td style="text-align:left;">上下文</td><td style="text-align:left;">http,server,location</td></tr></tbody></table><h4 id="_10-3-8-案例" tabindex="-1"><a class="header-anchor" href="#_10-3-8-案例"><span>10.3.8 案例</span></a></h4><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text"><pre><code class="language-text"><span class="line">gzip index.txt</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p>/etc/nginx/conf.d/default.conf</p><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text"><pre><code class="language-text"><span class="line">    location ~ .*\\.(jpg|png|gif)$ {</span>
<span class="line">         gzip off;</span>
<span class="line">        root /data/www/images;</span>
<span class="line">    }</span>
<span class="line"></span>
<span class="line">    location ~ .*\\.(html|js|css)$ {</span>
<span class="line">         gzip on; </span>
<span class="line">         gzip_min_length 1k;    </span>
<span class="line">         gzip_http_version 1.1; </span>
<span class="line">         gzip_comp_level 9;     </span>
<span class="line">         gzip_types  text/css application/javascript;</span>
<span class="line">        root /data/www/html;</span>
<span class="line">    }</span>
<span class="line"></span>
<span class="line">    location ~ ^/download {</span>
<span class="line">         gzip_static on; </span>
<span class="line">         tcp_nopush on;  </span>
<span class="line">         root /data/www; </span>
<span class="line">    } </span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="_11-浏览器缓存" tabindex="-1"><a class="header-anchor" href="#_11-浏览器缓存"><span>11. 浏览器缓存</span></a></h2><ul><li>校验本地缓存是否过期</li></ul><p><img src="http://img.zhufengpeixun.cn/cachecontrol.png" alt="cachecontrol"></p><table><thead><tr><th style="text-align:left;">类型</th><th style="text-align:left;">种类</th></tr></thead><tbody><tr><td style="text-align:left;">检验是否过期</td><td style="text-align:left;">Expires、Cache-Control(max-age)</td></tr><tr><td style="text-align:left;">Etag</td><td style="text-align:left;">Etag</td></tr><tr><td style="text-align:left;">Last-Modified</td><td style="text-align:left;">Last-Modified</td></tr></tbody></table><h3 id="_11-1-expires" tabindex="-1"><a class="header-anchor" href="#_11-1-expires"><span>11.1 expires</span></a></h3><ul><li>添加Cache-Control、Expires头</li></ul><table><thead><tr><th style="text-align:left;">类型</th><th style="text-align:left;">种类</th></tr></thead><tbody><tr><td style="text-align:left;">语法</td><td style="text-align:left;">expires time</td></tr><tr><td style="text-align:left;">默认</td><td style="text-align:left;">expires off;</td></tr><tr><td style="text-align:left;">上下文</td><td style="text-align:left;">http,server,location</td></tr></tbody></table><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code class="language-javascript"><span class="line">location <span class="token operator">~</span> <span class="token punctuation">.</span><span class="token operator">*</span>\\<span class="token punctuation">.</span><span class="token punctuation">(</span>jpg<span class="token operator">|</span>png<span class="token operator">|</span>gif<span class="token punctuation">)</span>$ <span class="token punctuation">{</span></span>
<span class="line">    expires 24h<span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="_12-跨域" tabindex="-1"><a class="header-anchor" href="#_12-跨域"><span>12. 跨域</span></a></h2><ul><li>跨域是指一个域下的文档或脚本试图去请求另一个域下的资源</li></ul><table><thead><tr><th style="text-align:left;">类型</th><th style="text-align:left;">种类</th></tr></thead><tbody><tr><td style="text-align:left;">语法</td><td style="text-align:left;">add_header name value</td></tr><tr><td style="text-align:left;">默认</td><td style="text-align:left;">add_header --;</td></tr><tr><td style="text-align:left;">上下文</td><td style="text-align:left;">http,server,location</td></tr></tbody></table><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code class="language-javascript"><span class="line"><span class="token literal-property property">https</span><span class="token operator">:</span><span class="token operator">/</span><span class="token operator">/</span>github<span class="token punctuation">.</span>com<span class="token operator">/</span>creationix<span class="token operator">/</span>nvm</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code class="language-javascript"><span class="line">location <span class="token operator">~</span> <span class="token punctuation">.</span><span class="token operator">*</span>\\<span class="token punctuation">.</span>json$ <span class="token punctuation">{</span></span>
<span class="line">        add_header Access<span class="token operator">-</span>Control<span class="token operator">-</span>Allow<span class="token operator">-</span>Origin http<span class="token operator">:</span><span class="token operator">/</span><span class="token operator">/</span>localhost<span class="token operator">:</span><span class="token number">3000</span><span class="token punctuation">;</span></span>
<span class="line">        add_header Access<span class="token operator">-</span>Control<span class="token operator">-</span>Allow<span class="token operator">-</span>Methods <span class="token constant">GET</span><span class="token punctuation">,</span><span class="token constant">POST</span><span class="token punctuation">,</span><span class="token constant">PUT</span><span class="token punctuation">,</span><span class="token constant">DELETE</span><span class="token punctuation">,</span><span class="token constant">OPTIONS</span><span class="token punctuation">;</span></span>
<span class="line">        root <span class="token operator">/</span>data<span class="token operator">/</span>json<span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code class="language-javascript"><span class="line"><span class="token keyword">let</span> xhr <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">XMLHttpRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        xhr<span class="token punctuation">.</span><span class="token function">open</span><span class="token punctuation">(</span><span class="token string">&#39;GET&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;http://47.104.184.134/users.json&#39;</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        xhr<span class="token punctuation">.</span><span class="token function-variable function">onreadystatechange</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token keyword">if</span> <span class="token punctuation">(</span>xhr<span class="token punctuation">.</span>readyState <span class="token operator">==</span> <span class="token number">4</span> <span class="token operator">&amp;&amp;</span> xhr<span class="token punctuation">.</span>status <span class="token operator">==</span> <span class="token number">200</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">                console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>xhr<span class="token punctuation">.</span>responseText<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">            <span class="token punctuation">}</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">xhr<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="_13-防盗链" tabindex="-1"><a class="header-anchor" href="#_13-防盗链"><span>13. 防盗链</span></a></h2><ul><li><p>防止网站资源被盗用</p></li><li><p>保证信息安全</p></li><li><p>防止流量过量</p></li><li><p>需要区别哪些请求是非正常的用户请求</p></li><li><p>使用<code>http_refer</code>防盗链</p></li></ul><table><thead><tr><th style="text-align:left;">类型</th><th style="text-align:left;">种类</th></tr></thead><tbody><tr><td style="text-align:left;">语法</td><td style="text-align:left;">valid_referers none、block、server_names、IP</td></tr><tr><td style="text-align:left;">默认</td><td style="text-align:left;">-</td></tr><tr><td style="text-align:left;">上下文</td><td style="text-align:left;">server,location</td></tr></tbody></table><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text"><pre><code class="language-text"><span class="line">location ~ .*\\.(jpg|png|gif)$ {</span>
<span class="line">        expires 1h;</span>
<span class="line">        gzip off;</span>
<span class="line">        gzip_http_version 1.1;</span>
<span class="line">        gzip_comp_level 3;</span>
<span class="line">        gzip_types image/jpeg image/png image/gif;</span>
<span class="line">         </span>
<span class="line">+       valid_referers none blocked 47.104.184.134;</span>
<span class="line"> +       if ($invalid_referer) { </span>
<span class="line">+           return 403;</span>
<span class="line">+       }</span>
<span class="line">        root /data/images;</span>
<span class="line">    }</span>
<span class="line"></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code class="language-javascript"><span class="line"><span class="token operator">-</span>e<span class="token punctuation">,</span> <span class="token operator">--</span>referer       Referer <span class="token constant">URL</span> <span class="token punctuation">(</span><span class="token constant">H</span><span class="token punctuation">)</span></span>
<span class="line">curl <span class="token operator">-</span>e <span class="token string">&quot;http://www.baidu.com&quot;</span> <span class="token literal-property property">http</span><span class="token operator">:</span><span class="token operator">/</span><span class="token operator">/</span><span class="token number">192.171</span><span class="token number">.207</span><span class="token number">.104</span><span class="token operator">/</span>girl<span class="token punctuation">.</span>jpg</span>
<span class="line">curl <span class="token operator">-</span>e <span class="token string">&quot;192.171.207.100&quot;</span> <span class="token literal-property property">http</span><span class="token operator">:</span><span class="token operator">/</span><span class="token operator">/</span><span class="token number">192.171</span><span class="token number">.207</span><span class="token number">.104</span><span class="token operator">/</span>girl<span class="token punctuation">.</span>jpg</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="_14-代理服务" tabindex="-1"><a class="header-anchor" href="#_14-代理服务"><span>14. 代理服务</span></a></h2><h3 id="_14-1-配置" tabindex="-1"><a class="header-anchor" href="#_14-1-配置"><span>14.1 配置</span></a></h3><table><thead><tr><th style="text-align:left;">类型</th><th style="text-align:left;">种类</th></tr></thead><tbody><tr><td style="text-align:left;">语法</td><td style="text-align:left;">proxy_pass URL</td></tr><tr><td style="text-align:left;">默认</td><td style="text-align:left;">-</td></tr><tr><td style="text-align:left;">上下文</td><td style="text-align:left;">server,location</td></tr></tbody></table><h3 id="_14-2-正向代理" tabindex="-1"><a class="header-anchor" href="#_14-2-正向代理"><span>14.2 正向代理</span></a></h3><ul><li>正向代理的对象是客户端,服务器端看不到真正的客户端</li><li>通过公司代理服务器上网</li></ul><p><img src="http://img.zhufengpeixun.cn/positiveproxy.jpg" alt="positiveproxy"></p><p>C:\\Windows\\System32\\drivers\\etc</p><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code class="language-javascript"><span class="line"><span class="token number">192.168</span><span class="token number">.20</span><span class="token number">.150</span> www<span class="token punctuation">.</span>zhufengpeixun<span class="token punctuation">.</span>cn</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text"><pre><code class="language-text"><span class="line"> resolver 8.8.8.8; </span>
<span class="line">location / {</span>
<span class="line">     </span>
<span class="line">    proxy_pass http://$http_host$request_uri;</span>
<span class="line">}</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li>按<code>Win+R</code>系统热键打开<code>运行</code>窗口，输入<code>ipconfig /flushdns</code>命令后按回车，就可以清空电脑的DNS缓存</li></ul><h3 id="_14-3-反向代理" tabindex="-1"><a class="header-anchor" href="#_14-3-反向代理"><span>14.3 反向代理</span></a></h3><ul><li>反向代理的对象的服务端,客户端看不到真正的服务端</li><li>nginx代理应用服务器</li></ul><p><img src="http://img.zhufengpeixun.cn/fanproxy.jpg" alt="fanproxy"></p><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text"><pre><code class="language-text"><span class="line">location ~ ^/api {</span>
<span class="line">    proxy_pass http://localhost:3000;</span>
<span class="line">     proxy_redirect default; </span>
<span class="line"></span>
<span class="line">     proxy_set_header Host $http_host;        </span>
<span class="line">     proxy_set_header X-Real-IP $remote_addr; </span>
<span class="line"></span>
<span class="line">     proxy_connect_timeout 30; </span>
<span class="line">     proxy_send_timeout 60;    </span>
<span class="line">     proxy_read_timeout 60;    </span>
<span class="line"></span>
<span class="line"></span>
<span class="line">     proxy_buffering on;             </span>
<span class="line">     proxy_buffers 4 128k;           </span>
<span class="line">     proxy_busy_buffers_size 256k;   </span>
<span class="line">     proxy_buffer_size 32k;          </span>
<span class="line">     proxy_max_temp_file_size 256k; </span>
<span class="line">}</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code class="language-javascript"><span class="line">curl http<span class="token operator">:</span><span class="token operator">/</span><span class="token operator">/</span>localhost<span class="token operator">/</span>api<span class="token operator">/</span>users<span class="token punctuation">.</span>json</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><h2 id="_15-负载均衡" tabindex="-1"><a class="header-anchor" href="#_15-负载均衡"><span>15 负载均衡</span></a></h2><p><img src="http://img.zhufengpeixun.cn/nginxbalance.jpg" alt="nginxbalance"></p><ul><li>使用集群是网站解决高并发、海量数据问题的常用手段。</li><li>当一台服务器的处理能力、存储空间不足时，不要企图去换更强大的服务器，对大型网站而言，不管多么强大的服务器，都满足不了网站持续增长的业务需求。</li><li>这种情况下，更恰当的做法是增加一台服务器分担原有服务器的访问及存储压力。通过负载均衡调度服务器，将来自浏览器的访问请求分发到应用服务器集群中的任何一台服务器上，如果有更多的用户，就在集群中加入更多的应用服务器，使应用服务器的负载压力不再成为整个网站的瓶颈。</li></ul><h3 id="_15-1-upstream" tabindex="-1"><a class="header-anchor" href="#_15-1-upstream"><span>15.1 upstream</span></a></h3><ul><li>nginx把请求转发到后台的一组<code>upstream</code>服务池</li></ul><table><thead><tr><th style="text-align:left;">类型</th><th style="text-align:left;">种类</th></tr></thead><tbody><tr><td style="text-align:left;">语法</td><td style="text-align:left;">upstream name {}</td></tr><tr><td style="text-align:left;">默认</td><td style="text-align:left;">-</td></tr><tr><td style="text-align:left;">上下文</td><td style="text-align:left;">http</td></tr></tbody></table><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code class="language-javascript"><span class="line"><span class="token keyword">var</span> http <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span> <span class="token string">&#39;http&#39;</span> <span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">var</span> server <span class="token operator">=</span>http<span class="token punctuation">.</span><span class="token function">createServer</span><span class="token punctuation">(</span> <span class="token keyword">function</span> <span class="token punctuation">(</span> <span class="token parameter">request <span class="token punctuation">,</span>response</span> <span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line">          response<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token string">&#39;server3 000&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span> <span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">server<span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span> <span class="token number">3000</span> <span class="token punctuation">,</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line">console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span> <span class="token string">&#39;HTTP服务器启动中，端口：3000&#39;</span> <span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code class="language-javascript"><span class="line">upstream zhufeng <span class="token punctuation">{</span></span>
<span class="line">  server <span class="token number">127.0</span><span class="token number">.0</span><span class="token number">.1</span><span class="token operator">:</span><span class="token number">3000</span> weight<span class="token operator">=</span><span class="token number">10</span><span class="token punctuation">;</span></span>
<span class="line">  server <span class="token number">127.0</span><span class="token number">.0</span><span class="token number">.1</span><span class="token operator">:</span><span class="token number">4000</span><span class="token punctuation">;</span></span>
<span class="line">  server <span class="token number">127.0</span><span class="token number">.0</span><span class="token number">.1</span><span class="token operator">:</span><span class="token number">5000</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">server <span class="token punctuation">{</span></span>
<span class="line">    location <span class="token operator">/</span> <span class="token punctuation">{</span></span>
<span class="line">        proxy_pass http<span class="token operator">:</span><span class="token operator">/</span><span class="token operator">/</span>zhufeng<span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_15-2-后端服务器调试状态" tabindex="-1"><a class="header-anchor" href="#_15-2-后端服务器调试状态"><span>15.2 后端服务器调试状态</span></a></h3><table><thead><tr><th style="text-align:left;">状态</th><th style="text-align:left;">描述</th></tr></thead><tbody><tr><td style="text-align:left;">down</td><td style="text-align:left;">当前的服务器不参与负载均衡</td></tr><tr><td style="text-align:left;">backup</td><td style="text-align:left;">当其它节点都无法使用时的备份的服务器</td></tr><tr><td style="text-align:left;">max_fails</td><td style="text-align:left;">允许请求失败的次数,到达最大次数就会休眠</td></tr><tr><td style="text-align:left;">fail_timeout</td><td style="text-align:left;">经过max_fails失败后，服务暂停的时间,默认10秒</td></tr><tr><td style="text-align:left;">max_conns</td><td style="text-align:left;">限制每个server最大的接收的连接数,性能高的服务器可以连接数多一些</td></tr></tbody></table><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code class="language-javascript"><span class="line">upstream zfpx <span class="token punctuation">{</span></span>
<span class="line">  server localhost<span class="token operator">:</span><span class="token number">3000</span> down<span class="token punctuation">;</span></span>
<span class="line">  server localhost<span class="token operator">:</span><span class="token number">4000</span> backup<span class="token punctuation">;</span></span>
<span class="line">  server localhost<span class="token operator">:</span><span class="token number">5000</span> max_fails<span class="token operator">=</span><span class="token number">1</span> fail_timeout<span class="token operator">=</span>10s<span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_15-3-分配方式" tabindex="-1"><a class="header-anchor" href="#_15-3-分配方式"><span>15.3 分配方式</span></a></h3><table><thead><tr><th style="text-align:left;">类型</th><th style="text-align:left;">种类</th></tr></thead><tbody><tr><td style="text-align:left;">轮询(默认)</td><td style="text-align:left;">每个请求按时间顺序逐一分配到不同的后端服务器，如果后端服务器down掉，能自动剔除</td></tr><tr><td style="text-align:left;">weight(加权轮询)</td><td style="text-align:left;">指定轮询几率，weight和访问比率成正比，用于后端服务器性能不均的情况</td></tr><tr><td style="text-align:left;">ip_hash</td><td style="text-align:left;">每个请求按访问ip的hash结果分配，这样每个访客固定访问一个后端服务器，可以解决session的问题</td></tr><tr><td style="text-align:left;">least_conn</td><td style="text-align:left;">哪个机器上连接数少就分发给谁</td></tr><tr><td style="text-align:left;">url_hash(第三方)</td><td style="text-align:left;">按访问的URL地址来分配 请求，每个URL都定向到同一个后端 服务器上(缓存)</td></tr><tr><td style="text-align:left;">fair(第三方)</td><td style="text-align:left;">按后端服务器的响应时间来分配请求，响应时间短的优先分配</td></tr><tr><td style="text-align:left;">正定义hash</td><td style="text-align:left;">hash自定义key</td></tr></tbody></table><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code class="language-javascript"><span class="line">upstream zhufeng<span class="token punctuation">{</span></span>
<span class="line">  ip_hash<span class="token punctuation">;</span></span>
<span class="line">  server <span class="token number">127.0</span><span class="token number">.0</span><span class="token number">.1</span><span class="token operator">:</span><span class="token number">3000</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code class="language-javascript"><span class="line">upstream zhufeng<span class="token punctuation">{</span></span>
<span class="line">  least_conn<span class="token punctuation">;</span></span>
<span class="line">  server <span class="token number">127.0</span><span class="token number">.0</span><span class="token number">.1</span><span class="token operator">:</span><span class="token number">3000</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code class="language-javascript"><span class="line">upstream zhufeng<span class="token punctuation">{</span></span>
<span class="line">  url_hash<span class="token punctuation">;</span></span>
<span class="line">  server <span class="token number">127.0</span><span class="token number">.0</span><span class="token number">.1</span><span class="token operator">:</span><span class="token number">3000</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code class="language-javascript"><span class="line">upstream zhufeng<span class="token punctuation">{</span></span>
<span class="line">  fair<span class="token punctuation">;</span></span>
<span class="line">  server <span class="token number">127.0</span><span class="token number">.0</span><span class="token number">.1</span><span class="token operator">:</span><span class="token number">3000</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code class="language-javascript"><span class="line">upstream zhufeng<span class="token punctuation">{</span></span>
<span class="line">  hash $request_uri<span class="token punctuation">;</span></span>
<span class="line">  server <span class="token number">127.0</span><span class="token number">.0</span><span class="token number">.1</span><span class="token operator">:</span><span class="token number">3000</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="_16-缓存" tabindex="-1"><a class="header-anchor" href="#_16-缓存"><span>16. 缓存</span></a></h2><ul><li>应用服务器端缓存</li><li>代理缓存</li><li>客户端缓存</li></ul><p><a href="https://blog.csdn.net/dengjiexian123/article/details/53386586" target="_blank" rel="noopener noreferrer">proxy_cache</a></p><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text"><pre><code class="language-text"><span class="line">http{  </span>
<span class="line">     </span>
<span class="line">    proxy_cache_path /data/nginx/cache levels=1:2 keys_zone=cache:100m inactive=60m max_size=10g;  </span>
<span class="line">}  </span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><table><thead><tr><th style="text-align:left;">键值</th><th style="text-align:left;">含义</th></tr></thead><tbody><tr><td style="text-align:left;">proxy_cache_path</td><td style="text-align:left;">缓存文件路径</td></tr><tr><td style="text-align:left;">levels</td><td style="text-align:left;">设置缓存文件目录层次；levels=1:2 表示两级目录</td></tr><tr><td style="text-align:left;">keys_zone</td><td style="text-align:left;">设置缓存名字和共享内存大小</td></tr><tr><td style="text-align:left;">inactive</td><td style="text-align:left;">在指定时间内没人访问则被删除</td></tr><tr><td style="text-align:left;">max_size</td><td style="text-align:left;">最大缓存空间，如果缓存空间满，默认覆盖掉缓存时间最长的资源</td></tr></tbody></table><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text"><pre><code class="language-text"><span class="line">    if ($request_uri ~ ^/cache/(login|logout)) {</span>
<span class="line">      set $nocache 1;</span>
<span class="line">    }</span>
<span class="line">    location / {</span>
<span class="line">       proxy_pass http://zhufeng;</span>
<span class="line">    }</span>
<span class="line">    location ~ ^/cache/ {</span>
<span class="line">     proxy_cache cache;</span>
<span class="line">      proxy_cache_valid  200 206 304 301 302 60m;   </span>
<span class="line">      proxy_cache_key $uri;  </span>
<span class="line">     proxy_no_cache $nocache;</span>
<span class="line">      proxy_set_header Host $host:$server_port;  </span>
<span class="line">      proxy_set_header X-Real-IP $remote_addr;   </span>
<span class="line">      proxy_set_header   X-Forwarded-For $proxy_add_x_forwarded_for;   </span>
<span class="line">     proxy_pass http://127.0.0.1:6000;</span>
<span class="line">    }</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><table><thead><tr><th style="text-align:left;">键值</th><th style="text-align:left;">含义</th></tr></thead><tbody><tr><td style="text-align:left;">proxy_cache</td><td style="text-align:left;">使用名为cache的对应缓存配置</td></tr><tr><td style="text-align:left;">proxy_cache_valid 200 206 304 301 302 10d;</td><td style="text-align:left;">对httpcode为200的缓存10天</td></tr><tr><td style="text-align:left;">proxy_cache_key $uri</td><td style="text-align:left;">定义缓存唯一key,通过唯一key来进行hash存取</td></tr><tr><td style="text-align:left;">proxy_set_header</td><td style="text-align:left;">自定义http header头，用于发送给后端真实服务器</td></tr><tr><td style="text-align:left;">proxy_pass</td><td style="text-align:left;">指代理后转发的路径，注意是否需要最后的/</td></tr></tbody></table><h2 id="_17-rewrite" tabindex="-1"><a class="header-anchor" href="#_17-rewrite"><span>17. rewrite</span></a></h2><ul><li>可以实现url重写及重定向</li></ul><h3 id="_17-1-用途" tabindex="-1"><a class="header-anchor" href="#_17-1-用途"><span>17.1 用途</span></a></h3><ul><li>URL页面跳转</li><li>兼容旧版本</li><li>SEO优化(伪静态)</li><li>维护(后台维护、流量转发)</li><li>安全(伪静态)</li></ul><h3 id="_17-2-语法" tabindex="-1"><a class="header-anchor" href="#_17-2-语法"><span>17.2 语法</span></a></h3><table><thead><tr><th style="text-align:left;">类型</th><th style="text-align:left;">种类</th></tr></thead><tbody><tr><td style="text-align:left;">语法</td><td style="text-align:left;">rewrite regex replacement [flag]</td></tr><tr><td style="text-align:left;">默认</td><td style="text-align:left;">-</td></tr><tr><td style="text-align:left;">上下文</td><td style="text-align:left;">server,location,if</td></tr></tbody></table><ul><li>regex 正则表达式指的是要被改写的路径</li><li>replacement 目标要替换成哪个URL</li><li>flag 标识</li></ul><p>实例</p><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code class="language-javascript"><span class="line">rewrite <span class="token operator">^</span><span class="token punctuation">(</span><span class="token punctuation">.</span><span class="token operator">*</span><span class="token punctuation">)</span>$ <span class="token operator">/</span>www<span class="token operator">/</span>reparing<span class="token punctuation">.</span>html <span class="token keyword">break</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><h3 id="_17-3-正则表达式" tabindex="-1"><a class="header-anchor" href="#_17-3-正则表达式"><span>17.3 正则表达式</span></a></h3><table><thead><tr><th style="text-align:left;">类型</th><th style="text-align:left;">种类</th></tr></thead><tbody><tr><td style="text-align:left;">.</td><td style="text-align:left;">匹配除换行符之外的任意字符</td></tr><tr><td style="text-align:left;">?</td><td style="text-align:left;">重复0次或1次</td></tr><tr><td style="text-align:left;">+</td><td style="text-align:left;">重复1次或更多次</td></tr><tr><td style="text-align:left;">*</td><td style="text-align:left;">重复零次或多次</td></tr><tr><td style="text-align:left;">^</td><td style="text-align:left;">匹配字符串的开始</td></tr><tr><td style="text-align:left;">$</td><td style="text-align:left;">匹配字符串的结束</td></tr><tr><td style="text-align:left;">{n}</td><td style="text-align:left;">重复n次</td></tr><tr><td style="text-align:left;">{n,}</td><td style="text-align:left;">重复n次或更多次</td></tr><tr><td style="text-align:left;">[abc]</td><td style="text-align:left;">匹配单个字符a或者b或者c</td></tr><tr><td style="text-align:left;">a-z</td><td style="text-align:left;">匹配a-z小写字母的任意一个</td></tr><tr><td style="text-align:left;">|转义字符</td><td style="text-align:left;"></td></tr><tr><td style="text-align:left;">()</td><td style="text-align:left;">用于匹配括号之间的内容，可以通过$1、$2引用</td></tr></tbody></table><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code class="language-javascript"><span class="line">rewrite index\\<span class="token punctuation">.</span>php$ <span class="token operator">/</span>pages<span class="token operator">/</span>repare<span class="token punctuation">.</span>html <span class="token keyword">break</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code class="language-javascript"><span class="line"><span class="token keyword">if</span><span class="token punctuation">(</span>$http_user_agent <span class="token operator">~</span> <span class="token constant">MSIE</span><span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line">  rewrite <span class="token operator">^</span><span class="token punctuation">(</span><span class="token punctuation">.</span><span class="token operator">*</span><span class="token punctuation">)</span>$ <span class="token operator">/</span>msie<span class="token operator">/</span>$1 <span class="token keyword">break</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>pcretest</p><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code class="language-javascript"><span class="line">wget https<span class="token operator">:</span><span class="token operator">/</span><span class="token operator">/</span>ftp<span class="token punctuation">.</span>pcre<span class="token punctuation">.</span>org<span class="token operator">/</span>pub<span class="token operator">/</span>pcre<span class="token operator">/</span>pcre<span class="token operator">-</span><span class="token number">8.13</span><span class="token punctuation">.</span>tar<span class="token punctuation">.</span>gz</span>
<span class="line">tar <span class="token operator">-</span>xzvf  pcre<span class="token operator">-</span><span class="token number">8.13</span><span class="token punctuation">.</span>tar<span class="token punctuation">.</span>gz</span>
<span class="line">cd pcre<span class="token operator">-</span><span class="token number">8.13</span></span>
<span class="line"><span class="token punctuation">.</span><span class="token operator">/</span>configure <span class="token operator">--</span>enable<span class="token operator">-</span>utf8  </span>
<span class="line">make</span>
<span class="line">make install</span>
<span class="line">pcretest</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_17-4-flag" tabindex="-1"><a class="header-anchor" href="#_17-4-flag"><span>17.4 flag</span></a></h3><ul><li>标志位是标识规则对应的类型</li></ul><table><thead><tr><th style="text-align:left;">flag</th><th style="text-align:left;">含义</th></tr></thead><tbody><tr><td style="text-align:left;">last</td><td style="text-align:left;">先匹配自己的location,然后通过rewrite规则新建一个请求再次请求服务端</td></tr><tr><td style="text-align:left;">break</td><td style="text-align:left;">先匹配自己的location,然后生命周期会在当前的location结束,不再进行后续的匹配</td></tr><tr><td style="text-align:left;">redirect</td><td style="text-align:left;">返回302昨时重定向,以后还会请求这个服务器</td></tr><tr><td style="text-align:left;">permanent</td><td style="text-align:left;">返回301永久重定向,以后会直接请求永久重定向后的域名</td></tr></tbody></table><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text"><pre><code class="language-text"><span class="line"> location ~ ^/break {</span>
<span class="line">     rewrite ^/break /test break;</span>
<span class="line">     proxy_pass http://127.0.0.1:3000;</span>
<span class="line">}</span>
<span class="line"></span>
<span class="line">location ~ ^/last {</span>
<span class="line">      rewrite ^/last /test last;</span>
<span class="line">}</span>
<span class="line"></span>
<span class="line">location /test {</span>
<span class="line">      default_type application/json;</span>
<span class="line">      return 200 &#39;{&quot;code&quot;:0,&quot;msg&quot;:&quot;success&quot;}&#39;;</span>
<span class="line">}</span>
<span class="line"></span>
<span class="line">curl -vL http://192.168.20.150/redirect</span>
<span class="line"></span>
<span class="line">location ~ ^/redirect {</span>
<span class="line"> rewrite ^/redirect http://www.baidu.com redirect;</span>
<span class="line"> rewrite ^/redirect http://www.baidu.com permanent;</span>
<span class="line">}</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li>先执行server中的rewrite指令</li><li>执行location匹配</li><li>再执行location中的rewrite</li></ul><h3 id="_17-5-rewrite优先级" tabindex="-1"><a class="header-anchor" href="#_17-5-rewrite优先级"><span>17.5 rewrite优先级</span></a></h3><ul><li>先执行server中的rewrite指令</li><li>执行location匹配</li><li>再执行location中的rewrite</li></ul><h3 id="_17-6-location中的优先级" tabindex="-1"><a class="header-anchor" href="#_17-6-location中的优先级"><span>17.6 location中的优先级</span></a></h3><ul><li>等号类型（=）的优先级最高。一旦匹配成功，则不再查找其他匹配项。</li><li>^~类型表达式。一旦匹配成功，则不再查找其他匹配项。</li><li>正则表达式类型（~ ~*）的优先级次之。如果有多个location的正则能匹配的话，则使用正则表达式最长的那个。</li><li>常规字符串匹配类型按前缀匹配</li></ul><h2 id="_20-附录" tabindex="-1"><a class="header-anchor" href="#_20-附录"><span>20. 附录</span></a></h2><h3 id="_20-1-用户空间和内核空间" tabindex="-1"><a class="header-anchor" href="#_20-1-用户空间和内核空间"><span>20.1 用户空间和内核空间</span></a></h3><ul><li>现在操作系统都采用虚拟寻址，处理器先产生一个虚拟地址，通过地址翻译成物理地址（内存的地址），再通过总线的传递，最后处理器拿到某个物理地址返回的字节。</li><li>对32位操作系统而言，它的寻址空间（虚拟存储空间）为4G（2的32次方）。操作系统的核心是内核，独立于普通的应用程序，可以访问受保护的内存空间，也有访问底层硬件设备的所有权限。为了保证用户进程不能直接操作内核（kernel），保证内核的安全，操心系统将虚拟空间划分为两部分，一部分为内核空间，一部分为用户空间</li><li>针对linux操作系统而言，将最高的1G字节（从虚拟地址0xC0000000到0xFFFFFFFF），供内核使用，称为内核空间，而将较低的3G字节（从虚拟地址0x00000000到0xBFFFFFFF），供各个进程使用，称为用户空间。</li><li>地址空间就是一个非负整数地址的有序集合。如{0,1,2...}。</li></ul><h3 id="_20-2-进程上下文切换-进程切换" tabindex="-1"><a class="header-anchor" href="#_20-2-进程上下文切换-进程切换"><span>20.2 进程上下文切换(进程切换)</span></a></h3><ul><li>为了控制进程的执行，内核必须有能力挂起正在CPU上运行的进程，并恢复以前挂起的某个进程的执行。这种行为被称为进程切换</li><li>从一个进程的运行转到另一个进程上运行，这个过程中经过下面这些变化： <ul><li><ol><li>保存当前进程A的上下文,上下文就是内核再次唤醒当前进程时所需要的状态，由一些对象的值组成 - 2. 恢复成进程B的上下文 ....</li></ol></li><li><ol start="3"><li>恢复成进程A的上下文</li></ol></li></ul></li></ul><h3 id="_20-3-进程的阻塞" tabindex="-1"><a class="header-anchor" href="#_20-3-进程的阻塞"><span>20.3 进程的阻塞</span></a></h3><ul><li>正在执行的进程，由于期待的某些事件未发生，将自己的运行状态变成阻塞状态</li><li>进程的阻塞是进程自身的一种主动行为，也因此只有处于运行态的进程（获得CPU），才可能将其转为阻塞状态。当进程进入阻塞状态，是不占用CPU资源的</li></ul><h3 id="_20-4-文件描述符" tabindex="-1"><a class="header-anchor" href="#_20-4-文件描述符"><span>20.4 文件描述符</span></a></h3><ul><li>文件描述符(File descriptor)是一个用于表述指向文件的引用的抽象化概念</li><li>当程序打开一个现有文件或者创建一个新文件时，内核向进程返回一个文件描述符</li></ul><h3 id="_20-5-i-o模式" tabindex="-1"><a class="header-anchor" href="#_20-5-i-o模式"><span>20.5 I/O模式</span></a></h3><ul><li>对于一次IO访问(以read举例),数据会先被拷贝到操作系统内核的缓冲区中，然后才会从操作系统内核的缓冲区拷贝到应用程序的缓冲区，最后交给进程。所以说，当一个read操作发生时，它会经历两个阶段： <ul><li><ol><li>等待数据准备</li></ol></li><li><ol start="2"><li>将数据从内核拷贝到进程中</li></ol></li></ul></li></ul><h3 id="_20-6-分类" tabindex="-1"><a class="header-anchor" href="#_20-6-分类"><span>20.6 分类</span></a></h3><ul><li>同步阻塞IO</li><li>同步非阻塞IO</li><li>异步阻塞IO(IO多路复用)</li><li>异步非阻塞IO</li></ul><h3 id="_20-7-事件模型" tabindex="-1"><a class="header-anchor" href="#_20-7-事件模型"><span>20.7 事件模型</span></a></h3><ul><li>目前支持I/O多路复用的系统调用有 select、poll和epoll</li><li>I/O多路复用就是通过一种机制,一个进程可以监视多个描述符,一旦某个描述符就绪(一般是读就绪或者写就绪),能够通知程序进行相应的读写操作</li><li>但select、poll和epoll本质上都是同步I/O，因为他们都需要在读写事件就绪后自己负责进行读写，也就是说这个读写过程是阻塞的</li></ul><table><thead><tr><th style="text-align:left;">事件模型</th><th style="text-align:left;">描述</th></tr></thead><tbody><tr><td style="text-align:left;">select</td><td style="text-align:left;">单个进程能打开的最大连接数为1024,因为需要对所有的文件描述符进行线性遍历，所以文件描述符太多会导致性能下降。</td></tr><tr><td style="text-align:left;">poll</td><td style="text-align:left;">和select基本一样，因为用链表存储文件描述符,没有最大连接数限制</td></tr><tr><td style="text-align:left;">epoll</td><td style="text-align:left;">epoll是在每个文件描述符上设置callback来实现，FD就绪后才会调用callback,活跃socket少的话性能高，socket活跃多的话性能低</td></tr></tbody></table>`,339)])])}const d=n(l,[["render",i]]),c=JSON.parse('{"path":"/strong/61.10.devops-nginx.html","title":"","lang":"en-US","frontmatter":{},"git":{"updatedTime":1681290319000,"contributors":[{"name":"yutao","username":"yutao","email":"642231346@qq.com","commits":1,"url":"https://github.com/yutao"}],"changelog":[{"hash":"f5ab8c9d34991ec274f7f652439afe5b2afb6147","time":1681290319000,"email":"642231346@qq.com","author":"yutao","message":"modify"}]},"filePathRelative":"strong/61.10.devops-nginx.md"}');export{d as comp,c as data};
