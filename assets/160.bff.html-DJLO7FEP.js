import{_ as s,c as a,a as p,o as e}from"./app-CD1YpnS1.js";const t={};function l(c,n){return e(),a("div",null,[...n[0]||(n[0]=[p(`<h2 id="_1-课程大纲" tabindex="-1"><a class="header-anchor" href="#_1-课程大纲"><span>1.课程大纲</span></a></h2><ul><li>BFF架构演进</li><li>RPC高性性能BFF实战</li><li>DDD和GraphQL实战BFF</li><li>Serverless实战BFF</li></ul><h2 id="_2-bff架构演进" tabindex="-1"><a class="header-anchor" href="#_2-bff架构演进"><span>2.BFF架构演进</span></a></h2><p><img src="https://static.zhufengpeixun.com/ge_ren_zhong_xin_1673108734927.png" alt=""></p><h3 id="_2-1-单体服务" tabindex="-1"><a class="header-anchor" href="#_2-1-单体服务"><span>2.1 单体服务</span></a></h3><ul><li>单体服务是指一个独立的应用程序，包含了所有的功能和业务逻辑。这种架构方式在小型应用程序中很常见</li><li>随着应用程序的功能越来越多，代码库也会越来越大，维护起来也会变得更加困难。此外，单体服务的整体复杂度也会增加，这可能导致软件开发周期变长，质量下降，并且系统的扩展性也会受到限制</li></ul><p><img src="https://static.zhufengpeixun.com/web0_1673109441373.jpg" alt=""></p><h3 id="_2-2-微服务" tabindex="-1"><a class="header-anchor" href="#_2-2-微服务"><span>2.2 微服务</span></a></h3><ul><li>为了应对这些问题，许多公司开始使用微服务架构。微服务是指将一个大型应用程序拆分成若干个小型服务，每个服务负责执行特定的任务。这种架构方式可以帮助公司更快地开发和部署新功能，并提高系统的可扩展性和可维护性</li><li>这种方式会有以下问题 <ul><li>域名开销增加 <ul><li>内部服务器暴露在公网，有安全隐患</li><li>各个端有大量的个性化需求 <ul><li>数据聚合 某些功能可能需要调用多个微服务进行组合 <ul><li>数据裁剪 后端服务返回的数据可能需要过滤掉一些敏感数据</li><li>数据适配 后端返回的数据可能需要针对不同端进行数据结构的适配，后端返回<code>XML</code>，但前端需要<code>JSON</code></li><li>数据鉴权 不同的客户端有不同的权限要求</li></ul></li></ul></li></ul></li></ul></li></ul><p><img src="https://static.zhufengpeixun.com/web15_1673110992237.jpg" alt=""></p><h3 id="_2-3-bff" tabindex="-1"><a class="header-anchor" href="#_2-3-bff"><span>2.3 BFF</span></a></h3><ul><li>BFF是<code>Backend for Frontend</code>的缩写，指的是专门为前端应用设计的后端服务</li><li>主要用来为各个端提供代理数据聚合、裁剪、适配和鉴权服务，方便各个端接入后端服务</li><li>BFF可以把前端和微服务进行解耦，各自可以独立演进</li></ul><p><img src="https://static.zhufengpeixun.com/web23_1673111569390.jpg" alt=""></p><h3 id="_2-4-网关" tabindex="-1"><a class="header-anchor" href="#_2-4-网关"><span>2.4 网关</span></a></h3><ul><li>API 网关是一种用于在应用程序和 API 之间提供安全访问的中间层</li><li>API 网关还可以用于监控 API 调用，路由请求，以及在请求和响应之间添加附加功能（例如身份验证，缓存，数据转换，压缩、流量控制、限流熔断、防爬虫等）</li><li>网关和BFF可能合二为一</li></ul><p><img src="https://static.zhufengpeixun.com/web32_1673150436062.jpg" alt=""></p><h3 id="_2-5-集群化" tabindex="-1"><a class="header-anchor" href="#_2-5-集群化"><span>2.5 集群化</span></a></h3><ul><li>单点服务器可能会存在以下几个问题： <ul><li>单点故障：单点服务器只有一台，如果这台服务器出现故障，整个系统都会停止工作，这会导致服务中断</li><li>计算能力有限：单点服务器的计算能力是有限的，无法应对大规模的计算需求</li><li>可扩展性差：单点服务器的扩展能力有限，如果想要提升计算能力，就必须改造或者替换现有的服务器</li></ul></li><li>这些问题可以通过采用服务器集群的方式来解决</li></ul><p><img src="https://static.zhufengpeixun.com/web4_1673152233154.jpg" alt=""></p><h2 id="_3-创建用户微服务" tabindex="-1"><a class="header-anchor" href="#_3-创建用户微服务"><span>3.创建用户微服务</span></a></h2><h3 id="_3-1-微服务" tabindex="-1"><a class="header-anchor" href="#_3-1-微服务"><span>3.1 微服务</span></a></h3><ul><li>微服务是一种架构模式，它将单个应用程序划分为小的服务，每个服务都独立运行并且可以使用不同的语言开发。这种架构模式使得应用程序变得更容易开发、维护和扩展</li><li>微服务架构通常会有许多不同的服务，这些服务可能位于不同的机器上，因此需要使用某种通信协议来进行通信</li><li>因为<code>RPC</code>协议比<code>HTTP</code>协议具有更低的延迟和更高的性能，所以用的更多</li></ul><h3 id="_3-2-rpc" tabindex="-1"><a class="header-anchor" href="#_3-2-rpc"><span>3.2 RPC</span></a></h3><ul><li><code>RPC（Remote Procedure Call）</code> 是远程过程调用的缩写，是一种通信协议，允许程序在不同的计算机上相互调用远程过程，就像调用本地过程一样</li></ul><h3 id="_3-3-sofa-rpc-node" tabindex="-1"><a class="header-anchor" href="#_3-3-sofa-rpc-node"><span>3.3 sofa-rpc-node</span></a></h3><ul><li><code>sofa-rpc-node</code> 是基于 Node.js 的一个 RPC 框架，支持多种协议</li></ul><h3 id="_3-4-protocol-buffers" tabindex="-1"><a class="header-anchor" href="#_3-4-protocol-buffers"><span>3.4 Protocol Buffers</span></a></h3><ul><li><code>Protocol Buffers</code>（简称 protobuf）是 Google 开发的一种数据序列化格式，可以将结构化数据序列化成二进制格式，并能够跨语言使用</li></ul><h3 id="_3-5-zookeeper" tabindex="-1"><a class="header-anchor" href="#_3-5-zookeeper"><span>3.5 Zookeeper</span></a></h3><h4 id="_3-5-1-简介" tabindex="-1"><a class="header-anchor" href="#_3-5-1-简介"><span>3.5.1 简介</span></a></h4><ul><li>ZooKeeper 是一个分布式协调服务，提供了一些简单的分布式服务，如配置维护、名字服务、组服务等。它可以用于管理分布式系统中的数据</li><li><a href="https://zookeeper.apache.org/releases.html" target="_blank" rel="noopener noreferrer">Apache Zookeeper 官网</a></li></ul><h4 id="_3-5-2-安装启动" tabindex="-1"><a class="header-anchor" href="#_3-5-2-安装启动"><span>3.5.2 安装启动</span></a></h4><ul><li><ol><li>下载 Zookeeper 安装包，可以从<a href="https://zookeeper.apache.org/releases.html" target="_blank" rel="noopener noreferrer">Apache Zookeeper 官网</a>下载最新版本的安装包</li></ol></li><li><ol start="2"><li>解压安装包，将下载的压缩包解压到指定的目录。</li></ol></li><li><ol start="3"><li>配置环境变量，将 Zookeeper 安装目录添加到环境变量中</li></ol></li><li><ol start="4"><li>修改配置文件，在安装目录下的 <code>conf</code> 目录中找到 <code>zookeeper.properties</code> 文件，修改相关配置</li></ol></li><li><ol start="5"><li>启动 Zookeeper，在安装目录下运行命令 <code>bin\\zkServer.cmd</code> 即可启动 Zookeeper</li></ol></li></ul><p>zookeeper\\conf\\zoo.cfg</p><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text"><pre><code class="language-text"><span class="line">+dataDir=./data</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><h3 id="_3-6-启动服务" tabindex="-1"><a class="header-anchor" href="#_3-6-启动服务"><span>3.6 启动服务</span></a></h3><ul><li><code>logger</code> 是日志记录器，用于记录服务器运行时的日志信息</li><li><code>registry</code> 是一个注册中心，用于维护服务的注册信息，帮助服务节点和客户端找到对方。</li><li><code>server</code> 表示服务端。服务端是提供服务的节点，它会将自己所提供的服务注册到注册中心，并等待客户端的调用。服务端通常会实现具体的业务逻辑，并使用 <code>RPC</code> 或其他通信协议与客户端进行通信</li><li><code>server</code> 的 <code>addService</code> 方法接受两个参数：服务接口和服务实现。服务接口是一个对象，其中包含了服务的名称信息。服务实现是一个对象，其中包含了具体实现服务方法的函数</li><li>RPC 服务器的 <code>start</code> 方法，用于启动服务器</li><li>RPC 服务器的 <code>publish</code> 方法，用于向注册中心注册服务。这样，客户端就可以通过注册中心获取服务的地址和端口，并直接向服务器发起调用</li></ul><h4 id="_3-6-1-安装" tabindex="-1"><a class="header-anchor" href="#_3-6-1-安装"><span>3.6.1 安装</span></a></h4><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text"><pre><code class="language-text"><span class="line">npm install mysql2 sofa-rpc-node --save</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><h4 id="_3-6-2-user-package-json" tabindex="-1"><a class="header-anchor" href="#_3-6-2-user-package-json"><span>3.6.2 user\\package.json</span></a></h4><p>user\\package.json</p><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text"><pre><code class="language-text"><span class="line">{</span>
<span class="line">    &quot;name&quot;: &quot;user&quot;,</span>
<span class="line">    &quot;version&quot;: &quot;1.0.0&quot;,</span>
<span class="line">    &quot;description&quot;: &quot;&quot;,</span>
<span class="line">    &quot;main&quot;: &quot;index.js&quot;,</span>
<span class="line">+ &quot;scripts&quot;: {</span>
<span class="line">+     &quot;dev&quot;: &quot;nodemon index.js&quot;</span>
<span class="line">+ },</span>
<span class="line">    &quot;keywords&quot;: [],</span>
<span class="line">    &quot;author&quot;: &quot;&quot;,</span>
<span class="line">    &quot;license&quot;: &quot;MIT&quot;,</span>
<span class="line">    &quot;dependencies&quot;: {</span>
<span class="line">        &quot;sofa-rpc-node&quot;: &quot;^2.8.0&quot;</span>
<span class="line">    }</span>
<span class="line">}</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_3-6-3-user-index-js" tabindex="-1"><a class="header-anchor" href="#_3-6-3-user-index-js"><span>3.6.3 user\\index.js</span></a></h4><p>user\\index.js</p><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code class="language-javascript"><span class="line"><span class="token keyword">const</span> <span class="token punctuation">{</span> <span class="token literal-property property">server</span><span class="token operator">:</span> <span class="token punctuation">{</span> RpcServer <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token literal-property property">registry</span><span class="token operator">:</span> <span class="token punctuation">{</span> ZookeeperRegistry <span class="token punctuation">}</span> <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&#39;sofa-rpc-node&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">const</span> mysql <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&#39;mysql2/promise&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">let</span> connection<span class="token punctuation">;</span></span>
<span class="line"><span class="token comment">// 引入 console 模块</span></span>
<span class="line"><span class="token keyword">const</span> logger <span class="token operator">=</span> console<span class="token punctuation">;</span></span>
<span class="line"><span class="token comment">// 创建 Zookeeper 注册中心实例，传入地址为 &#39;127.0.0.1:2181&#39;</span></span>
<span class="line"><span class="token keyword">const</span> registry <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ZookeeperRegistry</span><span class="token punctuation">(</span><span class="token punctuation">{</span></span>
<span class="line">    logger<span class="token punctuation">,</span></span>
<span class="line">    <span class="token literal-property property">address</span><span class="token operator">:</span> <span class="token string">&#39;127.0.0.1:2181&#39;</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token literal-property property">connectTimeout</span><span class="token operator">:</span> <span class="token number">1000</span> <span class="token operator">*</span> <span class="token number">60</span> <span class="token operator">*</span> <span class="token number">60</span> <span class="token operator">*</span> <span class="token number">24</span><span class="token punctuation">,</span></span>
<span class="line"><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token comment">// 创建 RPC 服务器实例，传入注册中心和端口号</span></span>
<span class="line"><span class="token keyword">const</span> server <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">RpcServer</span><span class="token punctuation">(</span><span class="token punctuation">{</span></span>
<span class="line">    logger<span class="token punctuation">,</span></span>
<span class="line">    registry<span class="token punctuation">,</span></span>
<span class="line">    <span class="token literal-property property">port</span><span class="token operator">:</span> <span class="token number">10000</span></span>
<span class="line"><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token comment">// 添加服务接口，实现 getUserInfo 方法</span></span>
<span class="line">server<span class="token punctuation">.</span><span class="token function">addService</span><span class="token punctuation">(</span><span class="token punctuation">{</span></span>
<span class="line">    <span class="token literal-property property">interfaceName</span><span class="token operator">:</span> <span class="token string">&#39;com.zhufeng.user&#39;</span></span>
<span class="line"><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">async</span> <span class="token function">getUserInfo</span><span class="token punctuation">(</span><span class="token parameter">userId</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">const</span> <span class="token punctuation">[</span>rows<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">await</span> connection<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">\`</span><span class="token string">SELECT id,username,avatar,password,phone FROM user WHERE id=</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">\${</span>userId<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> limit 1</span><span class="token template-punctuation string">\`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">return</span> rows<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token comment">// 启动 RPC 服务器，并发布服务</span></span>
<span class="line"><span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    connection <span class="token operator">=</span> <span class="token keyword">await</span> mysql<span class="token punctuation">.</span><span class="token function">createConnection</span><span class="token punctuation">(</span><span class="token punctuation">{</span></span>
<span class="line">        <span class="token literal-property property">host</span><span class="token operator">:</span> <span class="token string">&#39;localhost&#39;</span><span class="token punctuation">,</span></span>
<span class="line">        <span class="token literal-property property">user</span><span class="token operator">:</span> <span class="token string">&#39;root&#39;</span><span class="token punctuation">,</span></span>
<span class="line">        <span class="token literal-property property">password</span><span class="token operator">:</span> <span class="token string">&#39;root&#39;</span><span class="token punctuation">,</span></span>
<span class="line">        <span class="token literal-property property">database</span><span class="token operator">:</span> <span class="token string">&#39;bff&#39;</span></span>
<span class="line">    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">await</span> server<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">await</span> server<span class="token punctuation">.</span><span class="token function">publish</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">     console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">\`</span><span class="token string">用户微服务发布成功</span><span class="token template-punctuation string">\`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_3-6-4-client-js" tabindex="-1"><a class="header-anchor" href="#_3-6-4-client-js"><span>3.6.4 client.js</span></a></h4><p>user\\client.js</p><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code class="language-javascript"><span class="line"><span class="token keyword">const</span> <span class="token punctuation">{</span> <span class="token literal-property property">client</span><span class="token operator">:</span> <span class="token punctuation">{</span> RpcClient <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token literal-property property">registry</span><span class="token operator">:</span> <span class="token punctuation">{</span> ZookeeperRegistry <span class="token punctuation">}</span> <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&#39;sofa-rpc-node&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token comment">// 设置日志记录器</span></span>
<span class="line"><span class="token keyword">const</span> logger <span class="token operator">=</span> console<span class="token punctuation">;</span></span>
<span class="line"><span class="token comment">// 创建 Zookeeper 注册中心</span></span>
<span class="line"><span class="token keyword">const</span> registry <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ZookeeperRegistry</span><span class="token punctuation">(</span><span class="token punctuation">{</span></span>
<span class="line">    logger<span class="token punctuation">,</span></span>
<span class="line">    <span class="token literal-property property">address</span><span class="token operator">:</span> <span class="token string">&#39;127.0.0.1:2181&#39;</span><span class="token punctuation">,</span></span>
<span class="line"><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token comment">// 创建 RPC 客户端</span></span>
<span class="line">    <span class="token keyword">const</span> client <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">RpcClient</span><span class="token punctuation">(</span><span class="token punctuation">{</span> logger<span class="token punctuation">,</span> registry <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token comment">// 创建 RPC 服务消费者</span></span>
<span class="line">    <span class="token keyword">const</span> userConsumer <span class="token operator">=</span> client<span class="token punctuation">.</span><span class="token function">createConsumer</span><span class="token punctuation">(</span><span class="token punctuation">{</span></span>
<span class="line">        <span class="token comment">// 指定服务接口名称</span></span>
<span class="line">        <span class="token literal-property property">interfaceName</span><span class="token operator">:</span> <span class="token string">&#39;com.zhufeng.user&#39;</span></span>
<span class="line">    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token comment">// 等待服务就绪</span></span>
<span class="line">    <span class="token keyword">await</span> userConsumer<span class="token punctuation">.</span><span class="token function">ready</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token comment">// 调用服务方法</span></span>
<span class="line">    <span class="token keyword">const</span> result <span class="token operator">=</span> <span class="token keyword">await</span> userConsumer<span class="token punctuation">.</span><span class="token function">invoke</span><span class="token punctuation">(</span><span class="token string">&#39;getUserInfo&#39;</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> <span class="token literal-property property">responseTimeout</span><span class="token operator">:</span> <span class="token number">3000</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token comment">// 输出结果</span></span>
<span class="line">    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    process<span class="token punctuation">.</span><span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="_4-创建文章微服务" tabindex="-1"><a class="header-anchor" href="#_4-创建文章微服务"><span>4.创建文章微服务</span></a></h2><h3 id="_4-1-安装" tabindex="-1"><a class="header-anchor" href="#_4-1-安装"><span>4.1 安装</span></a></h3><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text"><pre><code class="language-text"><span class="line">npm install mysql2 sofa-rpc-node --save</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><h3 id="_4-2-article-package-json" tabindex="-1"><a class="header-anchor" href="#_4-2-article-package-json"><span>4.2 article\\package.json</span></a></h3><p>article\\package.json</p><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text"><pre><code class="language-text"><span class="line">{</span>
<span class="line">    &quot;name&quot;: &quot;user&quot;,</span>
<span class="line">    &quot;version&quot;: &quot;1.0.0&quot;,</span>
<span class="line">    &quot;description&quot;: &quot;&quot;,</span>
<span class="line">    &quot;main&quot;: &quot;index.js&quot;,</span>
<span class="line">    &quot;scripts&quot;: {</span>
<span class="line">+    &quot;dev&quot;: &quot;nodemon index.js&quot;</span>
<span class="line">    },</span>
<span class="line">    &quot;keywords&quot;: [],</span>
<span class="line">    &quot;author&quot;: &quot;&quot;,</span>
<span class="line">    &quot;license&quot;: &quot;MIT&quot;,</span>
<span class="line">    &quot;dependencies&quot;: {</span>
<span class="line">        &quot;mysql2&quot;: &quot;^2.3.3&quot;,</span>
<span class="line">        &quot;sofa-rpc-node&quot;: &quot;^2.8.0&quot;</span>
<span class="line">    }</span>
<span class="line">}</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_4-3-article-index-js" tabindex="-1"><a class="header-anchor" href="#_4-3-article-index-js"><span>4.3 article\\index.js</span></a></h3><p>article\\index.js</p><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code class="language-javascript"><span class="line"><span class="token keyword">const</span> <span class="token punctuation">{</span> <span class="token literal-property property">server</span><span class="token operator">:</span> <span class="token punctuation">{</span> RpcServer <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token literal-property property">registry</span><span class="token operator">:</span> <span class="token punctuation">{</span> ZookeeperRegistry <span class="token punctuation">}</span> <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&#39;sofa-rpc-node&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">const</span> mysql <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&#39;mysql2/promise&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">let</span> connection<span class="token punctuation">;</span></span>
<span class="line"><span class="token comment">// 引入 console 模块</span></span>
<span class="line"><span class="token keyword">const</span> logger <span class="token operator">=</span> console<span class="token punctuation">;</span></span>
<span class="line"><span class="token comment">// 创建 Zookeeper 注册中心实例，传入地址为 &#39;127.0.0.1:2181&#39;</span></span>
<span class="line"><span class="token keyword">const</span> registry <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ZookeeperRegistry</span><span class="token punctuation">(</span><span class="token punctuation">{</span></span>
<span class="line">    logger<span class="token punctuation">,</span></span>
<span class="line">    <span class="token literal-property property">address</span><span class="token operator">:</span> <span class="token string">&#39;127.0.0.1:2181&#39;</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token literal-property property">connectTimeout</span><span class="token operator">:</span> <span class="token number">1000</span> <span class="token operator">*</span> <span class="token number">60</span> <span class="token operator">*</span> <span class="token number">60</span> <span class="token operator">*</span> <span class="token number">24</span><span class="token punctuation">,</span></span>
<span class="line"><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token comment">// 创建 RPC 服务器实例，传入注册中心和端口号</span></span>
<span class="line"><span class="token keyword">const</span> server <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">RpcServer</span><span class="token punctuation">(</span><span class="token punctuation">{</span></span>
<span class="line">    logger<span class="token punctuation">,</span></span>
<span class="line">    registry<span class="token punctuation">,</span></span>
<span class="line">    <span class="token literal-property property">port</span><span class="token operator">:</span> <span class="token number">20000</span></span>
<span class="line"><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token comment">// 添加服务接口，实现 getPostCount 方法</span></span>
<span class="line">server<span class="token punctuation">.</span><span class="token function">addService</span><span class="token punctuation">(</span><span class="token punctuation">{</span></span>
<span class="line">    <span class="token literal-property property">interfaceName</span><span class="token operator">:</span> <span class="token string">&#39;com.zhufeng.post&#39;</span></span>
<span class="line"><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">async</span> <span class="token function">getPostCount</span><span class="token punctuation">(</span><span class="token parameter">userId</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">const</span> <span class="token punctuation">[</span>rows<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">await</span> connection<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">\`</span><span class="token string">SELECT count(*) as postCount FROM post WHERE user_id=</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">\${</span>userId<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> limit 1</span><span class="token template-punctuation string">\`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">return</span> rows<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>postCount<span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token comment">// 启动 RPC 服务器，并发布服务</span></span>
<span class="line"><span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    connection <span class="token operator">=</span> <span class="token keyword">await</span> mysql<span class="token punctuation">.</span><span class="token function">createConnection</span><span class="token punctuation">(</span><span class="token punctuation">{</span></span>
<span class="line">        <span class="token literal-property property">host</span><span class="token operator">:</span> <span class="token string">&#39;localhost&#39;</span><span class="token punctuation">,</span></span>
<span class="line">        <span class="token literal-property property">user</span><span class="token operator">:</span> <span class="token string">&#39;root&#39;</span><span class="token punctuation">,</span></span>
<span class="line">        <span class="token literal-property property">password</span><span class="token operator">:</span> <span class="token string">&#39;root&#39;</span><span class="token punctuation">,</span></span>
<span class="line">        <span class="token literal-property property">database</span><span class="token operator">:</span> <span class="token string">&#39;bff&#39;</span></span>
<span class="line">    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">await</span> server<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">await</span> server<span class="token punctuation">.</span><span class="token function">publish</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">\`</span><span class="token string">文章微服务发布成功</span><span class="token template-punctuation string">\`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_4-4-client-js" tabindex="-1"><a class="header-anchor" href="#_4-4-client-js"><span>4.4 client.js</span></a></h3><p>article\\client.js</p><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code class="language-javascript"><span class="line"><span class="token keyword">const</span> <span class="token punctuation">{</span> <span class="token literal-property property">client</span><span class="token operator">:</span> <span class="token punctuation">{</span> RpcClient <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token literal-property property">registry</span><span class="token operator">:</span> <span class="token punctuation">{</span> ZookeeperRegistry <span class="token punctuation">}</span> <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&#39;sofa-rpc-node&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token comment">// 设置日志记录器</span></span>
<span class="line"><span class="token keyword">const</span> logger <span class="token operator">=</span> console<span class="token punctuation">;</span></span>
<span class="line"><span class="token comment">// 创建 Zookeeper 注册中心</span></span>
<span class="line"><span class="token keyword">const</span> registry <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ZookeeperRegistry</span><span class="token punctuation">(</span><span class="token punctuation">{</span></span>
<span class="line">    logger<span class="token punctuation">,</span></span>
<span class="line">    <span class="token literal-property property">address</span><span class="token operator">:</span> <span class="token string">&#39;127.0.0.1:2181&#39;</span><span class="token punctuation">,</span></span>
<span class="line"><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token comment">// 创建 RPC 客户端</span></span>
<span class="line">    <span class="token keyword">const</span> client <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">RpcClient</span><span class="token punctuation">(</span><span class="token punctuation">{</span> logger<span class="token punctuation">,</span> registry <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token comment">// 创建 RPC 服务消费者</span></span>
<span class="line">    <span class="token keyword">const</span> consumer <span class="token operator">=</span> client<span class="token punctuation">.</span><span class="token function">createConsumer</span><span class="token punctuation">(</span><span class="token punctuation">{</span></span>
<span class="line">        <span class="token comment">// 指定服务接口名称</span></span>
<span class="line">        <span class="token literal-property property">interfaceName</span><span class="token operator">:</span> <span class="token string">&#39;com.zhufeng.post&#39;</span></span>
<span class="line">    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token comment">// 等待服务就绪</span></span>
<span class="line">    <span class="token keyword">await</span> consumer<span class="token punctuation">.</span><span class="token function">ready</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token comment">// 调用服务方法</span></span>
<span class="line">    <span class="token keyword">const</span> result <span class="token operator">=</span> <span class="token keyword">await</span> consumer<span class="token punctuation">.</span><span class="token function">invoke</span><span class="token punctuation">(</span><span class="token string">&#39;getPostCount&#39;</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> <span class="token literal-property property">responseTimeout</span><span class="token operator">:</span> <span class="token number">3000</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token comment">// 输出结果</span></span>
<span class="line">    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    process<span class="token punctuation">.</span><span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="_5-创建bff" tabindex="-1"><a class="header-anchor" href="#_5-创建bff"><span>5.创建BFF</span></a></h2><h3 id="_5-1-安装" tabindex="-1"><a class="header-anchor" href="#_5-1-安装"><span>5.1 安装</span></a></h3><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text"><pre><code class="language-text"><span class="line">npm install koa koa-router koa-logger sofa-rpc-node lru-cache ioredis amqplib fs-extra --save</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p>访问地址</p><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code class="language-javascript"><span class="line"><span class="token literal-property property">http</span><span class="token operator">:</span><span class="token operator">/</span><span class="token operator">/</span>localhost<span class="token operator">:</span><span class="token number">3000</span><span class="token operator">/</span><span class="token operator">?</span>userId<span class="token operator">=</span><span class="token number">1</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><h3 id="_5-2-bff-package-json" tabindex="-1"><a class="header-anchor" href="#_5-2-bff-package-json"><span>5.2 bff\\package.json</span></a></h3><p>bff\\package.json</p><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text"><pre><code class="language-text"><span class="line">{</span>
<span class="line">    &quot;name&quot;: &quot;bff&quot;,</span>
<span class="line">    &quot;version&quot;: &quot;1.0.0&quot;,</span>
<span class="line">    &quot;description&quot;: &quot;&quot;,</span>
<span class="line">    &quot;main&quot;: &quot;index.js&quot;,</span>
<span class="line">    &quot;scripts&quot;: {</span>
<span class="line">+    &quot;dev&quot;: &quot;nodemon index.js&quot;,</span>
<span class="line">+    &quot;start&quot;: &quot;pm2 start index.js --name bff&quot;</span>
<span class="line">    },</span>
<span class="line">    &quot;keywords&quot;: [],</span>
<span class="line">    &quot;author&quot;: &quot;&quot;,</span>
<span class="line">    &quot;license&quot;: &quot;ISC&quot;,</span>
<span class="line">    &quot;dependencies&quot;: {</span>
<span class="line">        &quot;koa&quot;: &quot;^2.14.1&quot;,</span>
<span class="line">        &quot;koa-logger&quot;: &quot;^3.2.1&quot;,</span>
<span class="line">        &quot;koa-router&quot;: &quot;^12.0.0&quot;,</span>
<span class="line">        &quot;sofa-rpc-node&quot;: &quot;^2.8.0&quot;</span>
<span class="line">    }</span>
<span class="line">}</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_5-3-bff-index-js" tabindex="-1"><a class="header-anchor" href="#_5-3-bff-index-js"><span>5.3 bff\\index.js</span></a></h3><p>bff\\index.js</p><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code class="language-javascript"><span class="line"><span class="token keyword">const</span> Koa <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&#39;koa&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">const</span> router <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&#39;koa-router&#39;</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">const</span> logger <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&#39;koa-logger&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">const</span> rpcMiddleware <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&#39;./middleware/rpc&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">const</span> app <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Koa</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token function">logger</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token function">rpcMiddleware</span><span class="token punctuation">(</span><span class="token punctuation">{</span></span>
<span class="line">    <span class="token comment">//配置 rpc 中间件的参数，表示要调用的 rpc 接口名称</span></span>
<span class="line">    <span class="token literal-property property">interfaceNames</span><span class="token operator">:</span> <span class="token punctuation">[</span></span>
<span class="line">        <span class="token string">&#39;com.zhufeng.user&#39;</span><span class="token punctuation">,</span></span>
<span class="line">        <span class="token string">&#39;com.zhufeng.post&#39;</span></span>
<span class="line">    <span class="token punctuation">]</span></span>
<span class="line"><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">router<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&#39;/&#39;</span><span class="token punctuation">,</span> <span class="token keyword">async</span> <span class="token parameter">ctx</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">const</span> userId <span class="token operator">=</span> ctx<span class="token punctuation">.</span>query<span class="token punctuation">.</span>userId<span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">const</span> <span class="token punctuation">{</span> <span class="token literal-property property">rpcConsumers</span><span class="token operator">:</span> <span class="token punctuation">{</span> user<span class="token punctuation">,</span> post <span class="token punctuation">}</span> <span class="token punctuation">}</span> <span class="token operator">=</span> ctx<span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">const</span> <span class="token punctuation">[</span>userInfo<span class="token punctuation">,</span> postCount<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">await</span> Promise<span class="token punctuation">.</span><span class="token function">all</span><span class="token punctuation">(</span><span class="token punctuation">[</span></span>
<span class="line">        user<span class="token punctuation">.</span><span class="token function">invoke</span><span class="token punctuation">(</span><span class="token string">&#39;getUserInfo&#39;</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>userId<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line">        post<span class="token punctuation">.</span><span class="token function">invoke</span><span class="token punctuation">(</span><span class="token string">&#39;getPostCount&#39;</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>userId<span class="token punctuation">]</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    ctx<span class="token punctuation">.</span>body <span class="token operator">=</span> <span class="token punctuation">{</span> userInfo<span class="token punctuation">,</span> postCount <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span>router<span class="token punctuation">.</span><span class="token function">routes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span>router<span class="token punctuation">.</span><span class="token function">allowedMethods</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">app<span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span><span class="token number">3000</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></span>
<span class="line">    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&#39;bff server is running at 3000&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_5-4-rpc-js" tabindex="-1"><a class="header-anchor" href="#_5-4-rpc-js"><span>5.4 rpc.js</span></a></h3><p>bff\\middleware\\rpc.js</p><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code class="language-javascript"><span class="line"><span class="token keyword">const</span> <span class="token punctuation">{</span> <span class="token literal-property property">client</span><span class="token operator">:</span> <span class="token punctuation">{</span> RpcClient <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token literal-property property">registry</span><span class="token operator">:</span> <span class="token punctuation">{</span> ZookeeperRegistry <span class="token punctuation">}</span> <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&#39;sofa-rpc-node&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">const</span> <span class="token function-variable function">rpcMiddleware</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">options <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">return</span> <span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">ctx<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">const</span> logger <span class="token operator">=</span> options<span class="token punctuation">.</span>logger <span class="token operator">||</span> console<span class="token punctuation">;</span></span>
<span class="line">        <span class="token comment">//创建 ZookeeperRegistry 类的实例，用于管理服务发现和注册</span></span>
<span class="line">        <span class="token keyword">const</span> registry <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ZookeeperRegistry</span><span class="token punctuation">(</span><span class="token punctuation">{</span></span>
<span class="line">            logger<span class="token punctuation">,</span></span>
<span class="line">            <span class="token literal-property property">address</span><span class="token operator">:</span> options<span class="token punctuation">.</span>address <span class="token operator">||</span> <span class="token string">&#39;127.0.0.1:2181&#39;</span><span class="token punctuation">,</span></span>
<span class="line">        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token comment">//创建 RpcClient 类的实例，用于发送 rpc 请求</span></span>
<span class="line">        <span class="token keyword">const</span> client <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">RpcClient</span><span class="token punctuation">(</span><span class="token punctuation">{</span> logger<span class="token punctuation">,</span> registry <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">const</span> interfaceNames <span class="token operator">=</span> options<span class="token punctuation">.</span>interfaceNames <span class="token operator">||</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">const</span> rpcConsumers <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> interfaceNames<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token keyword">const</span> interfaceName <span class="token operator">=</span> interfaceNames<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span></span>
<span class="line">            <span class="token comment">//使用 RpcClient 的 createConsumer 方法创建 rpc 消费者</span></span>
<span class="line">            <span class="token keyword">const</span> consumer <span class="token operator">=</span> client<span class="token punctuation">.</span><span class="token function">createConsumer</span><span class="token punctuation">(</span><span class="token punctuation">{</span></span>
<span class="line">                interfaceName<span class="token punctuation">,</span></span>
<span class="line">            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">            <span class="token comment">//等待 rpc 消费者准备完毕</span></span>
<span class="line">            <span class="token keyword">await</span> consumer<span class="token punctuation">.</span><span class="token function">ready</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">            rpcConsumers<span class="token punctuation">[</span>interfaceName<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">&#39;.&#39;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">pop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">=</span> consumer<span class="token punctuation">;</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">        ctx<span class="token punctuation">.</span>rpcConsumers <span class="token operator">=</span> rpcConsumers<span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">await</span> <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span><span class="token punctuation">;</span></span>
<span class="line">module<span class="token punctuation">.</span>exports <span class="token operator">=</span> rpcMiddleware<span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_5-5-bff-index-js" tabindex="-1"><a class="header-anchor" href="#_5-5-bff-index-js"><span>5.5 bff\\index.js</span></a></h3><p>数据处理</p><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text"><pre><code class="language-text"><span class="line">const Koa = require(&#39;koa&#39;);</span>
<span class="line">const router = require(&#39;koa-router&#39;)();</span>
<span class="line">const logger = require(&#39;koa-logger&#39;);</span>
<span class="line">const rpcMiddleware = require(&#39;./middleware/rpc&#39;);</span>
<span class="line">const app = new Koa();</span>
<span class="line">app.use(logger());</span>
<span class="line">app.use(rpcMiddleware({</span>
<span class="line">    interfaceNames: [</span>
<span class="line">        &#39;com.zhufeng.user&#39;,</span>
<span class="line">        &#39;com.zhufeng.post&#39;</span>
<span class="line">    ]</span>
<span class="line">}));</span>
<span class="line">router.get(&#39;/&#39;, async ctx =&gt; {</span>
<span class="line">    const userId = ctx.query.userId;</span>
<span class="line">    const { rpcConsumers: { user, post } } = ctx;</span>
<span class="line">    const [userInfo, postCount] = await Promise.all([</span>
<span class="line">        user.invoke(&#39;getUserInfo&#39;, [userId]),</span>
<span class="line">        post.invoke(&#39;getPostCount&#39;, [userId])</span>
<span class="line">    ]);</span>
<span class="line">+ // 裁剪数据</span>
<span class="line">+ delete userInfo.password;</span>
<span class="line">+ // 数据脱敏</span>
<span class="line">+ userInfo.phone = userInfo.phone.replace(/(\\d{3})\\d{4}(\\d{4})/, &#39;$1****$2&#39;);</span>
<span class="line">+ // 数据适配</span>
<span class="line">+ userInfo.avatar = &quot;http://www.zhufengpeixun.cn/&quot;+userInfo.avatar,</span>
<span class="line">    ctx.body = { userInfo, postCount }</span>
<span class="line">});</span>
<span class="line">app.use(router.routes()).use(router.allowedMethods());</span>
<span class="line">app.listen(3000, () =&gt; {</span>
<span class="line">    console.log(&#39;bff server is running at 3000&#39;);</span>
<span class="line">});</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="_6-缓存" tabindex="-1"><a class="header-anchor" href="#_6-缓存"><span>6.缓存</span></a></h2><ul><li>BFF 作为前端应用和后端系统之间的抽象层，承担了大量的请求转发和数据转换工作。使用多级缓存可以帮助 BFF 减少对后端系统的访问，从而提高应用的响应速度</li><li>当 BFF 收到一个请求时，首先会检查内存缓存中是否存在对应的数据，如果有就直接返回数据。如果内存缓存中没有数据，就会检查Redis缓存，如果Redis缓存中有数据就返回数据，并将数据写入内存缓存。如果本地缓存中也没有数据，就会向后端系统发起请求，并将数据写入Redis缓存和内存缓存</li></ul><h3 id="_6-1-多级缓存" tabindex="-1"><a class="header-anchor" href="#_6-1-多级缓存"><span>6.1 多级缓存</span></a></h3><ul><li>多级缓存（multi-level cache）是指系统中使用了多个缓存层来存储数据的技术。这些缓存层的优先级通常是依次递减的，即最快的缓存层位于最顶层，最慢的缓存层位于最底层</li></ul><h3 id="_6-2-lru" tabindex="-1"><a class="header-anchor" href="#_6-2-lru"><span>6.2 LRU</span></a></h3><ul><li>LRU（Least Recently Used）是一种常用的高速缓存淘汰算法，它的原理是将最近使用过的数据或页面保留在缓存中，而最少使用的数据或页面将被淘汰。这样做的目的是为了最大化缓存的命中率，即使用缓存尽可能多地满足用户的请求</li></ul><h3 id="_6-3-redis" tabindex="-1"><a class="header-anchor" href="#_6-3-redis"><span>6.3 redis</span></a></h3><ul><li>Redis 是一种开源的内存数据存储系统，可以作为数据库、缓存和消息中间件使用</li><li>Redis 运行在内存中，因此它的读写速度非常快</li><li><code>ioredis</code> 是一个基于 Node.js 的 Redis 客户端，提供了对 Redis 命令的高度封装和支持</li><li><a href="https://github.com/tporadowski/redis/releases" target="_blank" rel="noopener noreferrer">redis</a></li><li><a href="https://static.zhufengpeixun.com/Redisx6450141_1673102444438.zip" target="_blank" rel="noopener noreferrer">Redis-x64-5.0.14.1</a></li></ul><h3 id="_6-4-使用缓存" tabindex="-1"><a class="header-anchor" href="#_6-4-使用缓存"><span>6.4 使用缓存</span></a></h3><h4 id="_6-4-1-bff-index-js" tabindex="-1"><a class="header-anchor" href="#_6-4-1-bff-index-js"><span>6.4.1 bff\\index.js</span></a></h4><p>bff\\index.js</p><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text"><pre><code class="language-text"><span class="line">const Koa = require(&#39;koa&#39;);</span>
<span class="line">const router = require(&#39;koa-router&#39;)();</span>
<span class="line">const logger = require(&#39;koa-logger&#39;);</span>
<span class="line">const rpcMiddleware = require(&#39;./middleware/rpc&#39;);</span>
<span class="line">+const cacheMiddleware = require(&#39;./middleware/cache&#39;);</span>
<span class="line">const app = new Koa();</span>
<span class="line">app.use(logger());</span>
<span class="line">app.use(rpcMiddleware({</span>
<span class="line">    interfaceNames: [</span>
<span class="line">        &#39;com.zhufeng.user&#39;,</span>
<span class="line">        &#39;com.zhufeng.post&#39;</span>
<span class="line">    ]</span>
<span class="line">}));</span>
<span class="line">+app.use(cacheMiddleware({}));</span>
<span class="line">router.get(&#39;/profile&#39;, async ctx =&gt; {</span>
<span class="line">    const userId = ctx.query.userId;</span>
<span class="line">    const { rpcConsumers: { user, post } } = ctx;</span>
<span class="line"> + const cacheKey = \`\${ctx.method}#\${ctx.path}</span>
<span class="line">+ let cacheData = await ctx.cache.get(cacheKey);</span>
<span class="line">+ if (cacheData) {</span>
<span class="line">+     ctx.body = cacheData;</span>
<span class="line">+     return;</span>
<span class="line">+ }</span>
<span class="line">    const [userInfo, postCount] = await Promise.all([</span>
<span class="line">        user.invoke(&#39;getUserInfo&#39;, [userId]),</span>
<span class="line">        post.invoke(&#39;getPostCount&#39;, [userId])</span>
<span class="line">    ]);</span>
<span class="line">  // 裁剪数据</span>
<span class="line">  delete userInfo.password;</span>
<span class="line">  // 数据脱敏</span>
<span class="line">  userInfo.phone = userInfo.phone.replace(/(\\d{3})\\d{4}(\\d{4})/, &#39;$1****$2&#39;);</span>
<span class="line">  // 数据适配</span>
<span class="line">  userInfo.avatar = &quot;http://www.zhufengpeixun.cn/&quot; + userInfo.avatar;</span>
<span class="line">+ cacheData = { userInfo, postCount };</span>
<span class="line">+ await ctx.cache.set(cacheKey, cacheData);// keys *</span>
<span class="line">+ ctx.body = cacheData</span>
<span class="line">});</span>
<span class="line">app.use(router.routes()).use(router.allowedMethods());</span>
<span class="line">app.listen(3000, () =&gt; {</span>
<span class="line">    console.log(&#39;bff server is running at 3000&#39;);</span>
<span class="line">});</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_6-4-2-cache-js" tabindex="-1"><a class="header-anchor" href="#_6-4-2-cache-js"><span>6.4.2 cache.js</span></a></h4><p>bff\\middleware\\cache.js</p><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code class="language-javascript"><span class="line"><span class="token keyword">const</span> LRUCache <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&#39;lru-cache&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">const</span> Redis <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&#39;ioredis&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">class</span> <span class="token class-name">CacheStore</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">this</span><span class="token punctuation">.</span>stores <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    <span class="token function">add</span><span class="token punctuation">(</span><span class="token parameter">store</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">this</span><span class="token punctuation">.</span>stores<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>store<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    <span class="token keyword">async</span> <span class="token function">get</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> store <span class="token keyword">of</span> <span class="token keyword">this</span><span class="token punctuation">.</span>stores<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token keyword">const</span> value <span class="token operator">=</span> <span class="token keyword">await</span> store<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">            <span class="token keyword">if</span> <span class="token punctuation">(</span>value <span class="token operator">!==</span> <span class="token keyword">undefined</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">                <span class="token keyword">return</span> value<span class="token punctuation">;</span></span>
<span class="line">            <span class="token punctuation">}</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    <span class="token keyword">async</span> <span class="token function">set</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> value<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> store <span class="token keyword">of</span> <span class="token keyword">this</span><span class="token punctuation">.</span>stores<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token keyword">await</span> store<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"><span class="token keyword">class</span> <span class="token class-name">MemoryStore</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">this</span><span class="token punctuation">.</span>cache <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">LRUCache</span><span class="token punctuation">(</span><span class="token punctuation">{</span></span>
<span class="line">            <span class="token literal-property property">max</span><span class="token operator">:</span> <span class="token number">100</span><span class="token punctuation">,</span></span>
<span class="line">            <span class="token literal-property property">ttl</span><span class="token operator">:</span> <span class="token number">1000</span> <span class="token operator">*</span> <span class="token number">60</span> <span class="token operator">*</span> <span class="token number">60</span> <span class="token operator">*</span> <span class="token number">24</span></span>
<span class="line">        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    <span class="token keyword">async</span> <span class="token function">get</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>cache<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    <span class="token keyword">async</span> <span class="token function">set</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> value<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">this</span><span class="token punctuation">.</span>cache<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"><span class="token keyword">class</span> <span class="token class-name">RedisStore</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter">options</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">this</span><span class="token punctuation">.</span>client <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Redis</span><span class="token punctuation">(</span>options<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    <span class="token keyword">async</span> <span class="token function">get</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">let</span> value <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span>client<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">return</span> value <span class="token operator">?</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token keyword">undefined</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    <span class="token keyword">async</span> <span class="token function">set</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> value<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span>client<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"><span class="token keyword">const</span> <span class="token function-variable function">cacheMiddleware</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">options <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">return</span> <span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">ctx<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">const</span> cacheStore <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">CacheStore</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        cacheStore<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">MemoryStore</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">const</span> redisStore <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">RedisStore</span><span class="token punctuation">(</span>options<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        cacheStore<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>redisStore<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        ctx<span class="token punctuation">.</span>cache <span class="token operator">=</span> cacheStore<span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">await</span> <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span><span class="token punctuation">;</span></span>
<span class="line">module<span class="token punctuation">.</span>exports <span class="token operator">=</span> cacheMiddleware<span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="_7-消息队列" tabindex="-1"><a class="header-anchor" href="#_7-消息队列"><span>7.消息队列</span></a></h2><ul><li>消息队列（Message Queue）用于在分布式系统中传递数据。它的特点是可以将消息发送者和接收者解耦，使得消息生产者和消息消费者可以独立的开发和部署</li></ul><h3 id="_7-1-引入原因" tabindex="-1"><a class="header-anchor" href="#_7-1-引入原因"><span>7.1 引入原因</span></a></h3><ul><li>在 BFF 中使用消息队列（message queue）有几个原因： <ul><li>大并发：消息队列可以帮助应对大并发的请求，BFF 可以将请求写入消息队列，然后后端服务可以从消息队列中读取请求并处理</li><li>解耦：消息队列可以帮助解耦 BFF 和后端服务，BFF 不需要关心后端服务的具体实现，只需要将请求写入消息队列，后端服务负责从消息队列中读取请求并处理</li><li>异步：消息队列可以帮助实现异步调用，BFF 可以将请求写入消息队列，然后立即返回响应给前端应用，后端服务在后台处理请求 <ul><li>流量削峰：消息队列可以帮助流量削峰，BFF 可以将请求写入消息队列，然后后端服务可以在合适的时候处理请求，从而缓解瞬时高峰流量带来的压力</li></ul></li></ul></li></ul><h3 id="_7-2-rabbitmq" tabindex="-1"><a class="header-anchor" href="#_7-2-rabbitmq"><span>7.2 RabbitMQ</span></a></h3><ul><li><code>RabbitMQ</code>是一个消息代理，它可以用来在消息生产者和消息消费者之间传递消息</li><li>RabbitMQ的工作流程如下： <ul><li>消息生产者将消息发送到<code>RabbitMQ</code>服务器</li><li><code>RabbitMQ</code>服务器将消息保存到队列中</li><li>消息消费者从队列中读取消息</li><li>当消息消费者处理完消息后<code>RabbitMQ</code>服务器将消息删除</li></ul></li><li>安装启动 <ul><li>在RabbitMQ下载[官网安装包](https://www.rabbitmq.com/install-windows.html</li><li>双击安装包，按照提示进行安装,直接就可以启动 <ul><li>安装前还要安装<a href="https://www.erlang.org/downloads" target="_blank" rel="noopener noreferrer">Erlang</a>,Erlang是一个结构化，动态类型编程语言，内建并行计算支持</li></ul></li></ul></li></ul><h3 id="_7-3-实现" tabindex="-1"><a class="header-anchor" href="#_7-3-实现"><span>7.3 实现</span></a></h3><h4 id="_7-3-2-bff-index-js" tabindex="-1"><a class="header-anchor" href="#_7-3-2-bff-index-js"><span>7.3.2 bff\\index.js</span></a></h4><p>bff\\index.js</p><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text"><pre><code class="language-text"><span class="line">const Koa = require(&#39;koa&#39;);</span>
<span class="line">const router = require(&#39;koa-router&#39;)();</span>
<span class="line">const logger = require(&#39;koa-logger&#39;);</span>
<span class="line">const rpcMiddleware = require(&#39;./middleware/rpc&#39;);</span>
<span class="line">const cacheMiddleware = require(&#39;./middleware/cache&#39;);</span>
<span class="line">+const mqMiddleware = require(&#39;./middleware/mq&#39;);</span>
<span class="line">const app = new Koa();</span>
<span class="line">app.use(logger());</span>
<span class="line">app.use(rpcMiddleware({</span>
<span class="line">    interfaceNames: [</span>
<span class="line">        &#39;com.zhufeng.user&#39;,</span>
<span class="line">        &#39;com.zhufeng.post&#39;</span>
<span class="line">    ]</span>
<span class="line">}));</span>
<span class="line">app.use(cacheMiddleware({}));</span>
<span class="line">+app.use(mqMiddleware({ url: &#39;amqp://localhost&#39; }));</span>
<span class="line">router.get(&#39;/profile&#39;, async ctx =&gt; {</span>
<span class="line">    const userId = ctx.query.userId;</span>
<span class="line">+    ctx.channels.logger.sendToQueue(&#39;logger&#39;, Buffer.from(JSON.stringify({</span>
<span class="line">+        method: ctx.method,</span>
<span class="line">+        path: ctx.path,</span>
<span class="line">+        userId</span>
<span class="line">+    })));</span>
<span class="line">    const { rpcConsumers: { user, post } } = ctx;</span>
<span class="line">     const cacheKey = \`\${ctx.method}#\${ctx.path}</span>
<span class="line">    let cacheData = await ctx.cache.get(cacheKey);</span>
<span class="line">    if (cacheData) {</span>
<span class="line">        ctx.body = cacheData;</span>
<span class="line">        return;</span>
<span class="line">    }</span>
<span class="line">    const [userInfo, postCount] = await Promise.all([</span>
<span class="line">        user.invoke(&#39;getUserInfo&#39;, [userId]),</span>
<span class="line">        post.invoke(&#39;getPostCount&#39;, [userId])</span>
<span class="line">    ]);</span>
<span class="line">      // 裁剪数据</span>
<span class="line">  delete userInfo.password;</span>
<span class="line">  // 数据脱敏</span>
<span class="line">  userInfo.phone = userInfo.phone.replace(/(\\d{3})\\d{4}(\\d{4})/, &#39;$1****$2&#39;);</span>
<span class="line">  // 数据适配</span>
<span class="line">  userInfo.avatar = &quot;http://www.zhufengpeixun.cn/&quot; + userInfo.avatar,</span>
<span class="line">    cacheData = { userInfo, postCount };</span>
<span class="line">  await ctx.cache.set(cacheKey, cacheData);// keys *</span>
<span class="line">  ctx.body = cacheData</span>
<span class="line">});</span>
<span class="line">app.use(router.routes()).use(router.allowedMethods());</span>
<span class="line">app.listen(3000, () =&gt; {</span>
<span class="line">    console.log(&#39;bff server is running at 3000&#39;);</span>
<span class="line">});</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_7-3-2-mq-js" tabindex="-1"><a class="header-anchor" href="#_7-3-2-mq-js"><span>7.3.2 mq.js</span></a></h4><p>bff\\middleware\\mq.js</p><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code class="language-javascript"><span class="line"><span class="token keyword">const</span> amqp <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&#39;amqplib&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">const</span> <span class="token function-variable function">mqMiddleware</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">options <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">return</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">ctx<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token comment">//使用 amqp.connect 方法连接 RabbitMQ 服务器</span></span>
<span class="line">        <span class="token keyword">const</span> rabbitMQClient <span class="token operator">=</span> <span class="token keyword">await</span> amqp<span class="token punctuation">.</span><span class="token function">connect</span><span class="token punctuation">(</span>options<span class="token punctuation">.</span>url <span class="token operator">||</span> <span class="token string">&#39;amqp://localhost&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token comment">//使用 rabbitMQClient 的 createChannel 方法创建 RabbitMQ 通道</span></span>
<span class="line">        <span class="token keyword">const</span> logger <span class="token operator">=</span> <span class="token keyword">await</span> rabbitMQClient<span class="token punctuation">.</span><span class="token function">createChannel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token comment">//使用 logger 的 assertQueue 方法创建名为 &quot;logger&quot; 的队列，如果队列已经存在则不会重复创建</span></span>
<span class="line">        <span class="token keyword">await</span> logger<span class="token punctuation">.</span><span class="token function">assertQueue</span><span class="token punctuation">(</span><span class="token string">&#39;logger&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        ctx<span class="token punctuation">.</span>channels <span class="token operator">=</span> <span class="token punctuation">{</span></span>
<span class="line">            logger</span>
<span class="line">        <span class="token punctuation">}</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">await</span> <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span><span class="token punctuation">;</span></span>
<span class="line">module<span class="token punctuation">.</span>exports <span class="token operator">=</span> mqMiddleware<span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_7-3-3-bff-logger-js" tabindex="-1"><a class="header-anchor" href="#_7-3-3-bff-logger-js"><span>7.3.3 bff\\logger.js</span></a></h4><p>bff\\logger.js</p><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code class="language-javascript"><span class="line"><span class="token keyword">const</span> amqplib <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&#39;amqplib&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">const</span> fs <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&#39;fs-extra&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">const</span> path <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&#39;path&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">const</span> conn <span class="token operator">=</span> <span class="token keyword">await</span> amqplib<span class="token punctuation">.</span><span class="token function">connect</span><span class="token punctuation">(</span><span class="token string">&#39;amqp://localhost&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">const</span> loggerChannel <span class="token operator">=</span> <span class="token keyword">await</span> conn<span class="token punctuation">.</span><span class="token function">createChannel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">await</span> loggerChannel<span class="token punctuation">.</span><span class="token function">assertQueue</span><span class="token punctuation">(</span><span class="token string">&#39;logger&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    loggerChannel<span class="token punctuation">.</span><span class="token function">consume</span><span class="token punctuation">(</span><span class="token string">&#39;logger&#39;</span><span class="token punctuation">,</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">event</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">const</span> message <span class="token operator">=</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>event<span class="token punctuation">.</span>content<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">await</span> fs<span class="token punctuation">.</span><span class="token function">appendFile</span><span class="token punctuation">(</span>path<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">&#39;logger.txt&#39;</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>message<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&#39;\\n&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="_8-serverless" tabindex="-1"><a class="header-anchor" href="#_8-serverless"><span>8.Serverless</span></a></h2><h3 id="_8-1-bff问题" tabindex="-1"><a class="header-anchor" href="#_8-1-bff问题"><span>8.1 BFF问题</span></a></h3><ul><li>复杂性增加：添加 BFF 层会增加系统的复杂性，因为它需要在后端 API 和前端应用程序之间处理请求和响应</li><li>性能问题：如果 BFF 层的实现不当，可能会导致性能问题，因为它需要在后端 API 和前端应用程序之间传输大量数据</li><li>安全风险：如果 BFF 层未得到正确保护，可能会导致安全风险，因为它可能会暴露敏感数据</li><li>维护成本：BFF 层需要维护和更新，这会增加维护成本</li><li>测试复杂性：由于 BFF 层需要在后端 API 和前端应用程序之间进行测试，因此测试可能会变得更加复杂</li><li>运维问题 要求有强大的日志、服务器监控、性能监控、负载均衡、备份冗灾、监控报警和弹性伸缩扩容等</li></ul><h3 id="_8-2-serverless" tabindex="-1"><a class="header-anchor" href="#_8-2-serverless"><span>8.2 Serverless</span></a></h3><ul><li>这些问题可以通过<a href="https://docs.cloudbase.net/" target="_blank" rel="noopener noreferrer">Serverless</a>来解决</li><li>Serverless = Faas (Function as a service) + Baas (Backend as a service)</li><li>FaaS（Function-as-a-Service）是服务商提供一个平台、提供给用户开发、运行管理这些函数的功能，而无需搭建和维护基础框架，是一种事件驱动由消息触发的函数服务</li><li>BaaS（Backend-as-a-Service）后端即服务，包含了后端服务组件，它是基于 API 的第三方服务，用于实现应用程序中的核心功能，包含常用的数据库、对象存储、消息队列、日志服务等等</li></ul><p><img src="https://static.zhufengpeixun.com/fassbass_1673160507846.png" alt=""></p><p><img src="https://static.zhufengpeixun.com/Serverless_1673160406503.png" alt=""></p><h3 id="_8-3-serverless的优势" tabindex="-1"><a class="header-anchor" href="#_8-3-serverless的优势"><span>8.3 Serverless的优势</span></a></h3><ul><li>节省成本：在传统架构中，你需要为应用程序所使用的服务器付费，即使它们没有被使用。在 Serverless 架构中，你仅需为实际使用的资源付费，这可以节省大量成本</li><li>更快的开发周期：Serverless 架构允许开发人员更快地构建和部署应用程序，因为它们可以更快地获得所需的资源</li><li>更好的可伸缩性：Serverless 架构可以自动扩展来满足增长的流量需求，无需人工干预</li><li>更好的可维护性：在 Serverless 架构中，你无需担心底层基础架构的维护，因为这些工作由云服务提供商负责</li><li>更高的可用性：由于 Serverless 架构具有自动扩展功能，因此它可以更好地应对突发流量，从而提高应用程序的可用性</li></ul><h3 id="_8-4-serverless的缺点" tabindex="-1"><a class="header-anchor" href="#_8-4-serverless的缺点"><span>8.4 Serverless的缺点</span></a></h3><ul><li>复杂性：Serverless 架构可能会使应用程序的体系结构变得更加复杂，因为它需要将应用程序拆分为许多小型函数</li><li>性能问题：在某些情况下，Serverless 架构可能会导致性能问题，因为函数执行需要额外的时间来启动和终止</li><li>限制：每个函数都有资源限制，因此需要仔细规划应用程序的体系结构，以免超出这些限制</li><li>依赖云服务提供商：使用 Serverless 架构需要依赖云服务提供商，因此如果这些服务出现故障，可能会对应用程序造成影响</li><li>调试困难：由于 Serverless 架构使用许多小型函数，因此调试可能会变得更加困难</li></ul><h2 id="_9-graphql" tabindex="-1"><a class="header-anchor" href="#_9-graphql"><span>9.GraphQL</span></a></h2><ul><li><code>GraphQL</code>是一种用于API的查询语言，它允许客户端向服务端请求特定的数据，而不是服务端将所有可能的数据全部返回。这样，客户端可以更精确地获取所需的数据，并且服务端可以更有效地满足请求</li><li><code>GraphQL</code>可以让客户端自己定义所需的数据结构，可以灵活地获取所需的数据。这对于多端应用来说非常方便，因为每一个客户端可能有不同的数据需求，使用GraphQL可以让每个客户端自己定义所需的数据结构</li><li><code>GraphQL</code>可以让BFF服务层从不同的数据源获取数据，并将它们组合起来返回给客户端。这对于在BFF架构中更好地组织数据是很有帮助的，因为你可以在BFF层中组合来自不同数据源的数据，而不用在客户端中再做一次组合</li></ul><h3 id="_9-1-apollo-server" tabindex="-1"><a class="header-anchor" href="#_9-1-apollo-server"><span>9.1 Apollo Server</span></a></h3><ul><li><code>Apollo Server</code>是一个用于构建GraphQL API的开源服务器框架。它支持多种编程语言，允许你使用同一种方式来访问不同的后端数据源，并且具有良好的扩展性</li><li><code>Apollo Server</code>是一种实现GraphQL服务端的方法，它提供了一些工具和功能，帮助你更轻松地构建和部署GraphQL API。它还提供了一些额外的功能，如缓存、身份验证和模拟数据，帮助你更快速地开发和测试你的API</li></ul><h3 id="_9-2-graphql-schema-language" tabindex="-1"><a class="header-anchor" href="#_9-2-graphql-schema-language"><span>9.2 GraphQL schema language</span></a></h3><ul><li><a href="https://graphql.org/learn/schema/" target="_blank" rel="noopener noreferrer">schema</a></li><li><code>GraphQL schema language</code>是一种用来定义GraphQL API的语言。它可以用来描述API中可用的数据和操作，包括支持的查询、变更、订阅等功能</li><li><code>GraphQL schema</code>由一系列的类型组成，每种类型都有一个名称和一些字段。每个字段都有一个名称和类型，并可能有一些额外的限制，比如是否是必填的或者有默认值</li></ul><h3 id="_9-3-resolvers" tabindex="-1"><a class="header-anchor" href="#_9-3-resolvers"><span>9.3 resolvers</span></a></h3><ul><li><a href="https://www.apollographql.com/docs/apollo-server/data/resolvers/" target="_blank" rel="noopener noreferrer">resolvers</a></li><li>在GraphQL中，<code>resolvers</code>是负责解析每个字段的函数。在Apollo Server中，你可以使用resolvers对象来定义这些函数</li><li><code>resolvers</code>对象是一个包含了所有解析器函数的对象。它的结构与你在schema中定义的类型的结构是一样的</li><li>除了定义解析器函数以外，你还可以在resolvers对象中定义自定义操作，例如查询、变更、订阅等。这些操作的解析器函数与字段的解析器函数的定义方式是一样的，只是函数名称不同而已</li></ul><h3 id="_9-4-apolloserver示例" tabindex="-1"><a class="header-anchor" href="#_9-4-apolloserver示例"><span>9.4 ApolloServer示例</span></a></h3><ul><li><code>gql</code>函数是一个<code>template tag</code>，你可以将它放在模板字符串的前面，然后在模板字符串中编写GraphQL schema language的代码,可以定义查询和变更操作</li><li>resolvers函数参数 <ul><li>obj：表示当前查询的父对象。例如，如果你在查询&quot;user&quot;类型的对象，那么obj就表示当前查询的&quot;user&quot;对象</li><li>args：表示当前查询的参数。例如，如果你在查询带有参数的字段，那么args就表示这些参数</li><li>context：表示当前的上下文对象，可以在整个查询中传递给所有的resolver</li><li>info：表示当前的查询信息，包括查询字符串、查询操作（query/mutation）、查询字段等</li></ul></li></ul><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code class="language-javascript"><span class="line"><span class="token keyword">const</span> <span class="token punctuation">{</span> ApolloServer<span class="token punctuation">,</span> gql <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&#39;apollo-server&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">const</span> typeDefs <span class="token operator">=</span> gql<span class="token template-string"><span class="token template-punctuation string">\`</span><span class="token string"></span>
<span class="line">  type Query {</span>
<span class="line">    users: [User]</span>
<span class="line">    user(id: ID): User</span>
<span class="line">  }</span>
<span class="line">  type Mutation {</span>
<span class="line">    createUser(username: String, age: Int): User</span>
<span class="line">    updateUser(id: ID, username: String, age: Int): Boolean</span>
<span class="line">    deleteUser(id: ID): Boolean</span>
<span class="line">  }</span>
<span class="line">  type User {</span>
<span class="line">    id: ID</span>
<span class="line">    username: String</span>
<span class="line">    age: Int</span>
<span class="line">  }</span>
<span class="line"></span><span class="token template-punctuation string">\`</span></span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">let</span> users <span class="token operator">=</span> <span class="token punctuation">[</span></span>
<span class="line">    <span class="token punctuation">{</span> <span class="token literal-property property">id</span><span class="token operator">:</span> <span class="token string">&quot;1&quot;</span><span class="token punctuation">,</span> <span class="token literal-property property">username</span><span class="token operator">:</span> <span class="token string">&quot;zhangsan&quot;</span><span class="token punctuation">,</span> <span class="token literal-property property">age</span><span class="token operator">:</span> <span class="token number">25</span> <span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token punctuation">{</span> <span class="token literal-property property">id</span><span class="token operator">:</span> <span class="token string">&quot;2&quot;</span><span class="token punctuation">,</span> <span class="token literal-property property">username</span><span class="token operator">:</span> <span class="token string">&quot;lisi&quot;</span><span class="token punctuation">,</span> <span class="token literal-property property">age</span><span class="token operator">:</span> <span class="token number">30</span> <span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line"><span class="token punctuation">]</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">const</span> resolvers <span class="token operator">=</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token literal-property property">Query</span><span class="token operator">:</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token function-variable function">users</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token parameter">obj<span class="token punctuation">,</span> args<span class="token punctuation">,</span> context<span class="token punctuation">,</span> info</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token keyword">return</span> users<span class="token punctuation">;</span></span>
<span class="line">        <span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">        <span class="token function-variable function">user</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token parameter">obj<span class="token punctuation">,</span> args<span class="token punctuation">,</span> context<span class="token punctuation">,</span> info</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token keyword">return</span> users<span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span><span class="token parameter">user</span> <span class="token operator">=&gt;</span> user<span class="token punctuation">.</span>id <span class="token operator">===</span> args<span class="token punctuation">.</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">    <span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token literal-property property">Mutation</span><span class="token operator">:</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token function-variable function">createUser</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token parameter">obj<span class="token punctuation">,</span> args<span class="token punctuation">,</span> context<span class="token punctuation">,</span> info</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token keyword">const</span> newUser <span class="token operator">=</span> <span class="token punctuation">{</span> <span class="token literal-property property">id</span><span class="token operator">:</span> users<span class="token punctuation">.</span>length <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token literal-property property">username</span><span class="token operator">:</span> args<span class="token punctuation">.</span>username<span class="token punctuation">,</span> <span class="token literal-property property">age</span><span class="token operator">:</span> args<span class="token punctuation">.</span>age <span class="token punctuation">}</span><span class="token punctuation">;</span></span>
<span class="line">            users<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>newUser<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">            <span class="token keyword">return</span> newUser<span class="token punctuation">;</span></span>
<span class="line">        <span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">        <span class="token function-variable function">updateUser</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token parameter">obj<span class="token punctuation">,</span> args<span class="token punctuation">,</span> context<span class="token punctuation">,</span> info</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token keyword">const</span> updatedUser <span class="token operator">=</span> <span class="token punctuation">{</span> <span class="token literal-property property">id</span><span class="token operator">:</span> args<span class="token punctuation">.</span>id<span class="token punctuation">,</span> <span class="token literal-property property">username</span><span class="token operator">:</span> args<span class="token punctuation">.</span>username<span class="token punctuation">,</span> <span class="token literal-property property">age</span><span class="token operator">:</span> args<span class="token punctuation">.</span>age <span class="token punctuation">}</span><span class="token punctuation">;</span></span>
<span class="line">            users <span class="token operator">=</span> users<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token parameter">user</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></span>
<span class="line">                <span class="token keyword">if</span> <span class="token punctuation">(</span>user<span class="token punctuation">.</span>id <span class="token operator">===</span> args<span class="token punctuation">.</span>id<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">                    <span class="token keyword">return</span> updatedUser<span class="token punctuation">;</span></span>
<span class="line">                <span class="token punctuation">}</span></span>
<span class="line">                <span class="token keyword">return</span> user<span class="token punctuation">;</span></span>
<span class="line">            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">            <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">        <span class="token function-variable function">deleteUser</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token parameter">obj<span class="token punctuation">,</span> args<span class="token punctuation">,</span> context<span class="token punctuation">,</span> info</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></span>
<span class="line">            users <span class="token operator">=</span> users<span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span><span class="token parameter">user</span> <span class="token operator">=&gt;</span> user<span class="token punctuation">.</span>id <span class="token operator">!==</span> args<span class="token punctuation">.</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">            <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line"><span class="token punctuation">}</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">const</span> server <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ApolloServer</span><span class="token punctuation">(</span><span class="token punctuation">{</span> typeDefs<span class="token punctuation">,</span> resolvers <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">server<span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> url <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></span>
<span class="line">    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">\`</span><span class="token string">Server ready at </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">\${</span>url<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">\`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code class="language-javascript"><span class="line">query <span class="token punctuation">{</span></span>
<span class="line">    users <span class="token punctuation">{</span></span>
<span class="line">        id</span>
<span class="line">        username</span>
<span class="line">        age</span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line">query <span class="token punctuation">{</span></span>
<span class="line">    <span class="token function">user</span><span class="token punctuation">(</span>id<span class="token operator">:</span> <span class="token string">&quot;1&quot;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        id</span>
<span class="line">        username</span>
<span class="line">        age</span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line">mutation <span class="token punctuation">{</span></span>
<span class="line">    <span class="token function">createUser</span><span class="token punctuation">(</span>username<span class="token operator">:</span> <span class="token string">&quot;wangwu&quot;</span><span class="token punctuation">,</span> <span class="token literal-property property">age</span><span class="token operator">:</span> <span class="token number">35</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        id</span>
<span class="line">        username</span>
<span class="line">        age</span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line">mutation <span class="token punctuation">{</span></span>
<span class="line">    <span class="token function">updateUser</span><span class="token punctuation">(</span>id<span class="token operator">:</span> <span class="token string">&quot;1&quot;</span><span class="token punctuation">,</span> <span class="token literal-property property">username</span><span class="token operator">:</span> <span class="token string">&quot;zhangsan2&quot;</span><span class="token punctuation">,</span> <span class="token literal-property property">age</span><span class="token operator">:</span> <span class="token number">26</span><span class="token punctuation">)</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line">mutation <span class="token punctuation">{</span></span>
<span class="line">    <span class="token function">deleteUser</span><span class="token punctuation">(</span>id<span class="token operator">:</span> <span class="token string">&quot;1&quot;</span><span class="token punctuation">)</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_9-5-apollo-server-koa" tabindex="-1"><a class="header-anchor" href="#_9-5-apollo-server-koa"><span>9.5 Apollo Server Koa</span></a></h3><ul><li>Apollo Server Koa 是一个基于 Koa 的中间件，可以将 <code>GraphQL API</code> 添加到 Koa 应用程序中。它使用 <code>Apollo Server</code> 来执行 <code>GraphQL</code> 服务器逻辑，并允许使用 Koa 的优秀特性（如路由和中间件）来构建应用程序</li></ul><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code class="language-javascript"><span class="line"><span class="token keyword">const</span> Koa <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&#39;koa&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">const</span> <span class="token punctuation">{</span> ApolloServer <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&#39;apollo-server-koa&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">const</span> typeDefs <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">\`</span><span class="token string"></span>
<span class="line">  type Query {</span>
<span class="line">    hello: String</span>
<span class="line">  }</span>
<span class="line"></span><span class="token template-punctuation string">\`</span></span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">const</span> resolvers <span class="token operator">=</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token literal-property property">Query</span><span class="token operator">:</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token function-variable function">hello</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token string">&#39;Hello, world!&#39;</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line"><span class="token punctuation">}</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">const</span> server <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ApolloServer</span><span class="token punctuation">(</span><span class="token punctuation">{</span> typeDefs<span class="token punctuation">,</span> resolvers <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">await</span> server<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token keyword">const</span> app <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Koa</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    server<span class="token punctuation">.</span><span class="token function">applyMiddleware</span><span class="token punctuation">(</span><span class="token punctuation">{</span> app <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    app<span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token literal-property property">port</span><span class="token operator">:</span> <span class="token number">4000</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span></span>
<span class="line">        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">\`</span><span class="token string">🚀 Server ready at http://localhost:4000</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">\${</span>server<span class="token punctuation">.</span>graphqlPath<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">\`</span></span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line"></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div>`,134)])])}const i=s(t,[["render",l]]),u=JSON.parse('{"path":"/strong/160.bff.html","title":"","lang":"en-US","frontmatter":{},"git":{"updatedTime":1681290319000,"contributors":[{"name":"yutao","username":"yutao","email":"642231346@qq.com","commits":1,"url":"https://github.com/yutao"}],"changelog":[{"hash":"f5ab8c9d34991ec274f7f652439afe5b2afb6147","time":1681290319000,"email":"642231346@qq.com","author":"yutao","message":"modify"}]},"filePathRelative":"strong/160.bff.md"}');export{i as comp,u as data};
