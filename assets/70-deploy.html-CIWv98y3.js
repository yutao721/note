import{_ as n,c as a,a as e,o as p}from"./app-CD1YpnS1.js";const l={};function t(o,s){return p(),a("div",null,[...s[0]||(s[0]=[e(`<h2 id="_1-准备工作" tabindex="-1"><a class="header-anchor" href="#_1-准备工作"><span>1. 准备工作</span></a></h2><ul><li>建议从<a href="https://dc.console.aliyun.com/next/index" target="_blank" rel="noopener noreferrer">阿里云</a>购买域名</li><li>建议从<a href="https://ecs.console.aliyun.com" target="_blank" rel="noopener noreferrer">阿里云</a>购买ECS服务器</li><li>建议从<a href="https://bsn.console.aliyun.com" target="_blank" rel="noopener noreferrer">阿里云</a>进行备案</li></ul><h2 id="_2-配置ecs服务器" tabindex="-1"><a class="header-anchor" href="#_2-配置ecs服务器"><span>2. 配置ECS服务器</span></a></h2><ul><li>配置root密码</li><li>配置安全规则</li></ul><h2 id="_3-登录服务器" tabindex="-1"><a class="header-anchor" href="#_3-登录服务器"><span>3. 登录服务器</span></a></h2><h3 id="_3-1-命令行登录" tabindex="-1"><a class="header-anchor" href="#_3-1-命令行登录"><span>3.1 命令行登录</span></a></h3><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code class="language-javascript"><span class="line">ssh root@<span class="token number">47.104</span><span class="token number">.191</span><span class="token number">.1</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><ul><li>当本机获得服务器公钥指纹，但是无法确认服务器安全性的时候会提示你是否要继续连接</li></ul><p><img src="http://img.zhufengpeixun.cn/2.ssh.png" alt="2.ssh.png"></p><h3 id="_3-2-ssh登录" tabindex="-1"><a class="header-anchor" href="#_3-2-ssh登录"><span>3.2 SSH登录</span></a></h3><h4 id="_3-2-1-新建用户" tabindex="-1"><a class="header-anchor" href="#_3-2-1-新建用户"><span>3.2.1 新建用户</span></a></h4><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text"><pre><code class="language-text"><span class="line">adduser devops</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><h4 id="_3-2-1-授与sudo权限" tabindex="-1"><a class="header-anchor" href="#_3-2-1-授与sudo权限"><span>3.2.1 授与sudo权限</span></a></h4><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text"><pre><code class="language-text"><span class="line">visudo</span>
<span class="line">devops ALL=(ALL:ALL) ALL  </span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div></div></div><ul><li>1 ALL 为允许使用<code>sudo</code>命令的主机</li><li>2 ALL devops可以以任意用户身份来执行命令</li><li>3 ALL devops可以以任意组身份来执行命令</li><li>4 ALL devops可以执行任意命令</li></ul><p>以下命令表示允许test用户从任何主机登录，以root的身份执行<code>/usr/sbin/useradd</code>命令</p><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text"><pre><code class="language-text"><span class="line">test ALL=(root) /usr/sbin/useradd</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><h3 id="_3-3-配置无密码登录" tabindex="-1"><a class="header-anchor" href="#_3-3-配置无密码登录"><span>3.3 配置无密码登录</span></a></h3><h4 id="_3-3-1-客户端" tabindex="-1"><a class="header-anchor" href="#_3-3-1-客户端"><span>3.3.1 客户端</span></a></h4><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code class="language-javascript"><span class="line">ssh<span class="token operator">-</span>keygen <span class="token operator">-</span>t rsa <span class="token operator">-</span>b <span class="token number">4096</span> <span class="token operator">-</span><span class="token constant">C</span> <span class="token string">&quot;83687401@qq.com&quot;</span></span>
<span class="line">cat <span class="token punctuation">.</span>ssh<span class="token operator">/</span>id_rsa<span class="token punctuation">.</span>pub</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_3-3-2-服务器端" tabindex="-1"><a class="header-anchor" href="#_3-3-2-服务器端"><span>3.3.2 服务器端</span></a></h4><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text"><pre><code class="language-text"><span class="line">ssh-keygen -t rsa -b 4096 -C &quot;83687401@qq.com&quot;</span>
<span class="line">vi ~/.ssh/authorized_keys</span>
<span class="line">chmod 644 ~/.ssh</span>
<span class="line">chmod 600 ~/.ssh/authorized_keys</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_3-4-修改ssh端口" tabindex="-1"><a class="header-anchor" href="#_3-4-修改ssh端口"><span>3.4 修改SSH端口</span></a></h3><p>/etc/ssh/sshd_config</p><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code class="language-javascript"><span class="line">Port <span class="token number">22222</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text"><pre><code class="language-text"><span class="line">systemctl restart sshd.service</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p><img src="http://img.zhufengpeixun.cn/outaddress.png" alt="outaddress"></p><ul><li>出方向: 是指ECS实例访问内网中其它实例或者公网的资源</li><li>入方向: 是指内网中的其它ECS实例 或公网上的资源访问ECS实例</li></ul><h2 id="_4-docker" tabindex="-1"><a class="header-anchor" href="#_4-docker"><span>4. docker</span></a></h2><h3 id="_4-1-为什么使用docker" tabindex="-1"><a class="header-anchor" href="#_4-1-为什么使用docker"><span>4.1 为什么使用docker?</span></a></h3><ul><li>境部署是所有团队都必须面对的问题，随着系统越来越大，依赖的服务也越来越多，例如：Web服务器 + MySql数据库 + Redis缓存等</li><li>依赖服务很多，本地搭建一套环境成本越来越高，初级人员很难解决环境部署中的一些问题</li><li>服务的版本差异及OS的差异都可能导致线上环境BUG，项目引入新的服务时所有人的环境需要重新配置</li><li>任何安装过Docker的机器都可以运行这个容器可以获得同样的结果,从而完全消除了不同环境，不同版本可能引起的各种问题</li></ul><h3 id="_4-2-docker中的概念" tabindex="-1"><a class="header-anchor" href="#_4-2-docker中的概念"><span>4.2 docker中的概念</span></a></h3><ul><li>Docker有三个基本概念：镜像(image),容器(container),仓库(repository)</li></ul><table><thead><tr><th style="text-align:left;">概念</th><th style="text-align:left;">说明</th></tr></thead><tbody><tr><td style="text-align:left;">镜像(image)</td><td style="text-align:left;">镜像中包含有需要运行的文件。镜像用来创建container，一个镜像可以运行多个container；镜像可以通过Dockerfile创建，也可以从Docker hub/registry上下载</td></tr><tr><td style="text-align:left;">容器(container)</td><td style="text-align:left;">容器是Docker的运行组件，启动一个镜像就是一个容器，容器是一个隔离环境，多个容器之间不会相互影响，保证容器中的程序运行在一个相对安全的环境中</td></tr><tr><td style="text-align:left;">仓库(repository)</td><td style="text-align:left;">共享和管理Docker镜像，用户可以上传或者下载上面的镜像，官方地址为 registry.hub.docker.com/ （类似于github对源代码的管理），也可以搭建自己私有的Docker registry</td></tr></tbody></table><p><img src="http://img.zhufengpeixun.cn/docker-arch.jpg" alt="docker-arch"></p><h3 id="_4-3-常见docker命令" tabindex="-1"><a class="header-anchor" href="#_4-3-常见docker命令"><span>4.3 常见docker命令</span></a></h3><table><thead><tr><th style="text-align:left;">概念</th><th style="text-align:left;">说明</th></tr></thead><tbody><tr><td style="text-align:left;">拉取镜像</td><td style="text-align:left;">docker pull centos</td></tr><tr><td style="text-align:left;">创建新容器并运行</td><td style="text-align:left;">docker run --name mynginx -d nginx:latest</td></tr><tr><td style="text-align:left;">启动容器</td><td style="text-align:left;">docker start container_name/container_id</td></tr><tr><td style="text-align:left;">停止容器</td><td style="text-align:left;">docker stop container_name/container_id</td></tr><tr><td style="text-align:left;">重启容器</td><td style="text-align:left;">docker restart container_name/container_id</td></tr><tr><td style="text-align:left;">在容器中开启交互终端</td><td style="text-align:left;">docker exec -i -t container_id /bin/bash</td></tr><tr><td style="text-align:left;">使用当前目录Dockerfile创建镜像,标签为xxx:v1</td><td style="text-align:left;">docker build -t xxx:v1</td></tr></tbody></table><h3 id="_4-4-安装docker" tabindex="-1"><a class="header-anchor" href="#_4-4-安装docker"><span>4.4 安装docker</span></a></h3><ul><li>docker分为企业版(EE)和社区版(CE)</li></ul><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code class="language-javascript"><span class="line">$ yum install <span class="token operator">-</span>y yum<span class="token operator">-</span>utils   device<span class="token operator">-</span>mapper<span class="token operator">-</span>persistent<span class="token operator">-</span>data   lvm2</span>
<span class="line">$ yum<span class="token operator">-</span>config<span class="token operator">-</span>manager     <span class="token operator">--</span>add<span class="token operator">-</span>repo     https<span class="token operator">:</span><span class="token operator">/</span><span class="token operator">/</span>download<span class="token punctuation">.</span>docker<span class="token punctuation">.</span>com<span class="token operator">/</span>linux<span class="token operator">/</span>centos<span class="token operator">/</span>docker<span class="token operator">-</span>ce<span class="token punctuation">.</span>repo</span>
<span class="line">$ yum install <span class="token operator">-</span>y docker<span class="token operator">-</span>ce docker<span class="token operator">-</span>ce<span class="token operator">-</span>cli containerd<span class="token punctuation">.</span>io</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_4-5-启动docker" tabindex="-1"><a class="header-anchor" href="#_4-5-启动docker"><span>4.5 启动docker</span></a></h3><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text"><pre><code class="language-text"><span class="line">$ systemctl start docker</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><h3 id="_4-6-查看docker版本" tabindex="-1"><a class="header-anchor" href="#_4-6-查看docker版本"><span>4.6 查看docker版本</span></a></h3><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text"><pre><code class="language-text"><span class="line">$ docker version</span>
<span class="line">$ docker info</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_4-7-docker-compose" tabindex="-1"><a class="header-anchor" href="#_4-7-docker-compose"><span>4.7 docker-compose</span></a></h3><ul><li>实际项目不可能只单单依赖于一个服务，例如一个常见的Web项目可能依赖于: 静态文件服务器，应用服务器，Mysql数据库等</li><li>我们可以通过分别启动单个镜像，并把镜像绑定到本地对应端口的形式进行部署，达到容器可通信的目的</li><li>但是为了更方便的管理多容器的情况，官方提供了docker-compose的方式</li><li>docker-compose是Docker的一种编排服务，是一个用于在 Docker 上定义并运行复杂应用的工具，可以让用户在集群中部署分布式应用</li><li>一个项目可以由多个服务（容器）关联而成，compose 面向项目进行管理，通过子命令对项目中的一组容器进行便捷地生命周期管理</li><li>compose中有两个重要的概念 <ul><li>服务 (service)：一个应用的容器，实际上可以包括若干运行相同镜像的容器实例</li><li>项目 (project)：由一组关联的应用容器组成的一个完整业务单元，在docker-compose.yml 文件中定义</li></ul></li></ul><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code class="language-javascript"><span class="line">curl <span class="token operator">-</span><span class="token constant">L</span> <span class="token string">&quot;https://github.com/docker/compose/releases/download/1.23.2/docker-compose-$(uname -s)-$(uname -m)&quot;</span> <span class="token operator">-</span>o <span class="token operator">/</span>usr<span class="token operator">/</span>local<span class="token operator">/</span>bin<span class="token operator">/</span>docker<span class="token operator">-</span>compose</span>
<span class="line">chmod <span class="token operator">+</span>x <span class="token operator">/</span>usr<span class="token operator">/</span>local<span class="token operator">/</span>bin<span class="token operator">/</span>docker<span class="token operator">-</span>compose</span>
<span class="line">docker<span class="token operator">-</span>compose <span class="token operator">--</span>version</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_4-8-阿里云加速" tabindex="-1"><a class="header-anchor" href="#_4-8-阿里云加速"><span>4.8 阿里云加速</span></a></h3><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text"><pre><code class="language-text"><span class="line">sudo mkdir -p /etc/docker</span>
<span class="line">sudo tee /etc/docker/daemon.json &lt;&lt;-&#39;EOF&#39;</span>
<span class="line">{</span>
<span class="line">  &quot;registry-mirrors&quot;: [&quot;https://fwvjnv59.mirror.aliyuncs.com&quot;]</span>
<span class="line">}</span>
<span class="line">EOF</span>
<span class="line"> </span>
<span class="line">sudo systemctl daemon-reload</span>
<span class="line">sudo systemctl restart docker</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="_5-整体架构" tabindex="-1"><a class="header-anchor" href="#_5-整体架构"><span>5.整体架构</span></a></h2><h3 id="_5-1-前端架构" tabindex="-1"><a class="header-anchor" href="#_5-1-前端架构"><span>5.1 前端架构</span></a></h3><ul><li>用户在浏览器里输入前端项目的虚拟IP地址</li><li>这个虚拟IP可能会被某个keepalived容器抢占</li><li>这个keepalived容器会让负载均衡的nginx服务器请求前端项目的nginx集群</li><li>前端项目调用的接口是后端项目的虚拟IP</li></ul><p><img src="http://img.zhufengpeixun.cn/frontdeploy.jpg" alt="frontdeploy"></p><h3 id="_5-2-后端架构" tabindex="-1"><a class="header-anchor" href="#_5-2-后端架构"><span>5.2 后端架构</span></a></h3><ul><li>前端项目会访问这个后端的虚拟IP</li><li>这个虚拟IP可能会被某个keepalived容器抢占</li><li>这个请求会转发到keepalived容器上的负载均衡节点上</li><li>负载均衡节点会把请求转发的node集群的某个节点上</li><li>node服务器可能需要访问mysql、mongodb、redis服务器</li></ul><p><img src="http://img.zhufengpeixun.cn/backdeployee.jpg" alt="backdeployee"></p><h3 id="_5-3-mysql数据库集群" tabindex="-1"><a class="header-anchor" href="#_5-3-mysql数据库集群"><span>5.3 mysql数据库集群</span></a></h3><ul><li>数据库的虚拟IP是192.168.100.200,web服务器如果想访问数据库需要连接这个IP</li><li>虚拟IP收到请求后会把请求转交给docker容器内的一个虚拟IP192.168.200.200上</li><li>Docker内的虚拟IP不能被外网使用，所以需要借助宿主机keepalived映射成外网可以访问的虚拟IP</li><li>此处配置了双机热备方案，如果第一个容器抢占了这个虚拟IP192.168.100.200</li><li>这个虚拟IP会把请求转发给此容器内的haproxy节点上</li><li>haproxy节点会把请求转发给MYSQL数据库集群中的某个节点上</li></ul><p><img src="http://img.zhufengpeixun.cn/mysqlcluster3.jpg" alt="mysqlcluster2"></p><h3 id="_5-4-mongodb数据库集群" tabindex="-1"><a class="header-anchor" href="#_5-4-mongodb数据库集群"><span>5.4 mongodb数据库集群</span></a></h3><h4 id="_5-4-1-主从复制" tabindex="-1"><a class="header-anchor" href="#_5-4-1-主从复制"><span>5.4.1 主从复制</span></a></h4><ul><li>主从复制是一个简单的数据库同步备份的集群技术</li><li>在数据库集群中要明确知道谁是主服务器，主服务器只有一台</li><li>从服务器要知道自己的数据源也就是知道自己的主服务器是谁</li></ul><p><img src="http://img.zhufengpeixun.cn/masterslave.jpg" alt="masterslave"></p><h4 id="_5-4-2-副本集" tabindex="-1"><a class="header-anchor" href="#_5-4-2-副本集"><span>5.4.2 副本集</span></a></h4><ul><li>MongoDB复制是将数据同步在多个服务器的过程。</li><li>复制提供了数据的冗余备份，并在多个服务器上存储数据副本，提高了数据的可用性， 并可以保证数据的安全性。</li><li>复制还允许您从硬件故障和服务中断中恢复数据。</li></ul><p><img src="http://img.zhufengpeixun.cn/replication.png" alt="replication"></p><h4 id="_5-4-3-分片" tabindex="-1"><a class="header-anchor" href="#_5-4-3-分片"><span>5.4.3 分片</span></a></h4><ul><li>在Mongodb里面存在另一种集群，就是分片技术,可以满足MongoDB数据量大量增长的需求</li><li>当MongoDB存储海量的数据时，一台机器可能不足以存储数据，也可能不足以提供可接受的读写吞吐量。这时，我们就可以通过在多台机器上分割数据，使得数据库系统能存储和处理更多的数据</li></ul><p><img src="http://img.zhufengpeixun.cn/sharding.png" alt="sharding"></p><h3 id="_5-5-redis数据库集群" tabindex="-1"><a class="header-anchor" href="#_5-5-redis数据库集群"><span>5.5 redis数据库集群</span></a></h3><ul><li>Redis-Cluster采用无中心结构，每个节点保存数据和整个集群状态,每个节点都和其他所有节点连接</li><li>所有的redis节点彼此互联(PING-PONG机制),内部使用二进制协议优化传输速度和带宽</li><li>客户端与redis节点直连,不需要中间proxy层.客户端不需要连接集群所有节点,连接集群中任何一个可用节点即可</li></ul><p><img src="http://img.zhufengpeixun.cn/redisconfig.jpg" alt="redisconfig"></p><h2 id="_6-mysql集群" tabindex="-1"><a class="header-anchor" href="#_6-mysql集群"><span>6.mysql集群</span></a></h2><ul><li><a href="https://hub.docker.com/r/percona/percona-xtradb-cluster/" target="_blank" rel="noopener noreferrer">percona-xtradb-cluster</a></li><li><a href="https://www.percona.com/doc/percona-xtradb-cluster/LATEST/install/docker.html" target="_blank" rel="noopener noreferrer">percona-xtradb-cluster官方文档</a></li><li>PXC的数据是强一致性的，要么所有节点都提交，要么都不提交</li></ul><p><img src="http://img.zhufengpeixun.cn/pxccluster.jpg" alt="pxccluster"></p><table><thead><tr><th style="text-align:left;">端口</th><th style="text-align:left;">描述</th></tr></thead><tbody><tr><td style="text-align:left;">3306</td><td style="text-align:left;">MYSQL服务端口</td></tr><tr><td style="text-align:left;">4444</td><td style="text-align:left;">请求全量同步(SST)接口</td></tr><tr><td style="text-align:left;">4567</td><td style="text-align:left;">数据库节点之间的通信接口</td></tr><tr><td style="text-align:left;">4568</td><td style="text-align:left;">请求增量同步(IST)端口</td></tr></tbody></table><h3 id="_6-1-安装集群" tabindex="-1"><a class="header-anchor" href="#_6-1-安装集群"><span>6.1 安装集群</span></a></h3><h4 id="_6-1-1-下载镜像" tabindex="-1"><a class="header-anchor" href="#_6-1-1-下载镜像"><span>6.1.1 下载镜像</span></a></h4><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code class="language-javascript"><span class="line">docker pull percona<span class="token operator">/</span>percona<span class="token operator">-</span>xtradb<span class="token operator">-</span>cluster<span class="token operator">:</span><span class="token number">5.6</span></span>
<span class="line">docker tag percona<span class="token operator">/</span>percona<span class="token operator">-</span>xtradb<span class="token operator">-</span>cluster<span class="token operator">:</span><span class="token number">5.6</span> pxc</span>
<span class="line">docker image rm percona<span class="token operator">/</span>percona<span class="token operator">-</span>xtradb<span class="token operator">-</span>cluster<span class="token operator">:</span><span class="token number">5.6</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_6-1-2-创建内部网络" tabindex="-1"><a class="header-anchor" href="#_6-1-2-创建内部网络"><span>6.1.2 创建内部网络</span></a></h4><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code class="language-javascript"><span class="line">docker network create <span class="token operator">--</span>subnet<span class="token operator">=</span><span class="token number">172.18</span><span class="token number">.0</span><span class="token number">.0</span><span class="token operator">/</span><span class="token number">24</span> znet </span>
<span class="line">docker network inspect znet</span>
<span class="line">docker network rm znet</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_6-1-3-创建docker卷" tabindex="-1"><a class="header-anchor" href="#_6-1-3-创建docker卷"><span>6.1.3 创建docker卷</span></a></h4><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text"><pre><code class="language-text"><span class="line">docker volume create --name v1</span>
<span class="line">docker volume create --name v2</span>
<span class="line">docker volume create --name v3</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_6-1-4-创建pxc容器" tabindex="-1"><a class="header-anchor" href="#_6-1-4-创建pxc容器"><span>6.1.4 创建pxc容器</span></a></h4><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code class="language-javascript"><span class="line">docker run <span class="token operator">-</span>d \\</span>
<span class="line"><span class="token operator">-</span>p <span class="token number">3306</span><span class="token operator">:</span><span class="token number">3306</span> \\</span>
<span class="line"><span class="token operator">-</span>e <span class="token constant">MYSQL_ROOT_PASSWORD</span><span class="token operator">=</span><span class="token number">123456</span> \\</span>
<span class="line"><span class="token operator">-</span>e <span class="token constant">CLUSTER_NAME</span><span class="token operator">=</span><span class="token constant">PXC</span> \\</span>
<span class="line"><span class="token operator">-</span>e <span class="token constant">XTRABACKUP_PASSWORD</span><span class="token operator">=</span><span class="token number">123456</span> \\</span>
<span class="line"><span class="token operator">-</span>v v1<span class="token operator">:</span><span class="token operator">/</span><span class="token keyword">var</span><span class="token operator">/</span>lib<span class="token operator">/</span>mysql \\</span>
<span class="line"><span class="token operator">--</span>privileged \\</span>
<span class="line"><span class="token operator">--</span>name<span class="token operator">=</span>mysql1 \\</span>
<span class="line"><span class="token operator">--</span>net<span class="token operator">=</span>znet \\</span>
<span class="line"><span class="token operator">--</span>ip <span class="token number">172.18</span><span class="token number">.0</span><span class="token number">.2</span> \\</span>
<span class="line">pxc</span>
<span class="line"></span>
<span class="line">docker exec <span class="token operator">-</span>it mysql1 bash</span>
<span class="line">docker logs mysql1</span>
<span class="line"></span>
<span class="line"></span>
<span class="line">docker run <span class="token operator">-</span>d \\</span>
<span class="line"><span class="token operator">-</span>p <span class="token number">3307</span><span class="token operator">:</span><span class="token number">3306</span> \\</span>
<span class="line"><span class="token operator">-</span>e <span class="token constant">MYSQL_ROOT_PASSWORD</span><span class="token operator">=</span><span class="token number">123456</span> \\</span>
<span class="line"><span class="token operator">-</span>e <span class="token constant">CLUSTER_NAME</span><span class="token operator">=</span><span class="token constant">PXC</span> \\</span>
<span class="line"><span class="token operator">-</span>e <span class="token constant">XTRABACKUP_PASSWORD</span><span class="token operator">=</span><span class="token number">123456</span> \\</span>
<span class="line"><span class="token operator">-</span>e <span class="token constant">CLUSTER_JOIN</span><span class="token operator">=</span>mysql1 \\</span>
<span class="line"><span class="token operator">-</span>v v2<span class="token operator">:</span><span class="token operator">/</span><span class="token keyword">var</span><span class="token operator">/</span>lib<span class="token operator">/</span>mysql \\</span>
<span class="line"><span class="token operator">--</span>privileged \\</span>
<span class="line"><span class="token operator">--</span>name<span class="token operator">=</span>mysql2 \\</span>
<span class="line"><span class="token operator">--</span>net<span class="token operator">=</span>znet \\</span>
<span class="line"><span class="token operator">--</span>ip <span class="token number">172.18</span><span class="token number">.0</span><span class="token number">.3</span> \\</span>
<span class="line">pxc</span>
<span class="line"></span>
<span class="line">docker run <span class="token operator">-</span>d \\</span>
<span class="line"><span class="token operator">-</span>p <span class="token number">3308</span><span class="token operator">:</span><span class="token number">3306</span> \\</span>
<span class="line"><span class="token operator">-</span>e <span class="token constant">MYSQL_ROOT_PASSWORD</span><span class="token operator">=</span><span class="token number">123456</span> \\</span>
<span class="line"><span class="token operator">-</span>e <span class="token constant">CLUSTER_NAME</span><span class="token operator">=</span><span class="token constant">PXC</span> \\</span>
<span class="line"><span class="token operator">-</span>e <span class="token constant">XTRABACKUP_PASSWORD</span><span class="token operator">=</span><span class="token number">123456</span> \\</span>
<span class="line"><span class="token operator">-</span>e <span class="token constant">CLUSTER_JOIN</span><span class="token operator">=</span>mysql1 \\</span>
<span class="line"><span class="token operator">-</span>v v3<span class="token operator">:</span><span class="token operator">/</span><span class="token keyword">var</span><span class="token operator">/</span>lib<span class="token operator">/</span>mysql \\</span>
<span class="line"><span class="token operator">--</span>privileged \\</span>
<span class="line"><span class="token operator">--</span>name<span class="token operator">=</span>mysql3 \\</span>
<span class="line"><span class="token operator">--</span>net<span class="token operator">=</span>znet \\</span>
<span class="line"><span class="token operator">--</span>ip <span class="token number">172.18</span><span class="token number">.0</span><span class="token number">.4</span> \\</span>
<span class="line">pxc</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><table><thead><tr><th style="text-align:left;">参数</th><th style="text-align:left;">含义</th></tr></thead><tbody><tr><td style="text-align:left;">-d</td><td style="text-align:left;">服务后台运行</td></tr><tr><td style="text-align:left;">-p</td><td style="text-align:left;">映射端口号</td></tr><tr><td style="text-align:left;">-e MYSQL_ROOT_PASSWORD=123456</td><td style="text-align:left;">指定容器内的数据库的root密码</td></tr><tr><td style="text-align:left;">-e CLUSTER_NAME=PXC</td><td style="text-align:left;">集群的名称</td></tr><tr><td style="text-align:left;">-e XTRABACKUP_PASSWORD=123456</td><td style="text-align:left;">备份密码</td></tr><tr><td style="text-align:left;">-v v1:/var/lib/mysql</td><td style="text-align:left;">把容器内的/var/lib/mysql目录映射为宿主机的数据卷</td></tr><tr><td style="text-align:left;">--privileged</td><td style="text-align:left;">自动获取权限</td></tr><tr><td style="text-align:left;">--name</td><td style="text-align:left;">指定容器的名称</td></tr><tr><td style="text-align:left;">--net</td><td style="text-align:left;">指定加入的网络</td></tr></tbody></table><h3 id="_6-2-负载均衡" tabindex="-1"><a class="header-anchor" href="#_6-2-负载均衡"><span>6.2 负载均衡</span></a></h3><ul><li>单节点处理所有请求负载高，性能差，所以我们要使用负载均衡</li><li>使用Haproxy做负载均衡，请求被均匀分发给每个节点，单节点负载低，性能好</li><li><a href="https://zhangge/5125.html" target="_blank" rel="noopener noreferrer">Haproxy</a>只是一个转发器</li></ul><p><img src="http://img.zhufengpeixun.cn/haproxymysql.jpg" alt="haproxymysql"></p><h4 id="_6-2-1-安装haproxy镜像" tabindex="-1"><a class="header-anchor" href="#_6-2-1-安装haproxy镜像"><span>6.2.1 安装haproxy镜像</span></a></h4><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text"><pre><code class="language-text"><span class="line">docker pull haproxy</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><h4 id="_6-2-2-创建配置文件" tabindex="-1"><a class="header-anchor" href="#_6-2-2-创建配置文件"><span>6.2.2 创建配置文件</span></a></h4><p>touch /home/devops/haproxy/haproxy.cfg</p><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text"><pre><code class="language-text"><span class="line">global</span>
<span class="line">     </span>
<span class="line">    chroot /usr/local/etc/haproxy</span>
<span class="line">     </span>
<span class="line">    log 127.0.0.1 local5 info</span>
<span class="line">     </span>
<span class="line">    daemon</span>
<span class="line">defaults</span>
<span class="line">    log    global</span>
<span class="line">    mode    http</span>
<span class="line">     </span>
<span class="line">    option    httplog</span>
<span class="line">     </span>
<span class="line">    option    dontlognull</span>
<span class="line">     </span>
<span class="line">    timeout connect 5000</span>
<span class="line">     </span>
<span class="line">    timeout client  50000</span>
<span class="line">     </span>
<span class="line">    timeout server  50000</span>
<span class="line"></span>
<span class="line"> </span>
<span class="line">listen  admin_stats</span>
<span class="line">     </span>
<span class="line">    bind  0.0.0.0:8888</span>
<span class="line">     </span>
<span class="line">    mode        http</span>
<span class="line">     </span>
<span class="line">    stats uri   /dbs</span>
<span class="line">     </span>
<span class="line">    stats realm     Global\\ statistics</span>
<span class="line">     </span>
<span class="line">    stats auth  admin:123456</span>
<span class="line"> </span>
<span class="line">listen  proxy-mysql</span>
<span class="line">     </span>
<span class="line">    bind  0.0.0.0:3306  </span>
<span class="line">     </span>
<span class="line">    mode  tcp</span>
<span class="line">     </span>
<span class="line">     </span>
<span class="line">     </span>
<span class="line">     </span>
<span class="line">     </span>
<span class="line">    balance  roundrobin</span>
<span class="line">     </span>
<span class="line">    option  tcplog</span>
<span class="line">     </span>
<span class="line">    option  mysql-check user haproxy</span>
<span class="line">    server  MySQL_1 172.18.0.2:3306 check weight 1 maxconn 2000  </span>
<span class="line">    server  MySQL_2 172.18.0.3:3306 check weight 1 maxconn 2000  </span>
<span class="line">    server  MySQL_3 172.18.0.4:3306 check weight 1 maxconn 2000 </span>
<span class="line">     </span>
<span class="line">    option  tcpka  </span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_6-2-3-创建haproxy容器" tabindex="-1"><a class="header-anchor" href="#_6-2-3-创建haproxy容器"><span>6.2.3 创建haproxy容器</span></a></h4><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code class="language-javascript"><span class="line">docker run <span class="token operator">-</span>it <span class="token operator">-</span>d <span class="token operator">-</span>p <span class="token number">4001</span><span class="token operator">:</span><span class="token number">8888</span> <span class="token operator">-</span>p <span class="token number">4002</span><span class="token operator">:</span><span class="token number">3306</span> <span class="token operator">-</span>v <span class="token operator">/</span>home<span class="token operator">/</span>devops<span class="token operator">/</span>haproxy<span class="token operator">:</span><span class="token operator">/</span>usr<span class="token operator">/</span>local<span class="token operator">/</span>etc<span class="token operator">/</span>haproxy <span class="token operator">--</span>name haproxy1 <span class="token operator">--</span>privileged <span class="token operator">--</span>net<span class="token operator">=</span>znet <span class="token operator">--</span>ip <span class="token number">172.18</span><span class="token number">.0</span><span class="token number">.5</span> <span class="token literal-property property">haproxy</span><span class="token operator">:</span><span class="token number">2.0</span></span>
<span class="line"></span>
<span class="line">haproxy <span class="token operator">-</span>f <span class="token operator">/</span>usr<span class="token operator">/</span>local<span class="token operator">/</span>etc<span class="token operator">/</span>haproxy<span class="token operator">/</span>haproxy<span class="token punctuation">.</span>cfg</span>
<span class="line"></span>
<span class="line"><span class="token literal-property property">http</span><span class="token operator">:</span><span class="token operator">/</span><span class="token operator">/</span><span class="token number">47.104</span><span class="token number">.191</span><span class="token number">.1</span><span class="token operator">:</span><span class="token number">4001</span><span class="token operator">/</span>dbs</span>
<span class="line">admin <span class="token number">123456</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_6-3-keepalived双机热备" tabindex="-1"><a class="header-anchor" href="#_6-3-keepalived双机热备"><span>6.3 keepalived双机热备</span></a></h3><ul><li>虚拟IP在linux系统中一个网卡可以定义多个IP地址，然后把这些IP地址分配给对应的程序</li><li>keepalived是用来强占虚拟IP的，在各自的haproxy容器中安装keepalived,用来强占虚拟IP</li><li>抢到虚拟IP的服务器叫做主服务器，没抢到的叫做备服务器</li><li>没抢到的就会处于等待的状态，然后通过心跳检测来检测主服务器是否正常，如果不正常则立刻抢占虚拟IP</li></ul><h3 id="_6-3-1-安装keepalived" tabindex="-1"><a class="header-anchor" href="#_6-3-1-安装keepalived"><span>6.3.1 安装keepalived</span></a></h3><ul><li>安装keepalived必须要安装在haproxy所在的容器内</li></ul><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code class="language-javascript"><span class="line">apt<span class="token operator">-</span><span class="token keyword">get</span> update</span>
<span class="line">apt<span class="token operator">-</span><span class="token keyword">get</span> install <span class="token operator">-</span>y keepalived</span>
<span class="line"><span class="token operator">/</span>etc<span class="token operator">/</span>keepalived<span class="token operator">/</span>keepalived<span class="token punctuation">.</span>conf</span>
<span class="line">rm <span class="token operator">/</span><span class="token keyword">var</span><span class="token operator">/</span>cache<span class="token operator">/</span>apt<span class="token operator">/</span>archives<span class="token operator">/</span>lock</span>
<span class="line">rm <span class="token operator">/</span><span class="token keyword">var</span><span class="token operator">/</span>lib<span class="token operator">/</span>dpkg<span class="token operator">/</span>lock</span>
<span class="line">apt<span class="token operator">-</span>get <span class="token operator">-</span>y install vim</span>
<span class="line">vim <span class="token operator">/</span>etc<span class="token operator">/</span>keepalived<span class="token operator">/</span>keepalived<span class="token punctuation">.</span>conf</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>docker cp keepalived.conf haproxy1:/etc/keepalived</p><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code class="language-javascript"><span class="line">vrrp_instance <span class="token constant">VI_1</span> <span class="token punctuation">{</span></span>
<span class="line">    state <span class="token constant">MASTER</span></span>
<span class="line">    <span class="token keyword">interface</span> <span class="token class-name">eth0</span></span>
<span class="line">    virtual_router_id <span class="token number">100</span></span>
<span class="line">    priority <span class="token number">100</span></span>
<span class="line">    advert_int <span class="token number">1</span></span>
<span class="line">    authentication <span class="token punctuation">{</span></span>
<span class="line">        auth_type <span class="token constant">PASS</span></span>
<span class="line">        auth_pass <span class="token number">123456</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    virtual_ipaddress <span class="token punctuation">{</span></span>
<span class="line">        <span class="token number">172.18</span><span class="token number">.0</span><span class="token number">.201</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><table><thead><tr><th style="text-align:left;">字段</th><th style="text-align:left;">含义</th></tr></thead><tbody><tr><td style="text-align:left;">state</td><td style="text-align:left;">keepalived节点身份，master是主服务器，backup是备服务器，主服务器要抢点虚拟IP，备用服务器不抢占虚拟IP</td></tr><tr><td style="text-align:left;">interface</td><td style="text-align:left;">网卡设备,docker 网卡在宿主机上可以访问，但其它地方访问不到,所以需要映射到局域网的虚拟IP上</td></tr><tr><td style="text-align:left;">virtual_router_id</td><td style="text-align:left;">虚拟路由标识，master和backup的虚拟路由标识必须一样，可以是0~255</td></tr><tr><td style="text-align:left;">priority</td><td style="text-align:left;">master权重，权重越高越容易抢到虚拟IP</td></tr><tr><td style="text-align:left;">authentication</td><td style="text-align:left;">主从服务器验证方式，主务必须使用相同的密码才能正常通信</td></tr><tr><td style="text-align:left;">virual_ipaddress</td><td style="text-align:left;">虚拟IP，可以设置多个虚拟IP</td></tr></tbody></table><p>启动keepalive后，宿主机就可以ping通虚拟IP</p><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code class="language-javascript"><span class="line">service keepalived start</span>
<span class="line">apt<span class="token operator">-</span><span class="token keyword">get</span> install <span class="token operator">-</span>y inetutils<span class="token operator">-</span>ping</span>
<span class="line">apt<span class="token operator">-</span><span class="token keyword">get</span> install net<span class="token operator">-</span>tools <span class="token operator">-</span>y  </span>
<span class="line">ping <span class="token number">172.18</span><span class="token number">.0</span><span class="token number">.201</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_6-3-2-haproxy2" tabindex="-1"><a class="header-anchor" href="#_6-3-2-haproxy2"><span>6.3.2 haproxy2</span></a></h3><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code class="language-javascript"><span class="line">docker run <span class="token operator">-</span>it <span class="token operator">-</span>d <span class="token operator">-</span>p <span class="token number">4003</span><span class="token operator">:</span><span class="token number">8888</span> <span class="token operator">-</span>p <span class="token number">4004</span><span class="token operator">:</span><span class="token number">3306</span> <span class="token operator">-</span>v <span class="token operator">/</span>home<span class="token operator">/</span>devops<span class="token operator">/</span>haproxy<span class="token operator">:</span><span class="token operator">/</span>usr<span class="token operator">/</span>local<span class="token operator">/</span>etc<span class="token operator">/</span>haproxy <span class="token operator">--</span>name haproxy2 <span class="token operator">--</span>privileged <span class="token operator">--</span>net<span class="token operator">=</span>znet <span class="token operator">--</span>ip <span class="token number">172.18</span><span class="token number">.0</span><span class="token number">.6</span> <span class="token literal-property property">haproxy</span><span class="token operator">:</span><span class="token number">2.0</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><h2 id="_7-布署egg-js" tabindex="-1"><a class="header-anchor" href="#_7-布署egg-js"><span>7. 布署Egg.js</span></a></h2><ul><li><a href="https://eggjs.org/zh-cn/intro/quickstart.html" target="_blank" rel="noopener noreferrer">eggjs</a></li></ul><h3 id="_7-1-编写项目" tabindex="-1"><a class="header-anchor" href="#_7-1-编写项目"><span>7.1 编写项目</span></a></h3><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text"><pre><code class="language-text"><span class="line">mkdir zhufeng_egg.js</span>
<span class="line">cnpm init egg --type=simple</span>
<span class="line">cnpm install</span>
<span class="line">cnpm start / npm run dev / npm test</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_7-2-部署项目" tabindex="-1"><a class="header-anchor" href="#_7-2-部署项目"><span>7.2 部署项目</span></a></h3><h4 id="_7-2-1-package-json" tabindex="-1"><a class="header-anchor" href="#_7-2-1-package-json"><span>7.2.1 package.json</span></a></h4><ul><li>把package.json中start这行里命令里的<code>--daemon</code>去掉,在Docker里eggjs应用要在前台运行</li></ul><h4 id="_7-2-2-dockerfile" tabindex="-1"><a class="header-anchor" href="#_7-2-2-dockerfile"><span>7.2.2 Dockerfile</span></a></h4><ul><li>在本地应用的根目录下建一个名为Dockerfile的文件</li></ul><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text"><pre><code class="language-text"><span class="line"> </span>
<span class="line">FROM node:12</span>
<span class="line"> </span>
<span class="line">RUN mkdir -p /usr/src/egg_server</span>
<span class="line"> </span>
<span class="line">WORKDIR /usr/src/egg_server</span>
<span class="line"> </span>
<span class="line">COPY package.json /usr/src/egg_server/package.json</span>
<span class="line"> </span>
<span class="line">RUN npm install --registry=https://registry.npm.taobao.org</span>
<span class="line"> </span>
<span class="line">COPY . /usr/src/egg_server</span>
<span class="line"> </span>
<span class="line">EXPOSE 7001</span>
<span class="line"> </span>
<span class="line">CMD npm start</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li>1.拉取docker镜像</li><li>2.创建docker工作目录，并将package.json拷贝到docker里</li><li>3.安装npm依赖</li><li>4.将服务器上的应用拷贝到docker里</li><li>5.暴露docker容器的端口，然后启动node应用</li></ul><h4 id="_7-2-3-上传服务器" tabindex="-1"><a class="header-anchor" href="#_7-2-3-上传服务器"><span>7.2.3 上传服务器</span></a></h4><ul><li>使用ftp工具或git工具将整个应用上传到生产环境服务器</li><li>并使用终端连接到服务器，进入到服务器应用的目录下</li></ul><h4 id="_7-2-4-编译docker镜像" tabindex="-1"><a class="header-anchor" href="#_7-2-4-编译docker镜像"><span>7.2.4 编译docker镜像</span></a></h4><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text"><pre><code class="language-text"><span class="line">docker build -t egg_server .</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><h4 id="_7-2-4-启动docker容器" tabindex="-1"><a class="header-anchor" href="#_7-2-4-启动docker容器"><span>7.2.4 启动docker容器</span></a></h4><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code class="language-javascript"><span class="line">docker run <span class="token operator">-</span>d <span class="token operator">--</span>name egg_server1 <span class="token operator">-</span>p <span class="token number">7001</span><span class="token operator">:</span><span class="token number">7001</span> <span class="token operator">--</span>net<span class="token operator">=</span>znet <span class="token operator">--</span>ip <span class="token number">172.18</span><span class="token number">.0</span><span class="token number">.7</span> egg_server </span>
<span class="line">docker run <span class="token operator">-</span>d <span class="token operator">--</span>name egg_server2 <span class="token operator">-</span>p <span class="token number">7002</span><span class="token operator">:</span><span class="token number">7001</span> <span class="token operator">--</span>net<span class="token operator">=</span>znet <span class="token operator">--</span>ip <span class="token number">172.18</span><span class="token number">.0</span><span class="token number">.8</span> egg_server </span>
<span class="line">docker run <span class="token operator">-</span>d <span class="token operator">--</span>name egg_server3 <span class="token operator">-</span>p <span class="token number">7003</span><span class="token operator">:</span><span class="token number">7001</span> <span class="token operator">--</span>net<span class="token operator">=</span>znet <span class="token operator">--</span>ip <span class="token number">172.18</span><span class="token number">.0</span><span class="token number">.9</span> egg_server </span>
<span class="line">docker ps</span>
<span class="line">curl <span class="token operator">-</span>i localhost<span class="token operator">:</span><span class="token number">7001</span></span>
<span class="line">curl <span class="token operator">-</span>i localhost<span class="token operator">:</span><span class="token number">7002</span></span>
<span class="line">curl <span class="token operator">-</span>i localhost<span class="token operator">:</span><span class="token number">7003</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="_8-布署nginx" tabindex="-1"><a class="header-anchor" href="#_8-布署nginx"><span>8. 布署nginx</span></a></h2><h3 id="_8-1-拉取官方的镜像" tabindex="-1"><a class="header-anchor" href="#_8-1-拉取官方的镜像"><span>8.1 拉取官方的镜像</span></a></h3><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text"><pre><code class="language-text"><span class="line">docker pull nginx</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><h3 id="_8-2-启动nginx" tabindex="-1"><a class="header-anchor" href="#_8-2-启动nginx"><span>8.2 启动nginx</span></a></h3><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code class="language-javascript"><span class="line">docker run <span class="token operator">-</span>d <span class="token operator">--</span>name nginx1 <span class="token operator">-</span>p <span class="token number">80</span><span class="token operator">:</span><span class="token number">80</span>  nginx</span>
<span class="line">docker ps</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_8-3-创建目录" tabindex="-1"><a class="header-anchor" href="#_8-3-创建目录"><span>8.3 创建目录</span></a></h3><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text"><pre><code class="language-text"><span class="line">$ mkdir -p ~/nginx/www ~/nginx/logs ~/nginx/conf</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><table><thead><tr><th style="text-align:left;">目录名</th><th style="text-align:left;">含义</th></tr></thead><tbody><tr><td style="text-align:left;">www</td><td style="text-align:left;">目录将映射为 nginx 容器配置的虚拟目录</td></tr><tr><td style="text-align:left;">logs</td><td style="text-align:left;">目录将映射为 nginx 容器的日志目录</td></tr><tr><td style="text-align:left;">conf</td><td style="text-align:left;">目录里的配置文件将映射为 nginx 容器的配置文件</td></tr></tbody></table><h3 id="_8-4-拷贝配置文件" tabindex="-1"><a class="header-anchor" href="#_8-4-拷贝配置文件"><span>8.4 拷贝配置文件</span></a></h3><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code class="language-javascript"><span class="line">$ docker cp 09ffe6a26871<span class="token operator">:</span><span class="token operator">/</span>etc<span class="token operator">/</span>nginx<span class="token operator">/</span>nginx<span class="token punctuation">.</span>conf <span class="token operator">~</span><span class="token operator">/</span>nginx<span class="token operator">/</span>conf</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><h3 id="_8-5-部署" tabindex="-1"><a class="header-anchor" href="#_8-5-部署"><span>8.5 部署</span></a></h3><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code class="language-javascript"><span class="line">docker run <span class="token operator">-</span>d <span class="token operator">-</span>p <span class="token number">80</span><span class="token operator">:</span><span class="token number">80</span> <span class="token operator">--</span>name nginx1 <span class="token operator">-</span>v <span class="token operator">~</span><span class="token operator">/</span>nginx<span class="token operator">/</span>www<span class="token operator">:</span><span class="token operator">/</span>usr<span class="token operator">/</span>share<span class="token operator">/</span>nginx<span class="token operator">/</span>html <span class="token operator">-</span>v <span class="token operator">~</span><span class="token operator">/</span>nginx<span class="token operator">/</span>conf<span class="token operator">/</span>nginx<span class="token punctuation">.</span>conf<span class="token operator">:</span><span class="token operator">/</span>etc<span class="token operator">/</span>nginx<span class="token operator">/</span>nginx<span class="token punctuation">.</span>conf <span class="token operator">-</span>v <span class="token operator">~</span><span class="token operator">/</span>nginx<span class="token operator">/</span>conf<span class="token operator">/</span>conf<span class="token punctuation">.</span>d<span class="token operator">:</span><span class="token operator">/</span>etc<span class="token operator">/</span>nginx<span class="token operator">/</span>conf<span class="token punctuation">.</span>d  <span class="token operator">-</span>v <span class="token operator">~</span><span class="token operator">/</span>nginx<span class="token operator">/</span>logs<span class="token operator">:</span><span class="token operator">/</span><span class="token keyword">var</span><span class="token operator">/</span>log<span class="token operator">/</span>nginx <span class="token operator">--</span>net<span class="token operator">=</span>znet <span class="token operator">--</span>ip <span class="token number">172.18</span><span class="token number">.0</span><span class="token number">.10</span> nginx</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><table><thead><tr><th style="text-align:left;">目录名</th><th style="text-align:left;">含义</th></tr></thead><tbody><tr><td style="text-align:left;">-p 80:80</td><td style="text-align:left;">将容器的 80 端口映射到主机的 80 端口</td></tr><tr><td style="text-align:left;">--name nginx1</td><td style="text-align:left;">将容器命名为nginx1</td></tr><tr><td style="text-align:left;">-v ~/nginx/www:/usr/share/nginx/html</td><td style="text-align:left;">将我们自己创建的 www 目录挂载到容器的 /usr/share/nginx/html</td></tr><tr><td style="text-align:left;">-v ~/nginx/conf/nginx.conf:/etc/nginx/nginx.conf</td><td style="text-align:left;">将我们自己创建的 nginx.conf 挂载到容器的 /etc/nginx/nginx.conf</td></tr><tr><td style="text-align:left;">-v ~/nginx/logs:/var/log/nginx</td><td style="text-align:left;">将我们自己创建的 logs 挂载到容器的 /var/log/nginx</td></tr></tbody></table><p>/root/nginx/conf/conf.d/default.conf</p><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code class="language-javascript"><span class="line">upstream nodeservers <span class="token punctuation">{</span>  </span>
<span class="line">     server <span class="token number">172.18</span><span class="token number">.0</span><span class="token number">.7</span><span class="token operator">:</span><span class="token number">7001</span><span class="token punctuation">;</span>  </span>
<span class="line">     server <span class="token number">172.18</span><span class="token number">.0</span><span class="token number">.8</span><span class="token operator">:</span><span class="token number">7001</span><span class="token punctuation">;</span>  </span>
<span class="line">     server <span class="token number">172.18</span><span class="token number">.0</span><span class="token number">.9</span><span class="token operator">:</span><span class="token number">7001</span><span class="token punctuation">;</span>  </span>
<span class="line"><span class="token punctuation">}</span>   </span>
<span class="line"></span>
<span class="line">server <span class="token punctuation">{</span>  </span>
<span class="line">        listen       <span class="token number">80</span><span class="token punctuation">;</span>  </span>
<span class="line">        server_name  <span class="token number">47.104</span><span class="token number">.191</span><span class="token number">.1</span><span class="token punctuation">;</span> </span>
<span class="line">        location <span class="token operator">/</span> <span class="token punctuation">{</span>  </span>
<span class="line">            root <span class="token operator">/</span>usr<span class="token operator">/</span>share<span class="token operator">/</span>nginx<span class="token operator">/</span>html<span class="token punctuation">;</span></span>
<span class="line">            index  index<span class="token punctuation">.</span>html index<span class="token punctuation">.</span>htm<span class="token punctuation">;</span>  </span>
<span class="line">        <span class="token punctuation">}</span>   </span>
<span class="line">        location <span class="token operator">/</span>api <span class="token punctuation">{</span>  </span>
<span class="line">            proxy_pass   http<span class="token operator">:</span><span class="token operator">/</span><span class="token operator">/</span>nodeservers<span class="token punctuation">;</span></span>
<span class="line">        <span class="token punctuation">}</span>  </span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text"><pre><code class="language-text"><span class="line">$ cd ~/nginx/www</span>
<span class="line">$ docker kill -s HUP nginx1</span>
<span class="line">$ docker restart nginx1</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code class="language-javascript"><span class="line">curl http<span class="token operator">:</span><span class="token operator">/</span><span class="token operator">/</span><span class="token number">47.104</span><span class="token number">.191</span><span class="token number">.1</span><span class="token operator">/</span>api<span class="token operator">/</span>login</span>
<span class="line">curl http<span class="token operator">:</span><span class="token operator">/</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">47.104.191.1</span><span class="token regex-delimiter">/</span></span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="_9-ant-design-pro" tabindex="-1"><a class="header-anchor" href="#_9-ant-design-pro"><span>9. Ant Design Pro</span></a></h2><ul><li>[)Ant Design Pro](<a href="https://github.com/ant-design/ant-design-pro%E6%98%AF%E4%B8%80%E4%B8%AA%E4%BC%81%E4%B8%9A%E7%BA%A7%E4%B8%AD%E5%90%8E%E5%8F%B0%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88%EF%BC%8C%E5%9C%A8Ant" target="_blank" rel="noopener noreferrer">https://github.com/ant-design/ant-design-pro是一个企业级中后台解决方案，在Ant</a> Design组件库的基础上，提炼出典型模板/业务组件/通用页等，在此基础上能够使开发者快速的完成中后台应用的开发</li></ul><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code class="language-javascript"><span class="line">git clone https<span class="token operator">:</span><span class="token operator">/</span><span class="token operator">/</span>github<span class="token punctuation">.</span>com<span class="token operator">/</span>ant<span class="token operator">-</span>design<span class="token operator">/</span>ant<span class="token operator">-</span>design<span class="token operator">-</span>pro<span class="token punctuation">.</span>git <span class="token operator">--</span>depth<span class="token operator">=</span><span class="token number">1</span></span>
<span class="line">cd ant<span class="token operator">-</span>design<span class="token operator">-</span>pro</span>
<span class="line">cnpm i </span>
<span class="line">cnpm run docker<span class="token operator">-</span>prod<span class="token operator">:</span>dev</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="_10-mongodb集群" tabindex="-1"><a class="header-anchor" href="#_10-mongodb集群"><span>10.mongodb集群</span></a></h2><ul><li>在Docker环境上搭建一个MongoDB集群</li></ul><h3 id="_10-1-容器" tabindex="-1"><a class="header-anchor" href="#_10-1-容器"><span>10.1 容器</span></a></h3><table><thead><tr><th style="text-align:left;">集群角色</th><th style="text-align:left;">ContainerName</th><th style="text-align:left;">IP:port</th></tr></thead><tbody><tr><td style="text-align:left;">Config Server</td><td style="text-align:left;">cfg_1</td><td style="text-align:left;">172.18.0.11:27019</td></tr><tr><td style="text-align:left;">Config Server</td><td style="text-align:left;">cfg_2</td><td style="text-align:left;">172.18.0.12:27019</td></tr><tr><td style="text-align:left;">Config Server</td><td style="text-align:left;">cfg_3</td><td style="text-align:left;">172.18.0.13:27019</td></tr><tr><td style="text-align:left;">Shard Server</td><td style="text-align:left;">shard1_1</td><td style="text-align:left;">172.18.0.14:27018</td></tr><tr><td style="text-align:left;">Shard Server</td><td style="text-align:left;">shard1_2</td><td style="text-align:left;">172.18.0.15:27018</td></tr><tr><td style="text-align:left;">Shard Server</td><td style="text-align:left;">shard1_3</td><td style="text-align:left;">172.18.0.16:27018</td></tr><tr><td style="text-align:left;">Shard Server</td><td style="text-align:left;">shard2_1</td><td style="text-align:left;">172.18.0.17:27018</td></tr><tr><td style="text-align:left;">Shard Server</td><td style="text-align:left;">shard2_2</td><td style="text-align:left;">172.18.0.18:27018</td></tr><tr><td style="text-align:left;">Shard Server</td><td style="text-align:left;">shard2_3</td><td style="text-align:left;">172.18.0.19:27018</td></tr><tr><td style="text-align:left;">Shard Server</td><td style="text-align:left;">shard3_1</td><td style="text-align:left;">172.18.0.20:27018</td></tr><tr><td style="text-align:left;">Shard Server</td><td style="text-align:left;">shard3_2</td><td style="text-align:left;">172.18.0.21:27018</td></tr><tr><td style="text-align:left;">Shard Server</td><td style="text-align:left;">shard3_3</td><td style="text-align:left;">172.18.0.22:27018</td></tr><tr><td style="text-align:left;">Mongos mongos_1</td><td style="text-align:left;">172.18.0.23:27020</td><td style="text-align:left;"></td></tr><tr><td style="text-align:left;">Mongos mongos_2</td><td style="text-align:left;">172.18.0.24:27020</td><td style="text-align:left;"></td></tr><tr><td style="text-align:left;">Mongos mongos_3</td><td style="text-align:left;">172.18.0.25:27020</td><td style="text-align:left;"></td></tr></tbody></table><h3 id="_10-2-拉取镜像" tabindex="-1"><a class="header-anchor" href="#_10-2-拉取镜像"><span>10.2 拉取镜像</span></a></h3><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code class="language-javascript"><span class="line">docker pull mongo<span class="token operator">:</span><span class="token number">4.0</span><span class="token number">.0</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><h3 id="_10-2-集群配置文件" tabindex="-1"><a class="header-anchor" href="#_10-2-集群配置文件"><span>10.2 集群配置文件</span></a></h3><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text"><pre><code class="language-text"><span class="line">mkdir -p /home/devops/configsvr</span>
<span class="line">mkdir -p /home/devops/shard1</span>
<span class="line">mkdir -p /home/devops/shard2</span>
<span class="line">mkdir -p /home/devops/shard3</span>
<span class="line">mkdir -p /home/devops/mongos</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_10-2-1-config-server-配置文件" tabindex="-1"><a class="header-anchor" href="#_10-2-1-config-server-配置文件"><span>10.2.1 Config-Server 配置文件</span></a></h4><ul><li>路径：/home/devops/configsvr/mongod.conf</li><li>说明：MongoDB v3.4 之后要求Config-Server也需要组成副本集形式<div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code class="language-javascript"><span class="line"><span class="token literal-property property">storage</span><span class="token operator">:</span></span>
<span class="line"><span class="token literal-property property">dbPath</span><span class="token operator">:</span> <span class="token operator">/</span>data<span class="token operator">/</span>db</span>
<span class="line"><span class="token literal-property property">journal</span><span class="token operator">:</span></span>
<span class="line">  <span class="token literal-property property">enabled</span><span class="token operator">:</span> <span class="token boolean">true</span></span>
<span class="line"><span class="token literal-property property">systemLog</span><span class="token operator">:</span></span>
<span class="line"><span class="token literal-property property">destination</span><span class="token operator">:</span> file</span>
<span class="line"><span class="token literal-property property">logAppend</span><span class="token operator">:</span> <span class="token boolean">true</span></span>
<span class="line"><span class="token literal-property property">path</span><span class="token operator">:</span> <span class="token operator">/</span><span class="token keyword">var</span><span class="token operator">/</span>log<span class="token operator">/</span>mongodb<span class="token operator">/</span>mongod<span class="token punctuation">.</span>log</span>
<span class="line"><span class="token literal-property property">net</span><span class="token operator">:</span></span>
<span class="line"><span class="token literal-property property">bindIp</span><span class="token operator">:</span> <span class="token number">127.0</span><span class="token number">.0</span><span class="token number">.1</span></span>
<span class="line"><span class="token literal-property property">processManagement</span><span class="token operator">:</span></span>
<span class="line"><span class="token literal-property property">timeZoneInfo</span><span class="token operator">:</span> <span class="token operator">/</span>usr<span class="token operator">/</span>share<span class="token operator">/</span>zoneinfo</span>
<span class="line"><span class="token literal-property property">replication</span><span class="token operator">:</span></span>
<span class="line"><span class="token literal-property property">replSetName</span><span class="token operator">:</span> cfg</span>
<span class="line"><span class="token literal-property property">sharding</span><span class="token operator">:</span></span>
<span class="line"><span class="token literal-property property">clusterRole</span><span class="token operator">:</span> configsvr</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></li></ul><h4 id="_10-2-3-shard-server-配置文件" tabindex="-1"><a class="header-anchor" href="#_10-2-3-shard-server-配置文件"><span>10.2.3 Shard-Server 配置文件</span></a></h4><ul><li>路径：/home/devops/shard1/mongod.conf</li><li>说明：此处配置3个分片为shard1,shard2,shard3;每个分片都需要组成副本集。</li><li>shard2,shard3目录下配置文件同名，修改replSetName字段的值分别为’shard2’和’shard3’</li></ul><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code class="language-javascript"><span class="line"><span class="token literal-property property">storage</span><span class="token operator">:</span></span>
<span class="line">  <span class="token literal-property property">dbPath</span><span class="token operator">:</span> <span class="token operator">/</span>data<span class="token operator">/</span>db</span>
<span class="line">  <span class="token literal-property property">journal</span><span class="token operator">:</span></span>
<span class="line">    <span class="token literal-property property">enabled</span><span class="token operator">:</span> <span class="token boolean">true</span></span>
<span class="line"><span class="token literal-property property">systemLog</span><span class="token operator">:</span></span>
<span class="line">  <span class="token literal-property property">destination</span><span class="token operator">:</span> file</span>
<span class="line">  <span class="token literal-property property">logAppend</span><span class="token operator">:</span> <span class="token boolean">true</span></span>
<span class="line">  <span class="token literal-property property">path</span><span class="token operator">:</span> <span class="token operator">/</span><span class="token keyword">var</span><span class="token operator">/</span>log<span class="token operator">/</span>mongodb<span class="token operator">/</span>mongod<span class="token punctuation">.</span>log</span>
<span class="line"><span class="token literal-property property">net</span><span class="token operator">:</span></span>
<span class="line">  <span class="token literal-property property">bindIp</span><span class="token operator">:</span> <span class="token number">127.0</span><span class="token number">.0</span><span class="token number">.1</span></span>
<span class="line"><span class="token literal-property property">processManagement</span><span class="token operator">:</span></span>
<span class="line">  <span class="token literal-property property">timeZoneInfo</span><span class="token operator">:</span> <span class="token operator">/</span>usr<span class="token operator">/</span>share<span class="token operator">/</span>zoneinfo</span>
<span class="line"><span class="token literal-property property">replication</span><span class="token operator">:</span></span>
<span class="line">  <span class="token literal-property property">replSetName</span><span class="token operator">:</span> shard1</span>
<span class="line"><span class="token literal-property property">sharding</span><span class="token operator">:</span></span>
<span class="line">  <span class="token literal-property property">clusterRole</span><span class="token operator">:</span> shardsvr</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_10-2-4-mongos-配置文件" tabindex="-1"><a class="header-anchor" href="#_10-2-4-mongos-配置文件"><span>10.2.4 Mongos 配置文件</span></a></h4><ul><li>路径：/home/dmc/mongos/mongos.conf</li><li>说明：mongos不需要存储因此去掉storage字段；可任意配置net.port字段，需要指定processManagement.fork为true以–fork方式启动</li><li>sharding.configDB字段用于指定Config-Server集群地址，格式为[replSetName]/[config-server1:port],[config-server2:port]</li></ul><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code class="language-javascript"><span class="line"><span class="token literal-property property">systemLog</span><span class="token operator">:</span></span>
<span class="line">  <span class="token literal-property property">destination</span><span class="token operator">:</span> file</span>
<span class="line">  <span class="token literal-property property">logAppend</span><span class="token operator">:</span> <span class="token boolean">true</span></span>
<span class="line">  <span class="token literal-property property">path</span><span class="token operator">:</span> <span class="token operator">/</span><span class="token keyword">var</span><span class="token operator">/</span>log<span class="token operator">/</span>mongodb<span class="token operator">/</span>mongos<span class="token punctuation">.</span>log</span>
<span class="line"><span class="token literal-property property">net</span><span class="token operator">:</span></span>
<span class="line">  <span class="token literal-property property">port</span><span class="token operator">:</span> <span class="token number">27020</span></span>
<span class="line">  <span class="token literal-property property">bindIp</span><span class="token operator">:</span> <span class="token number">127.0</span><span class="token number">.0</span><span class="token number">.1</span></span>
<span class="line"><span class="token literal-property property">processManagement</span><span class="token operator">:</span></span>
<span class="line">  <span class="token literal-property property">fork</span><span class="token operator">:</span> <span class="token boolean">true</span></span>
<span class="line">  <span class="token literal-property property">timeZoneInfo</span><span class="token operator">:</span> <span class="token operator">/</span>usr<span class="token operator">/</span>share<span class="token operator">/</span>zoneinfo</span>
<span class="line"><span class="token literal-property property">sharding</span><span class="token operator">:</span></span>
<span class="line">  <span class="token literal-property property">configDB</span><span class="token operator">:</span> cfg<span class="token operator">/</span><span class="token number">172.18</span><span class="token number">.0</span><span class="token number">.11</span><span class="token operator">:</span><span class="token number">27019</span><span class="token punctuation">,</span><span class="token number">172.18</span><span class="token number">.0</span><span class="token number">.12</span><span class="token operator">:</span><span class="token number">27019</span><span class="token punctuation">,</span><span class="token number">172.18</span><span class="token number">.0</span><span class="token number">.13</span><span class="token operator">:</span><span class="token number">27019</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_10-3-启动docker容器" tabindex="-1"><a class="header-anchor" href="#_10-3-启动docker容器"><span>10.3 启动Docker容器</span></a></h3><h4 id="_10-3-1-启动3个config-server容器" tabindex="-1"><a class="header-anchor" href="#_10-3-1-启动3个config-server容器"><span>10.3.1 启动3个Config-Server容器</span></a></h4><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code class="language-javascript"><span class="line">docker run <span class="token operator">-</span>d <span class="token operator">--</span>name<span class="token operator">=</span>cfg_1 <span class="token operator">--</span>network<span class="token operator">=</span>znet <span class="token operator">--</span>ip<span class="token operator">=</span><span class="token number">172.18</span><span class="token number">.0</span><span class="token number">.11</span> <span class="token operator">-</span>v <span class="token operator">/</span>home<span class="token operator">/</span>devops<span class="token operator">/</span>configsvr<span class="token operator">:</span><span class="token operator">/</span>etc<span class="token operator">/</span>mongodb mongo<span class="token operator">:</span><span class="token number">4.0</span><span class="token number">.0</span> <span class="token operator">-</span>f <span class="token operator">/</span>etc<span class="token operator">/</span>mongodb<span class="token operator">/</span>mongod<span class="token punctuation">.</span>conf</span>
<span class="line">docker run <span class="token operator">-</span>d <span class="token operator">--</span>name<span class="token operator">=</span>cfg_2 <span class="token operator">--</span>network<span class="token operator">=</span>znet <span class="token operator">--</span>ip<span class="token operator">=</span><span class="token number">172.18</span><span class="token number">.0</span><span class="token number">.12</span> <span class="token operator">-</span>v <span class="token operator">/</span>home<span class="token operator">/</span>devops<span class="token operator">/</span>configsvr<span class="token operator">:</span><span class="token operator">/</span>etc<span class="token operator">/</span>mongodb mongo<span class="token operator">:</span><span class="token number">4.0</span><span class="token number">.0</span> <span class="token operator">-</span>f <span class="token operator">/</span>etc<span class="token operator">/</span>mongodb<span class="token operator">/</span>mongod<span class="token punctuation">.</span>conf</span>
<span class="line">docker run <span class="token operator">-</span>d <span class="token operator">--</span>name<span class="token operator">=</span>cfg_3 <span class="token operator">--</span>network<span class="token operator">=</span>znet <span class="token operator">--</span>ip<span class="token operator">=</span><span class="token number">172.18</span><span class="token number">.0</span><span class="token number">.13</span> <span class="token operator">-</span>v <span class="token operator">/</span>home<span class="token operator">/</span>devops<span class="token operator">/</span>configsvr<span class="token operator">:</span><span class="token operator">/</span>etc<span class="token operator">/</span>mongodb mongo<span class="token operator">:</span><span class="token number">4.0</span><span class="token number">.0</span> <span class="token operator">-</span>f <span class="token operator">/</span>etc<span class="token operator">/</span>mongodb<span class="token operator">/</span>mongod<span class="token punctuation">.</span>conf</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>进入其中一个容器配置Config-Server副本集</p><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text"><pre><code class="language-text"><span class="line"> </span>
<span class="line">docker exec -it cfg_1 bash</span>
<span class="line"> </span>
<span class="line">mongo --port 27019</span>
<span class="line"> </span>
<span class="line">rs.initiate({</span>
<span class="line">    &quot;_id&quot;:&quot;cfg&quot;,</span>
<span class="line">    &quot;members&quot;:[</span>
<span class="line">        {</span>
<span class="line">            &quot;_id&quot;:0,</span>
<span class="line">            &quot;host&quot;:&quot;172.18.0.11:27019&quot;</span>
<span class="line">        },</span>
<span class="line">        {</span>
<span class="line">            &quot;_id&quot;:1,</span>
<span class="line">            &quot;host&quot;:&quot;172.18.0.12:27019&quot;</span>
<span class="line">        },</span>
<span class="line">        {</span>
<span class="line">            &quot;_id&quot;:2,</span>
<span class="line">            &quot;host&quot;:&quot;172.18.0.13:27019&quot;</span>
<span class="line">        }</span>
<span class="line">    ]</span>
<span class="line">})</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_10-3-2-启动3-3个shard-server容器" tabindex="-1"><a class="header-anchor" href="#_10-3-2-启动3-3个shard-server容器"><span>10.3.2 启动3*3个Shard-Server容器</span></a></h4><ul><li>说明：分片服务器启动后默认是以27018作为端口</li></ul><h5 id="_10-3-2-1-启动第一个分片-shard1" tabindex="-1"><a class="header-anchor" href="#_10-3-2-1-启动第一个分片-shard1"><span>10.3.2.1 启动第一个分片 - shard1</span></a></h5><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code class="language-javascript"><span class="line">docker run <span class="token operator">-</span>d <span class="token operator">--</span>name<span class="token operator">=</span>shard1_1 <span class="token operator">--</span>network<span class="token operator">=</span>znet <span class="token operator">--</span>ip<span class="token operator">=</span><span class="token number">172.18</span><span class="token number">.0</span><span class="token number">.14</span> <span class="token operator">-</span>v <span class="token operator">/</span>home<span class="token operator">/</span>devops<span class="token operator">/</span>shard1<span class="token operator">:</span><span class="token operator">/</span>etc<span class="token operator">/</span>mongodb mongo<span class="token operator">:</span><span class="token number">4.0</span><span class="token number">.0</span> <span class="token operator">-</span>f <span class="token operator">/</span>etc<span class="token operator">/</span>mongodb<span class="token operator">/</span>mongod<span class="token punctuation">.</span>conf</span>
<span class="line">docker run <span class="token operator">-</span>d <span class="token operator">--</span>name<span class="token operator">=</span>shard1_2 <span class="token operator">--</span>network<span class="token operator">=</span>znet <span class="token operator">--</span>ip<span class="token operator">=</span><span class="token number">172.18</span><span class="token number">.0</span><span class="token number">.15</span> <span class="token operator">-</span>v <span class="token operator">/</span>home<span class="token operator">/</span>devops<span class="token operator">/</span>shard1<span class="token operator">:</span><span class="token operator">/</span>etc<span class="token operator">/</span>mongodb mongo<span class="token operator">:</span><span class="token number">4.0</span><span class="token number">.0</span> <span class="token operator">-</span>f <span class="token operator">/</span>etc<span class="token operator">/</span>mongodb<span class="token operator">/</span>mongod<span class="token punctuation">.</span>conf</span>
<span class="line">docker run <span class="token operator">-</span>d <span class="token operator">--</span>name<span class="token operator">=</span>shard1_3 <span class="token operator">--</span>network<span class="token operator">=</span>znet <span class="token operator">--</span>ip<span class="token operator">=</span><span class="token number">172.18</span><span class="token number">.0</span><span class="token number">.16</span> <span class="token operator">-</span>v <span class="token operator">/</span>home<span class="token operator">/</span>devops<span class="token operator">/</span>shard1<span class="token operator">:</span><span class="token operator">/</span>etc<span class="token operator">/</span>mongodb mongo<span class="token operator">:</span><span class="token number">4.0</span><span class="token number">.0</span> <span class="token operator">-</span>f <span class="token operator">/</span>etc<span class="token operator">/</span>mongodb<span class="token operator">/</span>mongod<span class="token punctuation">.</span>conf</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>进入其中一个容器配置Shard-Server副本集</p><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text"><pre><code class="language-text"><span class="line"> </span>
<span class="line">docker exec -it shard1_1 bash</span>
<span class="line"> </span>
<span class="line">mongo --port 27018</span>
<span class="line"> </span>
<span class="line">rs.initiate({</span>
<span class="line">    &quot;_id&quot;:&quot;shard1&quot;,</span>
<span class="line">    &quot;members&quot;:[</span>
<span class="line">        {</span>
<span class="line">            &quot;_id&quot;:0,</span>
<span class="line">            &quot;host&quot;:&quot;172.18.0.14:27018&quot;</span>
<span class="line">        },</span>
<span class="line">        {</span>
<span class="line">            &quot;_id&quot;:1,</span>
<span class="line">            &quot;host&quot;:&quot;172.18.0.15:27018&quot;</span>
<span class="line">        },</span>
<span class="line">        {</span>
<span class="line">            &quot;_id&quot;:2,</span>
<span class="line">            &quot;host&quot;:&quot;172.18.0.16:27018&quot;</span>
<span class="line">        }</span>
<span class="line">    ]</span>
<span class="line">})</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h5 id="_10-3-2-2-启动第二个分片-shard2" tabindex="-1"><a class="header-anchor" href="#_10-3-2-2-启动第二个分片-shard2"><span>10.3.2.2 启动第二个分片 - shard2</span></a></h5><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code class="language-javascript"><span class="line">docker run <span class="token operator">-</span>d <span class="token operator">--</span>name<span class="token operator">=</span>shard2_1 <span class="token operator">--</span>network<span class="token operator">=</span>znet <span class="token operator">--</span>ip<span class="token operator">=</span><span class="token number">172.18</span><span class="token number">.0</span><span class="token number">.17</span> <span class="token operator">-</span>v <span class="token operator">/</span>home<span class="token operator">/</span>devops<span class="token operator">/</span>shard2<span class="token operator">:</span><span class="token operator">/</span>etc<span class="token operator">/</span>mongodb mongo<span class="token operator">:</span><span class="token number">4.0</span><span class="token number">.0</span> <span class="token operator">-</span>f <span class="token operator">/</span>etc<span class="token operator">/</span>mongodb<span class="token operator">/</span>mongod<span class="token punctuation">.</span>conf</span>
<span class="line">docker run <span class="token operator">-</span>d <span class="token operator">--</span>name<span class="token operator">=</span>shard2_2 <span class="token operator">--</span>network<span class="token operator">=</span>znet <span class="token operator">--</span>ip<span class="token operator">=</span><span class="token number">172.18</span><span class="token number">.0</span><span class="token number">.18</span> <span class="token operator">-</span>v <span class="token operator">/</span>home<span class="token operator">/</span>devops<span class="token operator">/</span>shard2<span class="token operator">:</span><span class="token operator">/</span>etc<span class="token operator">/</span>mongodb mongo<span class="token operator">:</span><span class="token number">4.0</span><span class="token number">.0</span> <span class="token operator">-</span>f <span class="token operator">/</span>etc<span class="token operator">/</span>mongodb<span class="token operator">/</span>mongod<span class="token punctuation">.</span>conf</span>
<span class="line">docker run <span class="token operator">-</span>d <span class="token operator">--</span>name<span class="token operator">=</span>shard2_3 <span class="token operator">--</span>network<span class="token operator">=</span>znet <span class="token operator">--</span>ip<span class="token operator">=</span><span class="token number">172.18</span><span class="token number">.0</span><span class="token number">.19</span> <span class="token operator">-</span>v <span class="token operator">/</span>home<span class="token operator">/</span>devops<span class="token operator">/</span>shard2<span class="token operator">:</span><span class="token operator">/</span>etc<span class="token operator">/</span>mongodb mongo<span class="token operator">:</span><span class="token number">4.0</span><span class="token number">.0</span> <span class="token operator">-</span>f <span class="token operator">/</span>etc<span class="token operator">/</span>mongodb<span class="token operator">/</span>mongod<span class="token punctuation">.</span>conf</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>进入其中一个容器配置Shard-Server副本集</p><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text"><pre><code class="language-text"><span class="line"> </span>
<span class="line">docker exec -it shard2_1 bash</span>
<span class="line"> </span>
<span class="line">mongo --port 27018</span>
<span class="line"> </span>
<span class="line">rs.initiate({</span>
<span class="line">    &quot;_id&quot;:&quot;shard2&quot;,</span>
<span class="line">    &quot;members&quot;:[</span>
<span class="line">        {</span>
<span class="line">            &quot;_id&quot;:0,</span>
<span class="line">            &quot;host&quot;:&quot;172.18.0.17:27018&quot;</span>
<span class="line">        },</span>
<span class="line">        {</span>
<span class="line">            &quot;_id&quot;:1,</span>
<span class="line">            &quot;host&quot;:&quot;172.18.0.18:27018&quot;</span>
<span class="line">        },</span>
<span class="line">        {</span>
<span class="line">            &quot;_id&quot;:2,</span>
<span class="line">            &quot;host&quot;:&quot;172.18.0.19:27018&quot;</span>
<span class="line">        }</span>
<span class="line">    ]</span>
<span class="line">})</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h5 id="_10-3-2-3-启动第三个分片-shard3" tabindex="-1"><a class="header-anchor" href="#_10-3-2-3-启动第三个分片-shard3"><span>10.3.2.3 启动第三个分片 - shard3</span></a></h5><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code class="language-javascript"><span class="line">docker run <span class="token operator">-</span>d <span class="token operator">--</span>name<span class="token operator">=</span>shard3_1 <span class="token operator">--</span>network<span class="token operator">=</span>znet <span class="token operator">--</span>ip<span class="token operator">=</span><span class="token number">172.18</span><span class="token number">.0</span><span class="token number">.20</span> <span class="token operator">-</span>v <span class="token operator">/</span>home<span class="token operator">/</span>devops<span class="token operator">/</span>shard3<span class="token operator">:</span><span class="token operator">/</span>etc<span class="token operator">/</span>mongodb mongo<span class="token operator">:</span><span class="token number">4.0</span><span class="token number">.0</span> <span class="token operator">-</span>f <span class="token operator">/</span>etc<span class="token operator">/</span>mongodb<span class="token operator">/</span>mongod<span class="token punctuation">.</span>conf</span>
<span class="line">docker run <span class="token operator">-</span>d <span class="token operator">--</span>name<span class="token operator">=</span>shard3_2 <span class="token operator">--</span>network<span class="token operator">=</span>znet <span class="token operator">--</span>ip<span class="token operator">=</span><span class="token number">172.18</span><span class="token number">.0</span><span class="token number">.21</span> <span class="token operator">-</span>v <span class="token operator">/</span>home<span class="token operator">/</span>devops<span class="token operator">/</span>shard3<span class="token operator">:</span><span class="token operator">/</span>etc<span class="token operator">/</span>mongodb mongo<span class="token operator">:</span><span class="token number">4.0</span><span class="token number">.0</span> <span class="token operator">-</span>f <span class="token operator">/</span>etc<span class="token operator">/</span>mongodb<span class="token operator">/</span>mongod<span class="token punctuation">.</span>conf</span>
<span class="line">docker run <span class="token operator">-</span>d <span class="token operator">--</span>name<span class="token operator">=</span>shard3_3 <span class="token operator">--</span>network<span class="token operator">=</span>znet <span class="token operator">--</span>ip<span class="token operator">=</span><span class="token number">172.18</span><span class="token number">.0</span><span class="token number">.22</span> <span class="token operator">-</span>v <span class="token operator">/</span>home<span class="token operator">/</span>devops<span class="token operator">/</span>shard3<span class="token operator">:</span><span class="token operator">/</span>etc<span class="token operator">/</span>mongodb mongo<span class="token operator">:</span><span class="token number">4.0</span><span class="token number">.0</span> <span class="token operator">-</span>f <span class="token operator">/</span>etc<span class="token operator">/</span>mongodb<span class="token operator">/</span>mongod<span class="token punctuation">.</span>conf</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>进入其中一个容器配置Shard-Server副本集</p><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text"><pre><code class="language-text"><span class="line"> </span>
<span class="line">docker exec -it shard3_1 bash</span>
<span class="line"> </span>
<span class="line">mongo --port 27018</span>
<span class="line"> </span>
<span class="line">rs.initiate({</span>
<span class="line">    &quot;_id&quot;:&quot;shard3&quot;,</span>
<span class="line">    &quot;members&quot;:[</span>
<span class="line">        {</span>
<span class="line">            &quot;_id&quot;:0,</span>
<span class="line">            &quot;host&quot;:&quot;172.18.0.20:27018&quot;</span>
<span class="line">        },</span>
<span class="line">        {</span>
<span class="line">            &quot;_id&quot;:1,</span>
<span class="line">            &quot;host&quot;:&quot;172.18.0.21:27018&quot;</span>
<span class="line">        },</span>
<span class="line">        {</span>
<span class="line">            &quot;_id&quot;:2,</span>
<span class="line">            &quot;host&quot;:&quot;172.18.0.22:27018&quot;</span>
<span class="line">        }</span>
<span class="line">    ]</span>
<span class="line">})</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h5 id="_10-3-2-4-启动3个mongos服务器" tabindex="-1"><a class="header-anchor" href="#_10-3-2-4-启动3个mongos服务器"><span>10.3.2.4 启动3个mongos服务器</span></a></h5><ul><li>说明：这里也使用了mongo镜像，但是需要开启mongos进程，mongod进程并不需要用到。</li></ul><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code class="language-javascript"><span class="line">docker run <span class="token operator">-</span>d <span class="token operator">--</span>name<span class="token operator">=</span>mongos_1 <span class="token operator">--</span>network<span class="token operator">=</span>znet <span class="token operator">--</span>ip<span class="token operator">=</span><span class="token number">172.18</span><span class="token number">.0</span><span class="token number">.23</span> <span class="token operator">-</span>v <span class="token operator">/</span>home<span class="token operator">/</span>devops<span class="token operator">/</span>mongos<span class="token operator">:</span><span class="token operator">/</span>etc<span class="token operator">/</span>mongodb mongo<span class="token operator">:</span><span class="token number">4.0</span><span class="token number">.0</span></span>
<span class="line">docker run <span class="token operator">-</span>d <span class="token operator">--</span>name<span class="token operator">=</span>mongos_2 <span class="token operator">--</span>network<span class="token operator">=</span>znet <span class="token operator">--</span>ip<span class="token operator">=</span><span class="token number">172.18</span><span class="token number">.0</span><span class="token number">.24</span> <span class="token operator">-</span>v <span class="token operator">/</span>home<span class="token operator">/</span>devops<span class="token operator">/</span>mongos<span class="token operator">:</span><span class="token operator">/</span>etc<span class="token operator">/</span>mongodb mongo<span class="token operator">:</span><span class="token number">4.0</span><span class="token number">.0</span></span>
<span class="line">docker run <span class="token operator">-</span>d <span class="token operator">--</span>name<span class="token operator">=</span>mongos_3 <span class="token operator">--</span>network<span class="token operator">=</span>znet <span class="token operator">--</span>ip<span class="token operator">=</span><span class="token number">172.18</span><span class="token number">.0</span><span class="token number">.25</span> <span class="token operator">-</span>v <span class="token operator">/</span>home<span class="token operator">/</span>devops<span class="token operator">/</span>mongos<span class="token operator">:</span><span class="token operator">/</span>etc<span class="token operator">/</span>mongodb mongo<span class="token operator">:</span><span class="token number">4.0</span><span class="token number">.0</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>进入每个容器中，启动mongos进程</p><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text"><pre><code class="language-text"><span class="line"> </span>
<span class="line">docker exec -it mongos_1 bash</span>
<span class="line"> </span>
<span class="line">mongos -f /etc/mongodb/mongos.conf</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>可以就在其中一个mongos容器中使用mongo shell连接mongos进程配置分片集群</p><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text"><pre><code class="language-text"><span class="line"> </span>
<span class="line">mongo -port 27020</span>
<span class="line"> </span>
<span class="line">sh.addShard(&quot;shard1/172.18.0.14:27018,172.18.0.15:27018,172.18.0.16:27018&quot;)</span>
<span class="line">sh.addShard(&quot;shard2/172.18.0.17:27018,172.18.0.18:27018,172.18.0.19:27018&quot;)</span>
<span class="line">sh.addShard(&quot;shard3/172.18.0.20:27018,172.18.0.21:27018,172.18.0.22:27018&quot;)</span>
<span class="line"></span>
<span class="line"> </span>
<span class="line">sh.enableSharding(&quot;cms&quot;)</span>
<span class="line"> </span>
<span class="line">sh.shardCollection(&quot;cms.user&quot;,{&quot;name&quot;:1})</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_10-4-写入数据" tabindex="-1"><a class="header-anchor" href="#_10-4-写入数据"><span>10.4 写入数据</span></a></h3><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text"><pre><code class="language-text"><span class="line">use cms;</span>
<span class="line">for(var i=1;i&lt;=1000000;i++){</span>
<span class="line">    db.user.insert({name:i,age:i});</span>
<span class="line">}</span>
<span class="line"></span>
<span class="line"> </span>
<span class="line">sh.status()</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="_11-redis集群" tabindex="-1"><a class="header-anchor" href="#_11-redis集群"><span>11. redis集群</span></a></h2><ul><li>高速缓存利用内存保存数据，读写速度远超硬盘</li><li>高速缓存可以减少I/O操作，降低I/O压力</li><li>Redis是VMware开发的开源免费的KV型NoSQL缓存产品</li><li>Redis具有很好的性能，最多可以提供10万次/秒的读写</li></ul><h3 id="_11-1-rediscluster" tabindex="-1"><a class="header-anchor" href="#_11-1-rediscluster"><span>11.1 RedisCluster</span></a></h3><ul><li>RedisCluster是官方推荐的，没有中心节点</li><li>无中心节点，客户端与redis节点直连，不需要中间代理层</li><li>数据可以被分片存储，每个节点存储的数据是不一样的，每个节点需要提供冗余节点</li><li>Redis管理方便，可以随时自行增加和摘除节点</li></ul><h3 id="_11-2-主从同步" tabindex="-1"><a class="header-anchor" href="#_11-2-主从同步"><span>11.2 主从同步</span></a></h3><ul><li>Redis集群中的数据库复制是通过主从同步来实现的</li><li>主节点(Master)把数据分发给从节点(Slave)</li><li>主从同步的好处在于高可用，Redis节点有冗余设计</li><li>Redis集群中应该包含奇数个Master,至少应该有3个Master</li><li>Redis集群中每个Master都应该有Slave</li></ul><p><img src="http://img.zhufengpeixun.cn/redisconfig.jpg" alt="redisconfig"></p><h3 id="_11-3-实操" tabindex="-1"><a class="header-anchor" href="#_11-3-实操"><span>11.3 实操</span></a></h3><h4 id="_11-3-1-安装redis镜像" tabindex="-1"><a class="header-anchor" href="#_11-3-1-安装redis镜像"><span>11.3.1 安装Redis镜像</span></a></h4><ul><li>导入本地Redis镜像文件，运行Redis容器<div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text"><pre><code class="language-text"><span class="line">docker pull zhangrenyang/redis:latest</span>
<span class="line">docker tag zhangrenyang/redis:latest zredis</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div></div></div></li></ul><h4 id="_11-3-2-启动容器" tabindex="-1"><a class="header-anchor" href="#_11-3-2-启动容器"><span>11.3.2 启动容器</span></a></h4><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code class="language-javascript"><span class="line">docker run <span class="token operator">-</span>it <span class="token operator">-</span>d <span class="token operator">--</span>name redis1 <span class="token operator">-</span>p <span class="token number">5001</span><span class="token operator">:</span><span class="token number">6379</span> <span class="token operator">--</span>net<span class="token operator">=</span>znet <span class="token operator">--</span>ip <span class="token number">172.18</span><span class="token number">.0</span><span class="token number">.23</span> zredis bash</span>
<span class="line">docker run <span class="token operator">-</span>it <span class="token operator">-</span>d <span class="token operator">--</span>name redis2 <span class="token operator">-</span>p <span class="token number">5002</span><span class="token operator">:</span><span class="token number">6379</span> <span class="token operator">--</span>net<span class="token operator">=</span>znet <span class="token operator">--</span>ip <span class="token number">172.18</span><span class="token number">.0</span><span class="token number">.24</span> zredis bash</span>
<span class="line">docker run <span class="token operator">-</span>it <span class="token operator">-</span>d <span class="token operator">--</span>name redis3 <span class="token operator">-</span>p <span class="token number">5003</span><span class="token operator">:</span><span class="token number">6379</span> <span class="token operator">--</span>net<span class="token operator">=</span>znet <span class="token operator">--</span>ip <span class="token number">172.18</span><span class="token number">.0</span><span class="token number">.25</span> zredis bash</span>
<span class="line">docker run <span class="token operator">-</span>it <span class="token operator">-</span>d <span class="token operator">--</span>name redis4 <span class="token operator">-</span>p <span class="token number">5004</span><span class="token operator">:</span><span class="token number">6379</span> <span class="token operator">--</span>net<span class="token operator">=</span>znet <span class="token operator">--</span>ip <span class="token number">172.18</span><span class="token number">.0</span><span class="token number">.26</span> zredis bash</span>
<span class="line">docker run <span class="token operator">-</span>it <span class="token operator">-</span>d <span class="token operator">--</span>name redis5 <span class="token operator">-</span>p <span class="token number">5005</span><span class="token operator">:</span><span class="token number">6379</span> <span class="token operator">--</span>net<span class="token operator">=</span>znet <span class="token operator">--</span>ip <span class="token number">172.18</span><span class="token number">.0</span><span class="token number">.27</span> zredis bash</span>
<span class="line">docker run <span class="token operator">-</span>it <span class="token operator">-</span>d <span class="token operator">--</span>name redis6 <span class="token operator">-</span>p <span class="token number">5006</span><span class="token operator">:</span><span class="token number">6379</span> <span class="token operator">--</span>net<span class="token operator">=</span>znet <span class="token operator">--</span>ip <span class="token number">172.18</span><span class="token number">.0</span><span class="token number">.28</span> zredis bash</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_11-3-3-配置文件" tabindex="-1"><a class="header-anchor" href="#_11-3-3-配置文件"><span>11.3.3 配置文件</span></a></h4><p>/user/redis/redis.conf</p><table><thead><tr><th style="text-align:left;">参数</th><th style="text-align:left;">含义</th></tr></thead><tbody><tr><td style="text-align:left;">daemonize yes</td><td style="text-align:left;">以后台模式运行</td></tr><tr><td style="text-align:left;">cluster-enabled yes</td><td style="text-align:left;">开启集群</td></tr><tr><td style="text-align:left;">cluster-config-filter nodes.conf</td><td style="text-align:left;">集群配置文件</td></tr><tr><td style="text-align:left;">cluster-node-timeout 15000</td><td style="text-align:left;">超时时间</td></tr><tr><td style="text-align:left;">appendonly yes</td><td style="text-align:left;">开启AOF模式，实现日志恢复数据</td></tr></tbody></table><h4 id="_11-3-4-配置集群" tabindex="-1"><a class="header-anchor" href="#_11-3-4-配置集群"><span>11.3.4 配置集群</span></a></h4><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code class="language-javascript"><span class="line">cp <span class="token operator">/</span>usr<span class="token operator">/</span>redis<span class="token operator">/</span>src<span class="token operator">/</span>redis<span class="token operator">-</span>trib<span class="token punctuation">.</span>rb <span class="token operator">/</span>usr<span class="token operator">/</span>redis<span class="token operator">/</span>cluster</span>
<span class="line">cd <span class="token operator">/</span>usr<span class="token operator">/</span>redis<span class="token operator">/</span>cluster</span>
<span class="line">apt<span class="token operator">-</span><span class="token keyword">get</span> install ruby</span>
<span class="line">apt<span class="token operator">-</span><span class="token keyword">get</span> install rubygems</span>
<span class="line">gem install redis</span>
<span class="line"></span>
<span class="line"><span class="token punctuation">.</span><span class="token operator">/</span>redis<span class="token operator">-</span>trib<span class="token punctuation">.</span>rb create <span class="token operator">--</span>replicas <span class="token number">1</span> <span class="token number">172.18</span><span class="token number">.0</span><span class="token number">.23</span><span class="token operator">:</span><span class="token number">6379</span> <span class="token number">172.18</span><span class="token number">.0</span><span class="token number">.24</span><span class="token operator">:</span><span class="token number">6379</span> <span class="token number">172.18</span><span class="token number">.0</span><span class="token number">.25</span><span class="token operator">:</span><span class="token number">6379</span> <span class="token number">172.18</span><span class="token number">.0</span><span class="token number">.26</span><span class="token operator">:</span><span class="token number">6379</span> <span class="token number">172.18</span><span class="token number">.0</span><span class="token number">.27</span><span class="token operator">:</span><span class="token number">6379</span> <span class="token number">172.18</span><span class="token number">.0</span><span class="token number">.28</span><span class="token operator">:</span><span class="token number">6379</span> </span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>--replicas 1 参数表示为每个主节点创建一个从节点</p><h2 id="_12-数据库备份" tabindex="-1"><a class="header-anchor" href="#_12-数据库备份"><span>12.数据库备份</span></a></h2><h3 id="_12-1-mysql" tabindex="-1"><a class="header-anchor" href="#_12-1-mysql"><span>12.1 mysql</span></a></h3><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code class="language-javascript"><span class="line">wget <span class="token operator">-</span>i <span class="token operator">-</span>c http<span class="token operator">:</span><span class="token operator">/</span><span class="token operator">/</span>dev<span class="token punctuation">.</span>mysql<span class="token punctuation">.</span>com<span class="token operator">/</span>get<span class="token operator">/</span>mysql57<span class="token operator">-</span>community<span class="token operator">-</span>release<span class="token operator">-</span>el7<span class="token operator">-</span><span class="token number">10</span><span class="token punctuation">.</span>noarch<span class="token punctuation">.</span>rpm</span>
<span class="line">yum <span class="token operator">-</span>y install mysql57<span class="token operator">-</span>community<span class="token operator">-</span>release<span class="token operator">-</span>el7<span class="token operator">-</span><span class="token number">10</span><span class="token punctuation">.</span>noarch<span class="token punctuation">.</span>rpm</span>
<span class="line">yum <span class="token operator">-</span>y install mysql<span class="token operator">-</span>community<span class="token operator">-</span>server</span>
<span class="line">systemctl start  mysqld<span class="token punctuation">.</span>service</span>
<span class="line">systemctl status mysqld<span class="token punctuation">.</span>service</span>
<span class="line"> mysql <span class="token operator">-</span>uroot <span class="token operator">-</span>p</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code class="language-javascript"><span class="line"> </span>
<span class="line"><span class="token constant">DATE</span><span class="token operator">=</span><span class="token function">$</span><span class="token punctuation">(</span>date <span class="token operator">+</span><span class="token operator">%</span><span class="token constant">F_</span><span class="token operator">%</span><span class="token constant">H</span><span class="token operator">-</span><span class="token operator">%</span><span class="token constant">M</span><span class="token operator">-</span><span class="token operator">%</span><span class="token constant">S</span><span class="token punctuation">)</span></span>
<span class="line"><span class="token constant">HOST</span><span class="token operator">=</span><span class="token number">192.168</span><span class="token number">.0</span><span class="token number">.1</span></span>
<span class="line"><span class="token constant">DB</span><span class="token operator">=</span>test</span>
<span class="line"><span class="token constant">USER</span><span class="token operator">=</span>root</span>
<span class="line"><span class="token constant">PASS</span><span class="token operator">=</span><span class="token number">123456</span></span>
<span class="line"><span class="token constant">MAIL</span><span class="token operator">=</span><span class="token string">&quot;83687401@qq.com&quot;</span></span>
<span class="line"><span class="token constant">BACKUP_DIR</span><span class="token operator">=</span><span class="token operator">/</span>data<span class="token operator">/</span>db_backup</span>
<span class="line"><span class="token constant">SQL_FILE</span><span class="token operator">=</span>$<span class="token punctuation">{</span><span class="token constant">DB</span><span class="token punctuation">}</span>_FULL_$<span class="token punctuation">{</span><span class="token constant">DATE</span><span class="token punctuation">}</span><span class="token punctuation">.</span>sql</span>
<span class="line">cd $<span class="token constant">BACKUP_DIR</span></span>
<span class="line">mysqldump <span class="token operator">-</span>h$<span class="token constant">HOST</span> <span class="token operator">-</span>u$<span class="token constant">USER</span> <span class="token operator">-</span>p$<span class="token constant">PASS</span> <span class="token operator">&gt;</span>  $<span class="token constant">SQL_FILE</span></span>
<span class="line">echo <span class="token string">&quot;$DATE 备份成功&quot;</span> <span class="token operator">|</span> mail <span class="token operator">-</span>s <span class="token string">&quot;备份成功通知&quot;</span> $<span class="token constant">MAIL</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_12-2-mongodb备份" tabindex="-1"><a class="header-anchor" href="#_12-2-mongodb备份"><span>12.2 mongodb备份</span></a></h3><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code class="language-javascript"><span class="line">dump<span class="token operator">=</span><span class="token operator">/</span>usr<span class="token operator">/</span>local<span class="token operator">/</span>mongodb<span class="token operator">/</span>bin<span class="token operator">/</span>mongodump</span>
<span class="line">out_dir<span class="token operator">=</span><span class="token operator">/</span>media<span class="token operator">/</span>sf_mongobak<span class="token operator">/</span>dump_bak</span>
<span class="line">tar_dir<span class="token operator">=</span><span class="token operator">/</span>media<span class="token operator">/</span>sf_mongobak<span class="token operator">/</span>tar_bak</span>
<span class="line">mkdir <span class="token operator">-</span>p $out_dir<span class="token operator">/</span>$sysdate</span>
<span class="line">$dump <span class="token operator">-</span>h <span class="token number">127.0</span><span class="token number">.0</span><span class="token number">.1</span> <span class="token operator">-</span>d masterdata <span class="token operator">-</span>o $out_dir<span class="token operator">/</span>$sysdate</span>
<span class="line">exit</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="_13-监控主机状态" tabindex="-1"><a class="header-anchor" href="#_13-监控主机状态"><span>13.监控主机状态</span></a></h2><h3 id="_13-1-定义一个颜色输出字符串函数" tabindex="-1"><a class="header-anchor" href="#_13-1-定义一个颜色输出字符串函数"><span>13.1 定义一个颜色输出字符串函数</span></a></h3><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text"><pre><code class="language-text"><span class="line"> </span>
<span class="line"> </span>
<span class="line">function echo_color(){</span>
<span class="line">  if [ $1 == &quot;green&quot; ]; then</span>
<span class="line">     echo -e &quot;\\033[32;40m$2\\033[0m&quot;</span>
<span class="line">  elif [ $1 == &quot;red&quot; ]; then</span>
<span class="line">     echo -e &quot;\\033[31;40m$2\\033[0m&quot;  </span>
<span class="line">  fi    </span>
<span class="line">}</span>
<span class="line"></span>
<span class="line">function echo_color2(){</span>
<span class="line">  case $1 in </span>
<span class="line">     green)</span>
<span class="line">        echo -e &quot;\\033[32;40m$2\\033[0m&quot;</span>
<span class="line">        ;;</span>
<span class="line">     red)</span>
<span class="line">        echo -e &quot;\\033[31;40m$2\\033[0m&quot;</span>
<span class="line">        ;;   </span>
<span class="line">       *) </span>
<span class="line">         echo &quot;echo_color2 {green|red} string&quot;</span>
<span class="line">  esac           </span>
<span class="line">}</span>
<span class="line"></span>
<span class="line">echo -e &quot;\\033[32;40mshell\\033[0m&quot;</span>
<span class="line">echo -e &quot;\\033[33;40mshell\\033[0m&quot;</span>
<span class="line"></span>
<span class="line">echo_color green hello</span>
<span class="line">echo_color red world</span>
<span class="line"></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_13-2-批量创建用户" tabindex="-1"><a class="header-anchor" href="#_13-2-批量创建用户"><span>13.2. 批量创建用户</span></a></h3><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code class="language-javascript"><span class="line"> </span>
<span class="line"><span class="token keyword">function</span> <span class="token function">echo_color</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line">  <span class="token keyword">if</span> <span class="token punctuation">[</span> $1 <span class="token operator">==</span> <span class="token string">&quot;green&quot;</span> <span class="token punctuation">]</span><span class="token punctuation">;</span> then</span>
<span class="line">     echo <span class="token operator">-</span>e <span class="token string">&quot;\\033[32;40m$2\\033[0m&quot;</span></span>
<span class="line">  elif <span class="token punctuation">[</span> $1 <span class="token operator">==</span> <span class="token string">&quot;red&quot;</span> <span class="token punctuation">]</span><span class="token punctuation">;</span> then</span>
<span class="line">     echo <span class="token operator">-</span>e <span class="token string">&quot;\\033[31;40m$2\\033[0m&quot;</span>  </span>
<span class="line">  fi    </span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">for</span> <span class="token constant">USER</span> <span class="token keyword">in</span> user<span class="token punctuation">{</span><span class="token number">1.</span><span class="token number">.5</span><span class="token punctuation">}</span><span class="token punctuation">;</span> <span class="token keyword">do</span></span>
<span class="line">  <span class="token keyword">if</span> <span class="token operator">!</span> id $<span class="token constant">USER</span> <span class="token operator">&amp;</span><span class="token operator">&gt;</span><span class="token operator">/</span>dev<span class="token operator">/</span><span class="token keyword">null</span><span class="token punctuation">;</span> then</span>
<span class="line">    <span class="token constant">PASS</span><span class="token operator">=</span><span class="token function">$</span><span class="token punctuation">(</span>echo $<span class="token constant">RANDOM</span> <span class="token operator">|</span> md5sum <span class="token operator">|</span> cut <span class="token operator">-</span>c <span class="token number">1</span><span class="token operator">-</span><span class="token number">8</span><span class="token punctuation">)</span></span>
<span class="line">    useradd $<span class="token constant">USER</span></span>
<span class="line">    echo $<span class="token constant">PASS</span> <span class="token operator">|</span> passwd <span class="token operator">--</span>stdin $<span class="token constant">USER</span> <span class="token operator">&amp;</span><span class="token operator">&gt;</span> <span class="token operator">/</span>dev<span class="token operator">/</span><span class="token keyword">null</span></span>
<span class="line">    echo <span class="token operator">-</span>e <span class="token string">&quot;$USER\\t$PASS&quot;</span> <span class="token operator">&gt;&gt;</span>user_file</span>
<span class="line">    echo <span class="token string">&quot;$USER user create successfully.&quot;</span></span>
<span class="line">  <span class="token keyword">else</span></span>
<span class="line">    echo_color red <span class="token string">&quot;$USER already exists.&quot;</span><span class="token punctuation">;</span>  </span>
<span class="line">  fi</span>
<span class="line">done</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_13-3-检查主机存活状态" tabindex="-1"><a class="header-anchor" href="#_13-3-检查主机存活状态"><span>13.3. 检查主机存活状态</span></a></h3><h4 id="_13-3-1-将错误ip放到数组中里面判断是否ping失败三次" tabindex="-1"><a class="header-anchor" href="#_13-3-1-将错误ip放到数组中里面判断是否ping失败三次"><span>13.3.1 将错误IP放到数组中里面判断是否ping失败三次</span></a></h4><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code class="language-javascript"><span class="line"> </span>
<span class="line"><span class="token constant">IP_LIST</span><span class="token operator">=</span><span class="token string">&quot;192.168.0.1 192.168.0.2&quot;</span></span>
<span class="line"><span class="token keyword">for</span> <span class="token constant">IP</span> <span class="token keyword">in</span> $<span class="token constant">IP_LIST</span><span class="token punctuation">;</span> <span class="token keyword">do</span></span>
<span class="line">  <span class="token keyword">if</span> ping <span class="token operator">-</span>c <span class="token number">1</span> $<span class="token constant">IP</span> <span class="token operator">&amp;</span><span class="token operator">&gt;</span><span class="token operator">/</span>dev<span class="token operator">/</span><span class="token keyword">null</span><span class="token punctuation">;</span> then</span>
<span class="line">     echo <span class="token string">&quot;$IP is ok.&quot;</span></span>
<span class="line">  <span class="token keyword">else</span></span>
<span class="line">     echo <span class="token string">&quot;$IP is wrong!&quot;</span></span>
<span class="line">  fi</span>
<span class="line">done       </span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text"><pre><code class="language-text"><span class="line"> </span>
<span class="line">IP_LIST=&quot;192.168.0.1 192.168.0.222&quot;</span>
<span class="line">for IP in $IP_LIST; do</span>
<span class="line">  NUM=1</span>
<span class="line">  while [ $NUM -le 3 ]; do</span>
<span class="line">      if ping -c 1 $IP &amp;&gt;/dev/null; then</span>
<span class="line">        echo &quot;$IP is ok.&quot;</span>
<span class="line">        break</span>
<span class="line">      else</span>
<span class="line">        echo $NUM</span>
<span class="line">        FAIL_COUNT[$NUM]=$IP</span>
<span class="line">      fi</span>
<span class="line">      let NUM++</span>
<span class="line">  done</span>
<span class="line">   echo \${</span>
<span class="line">   if [ \${</span>
<span class="line">    echo &quot;$IP is unreachable.&quot; </span>
<span class="line">  fi</span>
<span class="line">  unset FAIL_COUNT[*]</span>
<span class="line">done      </span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code class="language-javascript"><span class="line"> </span>
<span class="line"><span class="token constant">IP_LIST</span><span class="token operator">=</span><span class="token string">&quot;192.168.0.1 192.168.0.222&quot;</span></span>
<span class="line"><span class="token keyword">for</span> <span class="token constant">IP</span> <span class="token keyword">in</span> $<span class="token constant">IP_LIST</span><span class="token punctuation">;</span> <span class="token keyword">do</span></span>
<span class="line">  <span class="token constant">FAIL_COUNT</span><span class="token operator">=</span><span class="token number">1</span></span>
<span class="line">  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>i<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span>i<span class="token operator">&lt;=</span><span class="token number">3</span><span class="token punctuation">;</span>i<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">do</span></span>
<span class="line">    <span class="token keyword">if</span> ping <span class="token operator">-</span>c <span class="token number">1</span> $<span class="token constant">IP</span> <span class="token operator">&amp;</span><span class="token operator">&gt;</span><span class="token operator">/</span>dev<span class="token operator">/</span><span class="token keyword">null</span><span class="token punctuation">;</span> then</span>
<span class="line">        echo <span class="token string">&quot;$IP is ok.&quot;</span></span>
<span class="line">        <span class="token keyword">break</span></span>
<span class="line">    <span class="token keyword">else</span></span>
<span class="line">        echo $<span class="token constant">NUM</span></span>
<span class="line">        <span class="token keyword">let</span> <span class="token constant">FAIL_COUNT</span><span class="token operator">++</span></span>
<span class="line">    fi</span>
<span class="line">  done</span>
<span class="line">  <span class="token keyword">if</span> <span class="token punctuation">[</span> $<span class="token constant">FAIL_COUNT</span> <span class="token operator">-</span>eq <span class="token number">3</span> <span class="token punctuation">]</span><span class="token punctuation">;</span> then</span>
<span class="line">    echo <span class="token string">&quot;$IP is unreachable.&quot;</span> </span>
<span class="line">  fi</span>
<span class="line">done      </span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_13-4-获得cpu利用率" tabindex="-1"><a class="header-anchor" href="#_13-4-获得cpu利用率"><span>13.4 获得CPU利用率</span></a></h4><ul><li>借助<code>vmstat</code>工具来分析CPU统计信息</li></ul><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code class="language-javascript"><span class="line"> </span>
<span class="line"><span class="token function">cpu</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line">    local user system idle cwait</span>
<span class="line">    user<span class="token operator">=</span><span class="token function">$</span><span class="token punctuation">(</span>vmstat <span class="token operator">|</span> awk <span class="token string">&#39;NR==3{print $13}&#39;</span><span class="token punctuation">)</span></span>
<span class="line">    system<span class="token operator">=</span><span class="token function">$</span><span class="token punctuation">(</span>vmstat <span class="token operator">|</span> awk <span class="token string">&#39;NR==3{print $14}&#39;</span><span class="token punctuation">)</span></span>
<span class="line">    idea<span class="token operator">=</span><span class="token function">$</span><span class="token punctuation">(</span>vmstat <span class="token operator">|</span> awk <span class="token string">&#39;NR==3{print $15}&#39;</span><span class="token punctuation">)</span></span>
<span class="line">    cwait<span class="token operator">=</span><span class="token function">$</span><span class="token punctuation">(</span>vmstat <span class="token operator">|</span> awk <span class="token string">&#39;NR==3{print $16}&#39;</span><span class="token punctuation">)</span></span>
<span class="line">    echo <span class="token string">&quot;user cpu: $user%&quot;</span></span>
<span class="line">    echo <span class="token string">&quot;system cpu: $system%&quot;</span></span>
<span class="line">    echo <span class="token string">&quot;idle cpu: $idea%&quot;</span></span>
<span class="line">    echo <span class="token string">&quot;wait: $cwait%&quot;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line">cpu</span>
<span class="line"><span class="token function">memory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line">  local total used free</span>
<span class="line">  used<span class="token operator">=</span><span class="token function">$</span><span class="token punctuation">(</span>free <span class="token operator">-</span>m <span class="token operator">|</span> awk <span class="token string">&#39;NR==3{print $3}&#39;</span><span class="token punctuation">)</span></span>
<span class="line">  free<span class="token operator">=</span><span class="token function">$</span><span class="token punctuation">(</span>free <span class="token operator">-</span>m <span class="token operator">|</span> awak <span class="token string">&#39;NR==3{print $4}&#39;</span><span class="token punctuation">)</span></span>
<span class="line">  total<span class="token operator">=</span><span class="token function">$</span><span class="token punctuation">(</span><span class="token punctuation">(</span>$used<span class="token operator">+</span>$free<span class="token punctuation">)</span><span class="token punctuation">)</span></span>
<span class="line">  echo <span class="token string">&quot;内存总计: $(total)M&quot;</span></span>
<span class="line">  echo <span class="token string">&quot;内存使用: $(used)M&quot;</span></span>
<span class="line">  echo <span class="token string">&quot;内存剩余: $(free)M&quot;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line">memory</span>
<span class="line"></span>
<span class="line"><span class="token function">disk</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line">  local mount total used used_percent free</span>
<span class="line">  part<span class="token operator">=</span><span class="token function">$</span><span class="token punctuation">(</span>df <span class="token operator">-</span>h<span class="token operator">|</span>awk <span class="token string">&#39;BEGIN{OFS=&quot;=&quot;}/^\\/dev/{print $6,$2,$3,$4,$5}&#39;</span><span class="token punctuation">)</span></span>
<span class="line">  echo $p</span>
<span class="line">  <span class="token keyword">for</span> p <span class="token keyword">in</span>  $part<span class="token punctuation">;</span> <span class="token keyword">do</span></span>
<span class="line">    mount<span class="token operator">=</span><span class="token function">$</span><span class="token punctuation">(</span>echo $p <span class="token operator">|</span> cut <span class="token operator">-</span>d<span class="token string">&quot;=&quot;</span> <span class="token operator">-</span>f1<span class="token punctuation">)</span></span>
<span class="line">    total<span class="token operator">=</span><span class="token function">$</span><span class="token punctuation">(</span>echo $p <span class="token operator">|</span> cut <span class="token operator">-</span>d<span class="token string">&quot;=&quot;</span> <span class="token operator">-</span>f2<span class="token punctuation">)</span></span>
<span class="line">    used<span class="token operator">=</span><span class="token function">$</span><span class="token punctuation">(</span>echo $p <span class="token operator">|</span> cut <span class="token operator">-</span>d<span class="token string">&quot;=&quot;</span> <span class="token operator">-</span>f3<span class="token punctuation">)</span></span>
<span class="line">    free<span class="token operator">=</span><span class="token function">$</span><span class="token punctuation">(</span>echo $p <span class="token operator">|</span> cut <span class="token operator">-</span>d<span class="token string">&quot;=&quot;</span> <span class="token operator">-</span>f4<span class="token punctuation">)</span></span>
<span class="line">    used_percent<span class="token operator">=</span><span class="token function">$</span><span class="token punctuation">(</span>echo $p <span class="token operator">|</span> cut <span class="token operator">-</span>d<span class="token string">&quot;=&quot;</span> <span class="token operator">-</span>f5<span class="token operator">|</span>cut <span class="token operator">-</span>d<span class="token string">&quot;%&quot;</span> <span class="token operator">-</span>f1<span class="token punctuation">)</span></span>
<span class="line">    <span class="token keyword">if</span> <span class="token punctuation">[</span> $used_percent <span class="token operator">-</span>ge <span class="token number">5</span> <span class="token punctuation">]</span><span class="token punctuation">;</span> then</span>
<span class="line">      echo <span class="token string">&quot;挂载点: $mount&quot;</span></span>
<span class="line">      echo <span class="token string">&quot;总大小: $total&quot;</span></span>
<span class="line">      echo <span class="token string">&quot;使用大小: $used&quot;</span></span>
<span class="line">      echo <span class="token string">&quot;空闲大小: $free&quot;</span></span>
<span class="line">      echo <span class="token string">&quot;使用百分比: $used_percent%&quot;</span></span>
<span class="line">    fi  </span>
<span class="line">  done</span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code class="language-javascript"><span class="line"><span class="token keyword">while</span> <span class="token boolean">true</span><span class="token punctuation">;</span> <span class="token keyword">do</span> bash system<span class="token punctuation">.</span>sh<span class="token punctuation">;</span> sleep 1s<span class="token punctuation">;</span>done</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><h4 id="_13-5-监控网络流量" tabindex="-1"><a class="header-anchor" href="#_13-5-监控网络流量"><span>13.5 监控网络流量</span></a></h4><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code class="language-javascript"><span class="line"></span>
<span class="line"></span>
<span class="line"><span class="token function">traffic</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line">    local old_in old_out new_in new_out</span>
<span class="line">    old_in<span class="token operator">=</span><span class="token function">$</span><span class="token punctuation">(</span>ifconfig eth0 <span class="token operator">|</span> awk <span class="token string">&#39;/RX/&amp;&amp;/bytes/{print $2}&#39;</span> <span class="token operator">|</span>cut <span class="token operator">-</span>d<span class="token string">&quot;:&quot;</span> <span class="token operator">-</span>f2<span class="token punctuation">)</span></span>
<span class="line">    old_out<span class="token operator">=</span><span class="token function">$</span><span class="token punctuation">(</span>ifconfig eth0 <span class="token operator">|</span> awk <span class="token string">&#39;/TX/&amp;&amp;/bytes/{print $2}&#39;</span> <span class="token operator">|</span>cut <span class="token operator">-</span>d<span class="token string">&quot;:&quot;</span> <span class="token operator">-</span>f2<span class="token punctuation">)</span></span>
<span class="line">    sleep 1s</span>
<span class="line">    new_in<span class="token operator">=</span><span class="token function">$</span><span class="token punctuation">(</span>ifconfig eth0 <span class="token operator">|</span> awk <span class="token string">&#39;/RX/&amp;&amp;/bytes/{print $2}&#39;</span> <span class="token operator">|</span>cut <span class="token operator">-</span>d<span class="token string">&quot;:&quot;</span> <span class="token operator">-</span>f2<span class="token punctuation">)</span></span>
<span class="line">    new_out<span class="token operator">=</span><span class="token function">$</span><span class="token punctuation">(</span>ifconfig eth0 <span class="token operator">|</span> awk <span class="token string">&#39;/TX/&amp;&amp;/bytes/{print $2}&#39;</span> <span class="token operator">|</span>cut <span class="token operator">-</span>d<span class="token string">&quot;:&quot;</span> <span class="token operator">-</span>f2<span class="token punctuation">)</span></span>
<span class="line">    <span class="token keyword">in</span><span class="token operator">=</span><span class="token function">$</span><span class="token punctuation">(</span><span class="token punctuation">(</span>$new_in<span class="token operator">-</span>$old_in<span class="token punctuation">)</span><span class="token punctuation">)</span></span>
<span class="line">    out<span class="token operator">=</span><span class="token function">$</span><span class="token punctuation">(</span><span class="token punctuation">(</span>$new_out<span class="token operator">-</span>$old_out<span class="token punctuation">)</span><span class="token punctuation">)</span></span>
<span class="line">    echo <span class="token string">&quot;\${in}B/s \${out}B/s&quot;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_13-6-监控网站状态" tabindex="-1"><a class="header-anchor" href="#_13-6-监控网站状态"><span>13.6 监控网站状态</span></a></h4><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code class="language-javascript"><span class="line">curl <span class="token operator">-</span>o <span class="token operator">/</span>dev<span class="token operator">/</span><span class="token keyword">null</span> <span class="token operator">-</span>s <span class="token operator">-</span>w <span class="token string">&quot;%{http_code}&quot;</span> <span class="token literal-property property">http</span><span class="token operator">:</span><span class="token operator">/</span><span class="token operator">/</span>www<span class="token punctuation">.</span>baidu<span class="token punctuation">.</span>com</span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span class="token keyword">function</span> <span class="token function">check_url</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line">    <span class="token constant">HTTP_CODE</span><span class="token operator">=</span><span class="token function">$</span><span class="token punctuation">(</span>curl <span class="token operator">-</span>o <span class="token operator">/</span>dev<span class="token operator">/</span><span class="token keyword">null</span> <span class="token operator">-</span>s <span class="token operator">-</span>w <span class="token string">&quot;%{http_code}&quot;</span> $1<span class="token punctuation">)</span></span>
<span class="line">    <span class="token keyword">if</span> <span class="token punctuation">[</span> $<span class="token constant">HTTP_CODE</span> <span class="token operator">-</span>ne <span class="token number">200</span> <span class="token punctuation">]</span><span class="token punctuation">;</span> then</span>
<span class="line">      echo <span class="token string">&quot;$1不可达&quot;</span></span>
<span class="line">    <span class="token keyword">else</span></span>
<span class="line">      echo <span class="token string">&quot;$1状态正常&quot;</span>  </span>
<span class="line">    fi</span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token constant">URL_LIST</span><span class="token operator">=</span><span class="token string">&quot;http://www.baidu.com http://www.baidu2222.com&quot;</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">for</span> <span class="token constant">URL</span> <span class="token keyword">in</span> $<span class="token constant">URL_LIST</span><span class="token punctuation">;</span> <span class="token keyword">do</span></span>
<span class="line">  check_url $<span class="token constant">URL</span></span>
<span class="line">done</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_13-7-监控nginx状态" tabindex="-1"><a class="header-anchor" href="#_13-7-监控nginx状态"><span>13.7 监控nginx状态</span></a></h4><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code class="language-javascript"><span class="line">  </span>
<span class="line">Web<span class="token operator">=</span><span class="token template-string"><span class="token template-punctuation string">\`</span><span class="token string">ps -ef |grep nginx|grep -v grep|wc -l</span><span class="token template-punctuation string">\`</span></span></span>
<span class="line"> <span class="token keyword">if</span> <span class="token punctuation">[</span> $Web <span class="token operator">-</span>eq <span class="token number">2</span> <span class="token punctuation">]</span><span class="token punctuation">;</span>then</span>
<span class="line">    echo <span class="token string">&quot;your nginx is running&quot;</span></span>
<span class="line">      exit <span class="token number">0</span></span>
<span class="line">     <span class="token keyword">else</span></span>
<span class="line">       service nginx start</span>
<span class="line">        exit <span class="token number">1</span></span>
<span class="line">fi</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_13-8-监控mysql状态" tabindex="-1"><a class="header-anchor" href="#_13-8-监控mysql状态"><span>13.8 监控mysql状态</span></a></h4><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code class="language-javascript"><span class="line"> </span>
<span class="line">PortNum<span class="token operator">=</span><span class="token template-string"><span class="token template-punctuation string">\`</span><span class="token string">netstat -lnt|grep 3306|wc -l</span><span class="token template-punctuation string">\`</span></span></span>
<span class="line"><span class="token keyword">if</span> <span class="token punctuation">[</span> $PortNum <span class="token operator">-</span>eq <span class="token number">1</span> <span class="token punctuation">]</span></span>
<span class="line">then</span>
<span class="line"> echo <span class="token string">&quot;mysqld is running.&quot;</span></span>
<span class="line"><span class="token keyword">else</span></span>
<span class="line"> echo <span class="token string">&quot;mysqld is stoped.&quot;</span></span>
<span class="line">fi</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="_12-参考" tabindex="-1"><a class="header-anchor" href="#_12-参考"><span>12.参考</span></a></h2><h3 id="_12-网址" tabindex="-1"><a class="header-anchor" href="#_12-网址"><span>12. 网址</span></a></h3><ul><li><a href="https://www.linux.org/" target="_blank" rel="noopener noreferrer">linux</a></li><li><a href="https://www.docker.com/" target="_blank" rel="noopener noreferrer">docker</a></li><li><a href="http://nginx.org/" target="_blank" rel="noopener noreferrer">nginx</a></li><li><a href="https://www.mysql.com/" target="_blank" rel="noopener noreferrer">mysql</a></li><li><a href="https://www.mongodb.com/" target="_blank" rel="noopener noreferrer">mongodb</a></li><li><a href="https://xshell.en.softonic.com/" target="_blank" rel="noopener noreferrer">xshell</a></li><li><a href="https://www.netsarang.com/zh/xftp/" target="_blank" rel="noopener noreferrer">xftp</a></li><li><a href="https://robomongo.org/" target="_blank" rel="noopener noreferrer">robomongo</a></li><li><a href="https://www.navicat.com.cn/products/" target="_blank" rel="noopener noreferrer">navicat</a></li><li><a href="https://redis.io/" target="_blank" rel="noopener noreferrer">redis</a></li></ul><h3 id="_12-配置node-js" tabindex="-1"><a class="header-anchor" href="#_12-配置node-js"><span>12.配置node.js</span></a></h3><h4 id="_12-1-安装nvm" tabindex="-1"><a class="header-anchor" href="#_12-1-安装nvm"><span>12.1 安装nvm</span></a></h4><ul><li><a href="https://github.com/nvm-sh/nvm" target="_blank" rel="noopener noreferrer">nvm</a></li></ul><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code class="language-javascript"><span class="line">curl <span class="token operator">-</span>o<span class="token operator">-</span> https<span class="token operator">:</span><span class="token operator">/</span><span class="token operator">/</span>raw<span class="token punctuation">.</span>githubusercontent<span class="token punctuation">.</span>com<span class="token operator">/</span>nvm<span class="token operator">-</span>sh<span class="token operator">/</span>nvm<span class="token operator">/</span>v0<span class="token punctuation">.</span><span class="token number">34.0</span><span class="token operator">/</span>install<span class="token punctuation">.</span>sh <span class="token operator">|</span> bash</span>
<span class="line">source <span class="token operator">/</span>root<span class="token operator">/</span><span class="token punctuation">.</span>bashrc</span>
<span class="line">nvm install stable</span>
<span class="line">npm i cnpm <span class="token operator">-</span>g</span>
<span class="line">cnpm i nrm <span class="token operator">-</span>g</span>
<span class="line">cnpm i pm2 <span class="token operator">-</span>g</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div>`,242)])])}const i=n(l,[["render",t]]),c=JSON.parse('{"path":"/strong/70-deploy.html","title":"","lang":"en-US","frontmatter":{},"git":{"updatedTime":1681290319000,"contributors":[{"name":"yutao","username":"yutao","email":"642231346@qq.com","commits":1,"url":"https://github.com/yutao"}],"changelog":[{"hash":"f5ab8c9d34991ec274f7f652439afe5b2afb6147","time":1681290319000,"email":"642231346@qq.com","author":"yutao","message":"modify"}]},"filePathRelative":"strong/70-deploy.md"}');export{i as comp,c as data};
