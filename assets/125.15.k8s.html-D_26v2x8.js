import{_ as n,c as a,a as e,o as l}from"./app-CD1YpnS1.js";const p={};function i(t,s){return l(),a("div",null,[...s[0]||(s[0]=[e(`<h2 id="_1-灰度发布" tabindex="-1"><a class="header-anchor" href="#_1-灰度发布"><span>1.灰度发布</span></a></h2><ul><li>灰度发布是一种发布方式，也叫金丝雀发布</li><li>起源是矿工在下井之前会先放一只金丝雀到井里，如果金丝雀不叫了，就代表瓦斯浓度高。原因是金丝雀对瓦斯气体很敏感</li><li>灰度发布的做法是：会在现存旧应用的基础上，启动一个新版应用</li><li>但是新版应用并不会直接让用户访问。而是先让测试同学去进行测试。如果没有问题，则可以将真正的用户流量慢慢导入到新版</li><li>在这中间，持续对新版本运行状态做观察，直到慢慢切换过去，这就是所谓的A/B测试。当然，你也可以招募一些灰度用户，给他们设置独有的灰度标示（Cookie，Header），来让他们可以访问到新版应用</li><li>当然，如果中间切换出现问题，也应该将流量迅速地切换到老应用上 <img src="https://img.zhufengpeixun.com/7a69348037ccf22a240499919efff1e9" alt="jinsique"></li></ul><h3 id="_1-1-准备新版本service" tabindex="-1"><a class="header-anchor" href="#_1-1-准备新版本service"><span>1.1 准备新版本Service</span></a></h3><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text"><pre><code class="language-text"><span class="line">cp deployment-user-v1.yaml deployment-user-v2.yaml</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text"><pre><code class="language-text"><span class="line"> apiVersion: apps/v1  </span>
<span class="line"> kind: Deployment     </span>
<span class="line">metadata:</span>
<span class="line"> +  name: user-v2     </span>
<span class="line">spec:</span>
<span class="line">  selector:</span>
<span class="line">    matchLabels:</span>
<span class="line"> +      app: user-v2 </span>
<span class="line">   replicas: 3 </span>
<span class="line">  template:</span>
<span class="line">    metadata:</span>
<span class="line">      labels:</span>
<span class="line"> +        app: user-v2 </span>
<span class="line">     spec:   </span>
<span class="line">      containers:</span>
<span class="line">       - name: nginx </span>
<span class="line">+        image: registry.cn-beijing.aliyuncs.com/zhangrenyang/nginx:user-v2</span>
<span class="line">        ports:</span>
<span class="line">         - containerPort: 80 </span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>service-user-v2.yaml</p><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text"><pre><code class="language-text"><span class="line">apiVersion: v1</span>
<span class="line">kind: Service</span>
<span class="line">metadata:</span>
<span class="line">+  name: service-user-v2</span>
<span class="line">spec:</span>
<span class="line">  selector:</span>
<span class="line">+    app: user-v2</span>
<span class="line">  ports:</span>
<span class="line">  - protocol: TCP</span>
<span class="line">    port: 80</span>
<span class="line">    targetPort: 80</span>
<span class="line">  type: NodePort</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text"><pre><code class="language-text"><span class="line">kubectl apply -f deployment-user-v2.yaml service-user-v2.yaml</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><h3 id="_1-2-根据-cookie-切分流量" tabindex="-1"><a class="header-anchor" href="#_1-2-根据-cookie-切分流量"><span>1.2 根据 Cookie 切分流量</span></a></h3><ul><li><p>基于 Cookie 切分流量。这种实现原理主要根据用户请求中的 Cookie 是否存在灰度标示 Cookie去判断是否为灰度用户，再决定是否返回灰度版本服务</p></li><li><p><code>nginx.ingress.kubernetes.io/canary</code>：可选值为 true / false 。代表是否开启灰度功能</p></li><li><p><code>nginx.ingress.kubernetes.io/canary-by-cookie</code>：灰度发布 cookie 的 key。当 key 值等于 always 时，灰度触发生效。等于其他值时，则不会走灰度环境 ingress-gray.yaml</p><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text"><pre><code class="language-text"><span class="line">apiVersion: extensions/v1beta1</span>
<span class="line">kind: Ingress</span>
<span class="line">metadata:</span>
<span class="line">name: user-canary</span>
<span class="line">annotations:</span>
<span class="line">  kubernetes.io/ingress.class: nginx</span>
<span class="line">  nginx.ingress.kubernetes.io/rewrite-target: /</span>
<span class="line">  nginx.ingress.kubernetes.io/canary: &quot;true&quot;</span>
<span class="line">  nginx.ingress.kubernetes.io/canary-by-cookie: &quot;vip_user&quot;</span>
<span class="line">spec:</span>
<span class="line">rules:</span>
<span class="line">- http:</span>
<span class="line">    paths: </span>
<span class="line">     - backend:</span>
<span class="line">        serviceName: service-user-v2</span>
<span class="line">        servicePort: 80</span>
<span class="line">backend:</span>
<span class="line">   serviceName: service-user-v2</span>
<span class="line">   servicePort: 80</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></li><li><p>生效配置文件</p><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text"><pre><code class="language-text"><span class="line">kubectl apply -f ./ingress-gray.yaml </span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div></li><li><p>来获取 ingress 的外部端口</p></li><li><p>-n: 根据资源名称进行模糊查询</p><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code class="language-javascript"><span class="line">kubectl <span class="token operator">-</span>n ingress<span class="token operator">-</span>nginx <span class="token keyword">get</span> svc</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code class="language-javascript"><span class="line">curl http<span class="token operator">:</span><span class="token operator">/</span><span class="token operator">/</span><span class="token number">172.31</span><span class="token number">.178</span><span class="token number">.169</span><span class="token operator">:</span><span class="token number">31234</span><span class="token operator">/</span>user</span>
<span class="line">curl http<span class="token operator">:</span><span class="token operator">/</span><span class="token operator">/</span><span class="token number">118.190</span><span class="token number">.156</span><span class="token number">.138</span><span class="token operator">:</span><span class="token number">31234</span><span class="token operator">/</span>user</span>
<span class="line">curl <span class="token operator">--</span>cookie <span class="token string">&quot;vip_user=always&quot;</span>  <span class="token literal-property property">http</span><span class="token operator">:</span><span class="token operator">/</span><span class="token operator">/</span><span class="token number">172.31</span><span class="token number">.178</span><span class="token number">.169</span><span class="token operator">:</span><span class="token number">31234</span><span class="token operator">/</span>user</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></li></ul><h3 id="_1-3-基于-header-切分流量" tabindex="-1"><a class="header-anchor" href="#_1-3-基于-header-切分流量"><span>1.3 基于 Header 切分流量</span></a></h3><ul><li>基于 Header 切分流量，这种实现原理主要根据用户请求中的 header 是否存在灰度标示 header去判断是否为灰度用户，再决定是否返回灰度版本服务</li></ul><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text"><pre><code class="language-text"><span class="line">vi ingress-gray.yaml </span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text"><pre><code class="language-text"><span class="line">apiVersion: extensions/v1beta1</span>
<span class="line">kind: Ingress</span>
<span class="line">metadata:</span>
<span class="line">  name: user-canary</span>
<span class="line">  annotations:</span>
<span class="line">    kubernetes.io/ingress.class: nginx</span>
<span class="line">    nginx.ingress.kubernetes.io/rewrite-target: /</span>
<span class="line">    nginx.ingress.kubernetes.io/canary: &quot;true&quot;</span>
<span class="line">+    nginx.ingress.kubernetes.io/canary-by-header: &quot;name&quot;</span>
<span class="line">+    nginx.ingress.kubernetes.io/canary-by-header-value: &quot;vip&quot;</span>
<span class="line">spec:</span>
<span class="line">  rules:</span>
<span class="line">  - http:</span>
<span class="line">      paths: </span>
<span class="line">       - backend:</span>
<span class="line">          serviceName: service-user-v2</span>
<span class="line">          servicePort: 80</span>
<span class="line">  backend:</span>
<span class="line">     serviceName: service-user-v2</span>
<span class="line">     servicePort: 80</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code class="language-javascript"><span class="line">kubectl apply <span class="token operator">-</span>f ingress<span class="token operator">-</span>gray<span class="token punctuation">.</span>yaml</span>
<span class="line">curl <span class="token operator">--</span>header <span class="token string">&quot;name:vip&quot;</span>  <span class="token literal-property property">http</span><span class="token operator">:</span><span class="token operator">/</span><span class="token operator">/</span><span class="token number">172.31</span><span class="token number">.178</span><span class="token number">.169</span><span class="token operator">:</span><span class="token number">31234</span><span class="token operator">/</span>user</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_1-4-基于权重切分流量" tabindex="-1"><a class="header-anchor" href="#_1-4-基于权重切分流量"><span>1.4 基于权重切分流量</span></a></h3><ul><li>这种实现原理主要是根据用户请求，通过根据灰度百分比决定是否转发到灰度服务环境中</li><li><code>nginx.ingress.kubernetes.io/canary-weight</code>：值是字符串，为 0-100 的数字，代表灰度环境命中概率。如果值为 0，则表示不会走灰度。值越大命中概率越大。当值 = 100 时，代表全走灰度</li></ul><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text"><pre><code class="language-text"><span class="line">vi ingress-gray.yaml </span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text"><pre><code class="language-text"><span class="line">apiVersion: extensions/v1beta1</span>
<span class="line">kind: Ingress</span>
<span class="line">metadata:</span>
<span class="line">  name: user-canary</span>
<span class="line">  annotations:</span>
<span class="line">    kubernetes.io/ingress.class: nginx</span>
<span class="line">    nginx.ingress.kubernetes.io/rewrite-target: /</span>
<span class="line">    nginx.ingress.kubernetes.io/canary: &quot;true&quot;</span>
<span class="line">+   nginx.ingress.kubernetes.io/canary-weight: &quot;50&quot;</span>
<span class="line">spec:</span>
<span class="line">  rules:</span>
<span class="line">  - http:</span>
<span class="line">      paths: </span>
<span class="line">       - backend:</span>
<span class="line">          serviceName: service-user-v2</span>
<span class="line">          servicePort: 80</span>
<span class="line">  backend:</span>
<span class="line">     serviceName: service-user-v2</span>
<span class="line">     servicePort: 80</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code class="language-javascript"><span class="line">kubectl apply <span class="token operator">-</span>f ingress<span class="token operator">-</span>gray<span class="token punctuation">.</span>yaml</span>
<span class="line"><span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>i<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span> i<span class="token operator">&lt;=</span><span class="token number">10</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token keyword">do</span> curl http<span class="token operator">:</span><span class="token operator">/</span><span class="token operator">/</span><span class="token number">172.31</span><span class="token number">.178</span><span class="token number">.169</span><span class="token operator">:</span><span class="token number">31234</span><span class="token operator">/</span>user<span class="token punctuation">;</span> done</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_1-5-优先级" tabindex="-1"><a class="header-anchor" href="#_1-5-优先级"><span>1.5 优先级</span></a></h3><ul><li>canary-by-header -&gt; canary-by-cookie -&gt; canary-weight</li><li>k8s 会优先去匹配 header ，如果未匹配则去匹配 cookie ，最后是 weight</li></ul><h2 id="_2-滚动发布" tabindex="-1"><a class="header-anchor" href="#_2-滚动发布"><span>2.滚动发布</span></a></h2><ul><li>滚动发布，则是我们一般所说的无宕机发布。其发布方式如同名称一样，一次取出一台/多台服务器（看策略配置）进行新版本更新。当取出的服务器新版确保无问题后，接着采用同等方式更新后面的服务器</li><li>k8s创建副本应用程序的最佳方法就是部署(Deployment)，部署自动创建副本集(ReplicaSet)，副本集可以精确地控制每次替换的Pod数量，从而可以很好的实现滚动更新</li><li>k8s每次使用一个新的副本控制器(replication controller)来替换已存在的副本控制器，从而始终使用一个新的Pod模板来替换旧的pod模板 <ul><li>创建一个新的replication controller</li><li>增加或减少pod副本数量，直到满足当前批次期望的数量</li><li>删除旧的replication controller</li></ul></li></ul><h3 id="_2-1-发布流程和策略" tabindex="-1"><a class="header-anchor" href="#_2-1-发布流程和策略"><span>2.1 发布流程和策略</span></a></h3><ul><li>优点 <ul><li>不需要停机更新，无感知平滑更新。</li><li>版本更新成本小,不需要新旧版本共存</li></ul></li><li>缺点 <ul><li>更新时间长：每次只更新一个/多个镜像，需要频繁连续等待服务启动缓冲</li><li>旧版本环境无法得到备份：始终只有一个环境存在</li><li>回滚版本异常痛苦：如果滚动发布到一半出了问题，回滚时需要使用同样的滚动策略回滚旧版本</li></ul></li></ul><p><img src="https://img.zhufengpeixun.com/2f0529036ed8d4da16567297105a5d7f" alt=""> <img src="https://img.zhufengpeixun.com/00a2eaa29b202b63619b5f70f8abba22" alt=""> <img src="https://img.zhufengpeixun.com/39a62f4e6d3c3e91260268528de6723a" alt=""> <img src="https://img.zhufengpeixun.com/d132b095703f8563e946e1b49a6391c6" alt=""> <img src="https://img.zhufengpeixun.com/5f8473671577b28825421ddb705c668e" alt=""></p><h3 id="_2-2-配置文件" tabindex="-1"><a class="header-anchor" href="#_2-2-配置文件"><span>2.2 配置文件</span></a></h3><ul><li>先扩容为10个副本<div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code class="language-javascript"><span class="line">kubectl <span class="token keyword">get</span> deploy</span>
<span class="line">kubectl scale deployment user<span class="token operator">-</span>v1  <span class="token operator">--</span>replicas<span class="token operator">=</span><span class="token number">10</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div></div></div></li></ul><p>deployment-user-v1.yaml</p><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text"><pre><code class="language-text"><span class="line"> apiVersion: apps/v1  </span>
<span class="line"> kind: Deployment     </span>
<span class="line">metadata:</span>
<span class="line">   name: user-v1     </span>
<span class="line">spec:</span>
<span class="line">  minReadySeconds: 1</span>
<span class="line">+ strategy:</span>
<span class="line">+   type: RollingUpdate</span>
<span class="line">+   rollingUpdate:</span>
<span class="line">+     maxSurge: 1</span>
<span class="line">+     maxUnavailable: 0</span>
<span class="line">+ selector:</span>
<span class="line">+   matchLabels:</span>
<span class="line"> +     app: user-v1 </span>
<span class="line">   replicas: 10 </span>
<span class="line">  template:</span>
<span class="line">    metadata:</span>
<span class="line">      labels:</span>
<span class="line">         app: user-v1 </span>
<span class="line">     spec:   </span>
<span class="line">      containers:</span>
<span class="line">       - name: nginx </span>
<span class="line"> +       image: registry.cn-beijing.aliyuncs.com/zhangrenyang/nginx:user-v3 </span>
<span class="line">        ports:</span>
<span class="line">         - containerPort: 80 </span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><table><thead><tr><th style="text-align:left;">参数</th><th style="text-align:left;">含义</th></tr></thead><tbody><tr><td style="text-align:left;">minReadySeconds</td><td style="text-align:left;">容器接受流量延缓时间：单位为秒，默认为0。如果没有设置的话，k8s会认为容器启动成功后就可以用了。设置该值可以延缓容器流量切分</td></tr><tr><td style="text-align:left;">strategy.type = RollingUpdate</td><td style="text-align:left;">ReplicaSet 发布类型，声明为滚动发布，默认也为滚动发布</td></tr><tr><td style="text-align:left;">strategy.rollingUpdate.maxSurge</td><td style="text-align:left;">最多Pod数量：为数字类型/百分比。如果 maxSurge 设置为1，replicas 设置为10，则在发布过程中pod数量最多为10 + 1个（多出来的为旧版本pod，平滑期不可用状态）。maxUnavailable 为 0 时，该值也不能设置为0</td></tr><tr><td style="text-align:left;">strategy.rollingUpdate.maxUnavailable</td><td style="text-align:left;">升级中最多不可用pod的数量：为数字类型/百分比。当 maxSurge 为 0 时，该值也不能设置为0</td></tr></tbody></table><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text"><pre><code class="language-text"><span class="line">kubectl apply -f ./deployment-user-v1.yaml</span>
<span class="line">deployment.apps/user-v1 configured</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code class="language-javascript"><span class="line">kubectl rollout status deployment<span class="token operator">/</span>user<span class="token operator">-</span>v1</span>
<span class="line">Waiting <span class="token keyword">for</span> deployment <span class="token string">&quot;user-v1&quot;</span> rollout to finish<span class="token operator">:</span> <span class="token number">3</span> <span class="token keyword">of</span> <span class="token number">10</span> updated replicas are available<span class="token operator">...</span></span>
<span class="line">Waiting <span class="token keyword">for</span> deployment <span class="token string">&quot;user-v1&quot;</span> rollout to finish<span class="token operator">:</span> <span class="token number">3</span> <span class="token keyword">of</span> <span class="token number">10</span> updated replicas are available<span class="token operator">...</span></span>
<span class="line">Waiting <span class="token keyword">for</span> deployment <span class="token string">&quot;user-v1&quot;</span> rollout to finish<span class="token operator">:</span> <span class="token number">4</span> <span class="token keyword">of</span> <span class="token number">10</span> updated replicas are available<span class="token operator">...</span></span>
<span class="line">Waiting <span class="token keyword">for</span> deployment <span class="token string">&quot;user-v1&quot;</span> rollout to finish<span class="token operator">:</span> <span class="token number">4</span> <span class="token keyword">of</span> <span class="token number">10</span> updated replicas are available<span class="token operator">...</span></span>
<span class="line">Waiting <span class="token keyword">for</span> deployment <span class="token string">&quot;user-v1&quot;</span> rollout to finish<span class="token operator">:</span> <span class="token number">4</span> <span class="token keyword">of</span> <span class="token number">10</span> updated replicas are available<span class="token operator">...</span></span>
<span class="line">Waiting <span class="token keyword">for</span> deployment <span class="token string">&quot;user-v1&quot;</span> rollout to finish<span class="token operator">:</span> <span class="token number">4</span> <span class="token keyword">of</span> <span class="token number">10</span> updated replicas are available<span class="token operator">...</span></span>
<span class="line">Waiting <span class="token keyword">for</span> deployment <span class="token string">&quot;user-v1&quot;</span> rollout to finish<span class="token operator">:</span> <span class="token number">4</span> <span class="token keyword">of</span> <span class="token number">10</span> updated replicas are available<span class="token operator">...</span></span>
<span class="line">Waiting <span class="token keyword">for</span> deployment <span class="token string">&quot;user-v1&quot;</span> rollout to finish<span class="token operator">:</span> <span class="token number">4</span> <span class="token keyword">of</span> <span class="token number">10</span> updated replicas are available<span class="token operator">...</span></span>
<span class="line">deployment <span class="token string">&quot;user-v1&quot;</span> successfully rolled out</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="_3-服务可用性探针" tabindex="-1"><a class="header-anchor" href="#_3-服务可用性探针"><span>3.服务可用性探针</span></a></h2><h3 id="_3-1-什么是健康度检查" tabindex="-1"><a class="header-anchor" href="#_3-1-什么是健康度检查"><span>3.1 什么是健康度检查？</span></a></h3><ul><li>当 Pod 的状态为 Running 时，该 Pod 就可以被分配流量(可以访问到)了</li><li>一个后端容器启动成功，不一定不代表服务启动成功</li></ul><h3 id="_3-2-什么是服务探针" tabindex="-1"><a class="header-anchor" href="#_3-2-什么是服务探针"><span>3.2 什么是服务探针？</span></a></h3><ul><li>[define-a-TCP-liveness-probe](https://kubernetes.io/zh/docs/tasks/configure-pod-container/configure-liveness-readiness-startup-probes/</li><li><h4 id="_3-2-1-存活探针-livenessprobe" tabindex="-1"><a class="header-anchor" href="#_3-2-1-存活探针-livenessprobe"><span>3.2.1 存活探针 LivenessProbe</span></a></h4></li><li>第一种是存活探针。存活探针是对运行中的容器检测的。如果想检测你的服务在运行中有没有发生崩溃，服务有没有中途退出或无响应，可以使用这个探针</li><li>如果探针探测到错误， Kubernetes 就会杀掉这个 Pod；否则就不会进行处理。如果默认没有配置这个探针， Pod 不会被杀死</li></ul><h4 id="_3-2-2-可用探针-readinessprobe" tabindex="-1"><a class="header-anchor" href="#_3-2-2-可用探针-readinessprobe"><span>3.2.2 可用探针 ReadinessProbe</span></a></h4><ul><li>第二种是可用探针。作用是用来检测 Pod 是否允许被访问到（是否准备好接受流量）。如果你的服务加载很多数据，或者有其他需求要求在特定情况下不被分配到流量，那么可以用这个探针</li><li>如果探针检测失败，流量就不会分配给该 Pod。在没有配置该探针的情况下，会一直将流量分配给 Pod。当然，探针检测失败，Pod 不会被杀死</li></ul><h4 id="_3-2-3-启动探针-startupprobe" tabindex="-1"><a class="header-anchor" href="#_3-2-3-启动探针-startupprobe"><span>3.2.3 启动探针 StartupProbe</span></a></h4><ul><li>第三种是启动探针。作用是用来检测 Pod 是否已经启动成功。如果你的服务启动需要一些加载时长（例如初始化日志，等待其他调用的服务启动成功）才代表服务启动成功，则可以用这个探针。</li><li>如果探针检测失败，该 Pod 就会被杀死重启。在没有配置该探针的情况下，默认不会杀死 Pod 。在启动探针运行时，其他所有的探针检测都会失效</li></ul><table><thead><tr><th style="text-align:left;">探针名称</th><th style="text-align:left;">在哪个环节触发</th><th style="text-align:left;">作用</th><th style="text-align:left;">检测失败对Pod的反应</th></tr></thead><tbody><tr><td style="text-align:left;">启动探针</td><td style="text-align:left;">Pod 运行时</td><td style="text-align:left;">检测服务是否启动成功</td><td style="text-align:left;">杀死 Pod 并重启</td></tr><tr><td style="text-align:left;">存活探针</td><td style="text-align:left;">Pod 运行时</td><td style="text-align:left;">检测服务是否崩溃，是否需要重启服务</td><td style="text-align:left;">杀死 Pod 并重启</td></tr><tr><td style="text-align:left;">可用探针</td><td style="text-align:left;">Pod 运行时</td><td style="text-align:left;">检测服务是不是允许被访问到</td><td style="text-align:left;">停止Pod的访问调度，不会被杀死重启</td></tr></tbody></table><h3 id="_3-3-探测方式" tabindex="-1"><a class="header-anchor" href="#_3-3-探测方式"><span>3.3 探测方式</span></a></h3><h4 id="_3-3-1-execaction" tabindex="-1"><a class="header-anchor" href="#_3-3-1-execaction"><span>3.3.1 ExecAction</span></a></h4><ul><li>通过在 Pod 的容器内执行预定的 Shell 脚本命令。如果执行的命令没有报错退出（返回值为0），代表容器状态健康。否则就是有问题的</li></ul><p>vi shell-probe.yaml</p><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code class="language-javascript"><span class="line"><span class="token literal-property property">apiVersion</span><span class="token operator">:</span> v1</span>
<span class="line"><span class="token literal-property property">kind</span><span class="token operator">:</span> Pod</span>
<span class="line"><span class="token literal-property property">metadata</span><span class="token operator">:</span></span>
<span class="line">  <span class="token literal-property property">labels</span><span class="token operator">:</span></span>
<span class="line">    <span class="token literal-property property">test</span><span class="token operator">:</span> shell<span class="token operator">-</span>probe</span>
<span class="line">  <span class="token literal-property property">name</span><span class="token operator">:</span> shell<span class="token operator">-</span>probe</span>
<span class="line"><span class="token literal-property property">spec</span><span class="token operator">:</span></span>
<span class="line">  <span class="token literal-property property">containers</span><span class="token operator">:</span></span>
<span class="line">  <span class="token operator">-</span> name<span class="token operator">:</span> shell<span class="token operator">-</span>probe</span>
<span class="line">    <span class="token literal-property property">image</span><span class="token operator">:</span> registry<span class="token punctuation">.</span>aliyuncs<span class="token punctuation">.</span>com<span class="token operator">/</span>google_containers<span class="token operator">/</span>busybox</span>
<span class="line">    <span class="token literal-property property">args</span><span class="token operator">:</span></span>
<span class="line">    <span class="token operator">-</span> <span class="token operator">/</span>bin<span class="token operator">/</span>sh</span>
<span class="line">    <span class="token operator">-</span> <span class="token operator">-</span>c</span>
<span class="line">    <span class="token operator">-</span> touch <span class="token operator">/</span>tmp<span class="token operator">/</span>healthy<span class="token punctuation">;</span> sleep <span class="token number">30</span><span class="token punctuation">;</span> rm <span class="token operator">-</span>rf <span class="token operator">/</span>tmp<span class="token operator">/</span>healthy<span class="token punctuation">;</span> sleep <span class="token number">600</span></span>
<span class="line">    <span class="token literal-property property">livenessProbe</span><span class="token operator">:</span></span>
<span class="line">      <span class="token literal-property property">exec</span><span class="token operator">:</span></span>
<span class="line">        <span class="token literal-property property">command</span><span class="token operator">:</span></span>
<span class="line">        <span class="token operator">-</span> cat</span>
<span class="line">        <span class="token operator">-</span> <span class="token operator">/</span>tmp<span class="token operator">/</span>healthy</span>
<span class="line">      <span class="token literal-property property">initialDelaySeconds</span><span class="token operator">:</span> <span class="token number">5</span></span>
<span class="line">      <span class="token literal-property property">periodSeconds</span><span class="token operator">:</span> <span class="token number">5</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code class="language-javascript"><span class="line">kubectl apply <span class="token operator">-</span>f liveness<span class="token punctuation">.</span>yaml </span>
<span class="line">kubectl <span class="token keyword">get</span> pods <span class="token operator">|</span> grep liveness<span class="token operator">-</span>exec</span>
<span class="line">kubectl describe pods liveness<span class="token operator">-</span>exec</span>
<span class="line"></span>
<span class="line"><span class="token literal-property property">Events</span><span class="token operator">:</span></span>
<span class="line">  Type     Reason     Age                  From               Message</span>
<span class="line">  <span class="token operator">--</span><span class="token operator">--</span>     <span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span>     <span class="token operator">--</span><span class="token operator">--</span>                 <span class="token operator">--</span><span class="token operator">--</span>               <span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">-</span></span>
<span class="line">  Normal   Scheduled  2m44s                <span class="token keyword">default</span><span class="token operator">-</span>scheduler  Successfully assigned <span class="token keyword">default</span><span class="token operator">/</span>liveness<span class="token operator">-</span>exec to node1</span>
<span class="line">  Normal   Pulled     2m41s                kubelet            Successfully pulled image <span class="token string">&quot;registry.aliyuncs.com/google_containers/busybox&quot;</span> <span class="token keyword">in</span> <span class="token number">1</span><span class="token punctuation">.</span>669600584s</span>
<span class="line">  Normal   Pulled     86s                  kubelet            Successfully pulled image <span class="token string">&quot;registry.aliyuncs.com/google_containers/busybox&quot;</span> <span class="token keyword">in</span> <span class="token number">605</span><span class="token punctuation">.</span>008964ms</span>
<span class="line">  Warning  Unhealthy  <span class="token number">41</span><span class="token function">s</span> <span class="token punctuation">(</span>x6 over 2m6s<span class="token punctuation">)</span>   kubelet            Liveness probe failed<span class="token operator">:</span> cat<span class="token operator">:</span> can<span class="token string">&#39;t open &#39;</span><span class="token operator">/</span>tmp<span class="token operator">/</span>healthy&#39;<span class="token operator">:</span> No such file or directory</span>
<span class="line">  Normal   Killing    <span class="token number">41</span><span class="token function">s</span> <span class="token punctuation">(</span>x2 over 116s<span class="token punctuation">)</span>   kubelet            Container liveness failed liveness probe<span class="token punctuation">,</span> will be restarted</span>
<span class="line">  Normal   Created    <span class="token number">11</span><span class="token function">s</span> <span class="token punctuation">(</span>x3 over 2m41s<span class="token punctuation">)</span>  kubelet            Created container liveness</span>
<span class="line">  Normal   Started    <span class="token number">11</span><span class="token function">s</span> <span class="token punctuation">(</span>x3 over 2m41s<span class="token punctuation">)</span>  kubelet            Started container liveness</span>
<span class="line">  Normal   Pulling    <span class="token number">11</span><span class="token function">s</span> <span class="token punctuation">(</span>x3 over 2m43s<span class="token punctuation">)</span>  kubelet            Pulling image <span class="token string">&quot;registry.aliyuncs.com/google_containers/busybox&quot;</span></span>
<span class="line">  Normal   Pulled     11s                  kubelet            Successfully pulled image <span class="token string">&quot;registry.aliyuncs.com/google_containers/busybox&quot;</span> <span class="token keyword">in</span> <span class="token number">521</span><span class="token punctuation">.</span>70892ms</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_3-3-2-tcpsocketaction" tabindex="-1"><a class="header-anchor" href="#_3-3-2-tcpsocketaction"><span>3.3.2 TCPSocketAction</span></a></h4><ul><li>这种方式是使用 TCP 套接字检测。 Kubernetes 会尝试在 Pod 内与指定的端口进行连接。如果能建立连接（Pod的端口打开了），这个容器就代表是健康的，如果不能，则代表这个 Pod 就是有问题的</li></ul><p>tcp-probe.yaml</p><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code class="language-javascript"><span class="line"><span class="token literal-property property">apiVersion</span><span class="token operator">:</span> v1</span>
<span class="line"><span class="token literal-property property">kind</span><span class="token operator">:</span> Pod</span>
<span class="line"><span class="token literal-property property">metadata</span><span class="token operator">:</span></span>
<span class="line">  <span class="token literal-property property">name</span><span class="token operator">:</span> tcp<span class="token operator">-</span>probe</span>
<span class="line">  <span class="token literal-property property">labels</span><span class="token operator">:</span></span>
<span class="line">    <span class="token literal-property property">app</span><span class="token operator">:</span> tcp<span class="token operator">-</span>probe</span>
<span class="line"><span class="token literal-property property">spec</span><span class="token operator">:</span></span>
<span class="line">  <span class="token literal-property property">containers</span><span class="token operator">:</span></span>
<span class="line">  <span class="token operator">-</span> name<span class="token operator">:</span> tcp<span class="token operator">-</span>probe</span>
<span class="line">    <span class="token literal-property property">image</span><span class="token operator">:</span> nginx</span>
<span class="line">    <span class="token literal-property property">ports</span><span class="token operator">:</span></span>
<span class="line">    <span class="token operator">-</span> containerPort<span class="token operator">:</span> <span class="token number">80</span></span>
<span class="line">    <span class="token literal-property property">readinessProbe</span><span class="token operator">:</span></span>
<span class="line">      <span class="token literal-property property">tcpSocket</span><span class="token operator">:</span></span>
<span class="line">        <span class="token literal-property property">port</span><span class="token operator">:</span> <span class="token number">80</span></span>
<span class="line">      <span class="token literal-property property">initialDelaySeconds</span><span class="token operator">:</span> <span class="token number">5</span></span>
<span class="line">      <span class="token literal-property property">periodSeconds</span><span class="token operator">:</span> <span class="token number">10</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code class="language-javascript"><span class="line">kubectl apply <span class="token operator">-</span>f tcp<span class="token operator">-</span>probe<span class="token punctuation">.</span>yaml </span>
<span class="line">kubectl <span class="token keyword">get</span> pods <span class="token operator">|</span> grep tcp<span class="token operator">-</span>probe</span>
<span class="line">kubectl describe pods tcp<span class="token operator">-</span>probe</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code class="language-javascript"><span class="line">kubectl exec <span class="token operator">-</span>it tcp<span class="token operator">-</span>probe  <span class="token operator">--</span> <span class="token operator">/</span>bin<span class="token operator">/</span>sh</span>
<span class="line">apt<span class="token operator">-</span><span class="token keyword">get</span> update</span>
<span class="line">apt<span class="token operator">-</span><span class="token keyword">get</span> install vim <span class="token operator">-</span>y</span>
<span class="line">vi  <span class="token operator">/</span>etc<span class="token operator">/</span>nginx<span class="token operator">/</span>conf<span class="token punctuation">.</span>d<span class="token operator">/</span><span class="token keyword">default</span><span class="token punctuation">.</span>conf</span>
<span class="line"><span class="token number">80</span><span class="token operator">=&gt;</span><span class="token number">8080</span></span>
<span class="line">nginx <span class="token operator">-</span>s reload</span>
<span class="line">kubectl describe pod tcp<span class="token operator">-</span>probe</span>
<span class="line">Warning  Unhealthy  6s    kubelet            Readiness probe failed<span class="token operator">:</span> dial tcp <span class="token number">10.244</span><span class="token number">.1</span><span class="token number">.47</span><span class="token operator">:</span><span class="token number">80</span><span class="token operator">:</span> connect<span class="token operator">:</span> connection </span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_3-3-3-httpgetaction" tabindex="-1"><a class="header-anchor" href="#_3-3-3-httpgetaction"><span>3.3.3 HTTPGetAction</span></a></h4><ul><li>这种方式是使用 HTTP GET 请求。Kubernetes 会尝试访问 Pod 内指定的API路径。如果返回200，代表容器就是健康的。如果不能，代表这个 Pod 是有问题的</li></ul><p>vi http-probe.yaml</p><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text"><pre><code class="language-text"><span class="line">apiVersion: v1</span>
<span class="line">kind: Pod</span>
<span class="line">metadata:</span>
<span class="line">  labels:</span>
<span class="line">    test: http-probe</span>
<span class="line">  name: http-probe</span>
<span class="line">spec:</span>
<span class="line">  containers:</span>
<span class="line">  - name: http-probe</span>
<span class="line">    image: registry.cn-beijing.aliyuncs.com/zhangrenyang/http-probe:1.0.0</span>
<span class="line">    livenessProbe:</span>
<span class="line">      httpGet:</span>
<span class="line">        path: /liveness</span>
<span class="line">        port: 80</span>
<span class="line">        httpHeaders:</span>
<span class="line">        - name: source</span>
<span class="line">          value: probe</span>
<span class="line">      initialDelaySeconds: 3</span>
<span class="line">      periodSeconds: 3</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code class="language-javascript"><span class="line">vim <span class="token punctuation">.</span><span class="token operator">/</span>http<span class="token operator">-</span>probe<span class="token punctuation">.</span>yaml</span>
<span class="line">kubectl apply <span class="token operator">-</span>f <span class="token punctuation">.</span><span class="token operator">/</span>http<span class="token operator">-</span>probe<span class="token punctuation">.</span>yaml</span>
<span class="line">kubectl describe pods http<span class="token operator">-</span>probe</span>
<span class="line">Normal   Killing    5s                kubelet            Container http<span class="token operator">-</span>probe failed liveness probe<span class="token punctuation">,</span> will be restarted</span>
<span class="line">docker pull registry<span class="token punctuation">.</span>cn<span class="token operator">-</span>beijing<span class="token punctuation">.</span>aliyuncs<span class="token punctuation">.</span>com<span class="token operator">/</span>zhangrenyang<span class="token operator">/</span>http<span class="token operator">-</span>probe<span class="token operator">:</span><span class="token number">1.0</span><span class="token number">.0</span></span>
<span class="line">kubectl replace <span class="token operator">--</span>force <span class="token operator">-</span>f http<span class="token operator">-</span>probe<span class="token punctuation">.</span>yaml </span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>Dockerfile</p><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code class="language-javascript"><span class="line"><span class="token constant">FROM</span> node</span>
<span class="line"><span class="token constant">COPY</span> <span class="token punctuation">.</span><span class="token operator">/</span>app <span class="token operator">/</span>app</span>
<span class="line"><span class="token constant">WORKDIR</span> <span class="token operator">/</span>app</span>
<span class="line"><span class="token constant">EXPOSE</span> <span class="token number">3000</span></span>
<span class="line"><span class="token constant">CMD</span> node index<span class="token punctuation">.</span>js</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code class="language-javascript"><span class="line"><span class="token keyword">let</span> http <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&#39;http&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">let</span> start <span class="token operator">=</span> Date<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">http<span class="token punctuation">.</span><span class="token function">createServer</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span>res</span><span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line">  <span class="token keyword">if</span><span class="token punctuation">(</span>req<span class="token punctuation">.</span>url <span class="token operator">===</span> <span class="token string">&#39;/liveness&#39;</span><span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">let</span> value <span class="token operator">=</span> req<span class="token punctuation">.</span>headers<span class="token punctuation">[</span><span class="token string">&#39;source&#39;</span><span class="token punctuation">]</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">if</span><span class="token punctuation">(</span>value <span class="token operator">===</span> <span class="token string">&#39;probe&#39;</span><span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line">     <span class="token keyword">let</span> duration <span class="token operator">=</span> Date<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-</span>start<span class="token punctuation">;</span></span>
<span class="line">      <span class="token keyword">if</span><span class="token punctuation">(</span>duration<span class="token operator">&gt;</span><span class="token number">10</span><span class="token operator">*</span><span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line">          res<span class="token punctuation">.</span>statusCode<span class="token operator">=</span><span class="token number">500</span><span class="token punctuation">;</span></span>
<span class="line">          res<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token string">&#39;error&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">      <span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{</span></span>
<span class="line">          res<span class="token punctuation">.</span>statusCode<span class="token operator">=</span><span class="token number">200</span><span class="token punctuation">;</span></span>
<span class="line">          res<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token string">&#39;success&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">      <span class="token punctuation">}</span></span>
<span class="line">    <span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{</span></span>
<span class="line">     res<span class="token punctuation">.</span>statusCode<span class="token operator">=</span><span class="token number">200</span><span class="token punctuation">;</span></span>
<span class="line">     res<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token string">&#39;liveness&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">  <span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{</span></span>
<span class="line">     res<span class="token punctuation">.</span>statusCode<span class="token operator">=</span><span class="token number">200</span><span class="token punctuation">;</span></span>
<span class="line">     res<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token string">&#39;liveness&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">  <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span><span class="token number">3000</span><span class="token punctuation">,</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;http server started on 3000&quot;</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="_4-储存机密信息" tabindex="-1"><a class="header-anchor" href="#_4-储存机密信息"><span>4.储存机密信息</span></a></h2><h3 id="_4-1-什么是-secret" tabindex="-1"><a class="header-anchor" href="#_4-1-什么是-secret"><span>4.1 什么是 Secret</span></a></h3><ul><li>Secret 是 Kubernetes 内的一种资源类型，可以用它来存放一些机密信息（密码，token，密钥等）</li><li>信息被存入后，我们可以使用挂载卷的方式挂载进我们的 Pod 内。当然也可以存放docker私有镜像库的登录名和密码，用于拉取私有镜像。</li></ul><h3 id="_4-2-opaque-类型" tabindex="-1"><a class="header-anchor" href="#_4-2-opaque-类型"><span>4.2 Opaque 类型</span></a></h3><ul><li>一般拿来存放密码，密钥等信息，存储格式为 base64</li></ul><h4 id="_4-2-1-命令行创建" tabindex="-1"><a class="header-anchor" href="#_4-2-1-命令行创建"><span>4.2.1 命令行创建</span></a></h4><ul><li>account为 自定义的名称</li><li>--from-literal 的后面则跟随一组 key=value</li></ul><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code class="language-javascript"><span class="line">kubectl create secret generic mysql<span class="token operator">-</span>account <span class="token operator">--</span>from<span class="token operator">-</span>literal<span class="token operator">=</span>username<span class="token operator">=</span>zhufeng <span class="token operator">--</span>from<span class="token operator">-</span>literal<span class="token operator">=</span>password<span class="token operator">=</span><span class="token number">123456</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code class="language-javascript"><span class="line">kubectl <span class="token keyword">get</span> secret</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><table><thead><tr><th style="text-align:left;">字段</th><th style="text-align:left;">含义</th></tr></thead><tbody><tr><td style="text-align:left;">NAME</td><td style="text-align:left;">Secret的名称</td></tr><tr><td style="text-align:left;">TYPE</td><td style="text-align:left;">Secret的类型</td></tr><tr><td style="text-align:left;">DATA</td><td style="text-align:left;">存储内容的数量</td></tr><tr><td style="text-align:left;">AGE</td><td style="text-align:left;">创建到现在的时间</td></tr></tbody></table><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code class="language-javascript"><span class="line"><span class="token comment">//编辑值</span></span>
<span class="line">kubectl edit secret account</span>
<span class="line"><span class="token comment">//输出yaml格式</span></span>
<span class="line">kubectl <span class="token keyword">get</span> secret account <span class="token operator">-</span>o yaml</span>
<span class="line"><span class="token comment">//输出json格式</span></span>
<span class="line">kubectl <span class="token keyword">get</span> secret account <span class="token operator">-</span>o json</span>
<span class="line"><span class="token comment">//对Base64进行解码</span></span>
<span class="line">echo MTIzNDU2 <span class="token operator">|</span> base64 <span class="token operator">-</span>d</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_4-2-2-配置文件创建" tabindex="-1"><a class="header-anchor" href="#_4-2-2-配置文件创建"><span>4.2.2 配置文件创建</span></a></h4><p>mysql-account.yaml</p><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text"><pre><code class="language-text"><span class="line">apiVersion: v1</span>
<span class="line">kind: Secret</span>
<span class="line">metadata:</span>
<span class="line">  name: mysql-account</span>
<span class="line">stringData:</span>
<span class="line">  username: root</span>
<span class="line">  password: root</span>
<span class="line">type: Opaque</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code class="language-javascript"><span class="line">kubectl apply <span class="token operator">-</span>f mysql<span class="token operator">-</span>account<span class="token punctuation">.</span>yaml </span>
<span class="line">secret<span class="token operator">/</span>mysql<span class="token operator">-</span>account created</span>
<span class="line">kubectl <span class="token keyword">get</span> secret mysql<span class="token operator">-</span>account <span class="token operator">-</span>o yaml</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_4-3-私有镜像库认证" tabindex="-1"><a class="header-anchor" href="#_4-3-私有镜像库认证"><span>4.3 私有镜像库认证</span></a></h3><ul><li>第二种是私有镜像库认证类型，这种类型也比较常用，一般在拉取私有库的镜像时使用</li></ul><h4 id="_4-3-1-命令行创建" tabindex="-1"><a class="header-anchor" href="#_4-3-1-命令行创建"><span>4.3.1 命令行创建</span></a></h4><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text"><pre><code class="language-text"><span class="line">kubectl create secret docker-registry private-registry \\</span>
<span class="line">--docker-username=[用户名] \\</span>
<span class="line">--docker-password=[密码] \\</span>
<span class="line">--docker-email=[邮箱] \\</span>
<span class="line">--docker-server=[私有镜像库地址]</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code class="language-javascript"><span class="line"><span class="token comment">//查看私有库密钥组</span></span>
<span class="line">kubectl <span class="token keyword">get</span> secret <span class="token keyword">private</span><span class="token operator">-</span>registry <span class="token operator">-</span>o yaml</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text"><pre><code class="language-text"><span class="line">echo [value] | base64 -d</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><h4 id="_4-3-2-通过文件创建" tabindex="-1"><a class="header-anchor" href="#_4-3-2-通过文件创建"><span>4.3.2 通过文件创建</span></a></h4><p>vi private-registry-file.yaml</p><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code class="language-javascript"><span class="line"><span class="token literal-property property">apiVersion</span><span class="token operator">:</span> v1</span>
<span class="line"><span class="token literal-property property">kind</span><span class="token operator">:</span> Secret</span>
<span class="line"><span class="token literal-property property">metadata</span><span class="token operator">:</span></span>
<span class="line">  <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token keyword">private</span><span class="token operator">-</span>registry<span class="token operator">-</span>file</span>
<span class="line"><span class="token literal-property property">data</span><span class="token operator">:</span></span>
<span class="line">  <span class="token punctuation">.</span>dockerconfigjson<span class="token operator">:</span> eyJhdXRocyI6eyJodHRwczo</span>
<span class="line"><span class="token literal-property property">type</span><span class="token operator">:</span> kubernetes<span class="token punctuation">.</span>io<span class="token operator">/</span>dockerconfigjson</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code class="language-javascript"><span class="line">kubectl apply <span class="token operator">-</span>f <span class="token punctuation">.</span><span class="token operator">/</span><span class="token keyword">private</span><span class="token operator">-</span>registry<span class="token operator">-</span>file<span class="token punctuation">.</span>yaml</span>
<span class="line">kubectl <span class="token keyword">get</span> secret <span class="token keyword">private</span><span class="token operator">-</span>registry<span class="token operator">-</span>file <span class="token operator">-</span>o yaml</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_4-4-使用" tabindex="-1"><a class="header-anchor" href="#_4-4-使用"><span>4.4 使用</span></a></h3><h4 id="_4-4-1-volume-挂载" tabindex="-1"><a class="header-anchor" href="#_4-4-1-volume-挂载"><span>4.4.1 Volume 挂载</span></a></h4><ul><li>通过存储卷的方式挂载进去</li></ul><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text"><pre><code class="language-text"><span class="line"> apiVersion: apps/v1  </span>
<span class="line"> kind: Deployment     </span>
<span class="line">metadata:</span>
<span class="line">   name: user-v1     </span>
<span class="line">spec:</span>
<span class="line">  minReadySeconds: 1</span>
<span class="line">  strategy:</span>
<span class="line">    type: RollingUpdate</span>
<span class="line">    rollingUpdate:</span>
<span class="line">      maxSurge: 1</span>
<span class="line">      maxUnavailable: 0</span>
<span class="line">  selector:</span>
<span class="line">    matchLabels:</span>
<span class="line">       app: user-v1 </span>
<span class="line"> + replicas: 1 </span>
<span class="line">  template:</span>
<span class="line">    metadata:</span>
<span class="line">      labels:</span>
<span class="line">         app: user-v1 </span>
<span class="line">     spec:   </span>
<span class="line">+     volumes:</span>
<span class="line">+       - name: mysql-account</span>
<span class="line">+         secret:</span>
<span class="line">+           secretName: mysql-account</span>
<span class="line">      containers:</span>
<span class="line">       - name: nginx </span>
<span class="line">         image: registry.cn-beijing.aliyuncs.com/zhangrenyang/nginx:user-v3 </span>
<span class="line">+       volumeMounts:</span>
<span class="line">+       - name: mysql-account</span>
<span class="line">+         mountPath: /mysql-account</span>
<span class="line">+         readOnly: true</span>
<span class="line">        ports:</span>
<span class="line">         - containerPort: 80 </span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text"><pre><code class="language-text"><span class="line">kubectl describe pods  user-v1-b88799944-tjgrs </span>
<span class="line">kubectl exec -it user-v1-b88799944-tjgrs  -- ls /root</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_4-4-2-环境变量注入" tabindex="-1"><a class="header-anchor" href="#_4-4-2-环境变量注入"><span>4.4.2 环境变量注入</span></a></h4><ul><li>第二种是将 Secret 注入进容器的环境变量</li></ul><p>deployment-user-v1.yaml</p><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text"><pre><code class="language-text"><span class="line"> apiVersion: apps/v1  </span>
<span class="line"> kind: Deployment     </span>
<span class="line">metadata:</span>
<span class="line">   name: user-v1     </span>
<span class="line">spec:</span>
<span class="line">  minReadySeconds: 1</span>
<span class="line">  strategy:</span>
<span class="line">    type: RollingUpdate</span>
<span class="line">    rollingUpdate:</span>
<span class="line">      maxSurge: 1</span>
<span class="line">      maxUnavailable: 0</span>
<span class="line">  selector:</span>
<span class="line">    matchLabels:</span>
<span class="line">       app: user-v1 </span>
<span class="line">   replicas: 1 </span>
<span class="line">  template:</span>
<span class="line">    metadata:</span>
<span class="line">      labels:</span>
<span class="line">         app: user-v1 </span>
<span class="line">     spec:   </span>
<span class="line">      volumes:</span>
<span class="line">        - name: mysql-account</span>
<span class="line">          secret:</span>
<span class="line">            secretName: mysql-account</span>
<span class="line">      containers:</span>
<span class="line">       - name: nginx </span>
<span class="line">+       env:</span>
<span class="line">+       - name: USERNAME</span>
<span class="line">+         valueFrom:</span>
<span class="line">+           secretKeyRef:</span>
<span class="line">+             name: mysql-account</span>
<span class="line">+             key: username</span>
<span class="line">+       - name: PASSWORD</span>
<span class="line">+         valueFrom:</span>
<span class="line">+           secretKeyRef:</span>
<span class="line">+             name: mysql-account</span>
<span class="line">+             key: password</span>
<span class="line">         image: registry.cn-beijing.aliyuncs.com/zhangrenyang/nginx:user-v3 </span>
<span class="line">        volumeMounts:</span>
<span class="line">        - name: mysql-account</span>
<span class="line">          mountPath: /mysql-account</span>
<span class="line">          readOnly: true</span>
<span class="line">        ports:</span>
<span class="line">         - containerPort: 80 </span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code class="language-javascript"><span class="line">kubectl apply <span class="token operator">-</span>f deployment<span class="token operator">-</span>user<span class="token operator">-</span>v1<span class="token punctuation">.</span>yaml </span>
<span class="line">kubectl <span class="token keyword">get</span> pods</span>
<span class="line">kubectl describe pod  user<span class="token operator">-</span>v1<span class="token operator">-</span>5f48f78d86<span class="token operator">-</span>hjkcl</span>
<span class="line">kubectl exec <span class="token operator">-</span>it user<span class="token operator">-</span>v1<span class="token operator">-</span>688486759f<span class="token operator">-</span>9snpx <span class="token operator">--</span> env <span class="token operator">|</span> grep <span class="token constant">USERNAME</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_4-4-3-docker-私有库认证" tabindex="-1"><a class="header-anchor" href="#_4-4-3-docker-私有库认证"><span>4.4.3 Docker 私有库认证</span></a></h4><ul><li>第三种是 Docker 私有库类型，这种方法只能用来配置 私有镜像库认证。</li></ul><p>vi v4.yaml</p><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text"><pre><code class="language-text"><span class="line">image: [仅有镜像库地址]/[镜像名称]:[镜像标签]</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code class="language-javascript"><span class="line">kubectl apply <span class="token operator">-</span>f v4<span class="token punctuation">.</span>yaml</span>
<span class="line">kubectl <span class="token keyword">get</span> pods</span>
<span class="line">kubectl describe pods <span class="token punctuation">[</span><span class="token constant">POD_NAME</span><span class="token punctuation">]</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>vi v4.yaml</p><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text"><pre><code class="language-text"><span class="line">+imagePullSecrets:</span>
<span class="line">+ - name: private-registry-file</span>
<span class="line">containers:</span>
<span class="line">  - name: nginx</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text"><pre><code class="language-text"><span class="line">kubectl apply -f v4.yaml</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><h2 id="_5-服务发现" tabindex="-1"><a class="header-anchor" href="#_5-服务发现"><span>5.服务发现</span></a></h2><ul><li>当A服务依赖另一个 B服务,而我们常常不知道 B服务 的端口和IP，且端口和IP也相对不固定有可能经常更改</li><li>这时候，我们就需要<code>服务发现</code></li></ul><h3 id="_5-1-服务发现" tabindex="-1"><a class="header-anchor" href="#_5-1-服务发现"><span>5.1 服务发现</span></a></h3><ul><li>服务发现是指使用一个注册中心来记录分布式系统中的全部服务的信息，以便其他服务能够快速的找到这些已注册的服务</li></ul><h3 id="_5-2-coredns" tabindex="-1"><a class="header-anchor" href="#_5-2-coredns"><span>5.2 CoreDNS</span></a></h3><ul><li>Pod 的 IP 常常是漂移且不固定的，所以我们要使用 Service 这个神器来将它的访问入口固定住</li><li>可以利用 DNS 的机制给每个 Service 加一个内部的域名，指向其真实的IP</li><li>在Kubernetes中，对 Service 的服务发现，是通过一种叫做 CoreDNS 的组件去实现的</li><li>coreDNS 是使用 Go 语言实现的一个DNS服务器 <ul><li>-n 按命名空间过滤</li><li>-l 按标签过滤</li><li>-o wide 输出额外信息。对于Pod，将输出Pod所在的Node名</li></ul></li></ul><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code class="language-javascript"><span class="line">kubectl <span class="token operator">-</span>n kube<span class="token operator">-</span>system <span class="token keyword">get</span> all  <span class="token operator">-</span>l k8s<span class="token operator">-</span>app<span class="token operator">=</span>kube<span class="token operator">-</span>dns <span class="token operator">-</span>o wide</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><h3 id="_5-3-服务发现规则" tabindex="-1"><a class="header-anchor" href="#_5-3-服务发现规则"><span>5.3 服务发现规则</span></a></h3><ul><li>kubectl exec 的作用是可以直接在容器内执行Shell脚本 <ul><li>命令格式：<code>kubectl exec -it [PodName] -- [Command]</code></li><li>-i：即使没有连接，也要保持标准输入保持打开状态。一般与 -t 连用。</li><li>-t：分配一个伪TTY（终端设备终端窗口），一般与 -i 连用。可以分配给我们一个Shell终端</li></ul></li></ul><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code class="language-javascript"><span class="line">kubectl <span class="token keyword">get</span> pods</span>
<span class="line">kubectl <span class="token keyword">get</span> svc</span>
<span class="line">kubectl exec <span class="token operator">-</span>it user<span class="token operator">-</span>v1<span class="token operator">-</span>688486759f<span class="token operator">-</span>9snpx <span class="token operator">--</span> <span class="token operator">/</span>bin<span class="token operator">/</span>sh</span>
<span class="line">curl http<span class="token operator">:</span><span class="token operator">/</span><span class="token operator">/</span>service<span class="token operator">-</span>user<span class="token operator">-</span>v2</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li><p>namespace(命名空间)</p><ul><li>kubernetes namespace（命名空间）是 kubernetes 里比较重要的一个概念</li><li>在启动集群后，kubernetes 会分配一个默认命名空间，叫default。不同的命名空间可以实现资源隔离，服务隔离，甚至权限隔离</li><li>因为我们在之前创建的服务，都没有指定 namespace ，所以我们的服务都是在同一个 namespace default下</li><li>在同 namespace 下的规则，我们只需要直接访问 <a href="http://ServiceName:Port" target="_blank" rel="noopener noreferrer">http://ServiceName:Port</a> 就可以访问到相应的 Service</li><li>不同 namespace 下的规则是 <code>[ServiceName].[NameSpace].svc.cluster.local</code></li></ul></li><li><p>ServiceName 就是我们创建的 Service 名称</p></li><li><p>NameSpace 则是命名空间。如果你没有命名空间，则这个值为 default。</p></li></ul><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code class="language-javascript"><span class="line">curl http<span class="token operator">:</span><span class="token operator">/</span><span class="token operator">/</span>service<span class="token operator">-</span>user<span class="token operator">-</span>v2<span class="token punctuation">.</span>default<span class="token punctuation">.</span>svc<span class="token punctuation">.</span>cluster<span class="token punctuation">.</span>local</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><h2 id="_6-统一管理服务环境变量" tabindex="-1"><a class="header-anchor" href="#_6-统一管理服务环境变量"><span>6.统一管理服务环境变量</span></a></h2><ul><li>Kubernetes Secret 的主要作用是来存放密码，密钥等机密信息</li><li>对于环境变量的配置：例如你的数据库地址，负载均衡要转发的服务地址等信息。这部分内容使用 Secret 显然不合适，打包在镜像内耦合又太严重。这里，我们可以借助 Kubernetes ConfigMap 来配置这项事情</li></ul><h3 id="_6-1-什么是-configmap" tabindex="-1"><a class="header-anchor" href="#_6-1-什么是-configmap"><span>6.1 什么是 ConfigMap</span></a></h3><ul><li>ConfigMap 是 Kubernetes 的一种资源类型，我们可以使用它存放一些环境变量和配置文件</li><li>信息存入后，我们可以使用挂载卷的方式挂载进我们的 Pod 内，也可以通过环境变量注入</li><li>和 Secret 类型最大的不同是，存在 ConfigMap 内的内容不会加密</li></ul><h3 id="_6-2-创建" tabindex="-1"><a class="header-anchor" href="#_6-2-创建"><span>6.2 创建</span></a></h3><h4 id="_6-2-1-命令行创建" tabindex="-1"><a class="header-anchor" href="#_6-2-1-命令行创建"><span>6.2.1 命令行创建</span></a></h4><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code class="language-javascript"><span class="line">kubectl create configmap <span class="token punctuation">[</span>config_name<span class="token punctuation">]</span> <span class="token operator">--</span>from<span class="token operator">-</span>literal<span class="token operator">=</span><span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token operator">=</span><span class="token punctuation">[</span>value<span class="token punctuation">]</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code class="language-javascript"><span class="line">kubectl create configmap mysql<span class="token operator">-</span>config <span class="token operator">--</span>from<span class="token operator">-</span>literal<span class="token operator">=</span><span class="token constant">MYSQL_HOST</span><span class="token operator">=</span><span class="token number">192.168</span><span class="token number">.1</span><span class="token number">.172</span> <span class="token operator">--</span>from<span class="token operator">-</span>literal<span class="token operator">=</span><span class="token constant">MYSQL_PORT</span><span class="token operator">=</span><span class="token number">3306</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><ul><li>需要注意，configmap 的名称必须是全小写，特殊符号只能包含 &#39;-&#39; 和 &#39;.&#39;。可以用下面的这个正则表达式校验下看看符不符合规则：<code>[a-z0-9]([-a-z0-9]*[a-z0-9])?(\\.[a-z0-9]([-a-z0-9]*[a-z0-9])?)*&#39;)</code></li></ul><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code class="language-javascript"><span class="line">kubectl <span class="token keyword">get</span> cm</span>
<span class="line">kubectl describe cm mysql<span class="token operator">-</span>config</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_6-2-2-配置清单创建" tabindex="-1"><a class="header-anchor" href="#_6-2-2-配置清单创建"><span>6.2.2 配置清单创建</span></a></h4><ul><li>kind 的值为 ConfigMap,代表声明一个 ConfigMap 类型的资源</li><li>metadata.name 代表是该 configmap 的名称</li><li>data 是存放数据的地方，数据格式为 key:value</li></ul><p>mysql-config-file.yaml</p><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code class="language-javascript"><span class="line"><span class="token literal-property property">apiVersion</span><span class="token operator">:</span> v1</span>
<span class="line"><span class="token literal-property property">kind</span><span class="token operator">:</span> ConfigMap</span>
<span class="line"><span class="token literal-property property">metadata</span><span class="token operator">:</span></span>
<span class="line">  <span class="token literal-property property">name</span><span class="token operator">:</span> mysql<span class="token operator">-</span>config<span class="token operator">-</span>file</span>
<span class="line"><span class="token literal-property property">data</span><span class="token operator">:</span></span>
<span class="line">  <span class="token constant">MYSQL_HOST</span><span class="token operator">:</span> <span class="token string">&quot;192.168.1.172&quot;</span></span>
<span class="line">  <span class="token constant">MYSQL_PORT</span><span class="token operator">:</span> <span class="token string">&quot;3306&quot;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text"><pre><code class="language-text"><span class="line">kubectl apply -f ./mysql-config-file.yaml</span>
<span class="line">kubectl describe cm mysql-config-file</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_6-2-3-文件创建" tabindex="-1"><a class="header-anchor" href="#_6-2-3-文件创建"><span>6.2.3 文件创建</span></a></h4><ul><li><code>--from-file</code>代表一个文件</li><li><code>key</code>是文件在 <code>configmap</code> 内的 key</li><li><code>file_path</code> 是文件的路径</li></ul><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code class="language-javascript"><span class="line">kubectl create configmap <span class="token punctuation">[</span>configname<span class="token punctuation">]</span> <span class="token operator">--</span>from<span class="token operator">-</span>file<span class="token operator">=</span><span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token operator">=</span><span class="token punctuation">[</span>file_path<span class="token punctuation">]</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p>env.config</p><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code class="language-javascript"><span class="line"><span class="token constant">HOST</span><span class="token operator">:</span> <span class="token number">192.168</span><span class="token number">.0</span><span class="token number">.1</span></span>
<span class="line"><span class="token constant">PORT</span><span class="token operator">:</span> <span class="token number">8080</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code class="language-javascript"><span class="line">kubectl create configmap env<span class="token operator">-</span>from<span class="token operator">-</span>file <span class="token operator">--</span>from<span class="token operator">-</span>file<span class="token operator">=</span>env<span class="token operator">=</span><span class="token punctuation">.</span><span class="token operator">/</span>env<span class="token punctuation">.</span>config</span>
<span class="line">configmap<span class="token operator">/</span>env<span class="token operator">-</span>from<span class="token operator">-</span>file created</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code class="language-javascript"><span class="line">kubectl <span class="token keyword">get</span> cm env<span class="token operator">-</span>from<span class="token operator">-</span>file <span class="token operator">-</span>o yaml</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><h4 id="_6-2-4-目录创建" tabindex="-1"><a class="header-anchor" href="#_6-2-4-目录创建"><span>6.2.4 目录创建</span></a></h4><ul><li>也可以直接将一个目录下的文件整个存入进去</li></ul><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code class="language-javascript"><span class="line">kubectl create configmap <span class="token punctuation">[</span>configname<span class="token punctuation">]</span> <span class="token operator">--</span>from<span class="token operator">-</span>file<span class="token operator">=</span><span class="token punctuation">[</span>dir_path<span class="token punctuation">]</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code class="language-javascript"><span class="line">mkdir env <span class="token operator">&amp;&amp;</span> cd <span class="token punctuation">.</span><span class="token operator">/</span>env</span>
<span class="line">echo <span class="token string">&#39;local&#39;</span> <span class="token operator">&gt;</span> env<span class="token punctuation">.</span>local</span>
<span class="line">echo <span class="token string">&#39;test&#39;</span> <span class="token operator">&gt;</span> env<span class="token punctuation">.</span>test</span>
<span class="line">echo <span class="token string">&#39;prod&#39;</span> <span class="token operator">&gt;</span> env<span class="token punctuation">.</span>prod</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code class="language-javascript"><span class="line">kubectl create configmap env<span class="token operator">-</span>from<span class="token operator">-</span>dir <span class="token operator">--</span>from<span class="token operator">-</span>file<span class="token operator">=</span><span class="token punctuation">.</span><span class="token operator">/</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code class="language-javascript"><span class="line">kubectl <span class="token keyword">get</span> cm env<span class="token operator">-</span>from<span class="token operator">-</span>dir <span class="token operator">-</span>o yaml</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><h3 id="_6-3-使用方式" tabindex="-1"><a class="header-anchor" href="#_6-3-使用方式"><span>6.3 使用方式</span></a></h3><h4 id="_6-3-1-环境变量注入" tabindex="-1"><a class="header-anchor" href="#_6-3-1-环境变量注入"><span>6.3.1 环境变量注入</span></a></h4><ul><li>name 为要选择注入的 configmap 名称</li><li>key 则为 configmap 内的其中一个 key</li></ul><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text"><pre><code class="language-text"><span class="line">containers:</span>
<span class="line">   - name: nginx </span>
<span class="line">+   env:</span>
<span class="line">+     - name: MYSQL_HOST</span>
<span class="line">+       valueFrom:</span>
<span class="line">+         configMapKeyRef:</span>
<span class="line">+           name: mysql-config</span>
<span class="line">+           key: MYSQL_HOST</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text"><pre><code class="language-text"><span class="line">kubectl apply -f ./v1.yaml</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code class="language-javascript"><span class="line"><span class="token comment">//kubectl exec -it [POD_NAME] -- env | grep MYSQL_HOST</span></span>
<span class="line">kubectl exec  <span class="token operator">-</span>it user<span class="token operator">-</span>v1<span class="token operator">-</span>744f48d6bd<span class="token operator">-</span>9klqr <span class="token operator">--</span> env <span class="token operator">|</span> grep <span class="token constant">MYSQL_HOST</span></span>
<span class="line">kubectl exec  <span class="token operator">-</span>it user<span class="token operator">-</span>v1<span class="token operator">-</span>744f48d6bd<span class="token operator">-</span>9klqr  <span class="token operator">--</span> env <span class="token operator">|</span> grep <span class="token constant">MYSQL_PORT</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text"><pre><code class="language-text"><span class="line">      containers:</span>
<span class="line">       - name: nginx </span>
<span class="line">        env:</span>
<span class="line">+       envFrom:</span>
<span class="line">+       - configMapRef:</span>
<span class="line">+           name: mysql-config</span>
<span class="line">+           optional: true  </span>
<span class="line">         image: registry.cn-beijing.aliyuncs.com/zhangrenyang/nginx:user-v3 </span>
<span class="line">        volumeMounts:</span>
<span class="line">        - name: mysql-account</span>
<span class="line">          mountPath: /mysql-account</span>
<span class="line">          readOnly: true</span>
<span class="line">        ports:</span>
<span class="line">         - containerPort: 80 </span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_6-3-2-存储卷挂载" tabindex="-1"><a class="header-anchor" href="#_6-3-2-存储卷挂载"><span>6.3.2 存储卷挂载</span></a></h4><ul><li>存储卷挂载会将 configmap 里内容中的每个 key 和 value，以独立文件方式以外部挂载卷方式挂载进去（ key 是文件名，value 是文件内容）</li><li>在 Pod 层面声明一个外部存储卷 <ul><li>name 为存储卷名称</li><li>configMap 代表存储卷的文件来源</li><li>configMap.name 要填入要加载的 configMap 名称</li></ul></li><li>在容器镜像层面配置存储卷 <ul><li>name 的值来源于第一步配置的 name 值</li><li>mountPath 为要挂载的目录</li><li>readonly 则代表文件是不是只读</li></ul></li></ul><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text"><pre><code class="language-text"><span class="line">  template:</span>
<span class="line">    metadata:</span>
<span class="line">      labels:</span>
<span class="line">         app: user-v1 </span>
<span class="line">     spec:   </span>
<span class="line">      volumes:</span>
<span class="line">        - name: mysql-account</span>
<span class="line">          secret:</span>
<span class="line">            secretName: mysql-account</span>
<span class="line">+       - name: envfiles</span>
<span class="line">+         configMap:</span>
<span class="line">+           name: env-from-dir</span>
<span class="line">      containers:</span>
<span class="line">       - name: nginx </span>
<span class="line">        env:</span>
<span class="line">        - name: USERNAME</span>
<span class="line">          valueFrom:</span>
<span class="line">            secretKeyRef:</span>
<span class="line">              name: mysql-account</span>
<span class="line">              key: username</span>
<span class="line">        - name: PASSWORD</span>
<span class="line">          valueFrom:</span>
<span class="line">            secretKeyRef:</span>
<span class="line">              name: mysql-account</span>
<span class="line">              key: password</span>
<span class="line">        envFrom:</span>
<span class="line">        - configMapRef:</span>
<span class="line">            name: mysql-config</span>
<span class="line">            optional: true  </span>
<span class="line">         image: registry.cn-beijing.aliyuncs.com/zhangrenyang/nginx:user-v3 </span>
<span class="line">        volumeMounts:</span>
<span class="line">        - name: mysql-account</span>
<span class="line">          mountPath: /mysql-account</span>
<span class="line">          readOnly: true</span>
<span class="line">+       - name: envfiles</span>
<span class="line">+         mountPath: /envfiles</span>
<span class="line">+         readOnly: true</span>
<span class="line">        ports:</span>
<span class="line">         - containerPort: 80 </span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code class="language-javascript"><span class="line">kubectl apply <span class="token operator">-</span>f deployment<span class="token operator">-</span>user<span class="token operator">-</span>v1<span class="token punctuation">.</span>yaml </span>
<span class="line">kubectl <span class="token keyword">get</span> pods</span>
<span class="line">kubectl describe pod user<span class="token operator">-</span>v1<span class="token operator">-</span>79b8768f54<span class="token operator">-</span>r56kd</span>
<span class="line">kubectl exec <span class="token operator">-</span>it user<span class="token operator">-</span>v1<span class="token operator">-</span>744f48d6bd<span class="token operator">-</span>9klqr <span class="token operator">--</span> ls <span class="token operator">/</span>envfiles</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li>可以借助 volumes.configMap.items[] 字段来配置多个 item 项</li></ul><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text"><pre><code class="language-text"><span class="line">  spec:   </span>
<span class="line">      volumes:</span>
<span class="line">        - name: mysql-account</span>
<span class="line">          secret:</span>
<span class="line">            secretName: mysql-account</span>
<span class="line">        - name: envfiles</span>
<span class="line">          configMap:</span>
<span class="line">            name: env-from-dir</span>
<span class="line">+           items:</span>
<span class="line">+           - key: env.local</span>
<span class="line">+             path: env.local</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="_7-污点与容忍" tabindex="-1"><a class="header-anchor" href="#_7-污点与容忍"><span>7.污点与容忍</span></a></h2><ul><li>如何干预Pod 部署到特定的节点上可以通过污点与容忍度去实现</li></ul><h3 id="_7-1-么是污点和容忍度" tabindex="-1"><a class="header-anchor" href="#_7-1-么是污点和容忍度"><span>7.1 么是污点和容忍度？</span></a></h3><ul><li><p>在 Kubernetes 中， Pod 被部署到 Node 上面去的规则和逻辑是由 Kubernetes 的调度组件根据 Node 的剩余资源，地位，以及其他规则自动选择调度的</p></li><li><p>但前端和后端往往服务器资源的分配都是不均衡的，甚至有的服务只能让特定的服务器来跑</p></li><li><p>在这种情况下，我们选择自动调度是不均衡的，就需要人工去干预匹配选择规则了</p></li><li><p>这时候，就需要在给 Node 添加一个叫做污点的东西，以确保 Node 不被 Pod 调度到</p></li><li><p>当你给 Node 设置一个污点后，除非给 Pod 设置一个相对应的容忍度，否则 Pod 才能被调度上去。这也就是污点和容忍的来源</p></li><li><p>污点的格式是 <code>key=value</code>，可以自定义自己的内容，就像是一组 Tag 一样</p></li><li><p>Node_Name 为要添加污点的 node 名称</p></li><li><p>key 和 value 为一组键值对，代表一组标示标签</p></li><li><p>NoSchedule 则为不被调度的意思，和它同级别的还有其他的值：PreferNoSchedule 和 NoExecute</p></li></ul><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code class="language-javascript"><span class="line">kubectl taint nodes <span class="token punctuation">[</span>Node_Name<span class="token punctuation">]</span> <span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token operator">=</span><span class="token punctuation">[</span>value<span class="token punctuation">]</span><span class="token operator">:</span>NoSchedule</span>
<span class="line"><span class="token comment">//添加污点</span></span>
<span class="line">kubectl taint nodes node1 user<span class="token operator">-</span>v4<span class="token operator">=</span><span class="token boolean">true</span><span class="token operator">:</span>NoSchedule</span>
<span class="line"><span class="token comment">//查看污点</span></span>
<span class="line">kubectl describe node node1</span>
<span class="line">kubectl describe node master</span>
<span class="line"><span class="token literal-property property">Taints</span><span class="token operator">:</span> node<span class="token operator">-</span>role<span class="token punctuation">.</span>kubernetes<span class="token punctuation">.</span>io<span class="token operator">/</span>master<span class="token operator">:</span>NoSchedule</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>vi deployment-user-v4.yaml</p><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code class="language-javascript"><span class="line"><span class="token literal-property property">apiVersion</span><span class="token operator">:</span> apps<span class="token operator">/</span>v1 </span>
<span class="line"><span class="token literal-property property">kind</span><span class="token operator">:</span> Deployment </span>
<span class="line"><span class="token literal-property property">metadata</span><span class="token operator">:</span></span>
<span class="line">  <span class="token literal-property property">name</span><span class="token operator">:</span> user<span class="token operator">-</span>v4 </span>
<span class="line"><span class="token literal-property property">spec</span><span class="token operator">:</span></span>
<span class="line">  <span class="token literal-property property">minReadySeconds</span><span class="token operator">:</span> <span class="token number">1</span></span>
<span class="line">  <span class="token literal-property property">selector</span><span class="token operator">:</span></span>
<span class="line">    <span class="token literal-property property">matchLabels</span><span class="token operator">:</span></span>
<span class="line">      <span class="token literal-property property">app</span><span class="token operator">:</span> user<span class="token operator">-</span>v4 </span>
<span class="line">  <span class="token literal-property property">replicas</span><span class="token operator">:</span> <span class="token number">1</span></span>
<span class="line">  <span class="token literal-property property">template</span><span class="token operator">:</span></span>
<span class="line">    <span class="token literal-property property">metadata</span><span class="token operator">:</span></span>
<span class="line">      <span class="token literal-property property">labels</span><span class="token operator">:</span></span>
<span class="line">        <span class="token literal-property property">app</span><span class="token operator">:</span> user<span class="token operator">-</span>v4 </span>
<span class="line">    <span class="token literal-property property">spec</span><span class="token operator">:</span></span>
<span class="line">      <span class="token literal-property property">containers</span><span class="token operator">:</span></span>
<span class="line">      <span class="token operator">-</span> name<span class="token operator">:</span> nginx</span>
<span class="line">        <span class="token literal-property property">image</span><span class="token operator">:</span> registry<span class="token punctuation">.</span>cn<span class="token operator">-</span>beijing<span class="token punctuation">.</span>aliyuncs<span class="token punctuation">.</span>com<span class="token operator">/</span>zhangrenyang<span class="token operator">/</span>nginx<span class="token operator">:</span>user<span class="token operator">-</span>v3 </span>
<span class="line">        <span class="token literal-property property">ports</span><span class="token operator">:</span></span>
<span class="line">        <span class="token operator">-</span> containerPort<span class="token operator">:</span> <span class="token number">80</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text"><pre><code class="language-text"><span class="line">kubectl apply -f deployment-user-v4.yaml</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><ul><li>给 Pod 设置容忍度 <ul><li>想让 Pod 被调度过去，需要在 Pod 一侧添加相同的容忍度才能被调度到</li><li>给 Pod 设置一组容忍度，以匹配对应的 Node 的污点</li><li>key 和 value 是你配置 Node 污点的 key 和 value</li><li>effect 是 Node 污点的调度效果，和 Node 的设置项也是匹配的</li><li>operator 是运算符，equal 代表只有 key 和 value 相等才算数。当然也可以配置 exists ，代表只要 key 存在就匹配，不需要校验 value 的值</li></ul></li></ul><p>vi deployment-user-v4.yaml</p><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text"><pre><code class="language-text"><span class="line">apiVersion: apps/v1 </span>
<span class="line">kind: Deployment </span>
<span class="line">metadata:</span>
<span class="line">  name: user-v4 </span>
<span class="line">spec:</span>
<span class="line">  minReadySeconds: 1</span>
<span class="line">  selector:</span>
<span class="line">    matchLabels:</span>
<span class="line">      app: user-v4 </span>
<span class="line">  replicas: 1</span>
<span class="line">  template:</span>
<span class="line">    metadata:</span>
<span class="line">      labels:</span>
<span class="line">        app: user-v4 </span>
<span class="line">    spec:  </span>
<span class="line">+     tolerations:</span>
<span class="line">+     - key: &quot;user-v4&quot;</span>
<span class="line">+       operator: &quot;Equal&quot;</span>
<span class="line">+       value: &quot;true&quot;</span>
<span class="line">+       effect: &quot;NoSchedule&quot;</span>
<span class="line">      containers:</span>
<span class="line">      - name: nginx</span>
<span class="line">        image: registry.cn-beijing.aliyuncs.com/zhangrenyang/nginx:user-v3 </span>
<span class="line">        ports:</span>
<span class="line">        - containerPort: 80</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li><p>修改Node的污点</p><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code class="language-javascript"><span class="line">kubectl taint nodes node1 user<span class="token operator">-</span>v4<span class="token operator">=</span><span class="token number">1</span><span class="token operator">:</span>NoSchedule <span class="token operator">--</span>overwrite</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div></li><li><p>删除 Node 的污点</p><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text"><pre><code class="language-text"><span class="line">kubectl taint nodes node1 user-v4-</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div></li><li><p>在master上布署pod</p></li></ul><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code class="language-javascript"><span class="line">kubectl taint nodes node1 user<span class="token operator">-</span>v4<span class="token operator">=</span><span class="token boolean">true</span><span class="token operator">:</span>NoSchedule</span>
<span class="line">kubectl describe node node1</span>
<span class="line">kubectl describe node master</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>vi deployment-user-v4.yaml</p><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text"><pre><code class="language-text"><span class="line">apiVersion: apps/v1 </span>
<span class="line">kind: Deployment </span>
<span class="line">metadata:</span>
<span class="line">  name: user-v4 </span>
<span class="line">spec:</span>
<span class="line">  minReadySeconds: 1</span>
<span class="line">  selector:</span>
<span class="line">    matchLabels:</span>
<span class="line">      app: user-v4 </span>
<span class="line">  replicas: 1 </span>
<span class="line">  template:</span>
<span class="line">    metadata:</span>
<span class="line">      labels:</span>
<span class="line">        app: user-v4 </span>
<span class="line">    spec:  </span>
<span class="line">+     tolerations:</span>
<span class="line">+     - key: &quot;node-role.kubernetes.io/master&quot;</span>
<span class="line">+       operator: &quot;Exists&quot;</span>
<span class="line">+       effect: &quot;NoSchedule&quot;</span>
<span class="line">      containers:</span>
<span class="line">      - name: nginx</span>
<span class="line">        image: registry.cn-beijing.aliyuncs.com/zhangrenyang/nginx:user-v3 </span>
<span class="line">        ports:</span>
<span class="line">        - containerPort: 80</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text"><pre><code class="language-text"><span class="line"> kubectl apply -f deployment-user-v4.yaml</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p>apiVersion: v1kind: Podmetadata: name: private-regspec: containers: - name: private-reg-container image: imagePullSecrets: - name: har</p><ul><li><a href="https://www.jianshu.com/p/02d269c86bbe" target="_blank" rel="noopener noreferrer">Nexus3密码找回</a></li><li><a href="https://cloud.tencent.com/developer/article/1671701" target="_blank" rel="noopener noreferrer">nexus配置https支持</a></li></ul>`,178)])])}const c=n(p,[["render",i]]),o=JSON.parse('{"path":"/strong/125.15.k8s.html","title":"","lang":"en-US","frontmatter":{},"git":{"updatedTime":1681290319000,"contributors":[{"name":"yutao","username":"yutao","email":"642231346@qq.com","commits":1,"url":"https://github.com/yutao"}],"changelog":[{"hash":"f5ab8c9d34991ec274f7f652439afe5b2afb6147","time":1681290319000,"email":"642231346@qq.com","author":"yutao","message":"modify"}]},"filePathRelative":"strong/125.15.k8s.md"}');export{c as comp,o as data};
