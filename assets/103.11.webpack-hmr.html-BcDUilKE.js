import{_ as s,c as a,a as e,o as p}from"./app-CD1YpnS1.js";const t={};function l(c,n){return p(),a("div",null,[...n[0]||(n[0]=[e(`<h2 id="_1-什么是hmr" tabindex="-1"><a class="header-anchor" href="#_1-什么是hmr"><span>1. 什么是HMR</span></a></h2><ul><li><code>Hot Module Replacement</code>是指当我们对代码修改并保存后，webpack将会对代码进行重新打包，并将新的模块发送到浏览器端，浏览器用新的模块替换掉旧的模块，以实现在不刷新浏览器的前提下更新页面</li></ul><h2 id="_2-使用hmr" tabindex="-1"><a class="header-anchor" href="#_2-使用hmr"><span>2.使用HMR</span></a></h2><h3 id="_2-1-安装" tabindex="-1"><a class="header-anchor" href="#_2-1-安装"><span>2.1 安装</span></a></h3><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text"><pre><code class="language-text"><span class="line">yarn add webpack webpack-cli webpack-dev-server html-webpack-plugin socket.io socket.io-client events mime fs-extra --dev</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><h3 id="_2-2-使用" tabindex="-1"><a class="header-anchor" href="#_2-2-使用"><span>2.2 使用</span></a></h3><h4 id="_2-2-1-webpack-config-js" tabindex="-1"><a class="header-anchor" href="#_2-2-1-webpack-config-js"><span>2.2.1 webpack.config.js</span></a></h4><p>webpack.config.js</p><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code class="language-javascript"><span class="line"><span class="token keyword">let</span> path <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;path&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">let</span> webpack <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;webpack&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">let</span> HtmlWebpackPlugin <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;html-webpack-plugin&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">let</span> HotModuleReplacementPlugin <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&#39;webpack/lib/HotModuleReplacementPlugin&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token literal-property property">mode</span><span class="token operator">:</span> <span class="token string">&quot;development&quot;</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token literal-property property">entry</span><span class="token operator">:</span><span class="token string">&quot;./src/index.js&quot;</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token literal-property property">output</span><span class="token operator">:</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token literal-property property">filename</span><span class="token operator">:</span> <span class="token string">&quot;[name].js&quot;</span><span class="token punctuation">,</span></span>
<span class="line">        <span class="token literal-property property">path</span><span class="token operator">:</span> path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">&quot;dist&quot;</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token literal-property property">devServer</span><span class="token operator">:</span><span class="token punctuation">{</span></span>
<span class="line">        <span class="token literal-property property">hot</span><span class="token operator">:</span><span class="token boolean">true</span><span class="token punctuation">,</span></span>
<span class="line">        <span class="token literal-property property">port</span><span class="token operator">:</span><span class="token number">8000</span><span class="token punctuation">,</span></span>
<span class="line">        <span class="token literal-property property">contentBase</span><span class="token operator">:</span>path<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span><span class="token string">&#39;static&#39;</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token literal-property property">plugins</span><span class="token operator">:</span> <span class="token punctuation">[</span></span>
<span class="line">        <span class="token keyword">new</span> <span class="token class-name">HtmlWebpackPlugin</span><span class="token punctuation">(</span><span class="token punctuation">{</span></span>
<span class="line">            <span class="token literal-property property">template</span><span class="token operator">:</span><span class="token string">&#39;./src/index.html&#39;</span></span>
<span class="line">        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line">        <span class="token keyword">new</span> <span class="token class-name">HotModuleReplacementPlugin</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token punctuation">]</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_2-2-2-src-index-html" tabindex="-1"><a class="header-anchor" href="#_2-2-2-src-index-html"><span>2.2.2 src\\index.html</span></a></h4><p>src\\index.html</p><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code class="language-javascript"><span class="line"><span class="token operator">&lt;</span><span class="token operator">!</span><span class="token constant">DOCTYPE</span> html<span class="token operator">&gt;</span></span>
<span class="line"><span class="token operator">&lt;</span>html lang<span class="token operator">=</span><span class="token string">&quot;en&quot;</span><span class="token operator">&gt;</span></span>
<span class="line"><span class="token operator">&lt;</span>head<span class="token operator">&gt;</span></span>
<span class="line">    <span class="token operator">&lt;</span>meta charset<span class="token operator">=</span><span class="token string">&quot;UTF-8&quot;</span><span class="token operator">&gt;</span></span>
<span class="line">    <span class="token operator">&lt;</span>meta name<span class="token operator">=</span><span class="token string">&quot;viewport&quot;</span> content<span class="token operator">=</span><span class="token string">&quot;width=device-width, initial-scale=1.0&quot;</span><span class="token operator">&gt;</span></span>
<span class="line">    <span class="token operator">&lt;</span>title<span class="token operator">&gt;</span>hmr<span class="token operator">&lt;</span><span class="token operator">/</span>title<span class="token operator">&gt;</span></span>
<span class="line"><span class="token operator">&lt;</span><span class="token operator">/</span>head<span class="token operator">&gt;</span></span>
<span class="line"><span class="token operator">&lt;</span>body<span class="token operator">&gt;</span></span>
<span class="line">    <span class="token operator">&lt;</span>input<span class="token operator">/</span><span class="token operator">&gt;</span></span>
<span class="line">    <span class="token operator">&lt;</span>div id<span class="token operator">=</span><span class="token string">&quot;root&quot;</span><span class="token operator">&gt;</span><span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">&gt;</span></span>
<span class="line"><span class="token operator">&lt;</span><span class="token operator">/</span>body<span class="token operator">&gt;</span></span>
<span class="line"><span class="token operator">&lt;</span><span class="token operator">/</span>html<span class="token operator">&gt;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_2-2-3-src-index-js" tabindex="-1"><a class="header-anchor" href="#_2-2-3-src-index-js"><span>2.2.3 src\\index.js</span></a></h4><p>src\\index.js</p><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code class="language-javascript"><span class="line"><span class="token keyword">let</span> <span class="token function-variable function">render</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">let</span> title <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;./title.js&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    root<span class="token punctuation">.</span>innerText <span class="token operator">=</span> title<span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"><span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">if</span> <span class="token punctuation">(</span>module<span class="token punctuation">.</span>hot<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    module<span class="token punctuation">.</span>hot<span class="token punctuation">.</span><span class="token function">accept</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">&quot;./title.js&quot;</span><span class="token punctuation">]</span><span class="token punctuation">,</span> render<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_2-2-4-title-js" tabindex="-1"><a class="header-anchor" href="#_2-2-4-title-js"><span>2.2.4 title.js</span></a></h4><p>src\\title.js</p><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code class="language-javascript"><span class="line">module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token string">&quot;title&quot;</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><h4 id="_2-2-5-package-json" tabindex="-1"><a class="header-anchor" href="#_2-2-5-package-json"><span>2.2.5 package.json</span></a></h4><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text"><pre><code class="language-text"><span class="line">&quot;scripts&quot;: {</span>
<span class="line">  &quot;build&quot;: &quot;webpack&quot;,</span>
<span class="line">  &quot;dev&quot;: &quot;webpack serve&quot;</span>
<span class="line">}</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_2-2-6-debugger" tabindex="-1"><a class="header-anchor" href="#_2-2-6-debugger"><span>2.2.6 debugger</span></a></h4><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text"><pre><code class="language-text"><span class="line">  &quot;scripts&quot;: {</span>
<span class="line">    &quot;build&quot;: &quot;webpack&quot;,</span>
<span class="line">    &quot;dev&quot;: &quot;webpack serve&quot;,</span>
<span class="line">+    &quot;debug&quot;: &quot;webpack serve&quot;</span>
<span class="line">  },</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="_3-基础知识" tabindex="-1"><a class="header-anchor" href="#_3-基础知识"><span>3.基础知识</span></a></h2><h3 id="_3-1-module和chunk" tabindex="-1"><a class="header-anchor" href="#_3-1-module和chunk"><span>3.1 module和chunk</span></a></h3><ul><li>在 webpack里有各种各样的模块</li><li>一般一个入口会依赖多个模块</li><li>一个入口一般会对应一个chunk,这个chunk里包含这个入口依赖的所有的模块</li></ul><h3 id="_3-2-hotmodulereplacementplugin" tabindex="-1"><a class="header-anchor" href="#_3-2-hotmodulereplacementplugin"><span>3.2 HotModuleReplacementPlugin</span></a></h3><ul><li>webpack\\lib\\HotModuleReplacementPlugin.js</li><li>它会生成两个补丁文件 <ul><li>上一次编译生成的hash.hot-update.json,说明从上次编译到现在哪些代码块发生成改变</li><li>chunk名字.上一次编译生成的hash.hot-update.js,存放着此代码块最新的模块定义,里面会调用<code>webpackHotUpdate</code>方法</li></ul></li><li>向代码块中注入HMR runtime代码,热更新的主要逻辑,比如拉取代码、执行代码、执行accept回调都是它注入的到chunk中的</li><li><code>hotCreateRequire</code>会帮我们给模块 module的<code>parents</code>、<code>children</code>赋值</li></ul><h3 id="_3-3-webpack的监控模式" tabindex="-1"><a class="header-anchor" href="#_3-3-webpack的监控模式"><span>3.3 webpack的监控模式</span></a></h3><ul><li>如果使用监控模式编译webpack的话,如果文件系统中有文件发生了改变,webpack会监听到并重新打包</li><li>每次编译会产生一个新的hash值</li></ul><h2 id="_4-工作流程" tabindex="-1"><a class="header-anchor" href="#_4-工作流程"><span>4.工作流程</span></a></h2><h3 id="_4-1-服务器部分" tabindex="-1"><a class="header-anchor" href="#_4-1-服务器部分"><span>4.1. 服务器部分</span></a></h3><ol><li>启动webpack-dev-server服务器</li><li>创建webpack实例</li><li>创建Server服务器</li><li>添加webpack的<code>done</code>事件回调，在编译完成后会向浏览器发送消息</li><li>创建express应用app</li><li>使用监控模式开始启动webpack编译,在 webpack 的 watch 模式下，文件系统中某一个文件发生修改，webpack 监听到文件变化，根据配置文件对模块重新编译打包，并将打包后的代码通过简单的 JavaScript 对象保存在内存中</li><li>设置文件系统为内存文件系统</li><li>添加webpack-dev-middleware中间件</li><li>创建http服务器并启动服务</li><li>使用sockjs在浏览器端和服务端之间建立一个 websocket 长连接，将 webpack 编译打包的各个阶段的状态信息告知浏览器端,浏览器端根据这些<code>socket</code>消息进行不同的操作。当然服务端传递的最主要信息还是新模块的<code>hash</code>值，后面的步骤根据这一<code>hash</code>值来进行模块热替换</li></ol><table><thead><tr><th style="text-align:left;">步骤</th><th style="text-align:left;">代码位置</th></tr></thead><tbody><tr><td style="text-align:left;">1.启动webpack-dev-server服务器</td><td style="text-align:left;">[webpack-dev-server.js#L159](https://github.com/webpack/webpack-dev-server/blob/v3.7.2/bin/webpack-dev-server.js</td></tr><tr><td style="text-align:left;">2.创建webpack实例</td><td style="text-align:left;">[webpack-dev-server.js#L89](https://github.com/webpack/webpack-dev-server/blob/v3.7.2/bin/webpack-dev-server.js</td></tr><tr><td style="text-align:left;">3.创建Server服务器</td><td style="text-align:left;">[webpack-dev-server.js#L100](https://github.com/webpack/webpack-dev-server/blob/v3.7.2/bin/webpack-dev-server.js</td></tr><tr><td style="text-align:left;">4.更改config的entry属性</td><td style="text-align:left;">[webpack-dev-server.js#L157](https://github.com/webpack/webpack-dev-server/blob/v3.7.2/lib/Server.js</td></tr><tr><td style="text-align:left;">entry添加dev-server/client/index.js</td><td style="text-align:left;">[addEntries.js#L22](https://github.com/webpack/webpack-dev-server/blob/v3.7.2/lib/utils/addEntries.js</td></tr><tr><td style="text-align:left;">entry添加webpack/hot/dev-server.js</td><td style="text-align:left;">[addEntries.js#L30](https://github.com/webpack/webpack-dev-server/blob/v3.7.2/lib/utils/addEntries.js</td></tr><tr><td style="text-align:left;">5. setupHooks</td><td style="text-align:left;">[Server.js#L122](https://github.com/webpack/webpack-dev-server/blob/v3.7.2/lib/Server.js</td></tr><tr><td style="text-align:left;">6. 添加webpack的<code>done</code>事件回调</td><td style="text-align:left;">[Server.js#L183](https://github.com/webpack/webpack-dev-server/blob/v3.7.2/lib/Server.js</td></tr><tr><td style="text-align:left;">编译完成向websocket客户端推送消息，最主要信息还是新模块的hash值，后面的步骤根据这一hash值来进行模块热替换</td><td style="text-align:left;">[Server.js#L178](https://github.com/webpack/webpack-dev-server/blob/v3.7.2/lib/Server.js</td></tr><tr><td style="text-align:left;">7.创建express应用app</td><td style="text-align:left;">[Server.js#L169](https://github.com/webpack/webpack-dev-server/blob/v3.7.2/lib/Server.js</td></tr><tr><td style="text-align:left;">8. 添加webpack-dev-middleware中间件</td><td style="text-align:left;">[Server.js#L208](https://github.com/webpack/webpack-dev-server/blob/v3.7.2/lib/Server.js</td></tr><tr><td style="text-align:left;">以watch模式启动webpack编译，文件系统中某一个文件发生修改，webpack 监听到文件变化，根据配置文件对模块重新编译打包</td><td style="text-align:left;">[index.js#L41](https://github.com/webpack/webpack-dev-middleware/blob/v3.7.2/index.js</td></tr><tr><td style="text-align:left;">设置文件系统为内存文件系统</td><td style="text-align:left;">[index.js#L65](https://github.com/webpack/webpack-dev-middleware/blob/v3.7.2/index.js</td></tr><tr><td style="text-align:left;">返回一个中间件，负责返回生成的文件</td><td style="text-align:left;">[middleware.js#L20](https://github.com/webpack/webpack-dev-middleware/blob/v3.7.2/lib/middleware.js</td></tr><tr><td style="text-align:left;">app中使用webpack-dev-middlerware返回的中间件</td><td style="text-align:left;">[Server.js#L128](https://github.com/webpack/webpack-dev-server/blob/v3.7.2/lib/Server.js</td></tr><tr><td style="text-align:left;">9. 创建http服务器并启动服务</td><td style="text-align:left;">[Server.js#L135](https://github.com/webpack/webpack-dev-server/blob/v3.7.2/lib/Server.js</td></tr><tr><td style="text-align:left;">10. 使用sockjs在浏览器端和服务端之间建立一个 websocket 长连接</td><td style="text-align:left;">[Server.js#L745](https://github.com/webpack/webpack-dev-server/blob/v3.7.2/lib/Server.js</td></tr><tr><td style="text-align:left;">创建socket服务器并监听connection事件</td><td style="text-align:left;">[SockJSServer.js#L33](https://github.com/webpack/webpack-dev-server/blob/v3.7.2/lib/servers/SockJSServer.js</td></tr></tbody></table><h3 id="_4-2-客户端部分" tabindex="-1"><a class="header-anchor" href="#_4-2-客户端部分"><span>4.2. 客户端部分</span></a></h3><ol><li><code>webpack-dev-server/client-src/default/index.js</code>端会监听到此<code>hash</code>消息,会保存此hash值</li><li>客户端收到<code>ok</code>的消息后会执行<code>reloadApp</code>方法进行更新</li><li>在reloadApp中会进行判断，是否支持热更新，如果支持的话发射<code>webpackHotUpdate</code>事件,如果不支持则直接刷新浏览器</li><li>在<code>webpack/hot/dev-server.js</code>会监听<code>webpackHotUpdate</code>事件,然后执行<code>check()</code>方法进行检查</li><li>在check方法里会调用<code>module.hot.check</code>方法</li><li>它通过调用 <code>JsonpMainTemplate.runtime</code>的<code>hotDownloadManifest</code>方法，向 server 端发送 Ajax 请求，服务端返回一个 <code>Manifest</code>文件，该 <code>Manifest</code> 包含了所有要更新的模块的 <code>hash</code> 值和chunk名</li><li>调用<code>JsonpMainTemplate.runtime</code>的<code>hotDownloadUpdateChunk</code>方法通过JSONP请求获取到最新的模块代码</li><li>补丁JS取回来后会调用<code>JsonpMainTemplate.runtime.js</code>的<code>webpackHotUpdate</code>方法，里面会调用<code>hotAddUpdateChunk</code>方法,用新的模块替换掉旧的模块</li><li>然后会调用<code>HotModuleReplacement.runtime.js</code>的<code>hotAddUpdateChunk</code>方法动态更新模块代 码</li><li>然后调用<code>hotApply</code>方法进行热更新</li></ol><table><thead><tr><th style="text-align:left;">步骤</th><th style="text-align:left;">代码</th></tr></thead><tbody><tr><td style="text-align:left;">1.连接websocket服务器</td><td style="text-align:left;">[socket.js#L25](https://github.com/webpack/webpack-dev-server/blob/v3.7.2/client-src/default/socket.js</td></tr><tr><td style="text-align:left;">2.websocket客户端监听事件</td><td style="text-align:left;">[socket.js#L53](https://github.com/webpack/webpack-dev-server/blob/v3.7.2/client-src/default/socket.js</td></tr><tr><td style="text-align:left;">监听hash事件，保存此hash值</td><td style="text-align:left;">[index.js#L55](https://github.com/webpack/webpack-dev-server/blob/v3.7.2/client-src/default/index.js</td></tr><tr><td style="text-align:left;">3.监听ok事件，执行reloadApp方法进行更新</td><td style="text-align:left;">[index.js#L93](https://github.com/webpack/webpack-dev-server/blob/v3.7.2/client-src/default/index.js</td></tr><tr><td style="text-align:left;">4. 在reloadApp中会进行判断，是否支持热更新，如果支持的话发射<code>webpackHotUpdate</code>事件,如果不支持则直接刷新浏览器</td><td style="text-align:left;">[reloadApp.js#L7](https://github.com/webpack/webpack-dev-server/blob/v3.7.2/client-src/default/utils/reloadApp.js</td></tr><tr><td style="text-align:left;">5. 在<code>webpack/hot/dev-server.js</code>会监听<code>webpackHotUpdate</code>事件</td><td style="text-align:left;">[dev-server.js#L55](https://github.com/webpack/webpack/blob/v4.39.1/hot/dev-server.js</td></tr><tr><td style="text-align:left;">6. 在check方法里会调用<code>module.hot.check</code>方法</td><td style="text-align:left;">[dev-server.js#L13](https://github.com/webpack/webpack/blob/v4.39.1/hot/dev-server.js</td></tr><tr><td style="text-align:left;">7. 调用<code>hotDownloadManifest</code>，向 server 端发送 Ajax 请求，服务端返回一个 Manifest文件(lastHash.hot-update.json)，该 Manifest 包含了本次编译hash值 和 更新模块的chunk名</td><td style="text-align:left;">[HotModuleReplacement.runtime.js#L180](https://github.com/webpack/webpack/blob/v4.39.1/lib/HotModuleReplacement.runtime.js</td></tr><tr><td style="text-align:left;">8. 调用<code>JsonpMainTemplate.runtime</code>的<code>hotDownloadUpdateChunk</code>方法通过JSONP请求获取到最新的模块代码</td><td style="text-align:left;">[JsonpMainTemplate.runtime.js#L14](https://github.com/webpack/webpack/blob/v4.39.1/lib/web/JsonpMainTemplate.runtime.js</td></tr><tr><td style="text-align:left;">9. 补丁JS取回来后会调用<code>JsonpMainTemplate.runtime.js</code>的<code>webpackHotUpdate</code>方法</td><td style="text-align:left;">[JsonpMainTemplate.runtime.js#L8](https://github.com/webpack/webpack/blob/v4.39.1/lib/web/JsonpMainTemplate.runtime.js</td></tr><tr><td style="text-align:left;">10. 然后会调用<code>HotModuleReplacement.runtime.js</code>的<code>hotAddUpdateChunk</code>方法动态更新模块代码</td><td style="text-align:left;">[HotModuleReplacement.runtime.js#L222](https://github.com/webpack/webpack/blob/v4.39.1/lib/HotModuleReplacement.runtime.js</td></tr><tr><td style="text-align:left;">11.然后调用<code>hotApply</code>方法进行热更新</td><td style="text-align:left;"><a href="https://github.com/webpack/webpack/blob/v4.39.1/lib/HotModuleReplacement.runtime.js#L257" target="_blank" rel="noopener noreferrer">HotModuleReplacement.runtime.js#L257</a> [HotModuleReplacement.runtime.js#L278](https://github.com/webpack/webpack/blob/v4.39.1/lib/HotModuleReplacement.runtime.js</td></tr><tr><td style="text-align:left;">12.从缓存中删除旧模块</td><td style="text-align:left;">[HotModuleReplacement.runtime.js#L510](https://github.com/webpack/webpack/blob/v4.39.1/lib/HotModuleReplacement.runtime.js</td></tr><tr><td style="text-align:left;">13.执行accept的回调</td><td style="text-align:left;">[HotModuleReplacement.runtime.js#L569](https://github.com/webpack/webpack/blob/v4.39.1/lib/HotModuleReplacement.runtime.js</td></tr></tbody></table><h3 id="_4-3-相关代码" tabindex="-1"><a class="header-anchor" href="#_4-3-相关代码"><span>4.3 相关代码</span></a></h3><ul><li><a href="https://github.com/webpack/webpack-dev-server/blob/v3.7.2/bin/webpack-dev-server.js" target="_blank" rel="noopener noreferrer">webpack-dev-server.js</a></li><li><a href="https://github.com/webpack/webpack-dev-server/blob/v3.7.2/lib/Server.js" target="_blank" rel="noopener noreferrer">Server.js</a></li><li><a href="https://github.com/webpack/webpack-dev-middleware/blob/v3.7.0/index.js" target="_blank" rel="noopener noreferrer">webpack-dev-middleware/index.js</a></li><li><a href="https://github.com/webpack/webpack-dev-server/blob/v3.7.2/lib/servers/SockJSServer.js" target="_blank" rel="noopener noreferrer">SockJSServer.js</a></li></ul><p><img src="https://img.zhufengpeixun.com/1608382424775" alt="1608382424775.jpg"></p><h2 id="_5-启动开发服务器" tabindex="-1"><a class="header-anchor" href="#_5-启动开发服务器"><span>5.启动开发服务器</span></a></h2><h3 id="_5-1-startdevserver-js" tabindex="-1"><a class="header-anchor" href="#_5-1-startdevserver-js"><span>5.1 startDevServer.js</span></a></h3><p>startDevServer.js</p><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code class="language-javascript"><span class="line"><span class="token keyword">const</span> webpack <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;webpack&quot;</span><span class="token punctuation">)</span></span>
<span class="line"><span class="token keyword">const</span> Server <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&#39;./webpack-dev-server/lib/Server&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">const</span> config <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;./webpack.config&quot;</span><span class="token punctuation">)</span></span>
<span class="line"><span class="token keyword">function</span> <span class="token function">startDevServer</span><span class="token punctuation">(</span><span class="token parameter">compiler<span class="token punctuation">,</span>options</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">const</span> devServerOptions <span class="token operator">=</span> options<span class="token punctuation">.</span>devServer<span class="token operator">||</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">const</span> server <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Server</span><span class="token punctuation">(</span>compiler<span class="token punctuation">,</span> devServerOptions<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">const</span> <span class="token punctuation">{</span>host<span class="token operator">=</span><span class="token string">&#39;localhost&#39;</span><span class="token punctuation">,</span>port<span class="token operator">=</span><span class="token number">8080</span><span class="token punctuation">}</span><span class="token operator">=</span>devServerOptions<span class="token punctuation">;</span></span>
<span class="line">    server<span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span>port<span class="token punctuation">,</span> host<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">err</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></span>
<span class="line">        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">\`</span><span class="token string">Project is running at http://</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">\${</span>host<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">:</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">\${</span>port<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">\`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"><span class="token keyword">const</span> compiler <span class="token operator">=</span> <span class="token function">webpack</span><span class="token punctuation">(</span>config<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token function">startDevServer</span><span class="token punctuation">(</span>compiler<span class="token punctuation">,</span>config<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_5-2-server-js" tabindex="-1"><a class="header-anchor" href="#_5-2-server-js"><span>5.2 Server.js</span></a></h3><p>webpack-dev-server\\lib\\Server.js</p><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code class="language-javascript"><span class="line"><span class="token keyword">const</span> express <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;express&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">const</span> http <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;http&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">class</span> <span class="token class-name">Server</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter">compiler<span class="token punctuation">,</span>devServerOptions</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">this</span><span class="token punctuation">.</span>compiler <span class="token operator">=</span> compiler<span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">this</span><span class="token punctuation">.</span>devServerOptions <span class="token operator">=</span> devServerOptions<span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">setupApp</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">createServer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    <span class="token function">setupApp</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">this</span><span class="token punctuation">.</span>app <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">express</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    <span class="token function">createServer</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">this</span><span class="token punctuation">.</span>server <span class="token operator">=</span> http<span class="token punctuation">.</span><span class="token function">createServer</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>app<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    <span class="token function">listen</span><span class="token punctuation">(</span>port<span class="token punctuation">,</span> host <span class="token operator">=</span> <span class="token string">&quot;localhost&quot;</span><span class="token punctuation">,</span> <span class="token function-variable function">callback</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">         <span class="token keyword">this</span><span class="token punctuation">.</span>server<span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span>port<span class="token punctuation">,</span> host<span class="token punctuation">,</span> callback<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line">module<span class="token punctuation">.</span>exports <span class="token operator">=</span> Server<span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_5-3-package-json" tabindex="-1"><a class="header-anchor" href="#_5-3-package-json"><span>5.3 package.json</span></a></h3><p>package.json</p><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text"><pre><code class="language-text"><span class="line">  &quot;scripts&quot;: {</span>
<span class="line">    &quot;build&quot;: &quot;webpack&quot;,</span>
<span class="line">    &quot;dev&quot;: &quot;webpack-dev-server&quot;,</span>
<span class="line">+   &quot;start&quot;:&quot;node ./startDevServer.js&quot;</span>
<span class="line">  },</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="_6-给entry添加客户端" tabindex="-1"><a class="header-anchor" href="#_6-给entry添加客户端"><span>6.给entry添加客户端</span></a></h2><h3 id="_6-1-server-js" tabindex="-1"><a class="header-anchor" href="#_6-1-server-js"><span>6.1 Server.js</span></a></h3><p>webpack-dev-server\\lib\\server\\Server.js</p><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text"><pre><code class="language-text"><span class="line">const express = require(&quot;express&quot;);</span>
<span class="line">+const updateCompiler = require(&#39;./utils/updateCompiler&#39;);</span>
<span class="line">const http = require(&quot;http&quot;);</span>
<span class="line">class Server {</span>
<span class="line">    constructor(compiler,devServerOptions) {</span>
<span class="line">        this.compiler = compiler;</span>
<span class="line">        this.devServerOptions = devServerOptions;</span>
<span class="line">+       updateCompiler(compiler);</span>
<span class="line">        this.setupApp();</span>
<span class="line">        this.createServer();</span>
<span class="line">    }</span>
<span class="line">    setupApp() {</span>
<span class="line">        this.app = new express();</span>
<span class="line">    }</span>
<span class="line">    createServer() {</span>
<span class="line">        this.server = http.createServer(this.app);</span>
<span class="line">    }</span>
<span class="line">    listen(port, host = &quot;localhost&quot;, callback = ()=&gt;{}) {</span>
<span class="line">         this.server.listen(port, host, callback);</span>
<span class="line">    }</span>
<span class="line">}</span>
<span class="line">module.exports = Server;</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_6-2-updatecompiler-js" tabindex="-1"><a class="header-anchor" href="#_6-2-updatecompiler-js"><span>6.2 updateCompiler.js</span></a></h3><p>webpack-dev-server\\lib\\utils\\updateCompiler.js</p><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code class="language-javascript"><span class="line"><span class="token keyword">const</span> path <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;path&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">let</span> <span class="token function-variable function">updateCompiler</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">compiler</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">const</span> config <span class="token operator">=</span> compiler<span class="token punctuation">.</span>options<span class="token punctuation">;</span></span>
<span class="line">    <span class="token comment">//来自webpack-dev-server/client/index.js 在浏览器启动WS客户端</span></span>
<span class="line">    config<span class="token punctuation">.</span>entry<span class="token punctuation">.</span>main<span class="token punctuation">.</span>import<span class="token punctuation">.</span><span class="token function">unshift</span><span class="token punctuation">(</span>require<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token string">&quot;../../client/index.js&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token comment">//webpack/hot/dev-server.js 在浏览器监听WS发射出来的webpackHotUpdate事件</span></span>
<span class="line">    config<span class="token punctuation">.</span>entry<span class="token punctuation">.</span>main<span class="token punctuation">.</span>import<span class="token punctuation">.</span><span class="token function">unshift</span><span class="token punctuation">(</span>require<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token string">&quot;../../../webpack/hot/dev-server.js&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>config<span class="token punctuation">.</span>entry<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    compiler<span class="token punctuation">.</span>hooks<span class="token punctuation">.</span><span class="token function">entryOption</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>config<span class="token punctuation">.</span>context<span class="token punctuation">,</span> config<span class="token punctuation">.</span>entry<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line">module<span class="token punctuation">.</span>exports <span class="token operator">=</span> updateCompiler<span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_6-3-client-index-js" tabindex="-1"><a class="header-anchor" href="#_6-3-client-index-js"><span>6.3 client\\index.js</span></a></h3><p>webpack-dev-server\\lib\\client\\index.js</p><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code class="language-javascript"><span class="line">console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&#39;webpack-dev-server\\client\\index.js&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><h3 id="_6-4-dev-server-js" tabindex="-1"><a class="header-anchor" href="#_6-4-dev-server-js"><span>6.4 dev-server.js</span></a></h3><p>webpack-dev-server\\lib\\client\\hot\\dev-server.js</p><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code class="language-javascript"><span class="line">console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&#39;webpack-dev-server\\lib\\client\\hot\\dev-server.js&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><h2 id="_7-添加webpack的done事件回调" tabindex="-1"><a class="header-anchor" href="#_7-添加webpack的done事件回调"><span>7.添加webpack的done事件回调</span></a></h2><h3 id="_7-1-server-js" tabindex="-1"><a class="header-anchor" href="#_7-1-server-js"><span>7.1 Server.js</span></a></h3><p>webpack-dev-server\\lib\\server\\Server.js</p><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text"><pre><code class="language-text"><span class="line">const express = require(&quot;express&quot;);</span>
<span class="line">const updateCompiler = require(&#39;./utils/updateCompiler&#39;);</span>
<span class="line">const http = require(&quot;http&quot;);</span>
<span class="line">class Server {</span>
<span class="line">    constructor(compiler,devServerOptions) {</span>
<span class="line">        this.compiler = compiler;</span>
<span class="line">        this.devServerOptions=devServerOptions;</span>
<span class="line">        updateCompiler(compiler);</span>
<span class="line">+       this.sockets = [];</span>
<span class="line">+       this.setupHooks();</span>
<span class="line">        this.setupApp();</span>
<span class="line">        this.createServer();</span>
<span class="line">    }</span>
<span class="line">+    setupHooks() {</span>
<span class="line">+        this.compiler.hooks.done.tap(&#39;webpack-dev-server&#39;, (stats) =&gt; {</span>
<span class="line">+            console.log(&quot;stats.hash&quot;, stats.hash);</span>
<span class="line">+            this.sockets.forEach((socket) =&gt; {</span>
<span class="line">+                socket.emit(&quot;hash&quot;, stats.hash);</span>
<span class="line">+                socket.emit(&quot;ok&quot;);</span>
<span class="line">+            });</span>
<span class="line">+            this._stats = stats;</span>
<span class="line">+        });</span>
<span class="line">+    }</span>
<span class="line">    setupApp() {</span>
<span class="line">        this.app = new express();</span>
<span class="line">    }</span>
<span class="line">    createServer() {</span>
<span class="line">        this.server = http.createServer(this.app);</span>
<span class="line">    }</span>
<span class="line">    listen(port, host = &quot;localhost&quot;, callback = ()=&gt;{}) {</span>
<span class="line">         this.server.listen(port, host, callback);</span>
<span class="line">    }</span>
<span class="line">}</span>
<span class="line">module.exports = Server;</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="_8-webpack-dev-middleware中间件" tabindex="-1"><a class="header-anchor" href="#_8-webpack-dev-middleware中间件"><span>8.webpack-dev-middleware中间件</span></a></h2><ul><li><code>webpack-dev-middleware</code> 实现webpack编译和文件相关操作</li></ul><h3 id="_8-1-server-js" tabindex="-1"><a class="header-anchor" href="#_8-1-server-js"><span>8.1 Server.js</span></a></h3><p>webpack-dev-server\\lib\\Server.js</p><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text"><pre><code class="language-text"><span class="line">const express = require(&quot;express&quot;);</span>
<span class="line">const updateCompiler = require(&#39;./utils/updateCompiler&#39;);</span>
<span class="line">+const webpackDevMiddleware = require(&#39;../../webpack-dev-middleware&#39;);</span>
<span class="line">const http = require(&quot;http&quot;);</span>
<span class="line">class Server {</span>
<span class="line">    constructor(compiler,devServerOptions) {</span>
<span class="line">        this.compiler = compiler;</span>
<span class="line">        this.devServerOptions = devServerOptions;</span>
<span class="line">        updateCompiler(compiler);</span>
<span class="line">        this.sockets = [];</span>
<span class="line">        this.setupHooks();</span>
<span class="line">        this.setupApp();</span>
<span class="line">+       this.setupDevMiddleware();</span>
<span class="line">        this.createServer();</span>
<span class="line">    }</span>
<span class="line">+   setupDevMiddleware() {</span>
<span class="line">+        if(this.devServerOptions.contentBase)</span>
<span class="line">+            this.app.use(express.static(this.devServerOptions.contentBase));</span>
<span class="line">+        this.middleware = webpackDevMiddleware(this.compiler);</span>
<span class="line">+        this.app.use(this.middleware);</span>
<span class="line">+   }</span>
<span class="line">    setupHooks() {</span>
<span class="line">        this.compiler.hooks.done.tap(&#39;webpack-dev-server&#39;, (stats) =&gt; {</span>
<span class="line">            console.log(&quot;stats.hash&quot;, stats.hash);</span>
<span class="line">            this.sockets.forEach((socket) =&gt; {</span>
<span class="line">                socket.emit(&quot;hash&quot;, stats.hash);</span>
<span class="line">                socket.emit(&quot;ok&quot;);</span>
<span class="line">            });</span>
<span class="line">            this._stats = stats;</span>
<span class="line">        });</span>
<span class="line">    }</span>
<span class="line">    setupApp() {</span>
<span class="line">        this.app = new express();</span>
<span class="line">    }</span>
<span class="line">    createServer() {</span>
<span class="line">        this.server = http.createServer(this.app);</span>
<span class="line">    }</span>
<span class="line">    listen(port, host = &quot;localhost&quot;, callback = ()=&gt;{}) {</span>
<span class="line">         this.server.listen(port, host, callback);</span>
<span class="line">    }</span>
<span class="line">}</span>
<span class="line">module.exports = Server;</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_8-2-webpack-dev-middleware-index-js" tabindex="-1"><a class="header-anchor" href="#_8-2-webpack-dev-middleware-index-js"><span>8.2 webpack-dev-middleware\\index.js</span></a></h3><p>webpack-dev-middleware\\index.js</p><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code class="language-javascript"><span class="line"><span class="token keyword">const</span> middleware <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;./middleware&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">const</span> MemoryFileSystem <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;memory-fs&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">let</span> memoryFileSystem <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MemoryFileSystem</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">function</span> <span class="token function">webpackDevMiddleware</span><span class="token punctuation">(</span><span class="token parameter">compiler</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    compiler<span class="token punctuation">.</span><span class="token function">watch</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></span>
<span class="line">        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;start watching!&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">let</span> fs <span class="token operator">=</span> compiler<span class="token punctuation">.</span>outputFileSystem <span class="token operator">=</span> memoryFileSystem<span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">return</span> <span class="token function">middleware</span><span class="token punctuation">(</span><span class="token punctuation">{</span></span>
<span class="line">        fs<span class="token punctuation">,</span></span>
<span class="line">        <span class="token literal-property property">outputPath</span><span class="token operator">:</span>compiler<span class="token punctuation">.</span>options<span class="token punctuation">.</span>output<span class="token punctuation">.</span>path</span>
<span class="line">    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">module<span class="token punctuation">.</span>exports <span class="token operator">=</span> webpackDevMiddleware<span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_8-3-middleware-js" tabindex="-1"><a class="header-anchor" href="#_8-3-middleware-js"><span>8.3 middleware.js</span></a></h3><p>webpack-dev-middleware\\middleware.js</p><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code class="language-javascript"><span class="line"><span class="token keyword">const</span> mime <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&#39;mime&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">const</span> path <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;path&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">module<span class="token punctuation">.</span><span class="token function-variable function">exports</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token function">wrapper</span><span class="token punctuation">(</span><span class="token parameter">context</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">return</span> <span class="token keyword">function</span> <span class="token function">middleware</span><span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">let</span> url <span class="token operator">=</span> req<span class="token punctuation">.</span>url<span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">if</span> <span class="token punctuation">(</span>url <span class="token operator">===</span> <span class="token string">&quot;/&quot;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> url <span class="token operator">=</span> <span class="token string">&quot;/index.html&quot;</span><span class="token punctuation">;</span> <span class="token punctuation">}</span></span>
<span class="line">        <span class="token keyword">let</span> filename <span class="token operator">=</span> path<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span>context<span class="token punctuation">.</span>outputPath<span class="token punctuation">,</span> url<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">try</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token keyword">let</span> stat <span class="token operator">=</span> context<span class="token punctuation">.</span>fs<span class="token punctuation">.</span><span class="token function">statSync</span><span class="token punctuation">(</span>filename<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">            <span class="token keyword">if</span> <span class="token punctuation">(</span>stat<span class="token punctuation">.</span><span class="token function">isFile</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">                <span class="token keyword">let</span> content <span class="token operator">=</span> context<span class="token punctuation">.</span>fs<span class="token punctuation">.</span><span class="token function">readFileSync</span><span class="token punctuation">(</span>filename<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">                res<span class="token punctuation">.</span><span class="token function">setHeader</span><span class="token punctuation">(</span><span class="token string">&quot;Content-Type&quot;</span><span class="token punctuation">,</span> mime<span class="token punctuation">.</span><span class="token function">getType</span><span class="token punctuation">(</span>filename<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">                res<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span>content<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span></span>
<span class="line">                res<span class="token punctuation">.</span><span class="token function">sendStatus</span><span class="token punctuation">(</span><span class="token number">404</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">            <span class="token punctuation">}</span></span>
<span class="line">        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">            res<span class="token punctuation">.</span><span class="token function">sendStatus</span><span class="token punctuation">(</span><span class="token number">404</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">    <span class="token punctuation">}</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="_9-创建消息服务器" tabindex="-1"><a class="header-anchor" href="#_9-创建消息服务器"><span>9.创建消息服务器</span></a></h2><h3 id="_9-1-server-js" tabindex="-1"><a class="header-anchor" href="#_9-1-server-js"><span>9.1 Server.js</span></a></h3><p>webpack-dev-server\\lib\\server\\Server.js</p><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text"><pre><code class="language-text"><span class="line">const express = require(&quot;express&quot;);</span>
<span class="line">const updateCompiler = require(&#39;./utils/updateCompiler&#39;);</span>
<span class="line">const webpackDevMiddleware = require(&#39;../../webpack-dev-middleware&#39;);</span>
<span class="line">const http = require(&quot;http&quot;);</span>
<span class="line">+const WebsocketServer = require(&quot;socket.io&quot;);</span>
<span class="line">class Server {</span>
<span class="line">    constructor(compiler) {</span>
<span class="line">        this.compiler = compiler;</span>
<span class="line">        updateCompiler(compiler);</span>
<span class="line">        this.sockets = [];</span>
<span class="line">        this.setupHooks();</span>
<span class="line">        this.setupApp();</span>
<span class="line">        this.setupDevMiddleware();</span>
<span class="line">        this.createServer();</span>
<span class="line">+       this.createSocketServer();</span>
<span class="line">    }</span>
<span class="line">    setupDevMiddleware() {</span>
<span class="line">        this.middleware = webpackDevMiddleware(this.compiler);</span>
<span class="line">        this.app.use(this.middleware);</span>
<span class="line">    }</span>
<span class="line">    setupHooks() {</span>
<span class="line">        this.compiler.hooks.done.tap(&#39;webpack-dev-server&#39;, (stats) =&gt; {</span>
<span class="line">            console.log(&quot;stats.hash&quot;, stats.hash);</span>
<span class="line">            this.sockets.forEach((socket) =&gt; {</span>
<span class="line">                socket.emit(&quot;hash&quot;, stats.hash);</span>
<span class="line">                socket.emit(&quot;ok&quot;);</span>
<span class="line">            });</span>
<span class="line">            this._stats = stats;</span>
<span class="line">        });</span>
<span class="line">    }</span>
<span class="line">    setupApp() {</span>
<span class="line">        this.app = new express();</span>
<span class="line">    }</span>
<span class="line">    createServer() {</span>
<span class="line">        this.server = http.createServer(this.app);</span>
<span class="line">    }</span>
<span class="line">+    createSocketServer() {</span>
<span class="line">+        const io = WebsocketServer(this.server);</span>
<span class="line">+        io.on(&quot;connection&quot;, (socket) =&gt; {</span>
<span class="line">+            console.log(&quot;client connected&quot;);</span>
<span class="line">+            this.sockets.push(socket);</span>
<span class="line">+            socket.on(&quot;disconnect&quot;, () =&gt; {</span>
<span class="line">+                let index = this.sockets.indexOf(socket);</span>
<span class="line">+                this.sockets = this.sockets.splice(index, 1);</span>
<span class="line">+            });</span>
<span class="line">+            if(this._stats){</span>
<span class="line">+              socket.emit(&#39;hash&#39;, this._stats.hash);</span>
<span class="line">+              socket.emit(&#39;ok&#39;);</span>
<span class="line">+            }</span>
<span class="line">+        });</span>
<span class="line">+    }</span>
<span class="line">    listen(port, host = &quot;localhost&quot;, callback = ()=&gt;{}) {</span>
<span class="line">         this.server.listen(port, host, callback);</span>
<span class="line">    }</span>
<span class="line">}</span>
<span class="line">module.exports = Server;</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="_1-客户端连接消息服务器" tabindex="-1"><a class="header-anchor" href="#_1-客户端连接消息服务器"><span>1.客户端连接消息服务器</span></a></h2><h3 id="_1-1-index-html" tabindex="-1"><a class="header-anchor" href="#_1-1-index-html"><span>1.1 index.html</span></a></h3><p>src\\index.html</p><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text"><pre><code class="language-text"><span class="line">&lt;!DOCTYPE html&gt;</span>
<span class="line">&lt;html lang=&quot;en&quot;&gt;</span>
<span class="line">&lt;head&gt;</span>
<span class="line">    &lt;meta charset=&quot;UTF-8&quot;&gt;</span>
<span class="line">    &lt;meta name=&quot;viewport&quot; content=&quot;width=device-width, initial-scale=1.0&quot;&gt;</span>
<span class="line">    &lt;title&gt;hmr&lt;/title&gt;</span>
<span class="line">&lt;/head&gt;</span>
<span class="line">&lt;body&gt;</span>
<span class="line">    &lt;input/&gt;</span>
<span class="line">    &lt;div id=&quot;root&quot;&gt;&lt;/div&gt;</span>
<span class="line">+   &lt;script src=&quot;/socket.io/socket.io.js&quot;&gt;&lt;/script&gt;</span>
<span class="line">&lt;/body&gt;</span>
<span class="line">&lt;/html&gt;</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_1-2-webpack-hot-emitter-js" tabindex="-1"><a class="header-anchor" href="#_1-2-webpack-hot-emitter-js"><span>1.2 webpack\\hot\\emitter.js</span></a></h3><p>webpack\\hot\\emitter.js</p><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code class="language-javascript"><span class="line"><span class="token keyword">class</span> <span class="token class-name">EventEmitter</span> <span class="token punctuation">{</span></span>
<span class="line">  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">this</span><span class="token punctuation">.</span>events <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span></span>
<span class="line">  <span class="token punctuation">}</span></span>
<span class="line">  <span class="token function">on</span><span class="token punctuation">(</span><span class="token parameter">eventName<span class="token punctuation">,</span> fn</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">this</span><span class="token punctuation">.</span>events<span class="token punctuation">[</span>eventName<span class="token punctuation">]</span> <span class="token operator">=</span> fn<span class="token punctuation">;</span></span>
<span class="line">  <span class="token punctuation">}</span></span>
<span class="line">  <span class="token function">emit</span><span class="token punctuation">(</span><span class="token parameter">eventName<span class="token punctuation">,</span> <span class="token operator">...</span>args</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">this</span><span class="token punctuation">.</span>events<span class="token punctuation">[</span>eventName<span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token operator">...</span>args<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">  <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line">module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">EventEmitter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_1-3-webpack-dev-server-client-index-js" tabindex="-1"><a class="header-anchor" href="#_1-3-webpack-dev-server-client-index-js"><span>1.3 webpack-dev-server\\client\\index.js</span></a></h3><p>webpack-dev-server\\client\\index.js</p><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code class="language-javascript"><span class="line"><span class="token keyword">var</span> hotEmitter <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;../../webpack/hot/emitter&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">var</span> socket <span class="token operator">=</span> <span class="token function">io</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">var</span> currentHash <span class="token operator">=</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">var</span> initial <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span></span>
<span class="line">socket<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">&quot;hash&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">hash</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></span>
<span class="line">  currentHash <span class="token operator">=</span> hash<span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">socket<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">&quot;ok&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></span>
<span class="line">  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;ok&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">  <span class="token keyword">if</span><span class="token punctuation">(</span>initial<span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">return</span> initial<span class="token operator">=</span><span class="token boolean">false</span><span class="token punctuation">;</span>  </span>
<span class="line">  <span class="token punctuation">}</span></span>
<span class="line">  <span class="token function">reloadApp</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">function</span> <span class="token function">reloadApp</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">  hotEmitter<span class="token punctuation">.</span><span class="token function">emit</span><span class="token punctuation">(</span><span class="token string">&quot;webpackHotUpdate&quot;</span><span class="token punctuation">,</span> currentHash<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_1-4-webpack-hot-dev-server-js" tabindex="-1"><a class="header-anchor" href="#_1-4-webpack-hot-dev-server-js"><span>1.4 webpack\\hot\\dev-server.js</span></a></h3><p>webpack\\hot\\dev-server.js</p><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code class="language-javascript"><span class="line"><span class="token keyword">var</span> hotEmitter <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&#39;../../webpack/hot/emitter&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">hotEmitter<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">&quot;webpackHotUpdate&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">currentHash</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></span>
<span class="line">   console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&#39;dev-server&#39;</span><span class="token punctuation">,</span>currentHash<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span><span class="token punctuation">)</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="_2-打包后文件分析" tabindex="-1"><a class="header-anchor" href="#_2-打包后文件分析"><span>2.打包后文件分析</span></a></h2><h3 id="_2-1-static-hmr-html" tabindex="-1"><a class="header-anchor" href="#_2-1-static-hmr-html"><span>2.1 static\\hmr.html</span></a></h3><p>static\\hmr.html</p><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code class="language-javascript"><span class="line"><span class="token operator">&lt;</span><span class="token operator">!</span><span class="token constant">DOCTYPE</span> html<span class="token operator">&gt;</span></span>
<span class="line"><span class="token operator">&lt;</span>html lang<span class="token operator">=</span><span class="token string">&quot;en&quot;</span><span class="token operator">&gt;</span></span>
<span class="line"><span class="token operator">&lt;</span>head<span class="token operator">&gt;</span></span>
<span class="line">    <span class="token operator">&lt;</span>meta charset<span class="token operator">=</span><span class="token string">&quot;UTF-8&quot;</span><span class="token operator">&gt;</span></span>
<span class="line">    <span class="token operator">&lt;</span>meta name<span class="token operator">=</span><span class="token string">&quot;viewport&quot;</span> content<span class="token operator">=</span><span class="token string">&quot;width=device-width, initial-scale=1.0&quot;</span><span class="token operator">&gt;</span></span>
<span class="line">    <span class="token operator">&lt;</span>title<span class="token operator">&gt;</span>Document<span class="token operator">&lt;</span><span class="token operator">/</span>title<span class="token operator">&gt;</span></span>
<span class="line"><span class="token operator">&lt;</span><span class="token operator">/</span>head<span class="token operator">&gt;</span></span>
<span class="line"><span class="token operator">&lt;</span>body<span class="token operator">&gt;</span></span>
<span class="line">    <span class="token operator">&lt;</span>input<span class="token operator">/</span><span class="token operator">&gt;</span></span>
<span class="line">    <span class="token operator">&lt;</span>div id<span class="token operator">=</span><span class="token string">&quot;root&quot;</span><span class="token operator">&gt;</span><span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">&gt;</span></span>
<span class="line">    <span class="token operator">&lt;</span>script src<span class="token operator">=</span><span class="token string">&quot;/socket.io/socket.io.js&quot;</span><span class="token operator">&gt;</span><span class="token operator">&lt;</span><span class="token operator">/</span>script<span class="token operator">&gt;</span></span>
<span class="line">    <span class="token operator">&lt;</span>script src<span class="token operator">=</span><span class="token string">&quot;hmr.js&quot;</span><span class="token operator">&gt;</span><span class="token operator">&lt;</span><span class="token operator">/</span>script<span class="token operator">&gt;</span><span class="token operator">&lt;</span><span class="token operator">/</span>body<span class="token operator">&gt;</span></span>
<span class="line"><span class="token operator">&lt;</span><span class="token operator">/</span>html<span class="token operator">&gt;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_2-2-static-hmr-js" tabindex="-1"><a class="header-anchor" href="#_2-2-static-hmr-js"><span>2.2 static\\hmr.js</span></a></h3><p>static\\hmr.js</p><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code class="language-javascript"><span class="line"><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></span>
<span class="line">  <span class="token keyword">var</span> modules <span class="token operator">=</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token string-property property">&quot;./src/title.js&quot;</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token parameter">module</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></span>
<span class="line">      module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token string">&quot;title3&quot;</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token string-property property">&quot;./webpack/hot/emitter.js&quot;</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token parameter">module</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></span>
<span class="line">      <span class="token keyword">class</span> <span class="token class-name">EventEmitter</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">          <span class="token keyword">this</span><span class="token punctuation">.</span>events <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">        <span class="token function">on</span><span class="token punctuation">(</span><span class="token parameter">eventName<span class="token punctuation">,</span> fn</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">          <span class="token keyword">this</span><span class="token punctuation">.</span>events<span class="token punctuation">[</span>eventName<span class="token punctuation">]</span> <span class="token operator">=</span> fn<span class="token punctuation">;</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">        <span class="token function">emit</span><span class="token punctuation">(</span><span class="token parameter">eventName<span class="token punctuation">,</span> <span class="token operator">...</span>args</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">          <span class="token keyword">this</span><span class="token punctuation">.</span>events<span class="token punctuation">[</span>eventName<span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token operator">...</span>args<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">      <span class="token punctuation">}</span></span>
<span class="line">      module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">EventEmitter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">  <span class="token punctuation">}</span><span class="token punctuation">;</span></span>
<span class="line">  <span class="token keyword">var</span> cache <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span></span>
<span class="line">  <span class="token keyword">function</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token parameter">moduleId</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">if</span> <span class="token punctuation">(</span>cache<span class="token punctuation">[</span>moduleId<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">      <span class="token keyword">return</span> cache<span class="token punctuation">[</span>moduleId<span class="token punctuation">]</span><span class="token punctuation">.</span>exports<span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    <span class="token keyword">var</span> module <span class="token operator">=</span> <span class="token punctuation">(</span>cache<span class="token punctuation">[</span>moduleId<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span></span>
<span class="line">      <span class="token literal-property property">exports</span><span class="token operator">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    modules<span class="token punctuation">[</span>moduleId<span class="token punctuation">]</span><span class="token punctuation">(</span>module<span class="token punctuation">,</span> module<span class="token punctuation">.</span>exports<span class="token punctuation">,</span> require<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">return</span> module<span class="token punctuation">.</span>exports<span class="token punctuation">;</span></span>
<span class="line">  <span class="token punctuation">}</span></span>
<span class="line">  <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">var</span> hotEmitter <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;./webpack/hot/emitter.js&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">var</span> socket <span class="token operator">=</span> <span class="token function">io</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">var</span> currentHash <span class="token operator">=</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">var</span> initial <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span></span>
<span class="line">    socket<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">&quot;hash&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">hash</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></span>
<span class="line">      currentHash <span class="token operator">=</span> hash<span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    socket<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">&quot;ok&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></span>
<span class="line">      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;ok&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">      <span class="token keyword">if</span> <span class="token punctuation">(</span>initial<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">return</span> <span class="token punctuation">(</span>initial <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">      <span class="token punctuation">}</span></span>
<span class="line">      <span class="token function">reloadApp</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">function</span> <span class="token function">reloadApp</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">      hotEmitter<span class="token punctuation">.</span><span class="token function">emit</span><span class="token punctuation">(</span><span class="token string">&quot;webpackHotUpdate&quot;</span><span class="token punctuation">,</span> currentHash<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">  <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">var</span> hotEmitter <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;./webpack/hot/emitter.js&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    hotEmitter<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">&quot;webpackHotUpdate&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">currentHash</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></span>
<span class="line">      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;dev-server&quot;</span><span class="token punctuation">,</span> currentHash<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">  <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">let</span> <span class="token function-variable function">render</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></span>
<span class="line">      <span class="token keyword">let</span> title <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;./src/title.js&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">      root<span class="token punctuation">.</span>innerText <span class="token operator">=</span> title<span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="_2-创建模块父子关系" tabindex="-1"><a class="header-anchor" href="#_2-创建模块父子关系"><span>2.创建模块父子关系</span></a></h2><h3 id="_2-1-hmr-js" tabindex="-1"><a class="header-anchor" href="#_2-1-hmr-js"><span>2.1 hmr.js</span></a></h3><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text"><pre><code class="language-text"><span class="line">(() =&gt; {</span>
<span class="line">  var modules = {</span>
<span class="line">+    &quot;./src/index.js&quot;: (module,exports,require) =&gt; {</span>
<span class="line">+      let render = () =&gt; {</span>
<span class="line">+        let title = require(&quot;./src/title.js&quot;);</span>
<span class="line">+        root.innerText = title;</span>
<span class="line">+      };</span>
<span class="line">+      render();</span>
<span class="line">+    },</span>
<span class="line">    &quot;./src/title.js&quot;: (module) =&gt; {</span>
<span class="line">      module.exports = &quot;title3&quot;;</span>
<span class="line">    },</span>
<span class="line">    &quot;./webpack/hot/emitter.js&quot;: (module) =&gt; {</span>
<span class="line">      class EventEmitter {</span>
<span class="line">        constructor() {</span>
<span class="line">          this.events = {};</span>
<span class="line">        }</span>
<span class="line">        on(eventName, fn) {</span>
<span class="line">          this.events[eventName] = fn;</span>
<span class="line">        }</span>
<span class="line">        emit(eventName, ...args) {</span>
<span class="line">          this.events[eventName](...args);</span>
<span class="line">        }</span>
<span class="line">      }</span>
<span class="line">      module.exports = new EventEmitter();</span>
<span class="line">    },</span>
<span class="line">  };</span>
<span class="line">  var cache = {};</span>
<span class="line">+  function hotCreateModule() {</span>
<span class="line">+    var hot = {</span>
<span class="line">+      _acceptedDependencies: {},</span>
<span class="line">+      accept: function (deps, callback) {</span>
<span class="line">+        for (var i = 0; i &lt; deps.length; i++)</span>
<span class="line">+          hot._acceptedDependencies[deps[i]] = callback;</span>
<span class="line">+      },</span>
<span class="line">+      check: hotCheck,</span>
<span class="line">+    };</span>
<span class="line">+    return hot;</span>
<span class="line">+  }</span>
<span class="line">+ function hotCreateRequire(parentModuleId) {</span>
<span class="line">+   var parentModule = cache[parentModuleId];</span>
<span class="line">+   if (!parentModule) return require;</span>
<span class="line">+   var fn = function (childModuleId) {</span>
<span class="line">+     parentModule.children.push(childModuleId);</span>
<span class="line">+     require(childModuleId);</span>
<span class="line">+     let childModule = cache[childModuleId];</span>
<span class="line">+     childModule.parents.push(parentModule);</span>
<span class="line">+     return childModule.exports;</span>
<span class="line">+   };</span>
<span class="line">+   return fn;</span>
<span class="line">+ }</span>
<span class="line">  function require(moduleId) {</span>
<span class="line">    if (cache[moduleId]) {</span>
<span class="line">      return cache[moduleId].exports;</span>
<span class="line">    }</span>
<span class="line">    var module = (cache[moduleId] = {</span>
<span class="line">      exports: {},</span>
<span class="line">+      hot: hotCreateModule(moduleId),</span>
<span class="line">+      parents: [],</span>
<span class="line">+      children: [],</span>
<span class="line">    });</span>
<span class="line">+    modules[moduleId](module, module.exports, hotCreateRequire(moduleId));</span>
<span class="line">    return module.exports;</span>
<span class="line">  }</span>
<span class="line">  (() =&gt; {</span>
<span class="line">    var hotEmitter = require(&quot;./webpack/hot/emitter.js&quot;);</span>
<span class="line">    var socket = io();</span>
<span class="line">    var currentHash = &quot;&quot;;</span>
<span class="line">    var initial = true;</span>
<span class="line">    socket.on(&quot;hash&quot;, (hash) =&gt; {</span>
<span class="line">      currentHash = hash;</span>
<span class="line">    });</span>
<span class="line">    socket.on(&quot;ok&quot;, () =&gt; {</span>
<span class="line">      console.log(&quot;ok&quot;);</span>
<span class="line">      reloadApp();</span>
<span class="line">    });</span>
<span class="line">    function reloadApp() {</span>
<span class="line">      hotEmitter.emit(&quot;webpackHotUpdate&quot;, currentHash);</span>
<span class="line">    }</span>
<span class="line">  })();</span>
<span class="line">  (() =&gt; {</span>
<span class="line">    var hotEmitter = require(&quot;./webpack/hot/emitter.js&quot;);</span>
<span class="line">    hotEmitter.on(&quot;webpackHotUpdate&quot;, (currentHash) =&gt; {</span>
<span class="line">      console.log(&quot;dev-server&quot;, currentHash);</span>
<span class="line">    });</span>
<span class="line">  })();</span>
<span class="line">+  return hotCreateRequire(&quot;./src/index.js&quot;)(&quot;./src/index.js&quot;);</span>
<span class="line">})();</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="_3-热更新" tabindex="-1"><a class="header-anchor" href="#_3-热更新"><span>3.热更新</span></a></h2><h3 id="_3-1-webpack-config-js" tabindex="-1"><a class="header-anchor" href="#_3-1-webpack-config-js"><span>3.1 webpack.config.js</span></a></h3><p>webpack.config.js</p><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text"><pre><code class="language-text"><span class="line">module.exports = {</span>
<span class="line">    output: {</span>
<span class="line">        filename: &quot;[name].js&quot;,</span>
<span class="line">        path: path.resolve(__dirname, &quot;dist&quot;),</span>
<span class="line">+        hotUpdateGlobal:&#39;webpackHotUpdate&#39;</span>
<span class="line">    }</span>
<span class="line">}</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_3-2-hmr-js" tabindex="-1"><a class="header-anchor" href="#_3-2-hmr-js"><span>3.2 hmr.js</span></a></h3><p>static\\hmr.js</p><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text"><pre><code class="language-text"><span class="line">(() =&gt; {</span>
<span class="line">   var cache = {};</span>
<span class="line">+  var currentHash;</span>
<span class="line">+  var lastHash;</span>
<span class="line">+  let hotCheck = () =&gt; {</span>
<span class="line">+    hotDownloadManifest()</span>
<span class="line">+      .then((update) =&gt; {</span>
<span class="line">+        update.c.forEach((chunkID) =&gt; {</span>
<span class="line">+          hotDownloadUpdateChunk(chunkID);</span>
<span class="line">+        });</span>
<span class="line">+        lastHash = currentHash;</span>
<span class="line">+      })</span>
<span class="line">+      .catch((err) =&gt; {</span>
<span class="line">+        window.location.reload();</span>
<span class="line">+      });</span>
<span class="line">+  };</span>
<span class="line">+  let hotDownloadManifest = () =&gt; {</span>
<span class="line">+    return new Promise((resolve, reject) =&gt; {</span>
<span class="line">+      let xhr = new XMLHttpRequest();</span>
<span class="line">+      let hotUpdatePath = \`main.\${lastHash}.hot-update.json\`;</span>
<span class="line">+      xhr.open(&quot;get&quot;, hotUpdatePath);</span>
<span class="line">+      xhr.onload = () =&gt; {</span>
<span class="line">+        let hotUpdate = JSON.parse(xhr.responseText);</span>
<span class="line">+        resolve(hotUpdate);</span>
<span class="line">+      };</span>
<span class="line">+      xhr.onerror = (error) =&gt; {</span>
<span class="line">+        reject(error);</span>
<span class="line">+      };</span>
<span class="line">+      xhr.send();</span>
<span class="line">+    });</span>
<span class="line">+  };</span>
<span class="line">+  let hotDownloadUpdateChunk = (chunkID) =&gt; {</span>
<span class="line">+    let script = document.createElement(&quot;script&quot;);</span>
<span class="line">+    script.src = \`\${chunkID}.\${lastHash}.hot-update.js\`;</span>
<span class="line">+    document.head.appendChild(script);</span>
<span class="line">+  };</span>
<span class="line">+  self[&#39;webpackHotUpdate&#39;] = (chunkId, moreModules) =&gt; {</span>
<span class="line">+    hotAddUpdateChunk(chunkId, moreModules);</span>
<span class="line">+  };</span>
<span class="line">+  let hotUpdate = {};</span>
<span class="line">+  function hotAddUpdateChunk(chunkId, moreModules) {</span>
<span class="line">+    for (var moduleId in moreModules) {</span>
<span class="line">+      hotUpdate[moduleId] = modules[moduleId] = moreModules[moduleId];</span>
<span class="line">+    }</span>
<span class="line">+    hotApply();</span>
<span class="line">+  }</span>
<span class="line">+  function hotApply() {</span>
<span class="line">+    for (let moduleId in hotUpdate) {</span>
<span class="line">+      let oldModule = cache[moduleId];</span>
<span class="line">+      delete cache[moduleId];</span>
<span class="line">+      oldModule.parents &amp;&amp;</span>
<span class="line">+        oldModule.parents.forEach((parentModule) =&gt; {</span>
<span class="line">+          parentModule.hot._acceptedDependencies[moduleId] &amp;&amp;</span>
<span class="line">+            parentModule.hot._acceptedDependencies[moduleId]();</span>
<span class="line">+        });</span>
<span class="line">+    }</span>
<span class="line">+  }</span>
<span class="line">  var modules = {</span>
<span class="line">    &quot;./src/index.js&quot;: (module, exports, require) =&gt; {</span>
<span class="line">      let render = () =&gt; {</span>
<span class="line">        let title = require(&quot;./src/title.js&quot;);</span>
<span class="line">        root.innerText = title;</span>
<span class="line">      };</span>
<span class="line">      render();</span>
<span class="line">      if (module.hot) {</span>
<span class="line">        module.hot.accept([&quot;./src/title.js&quot;], render);</span>
<span class="line">      }</span>
<span class="line">    },</span>
<span class="line">    &quot;./src/title.js&quot;: (module) =&gt; {</span>
<span class="line">      module.exports = &quot;title3&quot;;</span>
<span class="line">    },</span>
<span class="line">    &quot;./webpack/hot/emitter.js&quot;: (module) =&gt; {</span>
<span class="line">      class EventEmitter {</span>
<span class="line">        constructor() {</span>
<span class="line">          this.events = {};</span>
<span class="line">        }</span>
<span class="line">        on(eventName, fn) {</span>
<span class="line">          this.events[eventName] = fn;</span>
<span class="line">        }</span>
<span class="line">        emit(eventName, ...args) {</span>
<span class="line">          this.events[eventName](...args);</span>
<span class="line">        }</span>
<span class="line">      }</span>
<span class="line">      module.exports = new EventEmitter();</span>
<span class="line">    },</span>
<span class="line">  };</span>
<span class="line"></span>
<span class="line">  function hotCreateModule() {</span>
<span class="line">    var hot = {</span>
<span class="line">      _acceptedDependencies: {},</span>
<span class="line">      accept: function (deps, callback) {</span>
<span class="line">        for (var i = 0; i &lt; deps.length; i++)</span>
<span class="line">          hot._acceptedDependencies[deps[i]] = callback;</span>
<span class="line">      },</span>
<span class="line">      check: hotCheck,</span>
<span class="line">    };</span>
<span class="line">    return hot;</span>
<span class="line">  }</span>
<span class="line">  function hotCreateRequire(parentModuleId) {</span>
<span class="line">    var parentModule = cache[parentModuleId];</span>
<span class="line">    if (!parentModule) return require;</span>
<span class="line">    var fn = function (childModuleId) {</span>
<span class="line">      parentModule.children.push(childModuleId);</span>
<span class="line">      require(childModuleId);</span>
<span class="line">      let childModule = cache[childModuleId];</span>
<span class="line">      childModule.parents.push(parentModule);</span>
<span class="line">      return childModule.exports;</span>
<span class="line">    };</span>
<span class="line">    return fn;</span>
<span class="line">  }</span>
<span class="line">  function require(moduleId) {</span>
<span class="line">    if (cache[moduleId]) {</span>
<span class="line">      return cache[moduleId].exports;</span>
<span class="line">    }</span>
<span class="line">    var module = (cache[moduleId] = {</span>
<span class="line">      exports: {},</span>
<span class="line">      hot: hotCreateModule(moduleId),</span>
<span class="line">      parents: [],</span>
<span class="line">      children: [],</span>
<span class="line">    });</span>
<span class="line">    modules[moduleId](module, module.exports, hotCreateRequire(moduleId));</span>
<span class="line">    return module.exports;</span>
<span class="line">  }</span>
<span class="line">  (() =&gt; {</span>
<span class="line">    var hotEmitter = require(&quot;./webpack/hot/emitter.js&quot;);</span>
<span class="line">    var socket = io();</span>
<span class="line">    var initial = true;</span>
<span class="line">    socket.on(&quot;hash&quot;, (hash) =&gt; {</span>
<span class="line">      currentHash = hash;</span>
<span class="line">    });</span>
<span class="line">    socket.on(&quot;ok&quot;, () =&gt; {</span>
<span class="line">      console.log(&quot;ok&quot;);</span>
<span class="line">      reloadApp();</span>
<span class="line">    });</span>
<span class="line">    function reloadApp() {</span>
<span class="line">      hotEmitter.emit(&quot;webpackHotUpdate&quot;, currentHash);</span>
<span class="line">    }</span>
<span class="line">  })();</span>
<span class="line">  (() =&gt; {</span>
<span class="line">    var hotEmitter = require(&quot;./webpack/hot/emitter.js&quot;);</span>
<span class="line">    hotEmitter.on(&quot;webpackHotUpdate&quot;, (currentHash) =&gt; {</span>
<span class="line">+     if (!lastHash) {</span>
<span class="line">+       lastHash = currentHash;</span>
<span class="line">+       console.log(&quot;lastHash=&quot;, lastHash, &quot;currentHash=&quot;, currentHash);</span>
<span class="line">+       return;</span>
<span class="line">+     }</span>
<span class="line">+     console.log(&quot;lastHash=&quot;, lastHash, &quot;currentHash=&quot;, currentHash);</span>
<span class="line">+     console.log(&quot;webpackHotUpdate hotCheck&quot;);</span>
<span class="line">+     hotCheck();</span>
<span class="line">    });</span>
<span class="line">  })();</span>
<span class="line">  return hotCreateRequire(&quot;./src/index.js&quot;)(&quot;./src/index.js&quot;);</span>
<span class="line">})();</span>
<span class="line"></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="_4-注释版" tabindex="-1"><a class="header-anchor" href="#_4-注释版"><span>4.注释版</span></a></h2><h3 id="_4-1-hmr-js" tabindex="-1"><a class="header-anchor" href="#_4-1-hmr-js"><span>4.1 hmr.js</span></a></h3><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code class="language-javascript"><span class="line"><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></span>
<span class="line">  <span class="token keyword">var</span> cache <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span></span>
<span class="line">  <span class="token keyword">var</span> currentHash<span class="token punctuation">;</span></span>
<span class="line">  <span class="token keyword">var</span> lastHash<span class="token punctuation">;</span></span>
<span class="line">  <span class="token keyword">let</span> hotUpdate <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">  <span class="token keyword">let</span> <span class="token function-variable function">hotCheck</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token comment">//6.它通过调用 JsonpMainTemplate.runtime的hotDownloadManifest方法，向 server 端发送 Ajax 请求，服务端返回一个 Manifest文件，该 Manifest 包含了所有要更新的模块的 hash 值和chunk名</span></span>
<span class="line">    <span class="token function">hotDownloadManifest</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">      <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">update</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></span>
<span class="line">        update<span class="token punctuation">.</span>c<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">chunkID</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></span>
<span class="line"></span>
<span class="line">          <span class="token comment">//7.调用JsonpMainTemplate.runtime的hotDownloadUpdateChunk方法通过JSONP请求获取到最新的模块代码</span></span>
<span class="line">          <span class="token function">hotDownloadUpdateChunk</span><span class="token punctuation">(</span>chunkID<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        lastHash <span class="token operator">=</span> currentHash<span class="token punctuation">;</span></span>
<span class="line">      <span class="token punctuation">}</span><span class="token punctuation">)</span></span>
<span class="line">      <span class="token punctuation">.</span><span class="token function">catch</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">err</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></span>
<span class="line">        window<span class="token punctuation">.</span>location<span class="token punctuation">.</span><span class="token function">reload</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">  <span class="token punctuation">}</span><span class="token punctuation">;</span></span>
<span class="line">  <span class="token keyword">let</span> <span class="token function-variable function">hotDownloadManifest</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></span>
<span class="line">      <span class="token keyword">let</span> xhr <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">XMLHttpRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">      <span class="token keyword">let</span> hotUpdatePath <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">\`</span><span class="token string">main.</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">\${</span>lastHash<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">.hot-update.json</span><span class="token template-punctuation string">\`</span></span><span class="token punctuation">;</span></span>
<span class="line">      xhr<span class="token punctuation">.</span><span class="token function">open</span><span class="token punctuation">(</span><span class="token string">&quot;get&quot;</span><span class="token punctuation">,</span> hotUpdatePath<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">      xhr<span class="token punctuation">.</span><span class="token function-variable function">onload</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">let</span> hotUpdate <span class="token operator">=</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>xhr<span class="token punctuation">.</span>responseText<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token function">resolve</span><span class="token punctuation">(</span>hotUpdate<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">      <span class="token punctuation">}</span><span class="token punctuation">;</span></span>
<span class="line">      xhr<span class="token punctuation">.</span><span class="token function-variable function">onerror</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">error</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token function">reject</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">      <span class="token punctuation">}</span><span class="token punctuation">;</span></span>
<span class="line">      xhr<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">  <span class="token punctuation">}</span><span class="token punctuation">;</span></span>
<span class="line">  <span class="token keyword">let</span> <span class="token function-variable function">hotDownloadUpdateChunk</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">chunkID</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">let</span> script <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">&quot;script&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    script<span class="token punctuation">.</span>src <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">\`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">\${</span>chunkID<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">.</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">\${</span>lastHash<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">.hot-update.js</span><span class="token template-punctuation string">\`</span></span><span class="token punctuation">;</span></span>
<span class="line">    document<span class="token punctuation">.</span>head<span class="token punctuation">.</span><span class="token function">appendChild</span><span class="token punctuation">(</span>script<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">  <span class="token punctuation">}</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">  <span class="token comment">//8.补丁JS取回来后会调用JsonpMainTemplate.runtime.js的webpackHotUpdate方法，里面会调用hotAddUpdateChunk方法,用新的模块替换掉旧的模块</span></span>
<span class="line">  self<span class="token punctuation">[</span><span class="token string">&#39;webpackHotUpdate&#39;</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">chunkId<span class="token punctuation">,</span> moreModules</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></span>
<span class="line">      <span class="token comment">//9.然后会调用HotModuleReplacement.runtime.js的hotAddUpdateChunk方法动态更新模块代 码</span></span>
<span class="line">      <span class="token function">hotAddUpdateChunk</span><span class="token punctuation">(</span>chunkId<span class="token punctuation">,</span> moreModules<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">  <span class="token punctuation">}</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">  <span class="token keyword">function</span> <span class="token function">hotAddUpdateChunk</span><span class="token punctuation">(</span><span class="token parameter">chunkId<span class="token punctuation">,</span> moreModules</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">var</span> moduleId <span class="token keyword">in</span> moreModules<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">      hotUpdate<span class="token punctuation">[</span>moduleId<span class="token punctuation">]</span> <span class="token operator">=</span> modules<span class="token punctuation">[</span>moduleId<span class="token punctuation">]</span> <span class="token operator">=</span> moreModules<span class="token punctuation">[</span>moduleId<span class="token punctuation">]</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    <span class="token comment">//10.然后调用hotApply方法进行热更新</span></span>
<span class="line">    <span class="token function">hotApply</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">  <span class="token punctuation">}</span></span>
<span class="line">  <span class="token keyword">function</span> <span class="token function">hotApply</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> moduleId <span class="token keyword">in</span> hotUpdate<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">      <span class="token keyword">let</span> oldModule <span class="token operator">=</span> cache<span class="token punctuation">[</span>moduleId<span class="token punctuation">]</span><span class="token punctuation">;</span></span>
<span class="line">      <span class="token keyword">delete</span> cache<span class="token punctuation">[</span>moduleId<span class="token punctuation">]</span><span class="token punctuation">;</span></span>
<span class="line">      oldModule<span class="token punctuation">.</span>parents <span class="token operator">&amp;&amp;</span></span>
<span class="line">        oldModule<span class="token punctuation">.</span>parents<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">parentModule</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></span>
<span class="line">          parentModule<span class="token punctuation">.</span>hot<span class="token punctuation">.</span>_acceptedDependencies<span class="token punctuation">[</span>moduleId<span class="token punctuation">]</span> <span class="token operator">&amp;&amp;</span></span>
<span class="line">            parentModule<span class="token punctuation">.</span>hot<span class="token punctuation">.</span>_acceptedDependencies<span class="token punctuation">[</span>moduleId<span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">  <span class="token punctuation">}</span></span>
<span class="line">  <span class="token keyword">var</span> modules <span class="token operator">=</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token string-property property">&quot;./src/index.js&quot;</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token parameter">module<span class="token punctuation">,</span> exports<span class="token punctuation">,</span> require</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></span>
<span class="line">      <span class="token keyword">let</span> <span class="token function-variable function">render</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">let</span> title <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;./src/title.js&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        root<span class="token punctuation">.</span>innerText <span class="token operator">=</span> title<span class="token punctuation">;</span></span>
<span class="line">      <span class="token punctuation">}</span><span class="token punctuation">;</span></span>
<span class="line">      <span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">      <span class="token keyword">if</span> <span class="token punctuation">(</span>module<span class="token punctuation">.</span>hot<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        module<span class="token punctuation">.</span>hot<span class="token punctuation">.</span><span class="token function">accept</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">&quot;./src/title.js&quot;</span><span class="token punctuation">]</span><span class="token punctuation">,</span> render<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">      <span class="token punctuation">}</span></span>
<span class="line">    <span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token string-property property">&quot;./src/title.js&quot;</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token parameter">module</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></span>
<span class="line">      module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token string">&quot;title3&quot;</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token string-property property">&quot;./webpack/hot/emitter.js&quot;</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token parameter">module</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></span>
<span class="line">      <span class="token keyword">class</span> <span class="token class-name">EventEmitter</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">          <span class="token keyword">this</span><span class="token punctuation">.</span>events <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">        <span class="token function">on</span><span class="token punctuation">(</span><span class="token parameter">eventName<span class="token punctuation">,</span> fn</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">          <span class="token keyword">this</span><span class="token punctuation">.</span>events<span class="token punctuation">[</span>eventName<span class="token punctuation">]</span> <span class="token operator">=</span> fn<span class="token punctuation">;</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">        <span class="token function">emit</span><span class="token punctuation">(</span><span class="token parameter">eventName<span class="token punctuation">,</span> <span class="token operator">...</span>args</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">          <span class="token keyword">this</span><span class="token punctuation">.</span>events<span class="token punctuation">[</span>eventName<span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token operator">...</span>args<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">      <span class="token punctuation">}</span></span>
<span class="line">      module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">EventEmitter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">  <span class="token punctuation">}</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">  <span class="token keyword">function</span> <span class="token function">hotCreateModule</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">var</span> hot <span class="token operator">=</span> <span class="token punctuation">{</span></span>
<span class="line">      <span class="token literal-property property">_acceptedDependencies</span><span class="token operator">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">      <span class="token function-variable function">accept</span><span class="token operator">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">deps<span class="token punctuation">,</span> callback</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">var</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> deps<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span></span>
<span class="line">          hot<span class="token punctuation">.</span>_acceptedDependencies<span class="token punctuation">[</span>deps<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">]</span> <span class="token operator">=</span> callback<span class="token punctuation">;</span></span>
<span class="line">      <span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">      <span class="token literal-property property">check</span><span class="token operator">:</span> hotCheck<span class="token punctuation">,</span></span>
<span class="line">    <span class="token punctuation">}</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">return</span> hot<span class="token punctuation">;</span></span>
<span class="line">  <span class="token punctuation">}</span></span>
<span class="line">  <span class="token keyword">function</span> <span class="token function">hotCreateRequire</span><span class="token punctuation">(</span><span class="token parameter">parentModuleId</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">var</span> parentModule <span class="token operator">=</span> cache<span class="token punctuation">[</span>parentModuleId<span class="token punctuation">]</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>parentModule<span class="token punctuation">)</span> <span class="token keyword">return</span> require<span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">var</span> <span class="token function-variable function">fn</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">childModuleId</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">      parentModule<span class="token punctuation">.</span>children<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>childModuleId<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">      <span class="token function">require</span><span class="token punctuation">(</span>childModuleId<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">      <span class="token keyword">let</span> childModule <span class="token operator">=</span> cache<span class="token punctuation">[</span>childModuleId<span class="token punctuation">]</span><span class="token punctuation">;</span></span>
<span class="line">      childModule<span class="token punctuation">.</span>parents<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>parentModule<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">      <span class="token keyword">return</span> childModule<span class="token punctuation">.</span>exports<span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">return</span> fn<span class="token punctuation">;</span></span>
<span class="line">  <span class="token punctuation">}</span></span>
<span class="line">  <span class="token keyword">function</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token parameter">moduleId</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">if</span> <span class="token punctuation">(</span>cache<span class="token punctuation">[</span>moduleId<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">      <span class="token keyword">return</span> cache<span class="token punctuation">[</span>moduleId<span class="token punctuation">]</span><span class="token punctuation">.</span>exports<span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    <span class="token keyword">var</span> module <span class="token operator">=</span> <span class="token punctuation">(</span>cache<span class="token punctuation">[</span>moduleId<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span></span>
<span class="line">      <span class="token literal-property property">exports</span><span class="token operator">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">      <span class="token literal-property property">hot</span><span class="token operator">:</span> <span class="token function">hotCreateModule</span><span class="token punctuation">(</span>moduleId<span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line">      <span class="token literal-property property">parents</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span></span>
<span class="line">      <span class="token literal-property property">children</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    modules<span class="token punctuation">[</span>moduleId<span class="token punctuation">]</span><span class="token punctuation">(</span>module<span class="token punctuation">,</span> module<span class="token punctuation">.</span>exports<span class="token punctuation">,</span> <span class="token function">hotCreateRequire</span><span class="token punctuation">(</span>moduleId<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">return</span> module<span class="token punctuation">.</span>exports<span class="token punctuation">;</span></span>
<span class="line">  <span class="token punctuation">}</span></span>
<span class="line">  <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">var</span> hotEmitter <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;./webpack/hot/emitter.js&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">var</span> socket <span class="token operator">=</span> <span class="token function">io</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token comment">//1.客户端会监听到此\`hash\`消息,会保存此hash值</span></span>
<span class="line">    socket<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">&quot;hash&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">hash</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></span>
<span class="line">      currentHash <span class="token operator">=</span> hash<span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    socket<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">&quot;ok&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></span>
<span class="line">      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;ok&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">      <span class="token comment">//2. 客户端收到ok的消息后会执行reloadApp方法进行更新</span></span>
<span class="line">      <span class="token function">reloadApp</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">function</span> <span class="token function">reloadApp</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">      <span class="token comment">//3.在reloadApp中会进行判断，是否支持热更新，如果支持的话发射webpackHotUpdate事件,如果不支持则直接刷新浏览器</span></span>
<span class="line">      hotEmitter<span class="token punctuation">.</span><span class="token function">emit</span><span class="token punctuation">(</span><span class="token string">&quot;webpackHotUpdate&quot;</span><span class="token punctuation">,</span> currentHash<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">  <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">var</span> hotEmitter <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;./webpack/hot/emitter.js&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token comment">//4.监听webpackHotUpdate事件,然后执行hotCheck()方法进行检查</span></span>
<span class="line">    hotEmitter<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">&quot;webpackHotUpdate&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">currentHash</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></span>
<span class="line">      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>lastHash<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        lastHash <span class="token operator">=</span> currentHash<span class="token punctuation">;</span></span>
<span class="line">        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;lastHash=&quot;</span><span class="token punctuation">,</span> lastHash<span class="token punctuation">,</span> <span class="token string">&quot;currentHash=&quot;</span><span class="token punctuation">,</span> currentHash<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">return</span><span class="token punctuation">;</span></span>
<span class="line">      <span class="token punctuation">}</span></span>
<span class="line">      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;lastHash=&quot;</span><span class="token punctuation">,</span> lastHash<span class="token punctuation">,</span> <span class="token string">&quot;currentHash=&quot;</span><span class="token punctuation">,</span> currentHash<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;webpackHotUpdate hotCheck&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">      <span class="token comment">//在check方法里会调用module.hot.check方法</span></span>
<span class="line">      <span class="token comment">//module.hot.check(); hotCheck();</span></span>
<span class="line">    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">  <span class="token keyword">return</span> <span class="token function">hotCreateRequire</span><span class="token punctuation">(</span><span class="token string">&quot;./src/index.js&quot;</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token string">&quot;./src/index.js&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_4-2-startdevserver-js" tabindex="-1"><a class="header-anchor" href="#_4-2-startdevserver-js"><span>4.2 startDevServer.js</span></a></h3><p>startDevServer.js</p><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code class="language-javascript"><span class="line"><span class="token keyword">const</span> webpack <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;webpack&quot;</span><span class="token punctuation">)</span></span>
<span class="line"><span class="token keyword">const</span> Server <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&#39;./webpack-dev-server/lib/Server&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">const</span> config <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;./webpack.config&quot;</span><span class="token punctuation">)</span></span>
<span class="line"><span class="token keyword">function</span> <span class="token function">startDevServer</span><span class="token punctuation">(</span><span class="token parameter">compiler<span class="token punctuation">,</span>options</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">const</span> devServerOptions <span class="token operator">=</span> options<span class="token punctuation">.</span>devServer<span class="token operator">||</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token comment">//3.创建Server服务器</span></span>
<span class="line">    <span class="token keyword">const</span> server <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Server</span><span class="token punctuation">(</span>compiler<span class="token punctuation">,</span> devServerOptions<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">const</span> <span class="token punctuation">{</span>host<span class="token operator">=</span><span class="token string">&#39;localhost&#39;</span><span class="token punctuation">,</span>port<span class="token operator">=</span><span class="token number">8080</span><span class="token punctuation">}</span><span class="token operator">=</span>devServerOptions<span class="token punctuation">;</span></span>
<span class="line">    server<span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span>port<span class="token punctuation">,</span> host<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">err</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></span>
<span class="line">        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">\`</span><span class="token string">Project is running at http://</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">\${</span>host<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">:</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">\${</span>port<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">\`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"><span class="token comment">//1.启动webpack-dev-server服务器</span></span>
<span class="line"><span class="token comment">//2.创建webpack实例</span></span>
<span class="line"><span class="token keyword">const</span> compiler <span class="token operator">=</span> <span class="token function">webpack</span><span class="token punctuation">(</span>config<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token function">startDevServer</span><span class="token punctuation">(</span>compiler<span class="token punctuation">,</span>config<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_4-3-webpack-dev-server-lib-server-js" tabindex="-1"><a class="header-anchor" href="#_4-3-webpack-dev-server-lib-server-js"><span>4.3 webpack-dev-server\\lib\\Server.js</span></a></h3><p>webpack-dev-server\\lib\\Server.js</p><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code class="language-javascript"><span class="line"><span class="token keyword">const</span> express <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;express&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">const</span> updateCompiler <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&#39;./utils/updateCompiler&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">const</span> webpackDevMiddleware <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&#39;../../webpack-dev-middleware&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">const</span> http <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;http&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">const</span> WebsocketServer <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;socket.io&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">class</span> <span class="token class-name">Server</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter">compiler<span class="token punctuation">,</span>devServerOptions</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">this</span><span class="token punctuation">.</span>compiler <span class="token operator">=</span> compiler<span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">this</span><span class="token punctuation">.</span>devServerOptions <span class="token operator">=</span> devServerOptions<span class="token punctuation">;</span></span>
<span class="line">        <span class="token function">updateCompiler</span><span class="token punctuation">(</span>compiler<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">this</span><span class="token punctuation">.</span>sockets <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token comment">//4.添加webpack的done事件回调，在编译完成后会向浏览器发送消息</span></span>
<span class="line">        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">setupHooks</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token comment">//5.创建express应用app</span></span>
<span class="line">        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">setupApp</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token comment">//6.使用监控模式开始启动webpack编译,在 webpack 的 watch 模式下，文件系统中某一个文件发生修改，webpack 监听到文件变化，根据配置文件对模块重新编译打包，并将打包后的代码通过简单的 JavaScript 对象保存在内存中</span></span>
<span class="line">        <span class="token comment">//8.添加webpack-dev-middleware中间件</span></span>
<span class="line">        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">setupDevMiddleware</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token comment">//9.创建http服务器并启动服务</span></span>
<span class="line">        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">createServer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token comment">//10.使用sockjs在浏览器端和服务端之间建立一个 websocket 长连接，将 webpack 编译打包的各个阶段的状态信息告知浏览器端,浏览器端根据这些socket消息进行不同的操作。当然服务端传递的最主要信息还是新模块的hash值，后面的步骤根据这一hash值来进行模块热替换</span></span>
<span class="line">        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">createSocketServer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    <span class="token function">setupDevMiddleware</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>devServerOptions<span class="token punctuation">.</span>contentBase<span class="token punctuation">)</span></span>
<span class="line">            <span class="token keyword">this</span><span class="token punctuation">.</span>app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span>express<span class="token punctuation">.</span><span class="token function">static</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>devServerOptions<span class="token punctuation">.</span>contentBase<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">this</span><span class="token punctuation">.</span>middleware <span class="token operator">=</span> <span class="token function">webpackDevMiddleware</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>compiler<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">this</span><span class="token punctuation">.</span>app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>middleware<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    <span class="token function">setupHooks</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">this</span><span class="token punctuation">.</span>compiler<span class="token punctuation">.</span>hooks<span class="token punctuation">.</span>done<span class="token punctuation">.</span><span class="token function">tap</span><span class="token punctuation">(</span><span class="token string">&#39;webpack-dev-server&#39;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">stats</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></span>
<span class="line">            console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;stats.hash&quot;</span><span class="token punctuation">,</span> stats<span class="token punctuation">.</span>hash<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">            <span class="token keyword">this</span><span class="token punctuation">.</span>sockets<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">socket</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></span>
<span class="line">                socket<span class="token punctuation">.</span><span class="token function">emit</span><span class="token punctuation">(</span><span class="token string">&quot;hash&quot;</span><span class="token punctuation">,</span> stats<span class="token punctuation">.</span>hash<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">                socket<span class="token punctuation">.</span><span class="token function">emit</span><span class="token punctuation">(</span><span class="token string">&quot;ok&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">            <span class="token keyword">this</span><span class="token punctuation">.</span>_stats <span class="token operator">=</span> stats<span class="token punctuation">;</span></span>
<span class="line">        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    <span class="token function">setupApp</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">this</span><span class="token punctuation">.</span>app <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">express</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    <span class="token function">createServer</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">this</span><span class="token punctuation">.</span>server <span class="token operator">=</span> http<span class="token punctuation">.</span><span class="token function">createServer</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>app<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    <span class="token function">createSocketServer</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">const</span> io <span class="token operator">=</span> <span class="token function">WebsocketServer</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>server<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        io<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">&quot;connection&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">socket</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></span>
<span class="line">            console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;client connected&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">            <span class="token keyword">this</span><span class="token punctuation">.</span>sockets<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>socket<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">            socket<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">&quot;disconnect&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></span>
<span class="line">                <span class="token keyword">let</span> index <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>sockets<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span>socket<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">                <span class="token keyword">this</span><span class="token punctuation">.</span>sockets <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>sockets<span class="token punctuation">.</span><span class="token function">splice</span><span class="token punctuation">(</span>index<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">            <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>_stats<span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line">                socket<span class="token punctuation">.</span><span class="token function">emit</span><span class="token punctuation">(</span><span class="token string">&#39;hash&#39;</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_stats<span class="token punctuation">.</span>hash<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">                socket<span class="token punctuation">.</span><span class="token function">emit</span><span class="token punctuation">(</span><span class="token string">&quot;ok&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">            <span class="token punctuation">}</span></span>
<span class="line">        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    <span class="token function">listen</span><span class="token punctuation">(</span>port<span class="token punctuation">,</span> host <span class="token operator">=</span> <span class="token string">&quot;localhost&quot;</span><span class="token punctuation">,</span> <span class="token function-variable function">callback</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">         <span class="token keyword">this</span><span class="token punctuation">.</span>server<span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span>port<span class="token punctuation">,</span> host<span class="token punctuation">,</span> callback<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line">module<span class="token punctuation">.</span>exports <span class="token operator">=</span> Server<span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_4-4-webpack-dev-middleware-index-js" tabindex="-1"><a class="header-anchor" href="#_4-4-webpack-dev-middleware-index-js"><span>4.4 webpack-dev-middleware\\index.js</span></a></h3><p>webpack-dev-middleware\\index.js</p><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code class="language-javascript"><span class="line"><span class="token keyword">const</span> middleware <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;./middleware&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">const</span> MemoryFileSystem <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;memory-fs&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">let</span> memoryFileSystem <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MemoryFileSystem</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">function</span> <span class="token function">webpackDevMiddleware</span><span class="token punctuation">(</span><span class="token parameter">compiler</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    compiler<span class="token punctuation">.</span><span class="token function">watch</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></span>
<span class="line">        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;start watching!&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token comment">//7.设置文件系统为内存文件系统</span></span>
<span class="line">    <span class="token keyword">let</span> fs <span class="token operator">=</span> compiler<span class="token punctuation">.</span>outputFileSystem <span class="token operator">=</span> memoryFileSystem<span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">return</span> <span class="token function">middleware</span><span class="token punctuation">(</span><span class="token punctuation">{</span></span>
<span class="line">        fs<span class="token punctuation">,</span></span>
<span class="line">        <span class="token literal-property property">outputPath</span><span class="token operator">:</span>compiler<span class="token punctuation">.</span>options<span class="token punctuation">.</span>output<span class="token punctuation">.</span>path</span>
<span class="line">    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">module<span class="token punctuation">.</span>exports <span class="token operator">=</span> webpackDevMiddleware<span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div>`,123)])])}const o=s(t,[["render",l]]),u=JSON.parse('{"path":"/strong/103.11.webpack-hmr.html","title":"","lang":"en-US","frontmatter":{},"git":{"updatedTime":1681290319000,"contributors":[{"name":"yutao","username":"yutao","email":"642231346@qq.com","commits":1,"url":"https://github.com/yutao"}],"changelog":[{"hash":"f5ab8c9d34991ec274f7f652439afe5b2afb6147","time":1681290319000,"email":"642231346@qq.com","author":"yutao","message":"modify"}]},"filePathRelative":"strong/103.11.webpack-hmr.md"}');export{o as comp,u as data};
