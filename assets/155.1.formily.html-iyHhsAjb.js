import{_ as s,c as a,a as p,o as e}from"./app-CD1YpnS1.js";const t={};function l(o,n){return e(),a("div",null,[...n[0]||(n[0]=[p(`<h2 id="_1-课程大纲" tabindex="-1"><a class="header-anchor" href="#_1-课程大纲"><span>1 课程大纲</span></a></h2><ul><li>第1次课 formily基础使用</li><li>第2次课 formily进阶使用和表单设计器</li><li>第3次课 formily开发低代码平台</li><li>第4次课 手写实现简版@formily/reactive、@formily/core、@formily/react、@formily/antd</li></ul><h2 id="_2-formily" tabindex="-1"><a class="header-anchor" href="#_2-formily"><span>2.formily</span></a></h2><ul><li><a href="https://formilyjs.org" target="_blank" rel="noopener noreferrer">formily</a>是一款面向中后台复杂场景的数据+协议驱动的表单框架，也是阿里巴巴集团统一表单解决方案,可以完成复杂表单需求，而且提供了表单设计器让我们快速设计表单</li></ul><h3 id="_2-1-核心优势" tabindex="-1"><a class="header-anchor" href="#_2-1-核心优势"><span>2.1 核心优势</span></a></h3><ul><li>高性能 字段数据极多的情况下保持快速响应，可以实现高效联动逻辑</li><li>跨端能力 与框架无关，可以兼容<code>react</code>和<code>vue</code>等框架</li><li>生态完备 支持了业界主流的<code>antd</code>和<code>element</code>等组件库</li><li>协议驱动 可以通过JSON驱动表单渲染，可以成为领域视图模型驱动的低代码渲染引擎</li></ul><h3 id="_2-2-分层架构" tabindex="-1"><a class="header-anchor" href="#_2-2-分层架构"><span>2.2 分层架构</span></a></h3><ul><li><a href="https://core.formilyjs.org/zh-CN" target="_blank" rel="noopener noreferrer">@formily/core</a>负责管理表单的状态、校验和联动等</li><li><a href="https://react.formilyjs.org/zh-CN/guide" target="_blank" rel="noopener noreferrer">@formily/react</a>是UI桥接库，用来接入内核数据实现最终的表单交互效果，不同框架有不同的桥接库</li><li><a href="https://antd.formilyjs.org/zh-CN/components" target="_blank" rel="noopener noreferrer">@formily/antd</a>封装了场景化的组件</li></ul><p><img src="https://static.zhufengpeixun.com/cells_1655566023464.svg" alt="cells"></p><ul><li>这张图主要将 Formily 分为了内核协议层，UI胶水桥接层，扩展组件层，和配置应用层</li><li>内核层是 UI 无关的，它保证了用户管理的逻辑和状态是不耦合任何一个框架</li><li>JSON Schema 独立存在，给 UI 桥接层消费，保证了协议驱动在不同 UI 框架下的绝对一致性，不需要重复实现协议解析逻辑</li><li>扩展组件层，提供一系列表单场景化组件，保证用户开箱即用。无需花大量时间做二次开发</li></ul><h3 id="_2-3-竞品对比" tabindex="-1"><a class="header-anchor" href="#_2-3-竞品对比"><span>2.3 竞品对比</span></a></h3><p><img src="https://static.zhufengpeixun.com/formcompare_1655566386488.png" alt="formcompare"></p><h3 id="_2-4-安装" tabindex="-1"><a class="header-anchor" href="#_2-4-安装"><span>2.4 安装</span></a></h3><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text"><pre><code class="language-text"><span class="line">npm init vite@latest</span>
<span class="line">npm install @formily/reactive @formily/core @formily/reactive-react @formily/react @formily/antd ajv less --save</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_2-5-配置" tabindex="-1"><a class="header-anchor" href="#_2-5-配置"><span>2.5 配置</span></a></h3><ul><li>[jsxRuntime](https://github.com/vitejs/vite/tree/main/packages/plugin-react</li><li>在 <code>less\`</code> 文件中引入 <code>antd</code> 的 <code>less</code> 文件会有一个<code>~</code>前置符，这种写法对于 ESM 构建工具是不兼容的</li><li><code>javascriptEnabled</code>这个参数在less3.0之后是默认为false</li></ul><p>vite.config.ts</p><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text"><pre><code class="language-text"><span class="line">import { defineConfig } from &#39;vite&#39;</span>
<span class="line">import react from &#39;@vitejs/plugin-react&#39;</span>
<span class="line"></span>
<span class="line">// https://vitejs.dev/config/</span>
<span class="line">export default defineConfig({</span>
<span class="line">+ plugins: [react({</span>
<span class="line">+   jsxRuntime: &#39;classic&#39;</span>
<span class="line">+ })],</span>
<span class="line">+ resolve: {</span>
<span class="line">+   alias: [</span>
<span class="line">+     { find: /^~/, replacement: &#39;&#39; }</span>
<span class="line">+   ]</span>
<span class="line">+ },</span>
<span class="line">+ css: {</span>
<span class="line">+   preprocessorOptions: {</span>
<span class="line">+     less: {</span>
<span class="line">+       // 支持内联 JavaScript</span>
<span class="line">+       javascriptEnabled: true,</span>
<span class="line">+     }</span>
<span class="line">+   }</span>
<span class="line">+ }</span>
<span class="line">})</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>tsconfig.json</p><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text"><pre><code class="language-text"><span class="line">{</span>
<span class="line">  &quot;compilerOptions&quot;: {</span>
<span class="line">    &quot;target&quot;: &quot;ESNext&quot;,</span>
<span class="line">    &quot;useDefineForClassFields&quot;: true,</span>
<span class="line">    &quot;lib&quot;: [&quot;DOM&quot;, &quot;DOM.Iterable&quot;, &quot;ESNext&quot;],</span>
<span class="line">    &quot;allowJs&quot;: false,</span>
<span class="line">    &quot;skipLibCheck&quot;: true,</span>
<span class="line">    &quot;esModuleInterop&quot;: false,</span>
<span class="line">    &quot;allowSyntheticDefaultImports&quot;: true,</span>
<span class="line">+   &quot;strict&quot;: false,</span>
<span class="line">+   &quot;noImplicitAny&quot;: false,</span>
<span class="line">    &quot;forceConsistentCasingInFileNames&quot;: true,</span>
<span class="line">    &quot;module&quot;: &quot;ESNext&quot;,</span>
<span class="line">    &quot;moduleResolution&quot;: &quot;Node&quot;,</span>
<span class="line">    &quot;resolveJsonModule&quot;: true,</span>
<span class="line">    &quot;isolatedModules&quot;: true,</span>
<span class="line">    &quot;noEmit&quot;: true,</span>
<span class="line">    &quot;jsx&quot;: &quot;react-jsx&quot;</span>
<span class="line">  },</span>
<span class="line">  &quot;include&quot;: [&quot;src&quot;],</span>
<span class="line">  &quot;references&quot;: [{ &quot;path&quot;: &quot;./tsconfig.node.json&quot; }]</span>
<span class="line">}</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="_3-字段数量多" tabindex="-1"><a class="header-anchor" href="#_3-字段数量多"><span>3. 字段数量多</span></a></h2><h3 id="_3-1-问题" tabindex="-1"><a class="header-anchor" href="#_3-1-问题"><span>3.1 问题</span></a></h3><ul><li>字段数量多，如何让性能不随字段数量增加而变差？</li></ul><h3 id="_3-2-解决方案" tabindex="-1"><a class="header-anchor" href="#_3-2-解决方案"><span>3.2 解决方案</span></a></h3><ul><li>依赖<a href="https://reactive.formilyjs.org/zh-CN" target="_blank" rel="noopener noreferrer">@formily/reactive</a>响应式解决方案，构建响应式表单的领域模型实现精确渲染</li></ul><p><img src="https://static.zhufengpeixun.com/Reaction_1655437930177.png" alt="Reaction"></p><h4 id="_3-2-1-mvvm" tabindex="-1"><a class="header-anchor" href="#_3-2-1-mvvm"><span>3.2.1 MVVM</span></a></h4><ul><li>MVVM（Model–view–viewmodel）是一种 OOP 软件架构模式，它的核心是将我们的应用程序的逻辑与视图做分离，提升代码可维护性与应用健壮性</li><li>View(视图层)负责维护 UI 结构与样式，同时负责与 ViewModel(视图模型)做数据绑定</li><li>这里的数据绑定关系是双向的，也就是，ViewModel(视图模型)的数据发生变化，会触发 View(视图层)的更新，同时视图层的数据变化又会触发 ViewModel(视图模型)的变化,Model 则更偏实际业务数据处理模型</li><li>ViewModel 和 Model 都是充血模型，两者都注入了不同领域的业务逻辑，比如 ViewModel 的业务逻辑更偏视图交互层的领域逻辑，而 Model 的业务逻辑则更偏业务数据的处理逻辑</li><li>Formily 它提供了 <code>View</code> 和 <code>ViewModel</code> 两层能力，<code>View</code> 则是<code>@formily/react</code>，专门用来与<code>@formily/core</code> 做桥接通讯的，所以，<code>@formily/core</code> 的定位就是 <code>ViewModel</code> 层</li></ul><p><img src="https://static.zhufengpeixun.com/MVVM_1655440368376.svg" alt="MVVM"></p><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code class="language-javascript"><span class="line"><span class="token operator">&lt;</span><span class="token operator">!</span><span class="token constant">DOCTYPE</span> html<span class="token operator">&gt;</span></span>
<span class="line"><span class="token operator">&lt;</span>html lang<span class="token operator">=</span><span class="token string">&quot;en&quot;</span><span class="token operator">&gt;</span></span>
<span class="line"><span class="token operator">&lt;</span>head<span class="token operator">&gt;</span></span>
<span class="line">    <span class="token operator">&lt;</span>meta charset<span class="token operator">=</span><span class="token string">&quot;UTF-8&quot;</span><span class="token operator">&gt;</span></span>
<span class="line">    <span class="token operator">&lt;</span>meta http<span class="token operator">-</span>equiv<span class="token operator">=</span><span class="token string">&quot;X-UA-Compatible&quot;</span> content<span class="token operator">=</span><span class="token string">&quot;IE=edge&quot;</span><span class="token operator">&gt;</span></span>
<span class="line">    <span class="token operator">&lt;</span>meta name<span class="token operator">=</span><span class="token string">&quot;viewport&quot;</span> content<span class="token operator">=</span><span class="token string">&quot;width=device-width, initial-scale=1.0&quot;</span><span class="token operator">&gt;</span></span>
<span class="line">    <span class="token operator">&lt;</span>title<span class="token operator">&gt;</span><span class="token constant">MVVM</span><span class="token operator">&lt;</span><span class="token operator">/</span>title<span class="token operator">&gt;</span></span>
<span class="line"><span class="token operator">&lt;</span><span class="token operator">/</span>head<span class="token operator">&gt;</span></span>
<span class="line"><span class="token operator">&lt;</span>body<span class="token operator">&gt;</span></span>
<span class="line">    <span class="token operator">&lt;</span>input id<span class="token operator">=</span><span class="token string">&quot;bookTitle&quot;</span> value<span class="token operator">=</span><span class="token string">&quot;红楼梦&quot;</span><span class="token operator">/</span><span class="token operator">&gt;</span></span>
<span class="line">    <span class="token operator">&lt;</span>script<span class="token operator">&gt;</span></span>
<span class="line">        <span class="token keyword">class</span> <span class="token class-name">Book</span><span class="token punctuation">{</span></span>
<span class="line">            <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter">title</span><span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line">                <span class="token keyword">this</span><span class="token punctuation">.</span>title<span class="token operator">=</span>title<span class="token punctuation">;</span></span>
<span class="line">            <span class="token punctuation">}</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">        <span class="token comment">//Model</span></span>
<span class="line">        <span class="token keyword">let</span> book <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Book</span><span class="token punctuation">(</span><span class="token string">&#39;红楼梦&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token comment">//ViewModel</span></span>
<span class="line">        <span class="token keyword">let</span> viewModel <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token literal-property property">display</span><span class="token operator">:</span><span class="token string">&#39;block&#39;</span><span class="token punctuation">}</span><span class="token punctuation">;</span></span>
<span class="line">        Object<span class="token punctuation">.</span><span class="token function">defineProperty</span><span class="token punctuation">(</span>viewModel<span class="token punctuation">,</span><span class="token string">&#39;title&#39;</span><span class="token punctuation">,</span><span class="token punctuation">{</span></span>
<span class="line">                <span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line">                    <span class="token keyword">return</span> book<span class="token punctuation">.</span>title<span class="token punctuation">;</span></span>
<span class="line">                <span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">                <span class="token function">set</span><span class="token punctuation">(</span>newTitle<span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line">                    bookTitle<span class="token punctuation">.</span>value <span class="token operator">=</span> book<span class="token punctuation">.</span>title <span class="token operator">=</span> newTitle<span class="token punctuation">;</span></span>
<span class="line">                <span class="token punctuation">}</span></span>
<span class="line">        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        Object<span class="token punctuation">.</span><span class="token function">defineProperty</span><span class="token punctuation">(</span>viewModel<span class="token punctuation">,</span><span class="token string">&#39;display&#39;</span><span class="token punctuation">,</span><span class="token punctuation">{</span></span>
<span class="line">                <span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line">                    <span class="token keyword">return</span> bookTitle<span class="token punctuation">.</span>style<span class="token punctuation">.</span>display<span class="token punctuation">;</span></span>
<span class="line">                <span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">                <span class="token function">set</span><span class="token punctuation">(</span>display<span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line">                    bookTitle<span class="token punctuation">.</span>style<span class="token punctuation">.</span>display <span class="token operator">=</span> display<span class="token punctuation">;</span></span>
<span class="line">                <span class="token punctuation">}</span></span>
<span class="line">        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token comment">//View(视图层)负责维护 UI 结构与样式</span></span>
<span class="line">        <span class="token comment">//同时负责与 ViewModel(视图模型)做数据绑定</span></span>
<span class="line">        <span class="token comment">//这里的数据绑定关系是双向的，也就是，ViewModel(视图模型)的数据发生变化，会触发 View(视图层)的更新</span></span>
<span class="line">        viewModel<span class="token punctuation">.</span>title<span class="token operator">=</span><span class="token string">&#39;新红楼梦&#39;</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span></span>
<span class="line">            viewModel<span class="token punctuation">.</span>display<span class="token operator">=</span> <span class="token string">&#39;none&#39;</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token number">3000</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token comment">//同时视图层的数据变化又会触发 ViewModel(视图模型)的变化</span></span>
<span class="line">        bookTitle<span class="token punctuation">.</span><span class="token function-variable function">onchange</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">event</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span></span>
<span class="line">            viewModel<span class="token punctuation">.</span>title <span class="token operator">=</span> event<span class="token punctuation">.</span>target<span class="token punctuation">.</span>value<span class="token punctuation">;</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">    <span class="token operator">&lt;</span><span class="token operator">/</span>script<span class="token operator">&gt;</span></span>
<span class="line"><span class="token operator">&lt;</span><span class="token operator">/</span>body<span class="token operator">&gt;</span></span>
<span class="line"><span class="token operator">&lt;</span><span class="token operator">/</span>html<span class="token operator">&gt;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_3-2-2-observable" tabindex="-1"><a class="header-anchor" href="#_3-2-2-observable"><span>3.2.2 observable</span></a></h4><ul><li><a href="https://reactive.formilyjs.org/zh-CN/api/observable" target="_blank" rel="noopener noreferrer">observable</a>主要用于创建不同响应式行为的 <code>observable</code> 对象</li><li>一个<code>observable</code>对象，字面意思是可订阅对象，我们通过创建一个可订阅对象，在每次操作该对象的属性数据的过程中，会自动通知订阅者</li><li><a href="https://reactive.formilyjs.org/zh-CN" target="_blank" rel="noopener noreferrer">@formily/reactive</a> 创建 <a href="https://reactive.formilyjs.org/zh-CN/api/observable" target="_blank" rel="noopener noreferrer">observable</a> 对象主要是通过 <code>ES Proxy</code> 来创建的，它可以做到完美劫持数据操作</li></ul><h4 id="_3-2-2-reaction" tabindex="-1"><a class="header-anchor" href="#_3-2-2-reaction"><span>3.2.2 Reaction</span></a></h4><ul><li>\`<a href="https://reactive.formilyjs.org/zh-CN/api/reaction" target="_blank" rel="noopener noreferrer">reaction</a>在响应式编程模型中，它就相当于是可订阅对象的订阅者</li><li>它接收一个 <code>tracker</code> 函数，这个函数在执行的时候，如果函数内部有对 <code>observable</code> 对象中的某个属性进行读操作会进行依赖收集，那当前 <code>reaction</code> 就会与该属性进行一个绑定(依赖追踪)，该属性在其它地方发生了写操作，就会触发 <code>tracker</code> 函数重复执行</li><li>从订阅到派发订阅，其实是一个封闭的循环状态机，每次 <code>tracker</code> 函数执行的时候都会重新收集依赖，依赖变化时又会重新触发<code>tracker</code>执行</li></ul><h4 id="_3-2-3-autorun" tabindex="-1"><a class="header-anchor" href="#_3-2-3-autorun"><span>3.2.3 autorun</span></a></h4><ul><li><a href="https://reactive.formilyjs.org/zh-CN/api/autorun" target="_blank" rel="noopener noreferrer">autorun</a>可以创建一个自动执行的响应器</li><li>接收一个 <code>tracker</code> 函数，如果函数内部有消费 <code>observable</code> 数据，数据发生变化时，<code>tracker</code> 函数会重复执行</li></ul><h4 id="_3-2-4-实现observable" tabindex="-1"><a class="header-anchor" href="#_3-2-4-实现observable"><span>3.2.4 实现observable</span></a></h4><h5 id="_3-2-4-1-src-main-tsx" tabindex="-1"><a class="header-anchor" href="#_3-2-4-1-src-main-tsx"><span>3.2.4.1 src\\main.tsx</span></a></h5><p>src\\main.tsx</p><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code class="language-javascript"><span class="line"><span class="token keyword">import</span> <span class="token punctuation">{</span> observable<span class="token punctuation">,</span> autorun <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&#39;./@formily/reactive&#39;</span></span>
<span class="line"><span class="token keyword">const</span> obs <span class="token operator">=</span> <span class="token function">observable</span><span class="token punctuation">(</span><span class="token punctuation">{</span></span>
<span class="line">  <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">&#39;zhu&#39;</span><span class="token punctuation">,</span></span>
<span class="line"><span class="token punctuation">}</span><span class="token punctuation">)</span></span>
<span class="line"><span class="token keyword">const</span> <span class="token function-variable function">tracker</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></span>
<span class="line">  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>obs<span class="token punctuation">.</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"><span class="token function">autorun</span><span class="token punctuation">(</span>tracker<span class="token punctuation">)</span></span>
<span class="line">obs<span class="token punctuation">.</span>name <span class="token operator">=</span> <span class="token string">&#39;feng&#39;</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token doc-comment comment">/**</span>
<span class="line">zhu</span>
<span class="line">feng</span>
<span class="line"> */</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text"><pre><code class="language-text"><span class="line">import { observable, autorun } from &#39;@formily/reactive&#39;</span>
<span class="line">const obs = observable({</span>
<span class="line">  name: &#39;zhu&#39;,</span>
<span class="line">+ age: 12</span>
<span class="line">})</span>
<span class="line">+let counter = 0;</span>
<span class="line">const tracker = () =&gt; {</span>
<span class="line">  console.log(obs.name);</span>
<span class="line">+ if (counter++) {</span>
<span class="line">+   console.log(obs.age);</span>
<span class="line">+ }</span>
<span class="line">}</span>
<span class="line">autorun(tracker)</span>
<span class="line">+obs.age = 13;</span>
<span class="line">obs.name = &#39;feng&#39;;</span>
<span class="line">+obs.age = 14;</span>
<span class="line">/**</span>
<span class="line">tracker第1次执行</span>
<span class="line">zhu</span>
<span class="line">tracker第2次执行</span>
<span class="line">feng</span>
<span class="line">13</span>
<span class="line">tracker第3次执行</span>
<span class="line">feng</span>
<span class="line">14</span>
<span class="line"> */</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h5 id="_3-2-4-2-reactive-index-ts" tabindex="-1"><a class="header-anchor" href="#_3-2-4-2-reactive-index-ts"><span>3.2.4.2 reactive\\index.ts</span></a></h5><p>src\\@formily\\reactive\\index.ts</p><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code class="language-javascript"><span class="line"><span class="token keyword">const</span> RawReactionsMap <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">WeakMap</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line"><span class="token keyword">let</span> currentReaction<span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">observable</span><span class="token punctuation">(</span><span class="token parameter">value</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Proxy</span><span class="token punctuation">(</span>value<span class="token punctuation">,</span> baseHandlers<span class="token punctuation">)</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"><span class="token keyword">export</span> <span class="token keyword">const</span> <span class="token function-variable function">autorun</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">tracker</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">const</span> <span class="token function-variable function">reaction</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></span>
<span class="line">        currentReaction <span class="token operator">=</span> reaction<span class="token punctuation">;</span></span>
<span class="line">        <span class="token function">tracker</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">        currentReaction <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    <span class="token function">reaction</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"><span class="token keyword">const</span> baseHandlers <span class="token operator">=</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token function">get</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> key<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">const</span> result <span class="token operator">=</span> target<span class="token punctuation">[</span>key<span class="token punctuation">]</span></span>
<span class="line">        <span class="token keyword">if</span> <span class="token punctuation">(</span>currentReaction<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token function">addRawReactionsMap</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> key<span class="token punctuation">,</span> currentReaction<span class="token punctuation">)</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">        <span class="token keyword">return</span> result</span>
<span class="line">    <span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token function">set</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> key<span class="token punctuation">,</span> value<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        target<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">=</span> value</span>
<span class="line">        RawReactionsMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>target<span class="token punctuation">)</span><span class="token operator">?.</span><span class="token function">get</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token operator">?.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">reaction</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token function">reaction</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span></span>
<span class="line">        <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"><span class="token keyword">const</span> <span class="token function-variable function">addRawReactionsMap</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">target<span class="token punctuation">,</span> key<span class="token punctuation">,</span> reaction</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">const</span> reactionsMap <span class="token operator">=</span> RawReactionsMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>target<span class="token punctuation">)</span></span>
<span class="line">    <span class="token keyword">if</span> <span class="token punctuation">(</span>reactionsMap<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">const</span> reactions <span class="token operator">=</span> reactionsMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span></span>
<span class="line">        <span class="token keyword">if</span> <span class="token punctuation">(</span>reactions<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">            reactions<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>reaction<span class="token punctuation">)</span></span>
<span class="line">        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span></span>
<span class="line">            reactionsMap<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> <span class="token punctuation">[</span>reaction<span class="token punctuation">]</span><span class="token punctuation">)</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">        <span class="token keyword">return</span> reactionsMap</span>
<span class="line">    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">const</span> reactionsMap <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Map</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">        reactionsMap<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> <span class="token punctuation">[</span>reaction<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        RawReactionsMap<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> reactionsMap<span class="token punctuation">)</span></span>
<span class="line">        <span class="token keyword">return</span> reactionsMap</span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_3-2-5-observer" tabindex="-1"><a class="header-anchor" href="#_3-2-5-observer"><span>3.2.5 Observer</span></a></h4><ul><li><a href="https://reactive.formilyjs.org/zh-CN/api/react/observer" target="_blank" rel="noopener noreferrer">Observer</a>接收一个 <code>Function RenderProps</code>，只要在 <code>Function</code> 内部消费到的任何响应式数据，都会随数据变化而自动重新渲染，也更容易实现局部精确渲染</li></ul><h5 id="_3-2-5-1-src-main-tsx" tabindex="-1"><a class="header-anchor" href="#_3-2-5-1-src-main-tsx"><span>3.2.5.1 src\\main.tsx</span></a></h5><p>src\\main.tsx</p><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code class="language-javascript"><span class="line"><span class="token keyword">import</span> React <span class="token keyword">from</span> <span class="token string">&#39;react&#39;</span></span>
<span class="line"><span class="token keyword">import</span> ReactDOM <span class="token keyword">from</span> <span class="token string">&#39;react-dom&#39;</span></span>
<span class="line"><span class="token keyword">import</span> App <span class="token keyword">from</span> <span class="token string">&#39;./App&#39;</span><span class="token punctuation">;</span></span>
<span class="line">ReactDOM<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span><span class="token operator">&lt;</span>App <span class="token operator">/</span><span class="token operator">&gt;</span><span class="token punctuation">,</span> document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">&#39;root&#39;</span><span class="token punctuation">)</span><span class="token operator">!</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h5 id="_3-2-5-2-src-app-tsx" tabindex="-1"><a class="header-anchor" href="#_3-2-5-2-src-app-tsx"><span>3.2.5.2 src\\App.tsx</span></a></h5><p>src\\App.tsx</p><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code class="language-javascript"><span class="line"><span class="token keyword">import</span> <span class="token punctuation">{</span> observable <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&#39;./@formily/reactive&#39;</span></span>
<span class="line"><span class="token keyword">import</span> <span class="token punctuation">{</span> Observer <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&#39;./@formily/reactive-react&#39;</span></span>
<span class="line"><span class="token keyword">const</span> username <span class="token operator">=</span> <span class="token function">observable</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token literal-property property">value</span><span class="token operator">:</span> <span class="token string">&#39;zhangsan&#39;</span> <span class="token punctuation">}</span><span class="token punctuation">)</span></span>
<span class="line"><span class="token keyword">const</span> age <span class="token operator">=</span> <span class="token function">observable</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token literal-property property">value</span><span class="token operator">:</span> <span class="token number">14</span> <span class="token punctuation">}</span><span class="token punctuation">)</span></span>
<span class="line"><span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></span>
<span class="line">  <span class="token keyword">return</span> <span class="token punctuation">(</span></span>
<span class="line">    <span class="token operator">&lt;</span><span class="token operator">&gt;</span></span>
<span class="line">      <span class="token operator">&lt;</span>Observer<span class="token operator">&gt;</span></span>
<span class="line">        <span class="token punctuation">{</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">(</span></span>
<span class="line">          <span class="token operator">&lt;</span>input</span>
<span class="line">            value<span class="token operator">=</span><span class="token punctuation">{</span>username<span class="token punctuation">.</span>value<span class="token punctuation">}</span></span>
<span class="line">            onChange<span class="token operator">=</span><span class="token punctuation">{</span><span class="token punctuation">(</span><span class="token parameter">event</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></span>
<span class="line">              username<span class="token punctuation">.</span>value <span class="token operator">=</span> event<span class="token punctuation">.</span>target<span class="token punctuation">.</span>value</span>
<span class="line">            <span class="token punctuation">}</span><span class="token punctuation">}</span></span>
<span class="line">          <span class="token operator">/</span><span class="token operator">&gt;</span></span>
<span class="line">        <span class="token punctuation">)</span><span class="token punctuation">}</span></span>
<span class="line">      <span class="token operator">&lt;</span><span class="token operator">/</span>Observer<span class="token operator">&gt;</span></span>
<span class="line">      <span class="token operator">&lt;</span>Observer<span class="token operator">&gt;</span><span class="token punctuation">{</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></span>
<span class="line">        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&#39;username render&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">return</span> <span class="token operator">&lt;</span>div<span class="token operator">&gt;</span><span class="token punctuation">{</span>username<span class="token punctuation">.</span>value<span class="token punctuation">}</span><span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">&gt;</span><span class="token punctuation">;</span></span>
<span class="line">      <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token operator">&lt;</span><span class="token operator">/</span>Observer<span class="token operator">&gt;</span></span>
<span class="line">      <span class="token operator">&lt;</span>Observer<span class="token operator">&gt;</span></span>
<span class="line">        <span class="token punctuation">{</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">(</span></span>
<span class="line">          <span class="token operator">&lt;</span>input</span>
<span class="line">            value<span class="token operator">=</span><span class="token punctuation">{</span>age<span class="token punctuation">.</span>value<span class="token punctuation">}</span></span>
<span class="line">            onChange<span class="token operator">=</span><span class="token punctuation">{</span><span class="token punctuation">(</span><span class="token parameter">event</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></span>
<span class="line">              age<span class="token punctuation">.</span>value <span class="token operator">=</span> <span class="token operator">+</span>event<span class="token punctuation">.</span>target<span class="token punctuation">.</span>value</span>
<span class="line">            <span class="token punctuation">}</span><span class="token punctuation">}</span></span>
<span class="line">          <span class="token operator">/</span><span class="token operator">&gt;</span></span>
<span class="line">        <span class="token punctuation">)</span><span class="token punctuation">}</span></span>
<span class="line">      <span class="token operator">&lt;</span><span class="token operator">/</span>Observer<span class="token operator">&gt;</span></span>
<span class="line">      <span class="token operator">&lt;</span>Observer<span class="token operator">&gt;</span><span class="token punctuation">{</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></span>
<span class="line">        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&#39;age render&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">return</span> <span class="token operator">&lt;</span>div<span class="token operator">&gt;</span><span class="token punctuation">{</span>age<span class="token punctuation">.</span>value<span class="token punctuation">}</span><span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">&gt;</span><span class="token punctuation">;</span></span>
<span class="line">      <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token operator">&lt;</span><span class="token operator">/</span>Observer<span class="token operator">&gt;</span></span>
<span class="line">    <span class="token operator">&lt;</span><span class="token operator">/</span><span class="token operator">&gt;</span></span>
<span class="line">  <span class="token punctuation">)</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h5 id="_3-2-5-3-reactive-react-index-tsx" tabindex="-1"><a class="header-anchor" href="#_3-2-5-3-reactive-react-index-tsx"><span>3.2.5.3 reactive-react\\index.tsx</span></a></h5><p>src\\@formily\\reactive-react\\index.tsx</p><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code class="language-javascript"><span class="line"><span class="token keyword">import</span> React<span class="token punctuation">,</span> <span class="token punctuation">{</span> useReducer <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&#39;react&#39;</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">import</span> <span class="token punctuation">{</span> Tracker <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&#39;../../@formily/reactive&#39;</span></span>
<span class="line"><span class="token keyword">export</span> <span class="token keyword">const</span> <span class="token function-variable function">Observer</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">props</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">const</span> <span class="token punctuation">[</span><span class="token punctuation">,</span> forceUpdate<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">useReducer</span><span class="token punctuation">(</span><span class="token parameter">x</span> <span class="token operator">=&gt;</span> x <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token keyword">const</span> trackerRef <span class="token operator">=</span> React<span class="token punctuation">.</span><span class="token function">useRef</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>trackerRef<span class="token punctuation">.</span>current<span class="token punctuation">)</span></span>
<span class="line">        trackerRef<span class="token punctuation">.</span>current <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Tracker</span><span class="token punctuation">(</span>forceUpdate<span class="token punctuation">)</span></span>
<span class="line">    <span class="token keyword">return</span> trackerRef<span class="token punctuation">.</span>current<span class="token punctuation">.</span><span class="token function">track</span><span class="token punctuation">(</span>props<span class="token punctuation">.</span>children<span class="token punctuation">)</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h5 id="_3-2-5-4-reactive-index-ts" tabindex="-1"><a class="header-anchor" href="#_3-2-5-4-reactive-index-ts"><span>3.2.5.4 reactive\\index.ts</span></a></h5><p>src\\@formily\\reactive\\index.ts</p><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text"><pre><code class="language-text"><span class="line">const RawReactionsMap = new WeakMap()</span>
<span class="line">let currentReaction;</span>
<span class="line">export function observable(value) {</span>
<span class="line">    return new Proxy(value, baseHandlers)</span>
<span class="line">}</span>
<span class="line">export const autorun = (tracker) =&gt; {</span>
<span class="line">    const reaction = () =&gt; {</span>
<span class="line">        currentReaction = reaction;</span>
<span class="line">        tracker()</span>
<span class="line">        currentReaction = null;</span>
<span class="line">    }</span>
<span class="line">    reaction()</span>
<span class="line">}</span>
<span class="line">const baseHandlers = {</span>
<span class="line">    get(target, key) {</span>
<span class="line">        const result = target[key]</span>
<span class="line">        if (currentReaction) {</span>
<span class="line">            addRawReactionsMap(target, key, currentReaction)</span>
<span class="line">        }</span>
<span class="line">        return result</span>
<span class="line">    },</span>
<span class="line">    set(target, key, value) {</span>
<span class="line">        target[key] = value</span>
<span class="line">        RawReactionsMap.get(target)?.get(key)?.forEach((reaction) =&gt; {</span>
<span class="line">+           if (typeof reaction._scheduler === &#39;function&#39;) {</span>
<span class="line">+               reaction._scheduler()</span>
<span class="line">+           } else {</span>
<span class="line">+               reaction()</span>
<span class="line">+           }</span>
<span class="line">        })</span>
<span class="line">        return true;</span>
<span class="line">    }</span>
<span class="line">}</span>
<span class="line">const addRawReactionsMap = (target, key, reaction) =&gt; {</span>
<span class="line">    const reactionsMap = RawReactionsMap.get(target)</span>
<span class="line">    if (reactionsMap) {</span>
<span class="line">        const reactions = reactionsMap.get(key)</span>
<span class="line">        if (reactions) {</span>
<span class="line">            reactions.push(reaction)</span>
<span class="line">        } else {</span>
<span class="line">            reactionsMap.set(key, [reaction])</span>
<span class="line">        }</span>
<span class="line">        return reactionsMap</span>
<span class="line">    } else {</span>
<span class="line">        const reactionsMap = new Map()</span>
<span class="line">        reactionsMap.set(key, [reaction]);</span>
<span class="line">        RawReactionsMap.set(target, reactionsMap)</span>
<span class="line">        return reactionsMap</span>
<span class="line">    }</span>
<span class="line">}</span>
<span class="line"></span>
<span class="line">+export class Tracker {</span>
<span class="line">+    constructor(scheduler) {</span>
<span class="line">+        this.track._scheduler = scheduler</span>
<span class="line">+    }</span>
<span class="line">+    track: any = (tracker) =&gt; {</span>
<span class="line">+        currentReaction = this.track;</span>
<span class="line">+        return tracker()</span>
<span class="line">+    }</span>
<span class="line">+}</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="_4-字段关联逻辑复杂" tabindex="-1"><a class="header-anchor" href="#_4-字段关联逻辑复杂"><span>4. 字段关联逻辑复杂</span></a></h2><h3 id="_4-1-问题" tabindex="-1"><a class="header-anchor" href="#_4-1-问题"><span>4.1 问题</span></a></h3><ul><li>字段关联逻辑复杂，如何更简单的实现复杂的联动逻辑？字段与字段关联时，如何保证不影响表单性能？ <ul><li>一对多(异步)</li><li>多对一(异步)</li><li>多对多(异步)</li></ul></li></ul><h3 id="_4-2-领域模型" tabindex="-1"><a class="header-anchor" href="#_4-2-领域模型"><span>4.2 领域模型</span></a></h3><ul><li>字段值的改变和应用状态、服务器返回数据等都可能会引发字段的联动</li><li>联动关系核心是将字段的某些状态属性与某些数据关联起来</li><li>可以定义针对表单领域的<code>领域模型</code></li><li><a href="https://core.formilyjs.org/zh-CN/api/models/form" target="_blank" rel="noopener noreferrer">Form</a>是调用<code>createForm</code>所返回的核心表单模型</li><li><a href="https://core.formilyjs.org/zh-CN/api/models/field" target="_blank" rel="noopener noreferrer">Field</a>是调用<code>createField</code>所返回的字段模型</li><li><a href="https://core.formilyjs.org/zh-CN/api/entry/create-form" target="_blank" rel="noopener noreferrer">createForm</a>用来创建表单核心领域模型，它是作为MVVM设计模式的标准 <code>ViewModel</code></li></ul><p><img src="https://static.zhufengpeixun.com/fields_1655444784309.svg" alt="fields"></p><p>src\\main.tsx</p><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code class="language-javascript"><span class="line"><span class="token keyword">import</span> <span class="token punctuation">{</span> createForm <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&#39;@formily/core&#39;</span></span>
<span class="line"><span class="token keyword">const</span> form <span class="token operator">=</span> <span class="token function">createForm</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line"><span class="token keyword">const</span> field <span class="token operator">=</span> form<span class="token punctuation">.</span><span class="token function">createField</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">&#39;target&#39;</span> <span class="token punctuation">}</span><span class="token punctuation">)</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_4-3-ddd-领域驱动" tabindex="-1"><a class="header-anchor" href="#_4-3-ddd-领域驱动"><span>4.3 DDD(领域驱动)</span></a></h3><ul><li>DDD(Domain-Driven Design)即领域驱动设计是思考问题的方法论,用于对实际问题建模</li><li>它以一种领域专家、设计人员、开发人员都能理解的通用语言作为相互交流的工具，然后将这些概念设计成一个领域模型。由领域模型驱动软件设计，用代码来实现该领域模型</li></ul><h4 id="_4-3-1-表单" tabindex="-1"><a class="header-anchor" href="#_4-3-1-表单"><span>4.3.1 表单</span></a></h4><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code class="language-javascript"><span class="line"><span class="token keyword">interface</span> <span class="token class-name">Form</span> <span class="token punctuation">{</span></span>
<span class="line">   values<span class="token punctuation">,</span><span class="token comment">//值</span></span>
<span class="line">   visible<span class="token punctuation">,</span> <span class="token comment">//是否可见</span></span>
<span class="line">   <span class="token function">submit</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">//提交</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_4-3-2-字段" tabindex="-1"><a class="header-anchor" href="#_4-3-2-字段"><span>4.3.2 字段</span></a></h4><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code class="language-javascript"><span class="line"><span class="token keyword">interface</span> <span class="token class-name">Field</span> <span class="token punctuation">{</span></span>
<span class="line">   value<span class="token punctuation">,</span>     <span class="token comment">//值</span></span>
<span class="line">   visible<span class="token punctuation">,</span>   <span class="token comment">//是否可见</span></span>
<span class="line">   <span class="token function">setValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">//设置值</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_4-4-路径系统" tabindex="-1"><a class="header-anchor" href="#_4-4-路径系统"><span>4.4 路径系统</span></a></h3><ul><li>表单模型作为顶层模型管理着所有字段模型，每个字段都有着自己的路径</li><li>如何优雅的查找某个字段?</li><li>Formily 独创的路径系统<a href="https://core.formilyjs.org/zh-CN/api/entry/form-path" target="_blank" rel="noopener noreferrer">@formily/path</a>让字段查找变得优雅</li><li><code>FormPath</code> 在 Formily 中核心是解决路径匹配问题和数据操作问题</li></ul><p>src\\main.tsx</p><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code class="language-javascript"><span class="line"><span class="token keyword">import</span> <span class="token punctuation">{</span> FormPath <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&#39;@formily/core&#39;</span></span>
<span class="line"><span class="token keyword">const</span> target <span class="token operator">=</span> <span class="token punctuation">{</span> <span class="token literal-property property">array</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token punctuation">}</span></span>
<span class="line"><span class="token comment">//点路径 就是我们最常用的a.b.c格式，用点符号来分割每个路径节点，主要用来读写数据</span></span>
<span class="line">FormPath<span class="token punctuation">.</span><span class="token function">setIn</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> <span class="token string">&#39;a.b.c&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;dotValue&#39;</span><span class="token punctuation">)</span></span>
<span class="line">console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>FormPath<span class="token punctuation">.</span><span class="token function">getIn</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> <span class="token string">&#39;a.b.c&#39;</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">//&#39;dotValue&#39;</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">//下标路径 对于数组路径，都会有下标，我们的下标可以用点语法，也可以用中括号</span></span>
<span class="line">FormPath<span class="token punctuation">.</span><span class="token function">setIn</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> <span class="token string">&#39;array.0.d&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;arrayValue&#39;</span><span class="token punctuation">)</span></span>
<span class="line">console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>FormPath<span class="token punctuation">.</span><span class="token function">getIn</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> <span class="token string">&#39;array.0.d&#39;</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">//arrayValue</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">//解构表达式 解构表达式类似于 ES6 的解构语法,在前后端数据不一致的场景非常适用,解构表达式会作为点路径的某个节点</span></span>
<span class="line">FormPath<span class="token punctuation">.</span><span class="token function">setIn</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> <span class="token string">&#39;parent.[f,g]&#39;</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span></span>
<span class="line"></span>
<span class="line">console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>target<span class="token punctuation">)</span><span class="token punctuation">)</span></span>
<span class="line"><span class="token comment">//{&quot;array&quot;:[{&quot;d&quot;:&quot;arrayValue&quot;}],&quot;a&quot;:{&quot;b&quot;:{&quot;c&quot;:&quot;dotValue&quot;}},&quot;parent&quot;:{&quot;f&quot;:1,&quot;g&quot;:2}}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="_5-生命周期" tabindex="-1"><a class="header-anchor" href="#_5-生命周期"><span>5. 生命周期</span></a></h2><h3 id="_5-1-问题" tabindex="-1"><a class="header-anchor" href="#_5-1-问题"><span>5.1 问题</span></a></h3><ul><li>响应式和路径系统组成一个较为完备的表单方案,但是一个黑盒</li><li>想要在某个过程阶段内实现一些自定义逻辑如何实现?</li></ul><h3 id="_5-2-解决方案" tabindex="-1"><a class="header-anchor" href="#_5-2-解决方案"><span>5.2 解决方案</span></a></h3><ul><li><a href="https://core.formilyjs.org/zh-CN/api/entry/form-effect-hooks" target="_blank" rel="noopener noreferrer">Form Effect Hooks</a>可以将整个表单生命周期作为事件钩子暴露给外界，这样就能做到了既有抽象，但又灵活的表单方案</li><li>[onFormInit](https://core.formilyjs.org/zh-CN/api/entry/form-effect-hooks</li><li>[onFormReact](https://core.formilyjs.org/zh-CN/api/entry/form-effect-hooks</li></ul><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code class="language-javascript"><span class="line"><span class="token keyword">import</span> <span class="token punctuation">{</span> useMemo<span class="token punctuation">,</span> useState <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&#39;react&#39;</span></span>
<span class="line"><span class="token keyword">import</span> <span class="token punctuation">{</span> createForm<span class="token punctuation">,</span> onFormInit<span class="token punctuation">,</span> onFormReact <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&#39;@formily/core&#39;</span></span>
<span class="line"><span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></span>
<span class="line">  <span class="token keyword">const</span> <span class="token punctuation">[</span>state<span class="token punctuation">,</span> setState<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">useState</span><span class="token punctuation">(</span><span class="token string">&#39;init&#39;</span><span class="token punctuation">)</span></span>
<span class="line">  <span class="token keyword">const</span> form <span class="token operator">=</span> <span class="token function">useMemo</span><span class="token punctuation">(</span></span>
<span class="line">    <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span></span>
<span class="line">      <span class="token function">createForm</span><span class="token punctuation">(</span><span class="token punctuation">{</span></span>
<span class="line">        <span class="token function">effects</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">          <span class="token function">onFormInit</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token function">setState</span><span class="token punctuation">(</span><span class="token string">&#39;表单已初始化&#39;</span><span class="token punctuation">)</span></span>
<span class="line">          <span class="token punctuation">}</span><span class="token punctuation">)</span></span>
<span class="line">          <span class="token function">onFormReact</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">form</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token keyword">if</span> <span class="token punctuation">(</span>form<span class="token punctuation">.</span>values<span class="token punctuation">.</span>input <span class="token operator">==</span> <span class="token string">&#39;Hello&#39;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">              <span class="token function">setState</span><span class="token punctuation">(</span><span class="token string">&#39;响应Hello&#39;</span><span class="token punctuation">)</span></span>
<span class="line">            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>form<span class="token punctuation">.</span>values<span class="token punctuation">.</span>input <span class="token operator">==</span> <span class="token string">&#39;World&#39;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">              <span class="token function">setState</span><span class="token punctuation">(</span><span class="token string">&#39;响应World&#39;</span><span class="token punctuation">)</span></span>
<span class="line">            <span class="token punctuation">}</span></span>
<span class="line">          <span class="token punctuation">}</span><span class="token punctuation">)</span></span>
<span class="line">        <span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line"></span>
<span class="line">      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token punctuation">[</span><span class="token punctuation">]</span></span>
<span class="line">  <span class="token punctuation">)</span></span>
<span class="line">  <span class="token keyword">return</span> <span class="token punctuation">(</span></span>
<span class="line">    <span class="token operator">&lt;</span>div<span class="token operator">&gt;</span></span>
<span class="line">      <span class="token operator">&lt;</span>p<span class="token operator">&gt;</span><span class="token punctuation">{</span>state<span class="token punctuation">}</span><span class="token operator">&lt;</span><span class="token operator">/</span>p<span class="token operator">&gt;</span></span>
<span class="line">      <span class="token operator">&lt;</span>button</span>
<span class="line">        onClick<span class="token operator">=</span><span class="token punctuation">{</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></span>
<span class="line">          form<span class="token punctuation">.</span><span class="token function">setValuesIn</span><span class="token punctuation">(</span><span class="token string">&#39;input&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;Hello&#39;</span><span class="token punctuation">)</span></span>
<span class="line">        <span class="token punctuation">}</span><span class="token punctuation">}</span></span>
<span class="line">      <span class="token operator">&gt;</span></span>
<span class="line">        Hello</span>
<span class="line">      <span class="token operator">&lt;</span><span class="token operator">/</span>button<span class="token operator">&gt;</span></span>
<span class="line">      <span class="token operator">&lt;</span>button</span>
<span class="line">        onClick<span class="token operator">=</span><span class="token punctuation">{</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></span>
<span class="line">          form<span class="token punctuation">.</span><span class="token function">setValuesIn</span><span class="token punctuation">(</span><span class="token string">&#39;input&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;World&#39;</span><span class="token punctuation">)</span></span>
<span class="line">        <span class="token punctuation">}</span><span class="token punctuation">}</span></span>
<span class="line">      <span class="token operator">&gt;</span></span>
<span class="line">        World</span>
<span class="line">      <span class="token operator">&lt;</span><span class="token operator">/</span>button<span class="token operator">&gt;</span></span>
<span class="line">    <span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">&gt;</span></span>
<span class="line">  <span class="token punctuation">)</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="_6-协议驱动" tabindex="-1"><a class="header-anchor" href="#_6-协议驱动"><span>6 协议驱动</span></a></h2><h3 id="_6-1-问题" tabindex="-1"><a class="header-anchor" href="#_6-1-问题"><span>6.1 问题</span></a></h3><ul><li>动态渲染述求很强烈 <ul><li>字段配置化，让非专业前端也能快速搭建复杂表单</li><li>跨端渲染，一份 JSON Schema，多端适配</li><li>如何在表单协议中描述布局？ <ul><li>纵向布局</li><li>横向布局</li><li>网格布局</li><li>弹性布局</li><li>自由布局</li></ul></li><li>如何在表单协议中描述逻辑？</li></ul></li></ul><h3 id="_6-2-解决方案" tabindex="-1"><a class="header-anchor" href="#_6-2-解决方案"><span>6.2 解决方案</span></a></h3><ul><li>表单场景的数据协议最流行就是<a href="https://json-schema.org/" target="_blank" rel="noopener noreferrer">JSON-Schema</a></li><li>定义一套通用协议，简单高效的描述表单逻辑，适合开发低代码</li></ul><h3 id="_6-3-json-schema" tabindex="-1"><a class="header-anchor" href="#_6-3-json-schema"><span>6.3 JSON-Schema</span></a></h3><ul><li><a href="https://json-schema.org" target="_blank" rel="noopener noreferrer">JSON-Schema</a>以数据描述视角驱动UI渲染，不好描述UI</li><li><a href="https://ajv.js.org" target="_blank" rel="noopener noreferrer">ajv</a>是一个JSON Schema验证器 -</li></ul><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code class="language-javascript"><span class="line"><span class="token keyword">import</span> Ajv <span class="token keyword">from</span> <span class="token string">&#39;ajv&#39;</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">const</span> ajv <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Ajv</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">const</span> schema <span class="token operator">=</span> <span class="token punctuation">{</span></span>
<span class="line">  <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token string">&quot;object&quot;</span><span class="token punctuation">,</span></span>
<span class="line">  <span class="token literal-property property">properties</span><span class="token operator">:</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token literal-property property">foo</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token string">&quot;integer&quot;</span> <span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token literal-property property">bar</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token string">&quot;string&quot;</span> <span class="token punctuation">}</span></span>
<span class="line">  <span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">  <span class="token literal-property property">required</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">&quot;foo&quot;</span><span class="token punctuation">]</span><span class="token punctuation">,</span></span>
<span class="line">  <span class="token literal-property property">additionalProperties</span><span class="token operator">:</span> <span class="token boolean">false</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">const</span> validate <span class="token operator">=</span> ajv<span class="token punctuation">.</span><span class="token function">compile</span><span class="token punctuation">(</span>schema<span class="token punctuation">)</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">const</span> data <span class="token operator">=</span> <span class="token punctuation">{</span></span>
<span class="line">  <span class="token literal-property property">foo</span><span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span></span>
<span class="line">  <span class="token literal-property property">bar</span><span class="token operator">:</span> <span class="token string">&quot;abc&quot;</span><span class="token punctuation">,</span></span>
<span class="line">  <span class="token literal-property property">age</span><span class="token operator">:</span> <span class="token number">1</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">const</span> valid <span class="token operator">=</span> <span class="token function">validate</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span></span>
<span class="line"><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>valid<span class="token punctuation">)</span></span>
<span class="line">  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>validate<span class="token punctuation">.</span>errors<span class="token punctuation">)</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_6-4-扩展的json-schema" tabindex="-1"><a class="header-anchor" href="#_6-4-扩展的json-schema"><span>6.4 扩展的JSON-Schema</span></a></h3><ul><li><code>Formily</code>扩展了<code>JSON-Schema</code> 属性，统一以<code>x-*</code>格式来表达扩展属性以描述数据无关的布局容器和控件，实现UI协议与数据协议混合在一起</li><li>JSON Schema 引入 <code>void</code>，代表一个虚数据节点，表示该节点并不占用实际数据结构</li><li>DSL(领域特定语言)(Domain Specific Language)是针对某一领域，具有受限表达性的一种计算机程序设计语言</li></ul><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code class="language-javascript"><span class="line"><span class="token punctuation">{</span></span>
<span class="line">  <span class="token string-property property">&quot;type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;string&quot;</span><span class="token punctuation">,</span></span>
<span class="line">  <span class="token string-property property">&quot;title&quot;</span><span class="token operator">:</span> <span class="token string">&quot;字符串&quot;</span><span class="token punctuation">,</span></span>
<span class="line">  <span class="token string-property property">&quot;description&quot;</span><span class="token operator">:</span> <span class="token string">&quot;这是一个字符串&quot;</span><span class="token punctuation">,</span></span>
<span class="line">  <span class="token string-property property">&quot;x-component&quot;</span><span class="token operator">:</span> <span class="token string">&quot;Input&quot;</span><span class="token punctuation">,</span><span class="token comment">//字段 UI 组件属性</span></span>
<span class="line">  <span class="token string-property property">&quot;x-component-props&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span><span class="token comment">//字段 UI 组件属性</span></span>
<span class="line">    <span class="token string-property property">&quot;placeholder&quot;</span><span class="token operator">:</span> <span class="token string">&quot;请输入&quot;</span></span>
<span class="line">  <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code class="language-javascript"><span class="line"><span class="token punctuation">{</span></span>
<span class="line">  <span class="token string-property property">&quot;type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;void&quot;</span><span class="token punctuation">,</span></span>
<span class="line">  <span class="token string-property property">&quot;title&quot;</span><span class="token operator">:</span> <span class="token string">&quot;卡片&quot;</span><span class="token punctuation">,</span></span>
<span class="line">  <span class="token string-property property">&quot;description&quot;</span><span class="token operator">:</span> <span class="token string">&quot;这是一个卡片&quot;</span><span class="token punctuation">,</span></span>
<span class="line">  <span class="token string-property property">&quot;x-component&quot;</span><span class="token operator">:</span> <span class="token string">&quot;Card&quot;</span><span class="token punctuation">,</span><span class="token comment">//字段 UI 组件属性</span></span>
<span class="line">  <span class="token string-property property">&quot;properties&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token string-property property">&quot;name&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span></span>
<span class="line">      <span class="token string-property property">&quot;type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;string&quot;</span><span class="token punctuation">,</span></span>
<span class="line">      <span class="token string-property property">&quot;title&quot;</span><span class="token operator">:</span> <span class="token string">&quot;字符串&quot;</span><span class="token punctuation">,</span></span>
<span class="line">      <span class="token string-property property">&quot;description&quot;</span><span class="token operator">:</span> <span class="token string">&quot;这是一个字符串&quot;</span><span class="token punctuation">,</span></span>
<span class="line">      <span class="token string-property property">&quot;x-component&quot;</span><span class="token operator">:</span> <span class="token string">&quot;Input&quot;</span><span class="token punctuation">,</span><span class="token comment">//字段 UI 组件属性</span></span>
<span class="line">      <span class="token string-property property">&quot;x-component-props&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span><span class="token comment">//字段 UI 组件属性</span></span>
<span class="line">        <span class="token string-property property">&quot;placeholder&quot;</span><span class="token operator">:</span> <span class="token string">&quot;请输入&quot;</span></span>
<span class="line">      <span class="token punctuation">}</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">  <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_6-5-api" tabindex="-1"><a class="header-anchor" href="#_6-5-api"><span>6.5 API</span></a></h3><ul><li><a href="https://core.formilyjs.org/zh-CN/api/entry/create-form" target="_blank" rel="noopener noreferrer">createForm</a>创建一个 Form 实例，作为 ViewModel 给 UI 框架层消费 <ul><li>effects 副作用逻辑，用于实现各种联动逻辑</li><li>[onFieldMount](https://core.formilyjs.org/zh-CN/api/entry/field-effect-hooks</li><li>[onFieldValueChange](https://core.formilyjs.org/zh-CN/api/entry/field-effect-hooks</li><li>[setFieldState](https://core.formilyjs.org/zh-CN/api/models/form</li></ul></li><li><a href="https://core.formilyjs.org/zh-CN/api/models/field" target="_blank" rel="noopener noreferrer">core/Field</a>组件是用来承接普通字段的组件</li><li><a href="https://react.formilyjs.org/zh-CN/api/components/field" target="_blank" rel="noopener noreferrer">react/Field</a>作为<code>@formily/core</code> 的 <code>createField</code> React 实现，它是专门用于将 <code>ViewModel</code> 与输入控件做绑定的桥接组件 <ul><li>[title](https://core.formilyjs.org/zh-CN/api/models/field</li><li>[required](https://core.formilyjs.org/zh-CN/api/models/field</li><li>[component](https://core.formilyjs.org/zh-CN/api/models/field</li><li>[decorator](https://core.formilyjs.org/zh-CN/api/models/field</li></ul></li><li><code>SchemaField</code>组件是专门用于解析<code>JSON-Schema</code>动态渲染表单的组件。 在使用<code>SchemaField</code>组件的时候，需要通过 <a href="https://react.formilyjs.org/zh-CN/api/components/schema-field" target="_blank" rel="noopener noreferrer">createSchemaField</a> 工厂函数创建一个 <code>SchemaField\`</code> 组件</li><li><a href="https://react.formilyjs.org/zh-CN/api/shared/schema" target="_blank" rel="noopener noreferrer">Schema</a>是<code>@formily/react</code>协议驱动最核心的部分 <ul><li>解析 <code>json-schema</code> 的能力</li><li>将 <code>json-schema</code> 转换成 <code>Field Model</code> 的能力</li><li>编译 <code>json-schema</code> 表达式的能力</li><li><code>x-component</code> 的组件标识与<code>createSchemaField</code>传入的组件集合的 <code>Key</code> 匹配</li><li><code>x-decorator</code> 的组件标识与<code>createSchemaField</code>传入的组件集合的 <code>Key</code> 匹配</li><li><code>Schema</code> 的每个属性都能使用字符串表达式<code>{{expression}}</code>，表达式变量可以从 <code>createSchemaField</code> 中传入，也可以从 <code>SchemaField</code> 组件中传入</li></ul></li><li><a href="https://react.formilyjs.org/zh-CN/api/shared/schema" target="_blank" rel="noopener noreferrer">Schema</a>属性 <ul><li><a href="https://react.formilyjs.org/zh-CN/api/shared/schema" target="_blank" rel="noopener noreferrer">type</a>类型</li><li><a href="https://react.formilyjs.org/zh-CN/api/shared/schema" target="_blank" rel="noopener noreferrer">properties</a>属性描述</li><li><a href="https://react.formilyjs.org/zh-CN/api/shared/schema" target="_blank" rel="noopener noreferrer">title</a>标题</li><li><a href="https://react.formilyjs.org/zh-CN/api/shared/schema" target="_blank" rel="noopener noreferrer">required</a>必填</li><li><a href="https://react.formilyjs.org/zh-CN/api/shared/schema" target="_blank" rel="noopener noreferrer">x-decorator</a>字段 UI 包装器组件</li><li><a href="https://react.formilyjs.org/zh-CN/api/shared/schema" target="_blank" rel="noopener noreferrer">x-component</a>字段 UI 组件属性</li><li><a href="https://react.formilyjs.org/zh-CN/api/shared/schema" target="_blank" rel="noopener noreferrer">x-component-props</a>字段 UI 组件属性</li><li>[x-reactions](https://react.formilyjs.org/zh-CN/api/shared/schema</li><li>[$deps](https://react.formilyjs.org/zh-CN/api/shared/schema</li><li>[$self](https://react.formilyjs.org/zh-CN/api/shared/schema</li></ul></li></ul><h3 id="_6-5-表单渲染" tabindex="-1"><a class="header-anchor" href="#_6-5-表单渲染"><span>6.5 表单渲染</span></a></h3><ul><li>Formily 的表单校验使用了极其强大且灵活的[FieldValidator](https://core.formilyjs.org/zh-CN/api/models/field</li><li>纯 <code>JSX</code> 场景校验属性，使用 <code>validator</code> 属性实现校验</li><li><code>Markup(JSON) Schema</code>场景协议校验属性校验，使用 <code>JSON Schema</code> 本身的校验属性与 <code>x-validator</code> 属性实现校验</li></ul><h4 id="_6-5-1-jsx-案例" tabindex="-1"><a class="header-anchor" href="#_6-5-1-jsx-案例"><span>6.5.1 JSX 案例</span></a></h4><p>src\\App.tsx</p><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code class="language-javascript"><span class="line"><span class="token keyword">import</span> <span class="token punctuation">{</span> createForm <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&#39;@formily/core&#39;</span></span>
<span class="line"><span class="token keyword">import</span> <span class="token punctuation">{</span> Field <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&#39;@formily/react&#39;</span></span>
<span class="line"><span class="token keyword">import</span> <span class="token string">&#39;antd/dist/antd.css&#39;</span></span>
<span class="line"><span class="token keyword">import</span> <span class="token punctuation">{</span> Form<span class="token punctuation">,</span> FormItem<span class="token punctuation">,</span> Input<span class="token punctuation">,</span> NumberPicker <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&#39;@formily/antd&#39;</span></span>
<span class="line"><span class="token comment">//createForm创建一个 Form 实例，作为 ViewModel 给 UI 框架层消费</span></span>
<span class="line"><span class="token keyword">const</span> form <span class="token operator">=</span> <span class="token function">createForm</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line"><span class="token keyword">function</span> <span class="token function">App</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">  <span class="token keyword">return</span> <span class="token punctuation">(</span></span>
<span class="line">    <span class="token operator">&lt;</span>Form form<span class="token operator">=</span><span class="token punctuation">{</span>form<span class="token punctuation">}</span> labelCol<span class="token operator">=</span><span class="token punctuation">{</span><span class="token number">6</span><span class="token punctuation">}</span> wrapperCol<span class="token operator">=</span><span class="token punctuation">{</span><span class="token number">10</span><span class="token punctuation">}</span><span class="token operator">&gt;</span></span>
<span class="line">      <span class="token operator">&lt;</span>Field</span>
<span class="line">        name<span class="token operator">=</span><span class="token string">&quot;name&quot;</span></span>
<span class="line">        title<span class="token operator">=</span><span class="token string">&quot;姓名&quot;</span></span>
<span class="line">        required</span>
<span class="line">        component<span class="token operator">=</span><span class="token punctuation">{</span><span class="token punctuation">[</span>Input<span class="token punctuation">]</span><span class="token punctuation">}</span></span>
<span class="line">        decorator<span class="token operator">=</span><span class="token punctuation">{</span><span class="token punctuation">[</span>FormItem<span class="token punctuation">]</span><span class="token punctuation">}</span></span>
<span class="line">      <span class="token operator">/</span><span class="token operator">&gt;</span></span>
<span class="line">      <span class="token operator">&lt;</span>Field</span>
<span class="line">        name<span class="token operator">=</span><span class="token string">&quot;age&quot;</span></span>
<span class="line">        title<span class="token operator">=</span><span class="token string">&quot;年龄&quot;</span></span>
<span class="line">        validator<span class="token operator">=</span><span class="token punctuation">{</span><span class="token punctuation">{</span> <span class="token literal-property property">maximum</span><span class="token operator">:</span> <span class="token number">5</span> <span class="token punctuation">}</span><span class="token punctuation">}</span></span>
<span class="line">        component<span class="token operator">=</span><span class="token punctuation">{</span><span class="token punctuation">[</span>NumberPicker<span class="token punctuation">]</span><span class="token punctuation">}</span></span>
<span class="line">        decorator<span class="token operator">=</span><span class="token punctuation">{</span><span class="token punctuation">[</span>FormItem<span class="token punctuation">]</span><span class="token punctuation">}</span></span>
<span class="line">      <span class="token operator">/</span><span class="token operator">&gt;</span></span>
<span class="line">    <span class="token operator">&lt;</span><span class="token operator">/</span>Form<span class="token operator">&gt;</span></span>
<span class="line">  <span class="token punctuation">)</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"><span class="token keyword">export</span> <span class="token keyword">default</span> App<span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_6-5-2-json-schema案例" tabindex="-1"><a class="header-anchor" href="#_6-5-2-json-schema案例"><span>6.5.2 JSON Schema案例</span></a></h4><ul><li><a href="https://react.formilyjs.org/zh-CN/api/shared/schema" target="_blank" rel="noopener noreferrer">schema</a>是<code>@formily/react</code>协议驱动最核心的部分 <ul><li>解析 <code>json-schema</code> 的能力</li><li>将 <code>json-schema</code> 转换成 <code>Field Model</code> 的能力</li><li>编译 <code>json-schema</code> 表达式的能力</li></ul></li></ul><p>src\\App.tsx</p><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code class="language-javascript"><span class="line"><span class="token keyword">import</span> <span class="token punctuation">{</span> createForm <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&#39;@formily/core&#39;</span></span>
<span class="line"><span class="token keyword">import</span> <span class="token punctuation">{</span> createSchemaField <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&#39;@formily/react&#39;</span></span>
<span class="line"><span class="token keyword">import</span> <span class="token string">&#39;antd/dist/antd.css&#39;</span></span>
<span class="line"><span class="token keyword">import</span> <span class="token punctuation">{</span> Form<span class="token punctuation">,</span> FormItem<span class="token punctuation">,</span> Input <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&#39;@formily/antd&#39;</span></span>
<span class="line"><span class="token keyword">const</span> form <span class="token operator">=</span> <span class="token function">createForm</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line"><span class="token keyword">const</span> SchemaField <span class="token operator">=</span> <span class="token function">createSchemaField</span><span class="token punctuation">(</span><span class="token punctuation">{</span></span>
<span class="line">  <span class="token literal-property property">components</span><span class="token operator">:</span> <span class="token punctuation">{</span></span>
<span class="line">    FormItem<span class="token punctuation">,</span></span>
<span class="line">    Input</span>
<span class="line">  <span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line"><span class="token punctuation">}</span><span class="token punctuation">)</span></span>
<span class="line"><span class="token keyword">const</span> schema <span class="token operator">=</span> <span class="token punctuation">{</span></span>
<span class="line">  <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token string">&#39;object&#39;</span><span class="token punctuation">,</span></span>
<span class="line">  <span class="token literal-property property">properties</span><span class="token operator">:</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token punctuation">{</span></span>
<span class="line">      <span class="token literal-property property">title</span><span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">\`</span><span class="token string">姓名</span><span class="token template-punctuation string">\`</span></span><span class="token punctuation">,</span></span>
<span class="line">      <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token string">&#39;string&#39;</span><span class="token punctuation">,</span></span>
<span class="line">      <span class="token literal-property property">required</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span></span>
<span class="line">      <span class="token string-property property">&#39;x-decorator&#39;</span><span class="token operator">:</span> <span class="token string">&#39;FormItem&#39;</span><span class="token punctuation">,</span><span class="token comment">//字段 UI 包装器组件</span></span>
<span class="line">      <span class="token string-property property">&#39;x-component&#39;</span><span class="token operator">:</span> <span class="token string">&#39;Input&#39;</span><span class="token punctuation">,</span><span class="token comment">//字段 UI 组件属性</span></span>
<span class="line">    <span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token literal-property property">age</span><span class="token operator">:</span> <span class="token punctuation">{</span></span>
<span class="line">      <span class="token literal-property property">title</span><span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">\`</span><span class="token string">邮箱</span><span class="token template-punctuation string">\`</span></span><span class="token punctuation">,</span></span>
<span class="line">      <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token string">&#39;string&#39;</span><span class="token punctuation">,</span></span>
<span class="line">      <span class="token literal-property property">required</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span></span>
<span class="line">      <span class="token string-property property">&#39;x-validator&#39;</span><span class="token operator">:</span> <span class="token string">&#39;email&#39;</span><span class="token punctuation">,</span></span>
<span class="line">      <span class="token string-property property">&#39;x-decorator&#39;</span><span class="token operator">:</span> <span class="token string">&#39;FormItem&#39;</span><span class="token punctuation">,</span><span class="token comment">//字段 UI 包装器组件</span></span>
<span class="line">      <span class="token string-property property">&#39;x-component&#39;</span><span class="token operator">:</span> <span class="token string">&#39;Input&#39;</span><span class="token punctuation">,</span><span class="token comment">//字段 UI 组件属性</span></span>
<span class="line">    <span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">  <span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"><span class="token keyword">function</span> <span class="token function">App</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">  <span class="token keyword">return</span> <span class="token punctuation">(</span></span>
<span class="line">    <span class="token operator">&lt;</span>Form form<span class="token operator">=</span><span class="token punctuation">{</span>form<span class="token punctuation">}</span> labelCol<span class="token operator">=</span><span class="token punctuation">{</span><span class="token number">6</span><span class="token punctuation">}</span> wrapperCol<span class="token operator">=</span><span class="token punctuation">{</span><span class="token number">10</span><span class="token punctuation">}</span><span class="token operator">&gt;</span></span>
<span class="line">      <span class="token operator">&lt;</span>SchemaField schema<span class="token operator">=</span><span class="token punctuation">{</span>schema<span class="token punctuation">}</span> <span class="token operator">/</span><span class="token operator">&gt;</span></span>
<span class="line">    <span class="token operator">&lt;</span><span class="token operator">/</span>Form<span class="token operator">&gt;</span></span>
<span class="line">  <span class="token punctuation">)</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"><span class="token keyword">export</span> <span class="token keyword">default</span> App<span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_6-5-3-markup-schema-案例" tabindex="-1"><a class="header-anchor" href="#_6-5-3-markup-schema-案例"><span>6.5.3 Markup Schema 案例</span></a></h4><p>src\\App.tsx</p><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code class="language-javascript"><span class="line"><span class="token keyword">import</span> <span class="token punctuation">{</span> createForm <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&#39;@formily/core&#39;</span></span>
<span class="line"><span class="token keyword">import</span> <span class="token punctuation">{</span> createSchemaField <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&#39;@formily/react&#39;</span></span>
<span class="line"><span class="token keyword">import</span> <span class="token string">&#39;antd/dist/antd.css&#39;</span></span>
<span class="line"><span class="token keyword">import</span> <span class="token punctuation">{</span> Form<span class="token punctuation">,</span> FormItem<span class="token punctuation">,</span> Input<span class="token punctuation">,</span> NumberPicker <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&#39;@formily/antd&#39;</span></span>
<span class="line"><span class="token keyword">const</span> form <span class="token operator">=</span> <span class="token function">createForm</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line"><span class="token keyword">const</span> SchemaField <span class="token operator">=</span> <span class="token function">createSchemaField</span><span class="token punctuation">(</span><span class="token punctuation">{</span></span>
<span class="line">  <span class="token literal-property property">components</span><span class="token operator">:</span> <span class="token punctuation">{</span></span>
<span class="line">    Input<span class="token punctuation">,</span></span>
<span class="line">    FormItem<span class="token punctuation">,</span></span>
<span class="line">    NumberPicker</span>
<span class="line">  <span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line"><span class="token punctuation">}</span><span class="token punctuation">)</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">function</span> <span class="token function">App</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">  <span class="token keyword">return</span> <span class="token punctuation">(</span></span>
<span class="line">    <span class="token operator">&lt;</span>Form form<span class="token operator">=</span><span class="token punctuation">{</span>form<span class="token punctuation">}</span> labelCol<span class="token operator">=</span><span class="token punctuation">{</span><span class="token number">6</span><span class="token punctuation">}</span> wrapperCol<span class="token operator">=</span><span class="token punctuation">{</span><span class="token number">10</span><span class="token punctuation">}</span><span class="token operator">&gt;</span></span>
<span class="line">      <span class="token operator">&lt;</span>SchemaField<span class="token operator">&gt;</span></span>
<span class="line">        <span class="token operator">&lt;</span>SchemaField<span class="token punctuation">.</span>String</span>
<span class="line">          name<span class="token operator">=</span><span class="token string">&quot;name&quot;</span></span>
<span class="line">          title<span class="token operator">=</span><span class="token string">&quot;姓名&quot;</span></span>
<span class="line">          required</span>
<span class="line">          x<span class="token operator">-</span>component<span class="token operator">=</span><span class="token string">&quot;Input&quot;</span><span class="token comment">//字段 UI 组件属性</span></span>
<span class="line">          x<span class="token operator">-</span>decorator<span class="token operator">=</span><span class="token string">&quot;FormItem&quot;</span><span class="token comment">//字段 UI 包装器组件</span></span>
<span class="line">        <span class="token operator">/</span><span class="token operator">&gt;</span></span>
<span class="line">        <span class="token operator">&lt;</span>SchemaField<span class="token punctuation">.</span>Number</span>
<span class="line">          name<span class="token operator">=</span><span class="token string">&quot;age&quot;</span></span>
<span class="line">          title<span class="token operator">=</span><span class="token string">&quot;年龄&quot;</span></span>
<span class="line">          maximum<span class="token operator">=</span><span class="token punctuation">{</span><span class="token number">120</span><span class="token punctuation">}</span></span>
<span class="line">          x<span class="token operator">-</span>component<span class="token operator">=</span><span class="token string">&quot;NumberPicker&quot;</span><span class="token comment">//字段 UI 组件属性</span></span>
<span class="line">          x<span class="token operator">-</span>decorator<span class="token operator">=</span><span class="token string">&quot;FormItem&quot;</span><span class="token comment">//字段 UI 包装器组件</span></span>
<span class="line">        <span class="token operator">/</span><span class="token operator">&gt;</span></span>
<span class="line">      <span class="token operator">&lt;</span><span class="token operator">/</span>SchemaField<span class="token operator">&gt;</span></span>
<span class="line">    <span class="token operator">&lt;</span><span class="token operator">/</span>Form<span class="token operator">&gt;</span></span>
<span class="line">  <span class="token punctuation">)</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"><span class="token keyword">export</span> <span class="token keyword">default</span> App<span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_6-6-联动校验" tabindex="-1"><a class="header-anchor" href="#_6-6-联动校验"><span>6.6 联动校验</span></a></h3><ul><li>同时我们还能在 <code>effects</code> 或者 <code>x-reactions</code> 中实现联动校验</li></ul><h4 id="_6-6-1-主动联动" tabindex="-1"><a class="header-anchor" href="#_6-6-1-主动联动"><span>6.6.1 主动联动</span></a></h4><ul><li>[Schema 联动协议](https://react.formilyjs.org/zh-CN/api/shared/schema</li></ul><p>src\\App.tsx</p><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code class="language-javascript"><span class="line"><span class="token keyword">import</span> <span class="token punctuation">{</span> createForm <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&#39;@formily/core&#39;</span></span>
<span class="line"><span class="token keyword">import</span> <span class="token punctuation">{</span> createSchemaField <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&#39;@formily/react&#39;</span></span>
<span class="line"><span class="token keyword">import</span> <span class="token string">&#39;antd/dist/antd.css&#39;</span></span>
<span class="line"><span class="token keyword">import</span> <span class="token punctuation">{</span> Form<span class="token punctuation">,</span> FormItem<span class="token punctuation">,</span> Input <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&#39;@formily/antd&#39;</span></span>
<span class="line"><span class="token keyword">const</span> form <span class="token operator">=</span> <span class="token function">createForm</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line"><span class="token keyword">const</span> SchemaField <span class="token operator">=</span> <span class="token function">createSchemaField</span><span class="token punctuation">(</span><span class="token punctuation">{</span></span>
<span class="line">  <span class="token literal-property property">components</span><span class="token operator">:</span> <span class="token punctuation">{</span></span>
<span class="line">    FormItem<span class="token punctuation">,</span></span>
<span class="line">    Input</span>
<span class="line">  <span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line"><span class="token punctuation">}</span><span class="token punctuation">)</span></span>
<span class="line"><span class="token keyword">const</span> schema <span class="token operator">=</span> <span class="token punctuation">{</span></span>
<span class="line">  <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token string">&#39;object&#39;</span><span class="token punctuation">,</span></span>
<span class="line">  <span class="token literal-property property">properties</span><span class="token operator">:</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token literal-property property">source</span><span class="token operator">:</span> <span class="token punctuation">{</span></span>
<span class="line">      <span class="token literal-property property">title</span><span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">\`</span><span class="token string">来源</span><span class="token template-punctuation string">\`</span></span><span class="token punctuation">,</span></span>
<span class="line">      <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token string">&#39;string&#39;</span><span class="token punctuation">,</span></span>
<span class="line">      <span class="token literal-property property">required</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span></span>
<span class="line">      <span class="token string-property property">&#39;x-decorator&#39;</span><span class="token operator">:</span> <span class="token string">&#39;FormItem&#39;</span><span class="token punctuation">,</span><span class="token comment">//字段 UI 包装器组件</span></span>
<span class="line">      <span class="token string-property property">&#39;x-component&#39;</span><span class="token operator">:</span> <span class="token string">&#39;Input&#39;</span><span class="token punctuation">,</span><span class="token comment">//字段 UI 组件属性</span></span>
<span class="line">      <span class="token string-property property">&quot;x-component-props&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span><span class="token comment">//字段 UI 组件属性</span></span>
<span class="line">        <span class="token string-property property">&quot;placeholder&quot;</span><span class="token operator">:</span> <span class="token string">&quot;请输入&quot;</span></span>
<span class="line">      <span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">      <span class="token string-property property">&quot;x-reactions&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token comment">//字段联动协议</span></span>
<span class="line">        <span class="token punctuation">{</span></span>
<span class="line">          <span class="token string-property property">&quot;target&quot;</span><span class="token operator">:</span> <span class="token string">&quot;target&quot;</span><span class="token punctuation">,</span><span class="token comment">///要操作的字段路径，支持FormPathPattern路径语法</span></span>
<span class="line">          <span class="token comment">//代表当前字段实例，可以在普通属性表达式中使用，也能在 x-reactions 中使用</span></span>
<span class="line">          <span class="token string-property property">&quot;when&quot;</span><span class="token operator">:</span> <span class="token string">&quot;{{$self.value == &#39;123&#39;}}&quot;</span><span class="token punctuation">,</span><span class="token comment">//联动条件</span></span>
<span class="line">          <span class="token string-property property">&quot;fulfill&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token comment">//满足条件</span></span>
<span class="line">            <span class="token string-property property">&quot;state&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span><span class="token comment">//更新状态</span></span>
<span class="line">              <span class="token string-property property">&quot;visible&quot;</span><span class="token operator">:</span> <span class="token boolean">true</span></span>
<span class="line">            <span class="token punctuation">}</span></span>
<span class="line">          <span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">          <span class="token string-property property">&quot;otherwise&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token comment">//不满足条件</span></span>
<span class="line">            <span class="token string-property property">&quot;state&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span><span class="token comment">//更新状态</span></span>
<span class="line">              <span class="token string-property property">&quot;visible&quot;</span><span class="token operator">:</span> <span class="token boolean">false</span></span>
<span class="line">            <span class="token punctuation">}</span></span>
<span class="line">          <span class="token punctuation">}</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">      <span class="token punctuation">]</span></span>
<span class="line">    <span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token literal-property property">target</span><span class="token operator">:</span> <span class="token punctuation">{</span></span>
<span class="line">      <span class="token string-property property">&quot;title&quot;</span><span class="token operator">:</span> <span class="token string">&quot;目标&quot;</span><span class="token punctuation">,</span></span>
<span class="line">      <span class="token string-property property">&quot;type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;string&quot;</span><span class="token punctuation">,</span></span>
<span class="line">      <span class="token string-property property">&quot;x-component&quot;</span><span class="token operator">:</span> <span class="token string">&quot;Input&quot;</span><span class="token punctuation">,</span><span class="token comment">//字段 UI 组件属性</span></span>
<span class="line">      <span class="token string-property property">&quot;x-component-props&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span><span class="token comment">//字段 UI 组件属性</span></span>
<span class="line">        <span class="token string-property property">&quot;placeholder&quot;</span><span class="token operator">:</span> <span class="token string">&quot;请输入&quot;</span></span>
<span class="line">      <span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">      <span class="token string-property property">&#39;x-decorator&#39;</span><span class="token operator">:</span> <span class="token string">&#39;FormItem&#39;</span><span class="token comment">//字段 UI 包装器组件</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">  <span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"><span class="token keyword">function</span> <span class="token function">App</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">  <span class="token keyword">return</span> <span class="token punctuation">(</span></span>
<span class="line">    <span class="token operator">&lt;</span>Form form<span class="token operator">=</span><span class="token punctuation">{</span>form<span class="token punctuation">}</span> labelCol<span class="token operator">=</span><span class="token punctuation">{</span><span class="token number">6</span><span class="token punctuation">}</span> wrapperCol<span class="token operator">=</span><span class="token punctuation">{</span><span class="token number">10</span><span class="token punctuation">}</span><span class="token operator">&gt;</span></span>
<span class="line">      <span class="token operator">&lt;</span>SchemaField schema<span class="token operator">=</span><span class="token punctuation">{</span>schema<span class="token punctuation">}</span> <span class="token operator">/</span><span class="token operator">&gt;</span></span>
<span class="line">    <span class="token operator">&lt;</span><span class="token operator">/</span>Form<span class="token operator">&gt;</span></span>
<span class="line">  <span class="token punctuation">)</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"><span class="token keyword">export</span> <span class="token keyword">default</span> App<span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_6-6-2-被动联动" tabindex="-1"><a class="header-anchor" href="#_6-6-2-被动联动"><span>6.6.2 被动联动</span></a></h4><p>src\\App.tsx</p><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code class="language-javascript"><span class="line"><span class="token keyword">import</span> <span class="token punctuation">{</span> createForm <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&#39;@formily/core&#39;</span></span>
<span class="line"><span class="token keyword">import</span> <span class="token punctuation">{</span> createSchemaField <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&#39;@formily/react&#39;</span></span>
<span class="line"><span class="token keyword">import</span> <span class="token string">&#39;antd/dist/antd.css&#39;</span></span>
<span class="line"><span class="token keyword">import</span> <span class="token punctuation">{</span> Form<span class="token punctuation">,</span> FormItem<span class="token punctuation">,</span> Input <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&#39;@formily/antd&#39;</span></span>
<span class="line"><span class="token keyword">const</span> form <span class="token operator">=</span> <span class="token function">createForm</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line"><span class="token keyword">const</span> SchemaField <span class="token operator">=</span> <span class="token function">createSchemaField</span><span class="token punctuation">(</span><span class="token punctuation">{</span></span>
<span class="line">  <span class="token literal-property property">components</span><span class="token operator">:</span> <span class="token punctuation">{</span></span>
<span class="line">    FormItem<span class="token punctuation">,</span></span>
<span class="line">    Input</span>
<span class="line">  <span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line"><span class="token punctuation">}</span><span class="token punctuation">)</span></span>
<span class="line"><span class="token keyword">const</span> schema <span class="token operator">=</span> <span class="token punctuation">{</span></span>
<span class="line">  <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token string">&#39;object&#39;</span><span class="token punctuation">,</span></span>
<span class="line">  <span class="token literal-property property">properties</span><span class="token operator">:</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token literal-property property">source</span><span class="token operator">:</span> <span class="token punctuation">{</span></span>
<span class="line">      <span class="token literal-property property">title</span><span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">\`</span><span class="token string">来源</span><span class="token template-punctuation string">\`</span></span><span class="token punctuation">,</span></span>
<span class="line">      <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token string">&#39;string&#39;</span><span class="token punctuation">,</span></span>
<span class="line">      <span class="token literal-property property">required</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span></span>
<span class="line">      <span class="token string-property property">&#39;x-decorator&#39;</span><span class="token operator">:</span> <span class="token string">&#39;FormItem&#39;</span><span class="token punctuation">,</span><span class="token comment">//字段 UI 包装器组件</span></span>
<span class="line">      <span class="token string-property property">&#39;x-component&#39;</span><span class="token operator">:</span> <span class="token string">&#39;Input&#39;</span><span class="token punctuation">,</span><span class="token comment">//字段 UI 组件属性</span></span>
<span class="line">      <span class="token string-property property">&quot;x-component-props&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span><span class="token comment">//字段 UI 组件属性</span></span>
<span class="line">        <span class="token string-property property">&quot;placeholder&quot;</span><span class="token operator">:</span> <span class="token string">&quot;请输入&quot;</span></span>
<span class="line">      <span class="token punctuation">}</span></span>
<span class="line">    <span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token literal-property property">target</span><span class="token operator">:</span> <span class="token punctuation">{</span></span>
<span class="line">      <span class="token string-property property">&quot;title&quot;</span><span class="token operator">:</span> <span class="token string">&quot;目标&quot;</span><span class="token punctuation">,</span></span>
<span class="line">      <span class="token string-property property">&quot;type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;string&quot;</span><span class="token punctuation">,</span></span>
<span class="line">      <span class="token string-property property">&quot;x-component&quot;</span><span class="token operator">:</span> <span class="token string">&quot;Input&quot;</span><span class="token punctuation">,</span><span class="token comment">//字段 UI 组件属性</span></span>
<span class="line">      <span class="token string-property property">&quot;x-component-props&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span><span class="token comment">//字段 UI 组件属性</span></span>
<span class="line">        <span class="token string-property property">&quot;placeholder&quot;</span><span class="token operator">:</span> <span class="token string">&quot;请输入&quot;</span></span>
<span class="line">      <span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">      <span class="token string-property property">&#39;x-decorator&#39;</span><span class="token operator">:</span> <span class="token string">&#39;FormItem&#39;</span><span class="token punctuation">,</span><span class="token comment">//字段 UI 包装器组件</span></span>
<span class="line">      <span class="token string-property property">&quot;x-reactions&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token comment">//字段联动协议</span></span>
<span class="line">        <span class="token punctuation">{</span></span>
<span class="line">          <span class="token string-property property">&quot;dependencies&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">&quot;source&quot;</span><span class="token punctuation">]</span><span class="token punctuation">,</span></span>
<span class="line">          <span class="token comment">//只能在x-reactions中的表达式消费，与 x-reactions 定义的 dependencies 对应，数组顺序一致</span></span>
<span class="line">          <span class="token string-property property">&quot;when&quot;</span><span class="token operator">:</span> <span class="token string">&quot;{{$deps[0] == &#39;123&#39;}}&quot;</span><span class="token punctuation">,</span></span>
<span class="line">          <span class="token string-property property">&quot;fulfill&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token string-property property">&quot;state&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span></span>
<span class="line">              <span class="token string-property property">&quot;visible&quot;</span><span class="token operator">:</span> <span class="token boolean">true</span></span>
<span class="line">            <span class="token punctuation">}</span></span>
<span class="line">          <span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">          <span class="token string-property property">&quot;otherwise&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token string-property property">&quot;state&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span></span>
<span class="line">              <span class="token string-property property">&quot;visible&quot;</span><span class="token operator">:</span> <span class="token boolean">false</span></span>
<span class="line">            <span class="token punctuation">}</span></span>
<span class="line">          <span class="token punctuation">}</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">      <span class="token punctuation">]</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">  <span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"><span class="token keyword">function</span> <span class="token function">App</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">  <span class="token keyword">return</span> <span class="token punctuation">(</span></span>
<span class="line">    <span class="token operator">&lt;</span>Form form<span class="token operator">=</span><span class="token punctuation">{</span>form<span class="token punctuation">}</span> labelCol<span class="token operator">=</span><span class="token punctuation">{</span><span class="token number">6</span><span class="token punctuation">}</span> wrapperCol<span class="token operator">=</span><span class="token punctuation">{</span><span class="token number">10</span><span class="token punctuation">}</span><span class="token operator">&gt;</span></span>
<span class="line">      <span class="token operator">&lt;</span>SchemaField schema<span class="token operator">=</span><span class="token punctuation">{</span>schema<span class="token punctuation">}</span> <span class="token operator">/</span><span class="token operator">&gt;</span></span>
<span class="line">    <span class="token operator">&lt;</span><span class="token operator">/</span>Form<span class="token operator">&gt;</span></span>
<span class="line">  <span class="token punctuation">)</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"><span class="token keyword">export</span> <span class="token keyword">default</span> App<span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_6-6-3-effects" tabindex="-1"><a class="header-anchor" href="#_6-6-3-effects"><span>6.6.3 effects</span></a></h4><p>src\\App.tsx</p><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code class="language-javascript"><span class="line"><span class="token keyword">import</span> <span class="token punctuation">{</span> createForm<span class="token punctuation">,</span> onFieldMount<span class="token punctuation">,</span> onFieldValueChange <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&#39;@formily/core&#39;</span></span>
<span class="line"><span class="token keyword">import</span> <span class="token punctuation">{</span> createSchemaField <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&#39;@formily/react&#39;</span></span>
<span class="line"><span class="token keyword">import</span> <span class="token string">&#39;antd/dist/antd.css&#39;</span></span>
<span class="line"><span class="token keyword">import</span> <span class="token punctuation">{</span> Form<span class="token punctuation">,</span> FormItem<span class="token punctuation">,</span> Input <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&#39;@formily/antd&#39;</span></span>
<span class="line"><span class="token keyword">const</span> form <span class="token operator">=</span> <span class="token function">createForm</span><span class="token punctuation">(</span><span class="token punctuation">{</span></span>
<span class="line">  <span class="token function">effects</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token comment">//effects 副作用逻辑，用于实现各种联动逻辑</span></span>
<span class="line">    <span class="token comment">//用于监听某个字段已挂载的副作用钩子</span></span>
<span class="line">    <span class="token function">onFieldMount</span><span class="token punctuation">(</span><span class="token string">&#39;target&#39;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token literal-property property">field</span><span class="token operator">:</span> any</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></span>
<span class="line">      <span class="token comment">//可以设置字段状态</span></span>
<span class="line">      form<span class="token punctuation">.</span><span class="token function">setFieldState</span><span class="token punctuation">(</span>field<span class="token punctuation">.</span><span class="token function">query</span><span class="token punctuation">(</span><span class="token string">&#39;target&#39;</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">state</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">if</span> <span class="token punctuation">(</span>field<span class="token punctuation">.</span>value <span class="token operator">===</span> <span class="token string">&#39;123&#39;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">          state<span class="token punctuation">.</span>visible <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span></span>
<span class="line">          state<span class="token punctuation">.</span>visible <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">      <span class="token punctuation">}</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token punctuation">}</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token comment">//用于监听某个字段值变化的副作用钩子</span></span>
<span class="line">    <span class="token function">onFieldValueChange</span><span class="token punctuation">(</span><span class="token string">&#39;source&#39;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token literal-property property">field</span><span class="token operator">:</span> any</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></span>
<span class="line">      form<span class="token punctuation">.</span><span class="token function">setFieldState</span><span class="token punctuation">(</span>field<span class="token punctuation">.</span><span class="token function">query</span><span class="token punctuation">(</span><span class="token string">&#39;target&#39;</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">state</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">if</span> <span class="token punctuation">(</span>field<span class="token punctuation">.</span>value <span class="token operator">===</span> <span class="token string">&#39;123&#39;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">          state<span class="token punctuation">.</span>visible <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span></span>
<span class="line">          state<span class="token punctuation">.</span>visible <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">      <span class="token punctuation">}</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token punctuation">}</span><span class="token punctuation">)</span></span>
<span class="line">  <span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line"><span class="token punctuation">}</span><span class="token punctuation">)</span></span>
<span class="line"><span class="token keyword">const</span> SchemaField <span class="token operator">=</span> <span class="token function">createSchemaField</span><span class="token punctuation">(</span><span class="token punctuation">{</span></span>
<span class="line">  <span class="token literal-property property">components</span><span class="token operator">:</span> <span class="token punctuation">{</span></span>
<span class="line">    FormItem<span class="token punctuation">,</span></span>
<span class="line">    Input</span>
<span class="line">  <span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line"><span class="token punctuation">}</span><span class="token punctuation">)</span></span>
<span class="line"><span class="token keyword">const</span> schema <span class="token operator">=</span> <span class="token punctuation">{</span></span>
<span class="line">  <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token string">&#39;object&#39;</span><span class="token punctuation">,</span></span>
<span class="line">  <span class="token literal-property property">properties</span><span class="token operator">:</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token literal-property property">source</span><span class="token operator">:</span> <span class="token punctuation">{</span></span>
<span class="line">      <span class="token literal-property property">title</span><span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">\`</span><span class="token string">来源</span><span class="token template-punctuation string">\`</span></span><span class="token punctuation">,</span></span>
<span class="line">      <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token string">&#39;string&#39;</span><span class="token punctuation">,</span></span>
<span class="line">      <span class="token literal-property property">required</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span></span>
<span class="line">      <span class="token string-property property">&#39;x-decorator&#39;</span><span class="token operator">:</span> <span class="token string">&#39;FormItem&#39;</span><span class="token punctuation">,</span><span class="token comment">//字段 UI 包装器组件</span></span>
<span class="line">      <span class="token string-property property">&#39;x-component&#39;</span><span class="token operator">:</span> <span class="token string">&#39;Input&#39;</span><span class="token punctuation">,</span><span class="token comment">//字段 UI 组件属性</span></span>
<span class="line">      <span class="token string-property property">&quot;x-component-props&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span><span class="token comment">//字段 UI 组件属性</span></span>
<span class="line">        <span class="token string-property property">&quot;placeholder&quot;</span><span class="token operator">:</span> <span class="token string">&quot;请输入&quot;</span></span>
<span class="line">      <span class="token punctuation">}</span></span>
<span class="line">    <span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token literal-property property">target</span><span class="token operator">:</span> <span class="token punctuation">{</span></span>
<span class="line">      <span class="token string-property property">&quot;title&quot;</span><span class="token operator">:</span> <span class="token string">&quot;目标&quot;</span><span class="token punctuation">,</span></span>
<span class="line">      <span class="token string-property property">&quot;type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;string&quot;</span><span class="token punctuation">,</span></span>
<span class="line">      <span class="token string-property property">&#39;x-decorator&#39;</span><span class="token operator">:</span> <span class="token string">&#39;FormItem&#39;</span><span class="token punctuation">,</span><span class="token comment">//字段 UI 包装器组件</span></span>
<span class="line">      <span class="token string-property property">&quot;x-component&quot;</span><span class="token operator">:</span> <span class="token string">&quot;Input&quot;</span><span class="token punctuation">,</span><span class="token comment">//字段 UI 组件属性</span></span>
<span class="line">      <span class="token string-property property">&quot;x-component-props&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span><span class="token comment">//字段 UI 组件属性</span></span>
<span class="line">        <span class="token string-property property">&quot;placeholder&quot;</span><span class="token operator">:</span> <span class="token string">&quot;请输入&quot;</span></span>
<span class="line">      <span class="token punctuation">}</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">  <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"><span class="token keyword">function</span> <span class="token function">App</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">  <span class="token keyword">return</span> <span class="token punctuation">(</span></span>
<span class="line">    <span class="token operator">&lt;</span>Form form<span class="token operator">=</span><span class="token punctuation">{</span>form<span class="token punctuation">}</span> labelCol<span class="token operator">=</span><span class="token punctuation">{</span><span class="token number">6</span><span class="token punctuation">}</span> wrapperCol<span class="token operator">=</span><span class="token punctuation">{</span><span class="token number">10</span><span class="token punctuation">}</span><span class="token operator">&gt;</span></span>
<span class="line">      <span class="token operator">&lt;</span>SchemaField schema<span class="token operator">=</span><span class="token punctuation">{</span>schema<span class="token punctuation">}</span> <span class="token operator">/</span><span class="token operator">&gt;</span></span>
<span class="line">    <span class="token operator">&lt;</span><span class="token operator">/</span>Form<span class="token operator">&gt;</span></span>
<span class="line">  <span class="token punctuation">)</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"><span class="token keyword">export</span> <span class="token keyword">default</span> App<span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div>`,120)])])}const i=s(t,[["render",l]]),r=JSON.parse('{"path":"/strong/155.1.formily.html","title":"","lang":"en-US","frontmatter":{},"git":{"updatedTime":1681290319000,"contributors":[{"name":"yutao","username":"yutao","email":"642231346@qq.com","commits":1,"url":"https://github.com/yutao"}],"changelog":[{"hash":"f5ab8c9d34991ec274f7f652439afe5b2afb6147","time":1681290319000,"email":"642231346@qq.com","author":"yutao","message":"modify"}]},"filePathRelative":"strong/155.1.formily.md"}');export{i as comp,r as data};
