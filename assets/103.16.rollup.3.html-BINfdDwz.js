import{_ as s,c as a,a as t,o as e}from"./app-CD1YpnS1.js";const p={};function l(o,n){return e(),a("div",null,[...n[0]||(n[0]=[t(`<h2 id="_1-rollup" tabindex="-1"><a class="header-anchor" href="#_1-rollup"><span>1. rollup</span></a></h2><ul><li><code>Rollup</code>是一个<code>JavaScript</code>模块打包器，可以将小块代码编译成大块复杂的代码，例如<code>library</code>或应用程序</li></ul><h3 id="_1-1-debugger-js" tabindex="-1"><a class="header-anchor" href="#_1-1-debugger-js"><span>1.1 debugger.js</span></a></h3><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code class="language-javascript"><span class="line"><span class="token keyword">import</span> <span class="token punctuation">{</span> rollup<span class="token punctuation">,</span> watch <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&#39;rollup&#39;</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">import</span> inputOptions <span class="token keyword">from</span> <span class="token string">&#39;./rollup.config.js&#39;</span></span>
<span class="line">  <span class="token punctuation">;</span> <span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token comment">//打包阶段 </span></span>
<span class="line">    <span class="token keyword">const</span> bundle <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">rollup</span><span class="token punctuation">(</span>inputOptions<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token comment">//生成阶段</span></span>
<span class="line">    <span class="token keyword">await</span> bundle<span class="token punctuation">.</span><span class="token function">generate</span><span class="token punctuation">(</span>inputOptions<span class="token punctuation">.</span>output<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token comment">//写入阶段</span></span>
<span class="line">    <span class="token keyword">await</span> bundle<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span>inputOptions<span class="token punctuation">.</span>output<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token comment">/* </span>
<span class="line">    const watcher = watch(inputOptions);</span>
<span class="line">    watcher.on(&#39;event&#39;, event =&gt; {</span>
<span class="line">      console.log(event);</span>
<span class="line">    });</span>
<span class="line">    setTimeout(() =&gt; {</span>
<span class="line">      watcher.close();</span>
<span class="line">    }, 1000); */</span></span>
<span class="line">    <span class="token comment">//关闭阶段</span></span>
<span class="line">    <span class="token keyword">await</span> bundle<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_1-2-rollup-config-js" tabindex="-1"><a class="header-anchor" href="#_1-2-rollup-config-js"><span>1.2 rollup.config.js</span></a></h3><p>rollup.config.js</p><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code class="language-javascript"><span class="line"><span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token punctuation">{</span></span>
<span class="line">  <span class="token literal-property property">input</span><span class="token operator">:</span> <span class="token string">&quot;./src/index.js&quot;</span><span class="token punctuation">,</span></span>
<span class="line">  <span class="token literal-property property">output</span><span class="token operator">:</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token literal-property property">dir</span><span class="token operator">:</span> <span class="token string">&#39;dist&#39;</span><span class="token punctuation">,</span></span>
<span class="line">  <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_1-3-package-json" tabindex="-1"><a class="header-anchor" href="#_1-3-package-json"><span>1.3 package.json</span></a></h3><p>package.json</p><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code class="language-javascript"><span class="line"><span class="token punctuation">{</span></span>
<span class="line">  <span class="token string-property property">&quot;type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;module&quot;</span><span class="token punctuation">,</span></span>
<span class="line">  <span class="token string-property property">&quot;scripts&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token string-property property">&quot;build&quot;</span><span class="token operator">:</span> <span class="token string">&quot;rollup -c&quot;</span></span>
<span class="line">  <span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="_2-rollup插件" tabindex="-1"><a class="header-anchor" href="#_2-rollup插件"><span>2. rollup插件</span></a></h2><ul><li>[Rollup 插件](https://rollupjs.org/guide/en/</li><li><a href="https://github.com/rollup/awesome" target="_blank" rel="noopener noreferrer">插件列表</a></li></ul><h3 id="_2-1-插件规范" tabindex="-1"><a class="header-anchor" href="#_2-1-插件规范"><span>2.1 插件规范</span></a></h3><ul><li>插件应该有一个清晰的名称，带有<code>rollup-plugin-prefix</code></li><li>在package.json中包含插件关键字</li><li>插件应该经过测试。我们推荐mocha或ava，它们支持开箱即用的Promise</li><li>尽可能使用异步方法。</li><li>编写英文文档</li><li>如果合适的话，确保你的插件输出正确的<code>sourcemap</code></li><li>如果您的插件使用“虚拟模块”（例如，用于辅助功能），请在模块ID前面加上<code>\\0</code>。这会阻止其他插件尝试处理它</li></ul><h3 id="_2-2-插件属性" tabindex="-1"><a class="header-anchor" href="#_2-2-插件属性"><span>2.2.插件属性</span></a></h3><h4 id="_2-2-1-name" tabindex="-1"><a class="header-anchor" href="#_2-2-1-name"><span>2.2.1 name</span></a></h4><ul><li>插件的名称，用于错误消息和警告</li><li>Type: 字符串</li></ul><h3 id="_2-2-build-hooks" tabindex="-1"><a class="header-anchor" href="#_2-2-build-hooks"><span>2.2 Build Hooks</span></a></h3><ul><li>为了与构建过程交互，你的插件对象包括“钩子”</li><li>钩子是在构建的不同阶段调用的函数</li><li>钩子可以影响构建的运行方式，提供关于构建的信息，或者在构建完成后修改构建</li><li>有不同种类的钩子 <ul><li><code>async</code> 钩子还可以返回解析为相同类型值的<code>Promise</code>；否则，钩子将被标记为<code>sync</code></li><li><code>first</code> 如果有几个插件实现了这个钩子，钩子会按顺序运行，直到钩子返回一个<code>非null</code>或未定义的值</li><li><code>sequential</code> 如果几个插件实现了这个钩子，那么它们都将按照指定的插件顺序运行。如果一个钩子是异步的，那么这种类型的后续钩子将等待当前钩子被解析</li><li><code>parallel</code> 如果多个插件实现了这个钩子，那么它们都将按照指定的插件顺序运行。如果一个钩子是异步的，那么这类后续钩子将并行运行，而不是等待当前钩子</li></ul></li><li><code>Build Hooks</code>在构建阶段运行，该阶段由<code>rollup.rollup(inputOptions)</code>触发</li><li>它们主要负责在<code>rollup</code>处理输入文件之前定位、提供和转换输入文件</li><li>构建阶段的第一个钩子是<code>options</code>，最后一个钩子总是<code>buildEnd</code></li><li>如果出现生成错误，将在此之后调用<code>closeBundle</code></li></ul><h4 id="_2-2-1-rollup-plugin-build-js" tabindex="-1"><a class="header-anchor" href="#_2-2-1-rollup-plugin-build-js"><span>2.2.1 rollup-plugin-build.js</span></a></h4><p>plugins\\rollup-plugin-build.js</p><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code class="language-javascript"><span class="line"><span class="token keyword">import</span> fs <span class="token keyword">from</span> <span class="token string">&#39;fs&#39;</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">function</span> <span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">  <span class="token keyword">return</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">&#39;build&#39;</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token keyword">async</span> <span class="token function">watchChange</span><span class="token punctuation">(</span><span class="token parameter">id<span class="token punctuation">,</span> change</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&#39;watchChange&#39;</span><span class="token punctuation">,</span> id<span class="token punctuation">,</span> change<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token keyword">async</span> <span class="token function">closeWatcher</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&#39;closeWatcher&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token keyword">async</span> <span class="token function">options</span><span class="token punctuation">(</span><span class="token parameter">inputOptions</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&#39;options&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">      <span class="token comment">//inputOptions.input = &#39;./src/main.js&#39;;</span></span>
<span class="line">    <span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token keyword">async</span> <span class="token function">buildStart</span><span class="token punctuation">(</span><span class="token parameter">inputOptions</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&#39;buildStart&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token keyword">async</span> <span class="token function">resolveId</span><span class="token punctuation">(</span><span class="token parameter">source<span class="token punctuation">,</span> importer</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">      <span class="token keyword">if</span> <span class="token punctuation">(</span>source <span class="token operator">===</span> <span class="token string">&#39;virtual&#39;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&#39;resolveId&#39;</span><span class="token punctuation">,</span> source<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token comment">//如果resolveId钩子有返回值了，那么就会跳过后面的查找逻辑，以此返回值作为最终的模块ID</span></span>
<span class="line">        <span class="token keyword">return</span> source<span class="token punctuation">;</span></span>
<span class="line">      <span class="token punctuation">}</span></span>
<span class="line">    <span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token comment">//加载此模块ID对应的内容</span></span>
<span class="line">    <span class="token keyword">async</span> <span class="token function">load</span><span class="token punctuation">(</span><span class="token parameter">id</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">      <span class="token keyword">if</span> <span class="token punctuation">(</span>id <span class="token operator">===</span> <span class="token string">&#39;virtual&#39;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&#39;load&#39;</span><span class="token punctuation">,</span> id<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">return</span> <span class="token template-string"><span class="token template-punctuation string">\`</span><span class="token string">export default &quot;virtual&quot;</span><span class="token template-punctuation string">\`</span></span><span class="token punctuation">;</span></span>
<span class="line">      <span class="token punctuation">}</span></span>
<span class="line">    <span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token keyword">async</span> <span class="token function">shouldTransformCachedModule</span><span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> id<span class="token punctuation">,</span> code<span class="token punctuation">,</span> ast <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&#39;shouldTransformCachedModule&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">      <span class="token comment">//不使用缓存，再次进行转换</span></span>
<span class="line">      <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token keyword">async</span> <span class="token function">transform</span><span class="token punctuation">(</span><span class="token parameter">code<span class="token punctuation">,</span> id</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&#39;transform&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token keyword">async</span> <span class="token function">moduleParsed</span><span class="token punctuation">(</span><span class="token parameter">moduleInfo</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&#39;moduleParsed&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token keyword">async</span> <span class="token function">resolveDynamicImport</span><span class="token punctuation">(</span><span class="token parameter">specifier<span class="token punctuation">,</span> importer</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&#39;resolveDynamicImport&#39;</span><span class="token punctuation">,</span> specifier<span class="token punctuation">,</span> importer<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token keyword">async</span> <span class="token function">buildEnd</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&#39;buildEnd&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">  <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"><span class="token keyword">export</span> <span class="token keyword">default</span> build<span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_2-2-2-rollup-config-js" tabindex="-1"><a class="header-anchor" href="#_2-2-2-rollup-config-js"><span>2.2.2 rollup.config.js</span></a></h4><p>rollup.config.js</p><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text"><pre><code class="language-text"><span class="line">+import build from &#39;./plugins/rollup-plugin-build.js&#39;;</span>
<span class="line">export default {</span>
<span class="line">  input: &quot;./src/index.js&quot;,</span>
<span class="line">  output: [{</span>
<span class="line">    dir: &#39;dist&#39;,</span>
<span class="line">  }],</span>
<span class="line">  plugins: [</span>
<span class="line">+   build()</span>
<span class="line">  ]</span>
<span class="line">}</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_2-2-4-options" tabindex="-1"><a class="header-anchor" href="#_2-2-4-options"><span>2.2.4 options</span></a></h4><ul><li>[big-list-of-options](https://rollupjs.org/guide/en/</li></ul><table><thead><tr><th style="text-align:left;">字段</th><th style="text-align:left;">值</th></tr></thead><tbody><tr><td style="text-align:left;">Type</td><td style="text-align:left;">(options: InputOptions) =&gt; InputOptions</td></tr><tr><td style="text-align:left;">Kind</td><td style="text-align:left;">async, sequential</td></tr><tr><td style="text-align:left;">Previous Hook</td><td style="text-align:left;">这是构建阶段的第一个钩子</td></tr><tr><td style="text-align:left;">Next Hook</td><td style="text-align:left;">buildStart</td></tr></tbody></table><ul><li>替换或操作传递给<code>rollup</code>的选项对象</li><li>返回<code>null</code>的话rollup不会替换任何内容</li><li>如果只需要阅读<code>options</code>，建议使用<code>buildStart</code>钩子，因为在考虑了所有选项钩子的转换后，该钩子可以访问选项</li><li>这是唯一一个无法访问大多数插件上下文实用程序功能的钩子，因为它是在完全配置汇总之前运行的</li></ul><h4 id="_2-2-5-buildstart" tabindex="-1"><a class="header-anchor" href="#_2-2-5-buildstart"><span>2.2.5 buildStart</span></a></h4><table><thead><tr><th style="text-align:left;">字段</th><th style="text-align:left;">值</th></tr></thead><tbody><tr><td style="text-align:left;">Type</td><td style="text-align:left;">(options: InputOptions) =&gt; void</td></tr><tr><td style="text-align:left;">Kind</td><td style="text-align:left;">async, parallel</td></tr><tr><td style="text-align:left;">Previous Hook</td><td style="text-align:left;">options</td></tr><tr><td style="text-align:left;">Next Hook</td><td style="text-align:left;">resolveId并行解析每个入口点</td></tr></tbody></table><ul><li>每次<code>rollup.rollup build</code>都要调用此钩子</li><li>当您需要访问传递给rollup的选项时，建议使用这个钩子</li><li>因为它考虑了所有<code>options</code>钩子的转换，还包含未设置选项的正确默认值</li></ul><p>build\\plugin-buildStart.js</p><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code class="language-javascript"><span class="line"><span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">function</span> <span class="token function">buildStart</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">  <span class="token keyword">return</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">&#39;buildStart&#39;</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token function">buildStart</span><span class="token punctuation">(</span><span class="token parameter">InputOptions</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&#39;buildStart&#39;</span><span class="token punctuation">,</span> InputOptions<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">  <span class="token punctuation">}</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_2-2-6-resolveid" tabindex="-1"><a class="header-anchor" href="#_2-2-6-resolveid"><span>2.2.6 resolveId</span></a></h4><table><thead><tr><th style="text-align:left;">字段</th><th style="text-align:left;">值</th></tr></thead><tbody><tr><td style="text-align:left;">Type</td><td style="text-align:left;">(source, importer) =&gt; string</td></tr><tr><td style="text-align:left;">Kind</td><td style="text-align:left;">async, first</td></tr><tr><td style="text-align:left;">Previous Hook</td><td style="text-align:left;"><code>buildStart</code>(如果我们正在解析入口点)，<code>moduleParsed</code>（如果我们正在解析导入），或者作为<code>resolveDynamicImport</code>的后备方案。此外，这个钩子可以在构建阶段通过调用插件钩子触发。<code>emitFile</code>发出一个入口点，或在任何时候通过调用此。<code>resolve</code>可手动解析id</td></tr><tr><td style="text-align:left;">Next Hook</td><td style="text-align:left;">如果解析的<code>id</code>尚未加载，则<code>load</code>，否则<code>buildEnd</code></td></tr></tbody></table><ul><li><p>定义自定义解析器</p></li><li><p>解析程序可用于定位第三方依赖关系等。这里<code>source</code>是导入语句中所写的导入对象，即</p></li><li><p>来源就是 <code>&quot;../bar.js&quot;</code></p><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code class="language-javascript"><span class="line"><span class="token keyword">import</span> <span class="token punctuation">{</span> foo <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&#39;../bar.js&#39;</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div></li><li><p><code>importer</code>是导入模块的完全解析id</p></li><li><p>在解析入口点时，<code>importer</code>通常是undefined</p></li><li><p>这里的一个例外是通过<code>this.emitFile</code>生成的入口点。在这里，您可以提供一个<code>importer</code>参数</p></li><li><p>对于这些情况，<code>isEntry</code>选项将告诉您，我们是否正在解析用户定义的入口点、发出的块，或者是否为此提供了<code>isEntry</code>参数。解析上下文函数</p></li><li><p>例如，您可以将其用作为入口点定义自定义代理模块的机制。以下插件将代理所有入口点以注入<code>polyfill</code>导入</p></li><li><p>返回<code>null</code>将遵循其他<code>resolveId</code>函数，最终遵循默认的解析行</p></li><li><p>返回<code>false</code>信号，表示源应被视为<code>外部模块</code>，不包括在<code>bundle</code>中 \`</p></li></ul><p>build\\plugin-polyfill.js</p><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code class="language-javascript"><span class="line"><span class="token comment">//我们在polyfill id前面加上\\0，告诉其他插件不要尝试加载或转换它</span></span>
<span class="line"><span class="token keyword">const</span> <span class="token constant">POLYFILL_ID</span> <span class="token operator">=</span> <span class="token string">&#39;\\0polyfill&#39;</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">const</span> <span class="token constant">PROXY_SUFFIX</span> <span class="token operator">=</span> <span class="token string">&#39;?inject-polyfill-proxy&#39;</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">function</span> <span class="token function">injectPolyfillPlugin</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">  <span class="token keyword">return</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">&#39;inject-polyfill&#39;</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token keyword">async</span> <span class="token function">resolveId</span><span class="token punctuation">(</span><span class="token parameter">source<span class="token punctuation">,</span> importer<span class="token punctuation">,</span> options</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">      <span class="token keyword">if</span> <span class="token punctuation">(</span>source <span class="token operator">===</span> <span class="token constant">POLYFILL_ID</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token comment">//重要的是，对于polyfills，应始终考虑副作用</span></span>
<span class="line">        <span class="token comment">//否则，使用\`treeshake.moduleSideEffects:false\`可能会阻止包含polyfill</span></span>
<span class="line">        <span class="token keyword">return</span> <span class="token punctuation">{</span> <span class="token literal-property property">id</span><span class="token operator">:</span> <span class="token constant">POLYFILL_ID</span><span class="token punctuation">,</span> <span class="token literal-property property">moduleSideEffects</span><span class="token operator">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span><span class="token punctuation">;</span></span>
<span class="line">      <span class="token punctuation">}</span></span>
<span class="line">      <span class="token keyword">if</span> <span class="token punctuation">(</span>options<span class="token punctuation">.</span>isEntry<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token comment">//确定实际的入口是什么。我们需要skipSelf来避免无限循环。</span></span>
<span class="line">        <span class="token keyword">const</span> resolution <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>source<span class="token punctuation">,</span> importer<span class="token punctuation">,</span> <span class="token punctuation">{</span> <span class="token literal-property property">skipSelf</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token operator">...</span>options <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token comment">//如果它无法解决或是外部的，只需返回它，这样Rollup就可以显示错误</span></span>
<span class="line">        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>resolution <span class="token operator">||</span> resolution<span class="token punctuation">.</span>external<span class="token punctuation">)</span> <span class="token keyword">return</span> resolution<span class="token punctuation">;</span></span>
<span class="line">        <span class="token comment">//在代理的加载钩子中，我们需要知道入口是否有默认导出</span></span>
<span class="line">        <span class="token comment">//然而，在那里，我们不再有完整的“解析”对象，它可能包含来自其他插件的元数据，这些插件只在第一次加载时添加</span></span>
<span class="line">        <span class="token comment">//仅在第一次加载时添加。因此我们在这里触发加载。</span></span>
<span class="line">        <span class="token keyword">const</span> moduleInfo <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">load</span><span class="token punctuation">(</span>resolution<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token comment">//我们需要确保即使对于treeshake来说，原始入口点的副作用也得到了考虑。moduleSideEffects:false。</span></span>
<span class="line">        <span class="token comment">//moduleSideEffects是ModuleInfo上的一个可写属性</span></span>
<span class="line">        moduleInfo<span class="token punctuation">.</span>moduleSideEffects <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token comment">//重要的是，新入口不能以\\0开头，并且与原始入口具有相同的目录，以免扰乱相对外部导入的生成</span></span>
<span class="line">        <span class="token comment">//此外，保留名称并在末尾添加一个“？查询”可以确保preserveModules将为该条目生成原始条目名称</span></span>
<span class="line">        <span class="token keyword">return</span> <span class="token template-string"><span class="token template-punctuation string">\`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">\${</span>resolution<span class="token punctuation">.</span>id<span class="token interpolation-punctuation punctuation">}</span></span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">\${</span><span class="token constant">PROXY_SUFFIX</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">\`</span></span><span class="token punctuation">;</span></span>
<span class="line">      <span class="token punctuation">}</span></span>
<span class="line">      <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token function">load</span><span class="token punctuation">(</span><span class="token parameter">id</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">      <span class="token keyword">if</span> <span class="token punctuation">(</span>id <span class="token operator">===</span> <span class="token constant">POLYFILL_ID</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token comment">// 替换为实际的polyfill import &#39;@babel/polyfill&#39;</span></span>
<span class="line">        <span class="token keyword">return</span> <span class="token string">&quot;console.log(&#39;polyfill&#39;);&quot;</span><span class="token punctuation">;</span></span>
<span class="line">      <span class="token punctuation">}</span></span>
<span class="line">      <span class="token keyword">if</span> <span class="token punctuation">(</span>id<span class="token punctuation">.</span><span class="token function">endsWith</span><span class="token punctuation">(</span><span class="token constant">PROXY_SUFFIX</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">const</span> entryId <span class="token operator">=</span> id<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token constant">PROXY_SUFFIX</span><span class="token punctuation">.</span>length<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token comment">//我们知道ModuleInfo.hasDefaultExport是可靠的，因为我们在等待在resolveId中的this.load</span></span>
<span class="line">        <span class="token comment">// We know ModuleInfo.hasDefaultExport is reliable because we awaited this.load in resolveId</span></span>
<span class="line">        <span class="token keyword">const</span> <span class="token punctuation">{</span> hasDefaultExport <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getModuleInfo</span><span class="token punctuation">(</span>entryId<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">let</span> code <span class="token operator">=</span></span>
<span class="line">          <span class="token template-string"><span class="token template-punctuation string">\`</span><span class="token string">import </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">\${</span><span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span><span class="token constant">POLYFILL_ID</span><span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">;</span><span class="token template-punctuation string">\`</span></span> <span class="token operator">+</span> <span class="token template-string"><span class="token template-punctuation string">\`</span><span class="token string">export * from </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">\${</span><span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>entryId<span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">;</span><span class="token template-punctuation string">\`</span></span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token comment">//命名空间重新导出不会重新导出默认值，因此我们需要在这里进行特殊处理</span></span>
<span class="line">        <span class="token keyword">if</span> <span class="token punctuation">(</span>hasDefaultExport<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">          code <span class="token operator">+=</span> <span class="token template-string"><span class="token template-punctuation string">\`</span><span class="token string">export { default } from </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">\${</span><span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>entryId<span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">;</span><span class="token template-punctuation string">\`</span></span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">        <span class="token keyword">return</span> code<span class="token punctuation">;</span></span>
<span class="line">      <span class="token punctuation">}</span></span>
<span class="line">      <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">  <span class="token punctuation">}</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_2-2-7-load" tabindex="-1"><a class="header-anchor" href="#_2-2-7-load"><span>2.2.7 load</span></a></h4><table><thead><tr><th style="text-align:left;">字段</th><th style="text-align:left;">值</th></tr></thead><tbody><tr><td style="text-align:left;"></td><td style="text-align:left;">(id) =&gt; string</td></tr><tr><td style="text-align:left;">Kind</td><td style="text-align:left;">async, first</td></tr><tr><td style="text-align:left;">Previous Hook</td><td style="text-align:left;">解析加载id的<code>resolveId</code>或<code>resolveDynamicImport</code>。此外，这个钩子可以在任何时候从插件钩子中通过调用<code>this.load</code>来触发预加载与id对应的模块</td></tr><tr><td style="text-align:left;">Next Hook</td><td style="text-align:left;"><code>transform</code>可在未使用缓存或没有使用相同代码的缓存副本时转换加载的文件，否则应使用<code>TransformCachedModule</code></td></tr></tbody></table><ul><li>定义自定义加载程序</li><li>返回<code>null</code>会推迟到其他加载函数（最终是从文件系统加载的默认行为）</li><li>为了防止额外的解析开销，例如这个钩子已经使用了这个。parse出于某种原因，为了生成AST，这个钩子可以选择性地返回<code>{code，AST，map}</code>对象。<code>ast</code>必须是标准的<code>ESTree ast</code>，每个节点都有开始和结束属性。如果转换不移动代码，可以通过将map设置为null来保留现有的sourcemaps。否则，您可能需要生成源映射。请参阅关于源代码转换的部分</li></ul><h4 id="_2-2-8-transform" tabindex="-1"><a class="header-anchor" href="#_2-2-8-transform"><span>2.2.8 transform</span></a></h4><table><thead><tr><th style="text-align:left;">字段</th><th style="text-align:left;">值</th></tr></thead><tbody><tr><td style="text-align:left;">Type</td><td style="text-align:left;">(code, id) =&gt; string</td></tr><tr><td style="text-align:left;">Kind</td><td style="text-align:left;">async, sequential</td></tr><tr><td style="text-align:left;">Previous Hook</td><td style="text-align:left;"><code>load</code> 当前处理的文件的位置。如果使用了缓存，并且有该模块的缓存副本，那么如果插件为该钩子返回true，则应<code>shouldTransformCachedModule</code></td></tr><tr><td style="text-align:left;">Next Hook</td><td style="text-align:left;"><code>moduleParsed</code> 一旦文件被处理和解析，模块就会被解析</td></tr></tbody></table><ul><li>可用于转换单个模块</li><li>为了防止额外的解析开销，例如这个钩子已经使用了<code>this.parse</code>出于某种原因，为了生成AST</li><li>这个钩子可以选择性地返回<code>{code，AST，map}</code>对象</li><li>ast必须是标准的ESTree ast，每个节点都有<code>start</code>和<code>end</code>属性</li><li>如果转换不移动代码，可以通过将map设置为null来保留现有的sourcemaps。否则，您可能需要生成源映射。请参阅关于源代码转换的部分</li></ul><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text"><pre><code class="language-text"><span class="line">npm install rollup-pluginutils @rollup/plugin-babel @babel/core @babel/preset-env  -D</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><pre><code>plugins\\rollup-plugin-babel.js
\`\`\`js
import { createFilter } from &#39;rollup-pluginutils&#39;
import babel from &#39;@babel/core&#39;
function plugin(pluginOptions = {}) {
  const defaultExtensions = [&#39;.js&#39;, &#39;.jsx&#39;]
  const { exclude, include, extensions = defaultExtensions } = pluginOptions;
  const extensionRegExp = new RegExp(\`(\${extensions.join(&#39;|&#39;)})$\`)
  const userDefinedFilter = createFilter(include, exclude);
  const filter = id =&gt; extensionRegExp.test(id) &amp;&amp; userDefinedFilter(id);
  return {
    name: &#39;babel&#39;,
    async transform(code, filename) {
      if (!filter(filename)) return null;
      let result = await babel.transformAsync(code);
      return result
    }
  }
}
export default plugin
</code></pre><h4 id="_2-2-9-shouldtransformcachedmodule" tabindex="-1"><a class="header-anchor" href="#_2-2-9-shouldtransformcachedmodule"><span>2.2.9 shouldTransformCachedModule</span></a></h4><table><thead><tr><th style="text-align:left;">字段</th><th style="text-align:left;">值</th></tr></thead><tbody><tr><td style="text-align:left;">Type</td><td style="text-align:left;">({id, code, ast, resoledSources, moduleSideEffects, syntheticNamedExports) =&gt; boolean</td></tr><tr><td style="text-align:left;">Kind: async, first</td><td style="text-align:left;"></td></tr><tr><td style="text-align:left;">Previous Hook</td><td style="text-align:left;"><code>load</code> 加载缓存文件以将其代码与缓存版本进行比较的位置</td></tr><tr><td style="text-align:left;">Next Hook</td><td style="text-align:left;"><code>moduleParsed</code> if no plugin returns true, otherwise <code>transform</code>.</td></tr></tbody></table><ul><li>如果使用了<code>Rollup</code>缓存（例如，在监视模式下或通过JavaScript API显式使用），如果在加载钩子之后，加载的代码与缓存副本的代码相同，则Rollup将跳过模块的转换钩子</li><li>为了防止这种情况，丢弃缓存的副本，而是转换一个模块，插件可以实现这个钩子并返回true。</li><li>这个钩子还可以用来找出缓存了哪些模块，并访问它们缓存的元信息</li><li>如果一个插件没有返回true，Rollup将触发其他插件的这个钩子，否则将跳过所有剩余的插件。</li></ul><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text"><pre><code class="language-text"><span class="line">npx rollup -c -w</span>
<span class="line">shouldTransformCachedModule</span>
<span class="line">transform</span>
<span class="line">moduleParsed</span>
<span class="line"></span>
<span class="line">shouldTransformCachedModule</span>
<span class="line">moduleParsed</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_2-2-10-moduleparsed" tabindex="-1"><a class="header-anchor" href="#_2-2-10-moduleparsed"><span>2.2.10 moduleParsed</span></a></h4><table><thead><tr><th style="text-align:left;">字段</th><th style="text-align:left;">值</th></tr></thead><tbody><tr><td style="text-align:left;">Type</td><td style="text-align:left;">(moduleInfo: ModuleInfo) =&gt; void</td></tr><tr><td style="text-align:left;">Kind: async, parallel</td><td style="text-align:left;"></td></tr><tr><td style="text-align:left;">Previous Hook</td><td style="text-align:left;"><code>transform</code> 转换当前处理的文件的位置</td></tr><tr><td style="text-align:left;">Next Hook</td><td style="text-align:left;"><code>resolveId</code> 和 <code>resolveDynamicImport</code> 并行解析所有发现的静态和动态导入（如果存在），否则buildEnd</td></tr></tbody></table><ul><li>每当模块被<code>Rollup</code>完全解析时，就会调用这个钩子。看看<code>this.getModuleInfo</code>了解传递给这个钩子的信息</li><li>与<code>transform</code>钩子不同，这个钩子从不缓存，可以用来获取缓存模块和其他模块的信息，包括元属性的最终形状、代码和ast</li></ul><h4 id="_2-2-10-resolvedynamicimport" tabindex="-1"><a class="header-anchor" href="#_2-2-10-resolvedynamicimport"><span>2.2.10 resolveDynamicImport</span></a></h4><table><thead><tr><th style="text-align:left;">字段</th><th style="text-align:left;">值</th></tr></thead><tbody><tr><td style="text-align:left;">Type</td><td style="text-align:left;">(specifier, importer) =&gt; string</td></tr><tr><td style="text-align:left;">Kind</td><td style="text-align:left;">async, first</td></tr><tr><td style="text-align:left;">Previous Hook</td><td style="text-align:left;"><code>moduleParsed</code> 已为导入文件分配模块</td></tr><tr><td style="text-align:left;">Next Hook</td><td style="text-align:left;"><code>load</code> 如果钩子使用尚未加载的id ,如果动态导入包含字符串且钩子未解析，请加载<code>resolveId</code>，否则为<code>buildEnd</code></td></tr></tbody></table><ul><li>为动态导入定义自定义解析程序</li><li>返回<code>false</code>表明导入应该保持原样，而不是传递给其他解析程序，从而使其成为外部的</li><li>与<code>resolveId</code>钩子类似，还可以返回一个对象，将导入解析为不同的id，同时将其标记为外部</li><li>如果动态导入被传递一个字符串作为参数，那么从这个钩子返回的字符串将被解释为一个现有的模块id，而返回null将推迟到其它解析器resolveId</li></ul><p>index.js</p><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code class="language-javascript"><span class="line"><span class="token keyword">import</span><span class="token punctuation">(</span><span class="token string">&#39;./msg.js&#39;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">res</span> <span class="token operator">=&gt;</span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span><span class="token punctuation">)</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><h4 id="_2-2-11-buildend" tabindex="-1"><a class="header-anchor" href="#_2-2-11-buildend"><span>2.2.11 buildEnd</span></a></h4><table><thead><tr><th style="text-align:left;">字段</th><th style="text-align:left;">值</th></tr></thead><tbody><tr><td style="text-align:left;">Type</td><td style="text-align:left;">(error) =&gt; void</td></tr><tr><td style="text-align:left;">Kind</td><td style="text-align:left;">async, parallel</td></tr><tr><td style="text-align:left;">Previous Hook</td><td style="text-align:left;">moduleParsed, resolveId or resolveDynamicImport.</td></tr><tr><td style="text-align:left;">Next Hook</td><td style="text-align:left;">outputOptions 输出生成阶段的输出，因为这是构建阶段的最后一个挂钩</td></tr></tbody></table><ul><li>在<code>rollup</code>完成打包时调用，但在调用<code>generate</code>或<code>write</code>之前调用；你也可以返回一个<code>Promise</code></li><li>如果在构建过程中发生错误，则会将其传递给此钩子</li></ul><h3 id="_2-3-output-generation-hooks" tabindex="-1"><a class="header-anchor" href="#_2-3-output-generation-hooks"><span>2.3 Output Generation Hooks</span></a></h3><ul><li>输出生成钩子可以提供有关生成的包的信息，并在完成后修改构建</li><li>输出生成阶段的第一个钩子是<code>outputOptions</code>，最后一个钩子要么<code>generateBundle</code>是通过成功生成输出</li><li>或者在输出生成过程中的任何时候发生错误 <code>renderError</code></li><li>此外，<code>closeBundle</code>可以作为最后一个钩子调用，但用户有责任手动调用<code>bundle.close()</code>以触发此钩子</li></ul><h4 id="_2-3-1-rollup-plugin-generation-js" tabindex="-1"><a class="header-anchor" href="#_2-3-1-rollup-plugin-generation-js"><span>2.3.1 rollup-plugin-generation.js</span></a></h4><p>plugins\\rollup-plugin-generation.js</p><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code class="language-javascript"><span class="line"><span class="token keyword">function</span> <span class="token function">generation</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">  <span class="token keyword">return</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">&#39;rollup-plugin-generation&#39;</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token comment">//这个钩子是同步的，不能加async</span></span>
<span class="line">    <span class="token function">outputOptions</span><span class="token punctuation">(</span><span class="token parameter">outputOptions</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&#39;outputOptions&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token function">renderStart</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&#39;renderStart&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token function">banner</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&#39;banner&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token function">footer</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&#39;footer&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token function">intro</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&#39;intro&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token function">outro</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&#39;outro&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token function">renderDynamicImport</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&#39;renderDynamicImport&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token function">augmentChunkHash</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&#39;augmentChunkHash&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token function">resolveFileUrl</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&#39;resolveFileUrl&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token function">resolveImportMeta</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&#39;resolveImportMeta&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token function">renderChunk</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&#39;renderChunk&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token function">generateBundle</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&#39;generateBundle&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token function">writeBundle</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&#39;writeBundle&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token function">renderError</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&#39;renderError&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token function">closeBundle</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&#39;closeBundle&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">  <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"><span class="token keyword">export</span> <span class="token keyword">default</span> generation<span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_2-3-2-rollup-config-js" tabindex="-1"><a class="header-anchor" href="#_2-3-2-rollup-config-js"><span>2.3.2 rollup.config.js</span></a></h4><p>rollup.config.js</p><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text"><pre><code class="language-text"><span class="line">import build from &#39;./plugins/rollup-plugin-build.js&#39;;</span>
<span class="line">+import generation from &#39;./plugins/rollup-plugin-generation.js&#39;;</span>
<span class="line">export default {</span>
<span class="line">  input: &quot;./src/index.js&quot;,</span>
<span class="line">  output: [{</span>
<span class="line">    dir: &#39;dist&#39;,</span>
<span class="line">  }],</span>
<span class="line">  plugins: [</span>
<span class="line">    build(),</span>
<span class="line">+   generation()</span>
<span class="line">  ]</span>
<span class="line">}</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_2-3-3-outputoptions" tabindex="-1"><a class="header-anchor" href="#_2-3-3-outputoptions"><span>2.3.3 outputOptions</span></a></h4><table><thead><tr><th style="text-align:left;">字段</th><th style="text-align:left;">值</th></tr></thead><tbody><tr><td style="text-align:left;">Type</td><td style="text-align:left;">(outputOptions) =&gt; null</td></tr><tr><td style="text-align:left;">Kind</td><td style="text-align:left;">async, parallel</td></tr><tr><td style="text-align:left;">Previous Hook</td><td style="text-align:left;"><code>buildEnd</code>如果这是第一次生成输出，否则为<code>generateBundle</code>，<code>writeBundle</code>或<code>renderError</code>取决于先前生成的输出。这是输出生成阶段的第一个钩子</td></tr><tr><td style="text-align:left;">Next Hook</td><td style="text-align:left;"><code>outputOptions</code> 输出生成阶段的输出，因为这是构建阶段的最后一个挂钩</td></tr></tbody></table><ul><li>替换或操作传递给<code>bundle.generate()</code>的输出选项对象<code>bundle.write()</code></li><li>返回<code>null</code>并不能代替任何东西</li><li>如果您只需要读取输出选项，建议使用<code>renderStart</code>钩子，因为在考虑<code>renderStart</code>所有钩子的转换后，此钩子可以访问输出选项</li></ul><h4 id="_2-3-4-renderstart" tabindex="-1"><a class="header-anchor" href="#_2-3-4-renderstart"><span>2.3.4 renderStart</span></a></h4><table><thead><tr><th style="text-align:left;">字段</th><th style="text-align:left;">值</th></tr></thead><tbody><tr><td style="text-align:left;">Type</td><td style="text-align:left;">(outputOptions, inputOptions) =&gt; void</td></tr><tr><td style="text-align:left;">种类</td><td style="text-align:left;">async, parallel</td></tr><tr><td style="text-align:left;">上一个钩子</td><td style="text-align:left;">outputOptions</td></tr><tr><td style="text-align:left;">下一个钩子</td><td style="text-align:left;">banner, footer, intro and outro 并行运行</td></tr></tbody></table><ul><li>每次初始调用<code>bundle.generate()</code>或被<code>bundle.write()</code>调用</li><li>要在生成完成时收到通知，请使用<code>generateBundle</code>和<code>renderError</code>挂钩</li><li>当您需要访问传递给的输出选项时，建议使用此挂钩.<code>bundle.generate()</code>或者<code>bundle.write()</code>因为它考虑了所有<code>outputOptions</code>挂钩的转换，并且还包含未设置选项的正确默认值。它还接收传递给的输入选项</li></ul><h4 id="_2-3-5-banner" tabindex="-1"><a class="header-anchor" href="#_2-3-5-banner"><span>2.3.5 banner</span></a></h4><table><thead><tr><th style="text-align:left;">字段</th><th style="text-align:left;">值</th></tr></thead><tbody><tr><td style="text-align:left;">Type</td><td style="text-align:left;">string</td></tr><tr><td style="text-align:left;">Kind</td><td style="text-align:left;">async, parallel</td></tr><tr><td style="text-align:left;">Previous Hook</td><td style="text-align:left;">renderStart</td></tr><tr><td style="text-align:left;">Next Hook</td><td style="text-align:left;">针对每个动态导入表达式 <code>renderDynamicImport</code></td></tr></tbody></table><h4 id="_2-3-6-footer" tabindex="-1"><a class="header-anchor" href="#_2-3-6-footer"><span>2.3.6 footer</span></a></h4><table><thead><tr><th style="text-align:left;">字段</th><th style="text-align:left;">值</th></tr></thead><tbody><tr><td style="text-align:left;">Type</td><td style="text-align:left;">string</td></tr><tr><td style="text-align:left;">Kind</td><td style="text-align:left;">async, parallel</td></tr><tr><td style="text-align:left;">Previous Hook</td><td style="text-align:left;">renderStart</td></tr><tr><td style="text-align:left;">Next Hook</td><td style="text-align:left;">针对每个动态导入表达式 <code>renderDynamicImport</code></td></tr></tbody></table><h4 id="_2-3-7-intro" tabindex="-1"><a class="header-anchor" href="#_2-3-7-intro"><span>2.3.7 intro</span></a></h4><table><thead><tr><th style="text-align:left;">字段</th><th style="text-align:left;">值</th></tr></thead><tbody><tr><td style="text-align:left;">Type</td><td style="text-align:left;">string</td></tr><tr><td style="text-align:left;">Kind</td><td style="text-align:left;">async, parallel</td></tr><tr><td style="text-align:left;">Previous Hook</td><td style="text-align:left;">renderStart</td></tr><tr><td style="text-align:left;">Next Hook</td><td style="text-align:left;">针对每个动态导入表达式 <code>renderDynamicImport</code></td></tr></tbody></table><h4 id="_2-3-8-outro" tabindex="-1"><a class="header-anchor" href="#_2-3-8-outro"><span>2.3.8 outro</span></a></h4><table><thead><tr><th style="text-align:left;">字段</th><th style="text-align:left;">值</th></tr></thead><tbody><tr><td style="text-align:left;">Type</td><td style="text-align:left;">string</td></tr><tr><td style="text-align:left;">Kind</td><td style="text-align:left;">async, parallel</td></tr><tr><td style="text-align:left;">Previous Hook</td><td style="text-align:left;">renderStart</td></tr><tr><td style="text-align:left;">Next Hook</td><td style="text-align:left;">针对每个动态导入表达式 <code>renderDynamicImport</code></td></tr></tbody></table><h4 id="_2-3-9-renderdynamicimport" tabindex="-1"><a class="header-anchor" href="#_2-3-9-renderdynamicimport"><span>2.3.9 renderDynamicImport</span></a></h4><table><thead><tr><th style="text-align:left;">字段</th><th style="text-align:left;">值</th></tr></thead><tbody><tr><td style="text-align:left;">Type</td><td style="text-align:left;">({format, moduleId, targetModuleId, customResolution}) =&gt; {left: string, right: string}</td></tr><tr><td style="text-align:left;">Kind</td><td style="text-align:left;">async, parallel</td></tr><tr><td style="text-align:left;">Previous Hook</td><td style="text-align:left;">banner , footer, intro, outro</td></tr><tr><td style="text-align:left;">Next Hook</td><td style="text-align:left;"><code>augmentChunkHash</code>对于每个在文件名中包含哈希的块</td></tr></tbody></table><ul><li>这个钩子提供了对如何呈现动态导入的细粒度控制</li><li>方法是替换导入表达式参数的左侧 ( import() 和右侧 ( ) 的代码。)</li><li>返回null延迟到此类型的其他钩子并最终呈现特定于格式的默认值</li><li>format是渲染的输出格式</li><li>moduleId执行动态导入的模块的 id</li><li>如果导入可以解析为内部或外部 id，targetModuleId则将设置为此 id，否则将为null</li></ul><p>plugins\\rollup-plugin-renderDynamicImport.js</p><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code class="language-javascript"><span class="line"><span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">function</span> <span class="token function">dynamicImportPolyfillPlugin</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">  <span class="token keyword">return</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">&#39;dynamic-import-polyfill&#39;</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token function">renderDynamicImport</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">      <span class="token keyword">return</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token literal-property property">left</span><span class="token operator">:</span> <span class="token string">&#39;dynamicImportPolyfill(&#39;</span><span class="token punctuation">,</span></span>
<span class="line">        <span class="token literal-property property">right</span><span class="token operator">:</span> <span class="token string">&#39;, import.meta.url)&#39;</span></span>
<span class="line">      <span class="token punctuation">}</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">  <span class="token punctuation">}</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code class="language-javascript"><span class="line"><span class="token function">dynamicImportPolyfill</span><span class="token punctuation">(</span><span class="token string">&#39;./msg-ca034dda.js&#39;</span><span class="token punctuation">,</span> <span class="token keyword">import</span><span class="token punctuation">.</span>meta<span class="token punctuation">.</span>url<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">res</span> <span class="token operator">=&gt;</span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>res<span class="token punctuation">.</span>default<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">function</span> <span class="token function">dynamicImportPolyfill</span><span class="token punctuation">(</span><span class="token parameter">filename<span class="token punctuation">,</span> url</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">  <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">const</span> script <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">&quot;script&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    script<span class="token punctuation">.</span>type <span class="token operator">=</span> <span class="token string">&quot;module&quot;</span><span class="token punctuation">;</span></span>
<span class="line">    script<span class="token punctuation">.</span><span class="token function-variable function">onload</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></span>
<span class="line">      <span class="token function">resolve</span><span class="token punctuation">(</span>window<span class="token punctuation">.</span>mod<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">const</span> absURL <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">URL</span><span class="token punctuation">(</span>filename<span class="token punctuation">,</span> url<span class="token punctuation">)</span><span class="token punctuation">.</span>href<span class="token punctuation">;</span></span>
<span class="line">    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>absURL<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">const</span> blob <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Blob</span><span class="token punctuation">(</span><span class="token punctuation">[</span></span>
<span class="line">      <span class="token template-string"><span class="token template-punctuation string">\`</span><span class="token string">import * as mod from &quot;</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">\${</span>absURL<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&quot;;</span><span class="token template-punctuation string">\`</span></span><span class="token punctuation">,</span></span>
<span class="line">      <span class="token template-string"><span class="token template-punctuation string">\`</span><span class="token string"> window.mod = mod;</span><span class="token template-punctuation string">\`</span></span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token string">&quot;text/javascript&quot;</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    script<span class="token punctuation">.</span>src <span class="token operator">=</span> <span class="token constant">URL</span><span class="token punctuation">.</span><span class="token function">createObjectURL</span><span class="token punctuation">(</span>blob<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    document<span class="token punctuation">.</span>head<span class="token punctuation">.</span><span class="token function">appendChild</span><span class="token punctuation">(</span>script<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_2-3-9-augmentchunkhash" tabindex="-1"><a class="header-anchor" href="#_2-3-9-augmentchunkhash"><span>2.3.9 augmentChunkHash</span></a></h4><table><thead><tr><th style="text-align:left;">字段</th><th style="text-align:left;">值</th></tr></thead><tbody><tr><td style="text-align:left;">Type</td><td style="text-align:left;">(chunkInfo: ChunkInfo) =&gt; string</td></tr><tr><td style="text-align:left;">Kind</td><td style="text-align:left;">sync, sequential</td></tr><tr><td style="text-align:left;">Previous Hook</td><td style="text-align:left;">renderDynamicImport针对每个动态导入表达式</td></tr><tr><td style="text-align:left;">Next Hook</td><td style="text-align:left;"><code>resolveFileUrl</code>对于每次使用<code>import.meta.ROLLUP_FILE_URL_referenceId</code>和<code>resolveImportMeta</code>所有其他访问<code>import.meta</code></td></tr></tbody></table><ul><li>可用于增加单个块的散列</li><li>为每个<code>Rollup</code>输出块调用</li><li>返回一个<code>false</code>值不会修改散列</li><li>真实值将传递给<code>hash.update</code>.</li><li>这<code>chunkInfo</code>是<code>generateBundle</code>不依赖文件名的属性的简化版本</li></ul><h4 id="_2-3-10-resolvefileurl" tabindex="-1"><a class="header-anchor" href="#_2-3-10-resolvefileurl"><span>2.3.10 resolveFileUrl</span></a></h4><ul><li><a href="https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Statements/import.meta" target="_blank" rel="noopener noreferrer">import.meta</a>是一个给JavaScript模块暴露特定上下文的元数据属性的对象。它包含了这个模块的信息，比如说这个模块的URL。</li></ul><table><thead><tr><th style="text-align:left;">字段</th><th style="text-align:left;">值</th></tr></thead><tbody><tr><td style="text-align:left;">Type</td><td style="text-align:left;">({chunkId, fileName, format, moduleId, referenceId, relativePath}) =&gt; string</td></tr><tr><td style="text-align:left;">Kind</td><td style="text-align:left;">sync, first</td></tr><tr><td style="text-align:left;">Previous Hook</td><td style="text-align:left;"><code>augmentChunkHash</code>对于在文件名中包含哈希的每个块</td></tr><tr><td style="text-align:left;">Next Hook</td><td style="text-align:left;"><code>renderChunk</code>对于每个块</td></tr></tbody></table><ul><li>允许自定义Rollup如何解析插件通过此链接发出的文件的URL<code>this.emitFile</code></li><li>默认情况下，Rollup 将生成代码</li><li><code>import.meta.ROLLUP_FILE_URL_referenceId</code>该代码应正确生成发出文件的绝对URL，而与输出格式和部署代码的主机系统无关</li></ul><p>src\\index.js</p><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code class="language-javascript"><span class="line"><span class="token keyword">import</span> logger <span class="token keyword">from</span> <span class="token string">&#39;logger&#39;</span></span>
<span class="line">console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>logger<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div></div></div><p>plugins\\rollup-plugin-resolveFileUrl.js</p><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code class="language-javascript"><span class="line"><span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">function</span> <span class="token function">resolveFileUrl</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">  <span class="token keyword">return</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">&#39;resolveFileUrl&#39;</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token function">resolveId</span><span class="token punctuation">(</span><span class="token parameter">source</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">      <span class="token keyword">if</span> <span class="token punctuation">(</span>source <span class="token operator">===</span> <span class="token string">&#39;logger&#39;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">return</span> source<span class="token punctuation">;</span></span>
<span class="line">      <span class="token punctuation">}</span></span>
<span class="line">    <span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token function">load</span><span class="token punctuation">(</span><span class="token parameter">importee</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">      <span class="token keyword">if</span> <span class="token punctuation">(</span>importee <span class="token operator">===</span> <span class="token string">&#39;logger&#39;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">let</span> referenceId <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">emitFile</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token string">&#39;asset&#39;</span><span class="token punctuation">,</span> <span class="token literal-property property">source</span><span class="token operator">:</span> <span class="token string">&#39;console.log(&quot;logger&quot;)&#39;</span><span class="token punctuation">,</span> <span class="token literal-property property">fileName</span><span class="token operator">:</span> <span class="token string">&quot;logger.js&quot;</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">return</span> <span class="token template-string"><span class="token template-punctuation string">\`</span><span class="token string">export default import.meta.ROLLUP_FILE_URL_</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">\${</span>referenceId<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">\`</span></span><span class="token punctuation">;</span></span>
<span class="line">      <span class="token punctuation">}</span></span>
<span class="line">    <span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token function">resolveFileUrl</span><span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> chunkId<span class="token punctuation">,</span> fileName<span class="token punctuation">,</span> format<span class="token punctuation">,</span> moduleId<span class="token punctuation">,</span> referenceId<span class="token punctuation">,</span> relativePath <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token comment">//import.meta.url</span></span>
<span class="line">      <span class="token keyword">return</span> <span class="token template-string"><span class="token template-punctuation string">\`</span><span class="token string">new URL(&#39;</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">\${</span>fileName<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&#39;, document.baseURI).href</span><span class="token template-punctuation string">\`</span></span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">  <span class="token punctuation">}</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_2-3-11-resolveimportmeta" tabindex="-1"><a class="header-anchor" href="#_2-3-11-resolveimportmeta"><span>2.3.11 resolveImportMeta</span></a></h4><table><thead><tr><th style="text-align:left;">字段</th><th style="text-align:left;">值</th></tr></thead><tbody><tr><td style="text-align:left;">Type</td><td style="text-align:left;">(property, {chunkId, moduleId, format}) =&gt; string</td></tr><tr><td style="text-align:left;">Kind</td><td style="text-align:left;">sync, first</td></tr><tr><td style="text-align:left;">Previous Hook</td><td style="text-align:left;"><code>augmentChunkHash</code>对于在文件名中包含哈希的每个块</td></tr><tr><td style="text-align:left;">Next Hook</td><td style="text-align:left;"><code>renderChunk</code>对于每个块</td></tr></tbody></table><ul><li>允许自定义 Rollup 如何处理<code>import.meta</code>,<code>import.meta.someProperty</code>特别是<code>import.meta.url</code></li><li>在 ES 模块中，<code>import.meta</code>是一个对象，<code>import.meta.url</code>包含当前模块的 URL</li></ul><h4 id="_2-3-12-renderchunk" tabindex="-1"><a class="header-anchor" href="#_2-3-12-renderchunk"><span>2.3.12 renderChunk</span></a></h4><table><thead><tr><th style="text-align:left;">字段</th><th style="text-align:left;">值</th></tr></thead><tbody><tr><td style="text-align:left;">Type</td><td style="text-align:left;">(code, chunk, options) =&gt; string</td></tr><tr><td style="text-align:left;">Kind</td><td style="text-align:left;">async, sequential</td></tr><tr><td style="text-align:left;">Previous Hook</td><td style="text-align:left;"><code>resolveFileUrl</code>对于 . 的每次使用<code>import.meta.ROLLUP_FILE_URL_referenceId</code>和<code>resolveImportMeta</code>所有其他访问<code>import.meta</code></td></tr><tr><td style="text-align:left;">Next Hook</td><td style="text-align:left;"><code>generateBundle</code></td></tr></tbody></table><ul><li>可用于转换单个块</li><li>为每个<code>rollup</code>输出块文件调用。返回null将不应用任何转换</li></ul><h4 id="_2-3-13-generatebundle" tabindex="-1"><a class="header-anchor" href="#_2-3-13-generatebundle"><span>2.3.13 generateBundle</span></a></h4><table><thead><tr><th style="text-align:left;">字段</th><th style="text-align:left;">值</th></tr></thead><tbody><tr><td style="text-align:left;">Type</td><td style="text-align:left;">(options, bundle, isWrite) =&gt; void</td></tr><tr><td style="text-align:left;">Kind</td><td style="text-align:left;">async, sequential</td></tr><tr><td style="text-align:left;">Previous Hook</td><td style="text-align:left;">renderChunk对于每个块</td></tr><tr><td style="text-align:left;">Next Hook</td><td style="text-align:left;"><code>writeBundle</code>如果输出是通过生成的，否则这是输出生成阶段的最后一个钩子，如果生成另一个输出<code>bundle.write()</code>，可能会再次跟随<code>outputOptions</code></td></tr></tbody></table><ul><li>在<code>bundle.generate()</code>之后调用</li><li>或者在 <code>bundle.write()</code>把文件写入之前调用</li><li>要在写入文件后修改文件，请使用<code>writeBundle</code>挂钩</li><li><code>writeBundle</code>提供正在写入或生成的文件的完整列表及其详细信息</li><li>您可以通过从该钩子中的捆绑对象中删除文件来防止发出文件。要发出其他文件，请使用<code>this.emitFile</code>插件上下文功能</li></ul><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text"><pre><code class="language-text"><span class="line">npm i dedent</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p>plugins\\rollup-plugin-html.js</p><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code class="language-javascript"><span class="line"><span class="token keyword">import</span> dedent <span class="token keyword">from</span> <span class="token string">&#39;dedent&#39;</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">function</span> <span class="token function">html</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">  <span class="token keyword">return</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">&#39;html&#39;</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token function">generateBundle</span><span class="token punctuation">(</span><span class="token parameter">options<span class="token punctuation">,</span> bundle</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">      <span class="token keyword">let</span> entryName<span class="token punctuation">;</span></span>
<span class="line">      <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> fileName <span class="token keyword">in</span> bundle<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">let</span> assetOrChunkInfo <span class="token operator">=</span> bundle<span class="token punctuation">[</span>fileName<span class="token punctuation">]</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token comment">//console.log(fileName, assetOrChunkInfo);</span></span>
<span class="line">        <span class="token keyword">if</span> <span class="token punctuation">(</span>assetOrChunkInfo<span class="token punctuation">.</span>isEntry<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">          entryName <span class="token operator">=</span> fileName<span class="token punctuation">;</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">      <span class="token punctuation">}</span></span>
<span class="line">      <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">emitFile</span><span class="token punctuation">(</span><span class="token punctuation">{</span></span>
<span class="line">        <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token string">&#39;asset&#39;</span><span class="token punctuation">,</span></span>
<span class="line">        <span class="token literal-property property">fileName</span><span class="token operator">:</span> <span class="token string">&#39;index.html&#39;</span><span class="token punctuation">,</span></span>
<span class="line">        <span class="token literal-property property">source</span><span class="token operator">:</span> dedent<span class="token template-string"><span class="token template-punctuation string">\`</span><span class="token string"></span>
<span class="line">        &lt;!DOCTYPE html&gt;</span>
<span class="line">        &lt;html&gt;</span>
<span class="line">        &lt;head&gt;</span>
<span class="line">          &lt;meta charset=&quot;UTF-8&quot;&gt;</span>
<span class="line">          &lt;title&gt;rollup&lt;/title&gt;</span>
<span class="line">         &lt;/head&gt;</span>
<span class="line">        &lt;body&gt;</span>
<span class="line">          &lt;script src=&quot;</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">\${</span>entryName<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&quot; type=&quot;module&quot;&gt;&lt;/script&gt;</span>
<span class="line">        &lt;/body&gt;</span>
<span class="line">        &lt;/html&gt;</span><span class="token template-punctuation string">\`</span></span></span>
<span class="line">      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">  <span class="token punctuation">}</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_2-3-14-writebundle" tabindex="-1"><a class="header-anchor" href="#_2-3-14-writebundle"><span>2.3.14 writeBundle</span></a></h4><table><thead><tr><th style="text-align:left;">字段</th><th style="text-align:left;">值</th></tr></thead><tbody><tr><td style="text-align:left;">Type</td><td style="text-align:left;">(options,bundle) =&gt; void</td></tr><tr><td style="text-align:left;">Kind</td><td style="text-align:left;">async, parallel</td></tr><tr><td style="text-align:left;">Previous Hook</td><td style="text-align:left;">generateBundle</td></tr><tr><td style="text-align:left;">Next Hook</td><td style="text-align:left;">如果被调用，这是输出生成阶段的最后一个钩子，如果生成另一个输出，可能会再次跟随<code>outputOptions</code></td></tr></tbody></table><ul><li><code>bundle.write()</code>仅在写入所有文件后才调用</li><li>与<code>generateBundle</code>钩子类似，<code>bundle</code>提供正在写入的文件的完整列表及其详细信息</li></ul><h4 id="_2-3-15-rendererror" tabindex="-1"><a class="header-anchor" href="#_2-3-15-rendererror"><span>2.3.15 renderError</span></a></h4><table><thead><tr><th style="text-align:left;">字段</th><th style="text-align:left;">值</th></tr></thead><tbody><tr><td style="text-align:left;">Type</td><td style="text-align:left;">(error: Error) =&gt; void</td></tr><tr><td style="text-align:left;">Kind</td><td style="text-align:left;">async, parallel</td></tr><tr><td style="text-align:left;">Previous Hook</td><td style="text-align:left;">renderStart从到 的任何钩子renderChunk</td></tr><tr><td style="text-align:left;">Next Hook</td><td style="text-align:left;"><code>outputOptions</code>如果它被调用，这是输出生成阶段的最后一个钩子，如果生成另一个输出，可能会再次跟随</td></tr></tbody></table><ul><li><code>bundle.generate()</code>当 rollup 在或期间遇到错误时调用<code>bundle.write()</code></li><li>错误被传递给这个钩子。要在生成成功完成时收到通知，请使用<code>generateBundle</code>钩子</li></ul><h4 id="_2-3-16-closebundle" tabindex="-1"><a class="header-anchor" href="#_2-3-16-closebundle"><span>2.3.16 closeBundle</span></a></h4><table><thead><tr><th style="text-align:left;">字段</th><th style="text-align:left;">值</th></tr></thead><tbody><tr><td style="text-align:left;">Type</td><td style="text-align:left;">closeBundle: () =&gt; Promise</td></tr><tr><td style="text-align:left;">Kind</td><td style="text-align:left;">async, parallel</td></tr><tr><td style="text-align:left;">Previous Hook</td><td style="text-align:left;"><code>buildEnd</code> 如果有构建错误.否则何时bundle.close()被调用，在这种情况下，这将是最后一个被触发的钩子。</td></tr></tbody></table><ul><li>可用于清理可能正在运行的任何外部服务</li><li><code>Rollup</code> 的 <code>CLI</code> 将确保在每次运行后调用此钩子</li><li>但 <code>JavaScript API</code> 的用户有责任在<code>bundle.close()</code>他们完成生成包后手动调用</li></ul><h2 id="_3-plugin-context" tabindex="-1"><a class="header-anchor" href="#_3-plugin-context"><span>3.Plugin Context</span></a></h2><h3 id="_3-1-this-emitfile" tabindex="-1"><a class="header-anchor" href="#_3-1-this-emitfile"><span>3.1 this.emitFile</span></a></h3><ul><li>[thisemitfile](https://rollupjs.org/guide/en/</li><li>Type: (emittedFile: EmittedChunk | EmittedAsset) =&gt; string</li><li>发出一个包含在生成输出中的新文件，并返回一个referenceId，该ID可在不同位置用于引用发出的文件</li><li>emittedFile 可以有两种形式之一</li></ul><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code class="language-javascript"><span class="line">type EmittedChunk <span class="token operator">=</span> <span class="token punctuation">{</span></span>
<span class="line">  <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token string">&#39;chunk&#39;</span><span class="token punctuation">;</span></span>
<span class="line">  <span class="token literal-property property">id</span><span class="token operator">:</span> string<span class="token punctuation">;</span></span>
<span class="line">  name<span class="token operator">?</span><span class="token operator">:</span> string<span class="token punctuation">;</span></span>
<span class="line">  fileName<span class="token operator">?</span><span class="token operator">:</span> string<span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">type EmittedAsset <span class="token operator">=</span> <span class="token punctuation">{</span></span>
<span class="line">  <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token string">&#39;asset&#39;</span><span class="token punctuation">;</span></span>
<span class="line">  name<span class="token operator">?</span><span class="token operator">:</span> string<span class="token punctuation">;</span></span>
<span class="line">  fileName<span class="token operator">?</span><span class="token operator">:</span> string<span class="token punctuation">;</span></span>
<span class="line">  source<span class="token operator">?</span><span class="token operator">:</span> string <span class="token operator">|</span> Uint8Array<span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_3-2-this-load" tabindex="-1"><a class="header-anchor" href="#_3-2-this-load"><span>3.2 this.load</span></a></h3><ul><li>[thisgetmoduleinfo](https://rollupjs.org/guide/en/</li><li>Type: (moduleId: string) =&gt; (ModuleInfo | null)</li><li>返回有关相关模块的其他信息</li></ul><h3 id="_3-3-this-load" tabindex="-1"><a class="header-anchor" href="#_3-3-this-load"><span>3.3 this.load</span></a></h3><ul><li>[thisload](https://rollupjs.org/guide/en/</li><li>Type: ({id: string, moduleSideEffects?: boolean | &#39;no-treeshake&#39; | null, syntheticNamedExports?: boolean | string | null, meta?: {[plugin: string]: any} | null, resolveDependencies?: boolean}) =&gt; Promise</li><li>加载并解析与给定id对应的模块，并将附加的元信息附加到模块（如果提供）</li><li>这将触发与另一个模块导入该模块时相同的加载、转换和模块授权挂钩</li></ul><h3 id="_3-4-this-resolve" tabindex="-1"><a class="header-anchor" href="#_3-4-this-resolve"><span>3.4 this.resolve</span></a></h3><ul><li>[thisresolve](https://rollupjs.org/guide/en/</li><li>使用Rollup使用的相同插件将导入解析为模块ID（即文件名），并确定导入是否应该是外部的</li><li>如果返回null，则无法通过Rollup或任何插件解析导入，但用户未明确将其标记为外部</li></ul><h2 id="_4-实战案例" tabindex="-1"><a class="header-anchor" href="#_4-实战案例"><span>4.实战案例</span></a></h2><ul><li><a href="https://astexplorer.net/" target="_blank" rel="noopener noreferrer">astexplorer</a>可以把代码转成语法树</li></ul><h3 id="_4-1-rollup-plugin-commonjs" tabindex="-1"><a class="header-anchor" href="#_4-1-rollup-plugin-commonjs"><span>4.1 @rollup/plugin-commonjs</span></a></h3><h4 id="_4-1-1-安装" tabindex="-1"><a class="header-anchor" href="#_4-1-1-安装"><span>4.1.1 安装</span></a></h4><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text"><pre><code class="language-text"><span class="line">npm install  @rollup/plugin-commonjs   --save</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><h4 id="_4-1-2-src-index-js" tabindex="-1"><a class="header-anchor" href="#_4-1-2-src-index-js"><span>4.1.2 src\\index.js</span></a></h4><p>src\\index.js</p><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code class="language-javascript"><span class="line"><span class="token keyword">import</span> catValue <span class="token keyword">from</span> <span class="token string">&#39;./cat.js&#39;</span><span class="token punctuation">;</span></span>
<span class="line">console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>catValue<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_4-1-3-src-cat-js" tabindex="-1"><a class="header-anchor" href="#_4-1-3-src-cat-js"><span>4.1.3 src\\cat.js</span></a></h4><p>src\\cat.js</p><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code class="language-javascript"><span class="line">module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token string">&#39;catValue&#39;</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><h4 id="_4-1-4-rollup-plugin-commonjs-js" tabindex="-1"><a class="header-anchor" href="#_4-1-4-rollup-plugin-commonjs-js"><span>4.1.4 rollup-plugin-commonjs.js</span></a></h4><p>plugins\\rollup-plugin-commonjs.js</p><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code class="language-javascript"><span class="line"><span class="token keyword">import</span> <span class="token punctuation">{</span> createFilter <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&#39;rollup-pluginutils&#39;</span></span>
<span class="line"><span class="token keyword">import</span> MagicString <span class="token keyword">from</span> <span class="token string">&#39;magic-string&#39;</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">import</span> <span class="token punctuation">{</span> walk <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&#39;estree-walker&#39;</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">import</span> path <span class="token keyword">from</span> <span class="token string">&#39;path&#39;</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">pluginOptions <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">  <span class="token keyword">const</span> defaultExtensions <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">&#39;.js&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;.jsx&#39;</span><span class="token punctuation">]</span></span>
<span class="line">  <span class="token keyword">const</span> <span class="token punctuation">{</span> exclude<span class="token punctuation">,</span> include<span class="token punctuation">,</span> extensions <span class="token operator">=</span> defaultExtensions <span class="token punctuation">}</span> <span class="token operator">=</span> pluginOptions<span class="token punctuation">;</span></span>
<span class="line">  <span class="token keyword">const</span> extensionRegExp <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">RegExp</span><span class="token punctuation">(</span></span>
<span class="line">    <span class="token template-string"><span class="token template-punctuation string">\`</span><span class="token string">(</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">\${</span>extensions<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token string">&#39;|&#39;</span><span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">)$</span><span class="token template-punctuation string">\`</span></span></span>
<span class="line">  <span class="token punctuation">)</span></span>
<span class="line">  <span class="token keyword">const</span> userDefinedFilter <span class="token operator">=</span> <span class="token function">createFilter</span><span class="token punctuation">(</span>include<span class="token punctuation">,</span> exclude<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">  <span class="token keyword">const</span> <span class="token function-variable function">filter</span> <span class="token operator">=</span> <span class="token parameter">id</span> <span class="token operator">=&gt;</span> extensionRegExp<span class="token punctuation">.</span><span class="token function">test</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token function">userDefinedFilter</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">  <span class="token keyword">return</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">&#39;commonjs&#39;</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token function">transform</span><span class="token punctuation">(</span><span class="token parameter">code<span class="token punctuation">,</span> id</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">filter</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span></span>
<span class="line">      <span class="token keyword">const</span> result <span class="token operator">=</span> <span class="token function">transformAndCheckExports</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>parse<span class="token punctuation">,</span> code<span class="token punctuation">,</span> id<span class="token punctuation">)</span></span>
<span class="line">      <span class="token keyword">return</span> result<span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">  <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"><span class="token keyword">function</span> <span class="token function">transformAndCheckExports</span><span class="token punctuation">(</span><span class="token parameter">parse<span class="token punctuation">,</span> code<span class="token punctuation">,</span> id</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">  <span class="token keyword">const</span> <span class="token punctuation">{</span> isEsModule<span class="token punctuation">,</span> ast <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">analyzeTopLevelStatements</span><span class="token punctuation">(</span>parse<span class="token punctuation">,</span> code<span class="token punctuation">,</span> id<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">  <span class="token keyword">if</span> <span class="token punctuation">(</span>isEsModule<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span></span>
<span class="line">  <span class="token punctuation">}</span></span>
<span class="line">  <span class="token keyword">return</span> <span class="token function">transformCommonjs</span><span class="token punctuation">(</span>code<span class="token punctuation">,</span> id<span class="token punctuation">,</span> ast<span class="token punctuation">)</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"><span class="token keyword">function</span> <span class="token function">getKeypath</span><span class="token punctuation">(</span><span class="token parameter">node</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">  <span class="token keyword">const</span> parts <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span></span>
<span class="line">  <span class="token keyword">while</span> <span class="token punctuation">(</span>node<span class="token punctuation">.</span>type <span class="token operator">===</span> <span class="token string">&#39;MemberExpression&#39;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    parts<span class="token punctuation">.</span><span class="token function">unshift</span><span class="token punctuation">(</span>node<span class="token punctuation">.</span>property<span class="token punctuation">.</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    node <span class="token operator">=</span> node<span class="token punctuation">.</span>object<span class="token punctuation">;</span></span>
<span class="line">  <span class="token punctuation">}</span></span>
<span class="line">  <span class="token keyword">if</span> <span class="token punctuation">(</span>node<span class="token punctuation">.</span>type <span class="token operator">!==</span> <span class="token string">&#39;Identifier&#39;</span><span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span></span>
<span class="line">  <span class="token keyword">const</span> <span class="token punctuation">{</span> name <span class="token punctuation">}</span> <span class="token operator">=</span> node<span class="token punctuation">;</span></span>
<span class="line">  parts<span class="token punctuation">.</span><span class="token function">unshift</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">  <span class="token keyword">return</span> <span class="token punctuation">{</span> name<span class="token punctuation">,</span> <span class="token literal-property property">keypath</span><span class="token operator">:</span> parts<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token string">&#39;.&#39;</span><span class="token punctuation">)</span> <span class="token punctuation">}</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"><span class="token keyword">function</span> <span class="token function">analyzeTopLevelStatements</span><span class="token punctuation">(</span><span class="token parameter">parse<span class="token punctuation">,</span> code</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">  <span class="token keyword">const</span> ast <span class="token operator">=</span> <span class="token function">parse</span><span class="token punctuation">(</span>code<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">  <span class="token keyword">let</span> isEsModule <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span></span>
<span class="line">  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> node <span class="token keyword">of</span> ast<span class="token punctuation">.</span>body<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">switch</span> <span class="token punctuation">(</span>node<span class="token punctuation">.</span>type<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">      <span class="token keyword">case</span> <span class="token string">&#39;ExportDefaultDeclaration&#39;</span><span class="token operator">:</span></span>
<span class="line">        isEsModule <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">break</span><span class="token punctuation">;</span></span>
<span class="line">      <span class="token keyword">case</span> <span class="token string">&#39;ExportNamedDeclaration&#39;</span><span class="token operator">:</span></span>
<span class="line">        isEsModule <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">break</span><span class="token punctuation">;</span></span>
<span class="line">      <span class="token keyword">case</span> <span class="token string">&#39;ImportDeclaration&#39;</span><span class="token operator">:</span></span>
<span class="line">        isEsModule <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">break</span><span class="token punctuation">;</span></span>
<span class="line">      <span class="token keyword">default</span><span class="token operator">:</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">  <span class="token punctuation">}</span></span>
<span class="line">  <span class="token keyword">return</span> <span class="token punctuation">{</span> isEsModule<span class="token punctuation">,</span> ast <span class="token punctuation">}</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"><span class="token keyword">function</span> <span class="token function">transformCommonjs</span><span class="token punctuation">(</span><span class="token parameter">code<span class="token punctuation">,</span> id<span class="token punctuation">,</span> ast</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">  <span class="token keyword">const</span> magicString <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MagicString</span><span class="token punctuation">(</span>code<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">  <span class="token keyword">const</span> exportDeclarations <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span></span>
<span class="line">  <span class="token keyword">let</span> moduleExportsAssignment<span class="token punctuation">;</span></span>
<span class="line">  <span class="token function">walk</span><span class="token punctuation">(</span>ast<span class="token punctuation">,</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token function">enter</span><span class="token punctuation">(</span><span class="token parameter">node</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">      <span class="token keyword">switch</span> <span class="token punctuation">(</span>node<span class="token punctuation">.</span>type<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">case</span> <span class="token string">&#39;AssignmentExpression&#39;</span><span class="token operator">:</span></span>
<span class="line">          <span class="token keyword">if</span> <span class="token punctuation">(</span>node<span class="token punctuation">.</span>left<span class="token punctuation">.</span>type <span class="token operator">===</span> <span class="token string">&#39;MemberExpression&#39;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token keyword">const</span> flattened <span class="token operator">=</span> <span class="token function">getKeypath</span><span class="token punctuation">(</span>node<span class="token punctuation">.</span>left<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">            <span class="token keyword">if</span> <span class="token punctuation">(</span>flattened<span class="token punctuation">.</span>keypath <span class="token operator">===</span> <span class="token string">&#39;module.exports&#39;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">              moduleExportsAssignment <span class="token operator">=</span> node<span class="token punctuation">;</span></span>
<span class="line">            <span class="token punctuation">}</span></span>
<span class="line">          <span class="token punctuation">}</span></span>
<span class="line">          <span class="token keyword">break</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">default</span><span class="token operator">:</span></span>
<span class="line">          <span class="token keyword">break</span><span class="token punctuation">;</span></span>
<span class="line">      <span class="token punctuation">}</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">  <span class="token keyword">const</span> <span class="token punctuation">{</span> left <span class="token punctuation">}</span> <span class="token operator">=</span> moduleExportsAssignment<span class="token punctuation">;</span></span>
<span class="line">  <span class="token keyword">const</span> exportsName <span class="token operator">=</span> path<span class="token punctuation">.</span><span class="token function">basename</span><span class="token punctuation">(</span>id<span class="token punctuation">,</span> path<span class="token punctuation">.</span><span class="token function">extname</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">  magicString<span class="token punctuation">.</span><span class="token function">overwrite</span><span class="token punctuation">(</span>left<span class="token punctuation">.</span>start<span class="token punctuation">,</span> left<span class="token punctuation">.</span>end<span class="token punctuation">,</span> exportsName<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">  magicString<span class="token punctuation">.</span><span class="token function">prependRight</span><span class="token punctuation">(</span>left<span class="token punctuation">.</span>start<span class="token punctuation">,</span> <span class="token string">&#39;var &#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">  exportDeclarations<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">\`</span><span class="token string">export default </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">\${</span>exportsName<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">;</span><span class="token template-punctuation string">\`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">  <span class="token keyword">const</span> exportBlock <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">\`</span><span class="token string">\\n\\n</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">\${</span>exportDeclarations<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token string">&#39;\\n&#39;</span><span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">\`</span></span><span class="token punctuation">;</span></span>
<span class="line">  magicString<span class="token punctuation">.</span><span class="token function">trim</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span>exportBlock<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">  <span class="token keyword">return</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token literal-property property">code</span><span class="token operator">:</span> magicString<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">  <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_4-1-5-rollup-config-js" tabindex="-1"><a class="header-anchor" href="#_4-1-5-rollup-config-js"><span>4.1.5 rollup.config.js</span></a></h4><p>rollup.config.js</p><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text"><pre><code class="language-text"><span class="line">//import babel from &#39;@rollup/plugin-babel&#39;</span>
<span class="line">//import babel from &#39;./plugins/rollup-plugin-babel.js&#39;</span>
<span class="line">//import commonjs from &#39;@rollup/plugin-commonjs&#39;</span>
<span class="line">+import commonjs from &#39;./plugins/rollup-plugin-commonjs&#39;</span>
<span class="line">export default {</span>
<span class="line">  input: &quot;./src/index.js&quot;,</span>
<span class="line">  output: {</span>
<span class="line">    dir: &#39;dist&#39;</span>
<span class="line">  },</span>
<span class="line">  plugins: [</span>
<span class="line">    //babel(),</span>
<span class="line">+   commonjs()</span>
<span class="line">  ]</span>
<span class="line">}</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_4-2-rollup-plugin-node-resolve" tabindex="-1"><a class="header-anchor" href="#_4-2-rollup-plugin-node-resolve"><span>4.2 @rollup/plugin-node-resolve</span></a></h3><h4 id="_4-2-1-安装" tabindex="-1"><a class="header-anchor" href="#_4-2-1-安装"><span>4.2.1 安装</span></a></h4><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text"><pre><code class="language-text"><span class="line">npm install @rollup/plugin-node-resolve check-is-array -D</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code class="language-javascript"><span class="line"><span class="token punctuation">(</span><span class="token operator">!</span><span class="token punctuation">)</span> Unresolved dependencies</span>
<span class="line"> <span class="token literal-property property">https</span><span class="token operator">:</span><span class="token operator">/</span><span class="token operator">/</span>rollupjs<span class="token punctuation">.</span>org<span class="token operator">/</span>guide<span class="token operator">/</span>en<span class="token operator">/</span></span>
<span class="line"><span class="token function">isarray</span> <span class="token punctuation">(</span>imported by src<span class="token operator">/</span>index<span class="token punctuation">.</span>js<span class="token punctuation">)</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_4-2-2-src-index-js" tabindex="-1"><a class="header-anchor" href="#_4-2-2-src-index-js"><span>4.2.2 src\\index.js</span></a></h4><p>src\\index.js</p><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text"><pre><code class="language-text"><span class="line">import isArray from &#39;check-is-array&#39;;</span>
<span class="line">console.log(isArray);</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_4-2-3-rollup-plugin-node-resolve-js" tabindex="-1"><a class="header-anchor" href="#_4-2-3-rollup-plugin-node-resolve-js"><span>4.2.3 rollup-plugin-node-resolve.js</span></a></h4><p>plugins\\rollup-plugin-node-resolve.js</p><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code class="language-javascript"><span class="line"><span class="token keyword">import</span> path <span class="token keyword">from</span> <span class="token string">&#39;path&#39;</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">import</span> Module <span class="token keyword">from</span> <span class="token string">&#39;module&#39;</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">function</span> <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">  <span class="token keyword">return</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">&#39;resolve&#39;</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token comment">//因为我们要改造根据模块的名称查找模所路径的逻辑</span></span>
<span class="line">    <span class="token keyword">async</span> <span class="token function">resolveId</span><span class="token punctuation">(</span><span class="token parameter">importee<span class="token punctuation">,</span> importer</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">      <span class="token comment">//如果是相对路径，则走默认逻辑</span></span>
<span class="line">      <span class="token keyword">if</span> <span class="token punctuation">(</span>importee<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">===</span> <span class="token string">&#39;.&#39;</span> <span class="token operator">||</span> path<span class="token punctuation">.</span><span class="token function">isAbsolute</span><span class="token punctuation">(</span>importee<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span></span>
<span class="line">      <span class="token punctuation">}</span></span>
<span class="line">      <span class="token keyword">let</span> location <span class="token operator">=</span> Module<span class="token punctuation">.</span><span class="token function">createRequire</span><span class="token punctuation">(</span>path<span class="token punctuation">.</span><span class="token function">dirname</span><span class="token punctuation">(</span>importer<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>importee<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>location<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">      <span class="token keyword">return</span> location<span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">  <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"><span class="token keyword">export</span> <span class="token keyword">default</span> resolve<span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_4-3-rollup-plugin-alias" tabindex="-1"><a class="header-anchor" href="#_4-3-rollup-plugin-alias"><span>4.3 @rollup/plugin-alias</span></a></h3><h4 id="_4-3-1-rollup-config-js" tabindex="-1"><a class="header-anchor" href="#_4-3-1-rollup-config-js"><span>4.3.1 rollup.config.js</span></a></h4><p>rollup.config.js</p><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code class="language-javascript"><span class="line"><span class="token comment">//import build from &#39;./plugins/rollup-plugin-build.js&#39;;</span></span>
<span class="line"><span class="token comment">//import polyfill from &#39;./plugins/rollup-plugin-inject-polyfill.js&#39;;</span></span>
<span class="line"><span class="token comment">//import babel from &#39;./plugins/rollup-plugin-babel.js&#39;;</span></span>
<span class="line"><span class="token comment">//import generation from &#39;./plugins/rollup-plugin-generation.js&#39;;</span></span>
<span class="line"><span class="token comment">//import importPolyFill from &#39;./plugins/rollup-plugin-import-polyfill.js&#39;;</span></span>
<span class="line"><span class="token comment">//import commonjs from &#39;@rollup/plugin-commonjs&#39;;</span></span>
<span class="line"><span class="token comment">//import commonjs from &#39;./plugins/rollup-plugin-commonjs&#39;;</span></span>
<span class="line"><span class="token comment">//import resolve from &#39;@rollup/plugin-node-resolve&#39;;</span></span>
<span class="line"><span class="token keyword">import</span> resolve <span class="token keyword">from</span> <span class="token string">&#39;./plugins/rollup-plugin-node-resolve.js&#39;</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token comment">//import alias from &#39;@rollup/plugin-alias&#39;;</span></span>
<span class="line"><span class="token keyword">import</span> alias <span class="token keyword">from</span> <span class="token string">&#39;./plugins/rollup-plugin-alias.js&#39;</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token punctuation">{</span></span>
<span class="line">  <span class="token literal-property property">input</span><span class="token operator">:</span> <span class="token string">&#39;./src/index.js&#39;</span><span class="token punctuation">,</span></span>
<span class="line">  <span class="token comment">//watch: true,</span></span>
<span class="line">  <span class="token literal-property property">output</span><span class="token operator">:</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token comment">//file: &#39;dist/main.js&#39;,</span></span>
<span class="line">    <span class="token literal-property property">dir</span><span class="token operator">:</span> <span class="token string">&#39;dist&#39;</span></span>
<span class="line">  <span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">  <span class="token literal-property property">plugins</span><span class="token operator">:</span> <span class="token punctuation">[</span></span>
<span class="line">    <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token function">alias</span><span class="token punctuation">(</span><span class="token punctuation">{</span></span>
<span class="line">      <span class="token literal-property property">entries</span><span class="token operator">:</span> <span class="token punctuation">[</span></span>
<span class="line">        <span class="token punctuation">{</span> <span class="token literal-property property">find</span><span class="token operator">:</span> <span class="token string">&#39;./xx.js&#39;</span><span class="token punctuation">,</span> <span class="token literal-property property">replacement</span><span class="token operator">:</span> <span class="token string">&#39;check-is-array&#39;</span> <span class="token punctuation">}</span></span>
<span class="line">      <span class="token punctuation">]</span></span>
<span class="line">    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line">  <span class="token punctuation">]</span><span class="token punctuation">,</span></span>
<span class="line">  <span class="token literal-property property">watch</span><span class="token operator">:</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token literal-property property">clearScreen</span><span class="token operator">:</span> <span class="token boolean">false</span></span>
<span class="line">  <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_4-3-2-rollup-plugin-alias-js" tabindex="-1"><a class="header-anchor" href="#_4-3-2-rollup-plugin-alias-js"><span>4.3.2 rollup-plugin-alias.js</span></a></h4><p>plugins\\rollup-plugin-alias.js</p><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code class="language-javascript"><span class="line"><span class="token keyword">function</span> <span class="token function">matches</span><span class="token punctuation">(</span><span class="token parameter">pattern<span class="token punctuation">,</span> importee</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">if</span> <span class="token punctuation">(</span>pattern <span class="token keyword">instanceof</span> <span class="token class-name">RegExp</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">return</span> pattern<span class="token punctuation">.</span><span class="token function">test</span><span class="token punctuation">(</span>importee<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    <span class="token keyword">if</span> <span class="token punctuation">(</span>importee<span class="token punctuation">.</span>length <span class="token operator">&lt;</span> pattern<span class="token punctuation">.</span>length<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    <span class="token keyword">if</span> <span class="token punctuation">(</span>importee <span class="token operator">===</span> pattern<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    <span class="token keyword">return</span> importee<span class="token punctuation">.</span><span class="token function">startsWith</span><span class="token punctuation">(</span>pattern <span class="token operator">+</span> <span class="token string">&#39;/&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">function</span> <span class="token function">alias</span><span class="token punctuation">(</span><span class="token parameter">options <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">const</span> <span class="token punctuation">{</span> entries <span class="token punctuation">}</span> <span class="token operator">=</span> options<span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">if</span> <span class="token punctuation">(</span>entries<span class="token punctuation">.</span>length <span class="token operator">===</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">return</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">&#39;alias&#39;</span><span class="token punctuation">,</span></span>
<span class="line">            <span class="token function-variable function">resolveId</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token keyword">null</span></span>
<span class="line">        <span class="token punctuation">}</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    <span class="token keyword">return</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">&#39;alias&#39;</span><span class="token punctuation">,</span></span>
<span class="line">        <span class="token function">resolveId</span><span class="token punctuation">(</span><span class="token parameter">importee<span class="token punctuation">,</span> importer</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>importer<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">                <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span></span>
<span class="line">            <span class="token punctuation">}</span></span>
<span class="line">            <span class="token keyword">const</span> matchedEntry <span class="token operator">=</span> entries<span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">entry</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token function">matches</span><span class="token punctuation">(</span>entry<span class="token punctuation">.</span>find<span class="token punctuation">,</span> importee<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>matchedEntry<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">                <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span></span>
<span class="line">            <span class="token punctuation">}</span></span>
<span class="line">            <span class="token keyword">const</span> updatedId <span class="token operator">=</span> importee<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span>matchedEntry<span class="token punctuation">.</span>find<span class="token punctuation">,</span> matchedEntry<span class="token punctuation">.</span>replacement<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">            <span class="token comment">//调用this.resolve意味着重新解析</span></span>
<span class="line">            <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>updatedId<span class="token punctuation">,</span> importer<span class="token punctuation">,</span> Object<span class="token punctuation">.</span><span class="token function">assign</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token literal-property property">skipSelf</span><span class="token operator">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span></span>
<span class="line">                <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolved</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> resolved <span class="token operator">||</span> <span class="token punctuation">{</span> <span class="token literal-property property">id</span><span class="token operator">:</span> updatedId <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">    <span class="token punctuation">}</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"><span class="token keyword">export</span> <span class="token keyword">default</span> alias<span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div>`,166)])])}const c=s(p,[["render",l]]),u=JSON.parse('{"path":"/strong/103.16.rollup.3.html","title":"","lang":"en-US","frontmatter":{},"git":{"updatedTime":1681290319000,"contributors":[{"name":"yutao","username":"yutao","email":"642231346@qq.com","commits":1,"url":"https://github.com/yutao"}],"changelog":[{"hash":"f5ab8c9d34991ec274f7f652439afe5b2afb6147","time":1681290319000,"email":"642231346@qq.com","author":"yutao","message":"modify"}]},"filePathRelative":"strong/103.16.rollup.3.md"}');export{c as comp,u as data};
