import{_ as s,c as a,a as p,o as e}from"./app-CD1YpnS1.js";const t={};function l(c,n){return e(),a("div",null,[...n[0]||(n[0]=[p(`<h2 id="_1-dva介绍" tabindex="-1"><a class="header-anchor" href="#_1-dva介绍"><span>1.dva介绍</span></a></h2><p><img src="https://zos.alipayobjects.com/rmsportal/PPrerEAKbIoDZYr.png" alt="dva"></p><h3 id="_1-1-前置知识" tabindex="-1"><a class="header-anchor" href="#_1-1-前置知识"><span>1.1 前置知识</span></a></h3><ul><li>react</li><li>react-router-dom</li><li>redux</li><li>react-redux</li><li>connected-react-router</li><li>history</li><li>dva</li></ul><h2 id="_2-初始化项目" tabindex="-1"><a class="header-anchor" href="#_2-初始化项目"><span>2. 初始化项目</span></a></h2><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text"><pre><code class="language-text"><span class="line">create-react-app zhufeng-dva-source</span>
<span class="line">cd  zhufeng-dva-source</span>
<span class="line">cnpm install dva redux react-redux react-router-dom connected-react-router history</span>
<span class="line">npm start</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="_3-基本计数器" tabindex="-1"><a class="header-anchor" href="#_3-基本计数器"><span>3. 基本计数器</span></a></h2><h3 id="_3-1-src-index-js" tabindex="-1"><a class="header-anchor" href="#_3-1-src-index-js"><span>3.1 src\\index.js</span></a></h3><p>src\\index.js</p><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code class="language-javascript"><span class="line"><span class="token keyword">import</span> React <span class="token keyword">from</span> <span class="token string">&#39;react&#39;</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">import</span> dva<span class="token punctuation">,</span><span class="token punctuation">{</span>connect<span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&#39;dva&#39;</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">const</span> app <span class="token operator">=</span> <span class="token function">dva</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">app<span class="token punctuation">.</span><span class="token function">model</span><span class="token punctuation">(</span><span class="token punctuation">{</span></span>
<span class="line">    <span class="token literal-property property">namespace</span><span class="token operator">:</span><span class="token string">&#39;counter&#39;</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token literal-property property">state</span><span class="token operator">:</span><span class="token punctuation">{</span><span class="token literal-property property">number</span><span class="token operator">:</span><span class="token number">0</span><span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token literal-property property">reducers</span><span class="token operator">:</span><span class="token punctuation">{</span></span>
<span class="line">        <span class="token function">add</span><span class="token punctuation">(</span><span class="token parameter">state</span><span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line">            <span class="token keyword">return</span> <span class="token punctuation">{</span><span class="token literal-property property">number</span><span class="token operator">:</span>state<span class="token punctuation">.</span>number<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">}</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">const</span> Counter <span class="token operator">=</span> <span class="token function">connect</span><span class="token punctuation">(</span></span>
<span class="line">    <span class="token parameter">state</span><span class="token operator">=&gt;</span>state<span class="token punctuation">.</span>counter</span>
<span class="line"><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token parameter">props</span><span class="token operator">=&gt;</span><span class="token punctuation">(</span></span>
<span class="line">    <span class="token operator">&lt;</span>div<span class="token operator">&gt;</span></span>
<span class="line">        <span class="token operator">&lt;</span>p<span class="token operator">&gt;</span><span class="token punctuation">{</span>props<span class="token punctuation">.</span>number<span class="token punctuation">}</span><span class="token operator">&lt;</span><span class="token operator">/</span>p<span class="token operator">&gt;</span></span>
<span class="line">        <span class="token operator">&lt;</span>button onClick<span class="token operator">=</span><span class="token punctuation">{</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span>props<span class="token punctuation">.</span><span class="token function">dispatch</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token literal-property property">type</span><span class="token operator">:</span><span class="token string">&quot;counter/add&quot;</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token operator">&gt;</span><span class="token operator">+</span><span class="token operator">&lt;</span><span class="token operator">/</span>button<span class="token operator">&gt;</span></span>
<span class="line">    <span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">&gt;</span></span>
<span class="line"><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">app<span class="token punctuation">.</span><span class="token function">router</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token operator">&lt;</span>Counter<span class="token operator">/</span><span class="token operator">&gt;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"> app<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span>&#39;</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_3-2-src-dva-index-js" tabindex="-1"><a class="header-anchor" href="#_3-2-src-dva-index-js"><span>3.2 src\\dva\\index.js</span></a></h3><p>src\\dva\\index.js</p><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code class="language-javascript"><span class="line"><span class="token keyword">import</span> React <span class="token keyword">from</span> <span class="token string">&#39;react&#39;</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">import</span> ReactDOM <span class="token keyword">from</span> <span class="token string">&#39;react-dom&#39;</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">import</span> <span class="token punctuation">{</span>createStore<span class="token punctuation">,</span>combineReducers<span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&#39;redux&#39;</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">import</span> <span class="token punctuation">{</span>connect<span class="token punctuation">,</span>Provider<span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&#39;react-redux&#39;</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">export</span> <span class="token punctuation">{</span>connect<span class="token punctuation">}</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">const</span> app <span class="token operator">=</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token literal-property property">_models</span><span class="token operator">:</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span></span>
<span class="line">        model<span class="token punctuation">,</span></span>
<span class="line">        <span class="token literal-property property">_router</span><span class="token operator">:</span><span class="token keyword">null</span><span class="token punctuation">,</span></span>
<span class="line">        router<span class="token punctuation">,</span></span>
<span class="line">        start</span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    <span class="token keyword">function</span> <span class="token function">model</span><span class="token punctuation">(</span><span class="token parameter">model</span><span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line">        app<span class="token punctuation">.</span>_models<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>model<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    <span class="token keyword">function</span> <span class="token function">router</span><span class="token punctuation">(</span><span class="token parameter">routerConfig</span><span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line">        app<span class="token punctuation">.</span>_router <span class="token operator">=</span> routerConfig<span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    <span class="token keyword">function</span> <span class="token function">start</span><span class="token punctuation">(</span><span class="token parameter">root</span><span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">let</span> reducers <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">let</span> i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>i<span class="token operator">&lt;</span>app<span class="token punctuation">.</span>_models<span class="token punctuation">.</span>length<span class="token punctuation">;</span>i<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line">            <span class="token keyword">let</span> model <span class="token operator">=</span> app<span class="token punctuation">.</span>_models<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span></span>
<span class="line">            model<span class="token punctuation">.</span>reducers <span class="token operator">=</span> <span class="token function">prefixNamespace</span><span class="token punctuation">(</span>model<span class="token punctuation">.</span>reducers<span class="token punctuation">,</span>model<span class="token punctuation">.</span>namespace<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">            reducers<span class="token punctuation">[</span>model<span class="token punctuation">.</span>namespace<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">state <span class="token operator">=</span> model<span class="token punctuation">.</span>state<span class="token punctuation">,</span> action</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">                <span class="token keyword">let</span> actionType <span class="token operator">=</span> action<span class="token punctuation">.</span>type<span class="token punctuation">;</span></span>
<span class="line">                <span class="token keyword">let</span> reducer <span class="token operator">=</span> model<span class="token punctuation">.</span>reducers<span class="token punctuation">[</span>actionType<span class="token punctuation">]</span><span class="token punctuation">;</span></span>
<span class="line">                <span class="token keyword">if</span> <span class="token punctuation">(</span>reducer<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">                    <span class="token keyword">return</span> <span class="token function">reducer</span><span class="token punctuation">(</span>state<span class="token punctuation">,</span> action<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">                <span class="token punctuation">}</span></span>
<span class="line">                <span class="token keyword">return</span> state<span class="token punctuation">;</span></span>
<span class="line">            <span class="token punctuation">}</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">        <span class="token keyword">let</span> rootReducer <span class="token operator">=</span> <span class="token function">combineReducers</span><span class="token punctuation">(</span>reducers<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">let</span> store <span class="token operator">=</span> <span class="token function">createStore</span><span class="token punctuation">(</span>rootReducer<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">let</span> App <span class="token operator">=</span> app<span class="token punctuation">.</span>_router<span class="token punctuation">;</span></span>
<span class="line">        ReactDOM<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span><span class="token operator">&lt;</span>Provider store<span class="token operator">=</span><span class="token punctuation">{</span>store<span class="token punctuation">}</span><span class="token operator">&gt;</span><span class="token operator">&lt;</span>App<span class="token operator">/</span><span class="token operator">&gt;</span><span class="token operator">&lt;</span><span class="token operator">/</span>Provider<span class="token operator">&gt;</span><span class="token punctuation">,</span>document<span class="token punctuation">.</span><span class="token function">querySelector</span><span class="token punctuation">(</span>root<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    <span class="token keyword">return</span> app<span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"><span class="token comment">//https://github.com/dvajs/dva/blob/master/packages/dva-core/src/prefixNamespace.js</span></span>
<span class="line"><span class="token keyword">function</span> <span class="token function">prefixNamespace</span><span class="token punctuation">(</span><span class="token parameter">reducers<span class="token punctuation">,</span>namespace</span><span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">return</span> Object<span class="token punctuation">.</span><span class="token function">keys</span><span class="token punctuation">(</span>reducers<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">reduce</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">memo<span class="token punctuation">,</span> key</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">const</span> newKey <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">\`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">\${</span>namespace<span class="token interpolation-punctuation punctuation">}</span></span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">\${</span><span class="token constant">NAMESPACE_SEPARATOR</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">\${</span>key<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">\`</span></span><span class="token punctuation">;</span></span>
<span class="line">        memo<span class="token punctuation">[</span>newKey<span class="token punctuation">]</span> <span class="token operator">=</span> reducers<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">return</span> memo<span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="_4-支持effects" tabindex="-1"><a class="header-anchor" href="#_4-支持effects"><span>4. 支持effects</span></a></h2><h3 id="_4-1-src-index-js" tabindex="-1"><a class="header-anchor" href="#_4-1-src-index-js"><span>4.1 src\\index.js</span></a></h3><p>src\\index.js</p><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text"><pre><code class="language-text"><span class="line">import React from &#39;react&#39;;</span>
<span class="line">import dva,{connect} from &#39;dva&#39;;</span>
<span class="line">const app = dva();</span>
<span class="line">+ function delay(ms) {</span>
<span class="line">+    return new Promise((resolve,reject) =&gt; {</span>
<span class="line">+        setTimeout(function () {</span>
<span class="line">+            resolve();</span>
<span class="line">+        },ms);</span>
<span class="line">+    });</span>
<span class="line">+ }</span>
<span class="line">app.model({</span>
<span class="line">    namespace:&#39;counter&#39;,</span>
<span class="line">    state:{number:0},</span>
<span class="line">    reducers:{</span>
<span class="line">        add(state){</span>
<span class="line">            return {number:state.number+1};</span>
<span class="line">        }</span>
<span class="line">    },</span>
<span class="line">+    effects:{</span>
<span class="line">+        *asyncAdd(action,{call,put}){</span>
<span class="line">+          yield call(delay,1000);</span>
<span class="line">+          yield put({type:&#39;counter/add&#39;});</span>
<span class="line">+        }</span>
<span class="line">+    }</span>
<span class="line">});</span>
<span class="line">const Counter = connect(</span>
<span class="line">    state=&gt;state.counter</span>
<span class="line">)(props=&gt;(</span>
<span class="line">    &lt;div&gt;</span>
<span class="line">        &lt;p&gt;{props.number}&lt;/p&gt;</span>
<span class="line">        &lt;button onClick={()=&gt;props.dispatch({type:&quot;counter/add&quot;})}&gt;+&lt;/button&gt;</span>
<span class="line">+        &lt;button onClick={()=&gt;props.dispatch({type:&quot;counter/asyncAdd&quot;})}&gt;异步+&lt;/button&gt;</span>
<span class="line">    &lt;/div&gt;</span>
<span class="line">));</span>
<span class="line">app.router(()=&gt;&lt;Counter/&gt;);</span>
<span class="line"> app.start(&#39;</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_4-2-src-dva-index-js" tabindex="-1"><a class="header-anchor" href="#_4-2-src-dva-index-js"><span>4.2 src\\dva\\index.js</span></a></h3><p>src\\dva\\index.js</p><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code class="language-javascript"><span class="line"><span class="token keyword">import</span> React <span class="token keyword">from</span> <span class="token string">&#39;react&#39;</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">import</span> ReactDOM <span class="token keyword">from</span> <span class="token string">&#39;react-dom&#39;</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token operator">+</span><span class="token keyword">import</span> <span class="token punctuation">{</span>createStore<span class="token punctuation">,</span>combineReducers<span class="token punctuation">,</span>applyMiddleware<span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&#39;redux&#39;</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">import</span> <span class="token punctuation">{</span>connect<span class="token punctuation">,</span>Provider<span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&#39;react-redux&#39;</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token operator">+</span><span class="token keyword">import</span> createSagaMiddleware <span class="token keyword">from</span> <span class="token string">&#39;redux-saga&#39;</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token operator">+</span><span class="token keyword">import</span> <span class="token operator">*</span> <span class="token keyword">as</span> sagaEffects <span class="token keyword">from</span> <span class="token string">&#39;redux-saga/effects&#39;</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">export</span> <span class="token punctuation">{</span>connect<span class="token punctuation">}</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">const</span> app <span class="token operator">=</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token literal-property property">_models</span><span class="token operator">:</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span></span>
<span class="line">        model<span class="token punctuation">,</span></span>
<span class="line">        <span class="token literal-property property">_router</span><span class="token operator">:</span><span class="token keyword">null</span><span class="token punctuation">,</span></span>
<span class="line">        router<span class="token punctuation">,</span></span>
<span class="line">        start</span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    <span class="token keyword">function</span> <span class="token function">model</span><span class="token punctuation">(</span><span class="token parameter">model</span><span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line">        app<span class="token punctuation">.</span>_models<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>model<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    <span class="token keyword">function</span> <span class="token function">router</span><span class="token punctuation">(</span><span class="token parameter">routerConfig</span><span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line">        app<span class="token punctuation">.</span>_router <span class="token operator">=</span> routerConfig<span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    <span class="token keyword">function</span> <span class="token function">start</span><span class="token punctuation">(</span><span class="token parameter">root</span><span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">let</span> reducers <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">let</span> i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>i<span class="token operator">&lt;</span>app<span class="token punctuation">.</span>_models<span class="token punctuation">.</span>length<span class="token punctuation">;</span>i<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line">            <span class="token keyword">let</span> model <span class="token operator">=</span> app<span class="token punctuation">.</span>_models<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span></span>
<span class="line">            reducers<span class="token punctuation">[</span>model<span class="token punctuation">.</span>namespace<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">state<span class="token operator">=</span>model<span class="token punctuation">.</span>state<span class="token punctuation">,</span>action</span><span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line">                 <span class="token keyword">let</span> actionType <span class="token operator">=</span> action<span class="token punctuation">.</span>type<span class="token punctuation">;</span></span>
<span class="line">                 <span class="token keyword">let</span> values <span class="token operator">=</span> actionType<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">&#39;/&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">                 <span class="token keyword">if</span><span class="token punctuation">(</span>values<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">===</span> model<span class="token punctuation">.</span>namespace<span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line">                    <span class="token keyword">let</span> reducer <span class="token operator">=</span> model<span class="token punctuation">.</span>reducers<span class="token punctuation">[</span>values<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">;</span></span>
<span class="line">                    <span class="token keyword">if</span><span class="token punctuation">(</span>reducer<span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line">                        <span class="token keyword">return</span> <span class="token function">reducer</span><span class="token punctuation">(</span>state<span class="token punctuation">,</span>action<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">                    <span class="token punctuation">}</span></span>
<span class="line">                 <span class="token punctuation">}</span></span>
<span class="line">                 <span class="token keyword">return</span> state<span class="token punctuation">;</span></span>
<span class="line">            <span class="token punctuation">}</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">        <span class="token keyword">let</span> rootReducer <span class="token operator">=</span> <span class="token function">combineReducers</span><span class="token punctuation">(</span>reducers<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token operator">+</span>        <span class="token keyword">let</span> sagaMiddleware <span class="token operator">=</span> <span class="token function">createSagaMiddleware</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token operator">+</span>        <span class="token keyword">function</span><span class="token operator">*</span> <span class="token function">rootSaga</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line"><span class="token operator">+</span>            <span class="token keyword">let</span> <span class="token punctuation">{</span>takeEvery<span class="token punctuation">}</span> <span class="token operator">=</span>  sagaEffects<span class="token punctuation">;</span></span>
<span class="line"><span class="token operator">+</span>            <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">const</span> model <span class="token keyword">of</span> app<span class="token punctuation">.</span>_models<span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line"><span class="token operator">+</span>                <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">const</span> key <span class="token keyword">in</span> model<span class="token punctuation">.</span>effects<span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line"><span class="token operator">+</span>                    <span class="token keyword">yield</span> <span class="token function">takeEvery</span><span class="token punctuation">(</span>model<span class="token punctuation">.</span>namespace<span class="token operator">+</span><span class="token string">&#39;/&#39;</span><span class="token operator">+</span>key<span class="token punctuation">,</span><span class="token keyword">function</span><span class="token operator">*</span><span class="token punctuation">(</span>action<span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line"><span class="token operator">+</span>                        <span class="token keyword">yield</span> model<span class="token punctuation">.</span>effects<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">(</span>action<span class="token punctuation">,</span>sagaEffects<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token operator">+</span>                    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token operator">+</span>                <span class="token punctuation">}</span></span>
<span class="line"><span class="token operator">+</span>            <span class="token punctuation">}</span></span>
<span class="line"><span class="token operator">+</span>        <span class="token punctuation">}</span></span>
<span class="line"><span class="token operator">+</span>        <span class="token keyword">let</span> store <span class="token operator">=</span> <span class="token function">createStore</span><span class="token punctuation">(</span>rootReducer<span class="token punctuation">,</span><span class="token function">applyMiddleware</span><span class="token punctuation">(</span>sagaMiddleware<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token operator">+</span>        sagaMiddleware<span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span>rootSaga<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">let</span> App <span class="token operator">=</span> app<span class="token punctuation">.</span>_router<span class="token punctuation">;</span></span>
<span class="line">        ReactDOM<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span><span class="token operator">&lt;</span>Provider store<span class="token operator">=</span><span class="token punctuation">{</span>store<span class="token punctuation">}</span><span class="token operator">&gt;</span><span class="token operator">&lt;</span>App<span class="token operator">/</span><span class="token operator">&gt;</span><span class="token operator">&lt;</span><span class="token operator">/</span>Provider<span class="token operator">&gt;</span><span class="token punctuation">,</span>document<span class="token punctuation">.</span><span class="token function">querySelector</span><span class="token punctuation">(</span>root<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    <span class="token keyword">return</span> app<span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="_5-支持路由" tabindex="-1"><a class="header-anchor" href="#_5-支持路由"><span>5.支持路由</span></a></h2><h3 id="_5-1-src-index-js" tabindex="-1"><a class="header-anchor" href="#_5-1-src-index-js"><span>5.1 src\\index.js</span></a></h3><p>src\\index.js</p><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text"><pre><code class="language-text"><span class="line">import React from &#39;react&#39;;</span>
<span class="line">import dva,{connect} from &#39;dva&#39;;</span>
<span class="line">+import {Router,Route} from &#39;dva/router&#39;;</span>
<span class="line">const app = dva();</span>
<span class="line">function delay(ms) {</span>
<span class="line">    return new Promise((resolve,reject) =&gt; {</span>
<span class="line">        setTimeout(function () {</span>
<span class="line">            resolve();</span>
<span class="line">        },ms);</span>
<span class="line">    });</span>
<span class="line">}</span>
<span class="line">app.model({</span>
<span class="line">    namespace:&#39;counter&#39;,</span>
<span class="line">    state:{number:0},</span>
<span class="line">    reducers:{</span>
<span class="line">        add(state){</span>
<span class="line">            return {number:state.number+1};</span>
<span class="line">        }</span>
<span class="line">    },</span>
<span class="line">    effects:{</span>
<span class="line">        *asyncAdd(action,{call,put}){</span>
<span class="line">          yield call(delay,1000);</span>
<span class="line">          yield put({type:&#39;counter/add&#39;});</span>
<span class="line">        }</span>
<span class="line">    }</span>
<span class="line">});</span>
<span class="line">const Counter = connect(</span>
<span class="line">    state=&gt;state.counter</span>
<span class="line">)(props=&gt;(</span>
<span class="line">    &lt;div&gt;</span>
<span class="line">        &lt;p&gt;{props.number}&lt;/p&gt;</span>
<span class="line">        &lt;button onClick={()=&gt;props.dispatch({type:&quot;counter/add&quot;})}&gt;+&lt;/button&gt;</span>
<span class="line">        &lt;button onClick={()=&gt;props.dispatch({type:&quot;counter/asyncAdd&quot;})}&gt;异步+&lt;/button&gt;</span>
<span class="line">    &lt;/div&gt;</span>
<span class="line">));</span>
<span class="line">//index.js:1375 Warning: Please use \`require(&quot;history&quot;).createHashHistory\` instead of \`require(&quot;history/createHashHistory&quot;)\`. Support for the latter will be removed in the next major release.</span>
<span class="line">//index.js:1375 Warning: [sagaEffects.put] counter/add should not be prefixed with namespace counter</span>
<span class="line">+const Home = ()=&gt;&lt;div&gt;Home&lt;/div&gt;</span>
<span class="line">+app.router(({history})=&gt;(</span>
<span class="line">+    &lt;Router history={history}&gt;</span>
<span class="line">+        &lt;&gt;</span>
<span class="line">+            &lt;Route path=&quot;/&quot; exact={true} component={Home}/&gt;</span>
<span class="line">+            &lt;Route path=&quot;/counter&quot; component={Counter}/&gt;</span>
<span class="line">+        &lt;/&gt;</span>
<span class="line">+    &lt;/Router&gt;</span>
<span class="line">+));</span>
<span class="line"> app.start(&#39;</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_5-2-src-dva-index-js" tabindex="-1"><a class="header-anchor" href="#_5-2-src-dva-index-js"><span>5.2 src\\dva\\index.js</span></a></h3><p>src\\dva\\index.js</p><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code class="language-javascript"><span class="line"><span class="token keyword">import</span> React <span class="token keyword">from</span> <span class="token string">&#39;react&#39;</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">import</span> ReactDOM <span class="token keyword">from</span> <span class="token string">&#39;react-dom&#39;</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">import</span> <span class="token punctuation">{</span>createStore<span class="token punctuation">,</span>combineReducers<span class="token punctuation">,</span>applyMiddleware<span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&#39;redux&#39;</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">import</span> <span class="token punctuation">{</span>connect<span class="token punctuation">,</span>Provider<span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&#39;react-redux&#39;</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">import</span> createSagaMiddleware <span class="token keyword">from</span> <span class="token string">&#39;redux-saga&#39;</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">import</span> <span class="token operator">*</span> <span class="token keyword">as</span> sagaEffects <span class="token keyword">from</span> <span class="token string">&#39;redux-saga/effects&#39;</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token operator">+</span><span class="token keyword">import</span> <span class="token punctuation">{</span>createHashHistory<span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&#39;history&#39;</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">export</span> <span class="token punctuation">{</span>connect<span class="token punctuation">}</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">const</span> app <span class="token operator">=</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token literal-property property">_models</span><span class="token operator">:</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span></span>
<span class="line">        model<span class="token punctuation">,</span></span>
<span class="line">        <span class="token literal-property property">_router</span><span class="token operator">:</span><span class="token keyword">null</span><span class="token punctuation">,</span></span>
<span class="line">        router<span class="token punctuation">,</span></span>
<span class="line">        start</span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    <span class="token keyword">function</span> <span class="token function">model</span><span class="token punctuation">(</span><span class="token parameter">model</span><span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line">        app<span class="token punctuation">.</span>_models<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>model<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    <span class="token keyword">function</span> <span class="token function">router</span><span class="token punctuation">(</span><span class="token parameter">routerConfig</span><span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line">        app<span class="token punctuation">.</span>_router <span class="token operator">=</span> routerConfig<span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    <span class="token keyword">function</span> <span class="token function">start</span><span class="token punctuation">(</span><span class="token parameter">root</span><span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">let</span> reducers <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">let</span> i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>i<span class="token operator">&lt;</span>app<span class="token punctuation">.</span>_models<span class="token punctuation">.</span>length<span class="token punctuation">;</span>i<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line">            <span class="token keyword">let</span> model <span class="token operator">=</span> app<span class="token punctuation">.</span>_models<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span></span>
<span class="line">            reducers<span class="token punctuation">[</span>model<span class="token punctuation">.</span>namespace<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">state<span class="token operator">=</span>model<span class="token punctuation">.</span>state<span class="token punctuation">,</span>action</span><span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line">                 <span class="token keyword">let</span> actionType <span class="token operator">=</span> action<span class="token punctuation">.</span>type<span class="token punctuation">;</span></span>
<span class="line">                 <span class="token keyword">let</span> values <span class="token operator">=</span> actionType<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">&#39;/&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">                 <span class="token keyword">if</span><span class="token punctuation">(</span>values<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">===</span> model<span class="token punctuation">.</span>namespace<span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line">                    <span class="token keyword">let</span> reducer <span class="token operator">=</span> model<span class="token punctuation">.</span>reducers<span class="token punctuation">[</span>values<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">;</span></span>
<span class="line">                    <span class="token keyword">if</span><span class="token punctuation">(</span>reducer<span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line">                        <span class="token keyword">return</span> <span class="token function">reducer</span><span class="token punctuation">(</span>state<span class="token punctuation">,</span>action<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">                    <span class="token punctuation">}</span></span>
<span class="line">                 <span class="token punctuation">}</span></span>
<span class="line">                 <span class="token keyword">return</span> state<span class="token punctuation">;</span></span>
<span class="line">            <span class="token punctuation">}</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">        <span class="token keyword">let</span> rootReducer <span class="token operator">=</span> <span class="token function">combineReducers</span><span class="token punctuation">(</span>reducers<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">let</span> sagaMiddleware <span class="token operator">=</span> <span class="token function">createSagaMiddleware</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">function</span><span class="token operator">*</span> <span class="token function">rootSaga</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line">            <span class="token keyword">let</span> <span class="token punctuation">{</span>takeEvery<span class="token punctuation">}</span> <span class="token operator">=</span>  sagaEffects<span class="token punctuation">;</span></span>
<span class="line">            <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">const</span> model <span class="token keyword">of</span> app<span class="token punctuation">.</span>_models<span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line">                <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">const</span> key <span class="token keyword">in</span> model<span class="token punctuation">.</span>effects<span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line">                    <span class="token keyword">yield</span> <span class="token function">takeEvery</span><span class="token punctuation">(</span>model<span class="token punctuation">.</span>namespace<span class="token operator">+</span><span class="token string">&#39;/&#39;</span><span class="token operator">+</span>key<span class="token punctuation">,</span><span class="token keyword">function</span><span class="token operator">*</span><span class="token punctuation">(</span>action<span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line">                        <span class="token keyword">yield</span> model<span class="token punctuation">.</span>effects<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">(</span>action<span class="token punctuation">,</span>sagaEffects<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">                    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">                <span class="token punctuation">}</span></span>
<span class="line">            <span class="token punctuation">}</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">        <span class="token keyword">let</span> store <span class="token operator">=</span> <span class="token function">createStore</span><span class="token punctuation">(</span>rootReducer<span class="token punctuation">,</span><span class="token function">applyMiddleware</span><span class="token punctuation">(</span>sagaMiddleware<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        sagaMiddleware<span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span>rootSaga<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token operator">+</span>        <span class="token keyword">let</span> history <span class="token operator">=</span> <span class="token function">createHashHistory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token operator">+</span>        <span class="token keyword">let</span> App <span class="token operator">=</span> app<span class="token punctuation">.</span><span class="token function">_router</span><span class="token punctuation">(</span><span class="token punctuation">{</span>history<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token operator">+</span>        ReactDOM<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span><span class="token operator">&lt;</span>Provider store<span class="token operator">=</span><span class="token punctuation">{</span>store<span class="token punctuation">}</span><span class="token operator">&gt;</span><span class="token punctuation">{</span>App<span class="token punctuation">}</span><span class="token operator">&lt;</span><span class="token operator">/</span>Provider<span class="token operator">&gt;</span><span class="token punctuation">,</span>document<span class="token punctuation">.</span><span class="token function">querySelector</span><span class="token punctuation">(</span>root<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    <span class="token keyword">return</span> app<span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_5-3-src-dva-router-js" tabindex="-1"><a class="header-anchor" href="#_5-3-src-dva-router-js"><span>5.3 src\\dva\\router.js</span></a></h3><p>src\\dva\\router.js</p><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code class="language-javascript"><span class="line"><span class="token keyword">export</span> <span class="token operator">*</span> <span class="token keyword">from</span> <span class="token string">&#39;react-router-dom&#39;</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><h2 id="_6-支持跳转" tabindex="-1"><a class="header-anchor" href="#_6-支持跳转"><span>6.支持跳转</span></a></h2><h3 id="_6-1-src-index-js" tabindex="-1"><a class="header-anchor" href="#_6-1-src-index-js"><span>6.1 src\\index.js</span></a></h3><p>src\\index.js</p><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text"><pre><code class="language-text"><span class="line">import React from &#39;react&#39;;</span>
<span class="line">import dva,{connect} from &#39;./dva&#39;;</span>
<span class="line">+ import {Router,Route,routerRedux} from &#39;./dva/router&#39;;</span>
<span class="line">const app = dva();</span>
<span class="line">function delay(ms) {</span>
<span class="line">    return new Promise((resolve,reject) =&gt; {</span>
<span class="line">        setTimeout(function () {</span>
<span class="line">            resolve();</span>
<span class="line">        },ms);</span>
<span class="line">    });</span>
<span class="line">}</span>
<span class="line">app.model({</span>
<span class="line">    namespace:&#39;counter&#39;,</span>
<span class="line">    state:{number:0},</span>
<span class="line">    reducers:{</span>
<span class="line">        add(state){</span>
<span class="line">            return {number:state.number+1};</span>
<span class="line">        }</span>
<span class="line">    },</span>
<span class="line">    effects:{</span>
<span class="line">        *asyncAdd(action,{call,put}){</span>
<span class="line">          yield call(delay,1000);</span>
<span class="line">          yield put({type:&#39;counter/add&#39;});</span>
<span class="line">        },</span>
<span class="line">+       *goto({to}, { put }) {</span>
<span class="line">+         yield put(routerRedux.push(to));</span>
<span class="line">+       }</span>
<span class="line">    }</span>
<span class="line">});</span>
<span class="line">const Counter = connect(</span>
<span class="line">    state=&gt;state.counter</span>
<span class="line">)(props=&gt;(</span>
<span class="line">    &lt;div&gt;</span>
<span class="line">        &lt;p&gt;{props.number}&lt;/p&gt;</span>
<span class="line">        &lt;button onClick={()=&gt;props.dispatch({type:&quot;counter/add&quot;})}&gt;+&lt;/button&gt;</span>
<span class="line">        &lt;button onClick={()=&gt;props.dispatch({type:&quot;counter/asyncAdd&quot;})}&gt;异步+&lt;/button&gt;</span>
<span class="line">+       &lt;button onClick={()=&gt;props.dispatch({type:&quot;counter/goto&quot;,to:&#39;/&#39;})}&gt;跳转到/&lt;/button&gt;</span>
<span class="line">    &lt;/div&gt;</span>
<span class="line">));</span>
<span class="line">//index.js:1375 Warning: Please use \`require(&quot;history&quot;).createHashHistory\` instead of \`require(&quot;history/createHashHistory&quot;)\`. Support for the latter will be removed in the next major release.</span>
<span class="line">//index.js:1375 Warning: [sagaEffects.put] counter/add should not be prefixed with namespace counter</span>
<span class="line">const Home = ()=&gt;&lt;div&gt;Home&lt;/div&gt;</span>
<span class="line">app.router(({history})=&gt;(</span>
<span class="line">        &lt;&gt;</span>
<span class="line">            &lt;Route path=&quot;/&quot; exact={true} component={Home}/&gt;</span>
<span class="line">            &lt;Route path=&quot;/counter&quot; component={Counter}/&gt;</span>
<span class="line">        &lt;/&gt;</span>
<span class="line">));</span>
<span class="line"> app.start(&#39;</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_6-2-src-dva-index-js" tabindex="-1"><a class="header-anchor" href="#_6-2-src-dva-index-js"><span>6.2 src\\dva\\index.js</span></a></h3><p>src\\dva\\index.js</p><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code class="language-javascript"><span class="line"><span class="token keyword">import</span> React <span class="token keyword">from</span> <span class="token string">&#39;react&#39;</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">import</span> ReactDOM <span class="token keyword">from</span> <span class="token string">&#39;react-dom&#39;</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">import</span> <span class="token punctuation">{</span>createStore<span class="token punctuation">,</span>combineReducers<span class="token punctuation">,</span>applyMiddleware<span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&#39;redux&#39;</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">import</span> <span class="token punctuation">{</span>connect<span class="token punctuation">,</span>Provider<span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&#39;react-redux&#39;</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">import</span> createSagaMiddleware <span class="token keyword">from</span> <span class="token string">&#39;redux-saga&#39;</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">import</span> <span class="token operator">*</span> <span class="token keyword">as</span> sagaEffects <span class="token keyword">from</span> <span class="token string">&#39;redux-saga/effects&#39;</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">import</span> <span class="token punctuation">{</span>createHashHistory<span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&#39;history&#39;</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token operator">+</span><span class="token keyword">import</span> <span class="token punctuation">{</span></span>
<span class="line"><span class="token operator">+</span>  routerMiddleware<span class="token punctuation">,</span></span>
<span class="line"><span class="token operator">+</span>  connectRouter<span class="token punctuation">,</span></span>
<span class="line"><span class="token operator">+</span>  ConnectedRouter</span>
<span class="line"><span class="token operator">+</span><span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;connected-react-router&quot;</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token operator">+</span><span class="token keyword">const</span> <span class="token constant">NAMESPACE_SEPARATOR</span> <span class="token operator">=</span> <span class="token string">&quot;/&quot;</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">export</span> <span class="token punctuation">{</span>connect<span class="token punctuation">}</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">const</span> app <span class="token operator">=</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token literal-property property">_models</span><span class="token operator">:</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span></span>
<span class="line">        model<span class="token punctuation">,</span></span>
<span class="line">        <span class="token literal-property property">_router</span><span class="token operator">:</span><span class="token keyword">null</span><span class="token punctuation">,</span></span>
<span class="line">        router<span class="token punctuation">,</span></span>
<span class="line">        start</span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    <span class="token keyword">function</span> <span class="token function">model</span><span class="token punctuation">(</span><span class="token parameter">model</span><span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line">        app<span class="token punctuation">.</span>_models<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>model<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    <span class="token keyword">function</span> <span class="token function">router</span><span class="token punctuation">(</span><span class="token parameter">routerConfig</span><span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line">        app<span class="token punctuation">.</span>_router <span class="token operator">=</span> routerConfig<span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    <span class="token keyword">function</span> <span class="token function">start</span><span class="token punctuation">(</span><span class="token parameter">root</span><span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line"><span class="token operator">+</span>        <span class="token keyword">let</span> history <span class="token operator">=</span> <span class="token function">createHashHistory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token operator">+</span>        <span class="token keyword">const</span> reducers <span class="token operator">=</span> <span class="token punctuation">{</span></span>
<span class="line"><span class="token operator">+</span>            router<span class="token operator">:</span> <span class="token function">connectRouter</span><span class="token punctuation">(</span>history<span class="token punctuation">)</span></span>
<span class="line"><span class="token operator">+</span>        <span class="token punctuation">}</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">let</span> i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>i<span class="token operator">&lt;</span>app<span class="token punctuation">.</span>_models<span class="token punctuation">.</span>length<span class="token punctuation">;</span>i<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line">            <span class="token keyword">let</span> model <span class="token operator">=</span> app<span class="token punctuation">.</span>_models<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span></span>
<span class="line">            reducers<span class="token punctuation">[</span>model<span class="token punctuation">.</span>namespace<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">state<span class="token operator">=</span>model<span class="token punctuation">.</span>state<span class="token punctuation">,</span>action</span><span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line">                 <span class="token keyword">let</span> actionType <span class="token operator">=</span> action<span class="token punctuation">.</span>type<span class="token punctuation">;</span></span>
<span class="line">                 <span class="token keyword">let</span> <span class="token punctuation">[</span>namespace<span class="token punctuation">,</span>type<span class="token punctuation">]</span> <span class="token operator">=</span> actionType<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token constant">NAMESPACE_SEPARATOR</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">                 <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>type<span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line">                   type <span class="token operator">=</span> namespace<span class="token punctuation">;</span></span>
<span class="line">                   namespace <span class="token operator">=</span> model<span class="token punctuation">.</span>namespace<span class="token punctuation">;</span></span>
<span class="line">                 <span class="token punctuation">}</span></span>
<span class="line">                 <span class="token keyword">if</span><span class="token punctuation">(</span>namespace <span class="token operator">===</span> model<span class="token punctuation">.</span>namespace<span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line">                    <span class="token keyword">let</span> reducer <span class="token operator">=</span> model<span class="token punctuation">.</span>reducers<span class="token punctuation">[</span>type<span class="token punctuation">]</span><span class="token punctuation">;</span></span>
<span class="line">                    <span class="token keyword">if</span><span class="token punctuation">(</span>reducer<span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line">                        <span class="token keyword">return</span> <span class="token function">reducer</span><span class="token punctuation">(</span>state<span class="token punctuation">,</span>action<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">                    <span class="token punctuation">}</span></span>
<span class="line">                 <span class="token punctuation">}</span></span>
<span class="line">                 <span class="token keyword">return</span> state<span class="token punctuation">;</span></span>
<span class="line">            <span class="token punctuation">}</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">        <span class="token keyword">let</span> rootReducer <span class="token operator">=</span> <span class="token function">combineReducers</span><span class="token punctuation">(</span>reducers<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">let</span> sagaMiddleware <span class="token operator">=</span> <span class="token function">createSagaMiddleware</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">function</span><span class="token operator">*</span> <span class="token function">rootSaga</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line">            <span class="token keyword">let</span> <span class="token punctuation">{</span>takeEvery<span class="token punctuation">}</span> <span class="token operator">=</span>  sagaEffects<span class="token punctuation">;</span></span>
<span class="line">            <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">const</span> model <span class="token keyword">of</span> app<span class="token punctuation">.</span>_models<span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line">                <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">const</span> key <span class="token keyword">in</span> model<span class="token punctuation">.</span>effects<span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line"><span class="token operator">+</span>                    <span class="token keyword">yield</span> <span class="token function">takeEvery</span><span class="token punctuation">(</span>model<span class="token punctuation">.</span>namespace<span class="token operator">+</span><span class="token constant">NAMESPACE_SEPARATOR</span><span class="token operator">+</span>key<span class="token punctuation">,</span><span class="token keyword">function</span><span class="token operator">*</span><span class="token punctuation">(</span>action<span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line"><span class="token operator">+</span>                        <span class="token keyword">yield</span> model<span class="token punctuation">.</span>effects<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">(</span>action<span class="token punctuation">,</span>sagaEffects<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token operator">+</span>                    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">                <span class="token punctuation">}</span></span>
<span class="line">            <span class="token punctuation">}</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line"><span class="token operator">+</span>        <span class="token keyword">let</span> store <span class="token operator">=</span> <span class="token function">createStore</span><span class="token punctuation">(</span>rootReducer<span class="token punctuation">,</span><span class="token function">applyMiddleware</span><span class="token punctuation">(</span><span class="token function">routerMiddleware</span><span class="token punctuation">(</span>history<span class="token punctuation">)</span><span class="token punctuation">,</span>sagaMiddleware<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        sagaMiddleware<span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span>rootSaga<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token operator">+</span>        <span class="token keyword">let</span> App <span class="token operator">=</span> app<span class="token punctuation">.</span><span class="token function">_router</span><span class="token punctuation">(</span><span class="token punctuation">{</span>history<span class="token punctuation">,</span>app<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token operator">+</span>        ReactDOM<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span></span>
<span class="line"><span class="token operator">+</span>        <span class="token operator">&lt;</span>Provider store<span class="token operator">=</span><span class="token punctuation">{</span>store<span class="token punctuation">}</span><span class="token operator">&gt;</span></span>
<span class="line"><span class="token operator">+</span>            <span class="token operator">&lt;</span>ConnectedRouter history<span class="token operator">=</span><span class="token punctuation">{</span>history<span class="token punctuation">}</span><span class="token operator">&gt;</span></span>
<span class="line"><span class="token operator">+</span>              <span class="token punctuation">{</span>App<span class="token punctuation">}</span></span>
<span class="line"><span class="token operator">+</span>            <span class="token operator">&lt;</span><span class="token operator">/</span>ConnectedRouter <span class="token operator">&gt;</span></span>
<span class="line"><span class="token operator">+</span>        <span class="token operator">&lt;</span><span class="token operator">/</span>Provider<span class="token operator">&gt;</span><span class="token punctuation">,</span>document<span class="token punctuation">.</span><span class="token function">querySelector</span><span class="token punctuation">(</span>root<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    <span class="token keyword">return</span> app<span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_6-3-src-dva-router-js" tabindex="-1"><a class="header-anchor" href="#_6-3-src-dva-router-js"><span>6.3 src\\dva\\router.js</span></a></h3><p>src\\dva\\router.js</p><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text"><pre><code class="language-text"><span class="line">+module.exports = require(&#39;react-router-dom&#39;);</span>
<span class="line">+module.exports.routerRedux = require(&#39;connected-react-router&#39;);</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="_7-支持自定义effects" tabindex="-1"><a class="header-anchor" href="#_7-支持自定义effects"><span>7.支持自定义effects</span></a></h2><h3 id="_7-1-src-index-js" tabindex="-1"><a class="header-anchor" href="#_7-1-src-index-js"><span>7.1 src\\index.js</span></a></h3><p>src\\index.js</p><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text"><pre><code class="language-text"><span class="line">import React from &#39;react&#39;;</span>
<span class="line">import dva,{connect} from &#39;dva&#39;;</span>
<span class="line">import {Router,Route,routerRedux} from &#39;dva/router&#39;;</span>
<span class="line">const app = dva();</span>
<span class="line">function delay(ms) {</span>
<span class="line">    return new Promise((resolve,reject) =&gt; {</span>
<span class="line">        setTimeout(function () {</span>
<span class="line">            resolve();</span>
<span class="line">        },ms);</span>
<span class="line">    });</span>
<span class="line">}</span>
<span class="line">app.model({</span>
<span class="line">    namespace:&#39;counter&#39;,</span>
<span class="line">    state:{number:0},</span>
<span class="line">    reducers:{</span>
<span class="line">        add(state,){</span>
<span class="line">            return {number:state.number+1};</span>
<span class="line">        },</span>
<span class="line">        increment(state,{payload}){</span>
<span class="line">           return {number:state.number+payload||1};</span>
<span class="line">        }</span>
<span class="line">    },</span>
<span class="line">    effects:{</span>
<span class="line">       *asyncAdd(action,{call,put}){</span>
<span class="line">          yield call(delay,1000);</span>
<span class="line">          yield put({type:&#39;counter/add&#39;});</span>
<span class="line">       },</span>
<span class="line">       *goto({to}, { put }) {</span>
<span class="line">         yield put(routerRedux.push(to));</span>
<span class="line">       },</span>
<span class="line">+       addWatchers:[</span>
<span class="line">+           function*({take,put,call}){</span>
<span class="line">+               for(let i=0;i&lt;3;i++){</span>
<span class="line">+                   const {payload} = yield take(&#39;counter/addWatcher&#39;);</span>
<span class="line">+                   yield call(delay,1000);</span>
<span class="line">+                   yield put({type:&#39;counter/increment&#39;,payload});</span>
<span class="line">+               }</span>
<span class="line">+               alert(&#39;不能再加了&#39;);</span>
<span class="line">+           },</span>
<span class="line">+           {type:&#39;watcher&#39;}</span>
<span class="line">+       ]</span>
<span class="line">    }</span>
<span class="line">});</span>
<span class="line">const Counter = connect(</span>
<span class="line">    state=&gt;state.counter</span>
<span class="line">)(props=&gt;(</span>
<span class="line">    &lt;div&gt;</span>
<span class="line">        &lt;p&gt;{props.number}&lt;/p&gt;</span>
<span class="line">        &lt;button onClick={()=&gt;props.dispatch({type:&quot;counter/add&quot;})}&gt;+&lt;/button&gt;</span>
<span class="line">        &lt;button onClick={()=&gt;props.dispatch({type:&quot;counter/asyncAdd&quot;})}&gt;异步+&lt;/button&gt;</span>
<span class="line">+        &lt;button onClick={()=&gt;props.dispatch({type:&quot;counter/addWatcher&quot;,payload:2})}&gt;自定义异步+2&lt;/button&gt;</span>
<span class="line">        &lt;button onClick={()=&gt;props.dispatch({type:&quot;counter/goto&quot;,to:&#39;/&#39;})}&gt;跳转到/&lt;/button&gt;</span>
<span class="line">    &lt;/div&gt;</span>
<span class="line">));</span>
<span class="line">const Home = ()=&gt;&lt;div&gt;Home&lt;/div&gt;</span>
<span class="line">app.router(({history})=&gt;(</span>
<span class="line">    &lt;Router history={history}&gt;</span>
<span class="line">        &lt;&gt;</span>
<span class="line">            &lt;Route path=&quot;/&quot; exact={true} component={Home}/&gt;</span>
<span class="line">            &lt;Route path=&quot;/counter&quot; component={Counter}/&gt;</span>
<span class="line">        &lt;/&gt;</span>
<span class="line">    &lt;/Router&gt;</span>
<span class="line">));</span>
<span class="line"> app.start(&#39;</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_7-2-src-dva-index-js" tabindex="-1"><a class="header-anchor" href="#_7-2-src-dva-index-js"><span>7.2 src\\dva\\index.js</span></a></h3><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code class="language-javascript"><span class="line"><span class="token keyword">import</span> React <span class="token keyword">from</span> <span class="token string">&#39;react&#39;</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">import</span> ReactDOM <span class="token keyword">from</span> <span class="token string">&#39;react-dom&#39;</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">import</span> <span class="token punctuation">{</span>createStore<span class="token punctuation">,</span>combineReducers<span class="token punctuation">,</span>applyMiddleware<span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&#39;redux&#39;</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">import</span> <span class="token punctuation">{</span>connect<span class="token punctuation">,</span>Provider<span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&#39;react-redux&#39;</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">import</span> createSagaMiddleware <span class="token keyword">from</span> <span class="token string">&#39;redux-saga&#39;</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">import</span> <span class="token operator">*</span> <span class="token keyword">as</span> sagaEffects <span class="token keyword">from</span> <span class="token string">&#39;redux-saga/effects&#39;</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">import</span> <span class="token punctuation">{</span>createHashHistory<span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&#39;history&#39;</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">import</span> <span class="token punctuation">{</span></span>
<span class="line">  routerMiddleware<span class="token punctuation">,</span></span>
<span class="line">  connectRouter<span class="token punctuation">,</span></span>
<span class="line">  ConnectedRouter</span>
<span class="line"><span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;connected-react-router&quot;</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">export</span> <span class="token punctuation">{</span>connect<span class="token punctuation">}</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">const</span> app <span class="token operator">=</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token literal-property property">_models</span><span class="token operator">:</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span></span>
<span class="line">        model<span class="token punctuation">,</span></span>
<span class="line">        <span class="token literal-property property">_router</span><span class="token operator">:</span><span class="token keyword">null</span><span class="token punctuation">,</span></span>
<span class="line">        router<span class="token punctuation">,</span></span>
<span class="line">        start</span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    <span class="token keyword">function</span> <span class="token function">model</span><span class="token punctuation">(</span><span class="token parameter">model</span><span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line">        app<span class="token punctuation">.</span>_models<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>model<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    <span class="token keyword">function</span> <span class="token function">router</span><span class="token punctuation">(</span><span class="token parameter">routerConfig</span><span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line">        app<span class="token punctuation">.</span>_router <span class="token operator">=</span> routerConfig<span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    <span class="token keyword">function</span> <span class="token function">start</span><span class="token punctuation">(</span><span class="token parameter">root</span><span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">let</span> history <span class="token operator">=</span> <span class="token function">createHashHistory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">const</span> reducers <span class="token operator">=</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token literal-property property">router</span><span class="token operator">:</span> <span class="token function">connectRouter</span><span class="token punctuation">(</span>history<span class="token punctuation">)</span></span>
<span class="line">        <span class="token punctuation">}</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">let</span> i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>i<span class="token operator">&lt;</span>app<span class="token punctuation">.</span>_models<span class="token punctuation">.</span>length<span class="token punctuation">;</span>i<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line">            <span class="token keyword">let</span> model <span class="token operator">=</span> app<span class="token punctuation">.</span>_models<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span></span>
<span class="line">            reducers<span class="token punctuation">[</span>model<span class="token punctuation">.</span>namespace<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">state<span class="token operator">=</span>model<span class="token punctuation">.</span>state<span class="token punctuation">,</span>action</span><span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line">                 <span class="token keyword">let</span> actionType <span class="token operator">=</span> action<span class="token punctuation">.</span>type<span class="token punctuation">;</span></span>
<span class="line">                 <span class="token keyword">let</span> values <span class="token operator">=</span> actionType<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">&#39;/&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">                 <span class="token keyword">if</span><span class="token punctuation">(</span>values<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">===</span> model<span class="token punctuation">.</span>namespace<span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line">                    <span class="token keyword">let</span> reducer <span class="token operator">=</span> model<span class="token punctuation">.</span>reducers<span class="token punctuation">[</span>values<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">;</span></span>
<span class="line">                    <span class="token keyword">if</span><span class="token punctuation">(</span>reducer<span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line">                        <span class="token keyword">return</span> <span class="token function">reducer</span><span class="token punctuation">(</span>state<span class="token punctuation">,</span>action<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">                    <span class="token punctuation">}</span></span>
<span class="line">                 <span class="token punctuation">}</span></span>
<span class="line">                 <span class="token keyword">return</span> state<span class="token punctuation">;</span></span>
<span class="line">            <span class="token punctuation">}</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">        <span class="token keyword">let</span> rootReducer <span class="token operator">=</span> <span class="token function">combineReducers</span><span class="token punctuation">(</span>reducers<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">         <span class="token keyword">let</span> sagaMiddleware <span class="token operator">=</span> <span class="token function">createSagaMiddleware</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">function</span><span class="token operator">*</span> <span class="token function">rootSaga</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line">            <span class="token keyword">let</span> <span class="token punctuation">{</span>takeEvery<span class="token punctuation">}</span> <span class="token operator">=</span>  sagaEffects<span class="token punctuation">;</span></span>
<span class="line">            <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">const</span> model <span class="token keyword">of</span> app<span class="token punctuation">.</span>_models<span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line"><span class="token operator">+</span>                <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">const</span> key <span class="token keyword">in</span> model<span class="token punctuation">.</span>effects<span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line"><span class="token operator">+</span>                    <span class="token keyword">let</span> effect <span class="token operator">=</span> model<span class="token punctuation">.</span>effects<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token operator">+</span>                    <span class="token keyword">if</span><span class="token punctuation">(</span>Array<span class="token punctuation">.</span><span class="token function">isArray</span><span class="token punctuation">(</span>effect<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> effect<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>type <span class="token operator">==</span> <span class="token string">&#39;watcher&#39;</span><span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line"><span class="token operator">+</span>                       <span class="token keyword">yield</span> sagaEffects<span class="token punctuation">.</span><span class="token function">fork</span><span class="token punctuation">(</span>effect<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span>sagaEffects<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token operator">+</span>                    <span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{</span></span>
<span class="line"><span class="token operator">+</span>                      <span class="token keyword">yield</span> <span class="token function">takeEvery</span><span class="token punctuation">(</span>model<span class="token punctuation">.</span>namespace<span class="token operator">+</span><span class="token string">&#39;/&#39;</span><span class="token operator">+</span>key<span class="token punctuation">,</span><span class="token keyword">function</span><span class="token operator">*</span><span class="token punctuation">(</span>action<span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line"><span class="token operator">+</span>                        <span class="token keyword">yield</span> model<span class="token punctuation">.</span>effects<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">(</span>action<span class="token punctuation">,</span>sagaEffects<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token operator">+</span>                      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token operator">+</span>                    <span class="token punctuation">}</span></span>
<span class="line"><span class="token operator">+</span>                <span class="token punctuation">}</span></span>
<span class="line"><span class="token operator">+</span>            <span class="token punctuation">}</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">        <span class="token keyword">let</span> store <span class="token operator">=</span> <span class="token function">createStore</span><span class="token punctuation">(</span>rootReducer<span class="token punctuation">,</span><span class="token function">applyMiddleware</span><span class="token punctuation">(</span><span class="token function">routerMiddleware</span><span class="token punctuation">(</span>history<span class="token punctuation">)</span><span class="token punctuation">,</span>sagaMiddleware<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        sagaMiddleware<span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span>rootSaga<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">let</span> App <span class="token operator">=</span> app<span class="token punctuation">.</span><span class="token function">_router</span><span class="token punctuation">(</span><span class="token punctuation">{</span>history<span class="token punctuation">,</span>app<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        ReactDOM<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span></span>
<span class="line">        <span class="token operator">&lt;</span>Provider store<span class="token operator">=</span><span class="token punctuation">{</span>store<span class="token punctuation">}</span><span class="token operator">&gt;</span></span>
<span class="line">            <span class="token operator">&lt;</span>ConnectedRouter history<span class="token operator">=</span><span class="token punctuation">{</span>history<span class="token punctuation">}</span><span class="token operator">&gt;</span></span>
<span class="line">              <span class="token punctuation">{</span>App<span class="token punctuation">}</span></span>
<span class="line">            <span class="token operator">&lt;</span><span class="token operator">/</span>ConnectedRouter <span class="token operator">&gt;</span></span>
<span class="line">        <span class="token operator">&lt;</span><span class="token operator">/</span>Provider<span class="token operator">&gt;</span><span class="token punctuation">,</span>document<span class="token punctuation">.</span><span class="token function">querySelector</span><span class="token punctuation">(</span>root<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    <span class="token keyword">return</span> app<span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="_8-支持钩子" tabindex="-1"><a class="header-anchor" href="#_8-支持钩子"><span>8.支持钩子</span></a></h2><h3 id="_8-1-src-index-js" tabindex="-1"><a class="header-anchor" href="#_8-1-src-index-js"><span>8.1 src\\index.js</span></a></h3><p>src\\index.js</p><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text"><pre><code class="language-text"><span class="line">import React from &#39;react&#39;;</span>
<span class="line">import dva,{connect} from &#39;dva&#39;;</span>
<span class="line">import {Router,Route,routerRedux} from &#39;dva/router&#39;;</span>
<span class="line">+import { message } from &#39;antd&#39;;</span>
<span class="line">+import logger from &#39;redux-logger&#39;;</span>
<span class="line">+import {createBrowserHistory} from &#39;history&#39;;</span>
<span class="line">+import &#39;antd/dist/antd.css&#39;</span>
<span class="line">+const SHOW = &#39;SHOW&#39;;</span>
<span class="line">+const HIDE = &#39;HIDE&#39;;</span>
<span class="line">+const initialState = {</span>
<span class="line">+    global: false,</span>
<span class="line">+    models: {},</span>
<span class="line">+    effects: {}</span>
<span class="line">+};</span>
<span class="line">+const app = dva({</span>
<span class="line">+    history:createBrowserHistory(),//自定义history</span>
<span class="line">+    initialState:{counter:{number:5}},//自定义初始状态</span>
<span class="line">+    //effect 执行错误或 subscription 通过 done 主动抛错时触发，可用于管理全局出错状态</span>
<span class="line">+    onError:((err, dispatch) =&gt; {message.error(err.message)}),</span>
<span class="line">+    //在 action 被 dispatch 时触发，用于注册 redux 中间件。支持函数或函数数组格式</span>
<span class="line">+    onAction:logger,</span>
<span class="line">+    //state 改变时触发，可用于同步 state 到 localStorage，服务器端等</span>
<span class="line">+    onStateChange:(state)=&gt;{console.log(state)},</span>
<span class="line">+    //封装 reducer 执行。比如借助 redux-undo 实现 redo/undo</span>
<span class="line">+    onReducer:reducer=&gt;(state,action)=&gt;{//增加额外的reducer</span>
<span class="line">+      localStorage.setItem(&#39;action&#39;,JSON.stringify(action));</span>
<span class="line">+      return reducer(state,action);</span>
<span class="line">+    },</span>
<span class="line">+    //封装 effect 执行。比如 dva-loading 基于此实现了自动处理 loading 状态。</span>
<span class="line">+    onEffect:(effect, { put }, model, actionType)=&gt;{</span>
<span class="line">+      const { namespace } = model;</span>
<span class="line">+      return function*(...args) {</span>
<span class="line">+        yield put({ type: SHOW, payload: { namespace, actionType } });</span>
<span class="line">+        yield effect(...args);</span>
<span class="line">+        yield put({ type: HIDE, payload: { namespace, actionType } });</span>
<span class="line">+      };</span>
<span class="line">+    },</span>
<span class="line">+    //指定额外的 reducer，比如 redux-form 需要指定额外的 form reducer：</span>
<span class="line">+    extraReducers:{</span>
<span class="line">+      loading(state = initialState, { type, payload }) {</span>
<span class="line">+        const { namespace, actionType } = payload || {};</span>
<span class="line">+        switch(type){</span>
<span class="line">+          case SHOW:</span>
<span class="line">+            return {global:true,models: { ...state.models, [namespace]: true }, effects: { ...state.effects, [actionType]: true },};</span>
<span class="line">+          case HIDE:</span>
<span class="line">+            const effects = { ...state.effects, [actionType]: false };</span>
<span class="line">+            const models = { ...state.models, [namespace]: false };</span>
<span class="line">+            const global = Object.keys(models).some(namespace =&gt; {</span>
<span class="line">+                return models[namespace];</span>
<span class="line">+            });</span>
<span class="line">+            return {global,models,effects};</span>
<span class="line">+          default:</span>
<span class="line">+            return state;  </span>
<span class="line">+        }</span>
<span class="line">+      }</span>
<span class="line">+    },</span>
<span class="line">+    //指定额外的 StoreEnhancer ，比如结合 redux-persist 的使用：</span>
<span class="line">+    //指定额外的 StoreEnhancer</span>
<span class="line">+    //它的参数是创建store的函数（store creator），返回值是一个可以创建功能更加强大的store的函数(enhanced store creator)</span>
<span class="line">+    extraEnhancers:(createStore)=&gt;{</span>
<span class="line">+       return (...args)=&gt;{</span>
<span class="line">+           let store = createStore(...args);</span>
<span class="line">+           console.log(&#39;返回更强大的store&#39;)</span>
<span class="line">+           return {...store,more(){console.log(&#39;更强大的强能&#39;)}};</span>
<span class="line">+       }</span>
<span class="line">+    }</span>
<span class="line">+});</span>
<span class="line">function delay(ms) {</span>
<span class="line">    return new Promise((resolve,reject) =&gt; {</span>
<span class="line">        setTimeout(function () {</span>
<span class="line">            resolve();</span>
<span class="line">        },ms);</span>
<span class="line">    });</span>
<span class="line">}</span>
<span class="line">app.model({</span>
<span class="line">    namespace:&#39;counter&#39;,</span>
<span class="line">    state:{number:0},</span>
<span class="line">    reducers:{</span>
<span class="line">        add(state,){</span>
<span class="line">            return {number:state.number+1};</span>
<span class="line">        },</span>
<span class="line">        increment(state,{payload}){</span>
<span class="line">           return {number:state.number+payload||1};</span>
<span class="line">        }</span>
<span class="line">    },</span>
<span class="line">    effects:{</span>
<span class="line">       *asyncAdd(action,{call,put}){</span>
<span class="line">          yield call(delay,1000);</span>
<span class="line">          yield put({type:&#39;counter/add&#39;});</span>
<span class="line">       },</span>
<span class="line">       *goto({to}, { put }) {</span>
<span class="line">         yield put(routerRedux.push(to));</span>
<span class="line">       },</span>
<span class="line">       addWatchers:[</span>
<span class="line">           function*({take,put,call}){</span>
<span class="line">               for(let i=0;i&lt;3;i++){</span>
<span class="line">                   const {payload} = yield take(&#39;counter/addWatcher&#39;);</span>
<span class="line">                   yield call(delay,1000);</span>
<span class="line">                   yield put({type:&#39;counter/increment&#39;,payload});</span>
<span class="line">               }</span>
<span class="line">               alert(&#39;不能再加了&#39;);</span>
<span class="line">           },</span>
<span class="line">           {type:&#39;watcher&#39;}</span>
<span class="line">       ]</span>
<span class="line">    }</span>
<span class="line">});</span>
<span class="line">const Counter = connect(</span>
<span class="line">    state=&gt;state.counter</span>
<span class="line">)(props=&gt;(</span>
<span class="line">    &lt;div&gt;</span>
<span class="line">        &lt;p&gt;{props.number}&lt;/p&gt;</span>
<span class="line">        &lt;button onClick={()=&gt;props.dispatch({type:&quot;counter/add&quot;})}&gt;+&lt;/button&gt;</span>
<span class="line">        &lt;button onClick={()=&gt;props.dispatch({type:&quot;counter/asyncAdd&quot;})}&gt;异步+&lt;/button&gt;</span>
<span class="line">        &lt;button onClick={()=&gt;props.dispatch({type:&quot;counter/addWatcher&quot;,payload:2})}&gt;自定义异步+2&lt;/button&gt;</span>
<span class="line">        &lt;button onClick={()=&gt;props.dispatch({type:&quot;counter/goto&quot;,to:&#39;/&#39;})}&gt;跳转到/&lt;/button&gt;</span>
<span class="line">    &lt;/div&gt;</span>
<span class="line">));</span>
<span class="line">const Home = ()=&gt;&lt;div&gt;Home&lt;/div&gt;</span>
<span class="line">app.router(({history})=&gt;(</span>
<span class="line">    &lt;Router history={history}&gt;</span>
<span class="line">        &lt;&gt;</span>
<span class="line">            &lt;Route path=&quot;/&quot; exact={true} component={Home}/&gt;</span>
<span class="line">            &lt;Route path=&quot;/counter&quot; component={Counter}/&gt;</span>
<span class="line">        &lt;/&gt;</span>
<span class="line">    &lt;/Router&gt;</span>
<span class="line">));</span>
<span class="line"> app.start(&#39;</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_8-2-src-dva-index-js" tabindex="-1"><a class="header-anchor" href="#_8-2-src-dva-index-js"><span>8.2 src\\dva\\index.js</span></a></h3><p>src\\dva\\index.js</p><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code class="language-javascript"><span class="line"><span class="token keyword">import</span> React <span class="token keyword">from</span> <span class="token string">&quot;react&quot;</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">import</span> ReactDOM <span class="token keyword">from</span> <span class="token string">&quot;react-dom&quot;</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">import</span> <span class="token punctuation">{</span> createStore<span class="token punctuation">,</span> combineReducers<span class="token punctuation">,</span> applyMiddleware <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;redux&quot;</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">import</span> <span class="token punctuation">{</span> connect<span class="token punctuation">,</span> Provider <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;react-redux&quot;</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">import</span> createSagaMiddleware <span class="token keyword">from</span> <span class="token string">&quot;redux-saga&quot;</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">import</span> <span class="token operator">*</span> <span class="token keyword">as</span> sagaEffects <span class="token keyword">from</span> <span class="token string">&quot;redux-saga/effects&quot;</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">import</span> <span class="token punctuation">{</span> createHashHistory <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;history&quot;</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">import</span> <span class="token punctuation">{</span></span>
<span class="line">  routerMiddleware<span class="token punctuation">,</span></span>
<span class="line">  connectRouter<span class="token punctuation">,</span></span>
<span class="line">  ConnectedRouter</span>
<span class="line"><span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;connected-react-router&quot;</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">const</span> <span class="token constant">NAMESPACE_SEPARATOR</span> <span class="token operator">=</span> <span class="token string">&quot;/&quot;</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">export</span> <span class="token punctuation">{</span> connect <span class="token punctuation">}</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">options</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">  <span class="token keyword">const</span> app <span class="token operator">=</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token literal-property property">_models</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span></span>
<span class="line">    model<span class="token punctuation">,</span></span>
<span class="line">    <span class="token literal-property property">_router</span><span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span></span>
<span class="line">    router<span class="token punctuation">,</span></span>
<span class="line">    start</span>
<span class="line">  <span class="token punctuation">}</span><span class="token punctuation">;</span></span>
<span class="line">  <span class="token keyword">function</span> <span class="token function">model</span><span class="token punctuation">(</span><span class="token parameter">model</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    app<span class="token punctuation">.</span>_models<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>model<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">  <span class="token punctuation">}</span></span>
<span class="line">  <span class="token keyword">function</span> <span class="token function">router</span><span class="token punctuation">(</span><span class="token parameter">routerConfig</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    app<span class="token punctuation">.</span>_router <span class="token operator">=</span> routerConfig<span class="token punctuation">;</span></span>
<span class="line">  <span class="token punctuation">}</span></span>
<span class="line"><span class="token operator">+</span>  <span class="token keyword">let</span> history <span class="token operator">=</span> options<span class="token punctuation">.</span>history<span class="token operator">||</span><span class="token function">createHashHistory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">  <span class="token keyword">function</span> <span class="token function">start</span><span class="token punctuation">(</span><span class="token parameter">root</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line"><span class="token operator">-</span>  <span class="token keyword">let</span> history <span class="token operator">=</span> <span class="token function">createHashHistory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token operator">+</span>    <span class="token keyword">let</span> reducers <span class="token operator">=</span> <span class="token punctuation">{</span></span>
<span class="line"><span class="token operator">+</span>      router<span class="token operator">:</span> <span class="token function">connectRouter</span><span class="token punctuation">(</span>history<span class="token punctuation">)</span></span>
<span class="line"><span class="token operator">+</span>    <span class="token punctuation">}</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token operator">+</span>    <span class="token keyword">if</span><span class="token punctuation">(</span>options<span class="token punctuation">.</span>extraReducers<span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line"><span class="token operator">+</span>        reducers <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token operator">...</span>reducers<span class="token punctuation">,</span><span class="token operator">...</span>options<span class="token punctuation">.</span>extraReducers<span class="token punctuation">}</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token operator">+</span>    <span class="token punctuation">}</span></span>
<span class="line">    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> app<span class="token punctuation">.</span>_models<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">      <span class="token keyword">let</span> model <span class="token operator">=</span> app<span class="token punctuation">.</span>_models<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span></span>
<span class="line">      reducers<span class="token punctuation">[</span>model<span class="token punctuation">.</span>namespace<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">state <span class="token operator">=</span> model<span class="token punctuation">.</span>state<span class="token punctuation">,</span> action</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">let</span> actionType <span class="token operator">=</span> action<span class="token punctuation">.</span>type<span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">let</span> values <span class="token operator">=</span> actionType<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token constant">NAMESPACE_SEPARATOR</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">if</span> <span class="token punctuation">(</span>values<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">===</span> model<span class="token punctuation">.</span>namespace<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">          <span class="token keyword">let</span> reducer <span class="token operator">=</span> model<span class="token punctuation">.</span>reducers<span class="token punctuation">[</span>values<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">;</span></span>
<span class="line">          <span class="token keyword">if</span> <span class="token punctuation">(</span>reducer<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token keyword">return</span> <span class="token function">reducer</span><span class="token punctuation">(</span>state<span class="token punctuation">,</span> action<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">          <span class="token punctuation">}</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">        <span class="token keyword">return</span> state<span class="token punctuation">;</span></span>
<span class="line">      <span class="token punctuation">}</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"><span class="token operator">+</span>    <span class="token keyword">let</span> combinedReducer  <span class="token operator">=</span> <span class="token function">combineReducers</span><span class="token punctuation">(</span>reducers<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token operator">+</span>    <span class="token keyword">let</span> <span class="token function-variable function">rootReducer</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">state<span class="token punctuation">,</span>action</span><span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line"><span class="token operator">+</span>        <span class="token keyword">let</span> newState <span class="token operator">=</span>  <span class="token function">combinedReducer</span><span class="token punctuation">(</span>state<span class="token punctuation">,</span>action<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token operator">+</span>        options<span class="token punctuation">.</span>onStateChange<span class="token operator">&amp;&amp;</span>options<span class="token punctuation">.</span><span class="token function">onStateChange</span><span class="token punctuation">(</span>newState<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token operator">+</span>        <span class="token keyword">return</span> newState<span class="token punctuation">;</span></span>
<span class="line"><span class="token operator">+</span>    <span class="token punctuation">}</span></span>
<span class="line"><span class="token operator">+</span>    <span class="token keyword">if</span><span class="token punctuation">(</span>options<span class="token punctuation">.</span>onReducer<span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line"><span class="token operator">+</span>        rootReducer <span class="token operator">=</span> options<span class="token punctuation">.</span><span class="token function">onReducer</span><span class="token punctuation">(</span>rootReducer<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token operator">+</span>    <span class="token punctuation">}</span></span>
<span class="line">    <span class="token keyword">let</span> sagaMiddleware <span class="token operator">=</span> <span class="token function">createSagaMiddleware</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">function</span><span class="token operator">*</span> <span class="token function">rootSaga</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">      <span class="token keyword">let</span> <span class="token punctuation">{</span> takeEvery <span class="token punctuation">}</span> <span class="token operator">=</span> sagaEffects<span class="token punctuation">;</span></span>
<span class="line">      <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> model <span class="token keyword">of</span> app<span class="token punctuation">.</span>_models<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> key <span class="token keyword">in</span> model<span class="token punctuation">.</span>effects<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">          <span class="token keyword">let</span> effect <span class="token operator">=</span> model<span class="token punctuation">.</span>effects<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">;</span></span>
<span class="line">          <span class="token keyword">if</span> <span class="token punctuation">(</span>Array<span class="token punctuation">.</span><span class="token function">isArray</span><span class="token punctuation">(</span>effect<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> effect<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>type <span class="token operator">==</span> <span class="token string">&quot;watcher&quot;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token keyword">yield</span> sagaEffects<span class="token punctuation">.</span><span class="token function">fork</span><span class="token punctuation">(</span>effect<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> sagaEffects<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">          <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token keyword">yield</span> <span class="token function">takeEvery</span><span class="token punctuation">(</span></span>
<span class="line">              model<span class="token punctuation">.</span>namespace <span class="token operator">+</span> <span class="token constant">NAMESPACE_SEPARATOR</span> <span class="token operator">+</span> key<span class="token punctuation">,</span></span>
<span class="line">              <span class="token keyword">function</span><span class="token operator">*</span><span class="token punctuation">(</span>action<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">                <span class="token keyword">yield</span> model<span class="token punctuation">.</span>effects<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">(</span>action<span class="token punctuation">,</span> sagaEffects<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">              <span class="token punctuation">}</span></span>
<span class="line">            <span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">          <span class="token punctuation">}</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">      <span class="token punctuation">}</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"><span class="token operator">+</span>    <span class="token keyword">if</span><span class="token punctuation">(</span>options<span class="token punctuation">.</span>onAction<span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line"><span class="token operator">+</span>        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token keyword">typeof</span> options<span class="token punctuation">.</span>onAction <span class="token operator">==</span> <span class="token string">&#39;function&#39;</span><span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line"><span class="token operator">+</span>            options<span class="token punctuation">.</span>onAction <span class="token operator">=</span> <span class="token punctuation">[</span>options<span class="token punctuation">.</span>onAction<span class="token punctuation">]</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token operator">+</span>        <span class="token punctuation">}</span></span>
<span class="line"><span class="token operator">+</span>    <span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{</span></span>
<span class="line"><span class="token operator">+</span>        options<span class="token punctuation">.</span>onAction<span class="token operator">=</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token operator">+</span>    <span class="token punctuation">}</span></span>
<span class="line"><span class="token operator">+</span>    <span class="token keyword">let</span> enhancedCreateStore<span class="token punctuation">;</span></span>
<span class="line"><span class="token operator">+</span>    <span class="token keyword">if</span><span class="token punctuation">(</span>options<span class="token punctuation">.</span>extraEnhancers<span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line"><span class="token operator">+</span>        enhancedCreateStore <span class="token operator">=</span> options<span class="token punctuation">.</span><span class="token function">extraEnhancers</span><span class="token punctuation">(</span>createStore<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token operator">+</span>    <span class="token punctuation">}</span></span>
<span class="line"><span class="token operator">+</span>    <span class="token keyword">let</span> store <span class="token operator">=</span> <span class="token function">enhancedCreateStore</span><span class="token punctuation">(</span></span>
<span class="line"><span class="token operator">+</span>      rootReducer<span class="token punctuation">,</span></span>
<span class="line"><span class="token operator">+</span>      <span class="token function">applyMiddleware</span><span class="token punctuation">(</span><span class="token function">routerMiddleware</span><span class="token punctuation">(</span>history<span class="token punctuation">)</span><span class="token punctuation">,</span> sagaMiddleware<span class="token punctuation">,</span><span class="token operator">...</span>options<span class="token punctuation">.</span>onAction<span class="token punctuation">)</span></span>
<span class="line"><span class="token operator">+</span>    <span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    sagaMiddleware<span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span>rootSaga<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">let</span> App <span class="token operator">=</span> app<span class="token punctuation">.</span><span class="token function">_router</span><span class="token punctuation">(</span><span class="token punctuation">{</span> history<span class="token punctuation">,</span> app <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    ReactDOM<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span></span>
<span class="line">      <span class="token operator">&lt;</span>Provider store<span class="token operator">=</span><span class="token punctuation">{</span>store<span class="token punctuation">}</span><span class="token operator">&gt;</span></span>
<span class="line">        <span class="token operator">&lt;</span>ConnectedRouter history<span class="token operator">=</span><span class="token punctuation">{</span>history<span class="token punctuation">}</span><span class="token operator">&gt;</span><span class="token punctuation">{</span>App<span class="token punctuation">}</span><span class="token operator">&lt;</span><span class="token operator">/</span>ConnectedRouter<span class="token operator">&gt;</span></span>
<span class="line">      <span class="token operator">&lt;</span><span class="token operator">/</span>Provider<span class="token operator">&gt;</span><span class="token punctuation">,</span></span>
<span class="line">      document<span class="token punctuation">.</span><span class="token function">querySelector</span><span class="token punctuation">(</span>root<span class="token punctuation">)</span></span>
<span class="line">    <span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">  <span class="token punctuation">}</span></span>
<span class="line">  <span class="token keyword">return</span> app<span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="_8-版本" tabindex="-1"><a class="header-anchor" href="#_8-版本"><span>8.版本</span></a></h2><h3 id="_8-1-src-index-js-1" tabindex="-1"><a class="header-anchor" href="#_8-1-src-index-js-1"><span>8.1 src\\index.js</span></a></h3><p>src\\index.js</p><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text"><pre><code class="language-text"><span class="line">import React from &#39;react&#39;;</span>
<span class="line">import dva,{connect} from &#39;./dva&#39;;</span>
<span class="line">import {Router,Route,routerRedux} from &#39;./dva/router&#39;;</span>
<span class="line">import {createBrowserHistory} from &#39;history&#39;;</span>
<span class="line">import {message} from &#39;antd&#39;;</span>
<span class="line">import &#39;antd/dist/antd.css&#39;;</span>
<span class="line">import logger from &#39;redux-logger&#39;;</span>
<span class="line">const SHOW = &#39;SHOW&#39;;</span>
<span class="line">const HIDE = &#39;HIDE&#39;;</span>
<span class="line">const initialLoadingState = {</span>
<span class="line">    global:false,//只有有任何一个saga执行的它就是为true,只有所有的saga都不执行它才为false</span>
<span class="line">    models:{},//里面放着哪个model有saga正在执行</span>
<span class="line">    effects:{},//model中的哪个saga正在执行</span>
<span class="line">}</span>
<span class="line">//routerRedux= connected-react-redux导出对象</span>
<span class="line">const app = dva({</span>
<span class="line">    history:createBrowserHistory(),//指定用哪个历史对象</span>
<span class="line">    initialState:{counter:{number:5}}, //初始状态</span>
<span class="line">    //当effect执行错误会走到这里</span>
<span class="line">    onError:(err,dispatch)=&gt;{message.error(err.toString())},</span>
<span class="line">    //值可能是一个中间件函数，也可能是一个中间件的数组</span>
<span class="line">    onAction:logger,</span>
<span class="line">    //当仓库中状态发生改变的时候，执行此函数</span>
<span class="line">    onStateChange:state=&gt;console.log(&#39;onStateChange&#39;,state),</span>
<span class="line">    //onReducer 是用来增强reducer的</span>
<span class="line">    onReducer:reducer=&gt;(state,action)=&gt;{</span>
<span class="line">        let newState =  reducer(state,action);</span>
<span class="line">        //newState.counter.number*=2;</span>
<span class="line">        return newState;</span>
<span class="line">    },</span>
<span class="line">    //封闭effect的执行 dva-loading 老的saga effects model 动作类型</span>
<span class="line">    onEffect:(effect,{put},model,actionType)=&gt;{</span>
<span class="line">        const {namespace} = model;</span>
<span class="line">        return function*(...args){</span>
<span class="line">            yield put({type:SHOW,payload:{namespace,actionType}});//namespace=counter actionType asyncAdd</span>
<span class="line">            yield effect(...args);</span>
<span class="line">            yield put({type:HIDE,payload:{namespace,actionType}});</span>
<span class="line">        }</span>
<span class="line">    },</span>
<span class="line">    //额外的reducer对象 </span>
<span class="line">    extraReducers:{</span>
<span class="line">        //当向仓库派发动作的时候</span>
<span class="line">        loading(state=initialLoadingState,{type,payload}){</span>
<span class="line">            const {namespace,actionType} = payload||{};//namespace =counter actionType -counter/asyncAdd</span>
<span class="line">            switch(type){</span>
<span class="line">                case SHOW:</span>
<span class="line">                  return {</span>
<span class="line">                      global:true,//只要有一个effect执行了，它就为true</span>
<span class="line">                      models:{...state.models,[namespace]:true},</span>
<span class="line">                      effects:{...state.effects,[actionType]:true}</span>
<span class="line">                  }</span>
<span class="line">                case HIDE:</span>
<span class="line">                  const effects =  {...state.effects,[actionType]:false};</span>
<span class="line">                  const models = {...state.models,[namespace]:false};</span>
<span class="line">                  const global = Object.keys(models).some(namespace=&gt;models[namespace]);</span>
<span class="line">                  return {effects,models,global};</span>
<span class="line">                default:</span>
<span class="line">                  return state;</span>
<span class="line">            }</span>
<span class="line"></span>
<span class="line">        }</span>
<span class="line">    },</span>
<span class="line">    //额外的增强器  用来增强createStore</span>
<span class="line">    extraEnhancers:createStore=&gt;{</span>
<span class="line">        return (...args)=&gt;{</span>
<span class="line">            let store = createStore(...args);</span>
<span class="line">            console.log(&#39;我正在创建仓库&#39;);</span>
<span class="line">            return store;</span>
<span class="line">        }</span>
<span class="line">    }</span>
<span class="line">});</span>
<span class="line">const delay = ms=&gt;new Promise(function(resolve){</span>
<span class="line">    setTimeout(() =&gt; {resolve();}, ms);</span>
<span class="line">});</span>
<span class="line">app.model({</span>
<span class="line">    namespace:&#39;counter&#39;,</span>
<span class="line">    state:{number:0},</span>
<span class="line">    reducers:{</span>
<span class="line">        add(state,{payload}){</span>
<span class="line">            return {number:state.number+(payload||1)};</span>
<span class="line">        }</span>
<span class="line">    },</span>
<span class="line">    effects:{</span>
<span class="line">        *asyncAdd(action,{put,call}){</span>
<span class="line">            yield call(delay,1000);</span>
<span class="line">            throw new Error(&#39;异步加1失败&#39;);</span>
<span class="line">            yield put({type:&#39;counter/add&#39;});</span>
<span class="line">        },</span>
<span class="line">        *goto({payload},{put}){</span>
<span class="line">            yield put(routerRedux.push(payload));//connected-react-router</span>
<span class="line">        },</span>
<span class="line">        addWatcher:[</span>
<span class="line">            function*({take,put,call}){</span>
<span class="line">                for(let i=0;i&lt;3;i++){</span>
<span class="line">                    const {payload} = yield take(&#39;counter/addWatcher&#39;);</span>
<span class="line">                    yield call(delay,1000);</span>
<span class="line">                    yield put({type:&#39;counter/add&#39;,payload});</span>
<span class="line">                }</span>
<span class="line">                console.log(&#39;已经到加最大值了，不能再加了&#39;)</span>
<span class="line">            },</span>
<span class="line">            {type:&#39;watcher&#39;}//监听器</span>
<span class="line">        ]</span>
<span class="line">    }</span>
<span class="line">});</span>
<span class="line">let Counter = connect(</span>
<span class="line">    state=&gt;state.counter</span>
<span class="line">)(</span>
<span class="line">  props=&gt;(</span>
<span class="line">      &lt;div&gt;</span>
<span class="line">        &lt;p&gt;{props.number}&lt;/p&gt;</span>
<span class="line">        &lt;button onClick={()=&gt;props.dispatch({type:&#39;counter/add&#39;})}&gt;+&lt;/button&gt;</span>
<span class="line">        &lt;button onClick={()=&gt;props.dispatch({type:&#39;counter/asyncAdd&#39;})}&gt;异步加1&lt;/button&gt;</span>
<span class="line">        &lt;button onClick={()=&gt;props.dispatch({type:&#39;counter/addWatcher&#39;})}&gt;addWatcher&lt;/button&gt;</span>
<span class="line">        &lt;button onClick={()=&gt;props.dispatch({type:&#39;counter/goto&#39;,payload:&#39;/&#39;})}&gt;跳转到/路径里&lt;/button&gt;</span>
<span class="line">      &lt;/div&gt;</span>
<span class="line">  )</span>
<span class="line">);</span>
<span class="line">const Home = props=&gt;&lt;div&gt;首页&lt;/div&gt;;</span>
<span class="line">app.router(({history})=&gt;(</span>
<span class="line">     &lt;Router history={history}&gt;</span>
<span class="line">      &lt;&gt;</span>
<span class="line">        &lt;Route path=&quot;/&quot; exact component={Home}/&gt;</span>
<span class="line">        &lt;Route path=&quot;/counter&quot; exact component={Counter}/&gt;</span>
<span class="line">      &lt;/&gt;</span>
<span class="line">      &lt;/Router&gt;</span>
<span class="line">));</span>
<span class="line"> app.start(&#39;</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_8-2-dva-index-js" tabindex="-1"><a class="header-anchor" href="#_8-2-dva-index-js"><span>8.2 dva\\index.js</span></a></h3><p>src\\dva\\index.js</p><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code class="language-javascript"><span class="line"><span class="token keyword">import</span> React <span class="token keyword">from</span> <span class="token string">&#39;react&#39;</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">import</span> ReactDOM <span class="token keyword">from</span> <span class="token string">&#39;react-dom&#39;</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">import</span> <span class="token punctuation">{</span>createStore<span class="token punctuation">,</span>combineReducers<span class="token punctuation">,</span>applyMiddleware<span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&#39;redux&#39;</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">import</span> <span class="token punctuation">{</span>connect<span class="token punctuation">,</span>Provider<span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&#39;react-redux&#39;</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">import</span> createSagaMiddleware <span class="token keyword">from</span> <span class="token string">&#39;redux-saga&#39;</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">import</span> <span class="token operator">*</span> <span class="token keyword">as</span> effects <span class="token keyword">from</span> <span class="token string">&#39;redux-saga/effects&#39;</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">import</span> createRootSaga <span class="token keyword">from</span> <span class="token string">&#39;./createRootSaga&#39;</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">import</span> createReducers <span class="token keyword">from</span> <span class="token string">&#39;./createReducers&#39;</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">import</span> <span class="token punctuation">{</span>createHashHistory<span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&#39;history&#39;</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">import</span> <span class="token punctuation">{</span>routerMiddleware<span class="token punctuation">,</span>connectRouter<span class="token punctuation">,</span>ConnectedRouter<span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&#39;connected-react-router&#39;</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">import</span> <span class="token punctuation">{</span>prefix<span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&#39;./utils&#39;</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">export</span> <span class="token punctuation">{</span>connect<span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">opts</span><span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">const</span> app <span class="token operator">=</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token literal-property property">_models</span><span class="token operator">:</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token comment">//存放着所有的模型</span></span>
<span class="line">        model<span class="token punctuation">,</span><span class="token comment">//添加模型的方法</span></span>
<span class="line">        <span class="token literal-property property">_router</span><span class="token operator">:</span><span class="token keyword">null</span><span class="token punctuation">,</span><span class="token comment">//此处存放着路由定义</span></span>
<span class="line">        router<span class="token punctuation">,</span><span class="token comment">//定义路由的方法</span></span>
<span class="line">        start</span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    <span class="token keyword">function</span> <span class="token function">model</span><span class="token punctuation">(</span><span class="token parameter">model</span><span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line">        app<span class="token punctuation">.</span>_models<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>model<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    <span class="token keyword">function</span> <span class="token function">router</span><span class="token punctuation">(</span><span class="token parameter">routerConfig</span><span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line">        app<span class="token punctuation">.</span>_router <span class="token operator">=</span> routerConfig<span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    <span class="token keyword">function</span> <span class="token function">start</span><span class="token punctuation">(</span><span class="token parameter">selector</span><span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">let</span> history <span class="token operator">=</span> opts<span class="token punctuation">.</span>history<span class="token operator">||</span><span class="token function">createHashHistory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">let</span> rootReducer <span class="token operator">=</span> <span class="token function">createReducers</span><span class="token punctuation">(</span>app<span class="token punctuation">.</span>_models<span class="token punctuation">,</span>history<span class="token punctuation">,</span>opts<span class="token punctuation">.</span>extraReducers<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//router</span></span>
<span class="line">        <span class="token keyword">let</span> <span class="token function-variable function">finalReducer</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">state<span class="token punctuation">,</span>action</span><span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line">            <span class="token keyword">let</span> newRootReducer <span class="token operator">=</span> opts<span class="token punctuation">.</span><span class="token function">onReducer</span><span class="token punctuation">(</span>rootReducer<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">            <span class="token keyword">let</span> newState <span class="token operator">=</span> <span class="token function">newRootReducer</span><span class="token punctuation">(</span>state<span class="token punctuation">,</span>action<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">            <span class="token keyword">if</span><span class="token punctuation">(</span>opts<span class="token punctuation">.</span>onStateChange<span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line">                 opts<span class="token punctuation">.</span><span class="token function">onStateChange</span><span class="token punctuation">(</span>newState<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">            <span class="token punctuation">}</span></span>
<span class="line">            <span class="token keyword">return</span> newState<span class="token punctuation">;</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">        <span class="token keyword">let</span> sagaMiddleware <span class="token operator">=</span> <span class="token function">createSagaMiddleware</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">let</span> rootSaga <span class="token operator">=</span> <span class="token function">createRootSaga</span><span class="token punctuation">(</span>app<span class="token punctuation">.</span>_models<span class="token punctuation">,</span>opts<span class="token punctuation">.</span>onError<span class="token operator">||</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>opts<span class="token punctuation">.</span>onEffect<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">if</span><span class="token punctuation">(</span>opts<span class="token punctuation">.</span>onAction<span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line">            <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>Array<span class="token punctuation">.</span><span class="token function">isArray</span><span class="token punctuation">(</span>opts<span class="token punctuation">.</span>onAction<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line">                opts<span class="token punctuation">.</span>onAction<span class="token operator">=</span><span class="token punctuation">[</span>opts<span class="token punctuation">.</span>onAction<span class="token punctuation">]</span><span class="token punctuation">;</span></span>
<span class="line">            <span class="token punctuation">}</span></span>
<span class="line">        <span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token punctuation">{</span></span>
<span class="line">         opts<span class="token punctuation">.</span>onAction<span class="token operator">=</span><span class="token punctuation">[</span><span class="token punctuation">]</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">        <span class="token keyword">let</span> newCreateStore <span class="token operator">=</span> createStore<span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">if</span><span class="token punctuation">(</span>opts<span class="token punctuation">.</span>extraEnhancers<span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line">            newCreateStore <span class="token operator">=</span> opts<span class="token punctuation">.</span><span class="token function">extraEnhancers</span><span class="token punctuation">(</span>createStore<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">        <span class="token keyword">let</span> store <span class="token operator">=</span> <span class="token function">newCreateStore</span><span class="token punctuation">(</span>finalReducer<span class="token punctuation">,</span>opts<span class="token punctuation">.</span>initialState<span class="token operator">||</span><span class="token keyword">undefined</span><span class="token punctuation">,</span></span>
<span class="line">        <span class="token function">applyMiddleware</span><span class="token punctuation">(</span><span class="token function">routerMiddleware</span><span class="token punctuation">(</span>history<span class="token punctuation">)</span><span class="token punctuation">,</span>sagaMiddleware<span class="token punctuation">,</span><span class="token operator">...</span>opts<span class="token punctuation">.</span>onAction<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        sagaMiddleware<span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span>rootSaga<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//开始启动rootSaga执行</span></span>
<span class="line">        <span class="token keyword">let</span> App <span class="token operator">=</span> app<span class="token punctuation">.</span><span class="token function">_router</span><span class="token punctuation">(</span><span class="token punctuation">{</span>history<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        ReactDOM<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span></span>
<span class="line">            <span class="token operator">&lt;</span>Provider store<span class="token operator">=</span><span class="token punctuation">{</span>store<span class="token punctuation">}</span><span class="token operator">&gt;</span></span>
<span class="line">                <span class="token operator">&lt;</span>ConnectedRouter history<span class="token operator">=</span><span class="token punctuation">{</span>history<span class="token punctuation">}</span><span class="token operator">&gt;</span></span>
<span class="line">                    <span class="token punctuation">{</span>App<span class="token punctuation">}</span></span>
<span class="line">                <span class="token operator">&lt;</span><span class="token operator">/</span>ConnectedRouter<span class="token operator">&gt;</span></span>
<span class="line">            <span class="token operator">&lt;</span><span class="token operator">/</span>Provider<span class="token operator">&gt;</span></span>
<span class="line">            <span class="token punctuation">,</span>document<span class="token punctuation">.</span><span class="token function">querySelector</span><span class="token punctuation">(</span>selector<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    <span class="token keyword">return</span> app<span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_8-3-router-js" tabindex="-1"><a class="header-anchor" href="#_8-3-router-js"><span>8.3 router.js</span></a></h3><p>src\\dva\\router.js</p><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code class="language-javascript"><span class="line">module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&#39;react-router-dom&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">module<span class="token punctuation">.</span>exports<span class="token punctuation">.</span>routerRedux <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&#39;connected-react-router&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_8-4-createreducers-js" tabindex="-1"><a class="header-anchor" href="#_8-4-createreducers-js"><span>8.4 createReducers.js</span></a></h3><p>src\\dva\\createReducers.js</p><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code class="language-javascript"><span class="line"><span class="token keyword">import</span> <span class="token punctuation">{</span>combineReducers<span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&#39;redux&#39;</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">import</span> <span class="token punctuation">{</span>prefix<span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&#39;./utils&#39;</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">import</span> <span class="token punctuation">{</span>connectRouter<span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&#39;connected-react-router&#39;</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">function</span> <span class="token function">createReducers</span><span class="token punctuation">(</span><span class="token parameter">models<span class="token punctuation">,</span>history<span class="token punctuation">,</span>extraReducers</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">  <span class="token keyword">let</span> reducers <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token literal-property property">router</span><span class="token operator">:</span><span class="token function">connectRouter</span><span class="token punctuation">(</span>history<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token operator">...</span>extraReducers<span class="token punctuation">}</span><span class="token punctuation">;</span></span>
<span class="line">  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> model <span class="token keyword">of</span> models<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">let</span> <span class="token punctuation">{</span> namespace<span class="token punctuation">,</span> <span class="token literal-property property">state</span><span class="token operator">:</span> initialState<span class="token punctuation">,</span> <span class="token literal-property property">reducers</span><span class="token operator">:</span> modelReducers <span class="token punctuation">}</span> <span class="token operator">=</span> model<span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">let</span> reducersWithPrefix <span class="token operator">=</span> <span class="token function">prefix</span><span class="token punctuation">(</span>modelReducers<span class="token punctuation">,</span> namespace<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//key已经增加了命名空间前缀了</span></span>
<span class="line">    reducers<span class="token punctuation">[</span>namespace<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">state <span class="token operator">=</span> initialState<span class="token punctuation">,</span> action</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">      <span class="token keyword">let</span> reducer <span class="token operator">=</span> reducersWithPrefix<span class="token punctuation">[</span>action<span class="token punctuation">.</span>type<span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">//type =&#39;counter/add&#39;</span></span>
<span class="line">      <span class="token keyword">if</span> <span class="token punctuation">(</span>reducer<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">return</span> <span class="token function">reducer</span><span class="token punctuation">(</span>state<span class="token punctuation">,</span> action<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">      <span class="token punctuation">}</span> <span class="token comment">//如果reducer没有匹配上，说明这个action不是给我处理的，直接返回老状态</span></span>
<span class="line">      <span class="token keyword">return</span> state<span class="token punctuation">;</span> <span class="token comment">//总状态的counter 属性</span></span>
<span class="line">    <span class="token punctuation">}</span><span class="token punctuation">;</span></span>
<span class="line">  <span class="token punctuation">}</span></span>
<span class="line">  <span class="token keyword">return</span>  <span class="token function">combineReducers</span><span class="token punctuation">(</span>reducers<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_8-5-createrootsaga-js" tabindex="-1"><a class="header-anchor" href="#_8-5-createrootsaga-js"><span>8.5 createRootSaga.js</span></a></h3><p>src\\dva\\createRootSaga.js</p><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code class="language-javascript"><span class="line"><span class="token keyword">import</span> <span class="token punctuation">{</span>prefix<span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&#39;./utils&#39;</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">import</span> <span class="token operator">*</span> <span class="token keyword">as</span> sagaEffects <span class="token keyword">from</span> <span class="token string">&#39;redux-saga/effects&#39;</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">function</span> <span class="token function">createRootSaga</span><span class="token punctuation">(</span><span class="token parameter">models<span class="token punctuation">,</span>onError<span class="token punctuation">,</span>onEffect</span><span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line">   <span class="token keyword">function</span><span class="token operator">*</span> <span class="token function">rootSaga</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line">       <span class="token keyword">try</span><span class="token punctuation">{</span></span>
<span class="line">         <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">let</span> model <span class="token keyword">of</span> models<span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line">           model<span class="token punctuation">.</span>effects <span class="token operator">=</span> <span class="token function">prefix</span><span class="token punctuation">(</span>model<span class="token punctuation">.</span>effects<span class="token punctuation">,</span>model<span class="token punctuation">.</span>namespace<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">           <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">let</span> key <span class="token keyword">in</span> model<span class="token punctuation">.</span>effects<span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token comment">//key counter/asyncAdd</span></span>
<span class="line">              <span class="token keyword">let</span> effect <span class="token operator">=</span> model<span class="token punctuation">.</span>effects<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">;</span></span>
<span class="line">              <span class="token keyword">if</span><span class="token punctuation">(</span>Array<span class="token punctuation">.</span><span class="token function">isArray</span><span class="token punctuation">(</span>effect<span class="token punctuation">)</span><span class="token operator">&amp;&amp;</span>effect<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>type <span class="token operator">==</span> <span class="token string">&#39;watcher&#39;</span><span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line">                  <span class="token keyword">let</span> effect <span class="token operator">=</span> model<span class="token punctuation">.</span>effects<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">;</span></span>
<span class="line">                  <span class="token keyword">yield</span> sagaEffects<span class="token punctuation">.</span><span class="token function">fork</span><span class="token punctuation">(</span>effect<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span>sagaEffects<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">              <span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{</span></span>
<span class="line">                <span class="token keyword">yield</span> sagaEffects<span class="token punctuation">.</span><span class="token function">takeEvery</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span><span class="token keyword">function</span><span class="token operator">*</span><span class="token punctuation">(</span>action<span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line">                    <span class="token keyword">let</span> oldEffect <span class="token operator">=</span> model<span class="token punctuation">.</span>effects<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">;</span></span>
<span class="line">                    <span class="token keyword">let</span> newEffect <span class="token operator">=</span> <span class="token function">onEffect</span><span class="token punctuation">(</span>oldEffect<span class="token punctuation">,</span>sagaEffects<span class="token punctuation">,</span>model<span class="token punctuation">,</span>action<span class="token punctuation">.</span>type<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">                    <span class="token keyword">yield</span> <span class="token function">newEffect</span><span class="token punctuation">(</span>action<span class="token punctuation">,</span>sagaEffects<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">                <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">              <span class="token punctuation">}</span>  </span>
<span class="line">           <span class="token punctuation">}</span></span>
<span class="line">       <span class="token punctuation">}</span></span>
<span class="line">       <span class="token punctuation">}</span><span class="token keyword">catch</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line">           <span class="token function">onError</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">       <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">   <span class="token punctuation">}</span></span>
<span class="line">   <span class="token keyword">return</span> rootSaga<span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="_8-参考" tabindex="-1"><a class="header-anchor" href="#_8-参考"><span>8.参考</span></a></h2><ul><li><a href="https://dvajs.com/" target="_blank" rel="noopener noreferrer">dvajs</a></li><li><a href="https://gitee.com/zhufengpeixun/zhufeng-dva-source4.git" target="_blank" rel="noopener noreferrer">zhufeng-dva-source4</a></li></ul>`,71)])])}const i=s(t,[["render",l]]),u=JSON.parse('{"path":"/strong/31.dva.html","title":"","lang":"en-US","frontmatter":{},"git":{"updatedTime":1681290319000,"contributors":[{"name":"yutao","username":"yutao","email":"642231346@qq.com","commits":1,"url":"https://github.com/yutao"}],"changelog":[{"hash":"f5ab8c9d34991ec274f7f652439afe5b2afb6147","time":1681290319000,"email":"642231346@qq.com","author":"yutao","message":"modify"}]},"filePathRelative":"strong/31.dva.md"}');export{i as comp,u as data};
