import{_ as n,c as a,a as p,o as e}from"./app-CD1YpnS1.js";const t={};function l(c,s){return e(),a("div",null,[...s[0]||(s[0]=[p(`<h2 id="_1-egg-js" tabindex="-1"><a class="header-anchor" href="#_1-egg-js"><span>1. egg.js</span></a></h2><ul><li><a href="https://eggjs.org/zh-cn/intro/" target="_blank" rel="noopener noreferrer">egg.js</a></li><li>提供基于 Egg 定制上层框架的能力</li><li>高度可扩展的插件机制</li><li>内置多进程管理</li><li>基于 Koa 开发，性能优异</li><li>框架稳定，测试覆盖率高</li><li>渐进式开发</li></ul><h3 id="_1-1-目录结构" tabindex="-1"><a class="header-anchor" href="#_1-1-目录结构"><span>1.1 目录结构</span></a></h3><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text"><pre><code class="language-text"><span class="line">├── package.json</span>
<span class="line">├── app.js (app.js 和 agent.js 用于自定义启动时的初始化工作)</span>
<span class="line">├── agent.js (可选)</span>
<span class="line">├── app</span>
<span class="line">|   ├── router.js(用于配置 URL 路由规则)</span>
<span class="line">│   ├── controller(用于解析用户的输入，处理后返回相应的结果)</span>
<span class="line">│   |   └── home.js</span>
<span class="line">│   ├── service (用于编写业务逻辑层，可选)</span>
<span class="line">│   |   └── user.js</span>
<span class="line">│   ├── middleware (用于编写中间件，可选)</span>
<span class="line">│   |   └── response_time.js</span>
<span class="line">│   ├── schedule (用于定时任务，可选)</span>
<span class="line">│   |   └── my_task.js</span>
<span class="line">│   ├── public (用于放置静态资源，可选)</span>
<span class="line">│   |   └── reset.css</span>
<span class="line">│   ├── extend (用于框架的扩展，可选)</span>
<span class="line">│   |   └── application.js app 对象指的是 Koa 的全局应用对象，全局只有一个，在应用启动时被创建。</span>
<span class="line">│       ├── context.js (Context 指的是 Koa 的请求上下文，这是 请求级别 的对象)</span>
<span class="line">│       ├── request.js (Request 对象和 Koa 的 Request 对象相同，是 请求级别 的对象)</span>
<span class="line">│       ├── response.js (Response 对象和 Koa 的 Response 对象相同，是 请求级别 的对象)</span>
<span class="line">│       ├── helper.js (Helper 函数用来提供一些实用的 utility 函数)</span>
<span class="line">│   ├── view (用于放置模板文件)</span>
<span class="line">│   |   └── home.tpl</span>
<span class="line">├── |── model (用于放置领域模型)</span>
<span class="line">│   |   └── home.tpl</span>
<span class="line">│   └── extend (用于框架的扩展)</span>
<span class="line">│       ├── helper.js (可选)</span>
<span class="line">│       ├── request.js (可选)</span>
<span class="line">│       ├── response.js (可选)</span>
<span class="line">│       ├── context.js (可选)</span>
<span class="line">│       ├── application.js (可选)</span>
<span class="line">│       └── agent.js (可选)</span>
<span class="line">├── config(用于编写配置文件)</span>
<span class="line">|   ├── plugin.js(用于配置需要加载的插件)</span>
<span class="line">|   ├── config.default.js</span>
<span class="line">│   ├── config.prod.js</span>
<span class="line">|   ├── config.test.js (可选)</span>
<span class="line">|   ├── config.local.js (可选)</span>
<span class="line">|   └── config.unittest.js (可选)</span>
<span class="line">└── test(用于单元测试)</span>
<span class="line">    ├── middleware</span>
<span class="line">    |   └── response_time.test.js</span>
<span class="line">    └── controller</span>
<span class="line">        └── home.test.js</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_1-2-访问" tabindex="-1"><a class="header-anchor" href="#_1-2-访问"><span>1.2 访问</span></a></h3><table><thead><tr><th style="text-align:left;">文件</th><th style="text-align:left;">app</th><th style="text-align:left;">ctx</th><th style="text-align:left;">service</th><th style="text-align:left;">config</th><th style="text-align:left;">logger</th><th style="text-align:left;">helper</th></tr></thead><tbody><tr><td style="text-align:left;">Controller</td><td style="text-align:left;">this.app</td><td style="text-align:left;">this.ctx</td><td style="text-align:left;">this.service</td><td style="text-align:left;">this.config</td><td style="text-align:left;">this.logger</td><td style="text-align:left;">this.app.helper</td></tr><tr><td style="text-align:left;">Service</td><td style="text-align:left;">this.app</td><td style="text-align:left;">this.ctx</td><td style="text-align:left;">this.service</td><td style="text-align:left;">this.config</td><td style="text-align:left;">this.logger</td><td style="text-align:left;">this.app.helper</td></tr></tbody></table><blockquote><p>ctx.helper</p></blockquote><h2 id="_2-初始化项目" tabindex="-1"><a class="header-anchor" href="#_2-初始化项目"><span>2. 初始化项目</span></a></h2><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text"><pre><code class="language-text"><span class="line">mkdir egg-news</span>
<span class="line">cd egg-news</span>
<span class="line">npm init -y</span>
<span class="line">cnpm i egg --save</span>
<span class="line">cnpm i egg-bin --save-dev</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="_3-添加-npm-scripts-到-package-json" tabindex="-1"><a class="header-anchor" href="#_3-添加-npm-scripts-到-package-json"><span>3. 添加 npm scripts 到 package.json：</span></a></h2><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text"><pre><code class="language-text"><span class="line">&quot;scripts&quot;: {</span>
<span class="line">    &quot;dev&quot;: &quot;egg-bin dev&quot;</span>
<span class="line">}</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="_4-跑通路由" tabindex="-1"><a class="header-anchor" href="#_4-跑通路由"><span>4. 跑通路由</span></a></h2><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text"><pre><code class="language-text"><span class="line">├─app</span>
<span class="line">│  │─router.js</span>
<span class="line">│  ├─controller</span>
<span class="line">│  │      news.js</span>
<span class="line">├─config</span>
<span class="line">│      config.default.js</span>
<span class="line">|─package.json</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_4-1-配置路由" tabindex="-1"><a class="header-anchor" href="#_4-1-配置路由"><span>4.1 配置路由</span></a></h3><p>app/router.js</p><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code class="language-javascript"><span class="line">module<span class="token punctuation">.</span><span class="token function-variable function">exports</span> <span class="token operator">=</span> <span class="token parameter">app</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">const</span> <span class="token punctuation">{</span> router<span class="token punctuation">,</span> controller <span class="token punctuation">}</span> <span class="token operator">=</span> app<span class="token punctuation">;</span></span>
<span class="line">    router<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&#39;/news&#39;</span><span class="token punctuation">,</span> controller<span class="token punctuation">.</span>news<span class="token punctuation">.</span>index<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_4-2-编写控制器" tabindex="-1"><a class="header-anchor" href="#_4-2-编写控制器"><span>4.2 编写控制器</span></a></h3><p>app\\controller\\news.js</p><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code class="language-javascript"><span class="line"><span class="token keyword">const</span> <span class="token punctuation">{</span> Controller <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&#39;egg&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">class</span> <span class="token class-name">NewsController</span> <span class="token keyword">extends</span> <span class="token class-name">Controller</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">async</span> <span class="token function">index</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">this</span><span class="token punctuation">.</span>ctx<span class="token punctuation">.</span>body <span class="token operator">=</span> <span class="token string">&#39;hello world&#39;</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line">module<span class="token punctuation">.</span>exports <span class="token operator">=</span> NewsController<span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_4-3-配置文件" tabindex="-1"><a class="header-anchor" href="#_4-3-配置文件"><span>4.3 配置文件</span></a></h3><p>config\\config.default.js</p><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code class="language-javascript"><span class="line">exports<span class="token punctuation">.</span>keys <span class="token operator">=</span> <span class="token string">&#39;zfpx&#39;</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><h2 id="_5-静态文件中间件" tabindex="-1"><a class="header-anchor" href="#_5-静态文件中间件"><span>5. 静态文件中间件</span></a></h2><ul><li>Egg 内置了 static 插件</li><li>static 插件默认映射 /public/<em>-&gt; app/public/</em> 目录</li><li>把静态资源都放到 app/public 目录即可</li><li><a href="http://img.zhufengpeixun.cn/bootstrap.zip" target="_blank" rel="noopener noreferrer">bootstrap</a></li></ul><h2 id="_6-使用模板引擎" tabindex="-1"><a class="header-anchor" href="#_6-使用模板引擎"><span>6. 使用模板引擎</span></a></h2><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text"><pre><code class="language-text"><span class="line">├─app</span>
<span class="line">│  │─router.js</span>
<span class="line">│  ├─controller</span>
<span class="line">│  │      news.js   </span>
<span class="line">│  ├─public</span>
<span class="line">│  │  ├─css</span>
<span class="line">│  │  │      bootstrap.css  </span>
<span class="line">│  │  └─js</span>
<span class="line">│  │          bootstrap.js         </span>
<span class="line">│  └─view</span>
<span class="line">│          news.ejs       </span>
<span class="line">├─config</span>
<span class="line">│   config.default.js</span>
<span class="line">│   plugin.js</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_6-1-安装依赖的插件" tabindex="-1"><a class="header-anchor" href="#_6-1-安装依赖的插件"><span>6.1 安装依赖的插件</span></a></h3><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text"><pre><code class="language-text"><span class="line">cnpm install egg-view-nunjucks --save</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><h3 id="_6-2-启用插件" tabindex="-1"><a class="header-anchor" href="#_6-2-启用插件"><span>6.2 启用插件</span></a></h3><p>{ROOT}\\config\\plugin.js</p><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code class="language-javascript"><span class="line">exports<span class="token punctuation">.</span>nunjucks <span class="token operator">=</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token literal-property property">enable</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token keyword">package</span><span class="token operator">:</span> <span class="token string">&#39;egg-view-nunjucks&#39;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_6-3-配置模板" tabindex="-1"><a class="header-anchor" href="#_6-3-配置模板"><span>6.3 配置模板</span></a></h3><p>{ROOT}\\config\\config.default.js</p><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code class="language-javascript"><span class="line">module<span class="token punctuation">.</span><span class="token function-variable function">exports</span><span class="token operator">=</span><span class="token parameter">app</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">let</span> config<span class="token operator">=</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">    config<span class="token punctuation">.</span>keys<span class="token operator">=</span><span class="token string">&#39;zfpx&#39;</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">    config<span class="token punctuation">.</span>view<span class="token operator">=</span><span class="token punctuation">{</span></span>
<span class="line">        <span class="token literal-property property">defaultExtension</span><span class="token operator">:</span> <span class="token string">&#39;.html&#39;</span><span class="token punctuation">,</span></span>
<span class="line">        <span class="token literal-property property">defaultViewEngine</span><span class="token operator">:</span> <span class="token string">&#39;nunjucks&#39;</span><span class="token punctuation">,</span></span>
<span class="line">        <span class="token literal-property property">mapping</span><span class="token operator">:</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token string-property property">&#39;.html&#39;</span><span class="token operator">:</span><span class="token string">&#39;nunjucks&#39;</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    <span class="token keyword">return</span> config<span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_6-4-编写模板" tabindex="-1"><a class="header-anchor" href="#_6-4-编写模板"><span>6.4 编写模板</span></a></h3><p>app\\view\\index.html</p><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text"><pre><code class="language-text"><span class="line">&lt;!DOCTYPE html&gt;</span>
<span class="line">&lt;html lang=&quot;en&quot;&gt;</span>
<span class="line">&lt;head&gt;</span>
<span class="line">    &lt;meta charset=&quot;UTF-8&quot;&gt;</span>
<span class="line">    &lt;meta name=&quot;viewport&quot; content=&quot;width=device-width, initial-scale=1.0&quot;&gt;</span>
<span class="line">    &lt;meta http-equiv=&quot;X-UA-Compatible&quot; content=&quot;ie=edge&quot;&gt;</span>
<span class="line">    &lt;link rel=&quot;stylesheet&quot; href=&quot;/public/css/bootstrap.css&quot;&gt;</span>
<span class="line">    &lt;title&gt;新闻列表&lt;/title&gt;</span>
<span class="line">&lt;/head&gt;</span>
<span class="line">&lt;body&gt;</span>
<span class="line">&lt;div class=&quot;container&quot;&gt;</span>
<span class="line">    &lt;div class=&quot;row&quot;&gt;</span>
<span class="line">        &lt;div class=&quot;col-md-8 col-md-offset-2&quot;&gt;</span>
<span class="line">           {% for item in list%}</span>
<span class="line">                &lt;div class=&quot;panel panel-default&quot;&gt;</span>
<span class="line">                    &lt;div class=&quot;panel-heading&quot;&gt;</span>
<span class="line">                       &lt;h3 class=&quot;text-center&quot;&gt;{{item.title}}&lt;/h3&gt;</span>
<span class="line">                    &lt;/div&gt;</span>
<span class="line">                    &lt;div class=&quot;panel-body&quot;&gt;</span>
<span class="line">                        &lt;img src=&quot;{{item.image}}&quot; class=&quot;img-responsive center-block&quot;&gt;</span>
<span class="line">                    &lt;/div&gt;</span>
<span class="line">                    &lt;div class=&quot;panel-footer&quot;&gt;</span>
<span class="line">                        &lt;h3 class=&quot;text-center&quot;&gt;创建时间: {{item.createAt}}&lt;/h3&gt;</span>
<span class="line">                    &lt;/div&gt;</span>
<span class="line">                 &lt;/div&gt;</span>
<span class="line">            {% endfor %}</span>
<span class="line">        &lt;/div&gt;</span>
<span class="line">    &lt;/div&gt;</span>
<span class="line">&lt;/div&gt;</span>
<span class="line">&lt;/body&gt;</span>
<span class="line">&lt;/html&gt;</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_6-5-编写控制器" tabindex="-1"><a class="header-anchor" href="#_6-5-编写控制器"><span>6.5 编写控制器</span></a></h3><p>app\\controller\\news.js</p><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code class="language-javascript"><span class="line"><span class="token keyword">const</span> <span class="token punctuation">{</span>Controller<span class="token punctuation">}</span><span class="token operator">=</span><span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&#39;egg&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">class</span> <span class="token class-name">NewsController</span> <span class="token keyword">extends</span> <span class="token class-name">Controller</span><span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">async</span> <span class="token function">index</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">const</span> <span class="token punctuation">{</span>ctx<span class="token punctuation">}</span><span class="token operator">=</span><span class="token keyword">this</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">const</span> list<span class="token operator">=</span><span class="token punctuation">[</span></span>
<span class="line">            <span class="token punctuation">{</span></span>
<span class="line">                <span class="token literal-property property">id</span><span class="token operator">:</span> <span class="token string">&#39;45154322_0&#39;</span><span class="token punctuation">,</span></span>
<span class="line">                <span class="token literal-property property">title</span><span class="token operator">:</span> <span class="token string">&#39;世界首富早晚是这个人，坐拥7家独角兽公司，估值破数万！&#39;</span><span class="token punctuation">,</span></span>
<span class="line">                <span class="token literal-property property">url</span><span class="token operator">:</span> <span class="token string">&#39;http://tech.ifeng.com/a/20180904/45154322_0.shtml&#39;</span><span class="token punctuation">,</span></span>
<span class="line">                <span class="token literal-property property">image</span><span class="token operator">:</span><span class="token string">&#39;http://p0.ifengimg.com/pmop/2018/0905/CFFF918B94D561D2A61FB434ADA81589E8972025_size41_w640_h479.jpeg&#39;</span><span class="token punctuation">,</span></span>
<span class="line">                <span class="token literal-property property">createAt</span><span class="token operator">:</span><span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toLocaleString</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">            <span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">            <span class="token punctuation">{</span></span>
<span class="line">                <span class="token literal-property property">id</span><span class="token operator">:</span> <span class="token string">&#39;16491630_0&#39;</span><span class="token punctuation">,</span></span>
<span class="line">                <span class="token literal-property property">title</span><span class="token operator">:</span> <span class="token string">&#39;支付宝们来了！将来人民币会消失吗？&#39;</span><span class="token punctuation">,</span></span>
<span class="line">                <span class="token literal-property property">url</span><span class="token operator">:</span> <span class="token string">&#39;http://finance.ifeng.com/a/20180907/16491630_0.shtml&#39;</span><span class="token punctuation">,</span></span>
<span class="line">                <span class="token literal-property property">image</span><span class="token operator">:</span><span class="token string">&#39;http://p0.ifengimg.com/pmop/2018/0907/2AF684C2EC49B7E3C17FCB13D6DEEF08401D4567_size27_w530_h369.jpeg&#39;</span><span class="token punctuation">,</span></span>
<span class="line">                <span class="token literal-property property">createAt</span><span class="token operator">:</span><span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toLocaleString</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">            <span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">            <span class="token punctuation">{</span></span>
<span class="line">                <span class="token literal-property property">id</span><span class="token operator">:</span> <span class="token string">&#39;2451982&#39;</span><span class="token punctuation">,</span></span>
<span class="line">                <span class="token literal-property property">title</span><span class="token operator">:</span> <span class="token string">&#39;《福布斯》专访贝索斯：无业务边界的亚马逊 令对手生畏的CEO&#39;</span><span class="token punctuation">,</span></span>
<span class="line">                <span class="token literal-property property">url</span><span class="token operator">:</span> <span class="token string">&#39;https://www.jiemian.com/article/2451982.html&#39;</span><span class="token punctuation">,</span></span>
<span class="line">                <span class="token literal-property property">image</span><span class="token operator">:</span><span class="token string">&#39;https://img1.jiemian.com/101/original/20180907/153628523948814900_a580x330.jpg&#39;</span><span class="token punctuation">,</span></span>
<span class="line">                <span class="token literal-property property">createAt</span><span class="token operator">:</span><span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toLocaleString</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">            <span class="token punctuation">}</span></span>
<span class="line">        <span class="token punctuation">]</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">await</span> ctx<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span><span class="token string">&#39;index&#39;</span><span class="token punctuation">,</span><span class="token punctuation">{</span>list<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line">module<span class="token punctuation">.</span>exports<span class="token operator">=</span>NewsController<span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="_7-读取远程接口服务" tabindex="-1"><a class="header-anchor" href="#_7-读取远程接口服务"><span>7. 读取远程接口服务</span></a></h2><p>在实际应用中，Controller 一般不会自己产出数据，也不会包含复杂的逻辑，复杂的过程应抽象为业务逻辑层 Service。</p><h3 id="_7-1-添加配置" tabindex="-1"><a class="header-anchor" href="#_7-1-添加配置"><span>7.1 添加配置</span></a></h3><p>config.default.js</p><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code class="language-javascript"><span class="line">config<span class="token punctuation">.</span>news<span class="token operator">=</span><span class="token punctuation">{</span></span>
<span class="line">       <span class="token literal-property property">pageSize</span><span class="token operator">:</span><span class="token number">10</span><span class="token punctuation">,</span></span>
<span class="line">        <span class="token comment">//newsListUrl: &#39;https://www.easy-mock.com/mock/5cfa48f640971927560c5d74/news/api/list&#39;,</span></span>
<span class="line">    <span class="token literal-property property">newsListUrl</span><span class="token operator">:</span><span class="token string">&#39;http://localhost:3000/news&#39;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>mock.js</p><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code class="language-javascript"><span class="line"><span class="token keyword">let</span> Mock <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&#39;mockjs&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">let</span> express <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&#39;express&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">let</span> app <span class="token operator">=</span> <span class="token function">express</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">app<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&#39;/news&#39;</span><span class="token punctuation">,</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span>res</span><span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line"> <span class="token keyword">let</span> result <span class="token operator">=</span> Mock<span class="token punctuation">.</span><span class="token function">mock</span><span class="token punctuation">(</span></span>
<span class="line">    <span class="token punctuation">{</span></span>
<span class="line">    <span class="token string-property property">&quot;data|10&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">{</span></span>
<span class="line">        <span class="token string-property property">&quot;id&quot;</span><span class="token operator">:</span> <span class="token string">&quot;@id&quot;</span><span class="token punctuation">,</span></span>
<span class="line">        <span class="token string-property property">&quot;title&quot;</span><span class="token operator">:</span> <span class="token string">&quot;@csentence&quot;</span><span class="token punctuation">,</span></span>
<span class="line">        <span class="token string-property property">&quot;url&quot;</span><span class="token operator">:</span> <span class="token string">&quot;@url&quot;</span><span class="token punctuation">,</span></span>
<span class="line">        <span class="token string-property property">&quot;image&quot;</span><span class="token operator">:</span> <span class="token string">&quot;@image(600X500)&quot;</span><span class="token punctuation">,</span></span>
<span class="line">        <span class="token string-property property">&quot;createAt&quot;</span><span class="token operator">:</span> <span class="token string">&quot;@datetime&quot;</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token punctuation">}</span><span class="token punctuation">]</span></span>
<span class="line"> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"> res<span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">app<span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span><span class="token number">3000</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_7-2-编写service" tabindex="-1"><a class="header-anchor" href="#_7-2-编写service"><span>7.2 编写Service</span></a></h3><p>app/service/news.js</p><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code class="language-javascript"><span class="line"><span class="token keyword">const</span> <span class="token punctuation">{</span>Service<span class="token punctuation">}</span><span class="token operator">=</span><span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&#39;egg&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">class</span> <span class="token class-name">NewsService</span> <span class="token keyword">extends</span> <span class="token class-name">Service</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">async</span> <span class="token function">list</span><span class="token punctuation">(</span><span class="token parameter">pageNum<span class="token punctuation">,</span>pageSize</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">const</span> <span class="token punctuation">{</span>ctx<span class="token punctuation">}</span><span class="token operator">=</span><span class="token keyword">this</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">const</span> <span class="token punctuation">{</span>newsListUrl<span class="token punctuation">}</span><span class="token operator">=</span><span class="token keyword">this</span><span class="token punctuation">.</span>config<span class="token punctuation">.</span>news<span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">const</span> result<span class="token operator">=</span><span class="token keyword">await</span> ctx<span class="token punctuation">.</span><span class="token function">curl</span><span class="token punctuation">(</span>newsListUrl<span class="token punctuation">,</span><span class="token punctuation">{</span></span>
<span class="line">            <span class="token literal-property property">method</span><span class="token operator">:</span> <span class="token string">&#39;GET&#39;</span><span class="token punctuation">,</span></span>
<span class="line">            <span class="token literal-property property">data</span><span class="token operator">:</span> <span class="token punctuation">{</span></span>
<span class="line">                pageNum<span class="token punctuation">,</span>pageSize</span>
<span class="line">            <span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">            <span class="token literal-property property">dataType</span><span class="token operator">:</span><span class="token string">&#39;json&#39;</span></span>
<span class="line">        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">return</span> result<span class="token punctuation">.</span>data<span class="token punctuation">.</span>data<span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line">module<span class="token punctuation">.</span>exports<span class="token operator">=</span>NewsService<span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_7-3-编写控制层" tabindex="-1"><a class="header-anchor" href="#_7-3-编写控制层"><span>7.3 编写控制层</span></a></h3><p>app/controller/news.js</p><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code class="language-javascript"><span class="line"><span class="token keyword">const</span> <span class="token punctuation">{</span>Controller<span class="token punctuation">}</span><span class="token operator">=</span><span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&#39;egg&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">class</span> <span class="token class-name">NewsController</span> <span class="token keyword">extends</span> <span class="token class-name">Controller</span><span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">async</span> <span class="token function">index</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">const</span> <span class="token punctuation">{</span>ctx<span class="token punctuation">,</span>service<span class="token punctuation">}</span><span class="token operator">=</span><span class="token keyword">this</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">let</span> <span class="token punctuation">{</span>pageNum<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span>pageSize<span class="token operator">=</span><span class="token keyword">this</span><span class="token punctuation">.</span>config<span class="token punctuation">.</span>news<span class="token punctuation">.</span>pageSize<span class="token punctuation">}</span><span class="token operator">=</span>ctx<span class="token punctuation">.</span>query<span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">const</span> list<span class="token operator">=</span><span class="token keyword">await</span> service<span class="token punctuation">.</span>news<span class="token punctuation">.</span><span class="token function">list</span><span class="token punctuation">(</span>pageNum<span class="token punctuation">,</span>pageSize<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">await</span> ctx<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span><span class="token string">&#39;index&#39;</span><span class="token punctuation">,</span><span class="token punctuation">{</span>list<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line">module<span class="token punctuation">.</span>exports<span class="token operator">=</span>NewsController<span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="_8-计划任务" tabindex="-1"><a class="header-anchor" href="#_8-计划任务"><span>8. 计划任务</span></a></h2><p>我们还会有许多场景需要执行一些定时任务，例如：</p><ul><li>定时上报应用状态。</li><li>定时从远程接口更新本地缓存。</li><li>定时进行文件切割、临时文件删除</li></ul><h3 id="_8-1-编写定时任务" tabindex="-1"><a class="header-anchor" href="#_8-1-编写定时任务"><span>8.1 编写定时任务</span></a></h3><ul><li>所有的定时任务都统一存放在 app/schedule 目录下，每一个文件都是一个独立的定时任务，可以配置定时任务的属性和要执行的方法</li></ul><h4 id="_8-1-1-update-cache-js" tabindex="-1"><a class="header-anchor" href="#_8-1-1-update-cache-js"><span>8.1.1 update_cache.js</span></a></h4><p>app\\schedule\\update_cache.js</p><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code class="language-javascript"><span class="line"><span class="token keyword">const</span> <span class="token punctuation">{</span>Subscription<span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&#39;egg&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">class</span> <span class="token class-name">UpdateCache</span> <span class="token keyword">extends</span> <span class="token class-name">Subscription</span> <span class="token punctuation">{</span></span>
<span class="line">  <span class="token comment">// 通过 schedule 属性来设置定时任务的执行间隔等配置</span></span>
<span class="line">  <span class="token keyword">static</span> <span class="token keyword">get</span> <span class="token function">schedule</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">return</span> <span class="token punctuation">{</span></span>
<span class="line">      <span class="token literal-property property">interval</span><span class="token operator">:</span> <span class="token string">&#39;1m&#39;</span><span class="token punctuation">,</span> <span class="token comment">// 1 分钟间隔</span></span>
<span class="line">      <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token string">&#39;all&#39;</span><span class="token punctuation">,</span> <span class="token comment">// 指定所有的 worker 都需要执行</span></span>
<span class="line">    <span class="token punctuation">}</span><span class="token punctuation">;</span></span>
<span class="line">  <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">  <span class="token comment">// subscribe 是真正定时任务执行时被运行的函数</span></span>
<span class="line">  <span class="token keyword">async</span> <span class="token function">subscribe</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">const</span> res <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span>ctx<span class="token punctuation">.</span><span class="token function">curl</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>config<span class="token punctuation">.</span>cache<span class="token punctuation">.</span>url<span class="token punctuation">,</span> <span class="token punctuation">{</span></span>
<span class="line">      <span class="token literal-property property">dataType</span><span class="token operator">:</span> <span class="token string">&#39;json&#39;</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">this</span><span class="token punctuation">.</span>ctx<span class="token punctuation">.</span>app<span class="token punctuation">.</span>cache <span class="token operator">=</span> res<span class="token punctuation">.</span>data<span class="token punctuation">;</span></span>
<span class="line">  <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">module<span class="token punctuation">.</span>exports <span class="token operator">=</span> UpdateCache<span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h5 id="_8-1-1-1-类型" tabindex="-1"><a class="header-anchor" href="#_8-1-1-1-类型"><span>8.1.1.1 类型</span></a></h5><ul><li>框架提供的定时任务默认支持两种类型，worker 和 all。worker 和 all 都支持上面的两种定时方式，只是当到执行时机时，会执行定时任务的 worker 不同： <ul><li>worker 类型：每台机器上只有一个 worker 会执行这个定时任务，每次执行定时任务的 worker 的选择是随机的。</li><li>all 类型：每台机器上的每个 worker 都会执行这个定时任务。</li></ul></li></ul><h5 id="_8-1-1-2-执行日志" tabindex="-1"><a class="header-anchor" href="#_8-1-1-2-执行日志"><span>8.1.1.2 执行日志</span></a></h5><ul><li>执行日志会输出到 <code>\${appInfo.root}/logs/{app_name}/egg-schedule.log</code></li></ul><h4 id="_8-1-2-config-default-js" tabindex="-1"><a class="header-anchor" href="#_8-1-2-config-default-js"><span>8.1.2 config.default.js</span></a></h4><p>config\\config.default.js</p><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text"><pre><code class="language-text"><span class="line">+config.cache = {</span>
<span class="line">+         //url:&#39;https://www.easy-mock.com/mock/5cfa48f640971927560c5d74/news/api/cache&#39;</span>
<span class="line">+        url: &#39;http://localhost:3000/cache&#39;,</span>
<span class="line">+}</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code class="language-javascript"><span class="line">app<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&#39;/cache&#39;</span><span class="token punctuation">,</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span>res</span><span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line"> res<span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token literal-property property">title</span><span class="token operator">:</span><span class="token string">&#39;新闻标题&#39;</span><span class="token operator">+</span>Date<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_8-1-3-news-js" tabindex="-1"><a class="header-anchor" href="#_8-1-3-news-js"><span>8.1.3 news.js</span></a></h4><p>app\\controller\\news.js</p><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text"><pre><code class="language-text"><span class="line">const {Controller} = require(&#39;egg&#39;);</span>
<span class="line">class NewsController extends Controller{</span>
<span class="line">    async index(){</span>
<span class="line">        const {ctx,service}=this;</span>
<span class="line">        let {pageNum=1,pageSize=this.config.news.pageSize}=ctx.query;</span>
<span class="line">        const list=await service.news.list(pageNum,pageSize);</span>
<span class="line">+        await ctx.render(&#39;index&#39;,{list,title:this.app.cache?this.app.cache.title:&#39;珠峰新闻列表&#39;});</span>
<span class="line">    }</span>
<span class="line">}</span>
<span class="line">module.exports = NewsController;</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>app\\view\\index.html</p><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code class="language-javascript"><span class="line"><span class="token operator">&lt;</span>div <span class="token keyword">class</span><span class="token operator">=</span><span class="token string">&quot;col-md-8 col-md-offset-2&quot;</span><span class="token operator">&gt;</span></span>
<span class="line"><span class="token punctuation">{</span><span class="token punctuation">{</span>title<span class="token punctuation">}</span><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_8-2-启动时执行定时任务" tabindex="-1"><a class="header-anchor" href="#_8-2-启动时执行定时任务"><span>8.2 启动时执行定时任务</span></a></h3><h4 id="_8-2-1-app-js" tabindex="-1"><a class="header-anchor" href="#_8-2-1-app-js"><span>8.2.1 app.js</span></a></h4><ul><li>框架提供了统一的入口文件（app.js）进行启动过程自定义 app.js<div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code class="language-javascript"><span class="line">module<span class="token punctuation">.</span><span class="token function-variable function">exports</span> <span class="token operator">=</span> <span class="token parameter">app</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></span>
<span class="line">app<span class="token punctuation">.</span><span class="token function">beforeStart</span><span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></span>
<span class="line">  <span class="token comment">// 保证应用启动监听端口前数据已经准备好了</span></span>
<span class="line">  <span class="token comment">// 后续数据的更新由定时任务自动触发</span></span>
<span class="line">  <span class="token keyword">await</span> app<span class="token punctuation">.</span><span class="token function">runSchedule</span><span class="token punctuation">(</span><span class="token string">&#39;update_cache&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></li></ul><h2 id="_9-mysql" tabindex="-1"><a class="header-anchor" href="#_9-mysql"><span>9. MySQL</span></a></h2><ul><li>框架提供了 egg-mysql 插件来访问 MySQL 数据库。这个插件既可以访问普通的 MySQL 数据库，也可以访问基于 MySQL 协议的在线数据库服务。</li></ul><h3 id="_9-1-安装与配置" tabindex="-1"><a class="header-anchor" href="#_9-1-安装与配置"><span>9.1 安装与配置</span></a></h3><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text"><pre><code class="language-text"><span class="line">$ cnpm i --save egg-mysql</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><h3 id="_9-2-开启插件" tabindex="-1"><a class="header-anchor" href="#_9-2-开启插件"><span>9.2 开启插件</span></a></h3><p>config/plugin.js</p><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code class="language-javascript"><span class="line">exports<span class="token punctuation">.</span>mysql <span class="token operator">=</span> <span class="token punctuation">{</span></span>
<span class="line">  <span class="token literal-property property">enable</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span></span>
<span class="line">  <span class="token keyword">package</span><span class="token operator">:</span> <span class="token string">&#39;egg-mysql&#39;</span><span class="token punctuation">,</span></span>
<span class="line"><span class="token punctuation">}</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_9-3-建表" tabindex="-1"><a class="header-anchor" href="#_9-3-建表"><span>9.3 建表</span></a></h3><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code class="language-javascript"><span class="line"><span class="token constant">DROP</span> <span class="token constant">TABLE</span> <span class="token constant">IF</span> <span class="token constant">EXISTS</span> <span class="token template-string"><span class="token template-punctuation string">\`</span><span class="token string">news</span><span class="token template-punctuation string">\`</span></span><span class="token punctuation">;</span></span>
<span class="line"><span class="token constant">CREATE</span> <span class="token constant">TABLE</span> <span class="token template-string"><span class="token template-punctuation string">\`</span><span class="token string">news</span><span class="token template-punctuation string">\`</span></span>  <span class="token punctuation">(</span></span>
<span class="line">  <span class="token template-string"><span class="token template-punctuation string">\`</span><span class="token string">id</span><span class="token template-punctuation string">\`</span></span> <span class="token function">int</span><span class="token punctuation">(</span><span class="token number">11</span><span class="token punctuation">)</span> <span class="token constant">NOT</span> <span class="token constant">NULL</span> <span class="token constant">AUTO_INCREMENT</span><span class="token punctuation">,</span></span>
<span class="line">  <span class="token template-string"><span class="token template-punctuation string">\`</span><span class="token string">title</span><span class="token template-punctuation string">\`</span></span> <span class="token function">varchar</span><span class="token punctuation">(</span><span class="token number">255</span><span class="token punctuation">)</span> <span class="token constant">CHARACTER</span> <span class="token constant">SET</span> utf8mb4 <span class="token constant">COLLATE</span> utf8mb4_bin <span class="token constant">NULL</span> <span class="token constant">DEFAULT</span> <span class="token constant">NULL</span><span class="token punctuation">,</span></span>
<span class="line">  <span class="token template-string"><span class="token template-punctuation string">\`</span><span class="token string">url</span><span class="token template-punctuation string">\`</span></span> <span class="token function">varchar</span><span class="token punctuation">(</span><span class="token number">255</span><span class="token punctuation">)</span> <span class="token constant">CHARACTER</span> <span class="token constant">SET</span> utf8mb4 <span class="token constant">COLLATE</span> utf8mb4_bin <span class="token constant">NULL</span> <span class="token constant">DEFAULT</span> <span class="token constant">NULL</span><span class="token punctuation">,</span></span>
<span class="line">  <span class="token template-string"><span class="token template-punctuation string">\`</span><span class="token string">image</span><span class="token template-punctuation string">\`</span></span> <span class="token function">varchar</span><span class="token punctuation">(</span><span class="token number">255</span><span class="token punctuation">)</span> <span class="token constant">CHARACTER</span> <span class="token constant">SET</span> utf8mb4 <span class="token constant">COLLATE</span> utf8mb4_bin <span class="token constant">NULL</span> <span class="token constant">DEFAULT</span> <span class="token constant">NULL</span><span class="token punctuation">,</span></span>
<span class="line">  <span class="token template-string"><span class="token template-punctuation string">\`</span><span class="token string">createAt</span><span class="token template-punctuation string">\`</span></span> datetime <span class="token constant">NULL</span> <span class="token constant">DEFAULT</span> <span class="token constant">NULL</span><span class="token punctuation">,</span></span>
<span class="line">  <span class="token constant">PRIMARY</span> <span class="token constant">KEY</span> <span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">\`</span><span class="token string">id</span><span class="token template-punctuation string">\`</span></span><span class="token punctuation">)</span> <span class="token constant">USING</span> <span class="token constant">BTREE</span></span>
<span class="line"><span class="token punctuation">)</span> <span class="token constant">ENGINE</span> <span class="token operator">=</span> InnoDB <span class="token constant">AUTO_INCREMENT</span> <span class="token operator">=</span> <span class="token number">4</span> <span class="token constant">CHARACTER</span> <span class="token constant">SET</span> <span class="token operator">=</span> utf8mb4 <span class="token constant">COLLATE</span> <span class="token operator">=</span> utf8mb4_bin <span class="token constant">ROW_FORMAT</span> <span class="token operator">=</span> Compact<span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token constant">INSERT</span> <span class="token constant">INTO</span> <span class="token template-string"><span class="token template-punctuation string">\`</span><span class="token string">news</span><span class="token template-punctuation string">\`</span></span> <span class="token constant">VALUES</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">&#39;世界首富早晚是这个人，坐拥7家独角兽公司，估值破数万！&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;http://tech.ifeng.com/a/20180904/45154322_0.shtml&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;http://p0.ifengimg.com/pmop/2018/0905/CFFF918B94D561D2A61FB434ADA81589E8972025_size41_w640_h479.jpeg&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;2019-06-08 22:07:29&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token constant">INSERT</span> <span class="token constant">INTO</span> <span class="token template-string"><span class="token template-punctuation string">\`</span><span class="token string">news</span><span class="token template-punctuation string">\`</span></span> <span class="token constant">VALUES</span> <span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token string">&#39;支付宝们来了！将来人民币会消失吗？&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;http://finance.ifeng.com/a/20180907/16491630_0.shtml&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;http://p0.ifengimg.com/pmop/2018/0907/2AF684C2EC49B7E3C17FCB13D6DEEF08401D4567_size27_w530_h369.jpeg&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;2019-06-08 22:08:24&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token constant">INSERT</span> <span class="token constant">INTO</span> <span class="token template-string"><span class="token template-punctuation string">\`</span><span class="token string">news</span><span class="token template-punctuation string">\`</span></span> <span class="token constant">VALUES</span> <span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token string">&#39;《福布斯》专访贝索斯：无业务边界的亚马逊 令对手生畏的CEO&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;https://www.jiemian.com/article/2451982.html&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;https://img1.jiemian.com/101/original/20180907/153628523948814900_a580x330.jpg&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;2019-06-08 22:17:16&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_9-4-配置数据源" tabindex="-1"><a class="header-anchor" href="#_9-4-配置数据源"><span>9.4 配置数据源</span></a></h3><p>config/config.\${env}.js</p><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code class="language-javascript"><span class="line">config<span class="token punctuation">.</span>mysql <span class="token operator">=</span> <span class="token punctuation">{</span></span>
<span class="line">  <span class="token comment">// 单数据库信息配置</span></span>
<span class="line">  <span class="token literal-property property">client</span><span class="token operator">:</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token comment">// host</span></span>
<span class="line">    <span class="token literal-property property">host</span><span class="token operator">:</span> <span class="token string">&#39;localhost&#39;</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token comment">// 端口号</span></span>
<span class="line">    <span class="token literal-property property">port</span><span class="token operator">:</span> <span class="token string">&#39;3306&#39;</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token comment">// 用户名</span></span>
<span class="line">    <span class="token literal-property property">user</span><span class="token operator">:</span> <span class="token string">&#39;root&#39;</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token comment">// 密码</span></span>
<span class="line">    <span class="token literal-property property">password</span><span class="token operator">:</span> <span class="token string">&#39;root&#39;</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token comment">// 数据库名</span></span>
<span class="line">    <span class="token literal-property property">database</span><span class="token operator">:</span> <span class="token string">&#39;cms&#39;</span></span>
<span class="line">  <span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">  <span class="token comment">// 是否加载到 app 上，默认开启</span></span>
<span class="line">  <span class="token literal-property property">app</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span></span>
<span class="line">  <span class="token comment">// 是否加载到 agent 上，默认关闭</span></span>
<span class="line">  <span class="token literal-property property">agent</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span></span>
<span class="line"><span class="token punctuation">}</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_9-5-news-js" tabindex="-1"><a class="header-anchor" href="#_9-5-news-js"><span>9.5 news.js</span></a></h3><p>app\\service\\news.js</p><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code class="language-javascript"><span class="line"><span class="token keyword">const</span> <span class="token punctuation">{</span>Service<span class="token punctuation">}</span><span class="token operator">=</span><span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&#39;egg&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">class</span> <span class="token class-name">NewsService</span> <span class="token keyword">extends</span> <span class="token class-name">Service</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">async</span> <span class="token function">list</span><span class="token punctuation">(</span><span class="token parameter">pageNum<span class="token punctuation">,</span>pageSize</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">const</span> <span class="token punctuation">{</span>ctx<span class="token punctuation">}</span><span class="token operator">=</span><span class="token keyword">this</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">let</span> result  <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span>app<span class="token punctuation">.</span>mysql<span class="token punctuation">.</span><span class="token function">query</span><span class="token punctuation">(</span><span class="token string">&#39;select * from news&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">return</span> result<span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line">module<span class="token punctuation">.</span>exports<span class="token operator">=</span>NewsService<span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="_10-sequelize" tabindex="-1"><a class="header-anchor" href="#_10-sequelize"><span>10. Sequelize</span></a></h2><ul><li>在一些较为复杂的应用中，我们可能会需要一个 ORM 框架来帮助我们管理数据层的代码。而在 Node.js 社区中，sequelize 是一个广泛使用的 ORM 框架，它支持 MySQL、PostgreSQL、SQLite 和 MSSQL 等多个数据源</li></ul><h3 id="_10-1-安装" tabindex="-1"><a class="header-anchor" href="#_10-1-安装"><span>10.1 安装</span></a></h3><ul><li><code>egg-sequelize</code>插件会辅助我们将定义好的Model对象加载到<code>app</code>和<code>ctx</code>上</li></ul><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text"><pre><code class="language-text"><span class="line">$ cnpm install --save egg-sequelize mysql2</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><h3 id="_10-2-启用插件" tabindex="-1"><a class="header-anchor" href="#_10-2-启用插件"><span>10.2 启用插件</span></a></h3><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code class="language-javascript"><span class="line">exports<span class="token punctuation">.</span>sequelize <span class="token operator">=</span> <span class="token punctuation">{</span></span>
<span class="line">  <span class="token literal-property property">enable</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span></span>
<span class="line">  <span class="token keyword">package</span><span class="token operator">:</span> <span class="token string">&#39;egg-sequelize&#39;</span><span class="token punctuation">,</span></span>
<span class="line"><span class="token punctuation">}</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_10-3-sequelize-配置" tabindex="-1"><a class="header-anchor" href="#_10-3-sequelize-配置"><span>10.3 sequelize 配置</span></a></h3><p>config/config.default.js</p><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code class="language-javascript"><span class="line">config<span class="token punctuation">.</span>sequelize <span class="token operator">=</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token literal-property property">dialect</span><span class="token operator">:</span> <span class="token string">&#39;mysql&#39;</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token literal-property property">host</span><span class="token operator">:</span> <span class="token string">&#39;localhost&#39;</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token literal-property property">port</span><span class="token operator">:</span> <span class="token number">3306</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token literal-property property">username</span><span class="token operator">:</span> <span class="token string">&quot;root&quot;</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token literal-property property">password</span><span class="token operator">:</span> <span class="token string">&quot;root&quot;</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token literal-property property">database</span><span class="token operator">:</span> <span class="token string">&#39;cms-development&#39;</span></span>
<span class="line"><span class="token punctuation">}</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>config/config.test.js</p><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code class="language-javascript"><span class="line">module<span class="token punctuation">.</span><span class="token function-variable function">exports</span><span class="token operator">=</span><span class="token parameter">app</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">let</span> config<span class="token operator">=</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span></span>
<span class="line">    config<span class="token punctuation">.</span>sequelize <span class="token operator">=</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token literal-property property">dialect</span><span class="token operator">:</span> <span class="token string">&#39;mysql&#39;</span><span class="token punctuation">,</span></span>
<span class="line">        <span class="token literal-property property">host</span><span class="token operator">:</span> <span class="token string">&#39;localhost&#39;</span><span class="token punctuation">,</span></span>
<span class="line">        <span class="token literal-property property">port</span><span class="token operator">:</span> <span class="token number">3306</span><span class="token punctuation">,</span></span>
<span class="line">        <span class="token literal-property property">username</span><span class="token operator">:</span> <span class="token string">&quot;root&quot;</span><span class="token punctuation">,</span></span>
<span class="line">        <span class="token literal-property property">password</span><span class="token operator">:</span> <span class="token string">&quot;root&quot;</span><span class="token punctuation">,</span></span>
<span class="line">        <span class="token literal-property property">database</span><span class="token operator">:</span> <span class="token string">&#39;cms-test&#39;</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token punctuation">}</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">return</span> config<span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_10-4-初始化数据库" tabindex="-1"><a class="header-anchor" href="#_10-4-初始化数据库"><span>10.4 初始化数据库</span></a></h3><h4 id="_10-4-1-安装sequelize-cli" tabindex="-1"><a class="header-anchor" href="#_10-4-1-安装sequelize-cli"><span>10.4.1 安装sequelize-cli</span></a></h4><ul><li>sequelize 提供了 <code>sequelize-cli</code> 工具来实现 <code>Migrations</code></li><li>sequelize-cli用于支持数据迁移和项目引导。通过迁移，可以将现有数据库迁移到另一个状态，反之亦然</li><li>这些迁移文件会被保存在迁移文件中，迁移文件描述了怎样到达新状态以及如何恢复更改以返回到迁移前的旧状态</li></ul><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text"><pre><code class="language-text"><span class="line">cnpm install --save sequelize sequelize-cli</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><h4 id="_10-4-2-sequelizerc" tabindex="-1"><a class="header-anchor" href="#_10-4-2-sequelizerc"><span>10.4.2 .sequelizerc</span></a></h4><ul><li>我们希望将所有数据库 <code>Migrations</code> 相关的内容都放在<code>database</code> 目录下，所以我们在项目根目录下新建一个 <code>.sequelizerc</code> 配置文件 <ul><li>config 包含配置文件，它告诉 CLI 如何连接数据库</li><li>migrations-path 包含所有迁移文件</li><li>seeders-path 包含所有种子文件,seeders 来在初始化数据表中中初始化一些基础数据</li><li>models-path 包含您的项目的所有模型</li></ul></li></ul><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code class="language-javascript"><span class="line"><span class="token keyword">const</span> path <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&#39;path&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span></span>
<span class="line">  <span class="token literal-property property">config</span><span class="token operator">:</span> path<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">&#39;database/config.json&#39;</span><span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line">  <span class="token string-property property">&#39;migrations-path&#39;</span><span class="token operator">:</span> path<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">&#39;database/migrations&#39;</span><span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line">  <span class="token string-property property">&#39;seeders-path&#39;</span><span class="token operator">:</span> path<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">&#39;database/seeders&#39;</span><span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line">  <span class="token string-property property">&#39;models-path&#39;</span><span class="token operator">:</span> path<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">&#39;app/model&#39;</span><span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line"><span class="token punctuation">}</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_10-4-3-初始化-migrations" tabindex="-1"><a class="header-anchor" href="#_10-4-3-初始化-migrations"><span>10.4.3 初始化 Migrations</span></a></h4><ul><li>在项目的演进过程中，每一个迭代都有可能对数据库数据结构做变更，怎样跟踪每一个迭代的数据变更，并在不同的环境（开发、测试、CI）和迭代切换中，快速变更数据结构呢？这时候我们就需要 Migrations 来帮我们管理数据结构的变更了</li><li>初始化 Migrations 配置文件和目录</li><li>执行完后会生成 <code>database/config.json</code> 文件和 <code>database/migrations</code></li></ul><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text"><pre><code class="language-text"><span class="line">npx sequelize init:config</span>
<span class="line">npx sequelize init:migrations</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div></div></div><ul><li>key是环境变量<code>NODE_ENV</code>的值，默认就是 <code>development</code></li><li><code>set NODE_ENV=test</code></li></ul><p>config.json</p><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code class="language-javascript"><span class="line"><span class="token punctuation">{</span></span>
<span class="line">  <span class="token string-property property">&quot;development&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token string-property property">&quot;username&quot;</span><span class="token operator">:</span> <span class="token string">&quot;root&quot;</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token string-property property">&quot;password&quot;</span><span class="token operator">:</span> <span class="token string">&quot;root&quot;</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token string-property property">&quot;database&quot;</span><span class="token operator">:</span> <span class="token string">&quot;cms-development&quot;</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token string-property property">&quot;host&quot;</span><span class="token operator">:</span> <span class="token string">&quot;127.0.0.1&quot;</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token string-property property">&quot;dialect&quot;</span><span class="token operator">:</span> <span class="token string">&quot;mysql&quot;</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token string-property property">&quot;operatorsAliases&quot;</span><span class="token operator">:</span> <span class="token boolean">false</span></span>
<span class="line">  <span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">  <span class="token string-property property">&quot;test&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token string-property property">&quot;username&quot;</span><span class="token operator">:</span> <span class="token string">&quot;root&quot;</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token string-property property">&quot;password&quot;</span><span class="token operator">:</span> <span class="token string">&quot;root&quot;</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token string-property property">&quot;database&quot;</span><span class="token operator">:</span> <span class="token string">&quot;cms-test&quot;</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token string-property property">&quot;host&quot;</span><span class="token operator">:</span> <span class="token string">&quot;127.0.0.1&quot;</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token string-property property">&quot;dialect&quot;</span><span class="token operator">:</span> <span class="token string">&quot;mysql&quot;</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token string-property property">&quot;operatorsAliases&quot;</span><span class="token operator">:</span> <span class="token boolean">false</span></span>
<span class="line">  <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_10-4-4-创建users表" tabindex="-1"><a class="header-anchor" href="#_10-4-4-创建users表"><span>10.4.4 创建users表</span></a></h4><h5 id="_10-4-4-1-创建目录" tabindex="-1"><a class="header-anchor" href="#_10-4-4-1-创建目录"><span>10.4.4.1 创建目录</span></a></h5><ul><li><p>编写项目的第一个 Migration 文件来创建我们的一个 users 表</p><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text"><pre><code class="language-text"><span class="line">npx sequelize migration:generate --name=init-users</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><blockquote><p>执行完后会在 database/migrations 目录下生成一个 migration 文件(\${timestamp}-init-users.js)</p></blockquote></li></ul><h5 id="_10-4-4-2-创建升级脚本" tabindex="-1"><a class="header-anchor" href="#_10-4-4-2-创建升级脚本"><span>10.4.4.2 创建升级脚本</span></a></h5><p>database\\migrations\\20190608143311-init-users.js</p><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code class="language-javascript"><span class="line">module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span></span>
<span class="line">  <span class="token comment">// 在执行数据库升级时调用的函数，创建 users 表</span></span>
<span class="line">  <span class="token function-variable function">up</span><span class="token operator">:</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">queryInterface<span class="token punctuation">,</span> Sequelize</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">const</span> <span class="token punctuation">{</span> <span class="token constant">INTEGER</span><span class="token punctuation">,</span> <span class="token constant">DATE</span><span class="token punctuation">,</span> <span class="token constant">STRING</span> <span class="token punctuation">}</span> <span class="token operator">=</span> Sequelize<span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">await</span> queryInterface<span class="token punctuation">.</span><span class="token function">createTable</span><span class="token punctuation">(</span><span class="token string">&#39;users&#39;</span><span class="token punctuation">,</span> <span class="token punctuation">{</span></span>
<span class="line">      <span class="token literal-property property">id</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token constant">INTEGER</span><span class="token punctuation">,</span> <span class="token literal-property property">primaryKey</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token literal-property property">autoIncrement</span><span class="token operator">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">      <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token constant">STRING</span><span class="token punctuation">(</span><span class="token number">30</span><span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line">      <span class="token literal-property property">age</span><span class="token operator">:</span> <span class="token constant">INTEGER</span><span class="token punctuation">,</span></span>
<span class="line">      <span class="token literal-property property">created_at</span><span class="token operator">:</span> <span class="token constant">DATE</span><span class="token punctuation">,</span></span>
<span class="line">      <span class="token literal-property property">updated_at</span><span class="token operator">:</span> <span class="token constant">DATE</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">  <span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">  <span class="token comment">// 在执行数据库降级时调用的函数，删除 users 表</span></span>
<span class="line">  <span class="token function-variable function">down</span><span class="token operator">:</span> <span class="token keyword">async</span> <span class="token parameter">queryInterface</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">await</span> queryInterface<span class="token punctuation">.</span><span class="token function">dropTable</span><span class="token punctuation">(</span><span class="token string">&#39;users&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">  <span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line"><span class="token punctuation">}</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h5 id="_10-4-4-3-执行-migrate-进行数据库变更" tabindex="-1"><a class="header-anchor" href="#_10-4-4-3-执行-migrate-进行数据库变更"><span>10.4.4.3 执行 migrate 进行数据库变更</span></a></h5><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text"><pre><code class="language-text"><span class="line"> </span>
<span class="line">npx sequelize db:migrate</span>
<span class="line"> </span>
<span class="line"> </span>
<span class="line"> </span>
<span class="line"> </span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h5 id="_10-4-4-4-添加种子数据" tabindex="-1"><a class="header-anchor" href="#_10-4-4-4-添加种子数据"><span>10.4.4.4 添加种子数据</span></a></h5><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text"><pre><code class="language-text"><span class="line">sequelize seed:create --name init-users</span>
<span class="line">npx sequelize db:seed:all</span>
<span class="line">npx sequelize db:seed:all --env development</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>database\\seeders\\20190803152323-init-users.js</p><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code class="language-javascript"><span class="line">module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token function-variable function">up</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token parameter">queryInterface<span class="token punctuation">,</span> Sequelize</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">return</span> queryInterface<span class="token punctuation">.</span><span class="token function">bulkInsert</span><span class="token punctuation">(</span><span class="token string">&#39;users&#39;</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">{</span></span>
<span class="line">            <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">&#39;zhufeng&#39;</span><span class="token punctuation">,</span></span>
<span class="line">            <span class="token literal-property property">age</span><span class="token operator">:</span><span class="token number">1</span><span class="token punctuation">,</span></span>
<span class="line">            <span class="token literal-property property">created_at</span><span class="token operator">:</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line">            <span class="token literal-property property">updated_at</span><span class="token operator">:</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">        <span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token punctuation">{</span></span>
<span class="line">            <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">&#39;jiagou&#39;</span><span class="token punctuation">,</span></span>
<span class="line">            <span class="token literal-property property">age</span><span class="token operator">:</span><span class="token number">2</span><span class="token punctuation">,</span></span>
<span class="line">            <span class="token literal-property property">created_at</span><span class="token operator">:</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line">            <span class="token literal-property property">updated_at</span><span class="token operator">:</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">        <span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line"></span>
<span class="line">    <span class="token function-variable function">down</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token parameter">queryInterface<span class="token punctuation">,</span> Sequelize</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">return</span> queryInterface<span class="token punctuation">.</span><span class="token function">bulkDelete</span><span class="token punctuation">(</span><span class="token string">&#39;users&#39;</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_10-4-5-使用" tabindex="-1"><a class="header-anchor" href="#_10-4-5-使用"><span>10.4.5 使用</span></a></h4><h5 id="_10-4-5-1-app-model-user-js" tabindex="-1"><a class="header-anchor" href="#_10-4-5-1-app-model-user-js"><span>10.4.5.1 app\\model\\user.js</span></a></h5><p>app\\model\\user.js</p><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code class="language-javascript"><span class="line">module<span class="token punctuation">.</span><span class="token function-variable function">exports</span> <span class="token operator">=</span> <span class="token parameter">app</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></span>
<span class="line">  <span class="token keyword">const</span> <span class="token punctuation">{</span> <span class="token constant">STRING</span><span class="token punctuation">,</span> <span class="token constant">INTEGER</span><span class="token punctuation">,</span> <span class="token constant">DATE</span> <span class="token punctuation">}</span> <span class="token operator">=</span> app<span class="token punctuation">.</span>Sequelize<span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">  <span class="token keyword">const</span> User <span class="token operator">=</span> app<span class="token punctuation">.</span>model<span class="token punctuation">.</span><span class="token function">define</span><span class="token punctuation">(</span><span class="token string">&#39;User&#39;</span><span class="token punctuation">,</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token literal-property property">id</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token constant">INTEGER</span><span class="token punctuation">,</span> <span class="token literal-property property">primaryKey</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token literal-property property">autoIncrement</span><span class="token operator">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token constant">STRING</span><span class="token punctuation">(</span><span class="token number">30</span><span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token literal-property property">age</span><span class="token operator">:</span> <span class="token constant">INTEGER</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token literal-property property">created_at</span><span class="token operator">:</span> <span class="token constant">DATE</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token literal-property property">updated_at</span><span class="token operator">:</span> <span class="token constant">DATE</span><span class="token punctuation">,</span></span>
<span class="line">  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">  <span class="token keyword">return</span> User<span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><blockquote><p>这个 Model 就可以在 Controller 和 Service 中通过 app.model.User 或者 ctx.model.User 访问到了</p></blockquote><h5 id="_10-4-5-2-router-js" tabindex="-1"><a class="header-anchor" href="#_10-4-5-2-router-js"><span>10.4.5.2 router.js</span></a></h5><p>app\\router.js</p><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code class="language-javascript"><span class="line">module<span class="token punctuation">.</span><span class="token function-variable function">exports</span> <span class="token operator">=</span> <span class="token parameter">app</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">const</span> <span class="token punctuation">{</span> router<span class="token punctuation">,</span> controller <span class="token punctuation">}</span> <span class="token operator">=</span> app<span class="token punctuation">;</span></span>
<span class="line">    router<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&#39;/news&#39;</span><span class="token punctuation">,</span> controller<span class="token punctuation">.</span>news<span class="token punctuation">.</span>index<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    router<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&#39;/users&#39;</span><span class="token punctuation">,</span> controller<span class="token punctuation">.</span>users<span class="token punctuation">.</span>index<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h5 id="_10-4-5-3-users-js" tabindex="-1"><a class="header-anchor" href="#_10-4-5-3-users-js"><span>10.4.5.3 users.js</span></a></h5><p>app\\controller\\users.js</p><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code class="language-javascript"><span class="line"><span class="token keyword">const</span> <span class="token punctuation">{</span> Controller <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&#39;egg&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">class</span> <span class="token class-name">UserController</span> <span class="token keyword">extends</span> <span class="token class-name">Controller</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">async</span> <span class="token function">index</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">       <span class="token keyword">const</span> <span class="token punctuation">{</span>ctx<span class="token punctuation">,</span>service<span class="token punctuation">}</span><span class="token operator">=</span><span class="token keyword">this</span><span class="token punctuation">;</span></span>
<span class="line">       ctx<span class="token punctuation">.</span>body <span class="token operator">=</span> <span class="token keyword">await</span> ctx<span class="token punctuation">.</span>model<span class="token punctuation">.</span>User<span class="token punctuation">.</span><span class="token function">findAll</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line">module<span class="token punctuation">.</span>exports <span class="token operator">=</span> UserController<span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_10-4-6-单元测试" tabindex="-1"><a class="header-anchor" href="#_10-4-6-单元测试"><span>10.4.6 单元测试</span></a></h4><h5 id="_10-4-6-1-在测试环境中建表" tabindex="-1"><a class="header-anchor" href="#_10-4-6-1-在测试环境中建表"><span>10.4.6.1 在测试环境中建表</span></a></h5><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text"><pre><code class="language-text"><span class="line">npx sequelize db:migrate --env test</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><h5 id="_10-4-6-2-factory-girl" tabindex="-1"><a class="header-anchor" href="#_10-4-6-2-factory-girl"><span>10.4.6.2 factory-girl</span></a></h5><ul><li>通过 factory-girl 模块来快速创建测试数据</li></ul><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text"><pre><code class="language-text"><span class="line">cnpm install --save-dev factory-girl</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><h5 id="_10-4-6-3-factories-js" tabindex="-1"><a class="header-anchor" href="#_10-4-6-3-factories-js"><span>10.4.6.3 factories.js</span></a></h5><p>test/factories.js</p><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code class="language-javascript"><span class="line"><span class="token keyword">const</span> <span class="token punctuation">{</span> factory <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&#39;factory-girl&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">module<span class="token punctuation">.</span><span class="token function-variable function">exports</span> <span class="token operator">=</span> <span class="token parameter">app</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></span>
<span class="line">  <span class="token comment">// 可以通过 app.factory 访问 factory 实例</span></span>
<span class="line">  app<span class="token punctuation">.</span>factory <span class="token operator">=</span> factory<span class="token punctuation">;</span></span>
<span class="line">  <span class="token comment">// 定义 user 和默认数据</span></span>
<span class="line">  factory<span class="token punctuation">.</span><span class="token function">define</span><span class="token punctuation">(</span><span class="token string">&#39;user&#39;</span><span class="token punctuation">,</span> app<span class="token punctuation">.</span>model<span class="token punctuation">.</span>User<span class="token punctuation">,</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token literal-property property">name</span><span class="token operator">:</span> factory<span class="token punctuation">.</span><span class="token function">sequence</span><span class="token punctuation">(</span><span class="token string">&#39;User.name&#39;</span><span class="token punctuation">,</span> <span class="token parameter">n</span> <span class="token operator">=&gt;</span> <span class="token template-string"><span class="token template-punctuation string">\`</span><span class="token string">name_</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">\${</span>n<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">\`</span></span><span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token literal-property property">age</span><span class="token operator">:</span> <span class="token number">18</span><span class="token punctuation">,</span></span>
<span class="line">  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h5 id="_10-4-6-4-setup-js" tabindex="-1"><a class="header-anchor" href="#_10-4-6-4-setup-js"><span>10.4.6.4 .setup.js</span></a></h5><p>test/.setup.js</p><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code class="language-javascript"><span class="line"><span class="token keyword">const</span> <span class="token punctuation">{</span> app <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&#39;egg-mock/bootstrap&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">const</span> factories <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&#39;./factories&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token function">before</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token function">factories</span><span class="token punctuation">(</span>app<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token function">afterEach</span><span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></span>
<span class="line">  <span class="token keyword">await</span> Promise<span class="token punctuation">.</span><span class="token function">all</span><span class="token punctuation">(</span><span class="token punctuation">[</span></span>
<span class="line">    app<span class="token punctuation">.</span>model<span class="token punctuation">.</span>User<span class="token punctuation">.</span><span class="token function">destroy</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token literal-property property">truncate</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token literal-property property">force</span><span class="token operator">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line">  <span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h5 id="_10-4-6-5-users-test-js" tabindex="-1"><a class="header-anchor" href="#_10-4-6-5-users-test-js"><span>10.4.6.5 users.test.js</span></a></h5><p>test/app/controller/users.test.js</p><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code class="language-javascript"><span class="line"><span class="token comment">// test/app/controller/users.test.js</span></span>
<span class="line"><span class="token keyword">const</span> <span class="token punctuation">{</span> assert<span class="token punctuation">,</span> app <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&#39;egg-mock/bootstrap&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token function">describe</span><span class="token punctuation">(</span><span class="token string">&#39;test/app/controller/users.test.js&#39;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></span>
<span class="line">  <span class="token function">describe</span><span class="token punctuation">(</span><span class="token string">&#39;GET /users&#39;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token function">it</span><span class="token punctuation">(</span><span class="token string">&#39;should work&#39;</span><span class="token punctuation">,</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></span>
<span class="line">      <span class="token comment">// 通过 factory-girl 快速创建 user 对象到数据库中</span></span>
<span class="line">      <span class="token keyword">await</span> app<span class="token punctuation">.</span>factory<span class="token punctuation">.</span><span class="token function">createMany</span><span class="token punctuation">(</span><span class="token string">&#39;user&#39;</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">      <span class="token keyword">const</span> res <span class="token operator">=</span> <span class="token keyword">await</span> app<span class="token punctuation">.</span><span class="token function">httpRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&#39;/users&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">      <span class="token function">assert</span><span class="token punctuation">(</span>res<span class="token punctuation">.</span>status <span class="token operator">===</span> <span class="token number">200</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">      <span class="token function">assert</span><span class="token punctuation">(</span>res<span class="token punctuation">.</span>body<span class="token punctuation">.</span>length <span class="token operator">===</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">      <span class="token function">assert</span><span class="token punctuation">(</span>res<span class="token punctuation">.</span>body<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">      <span class="token function">assert</span><span class="token punctuation">(</span>res<span class="token punctuation">.</span>body<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>age<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h5 id="_10-4-6-6-package-json" tabindex="-1"><a class="header-anchor" href="#_10-4-6-6-package-json"><span>10.4.6.6 package.json</span></a></h5><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text"><pre><code class="language-text"><span class="line">&quot;scripts&quot;: {</span>
<span class="line">    &quot;dev&quot;: &quot;egg-bin dev&quot;,</span>
<span class="line">+    &quot;test&quot;: &quot;egg-bin test&quot;</span>
<span class="line">}</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text"><pre><code class="language-text"><span class="line">npm run test</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><h2 id="_11-国际化-i18n" tabindex="-1"><a class="header-anchor" href="#_11-国际化-i18n"><span>11. 国际化（I18n）</span></a></h2><ul><li>为了方便开发多语言应用，框架内置了国际化（I18n）支持，由 egg-i18n 插件提供。</li></ul><h3 id="_11-1-默认语言" tabindex="-1"><a class="header-anchor" href="#_11-1-默认语言"><span>11.1 默认语言</span></a></h3><p>// config/config.default.js</p><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code class="language-javascript"><span class="line">exports<span class="token punctuation">.</span>i18n <span class="token operator">=</span> <span class="token punctuation">{</span></span>
<span class="line">  <span class="token literal-property property">defaultLocale</span><span class="token operator">:</span> <span class="token string">&#39;zh-CN&#39;</span><span class="token punctuation">,</span></span>
<span class="line"><span class="token punctuation">}</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_11-2-多语言文件" tabindex="-1"><a class="header-anchor" href="#_11-2-多语言文件"><span>11.2 多语言文件</span></a></h3><p>多种语言的配置是独立的，统一存放在 config/locale/*.js 下。</p><ul><li>config/locale/ <ul><li>en-US.js</li><li>zh-CN.js</li></ul></li></ul><h4 id="_11-2-1-en-us-js" tabindex="-1"><a class="header-anchor" href="#_11-2-1-en-us-js"><span>11.2.1 en-US.js</span></a></h4><p>config/locale/en-US.js</p><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code class="language-javascript"><span class="line">module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token literal-property property">Email</span><span class="token operator">:</span> <span class="token string">&#39;Email&#39;</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token string-property property">&#39;Welcome back, %s!&#39;</span><span class="token operator">:</span> <span class="token string">&#39;welcome back，%s!&#39;</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token string-property property">&#39;Hello {0}! My name is {1}.&#39;</span><span class="token operator">:</span> <span class="token string">&#39;你好 {0}! 我的名字叫 {1}。&#39;</span><span class="token punctuation">,</span></span>
<span class="line"><span class="token punctuation">}</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_11-2-2-zh-cn-js" tabindex="-1"><a class="header-anchor" href="#_11-2-2-zh-cn-js"><span>11.2.2 zh-CN.js</span></a></h4><p>config/locale/zh-CN.js</p><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code class="language-javascript"><span class="line"><span class="token comment">// config/locale/zh-CN.js</span></span>
<span class="line">module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token literal-property property">Email</span><span class="token operator">:</span> <span class="token string">&#39;邮箱&#39;</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token string-property property">&#39;Welcome back, %s!&#39;</span><span class="token operator">:</span> <span class="token string">&#39;欢迎回来，%s!&#39;</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token string-property property">&#39;Hello {0}! My name is {1}.&#39;</span><span class="token operator">:</span> <span class="token string">&#39;Hello {0}! My name is {1}.&#39;</span><span class="token punctuation">,</span></span>
<span class="line"><span class="token punctuation">}</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_11-3-获取多语言文本" tabindex="-1"><a class="header-anchor" href="#_11-3-获取多语言文本"><span>11.3 获取多语言文本</span></a></h3><ul><li>我们可以使用 __ (Alias: gettext) 函数获取 locale 文件夹下面的多语言文本。</li></ul><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code class="language-javascript"><span class="line">ctx<span class="token punctuation">.</span><span class="token function">__</span><span class="token punctuation">(</span><span class="token string">&#39;Email&#39;</span><span class="token punctuation">)</span></span>
<span class="line"><span class="token comment">// zh-CN =&gt; 邮箱</span></span>
<span class="line"><span class="token comment">// en-US =&gt; Email</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>app\\router.js</p><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code class="language-javascript"><span class="line">router<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&#39;/hello&#39;</span><span class="token punctuation">,</span> controller<span class="token punctuation">.</span>news<span class="token punctuation">.</span>hello<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p>app\\controller\\news.js</p><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text"><pre><code class="language-text"><span class="line">const { Controller } = require(&#39;egg&#39;);</span>
<span class="line">class NewsController extends Controller {</span>
<span class="line">    async hello(){</span>
<span class="line">        const {ctx}=this;</span>
<span class="line">+        let email = ctx.__(&#39;Email&#39;);</span>
<span class="line">+        let welcome = ctx.__(&#39;Welcome back, %s!&#39;, &#39;zhufeng&#39;);</span>
<span class="line">+        let Hello = ctx.__(&#39;Hello {0}! My name is {1}.&#39;, [&#39;zhufeng&#39;,&#39;jiagou&#39;]);</span>
<span class="line">+        ctx.body = email+welcome+Hello;</span>
<span class="line">    }</span>
<span class="line">}</span>
<span class="line">module.exports = NewsController;</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>app\\view\\index.html</p><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text"><pre><code class="language-text"><span class="line"> {{__(&#39;Email&#39;)}} </span>
<span class="line"> {{__(&#39;Welcome back, %s!&#39;, name)}} </span>
<span class="line"> {{__(&#39;Hello {0}! My name is {1}.&#39;, names)}} </span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="_12-扩展工具方法" tabindex="-1"><a class="header-anchor" href="#_12-扩展工具方法"><span>12. 扩展工具方法</span></a></h2><ul><li>框架提供了一种快速扩展的方式，只需在<code>app/extend</code>目录下提供扩展脚本即可</li><li>Helper 函数用来提供一些实用的 <code>utility</code> 函数。</li><li>访问方式 通过 <code>ctx.helper</code> 访问到 helper 对象</li></ul><p>app\\extend\\helper.js</p><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code class="language-javascript"><span class="line"><span class="token keyword">const</span> moment<span class="token operator">=</span><span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&#39;moment&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">moment<span class="token punctuation">.</span><span class="token function">locale</span><span class="token punctuation">(</span><span class="token string">&#39;zh-cn&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">exports<span class="token punctuation">.</span><span class="token function-variable function">fromNow</span><span class="token operator">=</span><span class="token parameter">dateTime</span> <span class="token operator">=&gt;</span> <span class="token function">moment</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span>dateTime<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">fromNow</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>app\\controller\\news.js</p><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code class="language-javascript"><span class="line">list<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">item</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></span>
<span class="line">            item<span class="token punctuation">.</span>createAt<span class="token operator">=</span>ctx<span class="token punctuation">.</span>helper<span class="token punctuation">.</span><span class="token function">fromNow</span><span class="token punctuation">(</span>item<span class="token punctuation">.</span>createAt<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">            <span class="token keyword">return</span> item<span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>app\\view\\index.html</p><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text"><pre><code class="language-text"><span class="line">时间: {{helper.fromNow(news.createAt)}}</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><h2 id="_13-中间件" tabindex="-1"><a class="header-anchor" href="#_13-中间件"><span>13. 中间件</span></a></h2><p>app/middleware/robot.js</p><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code class="language-javascript"><span class="line">module<span class="token punctuation">.</span><span class="token function-variable function">exports</span><span class="token operator">=</span><span class="token punctuation">(</span><span class="token parameter">options<span class="token punctuation">,</span>app</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">return</span> <span class="token keyword">async</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">ctx<span class="token punctuation">,</span>next</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">const</span> source<span class="token operator">=</span>ctx<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&#39;user-agent&#39;</span><span class="token punctuation">)</span><span class="token operator">||</span><span class="token string">&#39;&#39;</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">const</span> matched<span class="token operator">=</span>options<span class="token punctuation">.</span>ua<span class="token punctuation">.</span><span class="token function">some</span><span class="token punctuation">(</span><span class="token parameter">ua</span> <span class="token operator">=&gt;</span> ua<span class="token punctuation">.</span><span class="token function">test</span><span class="token punctuation">(</span>source<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">if</span> <span class="token punctuation">(</span>matched<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">            ctx<span class="token punctuation">.</span>status<span class="token operator">=</span><span class="token number">403</span><span class="token punctuation">;</span></span>
<span class="line">            ctx<span class="token punctuation">.</span>body<span class="token operator">=</span><span class="token string">&#39;你没有访问权限&#39;</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token keyword">await</span> <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>config.default.js</p><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code class="language-javascript"><span class="line">    config<span class="token punctuation">.</span>middleware<span class="token operator">=</span><span class="token punctuation">[</span></span>
<span class="line">        <span class="token string">&#39;robot&#39;</span></span>
<span class="line">    <span class="token punctuation">]</span></span>
<span class="line">    config<span class="token punctuation">.</span>robot<span class="token operator">=</span><span class="token punctuation">{</span></span>
<span class="line">        <span class="token literal-property property">ua</span><span class="token operator">:</span> <span class="token punctuation">[</span></span>
<span class="line">            <span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">Chrome</span><span class="token regex-delimiter">/</span></span></span>
<span class="line">        <span class="token punctuation">]</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code class="language-javascript"><span class="line">curl <span class="token operator">-</span>v  <span class="token operator">--</span>user<span class="token operator">-</span>agent <span class="token string">&#39;Chrome&#39;</span>  <span class="token literal-property property">http</span><span class="token operator">:</span><span class="token operator">/</span><span class="token operator">/</span><span class="token number">127.0</span><span class="token number">.0</span><span class="token number">.1</span><span class="token operator">:</span><span class="token number">7001</span><span class="token operator">/</span>news</span>
<span class="line">curl <span class="token operator">-</span>v  <span class="token operator">--</span>user<span class="token operator">-</span>agent <span class="token string">&#39;Chrome&#39;</span>  <span class="token literal-property property">http</span><span class="token operator">:</span><span class="token operator">/</span><span class="token operator">/</span><span class="token number">127.0</span><span class="token number">.0</span><span class="token number">.1</span><span class="token operator">:</span><span class="token number">7001</span><span class="token operator">/</span>news</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="_14-运行环境" tabindex="-1"><a class="header-anchor" href="#_14-运行环境"><span>14.运行环境</span></a></h2><p>框架有两种方式指定运行环境：</p><ul><li>通过 <code>config/env</code> 文件指定，该文件的内容就是运行环境，如 prod。</li><li>通过 <code>EGG_SERVER_ENV</code> 环境变量指定。</li><li>框架提供了变量 <code>app.config.env</code> 来表示应用当前的运行环境。</li><li>支持按环境变量加载不同的配置文件，如 <code>config.local.js</code>， <code>config.prod.js</code> 等等</li></ul><table><thead><tr><th style="text-align:left;">EGG_SERVER_ENV</th><th style="text-align:left;">说明</th></tr></thead><tbody><tr><td style="text-align:left;">local</td><td style="text-align:left;">本地开发环境</td></tr><tr><td style="text-align:left;">prod</td><td style="text-align:left;">生产环境</td></tr></tbody></table><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text"><pre><code class="language-text"><span class="line">npm install  cross-env --save-dev</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code class="language-javascript"><span class="line"><span class="token string-property property">&quot;scripts&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token string-property property">&quot;dev&quot;</span><span class="token operator">:</span> <span class="token string">&quot;cross-env EGG_SERVER_ENV=local  egg-bin dev&quot;</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token string-property property">&quot;debug&quot;</span><span class="token operator">:</span> <span class="token string">&quot;egg-bin debug&quot;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="_15-单元测试" tabindex="-1"><a class="header-anchor" href="#_15-单元测试"><span>15. 单元测试</span></a></h2><h3 id="_15-1-单元测试的优点" tabindex="-1"><a class="header-anchor" href="#_15-1-单元测试的优点"><span>15.1 单元测试的优点</span></a></h3><ul><li>代码质量持续有保障</li><li>重构正确性保障</li><li>增强自信心</li><li>自动化运行</li></ul><h3 id="_15-2-测试框架" tabindex="-1"><a class="header-anchor" href="#_15-2-测试框架"><span>15.2 测试框架</span></a></h3><ul><li><a href="https://mochajs.org/" target="_blank" rel="noopener noreferrer">mochajs</a></li><li><a href="https://github.com/power-assert-js/power-assert" target="_blank" rel="noopener noreferrer">power-assert</a></li></ul><h3 id="_15-3-测试约定" tabindex="-1"><a class="header-anchor" href="#_15-3-测试约定"><span>15.3 测试约定</span></a></h3><h4 id="_15-3-1-测试目录结构" tabindex="-1"><a class="header-anchor" href="#_15-3-1-测试目录结构"><span>15.3.1 测试目录结构</span></a></h4><ul><li>我们约定 <code>test</code> 目录为存放所有测试脚本的目录，测试所使用到的 <code>fixtures</code> 和相关辅助脚本都应该放在此目录下。</li><li>测试脚本文件统一按 \${filename}.test.js 命名，必须以 .test.js 作为文件后缀。 一个应用的测试目录示例：<div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text"><pre><code class="language-text"><span class="line">test</span>
<span class="line">├── controller</span>
<span class="line">│   └── news.test.js</span>
<span class="line">└── service</span>
<span class="line">  └── news.test.js</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></li></ul><h4 id="_15-3-2-测试运行工具" tabindex="-1"><a class="header-anchor" href="#_15-3-2-测试运行工具"><span>15.3.2 测试运行工具</span></a></h4><p>统一使用 egg-bin 来运行测试脚本， 自动将内置的 Mocha、co-mocha、power-assert，nyc 等模块组合引入到测试脚本中， 让我们聚焦精力在编写测试代码上，而不是纠结选择那些测试周边工具和模块。</p><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text"><pre><code class="language-text"><span class="line">  &quot;scripts&quot;: {</span>
<span class="line">    &quot;test&quot;: &quot;egg-bin test&quot;,</span>
<span class="line">    &quot;cov&quot;: &quot;egg-bin cov&quot;</span>
<span class="line">  }</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_15-3-3-mock" tabindex="-1"><a class="header-anchor" href="#_15-3-3-mock"><span>15.3.3 mock</span></a></h4><ul><li>如果要完整手写一个 app 创建和启动代码，还是需要写一段初始化脚本的， 并且还需要在测试跑完之后做一些清理工作，如删除临时文件，销毁 app。</li><li>常常还有模拟各种网络异常，服务访问异常等特殊情况。</li><li>egg.js单独为框架抽取了一个测试 mock 辅助模块：<code>egg-mock</code>， 有了它我们就可以非常快速地编写一个 app 的单元测试，并且还能快速创建一个 ctx 来测试它的属性、方法和 Service 等。</li></ul><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text"><pre><code class="language-text"><span class="line">cnpm i egg-mock -D</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><h4 id="_15-3-4-app" tabindex="-1"><a class="header-anchor" href="#_15-3-4-app"><span>15.3.4 app</span></a></h4><p>在测试运行之前，我们首先要创建应用的一个 app 实例， 通过它来访问需要被测试的 Controller、Middleware、Service 等应用层代码。</p><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code class="language-javascript"><span class="line"><span class="token comment">// test/controller/news.test.js</span></span>
<span class="line"><span class="token keyword">const</span> <span class="token punctuation">{</span> app<span class="token punctuation">,</span> mock<span class="token punctuation">,</span> assert <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&#39;egg-mock/bootstrap&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token function">describe</span><span class="token punctuation">(</span><span class="token string">&#39;test/controller/news.test.js&#39;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></span>
<span class="line"></span>
<span class="line"><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_15-3-5-钩子函数" tabindex="-1"><a class="header-anchor" href="#_15-3-5-钩子函数"><span>15.3.5 钩子函数</span></a></h4><p>test/order.test.js</p><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code class="language-javascript"><span class="line"><span class="token function">describe</span><span class="token punctuation">(</span><span class="token string">&#39;egg test&#39;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></span>
<span class="line">  <span class="token function">before</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&#39;order 1&#39;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">  <span class="token function">before</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&#39;order 2&#39;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">  <span class="token function">after</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&#39;order 6&#39;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">  <span class="token function">beforeEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&#39;order 3&#39;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">  <span class="token function">afterEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&#39;order 5&#39;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">  <span class="token function">it</span><span class="token punctuation">(</span><span class="token string">&#39;should worker&#39;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&#39;order 4&#39;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_15-3-6-ctx" tabindex="-1"><a class="header-anchor" href="#_15-3-6-ctx"><span>15.3.6 ctx</span></a></h4><p>test/controller/news.test.js</p><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code class="language-javascript"><span class="line"><span class="token keyword">const</span> <span class="token punctuation">{</span> app<span class="token punctuation">,</span> mock<span class="token punctuation">,</span> assert <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&#39;egg-mock/bootstrap&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token function">describe</span><span class="token punctuation">(</span><span class="token string">&#39;test/controller/news.test.js&#39;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></span>
<span class="line">  <span class="token function">it</span><span class="token punctuation">(</span><span class="token string">&#39;should get a ctx&#39;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">const</span> ctx<span class="token operator">=</span>app<span class="token punctuation">.</span><span class="token function">mockContext</span><span class="token punctuation">(</span><span class="token punctuation">{</span></span>
<span class="line">          <span class="token literal-property property">session</span><span class="token operator">:</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token literal-property property">user</span><span class="token operator">:</span><span class="token punctuation">{</span><span class="token literal-property property">name</span><span class="token operator">:</span><span class="token string">&#39;zfpx&#39;</span><span class="token punctuation">}</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token function">assert</span><span class="token punctuation">(</span>ctx<span class="token punctuation">.</span>method <span class="token operator">===</span> <span class="token string">&#39;GET&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token function">assert</span><span class="token punctuation">(</span>ctx<span class="token punctuation">.</span>url<span class="token operator">===</span><span class="token string">&#39;/&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token function">assert</span><span class="token punctuation">(</span>ctx<span class="token punctuation">.</span>session<span class="token punctuation">.</span>user<span class="token punctuation">.</span>name <span class="token operator">==</span> <span class="token string">&#39;zfpx&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_15-3-7-异步测试" tabindex="-1"><a class="header-anchor" href="#_15-3-7-异步测试"><span>15.3.7 异步测试</span></a></h4><p>test/controller/news.test.js</p><ul><li>egg-bin 支持测试异步调用，它支持多种写法</li></ul><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text"><pre><code class="language-text"><span class="line">  /*</span>
<span class="line">  it(&#39;promise&#39;,() =&gt; {</span>
<span class="line">    return app.httpRequest().get(&#39;/news&#39;).expect(200);</span>
<span class="line">  });</span>
<span class="line">  */</span>
<span class="line">  /*</span>
<span class="line">  it(&#39;callback&#39;,(done) =&gt; {</span>
<span class="line">      app.httpRequest().get(&#39;/news&#39;).expect(200,done);</span>
<span class="line">  });</span>
<span class="line">  */</span>
<span class="line">  /*</span>
<span class="line">  it(&#39;async&#39;,async () =&gt; {</span>
<span class="line">      await app.httpRequest().get(&#39;/news&#39;).expect(200);</span>
<span class="line">  });</span>
<span class="line">  */</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_15-4-全面测试" tabindex="-1"><a class="header-anchor" href="#_15-4-全面测试"><span>15.4 全面测试</span></a></h3><h4 id="_15-4-1-测试controller" tabindex="-1"><a class="header-anchor" href="#_15-4-1-测试controller"><span>15.4.1 测试Controller</span></a></h4><p>test/controller/user.test.js</p><ul><li><code>app.httpRequest()</code>是 <code>egg-mock</code> 封装的 <a href="https://github.com/visionmedia/supertest" target="_blank" rel="noopener noreferrer">SuperTest</a> 请求实例</li></ul><h5 id="_15-4-1-1-准备数据" tabindex="-1"><a class="header-anchor" href="#_15-4-1-1-准备数据"><span>15.4.1.1 准备数据</span></a></h5><p>app/router.js</p><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code class="language-javascript"><span class="line">router<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&#39;/add&#39;</span><span class="token punctuation">,</span>controller<span class="token punctuation">.</span>user<span class="token punctuation">.</span>add<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">router<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span><span class="token string">&#39;/doAdd&#39;</span><span class="token punctuation">,</span>controller<span class="token punctuation">.</span>user<span class="token punctuation">.</span>doAdd<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div></div></div><p>app/controller/user.js</p><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code class="language-javascript"><span class="line"><span class="token keyword">const</span> <span class="token punctuation">{</span>Controller<span class="token punctuation">}</span><span class="token operator">=</span><span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&#39;egg&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">let</span> users<span class="token operator">=</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">class</span> <span class="token class-name">UserController</span> <span class="token keyword">extends</span> <span class="token class-name">Controller</span><span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">async</span> <span class="token function">index</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">let</span> <span class="token punctuation">{</span>ctx<span class="token punctuation">}</span><span class="token operator">=</span><span class="token keyword">this</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">await</span> ctx<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span><span class="token string">&#39;user/list&#39;</span><span class="token punctuation">,</span><span class="token punctuation">{</span>users<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    <span class="token keyword">async</span> <span class="token function">add</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">let</span> <span class="token punctuation">{</span>ctx<span class="token punctuation">}</span><span class="token operator">=</span><span class="token keyword">this</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">await</span> ctx<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span><span class="token string">&#39;user/add&#39;</span><span class="token punctuation">,</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    <span class="token keyword">async</span> <span class="token function">doAdd</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">let</span> <span class="token punctuation">{</span>ctx<span class="token punctuation">}</span><span class="token operator">=</span><span class="token keyword">this</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">let</span> user<span class="token operator">=</span>ctx<span class="token punctuation">.</span>request<span class="token punctuation">.</span>body<span class="token punctuation">;</span></span>
<span class="line">        user<span class="token punctuation">.</span>id<span class="token operator">=</span>users<span class="token punctuation">.</span>length<span class="token operator">&gt;</span><span class="token number">0</span><span class="token operator">?</span>users<span class="token punctuation">[</span>users<span class="token punctuation">.</span>length<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>id<span class="token operator">+</span><span class="token number">1</span><span class="token operator">:</span><span class="token number">1</span><span class="token punctuation">;</span></span>
<span class="line">        users<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>user<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        ctx<span class="token punctuation">.</span>body <span class="token operator">=</span> user<span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line">module<span class="token punctuation">.</span>exports<span class="token operator">=</span>UserController<span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h5 id="_15-4-1-2-user-test-js" tabindex="-1"><a class="header-anchor" href="#_15-4-1-2-user-test-js"><span>15.4.1.2 user.test.js</span></a></h5><p>test/controller/user.test.js</p><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code class="language-javascript"><span class="line"><span class="token keyword">const</span> <span class="token punctuation">{</span> app<span class="token punctuation">,</span> mock<span class="token punctuation">,</span> assert <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&#39;egg-mock/bootstrap&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token function">it</span><span class="token punctuation">(</span><span class="token string">&#39;test post&#39;</span><span class="token punctuation">,</span><span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">let</span> user<span class="token operator">=</span><span class="token punctuation">{</span><span class="token literal-property property">username</span><span class="token operator">:</span> <span class="token string">&#39;zfpx&#39;</span><span class="token punctuation">}</span><span class="token punctuation">;</span></span>
<span class="line">        app<span class="token punctuation">.</span><span class="token function">mockCsrf</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">let</span> response<span class="token operator">=</span><span class="token keyword">await</span> app<span class="token punctuation">.</span><span class="token function">httpRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span><span class="token string">&#39;/doAdd&#39;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span>user<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">expect</span><span class="token punctuation">(</span><span class="token number">200</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token function">assert</span><span class="token punctuation">(</span>response<span class="token punctuation">.</span>body<span class="token punctuation">.</span>id <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_15-4-2-测试service" tabindex="-1"><a class="header-anchor" href="#_15-4-2-测试service"><span>15.4.2 测试service</span></a></h4><ul><li>Service 相对于 Controller 来说，测试起来会更加简单</li><li>我们只需要先创建一个 ctx，然后通过 <code>ctx.service.\${serviceName}</code> 拿到 Service 实例， 然后调用 Service 方法即可。</li></ul><p>test/service/user.test.js</p><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code class="language-javascript"><span class="line"><span class="token keyword">const</span> <span class="token punctuation">{</span> app<span class="token punctuation">,</span> mock<span class="token punctuation">,</span> assert <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&#39;egg-mock/bootstrap&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">const</span> <span class="token punctuation">{</span>app<span class="token punctuation">,</span>assert<span class="token punctuation">}</span><span class="token operator">=</span><span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&#39;egg-mock/bootstrap&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token function">describe</span><span class="token punctuation">(</span><span class="token string">&#39;test/service/news.test.js&#39;</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token function">it</span><span class="token punctuation">(</span><span class="token string">&#39;newsService&#39;</span><span class="token punctuation">,</span><span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">let</span> ctx<span class="token operator">=</span>app<span class="token punctuation">.</span><span class="token function">mockContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">let</span> result<span class="token operator">=</span><span class="token keyword">await</span> ctx<span class="token punctuation">.</span>service<span class="token punctuation">.</span>news<span class="token punctuation">.</span><span class="token function">list</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token function">assert</span><span class="token punctuation">(</span>result<span class="token punctuation">.</span>length <span class="token operator">==</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_15-4-3-extend-测试" tabindex="-1"><a class="header-anchor" href="#_15-4-3-extend-测试"><span>15.4.3 Extend 测试</span></a></h4><p>应用可以对 Application、Request、Response、Context 和 Helper 进行扩展。 我们可以对扩展的方法或者属性针对性的编写单元测试。</p><h5 id="_15-4-3-1-application" tabindex="-1"><a class="header-anchor" href="#_15-4-3-1-application"><span>15.4.3.1 application</span></a></h5><p>egg-mock 创建 app 的时候，已经将 Application 的扩展自动加载到 app 实例了， 直接使用这个 app 实例访问扩展的属性和方法即可进行测试。</p><p>app/extend/application.js</p><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code class="language-javascript"><span class="line"><span class="token keyword">let</span> cacheData<span class="token operator">=</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span></span>
<span class="line">exports<span class="token punctuation">.</span>cache<span class="token operator">=</span><span class="token punctuation">{</span></span>
<span class="line">    <span class="token function">get</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">return</span> cacheData<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token function">set</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span>val<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        cacheData<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token operator">=</span>val<span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>test/app/extend/cache.test.js</p><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code class="language-javascript"><span class="line"><span class="token keyword">const</span> <span class="token punctuation">{</span> app<span class="token punctuation">,</span> mock<span class="token punctuation">,</span> assert <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&#39;egg-mock/bootstrap&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token function">describe</span><span class="token punctuation">(</span><span class="token string">&#39;test/app/extend/cache.test.js&#39;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token function">it</span><span class="token punctuation">(</span><span class="token string">&#39;cache&#39;</span><span class="token punctuation">,</span><span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></span>
<span class="line">        app<span class="token punctuation">.</span>cache<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token string">&#39;name&#39;</span><span class="token punctuation">,</span><span class="token string">&#39;zfpx&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token function">assert</span><span class="token punctuation">(</span>app<span class="token punctuation">.</span>cache<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&#39;name&#39;</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token string">&#39;zfpx&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h5 id="_15-4-3-2-context" tabindex="-1"><a class="header-anchor" href="#_15-4-3-2-context"><span>15.4.3.2 context</span></a></h5><ul><li>Context 测试只比 Application 多了一个 <code>app.mockContext()</code> 步骤来模拟创建一个 Context 对象。</li></ul><p>app\\extend\\context.js</p><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code class="language-javascript"><span class="line">exports<span class="token punctuation">.</span><span class="token function-variable function">language</span><span class="token operator">=</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&#39;accept-language&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>test/app/extend/context.test.js</p><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code class="language-javascript"><span class="line"><span class="token keyword">const</span> <span class="token punctuation">{</span> app<span class="token punctuation">,</span> mock<span class="token punctuation">,</span> assert <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&#39;egg-mock/bootstrap&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token function">describe</span><span class="token punctuation">(</span><span class="token string">&#39;test/app/extend/context.test.js&#39;</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">let</span> language<span class="token operator">=</span><span class="token string">&quot;zh-cn&quot;</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token function">it</span><span class="token punctuation">(</span><span class="token string">&#39;test language&#39;</span><span class="token punctuation">,</span><span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">const</span> ctx<span class="token operator">=</span>app<span class="token punctuation">.</span><span class="token function">mockContext</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token literal-property property">headers</span><span class="token operator">:</span> <span class="token punctuation">{</span><span class="token string-property property">&#39;Accept-Language&#39;</span><span class="token operator">:</span>language<span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token comment">//console.log(&#39;ctx.lan&#39;,ctx.lan())</span></span>
<span class="line">        <span class="token function">assert</span><span class="token punctuation">(</span>ctx<span class="token punctuation">.</span><span class="token function">language</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> language<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h5 id="_15-4-3-3-request" tabindex="-1"><a class="header-anchor" href="#_15-4-3-3-request"><span>15.4.3.3 Request</span></a></h5><p>通过 ctx.request 来访问 Request 扩展的属性和方法，直接即可进行测试。 app\\extend\\request.js</p><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code class="language-javascript"><span class="line">module<span class="token punctuation">.</span>exports<span class="token operator">=</span><span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">get</span> <span class="token function">isChrome</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">const</span> userAgent<span class="token operator">=</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&#39;User-Agent&#39;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toLowerCase</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">return</span> userAgent<span class="token punctuation">.</span><span class="token function">includes</span><span class="token punctuation">(</span><span class="token string">&#39;chrome&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>test\\extend\\request.test.js</p><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code class="language-javascript"><span class="line"><span class="token keyword">const</span> <span class="token punctuation">{</span> app<span class="token punctuation">,</span> mock<span class="token punctuation">,</span> assert <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&#39;egg-mock/bootstrap&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token function">describe</span><span class="token punctuation">(</span><span class="token string">&#39;test/app/extend/request.test.js&#39;</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token function">it</span><span class="token punctuation">(</span><span class="token string">&#39;cache&#39;</span><span class="token punctuation">,</span><span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">const</span> ctx<span class="token operator">=</span>app<span class="token punctuation">.</span><span class="token function">mockContext</span><span class="token punctuation">(</span><span class="token punctuation">{</span></span>
<span class="line">            <span class="token literal-property property">headers</span><span class="token operator">:</span> <span class="token punctuation">{</span></span>
<span class="line">                <span class="token string-property property">&#39;User-Agent&#39;</span><span class="token operator">:</span><span class="token string">&#39;I love Chrome&#39;</span></span>
<span class="line">            <span class="token punctuation">}</span></span>
<span class="line">        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token function">assert</span><span class="token punctuation">(</span>ctx<span class="token punctuation">.</span>request<span class="token punctuation">.</span>isChrome<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h5 id="_15-4-3-4-response" tabindex="-1"><a class="header-anchor" href="#_15-4-3-4-response"><span>15.4.3.4 response</span></a></h5><p>Response 测试与 Request 完全一致。 通过 ctx.response 来访问 Response 扩展的属性和方法，直接即可进行测试。 app\\extend\\response.js</p><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code class="language-javascript"><span class="line">module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span></span>
<span class="line">  <span class="token keyword">get</span> <span class="token function">isSuccess</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>status <span class="token operator">===</span> <span class="token number">200</span><span class="token punctuation">;</span></span>
<span class="line">  <span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line"><span class="token punctuation">}</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>test\\extend\\response.test.js</p><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code class="language-javascript"><span class="line"><span class="token function">describe</span><span class="token punctuation">(</span><span class="token string">&#39;isSuccess()&#39;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></span>
<span class="line">  <span class="token function">it</span><span class="token punctuation">(</span><span class="token string">&#39;should true&#39;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">const</span> ctx <span class="token operator">=</span> app<span class="token punctuation">.</span><span class="token function">mockContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    ctx<span class="token punctuation">.</span>status <span class="token operator">=</span> <span class="token number">200</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token function">assert</span><span class="token punctuation">(</span>ctx<span class="token punctuation">.</span>response<span class="token punctuation">.</span>isSuccess <span class="token operator">===</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">  <span class="token function">it</span><span class="token punctuation">(</span><span class="token string">&#39;should false&#39;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">const</span> ctx <span class="token operator">=</span> app<span class="token punctuation">.</span><span class="token function">mockContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    ctx<span class="token punctuation">.</span>status <span class="token operator">=</span> <span class="token number">404</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token function">assert</span><span class="token punctuation">(</span>ctx<span class="token punctuation">.</span>response<span class="token punctuation">.</span>isSuccess <span class="token operator">===</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h5 id="_15-4-3-5-helper" tabindex="-1"><a class="header-anchor" href="#_15-4-3-5-helper"><span>15.4.3.5 Helper</span></a></h5><ul><li>Helper 测试方式与 Service 类似，也是通过 ctx 来访问到 Helper，然后调用 Helper 方法测试</li></ul><p>app\\extend\\helper.js</p><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code class="language-javascript"><span class="line">module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span></span>
<span class="line">  <span class="token function">money</span><span class="token punctuation">(</span><span class="token parameter">val</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">const</span> lang <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>ctx<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&#39;accept-language&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">if</span> <span class="token punctuation">(</span>lang<span class="token punctuation">.</span><span class="token function">includes</span><span class="token punctuation">(</span><span class="token string">&#39;zh-cn&#39;</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">      <span class="token keyword">return</span> <span class="token template-string"><span class="token template-punctuation string">\`</span><span class="token string">￥ </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">\${</span>val<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">\`</span></span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    <span class="token keyword">return</span> <span class="token template-string"><span class="token template-punctuation string">\`</span><span class="token string">$ </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">\${</span>val<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">\`</span></span><span class="token punctuation">;</span></span>
<span class="line">  <span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line"><span class="token punctuation">}</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>test\\extend\\helper.test.js</p><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code class="language-javascript"><span class="line"><span class="token function">describe</span><span class="token punctuation">(</span><span class="token string">&#39;money()&#39;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></span>
<span class="line">  <span class="token function">it</span><span class="token punctuation">(</span><span class="token string">&#39;should RMB&#39;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">const</span> ctx <span class="token operator">=</span> app<span class="token punctuation">.</span><span class="token function">mockContext</span><span class="token punctuation">(</span><span class="token punctuation">{</span></span>
<span class="line">      <span class="token comment">// 模拟 ctx 的 headers</span></span>
<span class="line">      <span class="token literal-property property">headers</span><span class="token operator">:</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token string-property property">&#39;Accept-Language&#39;</span><span class="token operator">:</span> <span class="token string">&#39;zh-cn&#39;</span><span class="token punctuation">,</span></span>
<span class="line">      <span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token function">assert</span><span class="token punctuation">(</span>ctx<span class="token punctuation">.</span>helper<span class="token punctuation">.</span><span class="token function">money</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span> <span class="token operator">===</span> <span class="token string">&#39;￥ 100&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">  <span class="token function">it</span><span class="token punctuation">(</span><span class="token string">&#39;should US Dolar&#39;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">const</span> ctx <span class="token operator">=</span> app<span class="token punctuation">.</span><span class="token function">mockContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token function">assert</span><span class="token punctuation">(</span>ctx<span class="token punctuation">.</span>helper<span class="token punctuation">.</span><span class="token function">money</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span> <span class="token operator">===</span> <span class="token string">&#39;$ 100&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_15-4-4-测试计划任务" tabindex="-1"><a class="header-anchor" href="#_15-4-4-测试计划任务"><span>15.4.4 测试计划任务</span></a></h4><ul><li>我们可以通过 <code>app.runSchedule(schedulePath)</code> 来运行一个定时任务</li><li><code>app.runSchedule</code> 接受一个定时任务文件路径<code>（app/schedule 目录下的相对路径或者完整的绝对路径）</code>，执行对应的定时任务，返回一个 <code>Promise</code></li></ul><p>update_cache.test.js</p><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code class="language-javascript"><span class="line"><span class="token keyword">const</span> mock <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&#39;egg-mock&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">const</span> assert <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&#39;assert&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token function">it</span><span class="token punctuation">(</span><span class="token string">&#39;should schedule work fine&#39;</span><span class="token punctuation">,</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></span>
<span class="line">  <span class="token keyword">const</span> app <span class="token operator">=</span> mock<span class="token punctuation">.</span><span class="token function">app</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">  <span class="token keyword">await</span> app<span class="token punctuation">.</span><span class="token function">ready</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">  <span class="token keyword">await</span> app<span class="token punctuation">.</span><span class="token function">runSchedule</span><span class="token punctuation">(</span><span class="token string">&#39;update_cache&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">  <span class="token function">assert</span><span class="token punctuation">(</span>app<span class="token punctuation">.</span>cache<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="_16-布署" tabindex="-1"><a class="header-anchor" href="#_16-布署"><span>16. 布署</span></a></h2><ul><li>框架内置了 egg-cluster 来启动 Master 进程，Master 有足够的稳定性，不再需要使用 pm2 等进程守护模块。</li><li>框架也提供了 egg-scripts 来支持线上环境的运行和停止</li></ul><h3 id="_16-1-安装工具" tabindex="-1"><a class="header-anchor" href="#_16-1-安装工具"><span>16.1 安装工具</span></a></h3><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text"><pre><code class="language-text"><span class="line">$ npm i egg-scripts --save</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><h3 id="_16-2-添加npm-scripts" tabindex="-1"><a class="header-anchor" href="#_16-2-添加npm-scripts"><span>16.2 添加npm scripts</span></a></h3><p>添加 npm scripts 到 package.json：</p><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code class="language-javascript"><span class="line"><span class="token punctuation">{</span></span>
<span class="line">  <span class="token string-property property">&quot;scripts&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token string-property property">&quot;start&quot;</span><span class="token operator">:</span> <span class="token string">&quot;egg-scripts start --daemon&quot;</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token string-property property">&quot;stop&quot;</span><span class="token operator">:</span> <span class="token string">&quot;egg-scripts stop&quot;</span></span>
<span class="line">  <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="_17-使用-vscode-进行调试" tabindex="-1"><a class="header-anchor" href="#_17-使用-vscode-进行调试"><span>17.使用 VSCode 进行调试</span></a></h2><ul><li>[使用-egg-bin-调试](https://eggjs.org/zh-cn/core/development.html</li><li>方式一：开启 VSCode 配置 Debug: Toggle Auto Attach，然后在 Terminal 执行 npm run debug 即可。</li><li>方式二：配置 VSCode 的 .vscode/launch.json，然后 F5 一键启动即可。（注意，需要关闭方式一中的配置）</li></ul><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code class="language-javascript"><span class="line"><span class="token comment">// .vscode/launch.json</span></span>
<span class="line"><span class="token punctuation">{</span></span>
<span class="line">  <span class="token string-property property">&quot;version&quot;</span><span class="token operator">:</span> <span class="token string">&quot;0.2.0&quot;</span><span class="token punctuation">,</span></span>
<span class="line">  <span class="token string-property property">&quot;configurations&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span></span>
<span class="line">    <span class="token punctuation">{</span></span>
<span class="line">      <span class="token string-property property">&quot;name&quot;</span><span class="token operator">:</span> <span class="token string">&quot;Launch Egg&quot;</span><span class="token punctuation">,</span></span>
<span class="line">      <span class="token string-property property">&quot;type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;node&quot;</span><span class="token punctuation">,</span></span>
<span class="line">      <span class="token string-property property">&quot;request&quot;</span><span class="token operator">:</span> <span class="token string">&quot;launch&quot;</span><span class="token punctuation">,</span></span>
<span class="line">      <span class="token string-property property">&quot;cwd&quot;</span><span class="token operator">:</span> <span class="token string">&quot;\${workspaceRoot}&quot;</span><span class="token punctuation">,</span></span>
<span class="line">      <span class="token string-property property">&quot;runtimeExecutable&quot;</span><span class="token operator">:</span> <span class="token string">&quot;npm&quot;</span><span class="token punctuation">,</span></span>
<span class="line">      <span class="token string-property property">&quot;windows&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token string-property property">&quot;runtimeExecutable&quot;</span><span class="token operator">:</span> <span class="token string">&quot;npm.cmd&quot;</span> <span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">      <span class="token string-property property">&quot;runtimeArgs&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span> <span class="token string">&quot;run&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;debug&quot;</span> <span class="token punctuation">]</span><span class="token punctuation">,</span></span>
<span class="line">      <span class="token string-property property">&quot;console&quot;</span><span class="token operator">:</span> <span class="token string">&quot;integratedTerminal&quot;</span><span class="token punctuation">,</span></span>
<span class="line">      <span class="token string-property property">&quot;protocol&quot;</span><span class="token operator">:</span> <span class="token string">&quot;auto&quot;</span><span class="token punctuation">,</span></span>
<span class="line">      <span class="token string-property property">&quot;restart&quot;</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span></span>
<span class="line">      <span class="token string-property property">&quot;port&quot;</span><span class="token operator">:</span> <span class="token number">9229</span><span class="token punctuation">,</span></span>
<span class="line">      <span class="token string-property property">&quot;autoAttachChildProcesses&quot;</span><span class="token operator">:</span> <span class="token boolean">true</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">  <span class="token punctuation">]</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="_18-参考" tabindex="-1"><a class="header-anchor" href="#_18-参考"><span>18.参考</span></a></h2><ul><li><a href="https://github.com/eggjs/egg-view-nunjucks" target="_blank" rel="noopener noreferrer">egg-view-nunjucks</a></li><li><a href="https://github.com/atian25/blog/issues/25" target="_blank" rel="noopener noreferrer">egg-debug</a></li><li><a href="https://www.easy-mock.com/docs" target="_blank" rel="noopener noreferrer">easy-mock</a></li><li><a href="https://github.com/nuysoft/Mock/wiki/Syntax-Specification" target="_blank" rel="noopener noreferrer">Mock</a></li></ul>`,290)])])}const i=n(t,[["render",l]]),u=JSON.parse('{"path":"/strong/30.cms-6-egg.html","title":"","lang":"en-US","frontmatter":{},"git":{"updatedTime":1681290319000,"contributors":[{"name":"yutao","username":"yutao","email":"642231346@qq.com","commits":1,"url":"https://github.com/yutao"}],"changelog":[{"hash":"f5ab8c9d34991ec274f7f652439afe5b2afb6147","time":1681290319000,"email":"642231346@qq.com","author":"yutao","message":"modify"}]},"filePathRelative":"strong/30.cms-6-egg.md"}');export{i as comp,u as data};
