import{_ as s,c as a,a as t,o as e}from"./app-CD1YpnS1.js";const l={};function i(p,n){return e(),a("div",null,[...n[0]||(n[0]=[t(`<h2 id="_1-nginx" tabindex="-1"><a class="header-anchor" href="#_1-nginx"><span>1. nginx</span></a></h2><p>nginx是一个开源且高性能、可靠的HTTP中间件和代理服务器</p><h2 id="_2-学习环境" tabindex="-1"><a class="header-anchor" href="#_2-学习环境"><span>2. 学习环境</span></a></h2><h3 id="_2-1-操作系统" tabindex="-1"><a class="header-anchor" href="#_2-1-操作系统"><span>2.1 操作系统</span></a></h3><p>CENTOS&gt;=7.0,位数 X64 CENTOS 7.2</p><h3 id="_2-2-环境确认" tabindex="-1"><a class="header-anchor" href="#_2-2-环境确认"><span>2.2 环境确认</span></a></h3><h4 id="_2-2-1-关闭-iptables" tabindex="-1"><a class="header-anchor" href="#_2-2-1-关闭-iptables"><span>2.2.1 关闭 iptables</span></a></h4><p>iptables命令是Linux上常用的防火墙软件</p><table><thead><tr><th style="text-align:left;">功能</th><th style="text-align:left;">命令</th></tr></thead><tbody><tr><td style="text-align:left;">停止防火墙</td><td style="text-align:left;">systemctl stop firewalld.service</td></tr><tr><td style="text-align:left;">永久关闭防火墙</td><td style="text-align:left;">systemctl disable firewalld.service</td></tr></tbody></table><h4 id="_2-2-2-确认停用-selinux" tabindex="-1"><a class="header-anchor" href="#_2-2-2-确认停用-selinux"><span>2.2.2 确认停用 selinux</span></a></h4><ul><li>安全增强型 Linux（Security-Enhanced Linux）简称 SELinux，它是一个 Linux 内核模块，也是 Linux 的一个安全子系统。</li><li>SELinux 主要作用就是最大限度地减小系统中服务进程可访问的资源（最小权限原则）。</li></ul><table><thead><tr><th style="text-align:left;">功能</th><th style="text-align:left;">命令</th></tr></thead><tbody><tr><td style="text-align:left;">检查状态</td><td style="text-align:left;">getenforce</td></tr><tr><td style="text-align:left;">检查状态</td><td style="text-align:left;">/usr/sbin/sestatus -v</td></tr><tr><td style="text-align:left;">临时关闭</td><td style="text-align:left;">setenforce 0</td></tr><tr><td style="text-align:left;">永久关闭</td><td style="text-align:left;">/etc/selinux/config SELINUX=enforcing改为SELINUX=disabled</td></tr></tbody></table><h4 id="_2-2-3-安装依赖模块" tabindex="-1"><a class="header-anchor" href="#_2-2-3-安装依赖模块"><span>2.2.3 安装依赖模块</span></a></h4><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text"><pre><code class="language-text"><span class="line">yum  -y install gcc gcc-c++ autoconf pcre pcre-devel make automake</span>
<span class="line">yum  -y install wget httpd-tools vim</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="_3-nginx的优势" tabindex="-1"><a class="header-anchor" href="#_3-nginx的优势"><span>3. nginx的优势</span></a></h2><ul><li>IO多路复用 多个描述符的IO操作都能在一个线程里并发交替顺序完成，复用线程 <ul><li>select 线性遍历文件描述符列表 1. 效率低下 2.最多只能有1024</li><li>epoll 每当fd就绪，采用系统回调函数将fd放入 1.效率高 2.没有1024限制</li></ul></li><li>CPU亲和 一种把CPU核心和Nginx工作进程绑定方式，把每个worker进程固定在一个CPU上执行，减少切换CPU和提交缓存命中率,获得更好的性能。</li><li>sendfile 零拷贝传输模式 ![usercore]</li></ul><p><img src="http://img.zhufengpeixun.cn/usercore.jpg" alt="usercore"></p><h2 id="_4-nginx安装" tabindex="-1"><a class="header-anchor" href="#_4-nginx安装"><span>4. nginx安装</span></a></h2><h3 id="_4-1-版本分类" tabindex="-1"><a class="header-anchor" href="#_4-1-版本分类"><span>4.1 版本分类</span></a></h3><ul><li>Mainline version 开发版</li><li>Stable version 稳定版</li><li>Legacy versions 历史版本</li></ul><h3 id="_4-2-下载地址" tabindex="-1"><a class="header-anchor" href="#_4-2-下载地址"><span>4.2 下载地址</span></a></h3><ul><li><a href="http://nginx.org/en/download.html" target="_blank" rel="noopener noreferrer">nginx</a></li><li>[linux_packages](http://nginx.org/en/linux_packages.html</li></ul><h3 id="_4-3-centos下yum安装" tabindex="-1"><a class="header-anchor" href="#_4-3-centos下yum安装"><span>4.3 CentOS下YUM安装</span></a></h3><p>/etc/yum.repos.d/nginx.repo</p><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code class="language-javascript"><span class="line"><span class="token punctuation">[</span>nginx<span class="token punctuation">]</span></span>
<span class="line">name<span class="token operator">=</span>nginx repo</span>
<span class="line">baseurl<span class="token operator">=</span>http<span class="token operator">:</span><span class="token operator">/</span><span class="token operator">/</span>nginx<span class="token punctuation">.</span>org<span class="token operator">/</span>packages<span class="token operator">/</span>centos<span class="token operator">/</span><span class="token number">7</span><span class="token operator">/</span>$basearch<span class="token operator">/</span></span>
<span class="line">gpgcheck<span class="token operator">=</span><span class="token number">0</span></span>
<span class="line">enabled<span class="token operator">=</span><span class="token number">1</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text"><pre><code class="language-text"><span class="line">yum install nginx -y</span>
<span class="line">nginx -v</span>
<span class="line">nginx -V</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="_5-目录" tabindex="-1"><a class="header-anchor" href="#_5-目录"><span>5. 目录</span></a></h2><h3 id="_5-1-安装目录" tabindex="-1"><a class="header-anchor" href="#_5-1-安装目录"><span>5.1 安装目录</span></a></h3><p>查看配置文件和目录</p><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text"><pre><code class="language-text"><span class="line">rpm -ql nginx</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><h3 id="_5-2-配置文件" tabindex="-1"><a class="header-anchor" href="#_5-2-配置文件"><span>5.2 配置文件</span></a></h3><table><thead><tr><th style="text-align:left;">类型</th><th style="text-align:left;">路径</th><th style="text-align:left;">用途</th></tr></thead><tbody><tr><td style="text-align:left;">配置文件</td><td style="text-align:left;">/etc/logrotate.d/nginx</td><td style="text-align:left;">用于logrotate服务的日志切割</td></tr><tr><td style="text-align:left;">配置文件</td><td style="text-align:left;">/etc/nginx /etc/nginx/nginx.conf /etc/nginx/conf.d /etc/nginx/conf.d/default.conf</td><td style="text-align:left;">主配置文件</td></tr><tr><td style="text-align:left;">配置文件</td><td style="text-align:left;">/etc/nginx/fastcgi_params /etc/nginx/scgi_params /etc/nginx/uwsgi_params</td><td style="text-align:left;">cgi配置,fastcgi配置</td></tr><tr><td style="text-align:left;">配置文件</td><td style="text-align:left;">/etc/nginx/koi-utf /etc/nginx/koi-win /etc/nginx/win-utf</td><td style="text-align:left;">编码转换映射转化文件</td></tr><tr><td style="text-align:left;">配置文件</td><td style="text-align:left;">/etc/nginx/mime.types</td><td style="text-align:left;">设置http协议的Content-Type与扩展名对应关系</td></tr><tr><td style="text-align:left;">配置文件</td><td style="text-align:left;">/usr/lib/systemd/system/nginx-debug.service /usr/lib/systemd/system/nginx.service /etc/sysconfig/nginx /etc/sysconfig/nginx-debug</td><td style="text-align:left;">用于配置系统守护进程管理器管理方式</td></tr><tr><td style="text-align:left;">配置文件</td><td style="text-align:left;">/etc/nginx/modules /usr/lib64/nginx/modules</td><td style="text-align:left;">nginx模块目录</td></tr><tr><td style="text-align:left;">命令</td><td style="text-align:left;">/usr/share/doc/nginx-1.14.0 /usr/share/doc/nginx-1.14.0/COPYRIGHT</td><td style="text-align:left;">nginx的手册和帮助文件</td></tr><tr><td style="text-align:left;">目录</td><td style="text-align:left;">/var/cache/nginx</td><td style="text-align:left;">nginx的缓存目录</td></tr><tr><td style="text-align:left;">目录</td><td style="text-align:left;">/var/log/nginx</td><td style="text-align:left;">nginx的日志目录</td></tr></tbody></table><h2 id="_5-3-编译参数" tabindex="-1"><a class="header-anchor" href="#_5-3-编译参数"><span>5.3 编译参数</span></a></h2><h3 id="_5-3-1-安装目录和路径" tabindex="-1"><a class="header-anchor" href="#_5-3-1-安装目录和路径"><span>5.3.1 安装目录和路径</span></a></h3><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text"><pre><code class="language-text"><span class="line">--prefix=/etc/nginx </span>
<span class="line">--sbin-path=/usr/sbin/nginx </span>
<span class="line">--modules-path=/usr/lib64/nginx/modules </span>
<span class="line">--conf-path=/etc/nginx/nginx.conf </span>
<span class="line">--error-log-path=/var/log/nginx/error.log </span>
<span class="line">--http-log-path=/var/log/nginx/access.log </span>
<span class="line">--pid-path=/var/run/nginx.pid </span>
<span class="line">--lock-path=/var/run/nginx.lock </span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_5-3-2-执行对应模块时-nginx所保留的临时性文件" tabindex="-1"><a class="header-anchor" href="#_5-3-2-执行对应模块时-nginx所保留的临时性文件"><span>5.3.2 执行对应模块时，nginx所保留的临时性文件</span></a></h3><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text"><pre><code class="language-text"><span class="line">--http-client-body-temp-path=/var/cache/nginx/client_temp </span>
<span class="line">--http-proxy-temp-path=/var/cache/nginx/proxy_temp </span>
<span class="line">--http-fastcgi-temp-path=/var/cache/nginx/fastcgi_temp </span>
<span class="line">--http-uwsgi-temp-path=/var/cache/nginx/uwsgi_temp </span>
<span class="line">--http-scgi-temp-path=/var/cache/nginx/scgi_temp </span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_5-3-3-设置nginx进程启动的用户和用户组" tabindex="-1"><a class="header-anchor" href="#_5-3-3-设置nginx进程启动的用户和用户组"><span>5.3.3 设置nginx进程启动的用户和用户组</span></a></h3><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text"><pre><code class="language-text"><span class="line">--user=nginx </span>
<span class="line">--group=nginx </span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_5-3-4-设置额外的参数将被添加到cflags变量" tabindex="-1"><a class="header-anchor" href="#_5-3-4-设置额外的参数将被添加到cflags变量"><span>5.3.4 设置额外的参数将被添加到CFLAGS变量</span></a></h3><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text"><pre><code class="language-text"><span class="line">--with-cc-opt=&#39;-O2 -g -pipe -Wall -Wp,-D_FORTIFY_SOURCE=2 -fexceptions -fstack-protector-strong </span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><h3 id="_5-3-5-设置附加的参数-链接系统库" tabindex="-1"><a class="header-anchor" href="#_5-3-5-设置附加的参数-链接系统库"><span>5.3.5 设置附加的参数，链接系统库</span></a></h3><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code class="language-javascript"><span class="line"><span class="token operator">--</span><span class="token keyword">with</span><span class="token operator">-</span>ld<span class="token operator">-</span>opt<span class="token operator">=</span><span class="token string">&#39;-Wl,-z,relro -Wl,-z,now -pie&#39;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><h3 id="_5-3-6-其它参数" tabindex="-1"><a class="header-anchor" href="#_5-3-6-其它参数"><span>5.3.6 其它参数</span></a></h3><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text"><pre><code class="language-text"><span class="line">--with-compat </span>
<span class="line">--with-file-aio </span>
<span class="line">--with-threads </span>
<span class="line">--with-http_addition_module </span>
<span class="line">--with-http_auth_request_module </span>
<span class="line">--with-http_dav_module </span>
<span class="line">--with-http_flv_module </span>
<span class="line">--with-http_gunzip_module </span>
<span class="line">--with-http_gzip_static_module </span>
<span class="line">--with-http_mp4_module </span>
<span class="line">--with-http_random_index_module </span>
<span class="line">--with-http_realip_module </span>
<span class="line">--with-http_secure_link_module </span>
<span class="line">--with-http_slice_module </span>
<span class="line">--with-http_ssl_module </span>
<span class="line">--with-http_stub_status_module </span>
<span class="line">--with-http_sub_module </span>
<span class="line">--with-http_v2_module </span>
<span class="line">--with-mail </span>
<span class="line">--with-mail_ssl_module </span>
<span class="line">--with-stream </span>
<span class="line">--with-stream_realip_module </span>
<span class="line">--with-stream_ssl_module </span>
<span class="line">--with-stream_ssl_preread_module </span>
<span class="line">--param=ssp-buffer-size=4 -grecord-gcc-switches -m64 -mtune=generic -fPIC&#39; </span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="_5-配置文件" tabindex="-1"><a class="header-anchor" href="#_5-配置文件"><span>5. 配置文件</span></a></h2><ul><li>/etc/nginx/nginx.conf</li><li>/etc/nginx/conf.d/*.conf /etc/nginx/conf.d/default.conf</li></ul><h3 id="_5-1-全局和服务配置" tabindex="-1"><a class="header-anchor" href="#_5-1-全局和服务配置"><span>5.1 全局和服务配置</span></a></h3><table><thead><tr><th style="text-align:left;">分类</th><th style="text-align:left;">配置项</th><th style="text-align:left;">作用</th></tr></thead><tbody><tr><td style="text-align:left;">全局</td><td style="text-align:left;">user</td><td style="text-align:left;">设置nginx服务的系统使用用户</td></tr><tr><td style="text-align:left;">全局</td><td style="text-align:left;">worker_processes</td><td style="text-align:left;">工作进程数,一般和CPU数量相同</td></tr><tr><td style="text-align:left;">全局</td><td style="text-align:left;">error_log</td><td style="text-align:left;">nginx的错误日志</td></tr><tr><td style="text-align:left;">全局</td><td style="text-align:left;">pid</td><td style="text-align:left;">nginx服务启动时的pid</td></tr></tbody></table><h3 id="_5-2-全局和服务配置" tabindex="-1"><a class="header-anchor" href="#_5-2-全局和服务配置"><span>5.2 全局和服务配置</span></a></h3><table><thead><tr><th style="text-align:left;">分类</th><th style="text-align:left;">配置项</th><th style="text-align:left;">作用</th></tr></thead><tbody><tr><td style="text-align:left;">events</td><td style="text-align:left;">worker_connections</td><td style="text-align:left;">每个进程允许的最大连接数 10000</td></tr><tr><td style="text-align:left;">events</td><td style="text-align:left;">use</td><td style="text-align:left;">指定使用哪种模型（select/poll/epoll）,建议让nginx自动选择,linux内核2.6以上一般能使用epoll，提高性能。</td></tr></tbody></table><p>/etc/nginx/nginx.conf</p><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text"><pre><code class="language-text"><span class="line">user  nginx;   设置nginx服务的系统使用用户  </span>
<span class="line">worker_processes  1;  工作进程数,一般和CPU数量相同 </span>
<span class="line"></span>
<span class="line">error_log  /var/log/nginx/error.log warn;   nginx的错误日志  </span>
<span class="line">pid        /var/run/nginx.pid;   nginx服务启动时的pid</span>
<span class="line"></span>
<span class="line">events {</span>
<span class="line">    worker_connections  1024;每个进程允许的最大连接数 10000</span>
<span class="line">}</span>
<span class="line"></span>
<span class="line">http {</span>
<span class="line">    include       /etc/nginx/mime.types;//文件后缀和类型类型的对应关系</span>
<span class="line">    default_type  application/octet-stream;//默认content-type</span>
<span class="line"></span>
<span class="line">    log_format  main  &#39;$remote_addr - $remote_user [$time_local] &quot;$request&quot; &#39;</span>
<span class="line">                      &#39;$status $body_bytes_sent &quot;$http_referer&quot; &#39;</span>
<span class="line">                      &#39;&quot;$http_user_agent&quot; &quot;$http_x_forwarded_for&quot;&#39;;  //日志记录格式</span>
<span class="line"></span>
<span class="line">    access_log  /var/log/nginx/access.log  main;//默认访问日志</span>
<span class="line"></span>
<span class="line">    sendfile        on;//启用sendfile</span>
<span class="line">     </span>
<span class="line"></span>
<span class="line">    keepalive_timeout  65;//超时时间是65秒</span>
<span class="line"></span>
<span class="line">     </span>
<span class="line"></span>
<span class="line">    include /etc/nginx/conf.d/*.conf;//包含的子配置文件</span>
<span class="line">}</span>
<span class="line"></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>default.conf</p><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text"><pre><code class="language-text"><span class="line">server {</span>
<span class="line">    listen       80;  //监听的端口号</span>
<span class="line">    server_name  localhost;  //用域名方式访问的地址</span>
<span class="line"></span>
<span class="line">     </span>
<span class="line">     </span>
<span class="line"></span>
<span class="line">    location / {</span>
<span class="line">        root   /usr/share/nginx/html;  //静态文件根目录</span>
<span class="line">        index  index.html index.htm;  //首页的索引文件</span>
<span class="line">    }</span>
<span class="line"></span>
<span class="line">     </span>
<span class="line"></span>
<span class="line">     </span>
<span class="line">     </span>
<span class="line">    error_page   500 502 503 504  /50x.html; </span>
<span class="line">    location = /50x.html {</span>
<span class="line">        root   /usr/share/nginx/html;</span>
<span class="line">    }</span>
<span class="line"></span>
<span class="line">     </span>
<span class="line">     </span>
<span class="line">     </span>
<span class="line">     </span>
<span class="line">     </span>
<span class="line"></span>
<span class="line">     </span>
<span class="line">     </span>
<span class="line">     </span>
<span class="line">     </span>
<span class="line">     </span>
<span class="line">     </span>
<span class="line">     </span>
<span class="line">     </span>
<span class="line">     </span>
<span class="line"></span>
<span class="line">     </span>
<span class="line">     </span>
<span class="line">     </span>
<span class="line">     </span>
<span class="line">     </span>
<span class="line">     </span>
<span class="line">}</span>
<span class="line"></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="_6-启动和重新加载" tabindex="-1"><a class="header-anchor" href="#_6-启动和重新加载"><span>6. 启动和重新加载</span></a></h2><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text"><pre><code class="language-text"><span class="line">systemctl restart nginx.service</span>
<span class="line">systemctl reload nginx.service</span>
<span class="line">nginx -s reload</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="_7-日志类型" tabindex="-1"><a class="header-anchor" href="#_7-日志类型"><span>7. 日志类型</span></a></h2><h3 id="_7-1-日志类型" tabindex="-1"><a class="header-anchor" href="#_7-1-日志类型"><span>7.1 日志类型</span></a></h3><ul><li>access_.log 访问日志</li><li>error.log 错误日志</li></ul><h3 id="_7-2-log-format" tabindex="-1"><a class="header-anchor" href="#_7-2-log-format"><span>7.2 log_format</span></a></h3><table><thead><tr><th style="text-align:left;">类型</th><th style="text-align:left;">用法</th></tr></thead><tbody><tr><td style="text-align:left;">语法</td><td style="text-align:left;">log_format name [escape=default[json] string]</td></tr><tr><td style="text-align:left;">默认</td><td style="text-align:left;">log_format combined ...</td></tr><tr><td style="text-align:left;">Context</td><td style="text-align:left;">http</td></tr></tbody></table><p>案例</p><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code class="language-javascript"><span class="line"> log_format  main  <span class="token string">&#39;$remote_addr - $remote_user [$time_local] &quot;$request&quot; &#39;</span></span>
<span class="line">                      <span class="token string">&#39;$status $body_bytes_sent &quot;$http_referer&quot; &#39;</span></span>
<span class="line">                      <span class="token string">&#39;&quot;$http_user_agent&quot; &quot;$http_x_forwarded_for&quot;&#39;</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"> log_format  zfpx  <span class="token string">&#39;$arg_name $http_referer sent_http_date&quot;&#39;</span><span class="token punctuation">;</span></span>
<span class="line"> access_log  <span class="token operator">/</span><span class="token keyword">var</span><span class="token operator">/</span>log<span class="token operator">/</span>nginx<span class="token operator">/</span>access<span class="token punctuation">.</span>log  main<span class="token punctuation">;</span>    </span>
<span class="line"></span>
<span class="line"> <span class="token number">221.216</span><span class="token number">.143</span><span class="token number">.110</span> <span class="token operator">-</span> <span class="token operator">-</span> <span class="token punctuation">[</span><span class="token number">09</span><span class="token operator">/</span>Jun<span class="token operator">/</span><span class="token number">2018</span><span class="token operator">:</span><span class="token number">22</span><span class="token operator">:</span><span class="token number">41</span><span class="token operator">:</span><span class="token number">18</span> <span class="token operator">+</span><span class="token number">0800</span><span class="token punctuation">]</span> <span class="token string">&quot;GET / HTTP/1.1&quot;</span> <span class="token number">200</span> <span class="token number">612</span> <span class="token string">&quot;-&quot;</span> <span class="token string">&quot;Mozilla/5.0 (Windows NT 6.1; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/62.0.3202.94 Safari/537.36&quot;</span> <span class="token string">&quot;-&quot;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_7-3-http请求变量" tabindex="-1"><a class="header-anchor" href="#_7-3-http请求变量"><span>7.3 HTTP请求变量</span></a></h3><table><thead><tr><th style="text-align:left;">名称</th><th style="text-align:left;">含义</th><th style="text-align:left;">例子</th></tr></thead><tbody><tr><td style="text-align:left;">arg_PARAMETER</td><td style="text-align:left;">请求参数</td><td style="text-align:left;">$arg_name</td></tr><tr><td style="text-align:left;">http_HEADER</td><td style="text-align:left;">请求头</td><td style="text-align:left;">$http_referer</td></tr><tr><td style="text-align:left;">sent_http_HEADER</td><td style="text-align:left;">响应头</td><td style="text-align:left;">sent_http_cookie</td></tr></tbody></table><h3 id="_7-4-内置变量" tabindex="-1"><a class="header-anchor" href="#_7-4-内置变量"><span>7.4 内置变量</span></a></h3><p><a href="http://nginx.org/en/docs/http/ngx_http_log_module.html" target="_blank" rel="noopener noreferrer">ngx_http_log_module</a> [log_format](http://nginx.org/en/docs/http/ngx_http_log_module.html</p><table><thead><tr><th style="text-align:left;">名称</th><th style="text-align:left;">含义</th></tr></thead><tbody><tr><td style="text-align:left;">$remote_addr</td><td style="text-align:left;">客户端地址</td></tr><tr><td style="text-align:left;">$remote_user</td><td style="text-align:left;">客户端用户名称</td></tr><tr><td style="text-align:left;">$time_local</td><td style="text-align:left;">访问时间和时区</td></tr><tr><td style="text-align:left;">$request</td><td style="text-align:left;">请求的URI和HTTP协议</td></tr><tr><td style="text-align:left;">$http_host</td><td style="text-align:left;">请求地址，即浏览器中你输入的地址（IP或域名）</td></tr><tr><td style="text-align:left;">$status</td><td style="text-align:left;">HTTP请求状态</td></tr><tr><td style="text-align:left;">$body_bytes_sent</td><td style="text-align:left;">发送给客户端文件内容大小</td></tr></tbody></table><h2 id="_8-nginx实战" tabindex="-1"><a class="header-anchor" href="#_8-nginx实战"><span>8. nginx实战</span></a></h2><h3 id="_8-1-静态资源web服务" tabindex="-1"><a class="header-anchor" href="#_8-1-静态资源web服务"><span>8.1 静态资源Web服务</span></a></h3><ul><li>静态资源：一般客户端发送请求到web服务器，web服务器从内存在取到相应的文件，返回给客户端，客户端解析并渲染显示出来。</li><li>动态资源：一般客户端请求的动态资源，先将请求交于web容器，web容器连接数据库，数据库处理数据之后，将内容交给web服务器，web服务器返回给客户端解析渲染处理。</li></ul><table><thead><tr><th style="text-align:left;">类型</th><th style="text-align:left;">种类</th></tr></thead><tbody><tr><td style="text-align:left;">浏览器渲染</td><td style="text-align:left;">HTML、CSS、JS</td></tr><tr><td style="text-align:left;">图片</td><td style="text-align:left;">JPEG、GIF、PNG</td></tr><tr><td style="text-align:left;">视频</td><td style="text-align:left;">FLV、MPEG</td></tr><tr><td style="text-align:left;">下载文件</td><td style="text-align:left;">Word、Excel</td></tr></tbody></table><h3 id="_8-2-cdn" tabindex="-1"><a class="header-anchor" href="#_8-2-cdn"><span>8.2 CDN</span></a></h3><ul><li>CDN的全称是Content Delivery Network，即内容分发网络。</li><li>CDN系统能够实时地根据网络流量和各节点的连接、负载状况以及到用户的距离和响应时间等综合信息将用户的请求重新导向离用户最近的服务节点上。其目的是使用户可就近取得所需内容，解决 Internet网络拥挤的状况，提高用户访问网站的响应速度。</li></ul><p><a href="http://img.zhufengpeixun.cn/cdn.jpg" target="_blank" rel="noopener noreferrer">cdn</a></p><h4 id="_8-2-1-配置语法" tabindex="-1"><a class="header-anchor" href="#_8-2-1-配置语法"><span>8.2.1 配置语法</span></a></h4><h5 id="_8-2-1-1-sendfile" tabindex="-1"><a class="header-anchor" href="#_8-2-1-1-sendfile"><span>8.2.1.1 sendfile</span></a></h5><p>不经过用户内核发送文件</p><table><thead><tr><th style="text-align:left;">类型</th><th style="text-align:left;">种类</th></tr></thead><tbody><tr><td style="text-align:left;">语法</td><td style="text-align:left;">sendfile on / off</td></tr><tr><td style="text-align:left;">默认</td><td style="text-align:left;">sendfile off;</td></tr><tr><td style="text-align:left;">上下文</td><td style="text-align:left;">http,server,location,if in location</td></tr></tbody></table><h5 id="_8-2-1-2-tcp-nopush" tabindex="-1"><a class="header-anchor" href="#_8-2-1-2-tcp-nopush"><span>8.2.1.2 tcp_nopush</span></a></h5><p>在sendfile开启的情况 下，提高网络包的传输效率</p><table><thead><tr><th style="text-align:left;">类型</th><th style="text-align:left;">种类</th></tr></thead><tbody><tr><td style="text-align:left;">语法</td><td style="text-align:left;">tcp_nopush on / off</td></tr><tr><td style="text-align:left;">默认</td><td style="text-align:left;">tcp_nopush off;</td></tr><tr><td style="text-align:left;">上下文</td><td style="text-align:left;">http,server,location</td></tr></tbody></table><h5 id="_8-2-1-2-tcp-nodelay" tabindex="-1"><a class="header-anchor" href="#_8-2-1-2-tcp-nodelay"><span>8.2.1.2 tcp_nodelay</span></a></h5><p>在keepalive连接下，提高网络包的传输实时性</p><table><thead><tr><th style="text-align:left;">类型</th><th style="text-align:left;">种类</th></tr></thead><tbody><tr><td style="text-align:left;">语法</td><td style="text-align:left;">tcp_nodelay on / off</td></tr><tr><td style="text-align:left;">默认</td><td style="text-align:left;">tcp_nodelay on;</td></tr><tr><td style="text-align:left;">上下文</td><td style="text-align:left;">http,server,location</td></tr></tbody></table><h5 id="_8-2-1-3-gzip" tabindex="-1"><a class="header-anchor" href="#_8-2-1-3-gzip"><span>8.2.1.3 gzip</span></a></h5><p>压缩文件可以节约带宽和提高网络传输效率</p><table><thead><tr><th style="text-align:left;">类型</th><th style="text-align:left;">种类</th></tr></thead><tbody><tr><td style="text-align:left;">语法</td><td style="text-align:left;">gzip on / off</td></tr><tr><td style="text-align:left;">默认</td><td style="text-align:left;">gzip off;</td></tr><tr><td style="text-align:left;">上下文</td><td style="text-align:left;">http,server,location</td></tr></tbody></table><h5 id="_8-2-1-4-gzip-comp-level" tabindex="-1"><a class="header-anchor" href="#_8-2-1-4-gzip-comp-level"><span>8.2.1.4 gzip_comp_level</span></a></h5><p>压缩比率越高，文件被压缩的体积越小</p><table><thead><tr><th style="text-align:left;">类型</th><th style="text-align:left;">种类</th></tr></thead><tbody><tr><td style="text-align:left;">语法</td><td style="text-align:left;">gzip_comp_level level</td></tr><tr><td style="text-align:left;">默认</td><td style="text-align:left;">gzip_comp_level 1;</td></tr><tr><td style="text-align:left;">上下文</td><td style="text-align:left;">http,server,location</td></tr></tbody></table><h5 id="_8-2-1-5-gzip-http-version" tabindex="-1"><a class="header-anchor" href="#_8-2-1-5-gzip-http-version"><span>8.2.1.5 gzip_http_version</span></a></h5><p>压缩HTTP版本</p><table><thead><tr><th style="text-align:left;">类型</th><th style="text-align:left;">种类</th></tr></thead><tbody><tr><td style="text-align:left;">语法</td><td style="text-align:left;">gzip_http_version 1.0/1.1</td></tr><tr><td style="text-align:left;">默认</td><td style="text-align:left;">gzip_http_version 1.1;</td></tr><tr><td style="text-align:left;">上下文</td><td style="text-align:left;">http,server,location</td></tr></tbody></table><h5 id="_8-2-1-6-http-gzip-static-module" tabindex="-1"><a class="header-anchor" href="#_8-2-1-6-http-gzip-static-module"><span>8.2.1.6 http_gzip-static_module</span></a></h5><p>先找磁盘上找同名的<code>.gz</code>这个文件是否存在,节约CPU的压缩时间和性能损耗</p><table><thead><tr><th style="text-align:left;">类型</th><th style="text-align:left;">种类</th></tr></thead><tbody><tr><td style="text-align:left;">语法</td><td style="text-align:left;">gzip_static on/off</td></tr><tr><td style="text-align:left;">默认</td><td style="text-align:left;">gzip_static off;</td></tr><tr><td style="text-align:left;">上下文</td><td style="text-align:left;">http,server,location</td></tr></tbody></table><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text"><pre><code class="language-text"><span class="line">location ~ .*\\.(jpg|png|gif)$ {</span>
<span class="line">        gzip off;</span>
<span class="line">        gzip_http_version 1.1;</span>
<span class="line">       gzip_comp_level 3;</span>
<span class="line">       gzip_types image/jpeg image/png image/gif;</span>
<span class="line">        root /data/images;</span>
<span class="line">    }</span>
<span class="line"></span>
<span class="line">    location ~ .*\\.(html|js|css)$ {</span>
<span class="line">        gzip on;</span>
<span class="line">        gzip_min_length 1k;</span>
<span class="line">        gzip_http_version 1.1;</span>
<span class="line">        gzip_comp_level 9;</span>
<span class="line">        gzip_types  text/css application/javascript;</span>
<span class="line">        root /data/html;</span>
<span class="line">    }</span>
<span class="line"></span>
<span class="line">    location ~ ^/download {</span>
<span class="line">        gzip_static on;</span>
<span class="line">        tcp_nopush on; </span>
<span class="line">        root /data/download;</span>
<span class="line">    }</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_8-3-浏览器缓存" tabindex="-1"><a class="header-anchor" href="#_8-3-浏览器缓存"><span>8.3 浏览器缓存</span></a></h3><p>校验本地缓存是否过期</p><table><thead><tr><th style="text-align:left;">类型</th><th style="text-align:left;">种类</th></tr></thead><tbody><tr><td style="text-align:left;">检验是否过期</td><td style="text-align:left;">Expires、Cache-Control(max-age)</td></tr><tr><td style="text-align:left;">Etag</td><td style="text-align:left;">Etag</td></tr><tr><td style="text-align:left;">Last-Modified</td><td style="text-align:left;">Last-Modified</td></tr></tbody></table><h4 id="_8-3-1-expires" tabindex="-1"><a class="header-anchor" href="#_8-3-1-expires"><span>8.3.1 expires</span></a></h4><p>添加Cache-Control、Expires头</p><table><thead><tr><th style="text-align:left;">类型</th><th style="text-align:left;">种类</th></tr></thead><tbody><tr><td style="text-align:left;">语法</td><td style="text-align:left;">expires time</td></tr><tr><td style="text-align:left;">默认</td><td style="text-align:left;">expires off;</td></tr><tr><td style="text-align:left;">上下文</td><td style="text-align:left;">http,server,location</td></tr></tbody></table><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code class="language-javascript"><span class="line">location <span class="token operator">~</span> <span class="token punctuation">.</span><span class="token operator">*</span>\\<span class="token punctuation">.</span><span class="token punctuation">(</span>jpg<span class="token operator">|</span>png<span class="token operator">|</span>gif<span class="token punctuation">)</span>$ <span class="token punctuation">{</span></span>
<span class="line">        expires 24h<span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_8-4-跨域" tabindex="-1"><a class="header-anchor" href="#_8-4-跨域"><span>8.4 跨域</span></a></h3><table><thead><tr><th style="text-align:left;">类型</th><th style="text-align:left;">种类</th></tr></thead><tbody><tr><td style="text-align:left;">语法</td><td style="text-align:left;">add_header name value</td></tr><tr><td style="text-align:left;">默认</td><td style="text-align:left;">add_header --;</td></tr><tr><td style="text-align:left;">上下文</td><td style="text-align:left;">http,server,location</td></tr></tbody></table><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code class="language-javascript"><span class="line">location <span class="token operator">~</span> <span class="token punctuation">.</span><span class="token operator">*</span>\\<span class="token punctuation">.</span>json$ <span class="token punctuation">{</span></span>
<span class="line">        add_header Access<span class="token operator">-</span>Control<span class="token operator">-</span>Allow<span class="token operator">-</span>Origin http<span class="token operator">:</span><span class="token operator">/</span><span class="token operator">/</span>localhost<span class="token operator">:</span><span class="token number">3000</span><span class="token punctuation">;</span></span>
<span class="line">        add_header Access<span class="token operator">-</span>Control<span class="token operator">-</span>Allow<span class="token operator">-</span>Methods <span class="token constant">GET</span><span class="token punctuation">,</span><span class="token constant">POST</span><span class="token punctuation">,</span><span class="token constant">PUT</span><span class="token punctuation">,</span><span class="token constant">DELETE</span><span class="token punctuation">,</span><span class="token constant">OPTIONS</span><span class="token punctuation">;</span></span>
<span class="line">        root <span class="token operator">/</span>data<span class="token operator">/</span>json<span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code class="language-javascript"><span class="line"><span class="token keyword">let</span> xhr <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">XMLHttpRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        xhr<span class="token punctuation">.</span><span class="token function">open</span><span class="token punctuation">(</span><span class="token string">&#39;GET&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;http://47.104.184.134/users.json&#39;</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        xhr<span class="token punctuation">.</span><span class="token function-variable function">onreadystatechange</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token keyword">if</span> <span class="token punctuation">(</span>xhr<span class="token punctuation">.</span>readyState <span class="token operator">==</span> <span class="token number">4</span> <span class="token operator">&amp;&amp;</span> xhr<span class="token punctuation">.</span>status <span class="token operator">==</span> <span class="token number">200</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">                console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>xhr<span class="token punctuation">.</span>responseText<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">            <span class="token punctuation">}</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">xhr<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_8-5-防盗链" tabindex="-1"><a class="header-anchor" href="#_8-5-防盗链"><span>8.5 防盗链</span></a></h3><ul><li>防止网站资源被盗用</li><li>保证信息安全</li><li>防止流量过量</li><li>区别哪些请求是非正常的用户请求</li><li>使用http_refer防盗链</li></ul><table><thead><tr><th style="text-align:left;">类型</th><th style="text-align:left;">种类</th></tr></thead><tbody><tr><td style="text-align:left;">语法</td><td style="text-align:left;">valid_referers none</td></tr><tr><td style="text-align:left;">默认</td><td style="text-align:left;">-</td></tr><tr><td style="text-align:left;">上下文</td><td style="text-align:left;">server,location</td></tr></tbody></table><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text"><pre><code class="language-text"><span class="line">location ~ .*\\.(jpg|png|gif)$ {</span>
<span class="line">        expires 1h;</span>
<span class="line">        gzip off;</span>
<span class="line">        gzip_http_version 1.1;</span>
<span class="line">        gzip_comp_level 3;</span>
<span class="line">        gzip_types image/jpeg image/png image/gif;</span>
<span class="line">+        valid_referers none blocked 47.104.184.134;</span>
<span class="line">+        if ($invalid_referer) {</span>
<span class="line">+           return 403;</span>
<span class="line">+        }</span>
<span class="line">        root /data/images;</span>
<span class="line">    }</span>
<span class="line"></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_8-6-代理服务" tabindex="-1"><a class="header-anchor" href="#_8-6-代理服务"><span>8.6 代理服务</span></a></h3><h4 id="_8-6-1-配置" tabindex="-1"><a class="header-anchor" href="#_8-6-1-配置"><span>8.6.1 配置</span></a></h4><table><thead><tr><th style="text-align:left;">类型</th><th style="text-align:left;">种类</th></tr></thead><tbody><tr><td style="text-align:left;">语法</td><td style="text-align:left;">proxy_pass URL</td></tr><tr><td style="text-align:left;">默认</td><td style="text-align:left;">-</td></tr><tr><td style="text-align:left;">上下文</td><td style="text-align:left;">server,location</td></tr></tbody></table><h4 id="_8-6-2-反向代理" tabindex="-1"><a class="header-anchor" href="#_8-6-2-反向代理"><span>8.6.2 反向代理</span></a></h4><p>反向代理的对象的服务端 <img src="http://img.zhufengpeixun.cn/fanproxy.jpg" alt="fanproxy"></p><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text"><pre><code class="language-text"><span class="line">resolver 8.8.8.8;</span>
<span class="line">location ~ ^/api {</span>
<span class="line">      proxy_pass http://127.0.0.1:3000;</span>
<span class="line">}</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_8-6-3-正向代理" tabindex="-1"><a class="header-anchor" href="#_8-6-3-正向代理"><span>8.6.3 正向代理</span></a></h4><p>正向代理的对象是客户端 <img src="http://img.zhufengpeixun.cn/positiveproxy.jpg" alt="positiveproxy"></p><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code class="language-javascript"><span class="line">location <span class="token operator">/</span> <span class="token punctuation">{</span></span>
<span class="line">        proxy_pass http<span class="token operator">:</span><span class="token operator">/</span><span class="token operator">/</span>$http_host$request_uri<span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_8-7-负载均衡" tabindex="-1"><a class="header-anchor" href="#_8-7-负载均衡"><span>8.7 负载均衡</span></a></h3><p><img src="http://img.zhufengpeixun.cn/nginxbalance.jpg" alt="nginxbalance"></p><ul><li>使用集群是网站解决高并发、海量数据问题的常用手段。</li><li>当一台服务器的处理能力、存储空间不足时，不要企图去换更强大的服务器，对大型网站而言，不管多么强大的服务器，都满足不了网站持续增长的业务需求。</li><li>这种情况下，更恰当的做法是增加一台服务器分担原有服务器的访问及存储压力。通过负载均衡调度服务器，将来自浏览器的访问请求分发到应用服务器集群中的任何一台服务器上，如果有更多的用户，就在集群中加入更多的应用服务器，使应用服务器的负载压力不再成为整个网站的瓶颈。</li></ul><h4 id="_8-7-1-upstream" tabindex="-1"><a class="header-anchor" href="#_8-7-1-upstream"><span>8.7.1 upstream</span></a></h4><table><thead><tr><th style="text-align:left;">类型</th><th style="text-align:left;">种类</th></tr></thead><tbody><tr><td style="text-align:left;">语法</td><td style="text-align:left;">upstream name {}</td></tr><tr><td style="text-align:left;">默认</td><td style="text-align:left;">-</td></tr><tr><td style="text-align:left;">上下文</td><td style="text-align:left;">http</td></tr></tbody></table><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code class="language-javascript"><span class="line">upstream zfpx <span class="token punctuation">{</span></span>
<span class="line">  ip_hash<span class="token punctuation">;</span></span>
<span class="line">  server localhost<span class="token operator">:</span><span class="token number">3000</span><span class="token punctuation">;</span></span>
<span class="line">  server localhost<span class="token operator">:</span><span class="token number">4000</span><span class="token punctuation">;</span></span>
<span class="line">  server localhost<span class="token operator">:</span><span class="token number">5000</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">server <span class="token punctuation">{</span></span>
<span class="line">    location <span class="token operator">/</span> <span class="token punctuation">{</span></span>
<span class="line">        proxy_pass http<span class="token operator">:</span><span class="token operator">/</span><span class="token operator">/</span>zfpx<span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_8-7-2-后端服务器调试状态" tabindex="-1"><a class="header-anchor" href="#_8-7-2-后端服务器调试状态"><span>8.7.2 后端服务器调试状态</span></a></h4><table><thead><tr><th style="text-align:left;">状态</th><th style="text-align:left;">描述</th></tr></thead><tbody><tr><td style="text-align:left;">down</td><td style="text-align:left;">不参与负载均衡</td></tr><tr><td style="text-align:left;">backup</td><td style="text-align:left;">备份的服务器</td></tr><tr><td style="text-align:left;">max_fails</td><td style="text-align:left;">允许请求失败的次数</td></tr><tr><td style="text-align:left;">fail_timeout</td><td style="text-align:left;">经过max_fails失败后，服务暂停的时间</td></tr><tr><td style="text-align:left;">max_conns</td><td style="text-align:left;">限制最大的接收的连接数</td></tr></tbody></table><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code class="language-javascript"><span class="line">upstream zfpx <span class="token punctuation">{</span></span>
<span class="line">  server localhost<span class="token operator">:</span><span class="token number">3000</span> down<span class="token punctuation">;</span></span>
<span class="line">  server localhost<span class="token operator">:</span><span class="token number">4000</span> backup<span class="token punctuation">;</span></span>
<span class="line">  server localhost<span class="token operator">:</span><span class="token number">5000</span> max_fails<span class="token operator">=</span><span class="token number">1</span> fail_timeout<span class="token operator">=</span>10s<span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_8-7-3-分配方式" tabindex="-1"><a class="header-anchor" href="#_8-7-3-分配方式"><span>8.7.3 分配方式</span></a></h4><table><thead><tr><th style="text-align:left;">类型</th><th style="text-align:left;">种类</th></tr></thead><tbody><tr><td style="text-align:left;">轮询（默认）</td><td style="text-align:left;">每个请求按时间顺序逐一分配到不同的后端服务器，如果后端服务器down掉，能自动剔除。</td></tr><tr><td style="text-align:left;">weight(加权轮询)</td><td style="text-align:left;">指定轮询几率，weight和访问比率成正比，用于后端服务器性能不均的情况。</td></tr><tr><td style="text-align:left;">ip_hash</td><td style="text-align:left;">每个请求按访问ip的hash结果分配，这样每个访客固定访问一个后端服务器，可以解决session的问题。</td></tr><tr><td style="text-align:left;">url_hash（第三方）</td><td style="text-align:left;">按访问的URL地址来分配 请求，每个URL都定向到同一个后端 服务器上(缓存)</td></tr><tr><td style="text-align:left;">fair（第三方）</td><td style="text-align:left;">按后端服务器的响应时间来分配请求，响应时间短的优先分配。</td></tr><tr><td style="text-align:left;">least_conn</td><td style="text-align:left;">最小连接数，哪个连接少就分给谁</td></tr><tr><td style="text-align:left;">自定义hash</td><td style="text-align:left;">hash自定义key</td></tr></tbody></table><h3 id="_8-8-缓存" tabindex="-1"><a class="header-anchor" href="#_8-8-缓存"><span>8.8 缓存</span></a></h3><p>nginx代理缓存</p><p><a href="https://blog.csdn.net/dengjiexian123/article/details/53386586" target="_blank" rel="noopener noreferrer">proxy_cache</a></p><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code class="language-javascript"><span class="line">http<span class="token punctuation">{</span>  </span>
<span class="line">    proxy_cache_path <span class="token operator">/</span>data<span class="token operator">/</span>nginx<span class="token operator">/</span>tmp<span class="token operator">-</span>test levels<span class="token operator">=</span><span class="token number">1</span><span class="token operator">:</span><span class="token number">2</span> keys_zone<span class="token operator">=</span>tmp<span class="token operator">-</span>test<span class="token operator">:</span>100m inactive<span class="token operator">=</span>7d max_size<span class="token operator">=</span>1000g<span class="token punctuation">;</span>  </span>
<span class="line"><span class="token punctuation">}</span>  </span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li>proxy_cache_path 缓存文件路径</li><li>levels 设置缓存文件目录层次；levels=1:2 表示两级目录</li><li>keys_zone 设置缓存名字和共享内存大小</li><li>inactive 在指定时间内没人访问则被删除</li><li>max_size 最大缓存空间，如果缓存空间满，默认覆盖掉缓存时间最长的资源。</li></ul><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code class="language-javascript"><span class="line">location <span class="token operator">/</span>tmp<span class="token operator">-</span>test<span class="token operator">/</span> <span class="token punctuation">{</span>  </span>
<span class="line">  proxy_cache tmp<span class="token operator">-</span>test<span class="token punctuation">;</span>  </span>
<span class="line">  proxy_cache_valid  <span class="token number">200</span> <span class="token number">206</span> <span class="token number">304</span> <span class="token number">301</span> <span class="token number">302</span> 10d<span class="token punctuation">;</span>  </span>
<span class="line">  proxy_cache_key $uri<span class="token punctuation">;</span>  </span>
<span class="line">  proxy_set_header Host $host<span class="token operator">:</span>$server_port<span class="token punctuation">;</span>  </span>
<span class="line">  proxy_set_header <span class="token constant">X</span><span class="token operator">-</span>Real<span class="token operator">-</span><span class="token constant">IP</span> $remote_addr<span class="token punctuation">;</span>  </span>
<span class="line">  proxy_set_header   <span class="token constant">X</span><span class="token operator">-</span>Forwarded<span class="token operator">-</span>For $proxy_add_x_forwarded_for<span class="token punctuation">;</span>  </span>
<span class="line">  proxy_pass http<span class="token operator">:</span><span class="token operator">/</span><span class="token operator">/</span><span class="token number">127.0</span><span class="token number">.0</span><span class="token number">.1</span><span class="token operator">:</span><span class="token number">8081</span><span class="token operator">/</span>media_store<span class="token punctuation">.</span>php<span class="token operator">/</span>tmp<span class="token operator">-</span>test<span class="token operator">/</span><span class="token punctuation">;</span>  </span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li>proxy_cache tmp-test 使用名为tmp-test的对应缓存配置</li><li>proxy_cache_valid 200 206 304 301 302 10d; 对httpcode为200…的缓存10天</li><li>proxy_cache_key $uri 定义缓存唯一key,通过唯一key来进行hash存取</li><li>proxy_set_header 自定义http header头，用于发送给后端真实服务器。</li><li>proxy_pass 指代理后转发的路径，注意是否需要最后的/</li></ul>`,141)])])}const r=s(l,[["render",i]]),c=JSON.parse('{"path":"/strong/43.nginx.html","title":"","lang":"en-US","frontmatter":{},"git":{"updatedTime":1681290319000,"contributors":[{"name":"yutao","username":"yutao","email":"642231346@qq.com","commits":1,"url":"https://github.com/yutao"}],"changelog":[{"hash":"f5ab8c9d34991ec274f7f652439afe5b2afb6147","time":1681290319000,"email":"642231346@qq.com","author":"yutao","message":"modify"}]},"filePathRelative":"strong/43.nginx.md"}');export{r as comp,c as data};
