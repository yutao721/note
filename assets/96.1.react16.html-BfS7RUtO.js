import{_ as s,c as a,a as p,o as e}from"./app-CD1YpnS1.js";const t={};function l(o,n){return e(),a("div",null,[...n[0]||(n[0]=[p(`<h2 id="_1-渲染原生组件" tabindex="-1"><a class="header-anchor" href="#_1-渲染原生组件"><span>1. 渲染原生组件</span></a></h2><h3 id="_1-1-src-index-js" tabindex="-1"><a class="header-anchor" href="#_1-1-src-index-js"><span>1.1 src\\index.js</span></a></h3><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code class="language-javascript"><span class="line"><span class="token keyword">import</span> React <span class="token keyword">from</span> <span class="token string">&#39;./react&#39;</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">import</span> ReactDOM <span class="token keyword">from</span> <span class="token string">&#39;./react-dom&#39;</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">let</span> <span class="token function-variable function">onClick</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span> <span class="token function">alert</span><span class="token punctuation">(</span><span class="token string">&#39;hello&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span></span>
<span class="line"><span class="token keyword">let</span> element <span class="token operator">=</span> React<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">&#39;button&#39;</span><span class="token punctuation">,</span></span>
<span class="line">  <span class="token punctuation">{</span> <span class="token literal-property property">id</span><span class="token operator">:</span> <span class="token string">&#39;sayHello&#39;</span><span class="token punctuation">,</span> onClick <span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">  <span class="token string">&quot;say&quot;</span><span class="token punctuation">,</span> React<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">&#39;span&#39;</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> <span class="token literal-property property">style</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token literal-property property">color</span><span class="token operator">:</span> <span class="token string">&#39;red&#39;</span> <span class="token punctuation">}</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token string">&#39;Hello&#39;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">ReactDOM<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span></span>
<span class="line">  element<span class="token punctuation">,</span></span>
<span class="line">  document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">&#39;root&#39;</span><span class="token punctuation">)</span></span>
<span class="line"><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_1-2-react-index-js" tabindex="-1"><a class="header-anchor" href="#_1-2-react-index-js"><span>1.2 react\\index.js</span></a></h3><p>src\\react\\index.js</p><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code class="language-javascript"><span class="line"><span class="token keyword">import</span> <span class="token punctuation">{</span> <span class="token constant">TEXT</span><span class="token punctuation">,</span> <span class="token constant">ELEMENT</span> <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&#39;./constants&#39;</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">import</span> <span class="token punctuation">{</span> ReactElement <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&#39;./vdom&#39;</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">function</span> <span class="token function">createElement</span><span class="token punctuation">(</span><span class="token parameter">type<span class="token punctuation">,</span> config <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token operator">...</span>children</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">delete</span> config<span class="token punctuation">.</span>__source<span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">delete</span> config<span class="token punctuation">.</span>__self<span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">let</span> <span class="token punctuation">{</span> key<span class="token punctuation">,</span> ref<span class="token punctuation">,</span> <span class="token operator">...</span>props <span class="token punctuation">}</span> <span class="token operator">=</span> config<span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">let</span> $$<span class="token keyword">typeof</span> <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> type <span class="token operator">===</span> <span class="token string">&#39;string&#39;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        $$<span class="token keyword">typeof</span> <span class="token operator">=</span> <span class="token constant">ELEMENT</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    props<span class="token punctuation">.</span>children <span class="token operator">=</span> children<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token parameter">item</span> <span class="token operator">=&gt;</span> <span class="token keyword">typeof</span> item <span class="token operator">===</span> <span class="token string">&#39;object&#39;</span> <span class="token operator">||</span> <span class="token keyword">typeof</span> item <span class="token operator">===</span> <span class="token string">&#39;function&#39;</span> <span class="token operator">?</span> item</span>
<span class="line">        <span class="token operator">:</span> <span class="token punctuation">{</span> $$<span class="token keyword">typeof</span><span class="token operator">:</span> <span class="token constant">TEXT</span><span class="token punctuation">,</span> <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token constant">TEXT</span><span class="token punctuation">,</span> <span class="token literal-property property">content</span><span class="token operator">:</span> item <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">return</span> <span class="token function">ReactElement</span><span class="token punctuation">(</span>$$<span class="token keyword">typeof</span><span class="token punctuation">,</span> type<span class="token punctuation">,</span> key<span class="token punctuation">,</span> ref<span class="token punctuation">,</span> props<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">const</span> React <span class="token operator">=</span> <span class="token punctuation">{</span></span>
<span class="line">    createElement</span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"><span class="token keyword">export</span> <span class="token keyword">default</span> React<span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_1-3-react-constants-js" tabindex="-1"><a class="header-anchor" href="#_1-3-react-constants-js"><span>1.3 react\\constants.js</span></a></h3><p>src\\react\\constants.js</p><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code class="language-javascript"><span class="line"><span class="token keyword">export</span> <span class="token keyword">const</span> <span class="token constant">TEXT</span> <span class="token operator">=</span> Symbol<span class="token punctuation">.</span><span class="token function">for</span><span class="token punctuation">(</span><span class="token string">&#39;TEXT&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">export</span> <span class="token keyword">const</span> <span class="token constant">ELEMENT</span> <span class="token operator">=</span> Symbol<span class="token punctuation">.</span><span class="token function">for</span><span class="token punctuation">(</span><span class="token string">&#39;ELEMENT&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_1-4-react-vdom-js" tabindex="-1"><a class="header-anchor" href="#_1-4-react-vdom-js"><span>1.4 react\\vdom.js</span></a></h3><p>src\\react\\vdom.js</p><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code class="language-javascript"><span class="line"><span class="token keyword">import</span> <span class="token punctuation">{</span> <span class="token constant">TEXT</span><span class="token punctuation">,</span> <span class="token constant">ELEMENT</span> <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&#39;./constants&#39;</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">import</span> <span class="token punctuation">{</span> setProps <span class="token punctuation">,</span>onlyOne<span class="token punctuation">,</span>flatten<span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&#39;./utils&#39;</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">createDOM</span><span class="token punctuation">(</span><span class="token parameter">element</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">     element <span class="token operator">=</span> <span class="token function">onlyOne</span><span class="token punctuation">(</span>element<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">let</span> <span class="token punctuation">{</span> $$<span class="token keyword">typeof</span> <span class="token punctuation">}</span> <span class="token operator">=</span> element<span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">let</span> dom <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>$$<span class="token keyword">typeof</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        dom <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">createTextNode</span><span class="token punctuation">(</span>element<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>$$<span class="token keyword">typeof</span> <span class="token operator">===</span> <span class="token constant">TEXT</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        dom <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">createTextNode</span><span class="token punctuation">(</span>element<span class="token punctuation">.</span>content<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>$$<span class="token keyword">typeof</span> <span class="token operator">===</span> <span class="token constant">ELEMENT</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        dom <span class="token operator">=</span> <span class="token function">createNativeDOM</span><span class="token punctuation">(</span>element<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    element<span class="token punctuation">.</span>dom <span class="token operator">=</span> dom<span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">return</span> dom<span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">function</span> <span class="token function">createNativeDOM</span><span class="token punctuation">(</span><span class="token parameter">element</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">let</span> <span class="token punctuation">{</span> type<span class="token punctuation">,</span> props <span class="token punctuation">}</span> <span class="token operator">=</span> element<span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">let</span> dom <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span>type<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token function">createChildren</span><span class="token punctuation">(</span>element<span class="token punctuation">,</span> dom<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token function">setProps</span><span class="token punctuation">(</span>dom<span class="token punctuation">,</span> props<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">if</span> <span class="token punctuation">(</span>props<span class="token punctuation">.</span>ref<span class="token punctuation">)</span></span>
<span class="line">        props<span class="token punctuation">.</span>ref<span class="token punctuation">.</span>current <span class="token operator">=</span> dom<span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">return</span> dom<span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">function</span> <span class="token function">createChildren</span><span class="token punctuation">(</span><span class="token parameter">element<span class="token punctuation">,</span> parentNode</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    element<span class="token punctuation">.</span>props<span class="token punctuation">.</span>children <span class="token operator">&amp;&amp;</span> <span class="token function">flatten</span><span class="token punctuation">(</span>element<span class="token punctuation">.</span>props<span class="token punctuation">.</span>children<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">childElement<span class="token punctuation">,</span> index</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></span>
<span class="line">        childElement<span class="token punctuation">.</span>_mountIndex <span class="token operator">=</span> index<span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">let</span> childDOM <span class="token operator">=</span> <span class="token function">createDOM</span><span class="token punctuation">(</span>childElement<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        parentNode<span class="token punctuation">.</span><span class="token function">appendChild</span><span class="token punctuation">(</span>childDOM<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">ReactElement</span><span class="token punctuation">(</span><span class="token parameter">$$<span class="token keyword">typeof</span><span class="token punctuation">,</span> type<span class="token punctuation">,</span> key<span class="token punctuation">,</span> ref<span class="token punctuation">,</span> props</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">let</span> element <span class="token operator">=</span> <span class="token punctuation">{</span></span>
<span class="line">        $$<span class="token keyword">typeof</span><span class="token punctuation">,</span></span>
<span class="line">        type<span class="token punctuation">,</span></span>
<span class="line">        props<span class="token punctuation">,</span></span>
<span class="line">        key<span class="token punctuation">,</span></span>
<span class="line">        ref</span>
<span class="line">    <span class="token punctuation">}</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">return</span> element<span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_1-5-react-dom-index-js" tabindex="-1"><a class="header-anchor" href="#_1-5-react-dom-index-js"><span>1.5 react-dom\\index.js</span></a></h3><p>src\\react-dom\\index.js</p><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code class="language-javascript"><span class="line"><span class="token keyword">import</span> <span class="token punctuation">{</span> createDOM <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&#39;../react/vdom&#39;</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">render</span><span class="token punctuation">(</span><span class="token parameter">element<span class="token punctuation">,</span> container</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">let</span> dom <span class="token operator">=</span> <span class="token function">createDOM</span><span class="token punctuation">(</span>element<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    container<span class="token punctuation">.</span><span class="token function">appendChild</span><span class="token punctuation">(</span>dom<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"><span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token punctuation">{</span>render<span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_1-6-react-utils-js" tabindex="-1"><a class="header-anchor" href="#_1-6-react-utils-js"><span>1.6 react\\utils.js</span></a></h3><p>src\\react\\utils.js</p><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code class="language-javascript"><span class="line"><span class="token keyword">import</span> <span class="token punctuation">{</span> addEvent <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&#39;./event&#39;</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">setProps</span><span class="token punctuation">(</span><span class="token parameter">elem<span class="token punctuation">,</span> props</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> key <span class="token keyword">in</span> props<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">if</span> <span class="token punctuation">(</span>key <span class="token operator">!==</span> <span class="token string">&#39;children&#39;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token keyword">let</span> value <span class="token operator">=</span> props<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">;</span></span>
<span class="line">            <span class="token function">setProp</span><span class="token punctuation">(</span>elem<span class="token punctuation">,</span> key<span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"><span class="token keyword">function</span> <span class="token function">setProp</span><span class="token punctuation">(</span><span class="token parameter">elem<span class="token punctuation">,</span> key<span class="token punctuation">,</span> value</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">^on</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">.</span><span class="token function">test</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token function">addEvent</span><span class="token punctuation">(</span>elem<span class="token punctuation">,</span> key<span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>key <span class="token operator">===</span> <span class="token string">&#39;style&#39;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">if</span> <span class="token punctuation">(</span>value<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> styleName <span class="token keyword">in</span> value<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">                <span class="token keyword">if</span> <span class="token punctuation">(</span>value<span class="token punctuation">.</span><span class="token function">hasOwnProperty</span><span class="token punctuation">(</span>styleName<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">                    elem<span class="token punctuation">.</span>style<span class="token punctuation">[</span>styleName<span class="token punctuation">]</span> <span class="token operator">=</span> value<span class="token punctuation">[</span>styleName<span class="token punctuation">]</span><span class="token punctuation">;</span></span>
<span class="line">                <span class="token punctuation">}</span></span>
<span class="line">            <span class="token punctuation">}</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span></span>
<span class="line">        elem<span class="token punctuation">.</span><span class="token function">setAttribute</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    <span class="token keyword">return</span> elem<span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"><span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">onlyOne</span><span class="token punctuation">(</span><span class="token parameter">obj</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">return</span> Array<span class="token punctuation">.</span><span class="token function">isArray</span><span class="token punctuation">(</span>obj<span class="token punctuation">)</span> <span class="token operator">?</span> obj<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">:</span> obj<span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"><span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">isFunction</span><span class="token punctuation">(</span><span class="token parameter">obj</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">return</span> <span class="token keyword">typeof</span> obj <span class="token operator">===</span> <span class="token string">&#39;function&#39;</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"><span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">flatten</span><span class="token punctuation">(</span><span class="token parameter">array</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">var</span> flattend <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token function">flat</span><span class="token punctuation">(</span><span class="token parameter">array</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        array<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">el</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token keyword">if</span> <span class="token punctuation">(</span>Array<span class="token punctuation">.</span><span class="token function">isArray</span><span class="token punctuation">(</span>el<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token function">flat</span><span class="token punctuation">(</span>el<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">            <span class="token keyword">else</span> flattend<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>el<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">(</span>array<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">return</span> flattend<span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_1-7-react-event-js" tabindex="-1"><a class="header-anchor" href="#_1-7-react-event-js"><span>1.7 react\\event.js</span></a></h3><p>src\\react\\event.js</p><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code class="language-javascript"><span class="line"><span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">addEvent</span><span class="token punctuation">(</span><span class="token parameter">dom<span class="token punctuation">,</span> eventType<span class="token punctuation">,</span> listener</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    eventType <span class="token operator">=</span> eventType<span class="token punctuation">.</span><span class="token function">toLowerCase</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">let</span> eventStore <span class="token operator">=</span> dom<span class="token punctuation">.</span>eventStore <span class="token operator">||</span> <span class="token punctuation">(</span>dom<span class="token punctuation">.</span>eventStore <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    eventStore<span class="token punctuation">[</span>eventType<span class="token punctuation">]</span> <span class="token operator">=</span> listener<span class="token punctuation">;</span></span>
<span class="line">    document<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span>eventType<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">,</span> dispatchEvent<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"><span class="token keyword">let</span> syntheticEvent<span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">function</span> <span class="token function">dispatchEvent</span><span class="token punctuation">(</span><span class="token parameter">event</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">let</span> <span class="token punctuation">{</span> type<span class="token punctuation">,</span> target <span class="token punctuation">}</span> <span class="token operator">=</span> event<span class="token punctuation">;</span></span>
<span class="line">    syntheticEvent <span class="token operator">=</span> <span class="token function">getSyntheticEvent</span><span class="token punctuation">(</span>event<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">while</span> <span class="token punctuation">(</span>target<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">let</span> <span class="token punctuation">{</span> eventStore <span class="token punctuation">}</span> <span class="token operator">=</span> target<span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">let</span> listener <span class="token operator">=</span> eventStore <span class="token operator">&amp;&amp;</span> eventStore<span class="token punctuation">[</span>eventType<span class="token punctuation">]</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">if</span> <span class="token punctuation">(</span>listener<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token function">listener</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> syntheticEvent<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">        target <span class="token operator">=</span> target<span class="token punctuation">.</span>parentNode<span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> key <span class="token keyword">in</span> syntheticEvent<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">if</span> <span class="token punctuation">(</span>syntheticEvent<span class="token punctuation">.</span><span class="token function">hasOwnProperty</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">)</span></span>
<span class="line">            <span class="token keyword">delete</span> syntheticEvent<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"><span class="token keyword">function</span> <span class="token function">persist</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    syntheticEvent <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span></span>
<span class="line">    Object<span class="token punctuation">.</span><span class="token function">setPrototypeOf</span><span class="token punctuation">(</span>syntheticEvent<span class="token punctuation">,</span> <span class="token punctuation">{</span></span>
<span class="line">        persist</span>
<span class="line">    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"><span class="token keyword">function</span> <span class="token function">getSyntheticEvent</span><span class="token punctuation">(</span><span class="token parameter">nativeEvent</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>syntheticEvent<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token function">persist</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    syntheticEvent<span class="token punctuation">.</span>nativeEvent <span class="token operator">=</span> nativeEvent<span class="token punctuation">;</span></span>
<span class="line">    syntheticEvent<span class="token punctuation">.</span>currentTarget <span class="token operator">=</span> nativeEvent<span class="token punctuation">.</span>target<span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> key <span class="token keyword">in</span> nativeEvent<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> nativeEvent<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token string">&#39;function&#39;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">            syntheticEvent<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">=</span> nativeEvent<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span>nativeEvent<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span></span>
<span class="line">            syntheticEvent<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">=</span> nativeEvent<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    <span class="token keyword">return</span> syntheticEvent<span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="_2-渲染类组件和函数组件" tabindex="-1"><a class="header-anchor" href="#_2-渲染类组件和函数组件"><span>2. 渲染类组件和函数组件</span></a></h2><h3 id="_2-1-src-index-js" tabindex="-1"><a class="header-anchor" href="#_2-1-src-index-js"><span>2.1 src\\index.js</span></a></h3><p>src\\index.js</p><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text"><pre><code class="language-text"><span class="line">import React from &#39;./react&#39;;</span>
<span class="line">import ReactDOM from &#39;./react-dom&#39;;</span>
<span class="line">+class ClassCounter extends React.Component {</span>
<span class="line">+    constructor(props) {</span>
<span class="line">+        super(props);</span>
<span class="line">+    }</span>
<span class="line">+    render() {</span>
<span class="line">+        return React.createElement(&#39;div&#39;, { id: &#39;counter&#39; }, &#39;hello&#39;);</span>
<span class="line">+    }</span>
<span class="line">+}</span>
<span class="line">+function FunctionCounter(props) {</span>
<span class="line">+    return React.createElement(&#39;div&#39;, { id: &#39;counter&#39; }, &#39;hello&#39;);</span>
<span class="line">+}</span>
<span class="line"></span>
<span class="line">+let element1 = React.createElement(&#39;div&#39;, { id: &#39;counter&#39; }, &#39;hello&#39;);</span>
<span class="line">+let element2 = React.createElement(ClassCounter);</span>
<span class="line">+let element3 = React.createElement(FunctionCounter);</span>
<span class="line">ReactDOM.render(</span>
<span class="line">+    element1,</span>
<span class="line">    document.getElementById(&#39;root&#39;)</span>
<span class="line">);</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_2-2-react-constants-js" tabindex="-1"><a class="header-anchor" href="#_2-2-react-constants-js"><span>2.2 react\\constants.js</span></a></h3><p>src\\react\\constants.js</p><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text"><pre><code class="language-text"><span class="line">export const TEXT = Symbol.for(&#39;TEXT&#39;);</span>
<span class="line">+export const ELEMENT = Symbol.for(&#39;ELEMENT&#39;);</span>
<span class="line">+export const FUNCTION_COMPONENT = Symbol.for(&#39;FUNCTION_COMPONENT&#39;);</span>
<span class="line">+export const CLASS_COMPONENT = Symbol.for(&#39;CLASS_COMPONENT&#39;);</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_2-3-react-index-js" tabindex="-1"><a class="header-anchor" href="#_2-3-react-index-js"><span>2.3 react\\index.js</span></a></h3><p>src\\react\\index.js</p><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code class="language-javascript"><span class="line"><span class="token operator">+</span><span class="token keyword">import</span> <span class="token punctuation">{</span> <span class="token constant">TEXT</span><span class="token punctuation">,</span> <span class="token constant">ELEMENT</span><span class="token punctuation">,</span> <span class="token constant">FUNCTION_COMPONENT</span><span class="token punctuation">,</span> <span class="token constant">CLASS_COMPONENT</span> <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&#39;./constants&#39;</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">import</span> <span class="token punctuation">{</span> ReactElement <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&#39;./vdom&#39;</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token operator">+</span><span class="token keyword">import</span> <span class="token punctuation">{</span> Component <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&#39;./component&#39;</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">function</span> <span class="token function">createElement</span><span class="token punctuation">(</span><span class="token parameter">type<span class="token punctuation">,</span> props <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token operator">...</span>children</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">let</span> $$<span class="token keyword">typeof</span> <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> type <span class="token operator">===</span> <span class="token string">&#39;string&#39;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        $$<span class="token keyword">typeof</span> <span class="token operator">=</span> <span class="token constant">ELEMENT</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token operator">+</span>    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> type <span class="token operator">===</span> <span class="token string">&#39;function&#39;</span> <span class="token operator">&amp;&amp;</span> type<span class="token punctuation">.</span>prototype<span class="token punctuation">.</span>isReactComponent<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line"><span class="token operator">+</span>        $$<span class="token keyword">typeof</span> <span class="token operator">=</span> <span class="token constant">CLASS_COMPONENT</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token operator">+</span>    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> type <span class="token operator">===</span> <span class="token string">&#39;function&#39;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line"><span class="token operator">+</span>        $$<span class="token keyword">typeof</span> <span class="token operator">=</span> <span class="token constant">FUNCTION_COMPONENT</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token operator">+</span>    <span class="token punctuation">}</span></span>
<span class="line">    props<span class="token punctuation">.</span>children <span class="token operator">=</span> children<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token parameter">item</span> <span class="token operator">=&gt;</span> <span class="token keyword">typeof</span> item <span class="token operator">===</span> <span class="token string">&#39;object&#39;</span> <span class="token operator">||</span> <span class="token keyword">typeof</span> item <span class="token operator">===</span> <span class="token string">&#39;function&#39;</span> <span class="token operator">?</span> item</span>
<span class="line">        <span class="token operator">:</span> <span class="token punctuation">{</span> $$<span class="token keyword">typeof</span><span class="token operator">:</span> <span class="token constant">TEXT</span><span class="token punctuation">,</span> <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token constant">TEXT</span><span class="token punctuation">,</span> <span class="token literal-property property">content</span><span class="token operator">:</span> item <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">return</span> <span class="token function">ReactElement</span><span class="token punctuation">(</span>$$<span class="token keyword">typeof</span><span class="token punctuation">,</span> type<span class="token punctuation">,</span> props<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"><span class="token operator">+</span><span class="token keyword">export</span> <span class="token punctuation">{</span></span>
<span class="line"><span class="token operator">+</span>    Component</span>
<span class="line"><span class="token operator">+</span><span class="token punctuation">}</span></span>
<span class="line"><span class="token operator">+</span><span class="token keyword">const</span> React <span class="token operator">=</span> <span class="token punctuation">{</span></span>
<span class="line">    createElement<span class="token punctuation">,</span></span>
<span class="line"><span class="token operator">+</span>    Component</span>
<span class="line"><span class="token operator">+</span><span class="token punctuation">}</span></span>
<span class="line"><span class="token keyword">export</span> <span class="token keyword">default</span> React<span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_2-4-react-vdom-js" tabindex="-1"><a class="header-anchor" href="#_2-4-react-vdom-js"><span>2.4 react\\vdom.js</span></a></h3><p>src\\react\\vdom.js</p><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code class="language-javascript"><span class="line"><span class="token operator">+</span><span class="token keyword">import</span> <span class="token punctuation">{</span> <span class="token constant">TEXT</span><span class="token punctuation">,</span> <span class="token constant">ELEMENT</span><span class="token punctuation">,</span> <span class="token constant">FUNCTION_COMPONENT</span><span class="token punctuation">,</span> <span class="token constant">CLASS_COMPONENT</span> <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&#39;./constants&#39;</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">import</span> <span class="token punctuation">{</span> setProps<span class="token punctuation">,</span>onlyOne<span class="token punctuation">,</span>flatten <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&#39;./utils&#39;</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">createDOM</span><span class="token punctuation">(</span><span class="token parameter">element</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    element <span class="token operator">=</span> <span class="token function">onlyOne</span><span class="token punctuation">(</span>element<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">let</span> <span class="token punctuation">{</span> $$<span class="token keyword">typeof</span> <span class="token punctuation">}</span> <span class="token operator">=</span> element<span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">let</span> dom <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>$$<span class="token keyword">typeof</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        dom <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">createTextNode</span><span class="token punctuation">(</span>element<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>$$<span class="token keyword">typeof</span> <span class="token operator">===</span> <span class="token constant">TEXT</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        dom <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">createTextNode</span><span class="token punctuation">(</span>element<span class="token punctuation">.</span>content<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>$$<span class="token keyword">typeof</span> <span class="token operator">===</span> <span class="token constant">ELEMENT</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        dom <span class="token operator">=</span> <span class="token function">createNativeDOM</span><span class="token punctuation">(</span>element<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token operator">+</span>    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>$$<span class="token keyword">typeof</span> <span class="token operator">===</span> <span class="token constant">FUNCTION_COMPONENT</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line"><span class="token operator">+</span>        dom <span class="token operator">=</span> <span class="token function">createFunctionComponentDOM</span><span class="token punctuation">(</span>element<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token operator">+</span>    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>$$<span class="token keyword">typeof</span> <span class="token operator">===</span> <span class="token constant">CLASS_COMPONENT</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line"><span class="token operator">+</span>        dom <span class="token operator">=</span> <span class="token function">createClassComponentDOM</span><span class="token punctuation">(</span>element<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    element<span class="token punctuation">.</span>dom <span class="token operator">=</span> dom<span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">return</span> dom<span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">function</span> <span class="token function">createNativeDOM</span><span class="token punctuation">(</span><span class="token parameter">element</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">let</span> <span class="token punctuation">{</span> type<span class="token punctuation">,</span> props <span class="token punctuation">}</span> <span class="token operator">=</span> element<span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">let</span> dom <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span>type<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token function">createChildren</span><span class="token punctuation">(</span>element<span class="token punctuation">,</span> dom<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token function">setProps</span><span class="token punctuation">(</span>dom<span class="token punctuation">,</span> props<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">return</span> dom<span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">function</span> <span class="token function">createChildren</span><span class="token punctuation">(</span><span class="token parameter">element<span class="token punctuation">,</span> parentNode</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    element<span class="token punctuation">.</span>props<span class="token punctuation">.</span>children <span class="token operator">&amp;&amp;</span> <span class="token function">flatten</span><span class="token punctuation">(</span>element<span class="token punctuation">.</span>props<span class="token punctuation">.</span>children<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">childElement<span class="token punctuation">,</span> index</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></span>
<span class="line">        childElement<span class="token punctuation">.</span>_mountIndex <span class="token operator">=</span> index<span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">let</span> childDOM <span class="token operator">=</span> <span class="token function">createDOM</span><span class="token punctuation">(</span>childElement<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        childElement<span class="token punctuation">.</span>dom <span class="token operator">=</span> childDOM<span class="token punctuation">;</span></span>
<span class="line">        parentNode<span class="token punctuation">.</span><span class="token function">appendChild</span><span class="token punctuation">(</span>childDOM<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"><span class="token operator">+</span><span class="token keyword">function</span> <span class="token function">createFunctionComponentDOM</span><span class="token punctuation">(</span><span class="token parameter">element</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line"><span class="token operator">+</span>    <span class="token keyword">let</span> <span class="token punctuation">{</span> type<span class="token punctuation">,</span> props <span class="token punctuation">}</span> <span class="token operator">=</span> element<span class="token punctuation">;</span></span>
<span class="line"><span class="token operator">+</span>    <span class="token keyword">let</span> renderElement <span class="token operator">=</span> <span class="token function">type</span><span class="token punctuation">(</span>props<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token operator">+</span>    element<span class="token punctuation">.</span>renderElement <span class="token operator">=</span> renderElement<span class="token punctuation">;</span></span>
<span class="line"><span class="token operator">+</span>    <span class="token keyword">let</span> newDOM <span class="token operator">=</span> <span class="token function">createDOM</span><span class="token punctuation">(</span>renderElement<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token operator">+</span>    renderElement<span class="token punctuation">.</span>dom <span class="token operator">=</span> newDOM<span class="token punctuation">;</span></span>
<span class="line"><span class="token operator">+</span>    <span class="token keyword">return</span> newDOM<span class="token punctuation">;</span></span>
<span class="line"><span class="token operator">+</span><span class="token punctuation">}</span></span>
<span class="line"><span class="token operator">+</span><span class="token keyword">function</span> <span class="token function">createClassComponentDOM</span><span class="token punctuation">(</span><span class="token parameter">element</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line"><span class="token operator">+</span>    <span class="token keyword">let</span> <span class="token punctuation">{</span> type<span class="token punctuation">,</span> props <span class="token punctuation">}</span> <span class="token operator">=</span> element<span class="token punctuation">;</span></span>
<span class="line"><span class="token operator">+</span>    <span class="token keyword">let</span> componentInstance <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">type</span><span class="token punctuation">(</span>props<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token operator">+</span>    element<span class="token punctuation">.</span>componentInstance <span class="token operator">=</span> componentInstance<span class="token punctuation">;</span></span>
<span class="line"><span class="token operator">+</span>    <span class="token keyword">let</span> renderElement <span class="token operator">=</span> componentInstance<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token operator">+</span>    componentInstance<span class="token punctuation">.</span>renderElement <span class="token operator">=</span> renderElement<span class="token punctuation">;</span></span>
<span class="line"><span class="token operator">+</span>    <span class="token keyword">let</span> newDOM <span class="token operator">=</span> <span class="token function">createDOM</span><span class="token punctuation">(</span>renderElement<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token operator">+</span>    <span class="token keyword">return</span> newDOM<span class="token punctuation">;</span></span>
<span class="line"><span class="token operator">+</span><span class="token punctuation">}</span></span>
<span class="line"><span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">ReactElement</span><span class="token punctuation">(</span><span class="token parameter">$$<span class="token keyword">typeof</span><span class="token punctuation">,</span> type<span class="token punctuation">,</span> key<span class="token punctuation">,</span> ref<span class="token punctuation">,</span> props</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">let</span> element <span class="token operator">=</span> <span class="token punctuation">{</span></span>
<span class="line">        $$<span class="token keyword">typeof</span><span class="token punctuation">,</span></span>
<span class="line">        type<span class="token punctuation">,</span></span>
<span class="line">        props<span class="token punctuation">,</span></span>
<span class="line">        key<span class="token punctuation">,</span></span>
<span class="line">        ref</span>
<span class="line">    <span class="token punctuation">}</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">return</span> element<span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_2-5-react-component-js" tabindex="-1"><a class="header-anchor" href="#_2-5-react-component-js"><span>2.5 react\\component.js</span></a></h3><p>src\\react\\component.js</p><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code class="language-javascript"><span class="line"><span class="token keyword">class</span> <span class="token class-name">Component</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter">props</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">this</span><span class="token punctuation">.</span>props <span class="token operator">=</span> props<span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"><span class="token class-name">Component</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span>isReactComponent <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">export</span> <span class="token punctuation">{</span></span>
<span class="line">    Component</span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="_3-组件更新" tabindex="-1"><a class="header-anchor" href="#_3-组件更新"><span>3. 组件更新</span></a></h2><p><img src="http://img.zhufengpeixun.cn/setState2.jpg" alt="setState2"></p><h3 id="_3-1-src-index-js" tabindex="-1"><a class="header-anchor" href="#_3-1-src-index-js"><span>3.1 src\\index.js</span></a></h3><p>src\\index.js</p><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text"><pre><code class="language-text"><span class="line">import React from &#39;./react&#39;;</span>
<span class="line">import ReactDOM from &#39;./react-dom&#39;;</span>
<span class="line">class Counter extends React.Component {</span>
<span class="line">    constructor(props) {</span>
<span class="line">        super(props);</span>
<span class="line">        this.state = { number: 0 };</span>
<span class="line">+        setInterval(() =&gt; {</span>
<span class="line">+            this.setState({ number: this.state.number + 1 });</span>
<span class="line">+        }, 2000);</span>
<span class="line">    }</span>
<span class="line">    render() {</span>
<span class="line">+        //return &lt;div id={&#39;counter&#39; + this.state.number}&gt;&lt;/div&gt;</span>
<span class="line">+        //return &lt;FunctionCounter number={this.state.number} /&gt;</span>
<span class="line">+        return &lt;ClassCounter number={this.state.number} /&gt;</span>
<span class="line">    }</span>
<span class="line">}</span>
<span class="line">+class ClassCounter extends React.Component {</span>
<span class="line">+    render() {</span>
<span class="line">+        return (</span>
<span class="line">+            &lt;div id={&#39;counter&#39; + this.props.number}&gt;&lt;/div&gt;</span>
<span class="line">+        )</span>
<span class="line">+    }</span>
<span class="line">+}</span>
<span class="line">+function FunctionCounter(props) {</span>
<span class="line">+    return (</span>
<span class="line">+        &lt;div id={&#39;counter&#39; + props.number}&gt;&lt;/div&gt;</span>
<span class="line">+    )</span>
<span class="line">+}</span>
<span class="line">+let element = React.createElement(Counter, {});</span>
<span class="line">ReactDOM.render(</span>
<span class="line">    element,</span>
<span class="line">    document.getElementById(&#39;root&#39;)</span>
<span class="line">);</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_3-2-react-utils-js" tabindex="-1"><a class="header-anchor" href="#_3-2-react-utils-js"><span>3.2 react\\utils.js</span></a></h3><p>src\\react\\utils.js</p><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code class="language-javascript"><span class="line"><span class="token keyword">import</span> <span class="token punctuation">{</span> addEvent <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&#39;./event&#39;</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">setProps</span><span class="token punctuation">(</span><span class="token parameter">elem<span class="token punctuation">,</span> props</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> key <span class="token keyword">in</span> props<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">if</span> <span class="token punctuation">(</span>key <span class="token operator">!==</span> <span class="token string">&#39;children&#39;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token keyword">let</span> value <span class="token operator">=</span> props<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">;</span></span>
<span class="line">            <span class="token function">setProp</span><span class="token punctuation">(</span>elem<span class="token punctuation">,</span> key<span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"><span class="token keyword">function</span> <span class="token function">setProp</span><span class="token punctuation">(</span><span class="token parameter">elem<span class="token punctuation">,</span> key<span class="token punctuation">,</span> value</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">^on</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">.</span><span class="token function">test</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token function">addEvent</span><span class="token punctuation">(</span>elem<span class="token punctuation">,</span> key<span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>key <span class="token operator">===</span> <span class="token string">&#39;style&#39;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">if</span> <span class="token punctuation">(</span>value<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> styleName <span class="token keyword">in</span> value<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">                <span class="token keyword">if</span> <span class="token punctuation">(</span>value<span class="token punctuation">.</span><span class="token function">hasOwnProperty</span><span class="token punctuation">(</span>styleName<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">                    elem<span class="token punctuation">.</span>style<span class="token punctuation">[</span>styleName<span class="token punctuation">]</span> <span class="token operator">=</span> value<span class="token punctuation">[</span>styleName<span class="token punctuation">]</span><span class="token punctuation">;</span></span>
<span class="line">                <span class="token punctuation">}</span></span>
<span class="line">            <span class="token punctuation">}</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span></span>
<span class="line">        elem<span class="token punctuation">.</span><span class="token function">setAttribute</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    <span class="token keyword">return</span> elem<span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">patchProps</span><span class="token punctuation">(</span><span class="token parameter">elem<span class="token punctuation">,</span> oldProps<span class="token punctuation">,</span> newProps</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> key <span class="token keyword">in</span> oldProps<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">if</span> <span class="token punctuation">(</span>key <span class="token operator">!==</span> <span class="token string">&#39;children&#39;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token keyword">if</span> <span class="token punctuation">(</span>newProps<span class="token punctuation">.</span><span class="token function">hasOwnProperty</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">                <span class="token function">setProp</span><span class="token punctuation">(</span>elem<span class="token punctuation">,</span> key<span class="token punctuation">,</span> newProps<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span></span>
<span class="line">                elem<span class="token punctuation">.</span><span class="token function">removeAttribute</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">            <span class="token punctuation">}</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> key <span class="token keyword">in</span> newProps<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">if</span> <span class="token punctuation">(</span>key <span class="token operator">!==</span> <span class="token string">&#39;children&#39;</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>newProps<span class="token punctuation">.</span><span class="token function">hasOwnProperty</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token function">setProp</span><span class="token punctuation">(</span>elem<span class="token punctuation">,</span> key<span class="token punctuation">,</span> newProps<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">)</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"><span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">onlyOne</span><span class="token punctuation">(</span><span class="token parameter">obj</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">return</span> Array<span class="token punctuation">.</span><span class="token function">isArray</span><span class="token punctuation">(</span>obj<span class="token punctuation">)</span> <span class="token operator">?</span> obj<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">:</span> obj<span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"><span class="token operator">+</span><span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">isFunction</span><span class="token punctuation">(</span><span class="token parameter">obj</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line"><span class="token operator">+</span>    <span class="token keyword">return</span> <span class="token keyword">typeof</span> obj <span class="token operator">===</span> <span class="token string">&#39;function&#39;</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token operator">+</span><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_3-3-react-vdom-js" tabindex="-1"><a class="header-anchor" href="#_3-3-react-vdom-js"><span>3.3 react\\vdom.js</span></a></h3><p>src\\react\\vdom.js</p><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code class="language-javascript"><span class="line"><span class="token keyword">import</span> <span class="token punctuation">{</span> <span class="token constant">TEXT</span><span class="token punctuation">,</span> <span class="token constant">ELEMENT</span><span class="token punctuation">,</span> <span class="token constant">FUNCTION_COMPONENT</span><span class="token punctuation">,</span> <span class="token constant">CLASS_COMPONENT</span> <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&#39;./constants&#39;</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token operator">+</span><span class="token keyword">import</span> <span class="token punctuation">{</span> setProps<span class="token punctuation">,</span> onlyOne<span class="token punctuation">,</span> flatten<span class="token punctuation">,</span>patchProps <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&#39;./utils&#39;</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">createDOM</span><span class="token punctuation">(</span><span class="token parameter">element</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line"><span class="token operator">+</span>    element <span class="token operator">=</span> <span class="token function">onlyOne</span><span class="token punctuation">(</span>element<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">let</span> <span class="token punctuation">{</span> $$<span class="token keyword">typeof</span> <span class="token punctuation">}</span> <span class="token operator">=</span> element<span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">let</span> dom <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>$$<span class="token keyword">typeof</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        dom <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">createTextNode</span><span class="token punctuation">(</span>element<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>$$<span class="token keyword">typeof</span> <span class="token operator">===</span> <span class="token constant">TEXT</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        dom <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">createTextNode</span><span class="token punctuation">(</span>element<span class="token punctuation">.</span>content<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>$$<span class="token keyword">typeof</span> <span class="token operator">===</span> <span class="token constant">ELEMENT</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        dom <span class="token operator">=</span> <span class="token function">createNativeDOM</span><span class="token punctuation">(</span>element<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>$$<span class="token keyword">typeof</span> <span class="token operator">===</span> <span class="token constant">FUNCTION_COMPONENT</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        dom <span class="token operator">=</span> <span class="token function">createFunctionComponentDOM</span><span class="token punctuation">(</span>element<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>$$<span class="token keyword">typeof</span> <span class="token operator">===</span> <span class="token constant">CLASS_COMPONENT</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        dom <span class="token operator">=</span> <span class="token function">createClassComponentDOM</span><span class="token punctuation">(</span>element<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    element<span class="token punctuation">.</span>dom <span class="token operator">=</span> dom<span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">return</span> dom<span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">function</span> <span class="token function">createNativeDOM</span><span class="token punctuation">(</span><span class="token parameter">element</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">let</span> <span class="token punctuation">{</span> type<span class="token punctuation">,</span> props <span class="token punctuation">}</span> <span class="token operator">=</span> element<span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">let</span> dom <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span>type<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token function">createChildren</span><span class="token punctuation">(</span>element<span class="token punctuation">,</span> dom<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token function">setProps</span><span class="token punctuation">(</span>dom<span class="token punctuation">,</span> props<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">return</span> dom<span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">function</span> <span class="token function">createChildren</span><span class="token punctuation">(</span><span class="token parameter">element<span class="token punctuation">,</span> parentNode</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    element<span class="token punctuation">.</span>props<span class="token punctuation">.</span>children <span class="token operator">&amp;&amp;</span> <span class="token function">flatten</span><span class="token punctuation">(</span>element<span class="token punctuation">.</span>props<span class="token punctuation">.</span>children<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">childElement<span class="token punctuation">,</span> index</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></span>
<span class="line">        childElement<span class="token punctuation">.</span>_mountIndex <span class="token operator">=</span> index<span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">let</span> childDOM <span class="token operator">=</span> <span class="token function">createDOM</span><span class="token punctuation">(</span>childElement<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        childElement<span class="token punctuation">.</span>dom <span class="token operator">=</span> childDOM<span class="token punctuation">;</span></span>
<span class="line">        parentNode<span class="token punctuation">.</span><span class="token function">appendChild</span><span class="token punctuation">(</span>childDOM<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"><span class="token keyword">function</span> <span class="token function">createFunctionComponentDOM</span><span class="token punctuation">(</span><span class="token parameter">element</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">let</span> <span class="token punctuation">{</span> type<span class="token punctuation">,</span> props <span class="token punctuation">}</span> <span class="token operator">=</span> element<span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">let</span> renderElement <span class="token operator">=</span> <span class="token function">type</span><span class="token punctuation">(</span>props<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    element<span class="token punctuation">.</span>renderElement <span class="token operator">=</span> renderElement<span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">let</span> newDOM <span class="token operator">=</span> <span class="token function">createDOM</span><span class="token punctuation">(</span>renderElement<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    renderElement<span class="token punctuation">.</span>dom <span class="token operator">=</span> newDOM<span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">return</span> newDOM<span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"><span class="token keyword">function</span> <span class="token function">createClassComponentDOM</span><span class="token punctuation">(</span><span class="token parameter">element</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">let</span> <span class="token punctuation">{</span> type<span class="token punctuation">,</span> props <span class="token punctuation">}</span> <span class="token operator">=</span> element<span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">let</span> componentInstance <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">type</span><span class="token punctuation">(</span>props<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    element<span class="token punctuation">.</span>componentInstance <span class="token operator">=</span> componentInstance<span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">let</span> renderElement <span class="token operator">=</span> componentInstance<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    componentInstance<span class="token punctuation">.</span>renderElement <span class="token operator">=</span> renderElement<span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">let</span> newDOM <span class="token operator">=</span> <span class="token function">createDOM</span><span class="token punctuation">(</span>renderElement<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">return</span> newDOM<span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"><span class="token operator">+</span><span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">compareTwoElements</span><span class="token punctuation">(</span><span class="token parameter">oldElement<span class="token punctuation">,</span> newElement</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line"><span class="token operator">+</span>    oldElement <span class="token operator">=</span> <span class="token function">onlyOne</span><span class="token punctuation">(</span>oldElement<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token operator">+</span>    newElement <span class="token operator">=</span> <span class="token function">onlyOne</span><span class="token punctuation">(</span>newElement<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token operator">+</span>    <span class="token keyword">let</span> currentDOM <span class="token operator">=</span> oldElement<span class="token punctuation">.</span>dom<span class="token punctuation">;</span></span>
<span class="line"><span class="token operator">+</span>    <span class="token keyword">let</span> currentElement <span class="token operator">=</span> oldElement<span class="token punctuation">;</span></span>
<span class="line"><span class="token operator">+</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>newElement <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token comment">//如果新节点没有了，直接删除拉倒</span></span>
<span class="line"><span class="token operator">+</span>        currentDOM<span class="token punctuation">.</span>parentNode<span class="token punctuation">.</span><span class="token function">removeChild</span><span class="token punctuation">(</span>currentDOM<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token operator">+</span>        currentElement <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token operator">+</span>    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>oldElement<span class="token punctuation">.</span>type <span class="token operator">!==</span> newElement<span class="token punctuation">.</span>type<span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token comment">//如果类型不同</span></span>
<span class="line"><span class="token operator">+</span>        <span class="token keyword">let</span> newDOM <span class="token operator">=</span> <span class="token function">createDOM</span><span class="token punctuation">(</span>newElement<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token operator">+</span>        currentDOM<span class="token punctuation">.</span>parentNode<span class="token punctuation">.</span><span class="token function">replaceChild</span><span class="token punctuation">(</span>newDOM<span class="token punctuation">,</span> currentDOM<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token operator">+</span>        currentElement <span class="token operator">=</span> newElement<span class="token punctuation">;</span></span>
<span class="line"><span class="token operator">+</span>    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span></span>
<span class="line"><span class="token operator">+</span>        <span class="token function">updateElement</span><span class="token punctuation">(</span>oldElement<span class="token punctuation">,</span> newElement<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token operator">+</span>    <span class="token punctuation">}</span></span>
<span class="line"><span class="token operator">+</span>    <span class="token keyword">return</span> currentElement<span class="token punctuation">;</span></span>
<span class="line"><span class="token operator">+</span><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token operator">+</span><span class="token keyword">function</span> <span class="token function">updateElement</span><span class="token punctuation">(</span><span class="token parameter">oldElement<span class="token punctuation">,</span> newElement</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line"><span class="token operator">+</span>    <span class="token keyword">let</span> currentDOM <span class="token operator">=</span> newElement<span class="token punctuation">.</span>dom <span class="token operator">=</span> oldElement<span class="token punctuation">.</span>dom<span class="token punctuation">;</span></span>
<span class="line"><span class="token operator">+</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>oldElement<span class="token punctuation">.</span>$$<span class="token keyword">typeof</span> <span class="token operator">===</span> <span class="token constant">TEXT</span> <span class="token operator">&amp;&amp;</span> newElement<span class="token punctuation">.</span>$$<span class="token keyword">typeof</span> <span class="token operator">===</span> <span class="token constant">TEXT</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token comment">//如果都是文本类型，则直接改文本</span></span>
<span class="line"><span class="token operator">+</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>oldElement<span class="token punctuation">.</span>content <span class="token operator">!==</span> newElement<span class="token punctuation">.</span>content<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line"><span class="token operator">+</span>            currentDOM<span class="token punctuation">.</span>textContent <span class="token operator">=</span> newElement<span class="token punctuation">.</span>content<span class="token punctuation">;</span></span>
<span class="line"><span class="token operator">+</span>        <span class="token punctuation">}</span></span>
<span class="line"><span class="token operator">+</span>    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>oldElement<span class="token punctuation">.</span>$$<span class="token keyword">typeof</span> <span class="token operator">===</span> <span class="token constant">ELEMENT</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line"><span class="token operator">+</span>        <span class="token function">updateDOMProps</span><span class="token punctuation">(</span>currentDOM<span class="token punctuation">,</span> oldElement<span class="token punctuation">.</span>props<span class="token punctuation">,</span> newElement<span class="token punctuation">.</span>props<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token operator">+</span>        oldElement<span class="token punctuation">.</span>props <span class="token operator">=</span> newElement<span class="token punctuation">.</span>props<span class="token punctuation">;</span></span>
<span class="line"><span class="token operator">+</span>    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>oldElement<span class="token punctuation">.</span>$$<span class="token keyword">typeof</span> <span class="token operator">===</span> <span class="token constant">CLASS_COMPONENT</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line"><span class="token operator">+</span>        <span class="token function">updateClassComponent</span><span class="token punctuation">(</span>oldElement<span class="token punctuation">,</span> newElement<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token operator">+</span>        newElement<span class="token punctuation">.</span>componentInstance <span class="token operator">=</span> oldElement<span class="token punctuation">.</span>componentInstance<span class="token punctuation">;</span></span>
<span class="line"><span class="token operator">+</span>    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>oldElement<span class="token punctuation">.</span>$$<span class="token keyword">typeof</span> <span class="token operator">===</span> <span class="token constant">FUNCTION_COMPONENT</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line"><span class="token operator">+</span>        <span class="token function">updateFunctionComponent</span><span class="token punctuation">(</span>oldElement<span class="token punctuation">,</span> newElement<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token operator">+</span>    <span class="token punctuation">}</span></span>
<span class="line"><span class="token operator">+</span><span class="token punctuation">}</span></span>
<span class="line"><span class="token operator">+</span><span class="token keyword">function</span> <span class="token function">updateDOMProps</span><span class="token punctuation">(</span><span class="token parameter">dom<span class="token punctuation">,</span> oldProps<span class="token punctuation">,</span> newProps</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line"><span class="token operator">+</span>    <span class="token keyword">return</span> <span class="token function">patchProps</span><span class="token punctuation">(</span>dom<span class="token punctuation">,</span> oldProps<span class="token punctuation">,</span> newProps<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token operator">+</span><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token operator">+</span><span class="token keyword">function</span> <span class="token function">updateClassComponent</span><span class="token punctuation">(</span><span class="token parameter">oldElement<span class="token punctuation">,</span> newElement</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line"><span class="token operator">+</span>    <span class="token keyword">let</span> componentInstance <span class="token operator">=</span> oldElement<span class="token punctuation">.</span>componentInstance<span class="token punctuation">;</span></span>
<span class="line"><span class="token operator">+</span>    <span class="token keyword">let</span> updater <span class="token operator">=</span> componentInstance<span class="token punctuation">.</span>$updater<span class="token punctuation">;</span></span>
<span class="line"><span class="token operator">+</span>    <span class="token keyword">let</span> nextProps <span class="token operator">=</span> newElement<span class="token punctuation">.</span>props<span class="token punctuation">;</span></span>
<span class="line"><span class="token operator">+</span>    updater<span class="token punctuation">.</span><span class="token function">emitUpdate</span><span class="token punctuation">(</span>nextProps<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token operator">+</span><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token operator">+</span><span class="token keyword">function</span> <span class="token function">updateFunctionComponent</span><span class="token punctuation">(</span><span class="token parameter">oldElement<span class="token punctuation">,</span> newElement</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line"><span class="token operator">+</span>    <span class="token keyword">let</span> newRenderElement <span class="token operator">=</span> newElement<span class="token punctuation">.</span><span class="token function">type</span><span class="token punctuation">(</span>newElement<span class="token punctuation">.</span>props<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token operator">+</span>    <span class="token keyword">var</span> oldRenderElement <span class="token operator">=</span> oldElement<span class="token punctuation">.</span>renderElement<span class="token punctuation">;</span></span>
<span class="line"><span class="token operator">+</span>    <span class="token keyword">var</span> currentElement <span class="token operator">=</span> <span class="token function">compareTwoElements</span><span class="token punctuation">(</span>oldRenderElement<span class="token punctuation">,</span> newRenderElement<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token operator">+</span>    newElement<span class="token punctuation">.</span>renderElement <span class="token operator">=</span> currentElement<span class="token punctuation">;</span></span>
<span class="line"><span class="token operator">+</span><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">ReactElement</span><span class="token punctuation">(</span><span class="token parameter">$$<span class="token keyword">typeof</span><span class="token punctuation">,</span> type<span class="token punctuation">,</span> key<span class="token punctuation">,</span> ref<span class="token punctuation">,</span> props</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">let</span> element <span class="token operator">=</span> <span class="token punctuation">{</span></span>
<span class="line">        $$<span class="token keyword">typeof</span><span class="token punctuation">,</span></span>
<span class="line">        type<span class="token punctuation">,</span></span>
<span class="line">        props<span class="token punctuation">,</span></span>
<span class="line">        key<span class="token punctuation">,</span></span>
<span class="line">        ref</span>
<span class="line">    <span class="token punctuation">}</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">return</span> element<span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_3-4-src-component-js" tabindex="-1"><a class="header-anchor" href="#_3-4-src-component-js"><span>3.4 src\\component.js</span></a></h3><p>src\\component.js</p><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text"><pre><code class="language-text"><span class="line">import { isFunction } from &#39;./utils&#39;;</span>
<span class="line">import { compareTwoElements } from &#39;./vdom&#39;;</span>
<span class="line">+export let updateQueue = {</span>
<span class="line">+    updaters: [],</span>
<span class="line">+    isPending: false,</span>
<span class="line">+    add(updater) {</span>
<span class="line">+        this.updaters.push(updater);</span>
<span class="line">+    },</span>
<span class="line">+    batchUpdate() {</span>
<span class="line">+        if (this.isPending) {</span>
<span class="line">+            return;</span>
<span class="line">+        }</span>
<span class="line">+        this.isPending = true;</span>
<span class="line">+        let { updaters } = this;</span>
<span class="line">+        let updater;</span>
<span class="line">+        while ((updater = updaters.pop())) {</span>
<span class="line">+            updater.updateComponent();</span>
<span class="line">+        }</span>
<span class="line">+        this.isPending = false;</span>
<span class="line">+    },</span>
<span class="line">+};</span>
<span class="line">+class Updater {</span>
<span class="line">+    constructor(instance) {</span>
<span class="line">+        this.instance = instance;</span>
<span class="line">+        this.pendingStates = [];</span>
<span class="line">+        this.nextProps = null;</span>
<span class="line">+    }</span>
<span class="line">+    addState(partialState) {</span>
<span class="line">+        this.pendingStates.push(partialState);</span>
<span class="line">+        this.emitUpdate();</span>
<span class="line">+    }</span>
<span class="line">+    emitUpdate(nextProps) {</span>
<span class="line">+        this.nextProps = nextProps;</span>
<span class="line">+        nextProps || !updateQueue.isPending</span>
<span class="line">+            ? this.updateComponent()</span>
<span class="line">+            : updateQueue.add(this);</span>
<span class="line">+    }</span>
<span class="line">+    updateComponent() {</span>
<span class="line">+        let { instance, pendingStates, nextProps } = this;</span>
<span class="line">+        if (nextProps || pendingStates.length &gt; 0) {</span>
<span class="line">+            shouldUpdate(</span>
<span class="line">+                instance,</span>
<span class="line">+                nextProps,</span>
<span class="line">+                this.getState()</span>
<span class="line">+            );</span>
<span class="line">+        }</span>
<span class="line">+    }</span>
<span class="line"></span>
<span class="line">+    getState() {</span>
<span class="line">+        let { instance, pendingStates } = this;</span>
<span class="line">+        let { state } = instance;</span>
<span class="line">+        if (pendingStates.length) {</span>
<span class="line">+            pendingStates.forEach(nextState =&gt; {</span>
<span class="line">+                if (isFunction(nextState)) {</span>
<span class="line">+                    nextState = nextState.call(instance, state);</span>
<span class="line">+                }</span>
<span class="line">+                state = { ...state, ...nextState };</span>
<span class="line">+            });</span>
<span class="line">+            pendingStates.length = 0;</span>
<span class="line">+        }</span>
<span class="line">+        return state;</span>
<span class="line">+    }</span>
<span class="line">+}</span>
<span class="line">+function shouldUpdate(component, nextProps, nextState) {</span>
<span class="line">+    component.props = nextProps;</span>
<span class="line">+    component.state = nextState;</span>
<span class="line">+    if (component.shouldComponentUpdate &amp;&amp; !component.shouldComponentUpdate(nextProps, nextState)) {</span>
<span class="line">+        return;</span>
<span class="line">+    }</span>
<span class="line">+    component.forceUpdate();</span>
<span class="line">+}</span>
<span class="line"></span>
<span class="line">class Component {</span>
<span class="line">    constructor(props) {</span>
<span class="line">        this.props = props;</span>
<span class="line">+        this.$updater = new Updater(this);</span>
<span class="line">+        this.state = {};</span>
<span class="line">+        this.nextProps = null;</span>
<span class="line">    }</span>
<span class="line">+    setState(partialState) {</span>
<span class="line">+        this.$updater.addState(partialState);</span>
<span class="line">+    }</span>
<span class="line">+    forceUpdate() {</span>
<span class="line">+        let { props, state, renderElement: oldRenderElement } = this;</span>
<span class="line">+        if (this.componentWillUpdate) {</span>
<span class="line">+            this.componentWillUpdate(props, state);</span>
<span class="line">+        }</span>
<span class="line">+        let newRenderElement = this.render();</span>
<span class="line">+        let currentElement = compareTwoElements(oldRenderElement, newRenderElement);</span>
<span class="line">+        this.renderElement = currentElement;</span>
<span class="line">+        if (this.componentDidUpdate) {</span>
<span class="line">+            this.componentDidUpdate(props, state);</span>
<span class="line">+        }</span>
<span class="line">+    }</span>
<span class="line">+}</span>
<span class="line">Component.prototype.isReactComponent = {};</span>
<span class="line">export {</span>
<span class="line">    Component</span>
<span class="line">}</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_3-5-react-event-js" tabindex="-1"><a class="header-anchor" href="#_3-5-react-event-js"><span>3.5 react\\event.js</span></a></h3><p>src\\react\\event.js</p><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text"><pre><code class="language-text"><span class="line">+import { updateQueue } from &#39;./component&#39;;</span>
<span class="line">export function addEvent(elem, eventType, listener) {</span>
<span class="line">    eventType = eventType.toLowerCase();</span>
<span class="line">    let eventStore = elem.eventStore || (elem.eventStore = {});</span>
<span class="line">    eventStore[eventType] = listener;</span>
<span class="line">    document.addEventListener(eventType.substr(2), dispatchEvent, false)</span>
<span class="line">}</span>
<span class="line">function dispatchEvent(event) {</span>
<span class="line">    let { target, type } = event</span>
<span class="line">    let eventType = &#39;on&#39; + type;</span>
<span class="line">    let syntheticEvent;</span>
<span class="line">+   updateQueue.isPending = true;</span>
<span class="line">    while (target) {</span>
<span class="line">        let { eventStore } = target</span>
<span class="line">        let listener = eventStore &amp;&amp; eventStore[eventType];</span>
<span class="line">        if (listener) {</span>
<span class="line">            if (!syntheticEvent) {</span>
<span class="line">                syntheticEvent = createSyntheticEvent(event);</span>
<span class="line">            }</span>
<span class="line">            syntheticEvent.currentTarget = target;</span>
<span class="line">            listener.call(target, syntheticEvent);</span>
<span class="line">        }</span>
<span class="line">        target = target.parentNode;</span>
<span class="line">    }</span>
<span class="line">+    updateQueue.isPending = false;</span>
<span class="line">+    updateQueue.batchUpdate();</span>
<span class="line">}</span>
<span class="line">function createSyntheticEvent(nativeEvent) {</span>
<span class="line">    let syntheticEvent = {}</span>
<span class="line">    syntheticEvent.nativeEvent = nativeEvent</span>
<span class="line">    for (let key in nativeEvent) {</span>
<span class="line">        if (typeof nativeEvent[key] == &#39;function&#39;) {</span>
<span class="line">            syntheticEvent[key] = nativeEvent[key].bind(nativeEvent)</span>
<span class="line">        } else {</span>
<span class="line">            syntheticEvent[key] = nativeEvent[key]</span>
<span class="line">        }</span>
<span class="line">    }</span>
<span class="line">    return syntheticEvent</span>
<span class="line">}</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="_4-比较更新子节点" tabindex="-1"><a class="header-anchor" href="#_4-比较更新子节点"><span>4. 比较更新子节点</span></a></h2><h3 id="_4-1-深度优先遍历" tabindex="-1"><a class="header-anchor" href="#_4-1-深度优先遍历"><span>4.1 深度优先遍历</span></a></h3><p><img src="http://img.zhufengpeixun.cn/domdiff2.jpg" alt="domdiff2"></p><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code class="language-javascript"><span class="line"></span>
<span class="line"><span class="token keyword">let</span> tree <span class="token operator">=</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token literal-property property">value</span><span class="token operator">:</span> <span class="token string">&#39;A&#39;</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token literal-property property">left</span><span class="token operator">:</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token literal-property property">value</span><span class="token operator">:</span> <span class="token string">&#39;B&#39;</span><span class="token punctuation">,</span></span>
<span class="line">        <span class="token literal-property property">left</span><span class="token operator">:</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token literal-property property">value</span><span class="token operator">:</span> <span class="token string">&#39;D&#39;</span><span class="token punctuation">,</span></span>
<span class="line"></span>
<span class="line">        <span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">        <span class="token literal-property property">right</span><span class="token operator">:</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token literal-property property">value</span><span class="token operator">:</span> <span class="token string">&#39;E&#39;</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">    <span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token literal-property property">right</span><span class="token operator">:</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token literal-property property">value</span><span class="token operator">:</span> <span class="token string">&#39;C&#39;</span><span class="token punctuation">,</span></span>
<span class="line">        <span class="token literal-property property">left</span><span class="token operator">:</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token literal-property property">value</span><span class="token operator">:</span> <span class="token string">&#39;F&#39;</span><span class="token punctuation">,</span></span>
<span class="line"></span>
<span class="line">        <span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">        <span class="token literal-property property">right</span><span class="token operator">:</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token literal-property property">value</span><span class="token operator">:</span> <span class="token string">&#39;G&#39;</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"><span class="token keyword">let</span> depth <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">function</span> <span class="token function">visit</span><span class="token punctuation">(</span><span class="token parameter">tree</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    depth<span class="token operator">++</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">if</span> <span class="token punctuation">(</span>tree<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>depth<span class="token punctuation">,</span> tree<span class="token punctuation">.</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token function">visit</span><span class="token punctuation">(</span>tree<span class="token punctuation">.</span>left<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token function">visit</span><span class="token punctuation">(</span>tree<span class="token punctuation">.</span>right<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    depth<span class="token operator">--</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"><span class="token function">visit</span><span class="token punctuation">(</span>tree<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>depth<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_4-2-src-index-js" tabindex="-1"><a class="header-anchor" href="#_4-2-src-index-js"><span>4.2 src\\index.js</span></a></h3><p>src\\index.js</p><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code class="language-javascript"><span class="line"><span class="token keyword">import</span> React <span class="token keyword">from</span> <span class="token string">&#39;./react&#39;</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">import</span> ReactDOM <span class="token keyword">from</span> <span class="token string">&#39;./react-dom&#39;</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">class</span> <span class="token class-name">Counter</span> <span class="token keyword">extends</span> <span class="token class-name">React<span class="token punctuation">.</span>Component</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter">props</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">super</span><span class="token punctuation">(</span>props<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">this</span><span class="token punctuation">.</span>state <span class="token operator">=</span> <span class="token punctuation">{</span> <span class="token literal-property property">number</span><span class="token operator">:</span> <span class="token number">0</span> <span class="token punctuation">}</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    <span class="token function-variable function">handleClick</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">setState</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token literal-property property">number</span><span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">.</span>number <span class="token operator">+</span> <span class="token number">1</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">.</span>number<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">setState</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token literal-property property">number</span><span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">.</span>number <span class="token operator">+</span> <span class="token number">1</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">.</span>number<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">setState</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token literal-property property">number</span><span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">.</span>number <span class="token operator">+</span> <span class="token number">1</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">            console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">.</span>number<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    <span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">let</span> p <span class="token operator">=</span> React<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">&#39;p&#39;</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> <span class="token literal-property property">style</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token literal-property property">color</span><span class="token operator">:</span> <span class="token string">&#39;red&#39;</span> <span class="token punctuation">}</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">.</span>number<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">let</span> button <span class="token operator">=</span> React<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">&#39;button&#39;</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> <span class="token literal-property property">onClick</span><span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>handleClick <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token string">&#39;+&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">return</span> React<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">&#39;div&#39;</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> <span class="token literal-property property">id</span><span class="token operator">:</span> <span class="token string">&#39;counter&#39;</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> p<span class="token punctuation">,</span> button<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"><span class="token keyword">let</span> element <span class="token operator">=</span> React<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span>Counter<span class="token punctuation">,</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">ReactDOM<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span></span>
<span class="line">    element<span class="token punctuation">,</span></span>
<span class="line">    document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">&#39;root&#39;</span><span class="token punctuation">)</span></span>
<span class="line"><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_4-3-react-utils-js" tabindex="-1"><a class="header-anchor" href="#_4-3-react-utils-js"><span>4.3 react\\utils.js</span></a></h3><p>src\\react\\utils.js</p><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code class="language-javascript"><span class="line"><span class="token keyword">import</span> <span class="token punctuation">{</span> addEvent <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&#39;./event&#39;</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">setProps</span><span class="token punctuation">(</span><span class="token parameter">elem<span class="token punctuation">,</span> props</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> key <span class="token keyword">in</span> props<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">if</span> <span class="token punctuation">(</span>key <span class="token operator">!==</span> <span class="token string">&#39;children&#39;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token keyword">let</span> value <span class="token operator">=</span> props<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">;</span></span>
<span class="line">            <span class="token function">setProp</span><span class="token punctuation">(</span>elem<span class="token punctuation">,</span> key<span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"><span class="token keyword">function</span> <span class="token function">setProp</span><span class="token punctuation">(</span><span class="token parameter">elem<span class="token punctuation">,</span> key<span class="token punctuation">,</span> value</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">^on</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">.</span><span class="token function">test</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token function">addEvent</span><span class="token punctuation">(</span>elem<span class="token punctuation">,</span> key<span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>key <span class="token operator">===</span> <span class="token string">&#39;style&#39;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">if</span> <span class="token punctuation">(</span>value<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> styleName <span class="token keyword">in</span> value<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">                <span class="token keyword">if</span> <span class="token punctuation">(</span>value<span class="token punctuation">.</span><span class="token function">hasOwnProperty</span><span class="token punctuation">(</span>styleName<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">                    elem<span class="token punctuation">.</span>style<span class="token punctuation">[</span>styleName<span class="token punctuation">]</span> <span class="token operator">=</span> value<span class="token punctuation">[</span>styleName<span class="token punctuation">]</span><span class="token punctuation">;</span></span>
<span class="line">                <span class="token punctuation">}</span></span>
<span class="line">            <span class="token punctuation">}</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span></span>
<span class="line">        elem<span class="token punctuation">.</span><span class="token function">setAttribute</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    <span class="token keyword">return</span> elem<span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">patchProps</span><span class="token punctuation">(</span><span class="token parameter">elem<span class="token punctuation">,</span> oldProps<span class="token punctuation">,</span> newProps</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> key <span class="token keyword">in</span> oldProps<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">if</span> <span class="token punctuation">(</span>key <span class="token operator">!==</span> <span class="token string">&#39;children&#39;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token keyword">if</span> <span class="token punctuation">(</span>newProps<span class="token punctuation">.</span><span class="token function">hasOwnProperty</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">                <span class="token function">setProp</span><span class="token punctuation">(</span>elem<span class="token punctuation">,</span> key<span class="token punctuation">,</span> newProps<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span></span>
<span class="line">                elem<span class="token punctuation">.</span><span class="token function">removeAttribute</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">            <span class="token punctuation">}</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> key <span class="token keyword">in</span> newProps<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">if</span> <span class="token punctuation">(</span>key <span class="token operator">!==</span> <span class="token string">&#39;children&#39;</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>newProps<span class="token punctuation">.</span><span class="token function">hasOwnProperty</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token function">setProp</span><span class="token punctuation">(</span>elem<span class="token punctuation">,</span> key<span class="token punctuation">,</span> newProps<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">)</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"><span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">onlyOne</span><span class="token punctuation">(</span><span class="token parameter">obj</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">return</span> Array<span class="token punctuation">.</span><span class="token function">isArray</span><span class="token punctuation">(</span>obj<span class="token punctuation">)</span> <span class="token operator">?</span> obj<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">:</span> obj<span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">isFunction</span><span class="token punctuation">(</span><span class="token parameter">obj</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">return</span> <span class="token keyword">typeof</span> obj <span class="token operator">===</span> <span class="token string">&#39;function&#39;</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_4-4-react-vdom-js" tabindex="-1"><a class="header-anchor" href="#_4-4-react-vdom-js"><span>4.4 react\\vdom.js</span></a></h3><p>src\\react\\vdom.js</p><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code class="language-javascript"><span class="line"><span class="token keyword">import</span> <span class="token punctuation">{</span> <span class="token constant">TEXT</span><span class="token punctuation">,</span> <span class="token constant">ELEMENT</span><span class="token punctuation">,</span> <span class="token constant">FUNCTION_COMPONENT</span><span class="token punctuation">,</span> <span class="token constant">CLASS_COMPONENT</span> <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&#39;./constants&#39;</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token operator">+</span><span class="token keyword">import</span> <span class="token punctuation">{</span> setProps<span class="token punctuation">,</span> onlyOne<span class="token punctuation">,</span> patchProps<span class="token punctuation">,</span> deepEqual <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&#39;./utils&#39;</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">createDOM</span><span class="token punctuation">(</span><span class="token parameter">element</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    element <span class="token operator">=</span> <span class="token function">onlyOne</span><span class="token punctuation">(</span>element<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">let</span> <span class="token punctuation">{</span> $$<span class="token keyword">typeof</span> <span class="token punctuation">}</span> <span class="token operator">=</span> element<span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">let</span> dom <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>$$<span class="token keyword">typeof</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        dom <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">createTextNode</span><span class="token punctuation">(</span>element<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>$$<span class="token keyword">typeof</span> <span class="token operator">===</span> <span class="token constant">TEXT</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        dom <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">createTextNode</span><span class="token punctuation">(</span>element<span class="token punctuation">.</span>content<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>$$<span class="token keyword">typeof</span> <span class="token operator">===</span> <span class="token constant">ELEMENT</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        dom <span class="token operator">=</span> <span class="token function">createNativeDOM</span><span class="token punctuation">(</span>element<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>$$<span class="token keyword">typeof</span> <span class="token operator">===</span> <span class="token constant">FUNCTION_COMPONENT</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        dom <span class="token operator">=</span> <span class="token function">createFunctionComponentDOM</span><span class="token punctuation">(</span>element<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>$$<span class="token keyword">typeof</span> <span class="token operator">===</span> <span class="token constant">CLASS_COMPONENT</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        dom <span class="token operator">=</span> <span class="token function">createClassComponentDOM</span><span class="token punctuation">(</span>element<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    element<span class="token punctuation">.</span>dom <span class="token operator">=</span> dom<span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">return</span> dom<span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">function</span> <span class="token function">createNativeDOM</span><span class="token punctuation">(</span><span class="token parameter">element</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">let</span> <span class="token punctuation">{</span> type<span class="token punctuation">,</span> props <span class="token punctuation">}</span> <span class="token operator">=</span> element<span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">let</span> dom <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span>type<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token function">createChildren</span><span class="token punctuation">(</span>element<span class="token punctuation">,</span> dom<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token function">setProps</span><span class="token punctuation">(</span>dom<span class="token punctuation">,</span> props<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">return</span> dom<span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">function</span> <span class="token function">createChildren</span><span class="token punctuation">(</span><span class="token parameter">element<span class="token punctuation">,</span> parentNode</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    element<span class="token punctuation">.</span>props<span class="token punctuation">.</span>children <span class="token operator">&amp;&amp;</span> <span class="token function">flatten</span><span class="token punctuation">(</span>element<span class="token punctuation">.</span>props<span class="token punctuation">.</span>children<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">childElement<span class="token punctuation">,</span> index</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></span>
<span class="line">        childElement<span class="token punctuation">.</span>_mountIndex <span class="token operator">=</span> index<span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">let</span> childDOM <span class="token operator">=</span> <span class="token function">createDOM</span><span class="token punctuation">(</span>childElement<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        childElement<span class="token punctuation">.</span>dom <span class="token operator">=</span> childDOM<span class="token punctuation">;</span></span>
<span class="line">        parentNode<span class="token punctuation">.</span><span class="token function">appendChild</span><span class="token punctuation">(</span>childDOM<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"><span class="token keyword">function</span> <span class="token function">createFunctionComponentDOM</span><span class="token punctuation">(</span><span class="token parameter">element</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">let</span> <span class="token punctuation">{</span> type<span class="token punctuation">,</span> props <span class="token punctuation">}</span> <span class="token operator">=</span> element<span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">let</span> renderElement <span class="token operator">=</span> <span class="token function">type</span><span class="token punctuation">(</span>props<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    element<span class="token punctuation">.</span>renderElement <span class="token operator">=</span> renderElement<span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">let</span> newDOM <span class="token operator">=</span> <span class="token function">createDOM</span><span class="token punctuation">(</span>renderElement<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    renderElement<span class="token punctuation">.</span>dom <span class="token operator">=</span> newDOM<span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">return</span> newDOM<span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"><span class="token keyword">function</span> <span class="token function">createClassComponentDOM</span><span class="token punctuation">(</span><span class="token parameter">element</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">let</span> <span class="token punctuation">{</span> type<span class="token punctuation">,</span> props <span class="token punctuation">}</span> <span class="token operator">=</span> element<span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">let</span> componentInstance <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">type</span><span class="token punctuation">(</span>props<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    element<span class="token punctuation">.</span>componentInstance <span class="token operator">=</span> componentInstance<span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">let</span> renderElement <span class="token operator">=</span> componentInstance<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    componentInstance<span class="token punctuation">.</span>renderElement <span class="token operator">=</span> renderElement<span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">let</span> newDOM <span class="token operator">=</span> <span class="token function">createDOM</span><span class="token punctuation">(</span>renderElement<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">return</span> newDOM<span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"><span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">compareTwoElements</span><span class="token punctuation">(</span><span class="token parameter">oldElement<span class="token punctuation">,</span> newElement</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    oldElement <span class="token operator">=</span> <span class="token function">onlyOne</span><span class="token punctuation">(</span>oldElement<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    newElement <span class="token operator">=</span> <span class="token function">onlyOne</span><span class="token punctuation">(</span>newElement<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">let</span> currentDOM <span class="token operator">=</span> oldElement<span class="token punctuation">.</span>dom<span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">let</span> currentElement <span class="token operator">=</span> oldElement<span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">if</span> <span class="token punctuation">(</span>newElement <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token comment">//如果新节点没有了，直接删除拉倒</span></span>
<span class="line">        currentDOM<span class="token punctuation">.</span>parentNode<span class="token punctuation">.</span><span class="token function">removeChild</span><span class="token punctuation">(</span>currentDOM<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        currentElement <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>oldElement<span class="token punctuation">.</span>type <span class="token operator">!==</span> newElement<span class="token punctuation">.</span>type<span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token comment">//如果类型不同</span></span>
<span class="line">        <span class="token keyword">let</span> newDOM <span class="token operator">=</span> <span class="token function">createDOM</span><span class="token punctuation">(</span>newElement<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        currentDOM<span class="token punctuation">.</span>parentNode<span class="token punctuation">.</span><span class="token function">replaceChild</span><span class="token punctuation">(</span>newDOM<span class="token punctuation">,</span> currentDOM<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        currentElement <span class="token operator">=</span> newElement<span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token function">updateElement</span><span class="token punctuation">(</span>oldElement<span class="token punctuation">,</span> newElement<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    <span class="token keyword">return</span> currentElement<span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">function</span> <span class="token function">updateElement</span><span class="token punctuation">(</span><span class="token parameter">oldElement<span class="token punctuation">,</span> newElement</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">let</span> currentDOM <span class="token operator">=</span> newElement<span class="token punctuation">.</span>dom <span class="token operator">=</span> oldElement<span class="token punctuation">.</span>dom<span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">if</span> <span class="token punctuation">(</span>oldElement<span class="token punctuation">.</span>$$<span class="token keyword">typeof</span> <span class="token operator">===</span> <span class="token constant">TEXT</span> <span class="token operator">&amp;&amp;</span> newElement<span class="token punctuation">.</span>$$<span class="token keyword">typeof</span> <span class="token operator">===</span> <span class="token constant">TEXT</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token comment">//如果都是文本类型，则直接改文本</span></span>
<span class="line">        <span class="token keyword">if</span> <span class="token punctuation">(</span>oldElement<span class="token punctuation">.</span>content <span class="token operator">!==</span> newElement<span class="token punctuation">.</span>content<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">            currentDOM<span class="token punctuation">.</span>textContent <span class="token operator">=</span> newElement<span class="token punctuation">.</span>content<span class="token punctuation">;</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>oldElement<span class="token punctuation">.</span>$$<span class="token keyword">typeof</span> <span class="token operator">===</span> <span class="token constant">ELEMENT</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line"><span class="token operator">+</span>        <span class="token function">updateChildrenElements</span><span class="token punctuation">(</span>currentDOM<span class="token punctuation">,</span> oldElement<span class="token punctuation">.</span>props<span class="token punctuation">.</span>children<span class="token punctuation">,</span> newElement<span class="token punctuation">.</span>props<span class="token punctuation">.</span>children<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token function">updateDOMProps</span><span class="token punctuation">(</span>currentDOM<span class="token punctuation">,</span> oldElement<span class="token punctuation">.</span>props<span class="token punctuation">,</span> newElement<span class="token punctuation">.</span>props<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        oldElement<span class="token punctuation">.</span>props <span class="token operator">=</span> newElement<span class="token punctuation">.</span>props<span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>oldElement<span class="token punctuation">.</span>$$<span class="token keyword">typeof</span> <span class="token operator">===</span> <span class="token constant">CLASS_COMPONENT</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token function">updateClassComponent</span><span class="token punctuation">(</span>oldElement<span class="token punctuation">,</span> newElement<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        newElement<span class="token punctuation">.</span>componentInstance <span class="token operator">=</span> oldElement<span class="token punctuation">.</span>componentInstance<span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>oldElement<span class="token punctuation">.</span>$$<span class="token keyword">typeof</span> <span class="token operator">===</span> <span class="token constant">FUNCTION_COMPONENT</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token function">updateFunctionComponent</span><span class="token punctuation">(</span>oldElement<span class="token punctuation">,</span> newElement<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token operator">+</span><span class="token keyword">function</span> <span class="token function">updateChildrenElements</span><span class="token punctuation">(</span><span class="token parameter">dom<span class="token punctuation">,</span> oldChildrenElements<span class="token punctuation">,</span> newChildrenElement</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line"><span class="token operator">+</span>    <span class="token function">diff</span><span class="token punctuation">(</span>dom<span class="token punctuation">,</span> oldChildrenElements<span class="token punctuation">,</span> newChildrenElement<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token operator">+</span><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token operator">+</span><span class="token keyword">function</span> <span class="token function">diff</span><span class="token punctuation">(</span><span class="token parameter">parentNode<span class="token punctuation">,</span> oldChildrenElements<span class="token punctuation">,</span> newChildrenElements</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line"><span class="token operator">+</span>    <span class="token keyword">let</span> oldChildrenElementMap <span class="token operator">=</span> <span class="token function">getChildrenElementMap</span><span class="token punctuation">(</span>oldChildrenElements<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token operator">+</span>    <span class="token keyword">let</span> newChildrenElementMap <span class="token operator">=</span> <span class="token function">getNewChildren</span><span class="token punctuation">(</span>oldChildrenElementMap<span class="token punctuation">,</span> newChildrenElements<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token operator">+</span><span class="token punctuation">}</span></span>
<span class="line"><span class="token operator">+</span><span class="token keyword">function</span> <span class="token function">getChildrenElementMap</span><span class="token punctuation">(</span><span class="token parameter">childrenElements</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line"><span class="token operator">+</span>    <span class="token keyword">let</span> childrenElementMap <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token operator">+</span>    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> childrenElements<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line"><span class="token operator">+</span>        <span class="token keyword">let</span> key <span class="token operator">=</span> childrenElements<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>key <span class="token operator">||</span> i<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token operator">+</span>        childrenElementMap<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">=</span> childrenElements<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token operator">+</span>    <span class="token punctuation">}</span></span>
<span class="line"><span class="token operator">+</span>    <span class="token keyword">return</span> childrenElementMap<span class="token punctuation">;</span></span>
<span class="line"><span class="token operator">+</span><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token operator">+</span><span class="token keyword">function</span> <span class="token function">getNewChildren</span><span class="token punctuation">(</span><span class="token parameter">oldChildrenElementMap<span class="token punctuation">,</span> newChildrenElements</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line"><span class="token operator">+</span>    <span class="token keyword">let</span> newChildrenElementMap <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token operator">+</span>    newChildrenElements<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">newChildElement<span class="token punctuation">,</span> index</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></span>
<span class="line"><span class="token operator">+</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>newChildElement<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line"><span class="token operator">+</span>            <span class="token keyword">let</span> newKey <span class="token operator">=</span> newChildElement<span class="token punctuation">.</span>key <span class="token operator">||</span> index<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token operator">+</span>            <span class="token keyword">let</span> oldChildElement <span class="token operator">=</span> oldChildrenElementMap<span class="token punctuation">[</span>newKey<span class="token punctuation">]</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token operator">+</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">canDeepCompare</span><span class="token punctuation">(</span>oldChildElement<span class="token punctuation">,</span> newChildElement<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line"><span class="token operator">+</span>                <span class="token function">updateElement</span><span class="token punctuation">(</span>oldChildElement<span class="token punctuation">,</span> newChildElement<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token operator">+</span>                newChildrenElements<span class="token punctuation">[</span>index<span class="token punctuation">]</span> <span class="token operator">=</span> oldChildElement<span class="token punctuation">;</span></span>
<span class="line"><span class="token operator">+</span>            <span class="token punctuation">}</span></span>
<span class="line"><span class="token operator">+</span>            newChildrenElementMap<span class="token punctuation">[</span>newKey<span class="token punctuation">]</span> <span class="token operator">=</span> newChildrenElements<span class="token punctuation">[</span>index<span class="token punctuation">]</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token operator">+</span>        <span class="token punctuation">}</span></span>
<span class="line"><span class="token operator">+</span>    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token operator">+</span>    <span class="token keyword">return</span> newChildrenElementMap<span class="token punctuation">;</span></span>
<span class="line"><span class="token operator">+</span><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token operator">+</span><span class="token keyword">function</span> <span class="token function">canDeepCompare</span><span class="token punctuation">(</span><span class="token parameter">oldChildElement<span class="token punctuation">,</span> newChildElement</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line"><span class="token operator">+</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token operator">!</span>oldChildElement <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token operator">!</span>newChildElement<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line"><span class="token operator">+</span>        <span class="token keyword">return</span> oldChildElement<span class="token punctuation">.</span>type <span class="token operator">===</span> newChildElement<span class="token punctuation">.</span>type<span class="token punctuation">;</span></span>
<span class="line"><span class="token operator">+</span>    <span class="token punctuation">}</span></span>
<span class="line"><span class="token operator">+</span>    <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token operator">+</span><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token operator">+</span><span class="token keyword">function</span> <span class="token function">updateDOMProps</span><span class="token punctuation">(</span><span class="token parameter">dom<span class="token punctuation">,</span> oldProps<span class="token punctuation">,</span> newProps</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line"><span class="token operator">+</span>    <span class="token function">patchProps</span><span class="token punctuation">(</span>dom<span class="token punctuation">,</span> oldProps<span class="token punctuation">,</span> newProps<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token operator">+</span><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">function</span> <span class="token function">updateClassComponent</span><span class="token punctuation">(</span><span class="token parameter">oldElement<span class="token punctuation">,</span> newElement</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">let</span> componentInstance <span class="token operator">=</span> oldElement<span class="token punctuation">.</span>componentInstance<span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">let</span> updater <span class="token operator">=</span> componentInstance<span class="token punctuation">.</span>$updater<span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">let</span> nextProps <span class="token operator">=</span> newElement<span class="token punctuation">.</span>props<span class="token punctuation">;</span></span>
<span class="line">    updater<span class="token punctuation">.</span><span class="token function">emitUpdate</span><span class="token punctuation">(</span>nextProps<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"><span class="token keyword">function</span> <span class="token function">updateFunctionComponent</span><span class="token punctuation">(</span><span class="token parameter">oldElement<span class="token punctuation">,</span> newElement</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">let</span> newRenderElement <span class="token operator">=</span> newElement<span class="token punctuation">.</span><span class="token function">type</span><span class="token punctuation">(</span>newElement<span class="token punctuation">.</span>props<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">var</span> oldRenderElement <span class="token operator">=</span> oldElement<span class="token punctuation">.</span>renderElement<span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">var</span> currentElement <span class="token operator">=</span> <span class="token function">compareTwoElements</span><span class="token punctuation">(</span>oldRenderElement<span class="token punctuation">,</span> newRenderElement<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    newElement<span class="token punctuation">.</span>renderElement <span class="token operator">=</span> currentElement<span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">ReactElement</span><span class="token punctuation">(</span><span class="token parameter">$$<span class="token keyword">typeof</span><span class="token punctuation">,</span> type<span class="token punctuation">,</span> key<span class="token punctuation">,</span> ref<span class="token punctuation">,</span> props</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">let</span> element <span class="token operator">=</span> <span class="token punctuation">{</span></span>
<span class="line">        $$<span class="token keyword">typeof</span><span class="token punctuation">,</span></span>
<span class="line">        type<span class="token punctuation">,</span></span>
<span class="line">        props<span class="token punctuation">,</span></span>
<span class="line">        key<span class="token punctuation">,</span></span>
<span class="line">        ref</span>
<span class="line">    <span class="token punctuation">}</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">return</span> element<span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="_5-key的处理" tabindex="-1"><a class="header-anchor" href="#_5-key的处理"><span>5. key的处理</span></a></h2><h3 id="_5-1-src-index-js" tabindex="-1"><a class="header-anchor" href="#_5-1-src-index-js"><span>5.1 src\\index.js</span></a></h3><p>src\\index.js</p><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text"><pre><code class="language-text"><span class="line">import React from &#39;./react&#39;;</span>
<span class="line">import ReactDOM from &#39;./react-dom&#39;;</span>
<span class="line"></span>
<span class="line">+class App extends React.Component {</span>
<span class="line">+    constructor(props) {</span>
<span class="line">+        super(props);</span>
<span class="line">+        this.state = { odd: true };</span>
<span class="line">+        setTimeout(() =&gt; {</span>
<span class="line">+            this.setState({ odd: !this.state.odd });</span>
<span class="line">+        }, 1000);</span>
<span class="line">+    }</span>
<span class="line">+    handleClick = () =&gt; {</span>
<span class="line">+        this.setState({ number: this.state.number + 1 });</span>
<span class="line">+    }</span>
<span class="line">+    render() {</span>
<span class="line">+        if (this.state.odd) {</span>
<span class="line">+            return React.createElement(&#39;ul&#39;, { key: &#39;wrapper&#39; },</span>
<span class="line">+                React.createElement(&#39;li&#39;, { key: &#39;A&#39; }, &#39;A&#39;),</span>
<span class="line">+                React.createElement(&#39;li&#39;, { key: &#39;B&#39; }, &#39;B&#39;),</span>
<span class="line">+                React.createElement(&#39;li&#39;, { key: &#39;C&#39; }, &#39;C&#39;),</span>
<span class="line">+                React.createElement(&#39;li&#39;, { key: &#39;D&#39; }, &#39;D&#39;),</span>
<span class="line">+            );</span>
<span class="line">+        } else {</span>
<span class="line">+            return React.createElement(&#39;ul&#39;, { key: &#39;wrapper&#39; },</span>
<span class="line">+                React.createElement(&#39;li&#39;, { key: &#39;A&#39; }, &#39;A&#39;),</span>
<span class="line">+                React.createElement(&#39;li&#39;, { key: &#39;C&#39; }, &#39;C1&#39;),</span>
<span class="line">+                React.createElement(&#39;li&#39;, { key: &#39;B&#39; }, &#39;B1&#39;),</span>
<span class="line">+                React.createElement(&#39;li&#39;, { key: &#39;E&#39; }, &#39;E1&#39;),</span>
<span class="line">+                React.createElement(&#39;li&#39;, { key: &#39;F&#39; }, &#39;F1&#39;)</span>
<span class="line">+            );</span>
<span class="line">+        }</span>
<span class="line">+    }</span>
<span class="line">+}</span>
<span class="line"></span>
<span class="line">+class Todos extends React.Component {</span>
<span class="line">+    constructor(props) {</span>
<span class="line">+        super(props);</span>
<span class="line">+        this.state = { list: [], text: &#39;&#39; };</span>
<span class="line">+    }</span>
<span class="line">+    add = () =&gt; {</span>
<span class="line">+        if (this.state.text &amp;&amp; this.state.text.length &gt; 0) {</span>
<span class="line">+            this.setState({ list: [...this.state.list, this.state.text] });</span>
<span class="line">+        }</span>
<span class="line">+    }</span>
<span class="line">+    onChange = (event) =&gt; {</span>
<span class="line">+        this.setState({ text: event.target.value });</span>
<span class="line">+    }</span>
<span class="line">+    onDel = (index) =&gt; {</span>
<span class="line">+        this.state.list.splice(index, 1);</span>
<span class="line">+        this.setState({ list: this.state.list });</span>
<span class="line">+    }</span>
<span class="line">+    render() {</span>
<span class="line">+        var createItem = (itemText, index) =&gt; {</span>
<span class="line">+            return React.createElement(&quot;li&quot;, {}, itemText, React.createElement(&#39;button&#39;,</span>
<span class="line">+                { onClick: () =&gt; this.onDel(index) }, &#39;X&#39;));</span>
<span class="line">+        };</span>
<span class="line">+        var lists = this.state.list.map(createItem);</span>
<span class="line">+        let ul = React.createElement(&quot;ul&quot;, {}, ...lists);</span>
<span class="line">+        var input = React.createElement(&quot;input&quot;, { onKeyup: this.onChange, value: this.state.text });</span>
<span class="line">+        var button = React.createElement(&quot;button&quot;, { onClick: this.add }, &#39;Add&#39;)</span>
<span class="line">+        return React.createElement(&#39;div&#39;, {}, input, button, ul);</span>
<span class="line">+    }</span>
<span class="line">+}</span>
<span class="line">let element = React.createElement(Todos, {});</span>
<span class="line">ReactDOM.render(</span>
<span class="line">    element,</span>
<span class="line">    document.getElementById(&#39;root&#39;)</span>
<span class="line">);</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_5-2-react-constants-js" tabindex="-1"><a class="header-anchor" href="#_5-2-react-constants-js"><span>5.2 react\\constants.js</span></a></h3><p>src\\react\\constants.js</p><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text"><pre><code class="language-text"><span class="line">export const TEXT = Symbol.for(&#39;TEXT&#39;);</span>
<span class="line">export const ELEMENT = Symbol.for(&#39;ELEMENT&#39;);</span>
<span class="line">export const FUNCTION_COMPONENT = Symbol.for(&#39;FUNCTION_COMPONENT&#39;);</span>
<span class="line">export const CLASS_COMPONENT = Symbol.for(&#39;CLASS_COMPONENT&#39;);</span>
<span class="line"></span>
<span class="line">+export const MOVE = &#39;MOVE&#39;;</span>
<span class="line">+export const INSERT = &#39;INSERT&#39;;</span>
<span class="line">+export const REMOVE = &#39;REMOVE&#39;;</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_5-3-react-vdom-js" tabindex="-1"><a class="header-anchor" href="#_5-3-react-vdom-js"><span>5.3 react\\vdom.js</span></a></h3><p>src\\react\\vdom.js</p><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code class="language-javascript"><span class="line"><span class="token operator">+</span><span class="token keyword">import</span> <span class="token punctuation">{</span> <span class="token constant">TEXT</span><span class="token punctuation">,</span> <span class="token constant">ELEMENT</span><span class="token punctuation">,</span> <span class="token constant">FUNCTION_COMPONENT</span><span class="token punctuation">,</span> <span class="token constant">CLASS_COMPONENT</span><span class="token punctuation">,</span> <span class="token constant">MOVE</span><span class="token punctuation">,</span> <span class="token constant">INSERT</span><span class="token punctuation">,</span> <span class="token constant">REMOVE</span> <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&#39;./constants&#39;</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token operator">+</span><span class="token keyword">import</span> <span class="token punctuation">{</span> setProps<span class="token punctuation">,</span> onlyOne<span class="token punctuation">,</span>flatten<span class="token punctuation">,</span> patchProps<span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&#39;./utils&#39;</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token operator">+</span><span class="token keyword">const</span> diffQueue <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token operator">+</span><span class="token keyword">let</span> updateDepth <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">createDOM</span><span class="token punctuation">(</span><span class="token parameter">element</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    element <span class="token operator">=</span> <span class="token function">onlyOne</span><span class="token punctuation">(</span>element<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">let</span> <span class="token punctuation">{</span> $$<span class="token keyword">typeof</span> <span class="token punctuation">}</span> <span class="token operator">=</span> element<span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">let</span> dom <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>$$<span class="token keyword">typeof</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        dom <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">createTextNode</span><span class="token punctuation">(</span>element<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>$$<span class="token keyword">typeof</span> <span class="token operator">===</span> <span class="token constant">TEXT</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        dom <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">createTextNode</span><span class="token punctuation">(</span>element<span class="token punctuation">.</span>content<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>$$<span class="token keyword">typeof</span> <span class="token operator">===</span> <span class="token constant">ELEMENT</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        dom <span class="token operator">=</span> <span class="token function">createNativeDOM</span><span class="token punctuation">(</span>element<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>$$<span class="token keyword">typeof</span> <span class="token operator">===</span> <span class="token constant">FUNCTION_COMPONENT</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        dom <span class="token operator">=</span> <span class="token function">createFunctionComponentDOM</span><span class="token punctuation">(</span>element<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>$$<span class="token keyword">typeof</span> <span class="token operator">===</span> <span class="token constant">CLASS_COMPONENT</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        dom <span class="token operator">=</span> <span class="token function">createClassComponentDOM</span><span class="token punctuation">(</span>element<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    element<span class="token punctuation">.</span>dom <span class="token operator">=</span> dom<span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">return</span> dom<span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">function</span> <span class="token function">createNativeDOM</span><span class="token punctuation">(</span><span class="token parameter">element</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">let</span> <span class="token punctuation">{</span> type<span class="token punctuation">,</span> props <span class="token punctuation">}</span> <span class="token operator">=</span> element<span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">let</span> dom <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span>type<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token function">createChildren</span><span class="token punctuation">(</span>element<span class="token punctuation">,</span> dom<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token function">setProps</span><span class="token punctuation">(</span>dom<span class="token punctuation">,</span> props<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">return</span> dom<span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">function</span> <span class="token function">createChildren</span><span class="token punctuation">(</span><span class="token parameter">element<span class="token punctuation">,</span> parentNode</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    element<span class="token punctuation">.</span>props<span class="token punctuation">.</span>children <span class="token operator">&amp;&amp;</span> <span class="token function">flatten</span><span class="token punctuation">(</span>element<span class="token punctuation">.</span>props<span class="token punctuation">.</span>children<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">childElement<span class="token punctuation">,</span> index</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></span>
<span class="line">        childElement<span class="token punctuation">.</span>_mountIndex <span class="token operator">=</span> index<span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">let</span> childDOM <span class="token operator">=</span> <span class="token function">createDOM</span><span class="token punctuation">(</span>childElement<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        parentNode<span class="token punctuation">.</span><span class="token function">appendChild</span><span class="token punctuation">(</span>childDOM<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"><span class="token keyword">function</span> <span class="token function">createFunctionComponentDOM</span><span class="token punctuation">(</span><span class="token parameter">element</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">let</span> <span class="token punctuation">{</span> type<span class="token punctuation">,</span> props <span class="token punctuation">}</span> <span class="token operator">=</span> element<span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">let</span> renderElement <span class="token operator">=</span> <span class="token function">type</span><span class="token punctuation">(</span>props<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    element<span class="token punctuation">.</span>renderElement <span class="token operator">=</span> renderElement<span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">let</span> newDOM <span class="token operator">=</span> <span class="token function">createDOM</span><span class="token punctuation">(</span>renderElement<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    renderElement<span class="token punctuation">.</span>dom <span class="token operator">=</span> newDOM<span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">return</span> newDOM<span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"><span class="token keyword">function</span> <span class="token function">createClassComponentDOM</span><span class="token punctuation">(</span><span class="token parameter">element</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">let</span> <span class="token punctuation">{</span> type<span class="token punctuation">,</span> props <span class="token punctuation">}</span> <span class="token operator">=</span> element<span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">let</span> componentInstance <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">type</span><span class="token punctuation">(</span>props<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    element<span class="token punctuation">.</span>componentInstance <span class="token operator">=</span> componentInstance<span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">let</span> renderElement <span class="token operator">=</span> componentInstance<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    componentInstance<span class="token punctuation">.</span>renderElement <span class="token operator">=</span> renderElement<span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">let</span> newDOM <span class="token operator">=</span> <span class="token function">createDOM</span><span class="token punctuation">(</span>renderElement<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">return</span> newDOM<span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"><span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">compareTwoElements</span><span class="token punctuation">(</span><span class="token parameter">oldElement<span class="token punctuation">,</span> newElement</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    oldElement <span class="token operator">=</span> <span class="token function">onlyOne</span><span class="token punctuation">(</span>oldElement<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    newElement <span class="token operator">=</span> <span class="token function">onlyOne</span><span class="token punctuation">(</span>newElement<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">let</span> currentDOM <span class="token operator">=</span> oldElement<span class="token punctuation">.</span>dom<span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">let</span> currentElement <span class="token operator">=</span> oldElement<span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">if</span> <span class="token punctuation">(</span>newElement <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token comment">//如果新节点没有了，直接删除拉倒</span></span>
<span class="line">        currentDOM<span class="token punctuation">.</span>parentNode<span class="token punctuation">.</span><span class="token function">removeChild</span><span class="token punctuation">(</span>currentDOM<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        currentElement <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>oldElement<span class="token punctuation">.</span>type <span class="token operator">!==</span> newElement<span class="token punctuation">.</span>type<span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token comment">//如果类型不同</span></span>
<span class="line">        <span class="token keyword">let</span> newDOM <span class="token operator">=</span> <span class="token function">createDOM</span><span class="token punctuation">(</span>newElement<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        currentDOM<span class="token punctuation">.</span>parentNode<span class="token punctuation">.</span><span class="token function">replaceChild</span><span class="token punctuation">(</span>newDOM<span class="token punctuation">,</span> currentDOM<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        currentElement <span class="token operator">=</span> newElement<span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token function">updateElement</span><span class="token punctuation">(</span>oldElement<span class="token punctuation">,</span> newElement<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    <span class="token keyword">return</span> currentElement<span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">function</span> <span class="token function">updateElement</span><span class="token punctuation">(</span><span class="token parameter">oldElement<span class="token punctuation">,</span> newElement</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">let</span> currentDOM <span class="token operator">=</span> newElement<span class="token punctuation">.</span>dom <span class="token operator">=</span> oldElement<span class="token punctuation">.</span>dom<span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">if</span> <span class="token punctuation">(</span>oldElement<span class="token punctuation">.</span>$$<span class="token keyword">typeof</span> <span class="token operator">===</span> <span class="token constant">TEXT</span> <span class="token operator">&amp;&amp;</span> newElement<span class="token punctuation">.</span>$$<span class="token keyword">typeof</span> <span class="token operator">===</span> <span class="token constant">TEXT</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token comment">//如果都是文本类型，则直接改文本</span></span>
<span class="line">        <span class="token keyword">if</span> <span class="token punctuation">(</span>oldElement<span class="token punctuation">.</span>content <span class="token operator">!==</span> newElement<span class="token punctuation">.</span>content<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">            currentDOM<span class="token punctuation">.</span>textContent <span class="token operator">=</span> newElement<span class="token punctuation">.</span>content<span class="token punctuation">;</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>oldElement<span class="token punctuation">.</span>$$<span class="token keyword">typeof</span> <span class="token operator">===</span> <span class="token constant">ELEMENT</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line"><span class="token operator">+</span>        <span class="token function">updateChildrenElements</span><span class="token punctuation">(</span>currentDOM<span class="token punctuation">,</span> oldElement<span class="token punctuation">.</span>props<span class="token punctuation">.</span>children<span class="token punctuation">,</span> newElement<span class="token punctuation">.</span>props<span class="token punctuation">.</span>children<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token function">updateDOMProps</span><span class="token punctuation">(</span>currentDOM<span class="token punctuation">,</span> oldElement<span class="token punctuation">.</span>props<span class="token punctuation">,</span> newElement<span class="token punctuation">.</span>props<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        oldElement<span class="token punctuation">.</span>props <span class="token operator">=</span> newElement<span class="token punctuation">.</span>props<span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>oldElement<span class="token punctuation">.</span>$$<span class="token keyword">typeof</span> <span class="token operator">===</span> <span class="token constant">CLASS_COMPONENT</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token function">updateClassComponent</span><span class="token punctuation">(</span>oldElement<span class="token punctuation">,</span> newElement<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        newElement<span class="token punctuation">.</span>componentInstance <span class="token operator">=</span> oldElement<span class="token punctuation">.</span>componentInstance<span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>oldElement<span class="token punctuation">.</span>$$<span class="token keyword">typeof</span> <span class="token operator">===</span> <span class="token constant">FUNCTION_COMPONENT</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token function">updateFunctionComponent</span><span class="token punctuation">(</span>oldElement<span class="token punctuation">,</span> newElement<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"><span class="token keyword">function</span> <span class="token function">updateChildrenElements</span><span class="token punctuation">(</span><span class="token parameter">dom<span class="token punctuation">,</span> oldChildrenElements<span class="token punctuation">,</span> newChildrenElement</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line"><span class="token operator">+</span>    updateDepth<span class="token operator">++</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token function">diff</span><span class="token punctuation">(</span>dom<span class="token punctuation">,</span> <span class="token function">flatten</span><span class="token punctuation">(</span>oldChildrenElements<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>newChildrenElement<span class="token punctuation">)</span><span class="token punctuation">,</span> diffQueue<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token operator">+</span>    updateDepth<span class="token operator">--</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token operator">+</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>updateDepth <span class="token operator">===</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line"><span class="token operator">+</span>        <span class="token function">patch</span><span class="token punctuation">(</span>diffQueue<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token operator">+</span>        diffQueue<span class="token punctuation">.</span>length <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token operator">+</span>    <span class="token punctuation">}</span></span>
<span class="line"><span class="token operator">+</span><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">function</span> <span class="token function">diff</span><span class="token punctuation">(</span><span class="token parameter">parentNode<span class="token punctuation">,</span> oldChildrenElements<span class="token punctuation">,</span> newChildrenElements<span class="token punctuation">,</span> diffQueue</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">let</span> oldChildrenElementMap <span class="token operator">=</span> <span class="token function">getChildrenElementMap</span><span class="token punctuation">(</span>oldChildrenElements<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">let</span> newChildrenElementMap <span class="token operator">=</span> <span class="token function">getNewChildren</span><span class="token punctuation">(</span>oldChildrenElementMap<span class="token punctuation">,</span> newChildrenElements<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token operator">+</span>    <span class="token keyword">let</span> lastIndex <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token operator">+</span>    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> newChildrenElements<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line"><span class="token operator">+</span>        <span class="token keyword">let</span> newElement <span class="token operator">=</span> newChildrenElements<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token comment">//取得新元素</span></span>
<span class="line"><span class="token operator">+</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>newElement<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line"><span class="token operator">+</span>            <span class="token keyword">let</span> newKey <span class="token operator">=</span> <span class="token punctuation">(</span>newElement<span class="token punctuation">.</span>key<span class="token punctuation">)</span> <span class="token operator">||</span> i<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//取得新key</span></span>
<span class="line"><span class="token operator">+</span>            <span class="token keyword">let</span> oldElement <span class="token operator">=</span> oldChildrenElementMap<span class="token punctuation">[</span>newKey<span class="token punctuation">]</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token operator">+</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span>oldElement <span class="token operator">===</span> newElement<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line"><span class="token operator">+</span>                <span class="token keyword">if</span> <span class="token punctuation">(</span>oldElement<span class="token punctuation">.</span>_mountIndex <span class="token operator">&lt;</span> lastIndex<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line"><span class="token operator">+</span>                    diffQueue<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token punctuation">{</span></span>
<span class="line"><span class="token operator">+</span>                        parentNode<span class="token punctuation">,</span></span>
<span class="line"><span class="token operator">+</span>                        type<span class="token operator">:</span> <span class="token constant">MOVE</span><span class="token punctuation">,</span></span>
<span class="line"><span class="token operator">+</span>                        fromIndex<span class="token operator">:</span> oldElement<span class="token punctuation">.</span>_mountIndex<span class="token punctuation">,</span></span>
<span class="line"><span class="token operator">+</span>                        toIndex<span class="token operator">:</span> i</span>
<span class="line"><span class="token operator">+</span>                    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token operator">+</span>                <span class="token punctuation">}</span></span>
<span class="line"><span class="token operator">+</span>                lastIndex <span class="token operator">=</span> Math<span class="token punctuation">.</span><span class="token function">max</span><span class="token punctuation">(</span>oldElement<span class="token punctuation">.</span>_mountIndex<span class="token punctuation">,</span> lastIndex<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token operator">+</span>            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span></span>
<span class="line"><span class="token operator">+</span>                diffQueue<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token punctuation">{</span></span>
<span class="line"><span class="token operator">+</span>                    parentNode<span class="token punctuation">,</span></span>
<span class="line"><span class="token operator">+</span>                    type<span class="token operator">:</span> <span class="token constant">INSERT</span><span class="token punctuation">,</span></span>
<span class="line"><span class="token operator">+</span>                    toIndex<span class="token operator">:</span> i<span class="token punctuation">,</span></span>
<span class="line"><span class="token operator">+</span>                    dom<span class="token operator">:</span> <span class="token function">createDOM</span><span class="token punctuation">(</span>newElement<span class="token punctuation">)</span></span>
<span class="line"><span class="token operator">+</span>                <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token operator">+</span>            <span class="token punctuation">}</span></span>
<span class="line"><span class="token operator">+</span>            newElement<span class="token punctuation">.</span>_mountIndex <span class="token operator">=</span> i<span class="token punctuation">;</span></span>
<span class="line"><span class="token operator">+</span>        <span class="token punctuation">}</span></span>
<span class="line"><span class="token operator">+</span></span>
<span class="line"><span class="token operator">+</span>    <span class="token punctuation">}</span></span>
<span class="line"><span class="token operator">+</span>    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> oldKey <span class="token keyword">in</span> oldChildrenElementMap<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line"><span class="token operator">+</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>newChildrenElementMap<span class="token punctuation">.</span><span class="token function">hasOwnProperty</span><span class="token punctuation">(</span>oldKey<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line"><span class="token operator">+</span>            <span class="token keyword">let</span> oldElement <span class="token operator">=</span> oldChildrenElementMap<span class="token punctuation">[</span>oldKey<span class="token punctuation">]</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token operator">+</span>            diffQueue<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token punctuation">{</span></span>
<span class="line"><span class="token operator">+</span>                parentNode<span class="token punctuation">,</span></span>
<span class="line"><span class="token operator">+</span>                type<span class="token operator">:</span> <span class="token constant">REMOVE</span><span class="token punctuation">,</span></span>
<span class="line"><span class="token operator">+</span>                fromIndex<span class="token operator">:</span> oldElement<span class="token punctuation">.</span>_mountIndex</span>
<span class="line"><span class="token operator">+</span>            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token operator">+</span>        <span class="token punctuation">}</span></span>
<span class="line"><span class="token operator">+</span>    <span class="token punctuation">}</span></span>
<span class="line"><span class="token operator">+</span><span class="token punctuation">}</span></span>
<span class="line"><span class="token operator">+</span><span class="token keyword">function</span> <span class="token function">patch</span><span class="token punctuation">(</span><span class="token parameter">diffQueue</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line"><span class="token operator">+</span>    <span class="token keyword">let</span> deleteChildren <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token operator">+</span>    <span class="token keyword">let</span> deleteMap <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token operator">+</span>    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> diffQueue<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line"><span class="token operator">+</span>        <span class="token keyword">let</span> difference <span class="token operator">=</span> diffQueue<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token operator">+</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>difference<span class="token punctuation">.</span>type <span class="token operator">===</span> <span class="token constant">MOVE</span> <span class="token operator">||</span> difference<span class="token punctuation">.</span>type <span class="token operator">===</span> <span class="token constant">REMOVE</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line"><span class="token operator">+</span>            <span class="token keyword">let</span> fromIndex <span class="token operator">=</span> difference<span class="token punctuation">.</span>fromIndex<span class="token punctuation">;</span></span>
<span class="line"><span class="token operator">+</span>            <span class="token keyword">let</span> oldChild <span class="token operator">=</span> difference<span class="token punctuation">.</span>parentNode<span class="token punctuation">.</span>children<span class="token punctuation">[</span>fromIndex<span class="token punctuation">]</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token operator">+</span>            deleteMap<span class="token punctuation">[</span>fromIndex<span class="token punctuation">]</span> <span class="token operator">=</span> oldChild<span class="token punctuation">;</span></span>
<span class="line"><span class="token operator">+</span>            deleteChildren<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>oldChild<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token operator">+</span>        <span class="token punctuation">}</span></span>
<span class="line"><span class="token operator">+</span>    <span class="token punctuation">}</span></span>
<span class="line"><span class="token operator">+</span>    deleteChildren<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">child</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></span>
<span class="line"><span class="token operator">+</span>        child<span class="token punctuation">.</span>parentNode<span class="token punctuation">.</span><span class="token function">removeChild</span><span class="token punctuation">(</span>child<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token operator">+</span>    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token operator">+</span></span>
<span class="line"><span class="token operator">+</span>    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> k <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> k <span class="token operator">&lt;</span> diffQueue<span class="token punctuation">.</span>length<span class="token punctuation">;</span> k<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line"><span class="token operator">+</span>        <span class="token keyword">let</span> difference <span class="token operator">=</span> diffQueue<span class="token punctuation">[</span>k<span class="token punctuation">]</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token operator">+</span>        <span class="token keyword">switch</span> <span class="token punctuation">(</span>difference<span class="token punctuation">.</span>type<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line"><span class="token operator">+</span>            <span class="token keyword">case</span> <span class="token constant">INSERT</span><span class="token operator">:</span></span>
<span class="line"><span class="token operator">+</span>                <span class="token function">insertChildAt</span><span class="token punctuation">(</span>difference<span class="token punctuation">.</span>parentNode<span class="token punctuation">,</span> difference<span class="token punctuation">.</span>dom<span class="token punctuation">,</span> difference<span class="token punctuation">.</span>toIndex<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token operator">+</span>                <span class="token keyword">break</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token operator">+</span>            <span class="token keyword">case</span> <span class="token constant">MOVE</span><span class="token operator">:</span></span>
<span class="line"><span class="token operator">+</span>                <span class="token function">insertChildAt</span><span class="token punctuation">(</span>difference<span class="token punctuation">.</span>parentNode<span class="token punctuation">,</span> deleteMap<span class="token punctuation">[</span>difference<span class="token punctuation">.</span>fromIndex<span class="token punctuation">]</span><span class="token punctuation">,</span> difference<span class="token punctuation">.</span>toIndex<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token operator">+</span>                <span class="token keyword">break</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token operator">+</span>            <span class="token keyword">default</span><span class="token operator">:</span></span>
<span class="line"><span class="token operator">+</span>                <span class="token keyword">break</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token operator">+</span>        <span class="token punctuation">}</span></span>
<span class="line"><span class="token operator">+</span>    <span class="token punctuation">}</span></span>
<span class="line"><span class="token operator">+</span><span class="token punctuation">}</span></span>
<span class="line"><span class="token operator">+</span></span>
<span class="line"><span class="token operator">+</span><span class="token keyword">function</span> <span class="token function">insertChildAt</span><span class="token punctuation">(</span><span class="token parameter">parentNode<span class="token punctuation">,</span> childNode<span class="token punctuation">,</span> index</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line"><span class="token operator">+</span>    <span class="token keyword">let</span> oldChild <span class="token operator">=</span> parentNode<span class="token punctuation">.</span>children<span class="token punctuation">[</span>index<span class="token punctuation">]</span></span>
<span class="line"><span class="token operator">+</span>    oldChild <span class="token operator">?</span> parentNode<span class="token punctuation">.</span><span class="token function">insertBefore</span><span class="token punctuation">(</span>childNode<span class="token punctuation">,</span> oldChild<span class="token punctuation">)</span> <span class="token operator">:</span> parentNode<span class="token punctuation">.</span><span class="token function">appendChild</span><span class="token punctuation">(</span>childNode<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token operator">+</span><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">function</span> <span class="token function">getChildrenElementMap</span><span class="token punctuation">(</span><span class="token parameter">childrenElements</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">let</span> childrenElementMap <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> childrenElements<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">let</span> key <span class="token operator">=</span> childrenElements<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>key <span class="token operator">||</span> i<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        childrenElementMap<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">=</span> childrenElements<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    <span class="token keyword">return</span> childrenElementMap<span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">function</span> <span class="token function">getNewChildren</span><span class="token punctuation">(</span><span class="token parameter">oldChildrenElementMap<span class="token punctuation">,</span> newChildrenElements</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">let</span> newChildrenElementMap <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span></span>
<span class="line">    newChildrenElements<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">newChildElement<span class="token punctuation">,</span> index</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">if</span> <span class="token punctuation">(</span>newChildElement<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token keyword">let</span> newKey <span class="token operator">=</span> newChildElement<span class="token punctuation">.</span>key <span class="token operator">||</span> index<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">            <span class="token keyword">let</span> oldChildElement <span class="token operator">=</span> oldChildrenElementMap<span class="token punctuation">[</span>newKey<span class="token punctuation">]</span><span class="token punctuation">;</span></span>
<span class="line">            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">canDeepCompare</span><span class="token punctuation">(</span>oldChildElement<span class="token punctuation">,</span> newChildElement<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">                <span class="token function">updateElement</span><span class="token punctuation">(</span>oldChildElement<span class="token punctuation">,</span> newChildElement<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">                newChildrenElements<span class="token punctuation">[</span>index<span class="token punctuation">]</span> <span class="token operator">=</span> oldChildElement<span class="token punctuation">;</span></span>
<span class="line">            <span class="token punctuation">}</span></span>
<span class="line">            newChildrenElementMap<span class="token punctuation">[</span>newKey<span class="token punctuation">]</span> <span class="token operator">=</span> newChildrenElements<span class="token punctuation">[</span>index<span class="token punctuation">]</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">return</span> newChildrenElementMap<span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">function</span> <span class="token function">canDeepCompare</span><span class="token punctuation">(</span><span class="token parameter">oldChildElement<span class="token punctuation">,</span> newChildElement</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token operator">!</span>oldChildElement <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token operator">!</span>newChildElement<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">return</span> oldChildElement<span class="token punctuation">.</span>type <span class="token operator">===</span> newChildElement<span class="token punctuation">.</span>type<span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">function</span> <span class="token function">updateDOMProps</span><span class="token punctuation">(</span><span class="token parameter">dom<span class="token punctuation">,</span> oldProps<span class="token punctuation">,</span> newProps</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">return</span> <span class="token function">patchProps</span><span class="token punctuation">(</span>dom<span class="token punctuation">,</span> oldProps<span class="token punctuation">,</span> newProps<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">function</span> <span class="token function">updateClassComponent</span><span class="token punctuation">(</span><span class="token parameter">oldElement<span class="token punctuation">,</span> newElement</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">let</span> componentInstance <span class="token operator">=</span> oldElement<span class="token punctuation">.</span>componentInstance<span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">let</span> updater <span class="token operator">=</span> componentInstance<span class="token punctuation">.</span>$updater<span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">let</span> nextProps <span class="token operator">=</span> newElement<span class="token punctuation">.</span>props<span class="token punctuation">;</span></span>
<span class="line">    updater<span class="token punctuation">.</span><span class="token function">emitUpdate</span><span class="token punctuation">(</span>nextProps<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">function</span> <span class="token function">updateFunctionComponent</span><span class="token punctuation">(</span><span class="token parameter">oldElement<span class="token punctuation">,</span> newElement</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">let</span> newRenderElement <span class="token operator">=</span> newElement<span class="token punctuation">.</span><span class="token function">type</span><span class="token punctuation">(</span>newElement<span class="token punctuation">.</span>props<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">var</span> oldRenderElement <span class="token operator">=</span> oldElement<span class="token punctuation">.</span>renderElement<span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">var</span> currentElement <span class="token operator">=</span> <span class="token function">compareTwoElements</span><span class="token punctuation">(</span>oldRenderElement<span class="token punctuation">,</span> newRenderElement<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    newElement<span class="token punctuation">.</span>renderElement <span class="token operator">=</span> currentElement<span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"><span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">ReactElement</span><span class="token punctuation">(</span><span class="token parameter">$$<span class="token keyword">typeof</span><span class="token punctuation">,</span> type<span class="token punctuation">,</span> key<span class="token punctuation">,</span> ref<span class="token punctuation">,</span> props</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">let</span> element <span class="token operator">=</span> <span class="token punctuation">{</span></span>
<span class="line">        $$<span class="token keyword">typeof</span><span class="token punctuation">,</span></span>
<span class="line">        type<span class="token punctuation">,</span></span>
<span class="line">        props<span class="token punctuation">,</span></span>
<span class="line">        key<span class="token punctuation">,</span></span>
<span class="line">        ref</span>
<span class="line">    <span class="token punctuation">}</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">return</span> element<span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="_6-支持旧版生命周期" tabindex="-1"><a class="header-anchor" href="#_6-支持旧版生命周期"><span>6. 支持旧版生命周期</span></a></h2><p><img src="http://img.zhufengpeixun.cn/lifecycle.png" alt="lifecycle"></p><p><img src="http://img.zhufengpeixun.cn/lifecycle.jpg" alt="lifecycle"></p><h3 id="_6-1-src-index-js" tabindex="-1"><a class="header-anchor" href="#_6-1-src-index-js"><span>6.1 src\\index.js</span></a></h3><p>src\\index.js</p><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text"><pre><code class="language-text"><span class="line">import React from &#39;react&#39;;</span>
<span class="line">import ReactDOM from &#39;react-dom&#39;;</span>
<span class="line">+class Counter extends React.Component { // 他会比较两个状态相等就不会刷新视图 PureComponent是浅比较</span>
<span class="line">+    static defaultProps = {</span>
<span class="line">+        name: &#39;珠峰架构&#39;</span>
<span class="line">+    };</span>
<span class="line">+    constructor(props) {</span>
<span class="line">+        super(props);</span>
<span class="line">+        this.state = { number: 0 }</span>
<span class="line">+        console.log(&#39;Counter constructor&#39;)</span>
<span class="line">+    }</span>
<span class="line">+    componentWillMount() { // 取本地的数据 同步的方式：采用渲染之前获取数据，只渲染一次</span>
<span class="line">+        console.log(&#39;Counter  componentWillMount&#39;);</span>
<span class="line">+    }</span>
<span class="line">+    componentDidMount() {</span>
<span class="line">+        console.log(&#39;Counter  componentDidMount&#39;);</span>
<span class="line">+    }</span>
<span class="line">+    handleClick = () =&gt; {</span>
<span class="line">+        this.setState({ number: this.state.number + 1 });</span>
<span class="line">+    };</span>
<span class="line">+    // react可以shouldComponentUpdate方法中优化 PureComponent 可以帮我们做这件事</span>
<span class="line">+    shouldComponentUpdate(nextProps, nextState) { // 代表的是下一次的属性 和 下一次的状态</span>
<span class="line">+        console.log(&#39;Counter  shouldComponentUpdate&#39;);</span>
<span class="line">+        return nextState.number &gt; 1;</span>
<span class="line">+        // return nextState.number!==this.state.number; //如果此函数种返回了false 就不会调用render方法了</span>
<span class="line">+    } //不要随便用setState 可能会死循环</span>
<span class="line">+    componentWillUpdate() {</span>
<span class="line">+        console.log(&#39;Counter  componentWillUpdate&#39;);</span>
<span class="line">+    }</span>
<span class="line">+    componentDidUpdate() {</span>
<span class="line">+        console.log(&#39;Counter  componentDidUpdate&#39;);</span>
<span class="line">+    }</span>
<span class="line">+    render() {</span>
<span class="line">+        console.log(&#39;Counter render&#39;);</span>
<span class="line">+        return (</span>
<span class="line">+            &lt;div&gt;</span>
<span class="line">+                &lt;p&gt;{this.state.number}&lt;/p&gt;</span>
<span class="line">+                {this.state.number &gt; 3 ? null : &lt;ChildCounter n={this.state.number} /&gt;}</span>
<span class="line">+                &lt;button onClick={this.handleClick}&gt;+&lt;/button&gt;</span>
<span class="line">+            &lt;/div&gt;</span>
<span class="line">+        )</span>
<span class="line">+    }</span>
<span class="line">+}</span>
<span class="line">+class ChildCounter extends React.Component {</span>
<span class="line">+    componentWillUnmount() {</span>
<span class="line">+        console.log(&#39;ChildCounter  componentWillUnmount&#39;)</span>
<span class="line">+    }</span>
<span class="line">+    componentWillMount() {</span>
<span class="line">+        console.log(&#39;ChildCounter componentWillMount&#39;)</span>
<span class="line">+    }</span>
<span class="line">+    render() {</span>
<span class="line">+        console.log(&#39;ChildCounter render&#39;)</span>
<span class="line">+        return (&lt;div&gt;</span>
<span class="line">+            {this.props.n}</span>
<span class="line">+        &lt;/div&gt;)</span>
<span class="line">+    }</span>
<span class="line">+    componentDidMount() {</span>
<span class="line">+        console.log(&#39;ChildCounter componentDidMount&#39;)</span>
<span class="line">+    }</span>
<span class="line">+    componentWillReceiveProps(newProps) { // 第一次不会执行，之后属性更新时才会执行</span>
<span class="line">+        console.log(&#39;ChildCounter componentWillReceiveProps&#39;)</span>
<span class="line">+    }</span>
<span class="line">+    shouldComponentUpdate(nextProps, nextState) {</span>
<span class="line">+        console.log(&#39;ChildCounter shouldComponentUpdate&#39;)</span>
<span class="line">+        return nextProps.n &gt; 2; //子组件判断接收的属性 是否满足更新条件 为true则更新</span>
<span class="line">+    }</span>
<span class="line">+    componentWillUpdate() {</span>
<span class="line">+        console.log(&#39;ChildCounter  componentWillUpdate&#39;);</span>
<span class="line">+    }</span>
<span class="line">+    componentDidUpdate() {</span>
<span class="line">+        console.log(&#39;ChildCounter  componentDidUpdate&#39;);</span>
<span class="line">+    }</span>
<span class="line">+}</span>
<span class="line">let element = React.createElement(Counter, {});</span>
<span class="line">ReactDOM.render(</span>
<span class="line">    element,</span>
<span class="line">    document.getElementById(&#39;root&#39;)</span>
<span class="line">);</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_6-2-react-vdom-js" tabindex="-1"><a class="header-anchor" href="#_6-2-react-vdom-js"><span>6.2 react\\vdom.js</span></a></h3><p>src\\react\\vdom.js</p><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code class="language-javascript"><span class="line"><span class="token keyword">import</span> <span class="token punctuation">{</span> <span class="token constant">TEXT</span><span class="token punctuation">,</span> <span class="token constant">ELEMENT</span><span class="token punctuation">,</span> <span class="token constant">FUNCTION_COMPONENT</span><span class="token punctuation">,</span> <span class="token constant">CLASS_COMPONENT</span><span class="token punctuation">,</span> <span class="token constant">MOVE</span><span class="token punctuation">,</span> <span class="token constant">INSERT</span><span class="token punctuation">,</span> <span class="token constant">REMOVE</span> <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&#39;./constants&#39;</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">import</span> <span class="token punctuation">{</span> setProps<span class="token punctuation">,</span> onlyOne<span class="token punctuation">,</span> patchProps<span class="token punctuation">,</span> flatten <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&#39;./utils&#39;</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">const</span> diffQueue <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">let</span> updateDepth <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">createDOM</span><span class="token punctuation">(</span><span class="token parameter">element</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    element <span class="token operator">=</span> <span class="token function">onlyOne</span><span class="token punctuation">(</span>element<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">let</span> <span class="token punctuation">{</span> $$<span class="token keyword">typeof</span> <span class="token punctuation">}</span> <span class="token operator">=</span> element<span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">let</span> dom <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>$$<span class="token keyword">typeof</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        dom <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">createTextNode</span><span class="token punctuation">(</span>element<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>$$<span class="token keyword">typeof</span> <span class="token operator">===</span> <span class="token constant">TEXT</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        dom <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">createTextNode</span><span class="token punctuation">(</span>element<span class="token punctuation">.</span>content<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>$$<span class="token keyword">typeof</span> <span class="token operator">===</span> <span class="token constant">ELEMENT</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        dom <span class="token operator">=</span> <span class="token function">createNativeDOM</span><span class="token punctuation">(</span>element<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>$$<span class="token keyword">typeof</span> <span class="token operator">===</span> <span class="token constant">FUNCTION_COMPONENT</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        dom <span class="token operator">=</span> <span class="token function">createFunctionComponentDOM</span><span class="token punctuation">(</span>element<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>$$<span class="token keyword">typeof</span> <span class="token operator">===</span> <span class="token constant">CLASS_COMPONENT</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        dom <span class="token operator">=</span> <span class="token function">createClassComponentDOM</span><span class="token punctuation">(</span>element<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    element<span class="token punctuation">.</span>dom <span class="token operator">=</span> dom<span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">return</span> dom<span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">function</span> <span class="token function">createNativeDOM</span><span class="token punctuation">(</span><span class="token parameter">element</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">let</span> <span class="token punctuation">{</span> type<span class="token punctuation">,</span> props <span class="token punctuation">}</span> <span class="token operator">=</span> element<span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">let</span> dom <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span>type<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token function">createChildren</span><span class="token punctuation">(</span>element<span class="token punctuation">,</span> dom<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token function">setProps</span><span class="token punctuation">(</span>dom<span class="token punctuation">,</span> props<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">return</span> dom<span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">function</span> <span class="token function">createChildren</span><span class="token punctuation">(</span><span class="token parameter">element<span class="token punctuation">,</span> parentNode</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    element<span class="token punctuation">.</span>props<span class="token punctuation">.</span>children <span class="token operator">&amp;&amp;</span> <span class="token function">flatten</span><span class="token punctuation">(</span>element<span class="token punctuation">.</span>props<span class="token punctuation">.</span>children<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">childElement<span class="token punctuation">,</span> index</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></span>
<span class="line">        childElement<span class="token punctuation">.</span>_mountIndex <span class="token operator">=</span> index<span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">let</span> childDOM <span class="token operator">=</span> <span class="token function">createDOM</span><span class="token punctuation">(</span>childElement<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        parentNode<span class="token punctuation">.</span><span class="token function">appendChild</span><span class="token punctuation">(</span>childDOM<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"><span class="token keyword">function</span> <span class="token function">createFunctionComponentDOM</span><span class="token punctuation">(</span><span class="token parameter">element</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">let</span> <span class="token punctuation">{</span> type<span class="token punctuation">,</span> props <span class="token punctuation">}</span> <span class="token operator">=</span> element<span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">let</span> renderElement <span class="token operator">=</span> <span class="token function">type</span><span class="token punctuation">(</span>props<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    element<span class="token punctuation">.</span>renderElement <span class="token operator">=</span> renderElement<span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">let</span> newDOM <span class="token operator">=</span> <span class="token function">createDOM</span><span class="token punctuation">(</span>renderElement<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    renderElement<span class="token punctuation">.</span>dom <span class="token operator">=</span> newDOM<span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">return</span> newDOM<span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"><span class="token keyword">function</span> <span class="token function">createClassComponentDOM</span><span class="token punctuation">(</span><span class="token parameter">element</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">let</span> <span class="token punctuation">{</span> type<span class="token punctuation">,</span> props <span class="token punctuation">}</span> <span class="token operator">=</span> element<span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">let</span> componentInstance <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">type</span><span class="token punctuation">(</span>props<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token operator">+</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>componentInstance<span class="token punctuation">.</span>componentWillMount<span class="token punctuation">)</span></span>
<span class="line"><span class="token operator">+</span>        componentInstance<span class="token punctuation">.</span><span class="token function">componentWillMount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    element<span class="token punctuation">.</span>componentInstance <span class="token operator">=</span> componentInstance<span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">let</span> renderElement <span class="token operator">=</span> componentInstance<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    componentInstance<span class="token punctuation">.</span>renderElement <span class="token operator">=</span> renderElement<span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">let</span> newDOM <span class="token operator">=</span> <span class="token function">createDOM</span><span class="token punctuation">(</span>renderElement<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token operator">+</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>componentInstance<span class="token punctuation">.</span>componentDidMount<span class="token punctuation">)</span></span>
<span class="line"><span class="token operator">+</span>        componentInstance<span class="token punctuation">.</span><span class="token function">componentDidMount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">return</span> newDOM<span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"><span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">compareTwoElements</span><span class="token punctuation">(</span><span class="token parameter">oldElement<span class="token punctuation">,</span> newElement</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    oldElement <span class="token operator">=</span> <span class="token function">onlyOne</span><span class="token punctuation">(</span>oldElement<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    newElement <span class="token operator">=</span> <span class="token function">onlyOne</span><span class="token punctuation">(</span>newElement<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">let</span> currentDOM <span class="token operator">=</span> oldElement<span class="token punctuation">.</span>dom<span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">let</span> currentElement <span class="token operator">=</span> oldElement<span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">if</span> <span class="token punctuation">(</span>newElement <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token comment">//如果新节点没有了，直接删除拉倒</span></span>
<span class="line">        currentDOM<span class="token punctuation">.</span>parentNode<span class="token punctuation">.</span><span class="token function">removeChild</span><span class="token punctuation">(</span>currentDOM<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        currentElement <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>oldElement<span class="token punctuation">.</span>type <span class="token operator">!==</span> newElement<span class="token punctuation">.</span>type<span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token comment">//如果类型不同</span></span>
<span class="line">        <span class="token keyword">let</span> newDOM <span class="token operator">=</span> <span class="token function">createDOM</span><span class="token punctuation">(</span>newElement<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        currentDOM<span class="token punctuation">.</span>parentNode<span class="token punctuation">.</span><span class="token function">replaceChild</span><span class="token punctuation">(</span>newDOM<span class="token punctuation">,</span> currentDOM<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        currentElement <span class="token operator">=</span> newElement<span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token function">updateElement</span><span class="token punctuation">(</span>oldElement<span class="token punctuation">,</span> newElement<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    <span class="token keyword">return</span> currentElement<span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">function</span> <span class="token function">updateElement</span><span class="token punctuation">(</span><span class="token parameter">oldElement<span class="token punctuation">,</span> newElement</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">let</span> currentDOM <span class="token operator">=</span> newElement<span class="token punctuation">.</span>dom <span class="token operator">=</span> oldElement<span class="token punctuation">.</span>dom<span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">if</span> <span class="token punctuation">(</span>oldElement<span class="token punctuation">.</span>$$<span class="token keyword">typeof</span> <span class="token operator">===</span> <span class="token constant">TEXT</span> <span class="token operator">&amp;&amp;</span> newElement<span class="token punctuation">.</span>$$<span class="token keyword">typeof</span> <span class="token operator">===</span> <span class="token constant">TEXT</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token comment">//如果都是文本类型，则直接改文本</span></span>
<span class="line">        <span class="token keyword">if</span> <span class="token punctuation">(</span>oldElement<span class="token punctuation">.</span>content <span class="token operator">!==</span> newElement<span class="token punctuation">.</span>content<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">            currentDOM<span class="token punctuation">.</span>textContent <span class="token operator">=</span> newElement<span class="token punctuation">.</span>content<span class="token punctuation">;</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>oldElement<span class="token punctuation">.</span>$$<span class="token keyword">typeof</span> <span class="token operator">===</span> <span class="token constant">ELEMENT</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token function">updateChildrenElements</span><span class="token punctuation">(</span>currentDOM<span class="token punctuation">,</span> oldElement<span class="token punctuation">.</span>props<span class="token punctuation">.</span>children<span class="token punctuation">,</span> newElement<span class="token punctuation">.</span>props<span class="token punctuation">.</span>children<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token function">updateDOMProps</span><span class="token punctuation">(</span>currentDOM<span class="token punctuation">,</span> oldElement<span class="token punctuation">.</span>props<span class="token punctuation">,</span> newElement<span class="token punctuation">.</span>props<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        oldElement<span class="token punctuation">.</span>props <span class="token operator">=</span> newElement<span class="token punctuation">.</span>props<span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>oldElement<span class="token punctuation">.</span>$$<span class="token keyword">typeof</span> <span class="token operator">===</span> <span class="token constant">CLASS_COMPONENT</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token function">updateClassComponent</span><span class="token punctuation">(</span>oldElement<span class="token punctuation">,</span> newElement<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        newElement<span class="token punctuation">.</span>componentInstance <span class="token operator">=</span> oldElement<span class="token punctuation">.</span>componentInstance<span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>oldElement<span class="token punctuation">.</span>$$<span class="token keyword">typeof</span> <span class="token operator">===</span> <span class="token constant">FUNCTION_COMPONENT</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token function">updateFunctionComponent</span><span class="token punctuation">(</span>oldElement<span class="token punctuation">,</span> newElement<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"><span class="token keyword">function</span> <span class="token function">updateChildrenElements</span><span class="token punctuation">(</span><span class="token parameter">dom<span class="token punctuation">,</span> oldChildrenElements<span class="token punctuation">,</span> newChildrenElement</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    updateDepth<span class="token operator">++</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token function">diff</span><span class="token punctuation">(</span>dom<span class="token punctuation">,</span> <span class="token function">flatten</span><span class="token punctuation">(</span>oldChildrenElements<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">flatten</span><span class="token punctuation">(</span>newChildrenElement<span class="token punctuation">)</span><span class="token punctuation">,</span> diffQueue<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    updateDepth<span class="token operator">--</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">if</span> <span class="token punctuation">(</span>updateDepth <span class="token operator">===</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token function">patch</span><span class="token punctuation">(</span>diffQueue<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        diffQueue<span class="token punctuation">.</span>length <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">function</span> <span class="token function">diff</span><span class="token punctuation">(</span><span class="token parameter">parentNode<span class="token punctuation">,</span> oldChildrenElements<span class="token punctuation">,</span> newChildrenElements<span class="token punctuation">,</span> diffQueue</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">let</span> oldChildrenElementMap <span class="token operator">=</span> <span class="token function">getChildrenElementMap</span><span class="token punctuation">(</span>oldChildrenElements<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">let</span> newChildrenElementMap <span class="token operator">=</span> <span class="token function">getNewChildren</span><span class="token punctuation">(</span>oldChildrenElementMap<span class="token punctuation">,</span> newChildrenElements<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">let</span> lastIndex <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> newChildrenElements<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">let</span> newElement <span class="token operator">=</span> newChildrenElements<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token comment">//取得新元素</span></span>
<span class="line">        <span class="token keyword">if</span> <span class="token punctuation">(</span>newElement<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token keyword">let</span> newKey <span class="token operator">=</span> <span class="token punctuation">(</span>newElement<span class="token punctuation">.</span>key<span class="token punctuation">)</span> <span class="token operator">||</span> i<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//取得新key</span></span>
<span class="line">            <span class="token keyword">let</span> oldElement <span class="token operator">=</span> oldChildrenElementMap<span class="token punctuation">[</span>newKey<span class="token punctuation">]</span><span class="token punctuation">;</span></span>
<span class="line">            <span class="token keyword">if</span> <span class="token punctuation">(</span>oldElement <span class="token operator">===</span> newElement<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">                <span class="token keyword">if</span> <span class="token punctuation">(</span>oldElement<span class="token punctuation">.</span>_mountIndex <span class="token operator">&lt;</span> lastIndex<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">                    diffQueue<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token punctuation">{</span></span>
<span class="line">                        parentNode<span class="token punctuation">,</span></span>
<span class="line">                        <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token constant">MOVE</span><span class="token punctuation">,</span></span>
<span class="line">                        <span class="token literal-property property">fromIndex</span><span class="token operator">:</span> oldElement<span class="token punctuation">.</span>_mountIndex<span class="token punctuation">,</span></span>
<span class="line">                        <span class="token literal-property property">toIndex</span><span class="token operator">:</span> i</span>
<span class="line">                    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">                <span class="token punctuation">}</span></span>
<span class="line">                lastIndex <span class="token operator">=</span> Math<span class="token punctuation">.</span><span class="token function">max</span><span class="token punctuation">(</span>oldElement<span class="token punctuation">.</span>_mountIndex<span class="token punctuation">,</span> lastIndex<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span></span>
<span class="line">                diffQueue<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token punctuation">{</span></span>
<span class="line">                    parentNode<span class="token punctuation">,</span></span>
<span class="line">                    <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token constant">INSERT</span><span class="token punctuation">,</span></span>
<span class="line">                    <span class="token literal-property property">toIndex</span><span class="token operator">:</span> i<span class="token punctuation">,</span></span>
<span class="line">                    <span class="token literal-property property">dom</span><span class="token operator">:</span> <span class="token function">createDOM</span><span class="token punctuation">(</span>newElement<span class="token punctuation">)</span></span>
<span class="line">                <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">            <span class="token punctuation">}</span></span>
<span class="line">            newElement<span class="token punctuation">.</span>_mountIndex <span class="token operator">=</span> i<span class="token punctuation">;</span></span>
<span class="line"><span class="token operator">+</span>        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span></span>
<span class="line"><span class="token operator">+</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span>oldChildrenElements<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>componentInstance <span class="token operator">&amp;&amp;</span> oldChildrenElements<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>componentInstance<span class="token punctuation">.</span>componentWillUnmount<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line"><span class="token operator">+</span>                oldChildrenElements<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>componentInstance<span class="token punctuation">.</span><span class="token function">componentWillUnmount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token operator">+</span>            <span class="token punctuation">}</span></span>
<span class="line"><span class="token operator">+</span>        <span class="token punctuation">}</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> oldKey <span class="token keyword">in</span> oldChildrenElementMap<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>newChildrenElementMap<span class="token punctuation">.</span><span class="token function">hasOwnProperty</span><span class="token punctuation">(</span>oldKey<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token keyword">let</span> oldElement <span class="token operator">=</span> oldChildrenElementMap<span class="token punctuation">[</span>oldKey<span class="token punctuation">]</span><span class="token punctuation">;</span></span>
<span class="line">            diffQueue<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token punctuation">{</span></span>
<span class="line">                parentNode<span class="token punctuation">,</span></span>
<span class="line">                <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token constant">REMOVE</span><span class="token punctuation">,</span></span>
<span class="line">                <span class="token literal-property property">fromIndex</span><span class="token operator">:</span> oldElement<span class="token punctuation">.</span>_mountIndex</span>
<span class="line">            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"><span class="token keyword">function</span> <span class="token function">patch</span><span class="token punctuation">(</span><span class="token parameter">diffQueue</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">let</span> deleteChildren <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">let</span> deleteMap <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> diffQueue<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">let</span> difference <span class="token operator">=</span> diffQueue<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">if</span> <span class="token punctuation">(</span>difference<span class="token punctuation">.</span>type <span class="token operator">===</span> <span class="token constant">MOVE</span> <span class="token operator">||</span> difference<span class="token punctuation">.</span>type <span class="token operator">===</span> <span class="token constant">REMOVE</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token keyword">let</span> fromIndex <span class="token operator">=</span> difference<span class="token punctuation">.</span>fromIndex<span class="token punctuation">;</span></span>
<span class="line">            <span class="token keyword">let</span> oldChild <span class="token operator">=</span> difference<span class="token punctuation">.</span>parentNode<span class="token punctuation">.</span>children<span class="token punctuation">[</span>fromIndex<span class="token punctuation">]</span><span class="token punctuation">;</span></span>
<span class="line">            deleteMap<span class="token punctuation">[</span>fromIndex<span class="token punctuation">]</span> <span class="token operator">=</span> oldChild<span class="token punctuation">;</span></span>
<span class="line">            deleteChildren<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>oldChild<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    deleteChildren<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">child</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></span>
<span class="line">        child<span class="token punctuation">.</span>parentNode<span class="token punctuation">.</span><span class="token function">removeChild</span><span class="token punctuation">(</span>child<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> k <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> k <span class="token operator">&lt;</span> diffQueue<span class="token punctuation">.</span>length<span class="token punctuation">;</span> k<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">let</span> difference <span class="token operator">=</span> diffQueue<span class="token punctuation">[</span>k<span class="token punctuation">]</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">switch</span> <span class="token punctuation">(</span>difference<span class="token punctuation">.</span>type<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token keyword">case</span> <span class="token constant">INSERT</span><span class="token operator">:</span></span>
<span class="line">                <span class="token function">insertChildAt</span><span class="token punctuation">(</span>difference<span class="token punctuation">.</span>parentNode<span class="token punctuation">,</span> difference<span class="token punctuation">.</span>dom<span class="token punctuation">,</span> difference<span class="token punctuation">.</span>toIndex<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">                <span class="token keyword">break</span><span class="token punctuation">;</span></span>
<span class="line">            <span class="token keyword">case</span> <span class="token constant">MOVE</span><span class="token operator">:</span></span>
<span class="line">                <span class="token function">insertChildAt</span><span class="token punctuation">(</span>difference<span class="token punctuation">.</span>parentNode<span class="token punctuation">,</span> deleteMap<span class="token punctuation">[</span>difference<span class="token punctuation">.</span>fromIndex<span class="token punctuation">]</span><span class="token punctuation">,</span> difference<span class="token punctuation">.</span>toIndex<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">                <span class="token keyword">break</span><span class="token punctuation">;</span></span>
<span class="line">            <span class="token keyword">default</span><span class="token operator">:</span></span>
<span class="line">                <span class="token keyword">break</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">function</span> <span class="token function">insertChildAt</span><span class="token punctuation">(</span><span class="token parameter">parentNode<span class="token punctuation">,</span> childNode<span class="token punctuation">,</span> index</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">let</span> oldChild <span class="token operator">=</span> parentNode<span class="token punctuation">.</span>children<span class="token punctuation">[</span>index<span class="token punctuation">]</span></span>
<span class="line">    oldChild <span class="token operator">?</span> parentNode<span class="token punctuation">.</span><span class="token function">insertBefore</span><span class="token punctuation">(</span>childNode<span class="token punctuation">,</span> oldChild<span class="token punctuation">)</span> <span class="token operator">:</span> parentNode<span class="token punctuation">.</span><span class="token function">appendChild</span><span class="token punctuation">(</span>childNode<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">function</span> <span class="token function">getChildrenElementMap</span><span class="token punctuation">(</span><span class="token parameter">childrenElements</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">let</span> childrenElementMap <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> childrenElements<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">let</span> key <span class="token operator">=</span> childrenElements<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>key <span class="token operator">||</span> i<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        childrenElementMap<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">=</span> childrenElements<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    <span class="token keyword">return</span> childrenElementMap<span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">function</span> <span class="token function">getNewChildren</span><span class="token punctuation">(</span><span class="token parameter">oldChildrenElementMap<span class="token punctuation">,</span> newChildrenElements</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">let</span> newChildrenElementMap <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span></span>
<span class="line">    newChildrenElements<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">newChildElement<span class="token punctuation">,</span> index</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">if</span> <span class="token punctuation">(</span>newChildElement<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token keyword">let</span> newKey <span class="token operator">=</span> newChildElement<span class="token punctuation">.</span>key <span class="token operator">||</span> index<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">            <span class="token keyword">let</span> oldChildElement <span class="token operator">=</span> oldChildrenElementMap<span class="token punctuation">[</span>newKey<span class="token punctuation">]</span><span class="token punctuation">;</span></span>
<span class="line">            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">canDeepCompare</span><span class="token punctuation">(</span>oldChildElement<span class="token punctuation">,</span> newChildElement<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">                <span class="token function">updateElement</span><span class="token punctuation">(</span>oldChildElement<span class="token punctuation">,</span> newChildElement<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">                newChildrenElements<span class="token punctuation">[</span>index<span class="token punctuation">]</span> <span class="token operator">=</span> oldChildElement<span class="token punctuation">;</span></span>
<span class="line">            <span class="token punctuation">}</span></span>
<span class="line">            newChildrenElementMap<span class="token punctuation">[</span>newKey<span class="token punctuation">]</span> <span class="token operator">=</span> newChildrenElements<span class="token punctuation">[</span>index<span class="token punctuation">]</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">return</span> newChildrenElementMap<span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">function</span> <span class="token function">canDeepCompare</span><span class="token punctuation">(</span><span class="token parameter">oldChildElement<span class="token punctuation">,</span> newChildElement</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token operator">!</span>oldChildElement <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token operator">!</span>newChildElement<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">return</span> oldChildElement<span class="token punctuation">.</span>type <span class="token operator">===</span> newChildElement<span class="token punctuation">.</span>type<span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">function</span> <span class="token function">updateDOMProps</span><span class="token punctuation">(</span><span class="token parameter">dom<span class="token punctuation">,</span> oldProps<span class="token punctuation">,</span> newProps</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">return</span> <span class="token function">patchProps</span><span class="token punctuation">(</span>dom<span class="token punctuation">,</span> oldProps<span class="token punctuation">,</span> newProps<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">function</span> <span class="token function">updateClassComponent</span><span class="token punctuation">(</span><span class="token parameter">oldElement<span class="token punctuation">,</span> newElement</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">let</span> componentInstance <span class="token operator">=</span> oldElement<span class="token punctuation">.</span>componentInstance<span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">let</span> updater <span class="token operator">=</span> componentInstance<span class="token punctuation">.</span>$updater<span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">let</span> nextProps <span class="token operator">=</span> newElement<span class="token punctuation">.</span>props<span class="token punctuation">;</span></span>
<span class="line"><span class="token operator">+</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>componentInstance<span class="token punctuation">.</span>componentWillReceiveProps<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line"><span class="token operator">+</span>        componentInstance<span class="token punctuation">.</span><span class="token function">componentWillReceiveProps</span><span class="token punctuation">(</span>nextProps<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token operator">+</span>    <span class="token punctuation">}</span></span>
<span class="line">    updater<span class="token punctuation">.</span><span class="token function">emitUpdate</span><span class="token punctuation">(</span>nextProps<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">function</span> <span class="token function">updateFunctionComponent</span><span class="token punctuation">(</span><span class="token parameter">oldElement<span class="token punctuation">,</span> newElement</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">let</span> newRenderElement <span class="token operator">=</span> newElement<span class="token punctuation">.</span><span class="token function">type</span><span class="token punctuation">(</span>newElement<span class="token punctuation">.</span>props<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">var</span> oldRenderElement <span class="token operator">=</span> oldElement<span class="token punctuation">.</span>renderElement<span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">var</span> currentElement <span class="token operator">=</span> <span class="token function">compareTwoElements</span><span class="token punctuation">(</span>oldRenderElement<span class="token punctuation">,</span> newRenderElement<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    newElement<span class="token punctuation">.</span>renderElement <span class="token operator">=</span> currentElement<span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"><span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">ReactElement</span><span class="token punctuation">(</span><span class="token parameter">$$<span class="token keyword">typeof</span><span class="token punctuation">,</span> type<span class="token punctuation">,</span> key<span class="token punctuation">,</span> ref<span class="token punctuation">,</span> props</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">let</span> element <span class="token operator">=</span> <span class="token punctuation">{</span></span>
<span class="line">        $$<span class="token keyword">typeof</span><span class="token punctuation">,</span></span>
<span class="line">        type<span class="token punctuation">,</span></span>
<span class="line">        props<span class="token punctuation">,</span></span>
<span class="line">        key<span class="token punctuation">,</span></span>
<span class="line">        ref</span>
<span class="line">    <span class="token punctuation">}</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">return</span> element<span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="_7-新版生命周期和ref" tabindex="-1"><a class="header-anchor" href="#_7-新版生命周期和ref"><span>7. 新版生命周期和ref</span></a></h2><h3 id="_7-1-getderivedstatefromprops" tabindex="-1"><a class="header-anchor" href="#_7-1-getderivedstatefromprops"><span>7.1 getDerivedStateFromProps</span></a></h3><h4 id="_7-1-1-index-js" tabindex="-1"><a class="header-anchor" href="#_7-1-1-index-js"><span>7.1.1 index.js</span></a></h4><p>src/index.js</p><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code class="language-javascript"><span class="line"><span class="token keyword">import</span> React <span class="token keyword">from</span> <span class="token string">&#39;./react&#39;</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">import</span> ReactDOM <span class="token keyword">from</span> <span class="token string">&#39;./react-dom&#39;</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">class</span> <span class="token class-name">Counter</span> <span class="token keyword">extends</span> <span class="token class-name">React<span class="token punctuation">.</span>Component</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">static</span> defaultProps <span class="token operator">=</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">&#39;珠峰架构&#39;</span></span>
<span class="line">    <span class="token punctuation">}</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter">props</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">super</span><span class="token punctuation">(</span>props<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">this</span><span class="token punctuation">.</span>state <span class="token operator">=</span> <span class="token punctuation">{</span> <span class="token literal-property property">number</span><span class="token operator">:</span> <span class="token number">0</span> <span class="token punctuation">}</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">    <span class="token function-variable function">handleClick</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">setState</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token literal-property property">number</span><span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">.</span>number <span class="token operator">+</span> <span class="token number">1</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">    <span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">return</span> <span class="token punctuation">(</span></span>
<span class="line">            <span class="token operator">&lt;</span>div<span class="token operator">&gt;</span></span>
<span class="line">                <span class="token operator">&lt;</span>p<span class="token operator">&gt;</span><span class="token punctuation">{</span><span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">.</span>number<span class="token punctuation">}</span><span class="token operator">&lt;</span><span class="token operator">/</span>p<span class="token operator">&gt;</span></span>
<span class="line">                <span class="token operator">&lt;</span>ChildCounter number<span class="token operator">=</span><span class="token punctuation">{</span><span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">.</span>number<span class="token punctuation">}</span> <span class="token operator">/</span><span class="token operator">&gt;</span></span>
<span class="line">                <span class="token operator">&lt;</span>button onClick<span class="token operator">=</span><span class="token punctuation">{</span><span class="token keyword">this</span><span class="token punctuation">.</span>handleClick<span class="token punctuation">}</span><span class="token operator">&gt;</span><span class="token operator">+</span><span class="token operator">&lt;</span><span class="token operator">/</span>button<span class="token operator">&gt;</span></span>
<span class="line">            <span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">&gt;</span></span>
<span class="line">        <span class="token punctuation">)</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"><span class="token keyword">class</span> <span class="token class-name">ChildCounter</span> <span class="token keyword">extends</span> <span class="token class-name">React<span class="token punctuation">.</span>Component</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter">props</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">super</span><span class="token punctuation">(</span>props<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">this</span><span class="token punctuation">.</span>state <span class="token operator">=</span> <span class="token punctuation">{</span> <span class="token literal-property property">number</span><span class="token operator">:</span> <span class="token number">0</span> <span class="token punctuation">}</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    <span class="token keyword">static</span> <span class="token function">getDerivedStateFromProps</span><span class="token punctuation">(</span><span class="token parameter">nextProps<span class="token punctuation">,</span> prevState</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">const</span> <span class="token punctuation">{</span> number <span class="token punctuation">}</span> <span class="token operator">=</span> nextProps<span class="token punctuation">;</span></span>
<span class="line">        <span class="token comment">// 当传入的type发生变化的时候，更新state</span></span>
<span class="line">        <span class="token keyword">if</span> <span class="token punctuation">(</span>number <span class="token operator">%</span> <span class="token number">2</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token keyword">return</span> <span class="token punctuation">{</span> <span class="token literal-property property">number</span><span class="token operator">:</span> number <span class="token operator">*</span> <span class="token number">2</span> <span class="token punctuation">}</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token keyword">return</span> <span class="token punctuation">{</span> <span class="token literal-property property">number</span><span class="token operator">:</span> number <span class="token operator">*</span> <span class="token number">3</span> <span class="token punctuation">}</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">        <span class="token comment">// 否则，对于state不进行任何操作</span></span>
<span class="line">        <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    <span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token operator">&lt;</span>div<span class="token operator">&gt;</span></span>
<span class="line">            <span class="token punctuation">{</span><span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">.</span>number<span class="token punctuation">}</span></span>
<span class="line">        <span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">&gt;</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">ReactDOM<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span></span>
<span class="line">    <span class="token operator">&lt;</span>Counter <span class="token operator">/</span><span class="token operator">&gt;</span><span class="token punctuation">,</span></span>
<span class="line">    document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">&#39;root&#39;</span><span class="token punctuation">)</span></span>
<span class="line"><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_7-1-2-react-vdom-js" tabindex="-1"><a class="header-anchor" href="#_7-1-2-react-vdom-js"><span>7.1.2 react\\vdom.js</span></a></h4><p>src\\react\\vdom.js</p><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code class="language-javascript"><span class="line"><span class="token keyword">import</span> <span class="token punctuation">{</span> <span class="token constant">TEXT</span><span class="token punctuation">,</span> <span class="token constant">ELEMENT</span><span class="token punctuation">,</span> <span class="token constant">FUNCTION_COMPONENT</span><span class="token punctuation">,</span> <span class="token constant">CLASS_COMPONENT</span><span class="token punctuation">,</span> <span class="token constant">MOVE</span><span class="token punctuation">,</span> <span class="token constant">INSERT</span><span class="token punctuation">,</span> <span class="token constant">REMOVE</span> <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&#39;./constants&#39;</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">import</span> <span class="token punctuation">{</span> setProps<span class="token punctuation">,</span> onlyOne<span class="token punctuation">,</span> patchProps<span class="token punctuation">,</span> flatten <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&#39;./utils&#39;</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">const</span> diffQueue <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">let</span> updateDepth <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">createDOM</span><span class="token punctuation">(</span><span class="token parameter">element</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    element <span class="token operator">=</span> <span class="token function">onlyOne</span><span class="token punctuation">(</span>element<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">let</span> <span class="token punctuation">{</span> $$<span class="token keyword">typeof</span> <span class="token punctuation">}</span> <span class="token operator">=</span> element<span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">let</span> dom <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>$$<span class="token keyword">typeof</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        dom <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">createTextNode</span><span class="token punctuation">(</span>element<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>$$<span class="token keyword">typeof</span> <span class="token operator">===</span> <span class="token constant">TEXT</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        dom <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">createTextNode</span><span class="token punctuation">(</span>element<span class="token punctuation">.</span>content<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>$$<span class="token keyword">typeof</span> <span class="token operator">===</span> <span class="token constant">ELEMENT</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        dom <span class="token operator">=</span> <span class="token function">createNativeDOM</span><span class="token punctuation">(</span>element<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>$$<span class="token keyword">typeof</span> <span class="token operator">===</span> <span class="token constant">FUNCTION_COMPONENT</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        dom <span class="token operator">=</span> <span class="token function">createFunctionComponentDOM</span><span class="token punctuation">(</span>element<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>$$<span class="token keyword">typeof</span> <span class="token operator">===</span> <span class="token constant">CLASS_COMPONENT</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        dom <span class="token operator">=</span> <span class="token function">createClassComponentDOM</span><span class="token punctuation">(</span>element<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    element<span class="token punctuation">.</span>dom <span class="token operator">=</span> dom<span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">return</span> dom<span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">function</span> <span class="token function">createNativeDOM</span><span class="token punctuation">(</span><span class="token parameter">element</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">let</span> <span class="token punctuation">{</span> type<span class="token punctuation">,</span> props <span class="token punctuation">}</span> <span class="token operator">=</span> element<span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">let</span> dom <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span>type<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token function">createChildren</span><span class="token punctuation">(</span>element<span class="token punctuation">,</span> dom<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token function">setProps</span><span class="token punctuation">(</span>dom<span class="token punctuation">,</span> props<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">return</span> dom<span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">function</span> <span class="token function">createChildren</span><span class="token punctuation">(</span><span class="token parameter">element<span class="token punctuation">,</span> parentNode</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    element<span class="token punctuation">.</span>props<span class="token punctuation">.</span>children <span class="token operator">&amp;&amp;</span> <span class="token function">flatten</span><span class="token punctuation">(</span>element<span class="token punctuation">.</span>props<span class="token punctuation">.</span>children<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">childElement<span class="token punctuation">,</span> index</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></span>
<span class="line">        childElement<span class="token punctuation">.</span>_mountIndex <span class="token operator">=</span> index<span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">let</span> childDOM <span class="token operator">=</span> <span class="token function">createDOM</span><span class="token punctuation">(</span>childElement<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        parentNode<span class="token punctuation">.</span><span class="token function">appendChild</span><span class="token punctuation">(</span>childDOM<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"><span class="token keyword">function</span> <span class="token function">createFunctionComponentDOM</span><span class="token punctuation">(</span><span class="token parameter">element</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">let</span> <span class="token punctuation">{</span> type<span class="token punctuation">,</span> props <span class="token punctuation">}</span> <span class="token operator">=</span> element<span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">let</span> renderElement <span class="token operator">=</span> <span class="token function">type</span><span class="token punctuation">(</span>props<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    element<span class="token punctuation">.</span>renderElement <span class="token operator">=</span> renderElement<span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">let</span> newDOM <span class="token operator">=</span> <span class="token function">createDOM</span><span class="token punctuation">(</span>renderElement<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    renderElement<span class="token punctuation">.</span>dom <span class="token operator">=</span> newDOM<span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">return</span> newDOM<span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"><span class="token keyword">function</span> <span class="token function">createClassComponentDOM</span><span class="token punctuation">(</span><span class="token parameter">element</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">let</span> <span class="token punctuation">{</span> type<span class="token punctuation">,</span> props <span class="token punctuation">}</span> <span class="token operator">=</span> element<span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">let</span> componentInstance <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">type</span><span class="token punctuation">(</span>props<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">if</span> <span class="token punctuation">(</span>componentInstance<span class="token punctuation">.</span>componentWillMount<span class="token punctuation">)</span></span>
<span class="line">        componentInstance<span class="token punctuation">.</span><span class="token function">componentWillMount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    element<span class="token punctuation">.</span>componentInstance <span class="token operator">=</span> componentInstance<span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">let</span> renderElement <span class="token operator">=</span> componentInstance<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    componentInstance<span class="token punctuation">.</span>renderElement <span class="token operator">=</span> renderElement<span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">let</span> newDOM <span class="token operator">=</span> <span class="token function">createDOM</span><span class="token punctuation">(</span>renderElement<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">if</span> <span class="token punctuation">(</span>componentInstance<span class="token punctuation">.</span>componentDidMount<span class="token punctuation">)</span></span>
<span class="line">        componentInstance<span class="token punctuation">.</span><span class="token function">componentDidMount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">return</span> newDOM<span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"><span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">compareTwoElements</span><span class="token punctuation">(</span><span class="token parameter">oldElement<span class="token punctuation">,</span> newElement</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    oldElement <span class="token operator">=</span> <span class="token function">onlyOne</span><span class="token punctuation">(</span>oldElement<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    newElement <span class="token operator">=</span> <span class="token function">onlyOne</span><span class="token punctuation">(</span>newElement<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">let</span> currentDOM <span class="token operator">=</span> oldElement<span class="token punctuation">.</span>dom<span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">let</span> currentElement <span class="token operator">=</span> oldElement<span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">if</span> <span class="token punctuation">(</span>newElement <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token comment">//如果新节点没有了，直接删除拉倒</span></span>
<span class="line">        currentDOM<span class="token punctuation">.</span>parentNode<span class="token punctuation">.</span><span class="token function">removeChild</span><span class="token punctuation">(</span>currentDOM<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        currentElement <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>oldElement<span class="token punctuation">.</span>type <span class="token operator">!==</span> newElement<span class="token punctuation">.</span>type<span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token comment">//如果类型不同</span></span>
<span class="line">        <span class="token keyword">let</span> newDOM <span class="token operator">=</span> <span class="token function">createDOM</span><span class="token punctuation">(</span>newElement<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        currentDOM<span class="token punctuation">.</span>parentNode<span class="token punctuation">.</span><span class="token function">replaceChild</span><span class="token punctuation">(</span>newDOM<span class="token punctuation">,</span> currentDOM<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        currentElement <span class="token operator">=</span> newElement<span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token function">updateElement</span><span class="token punctuation">(</span>oldElement<span class="token punctuation">,</span> newElement<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    <span class="token keyword">return</span> currentElement<span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">function</span> <span class="token function">updateElement</span><span class="token punctuation">(</span><span class="token parameter">oldElement<span class="token punctuation">,</span> newElement</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">let</span> currentDOM <span class="token operator">=</span> newElement<span class="token punctuation">.</span>dom <span class="token operator">=</span> oldElement<span class="token punctuation">.</span>dom<span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">if</span> <span class="token punctuation">(</span>oldElement<span class="token punctuation">.</span>$$<span class="token keyword">typeof</span> <span class="token operator">===</span> <span class="token constant">TEXT</span> <span class="token operator">&amp;&amp;</span> newElement<span class="token punctuation">.</span>$$<span class="token keyword">typeof</span> <span class="token operator">===</span> <span class="token constant">TEXT</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token comment">//如果都是文本类型，则直接改文本</span></span>
<span class="line">        <span class="token keyword">if</span> <span class="token punctuation">(</span>oldElement<span class="token punctuation">.</span>content <span class="token operator">!==</span> newElement<span class="token punctuation">.</span>content<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">            currentDOM<span class="token punctuation">.</span>textContent <span class="token operator">=</span> newElement<span class="token punctuation">.</span>content<span class="token punctuation">;</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>oldElement<span class="token punctuation">.</span>$$<span class="token keyword">typeof</span> <span class="token operator">===</span> <span class="token constant">ELEMENT</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token function">updateChildrenElements</span><span class="token punctuation">(</span>currentDOM<span class="token punctuation">,</span> oldElement<span class="token punctuation">.</span>props<span class="token punctuation">.</span>children<span class="token punctuation">,</span> newElement<span class="token punctuation">.</span>props<span class="token punctuation">.</span>children<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token function">updateDOMProps</span><span class="token punctuation">(</span>currentDOM<span class="token punctuation">,</span> oldElement<span class="token punctuation">.</span>props<span class="token punctuation">,</span> newElement<span class="token punctuation">.</span>props<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        oldElement<span class="token punctuation">.</span>props <span class="token operator">=</span> newElement<span class="token punctuation">.</span>props<span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>oldElement<span class="token punctuation">.</span>$$<span class="token keyword">typeof</span> <span class="token operator">===</span> <span class="token constant">CLASS_COMPONENT</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token function">updateClassComponent</span><span class="token punctuation">(</span>oldElement<span class="token punctuation">,</span> newElement<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        newElement<span class="token punctuation">.</span>componentInstance <span class="token operator">=</span> oldElement<span class="token punctuation">.</span>componentInstance<span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>oldElement<span class="token punctuation">.</span>$$<span class="token keyword">typeof</span> <span class="token operator">===</span> <span class="token constant">FUNCTION_COMPONENT</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token function">updateFunctionComponent</span><span class="token punctuation">(</span>oldElement<span class="token punctuation">,</span> newElement<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"><span class="token keyword">function</span> <span class="token function">updateChildrenElements</span><span class="token punctuation">(</span><span class="token parameter">dom<span class="token punctuation">,</span> oldChildrenElements<span class="token punctuation">,</span> newChildrenElement</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    updateDepth<span class="token operator">++</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token function">diff</span><span class="token punctuation">(</span>dom<span class="token punctuation">,</span> <span class="token function">flatten</span><span class="token punctuation">(</span>oldChildrenElements<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">flatten</span><span class="token punctuation">(</span>newChildrenElement<span class="token punctuation">)</span><span class="token punctuation">,</span> diffQueue<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    updateDepth<span class="token operator">--</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">if</span> <span class="token punctuation">(</span>updateDepth <span class="token operator">===</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token function">patch</span><span class="token punctuation">(</span>diffQueue<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        diffQueue<span class="token punctuation">.</span>length <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">function</span> <span class="token function">diff</span><span class="token punctuation">(</span><span class="token parameter">parentNode<span class="token punctuation">,</span> oldChildrenElements<span class="token punctuation">,</span> newChildrenElements<span class="token punctuation">,</span> diffQueue</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">let</span> oldChildrenElementMap <span class="token operator">=</span> <span class="token function">getChildrenElementMap</span><span class="token punctuation">(</span>oldChildrenElements<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">let</span> newChildrenElementMap <span class="token operator">=</span> <span class="token function">getNewChildren</span><span class="token punctuation">(</span>oldChildrenElementMap<span class="token punctuation">,</span> newChildrenElements<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">let</span> lastIndex <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> newChildrenElements<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">let</span> newElement <span class="token operator">=</span> newChildrenElements<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token comment">//取得新元素</span></span>
<span class="line">        <span class="token keyword">if</span> <span class="token punctuation">(</span>newElement<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token keyword">let</span> newKey <span class="token operator">=</span> <span class="token punctuation">(</span>newElement<span class="token punctuation">.</span>key<span class="token punctuation">)</span> <span class="token operator">||</span> i<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//取得新key</span></span>
<span class="line">            <span class="token keyword">let</span> oldElement <span class="token operator">=</span> oldChildrenElementMap<span class="token punctuation">[</span>newKey<span class="token punctuation">]</span><span class="token punctuation">;</span></span>
<span class="line">            <span class="token keyword">if</span> <span class="token punctuation">(</span>oldElement <span class="token operator">===</span> newElement<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">                <span class="token keyword">if</span> <span class="token punctuation">(</span>oldElement<span class="token punctuation">.</span>_mountIndex <span class="token operator">&lt;</span> lastIndex<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">                    diffQueue<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token punctuation">{</span></span>
<span class="line">                        parentNode<span class="token punctuation">,</span></span>
<span class="line">                        <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token constant">MOVE</span><span class="token punctuation">,</span></span>
<span class="line">                        <span class="token literal-property property">fromIndex</span><span class="token operator">:</span> oldElement<span class="token punctuation">.</span>_mountIndex<span class="token punctuation">,</span></span>
<span class="line">                        <span class="token literal-property property">toIndex</span><span class="token operator">:</span> i</span>
<span class="line">                    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">                <span class="token punctuation">}</span></span>
<span class="line">                lastIndex <span class="token operator">=</span> Math<span class="token punctuation">.</span><span class="token function">max</span><span class="token punctuation">(</span>oldElement<span class="token punctuation">.</span>_mountIndex<span class="token punctuation">,</span> lastIndex<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span></span>
<span class="line">                diffQueue<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token punctuation">{</span></span>
<span class="line">                    parentNode<span class="token punctuation">,</span></span>
<span class="line">                    <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token constant">INSERT</span><span class="token punctuation">,</span></span>
<span class="line">                    <span class="token literal-property property">toIndex</span><span class="token operator">:</span> i<span class="token punctuation">,</span></span>
<span class="line">                    <span class="token literal-property property">dom</span><span class="token operator">:</span> <span class="token function">createDOM</span><span class="token punctuation">(</span>newElement<span class="token punctuation">)</span></span>
<span class="line">                <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">            <span class="token punctuation">}</span></span>
<span class="line">            newElement<span class="token punctuation">.</span>_mountIndex <span class="token operator">=</span> i<span class="token punctuation">;</span></span>
<span class="line">        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token keyword">if</span> <span class="token punctuation">(</span>oldChildrenElements<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>componentInstance <span class="token operator">&amp;&amp;</span> oldChildrenElements<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>componentInstance<span class="token punctuation">.</span>componentWillUnmount<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">                oldChildrenElements<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>componentInstance<span class="token punctuation">.</span><span class="token function">componentWillUnmount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">            <span class="token punctuation">}</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> oldKey <span class="token keyword">in</span> oldChildrenElementMap<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>newChildrenElementMap<span class="token punctuation">.</span><span class="token function">hasOwnProperty</span><span class="token punctuation">(</span>oldKey<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token keyword">let</span> oldElement <span class="token operator">=</span> oldChildrenElementMap<span class="token punctuation">[</span>oldKey<span class="token punctuation">]</span><span class="token punctuation">;</span></span>
<span class="line">            diffQueue<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token punctuation">{</span></span>
<span class="line">                parentNode<span class="token punctuation">,</span></span>
<span class="line">                <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token constant">REMOVE</span><span class="token punctuation">,</span></span>
<span class="line">                <span class="token literal-property property">fromIndex</span><span class="token operator">:</span> oldElement<span class="token punctuation">.</span>_mountIndex</span>
<span class="line">            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"><span class="token keyword">function</span> <span class="token function">patch</span><span class="token punctuation">(</span><span class="token parameter">diffQueue</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">let</span> deleteChildren <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">let</span> deleteMap <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> diffQueue<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">let</span> difference <span class="token operator">=</span> diffQueue<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">if</span> <span class="token punctuation">(</span>difference<span class="token punctuation">.</span>type <span class="token operator">===</span> <span class="token constant">MOVE</span> <span class="token operator">||</span> difference<span class="token punctuation">.</span>type <span class="token operator">===</span> <span class="token constant">REMOVE</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token keyword">let</span> fromIndex <span class="token operator">=</span> difference<span class="token punctuation">.</span>fromIndex<span class="token punctuation">;</span></span>
<span class="line">            <span class="token keyword">let</span> oldChild <span class="token operator">=</span> difference<span class="token punctuation">.</span>parentNode<span class="token punctuation">.</span>children<span class="token punctuation">[</span>fromIndex<span class="token punctuation">]</span><span class="token punctuation">;</span></span>
<span class="line">            deleteMap<span class="token punctuation">[</span>fromIndex<span class="token punctuation">]</span> <span class="token operator">=</span> oldChild<span class="token punctuation">;</span></span>
<span class="line">            deleteChildren<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>oldChild<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    deleteChildren<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">child</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></span>
<span class="line">        child<span class="token punctuation">.</span>parentNode<span class="token punctuation">.</span><span class="token function">removeChild</span><span class="token punctuation">(</span>child<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> k <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> k <span class="token operator">&lt;</span> diffQueue<span class="token punctuation">.</span>length<span class="token punctuation">;</span> k<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">let</span> difference <span class="token operator">=</span> diffQueue<span class="token punctuation">[</span>k<span class="token punctuation">]</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">switch</span> <span class="token punctuation">(</span>difference<span class="token punctuation">.</span>type<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token keyword">case</span> <span class="token constant">INSERT</span><span class="token operator">:</span></span>
<span class="line">                <span class="token function">insertChildAt</span><span class="token punctuation">(</span>difference<span class="token punctuation">.</span>parentNode<span class="token punctuation">,</span> difference<span class="token punctuation">.</span>dom<span class="token punctuation">,</span> difference<span class="token punctuation">.</span>toIndex<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">                <span class="token keyword">break</span><span class="token punctuation">;</span></span>
<span class="line">            <span class="token keyword">case</span> <span class="token constant">MOVE</span><span class="token operator">:</span></span>
<span class="line">                <span class="token function">insertChildAt</span><span class="token punctuation">(</span>difference<span class="token punctuation">.</span>parentNode<span class="token punctuation">,</span> deleteMap<span class="token punctuation">[</span>difference<span class="token punctuation">.</span>fromIndex<span class="token punctuation">]</span><span class="token punctuation">,</span> difference<span class="token punctuation">.</span>toIndex<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">                <span class="token keyword">break</span><span class="token punctuation">;</span></span>
<span class="line">            <span class="token keyword">default</span><span class="token operator">:</span></span>
<span class="line">                <span class="token keyword">break</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">function</span> <span class="token function">insertChildAt</span><span class="token punctuation">(</span><span class="token parameter">parentNode<span class="token punctuation">,</span> childNode<span class="token punctuation">,</span> index</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">let</span> oldChild <span class="token operator">=</span> parentNode<span class="token punctuation">.</span>children<span class="token punctuation">[</span>index<span class="token punctuation">]</span></span>
<span class="line">    oldChild <span class="token operator">?</span> parentNode<span class="token punctuation">.</span><span class="token function">insertBefore</span><span class="token punctuation">(</span>childNode<span class="token punctuation">,</span> oldChild<span class="token punctuation">)</span> <span class="token operator">:</span> parentNode<span class="token punctuation">.</span><span class="token function">appendChild</span><span class="token punctuation">(</span>childNode<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">function</span> <span class="token function">getChildrenElementMap</span><span class="token punctuation">(</span><span class="token parameter">childrenElements</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">let</span> childrenElementMap <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> childrenElements<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">let</span> key <span class="token operator">=</span> childrenElements<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>key <span class="token operator">||</span> i<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        childrenElementMap<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">=</span> childrenElements<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    <span class="token keyword">return</span> childrenElementMap<span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">function</span> <span class="token function">getNewChildren</span><span class="token punctuation">(</span><span class="token parameter">oldChildrenElementMap<span class="token punctuation">,</span> newChildrenElements</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">let</span> newChildrenElementMap <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span></span>
<span class="line">    newChildrenElements<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">newChildElement<span class="token punctuation">,</span> index</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">if</span> <span class="token punctuation">(</span>newChildElement<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token keyword">let</span> newKey <span class="token operator">=</span> newChildElement<span class="token punctuation">.</span>key <span class="token operator">||</span> index<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">            <span class="token keyword">let</span> oldChildElement <span class="token operator">=</span> oldChildrenElementMap<span class="token punctuation">[</span>newKey<span class="token punctuation">]</span><span class="token punctuation">;</span></span>
<span class="line">            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">canDeepCompare</span><span class="token punctuation">(</span>oldChildElement<span class="token punctuation">,</span> newChildElement<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">                <span class="token function">updateElement</span><span class="token punctuation">(</span>oldChildElement<span class="token punctuation">,</span> newChildElement<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">                newChildrenElements<span class="token punctuation">[</span>index<span class="token punctuation">]</span> <span class="token operator">=</span> oldChildElement<span class="token punctuation">;</span></span>
<span class="line">            <span class="token punctuation">}</span></span>
<span class="line">            newChildrenElementMap<span class="token punctuation">[</span>newKey<span class="token punctuation">]</span> <span class="token operator">=</span> newChildrenElements<span class="token punctuation">[</span>index<span class="token punctuation">]</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">return</span> newChildrenElementMap<span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">function</span> <span class="token function">canDeepCompare</span><span class="token punctuation">(</span><span class="token parameter">oldChildElement<span class="token punctuation">,</span> newChildElement</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token operator">!</span>oldChildElement <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token operator">!</span>newChildElement<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">return</span> oldChildElement<span class="token punctuation">.</span>type <span class="token operator">===</span> newChildElement<span class="token punctuation">.</span>type<span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">function</span> <span class="token function">updateDOMProps</span><span class="token punctuation">(</span><span class="token parameter">dom<span class="token punctuation">,</span> oldProps<span class="token punctuation">,</span> newProps</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">return</span> <span class="token function">patchProps</span><span class="token punctuation">(</span>dom<span class="token punctuation">,</span> oldProps<span class="token punctuation">,</span> newProps<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">function</span> <span class="token function">updateClassComponent</span><span class="token punctuation">(</span><span class="token parameter">oldElement<span class="token punctuation">,</span> newElement</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">let</span> componentInstance <span class="token operator">=</span> oldElement<span class="token punctuation">.</span>componentInstance<span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">let</span> updater <span class="token operator">=</span> componentInstance<span class="token punctuation">.</span>$updater<span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">let</span> nextProps <span class="token operator">=</span> newElement<span class="token punctuation">.</span>props<span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">if</span> <span class="token punctuation">(</span>componentInstance<span class="token punctuation">.</span>componentWillReceiveProps<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        componentInstance<span class="token punctuation">.</span><span class="token function">componentWillReceiveProps</span><span class="token punctuation">(</span>nextProps<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"><span class="token operator">+</span>   <span class="token keyword">if</span> <span class="token punctuation">(</span>newElement<span class="token punctuation">.</span>type<span class="token punctuation">.</span>getDerivedStateFromProps<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line"><span class="token operator">+</span>       <span class="token keyword">let</span> newState <span class="token operator">=</span> newElement<span class="token punctuation">.</span>type<span class="token punctuation">.</span><span class="token function">getDerivedStateFromProps</span><span class="token punctuation">(</span>nextProps<span class="token punctuation">,</span> componentInstance<span class="token punctuation">.</span>state<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token operator">+</span>       <span class="token keyword">if</span> <span class="token punctuation">(</span>newState<span class="token punctuation">)</span></span>
<span class="line"><span class="token operator">+</span>           componentInstance<span class="token punctuation">.</span>state <span class="token operator">=</span> newState<span class="token punctuation">;</span></span>
<span class="line"><span class="token operator">+</span>   <span class="token punctuation">}</span></span>
<span class="line">    updater<span class="token punctuation">.</span><span class="token function">emitUpdate</span><span class="token punctuation">(</span>nextProps<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">function</span> <span class="token function">updateFunctionComponent</span><span class="token punctuation">(</span><span class="token parameter">oldElement<span class="token punctuation">,</span> newElement</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">let</span> newRenderElement <span class="token operator">=</span> newElement<span class="token punctuation">.</span><span class="token function">type</span><span class="token punctuation">(</span>newElement<span class="token punctuation">.</span>props<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">var</span> oldRenderElement <span class="token operator">=</span> oldElement<span class="token punctuation">.</span>renderElement<span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">var</span> currentElement <span class="token operator">=</span> <span class="token function">compareTwoElements</span><span class="token punctuation">(</span>oldRenderElement<span class="token punctuation">,</span> newRenderElement<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    newElement<span class="token punctuation">.</span>renderElement <span class="token operator">=</span> currentElement<span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"><span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">ReactElement</span><span class="token punctuation">(</span><span class="token parameter">$$<span class="token keyword">typeof</span><span class="token punctuation">,</span> type<span class="token punctuation">,</span> key<span class="token punctuation">,</span> ref<span class="token punctuation">,</span> props</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">let</span> element <span class="token operator">=</span> <span class="token punctuation">{</span></span>
<span class="line">        $$<span class="token keyword">typeof</span><span class="token punctuation">,</span></span>
<span class="line">        type<span class="token punctuation">,</span></span>
<span class="line">        props<span class="token punctuation">,</span></span>
<span class="line">        key<span class="token punctuation">,</span></span>
<span class="line">        ref</span>
<span class="line">    <span class="token punctuation">}</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">return</span> element<span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_7-2-scrollinglist" tabindex="-1"><a class="header-anchor" href="#_7-2-scrollinglist"><span>7.2 ScrollingList</span></a></h3><h4 id="_7-2-1-index-js" tabindex="-1"><a class="header-anchor" href="#_7-2-1-index-js"><span>7.2.1 index.js</span></a></h4><p>src/index.js</p><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text"><pre><code class="language-text"><span class="line">import React from &#39;./react&#39;;</span>
<span class="line">import ReactDOM from &#39;./react-dom&#39;;</span>
<span class="line">+class ScrollingList extends React.Component {</span>
<span class="line">+    wrapper</span>
<span class="line">+    timeID</span>
<span class="line">+    constructor(props) {</span>
<span class="line">+        super(props);</span>
<span class="line">+        this.state = { messages: [] }</span>
<span class="line">+        this.wrapper = React.createRef();</span>
<span class="line">+    }</span>
<span class="line"></span>
<span class="line">+    addMessage = () =&gt; {</span>
<span class="line">+        this.setState(state =&gt; ({</span>
<span class="line">+            messages: [\`\${state.messages.length}\`, ...state.messages],</span>
<span class="line">+        }))</span>
<span class="line">+    }</span>
<span class="line">+    componentDidMount() {</span>
<span class="line">+        this.timeID = window.setInterval(() =&gt; {//设置定时器</span>
<span class="line">+            this.addMessage();</span>
<span class="line">+        }, 3000)</span>
<span class="line">+    }</span>
<span class="line">+    componentWillUnmount() {//清除定时器</span>
<span class="line">+        window.clearInterval(this.timeID);</span>
<span class="line">+    }</span>
<span class="line">+    getSnapshotBeforeUpdate = () =&gt; {//很关键的，我们获取当前rootNode的scrollHeight，传到componentDidUpdate 的参数perScrollHeight</span>
<span class="line">+        return this.wrapper.current.scrollHeight;</span>
<span class="line">+    }</span>
<span class="line">+    componentDidUpdate(pervProps, pervState, prevScrollHeight) {</span>
<span class="line">+        const curScrollTop = this.wrapper.current.scrollTop;//当前向上卷去的高度</span>
<span class="line">+        //当前向上卷去的高度加上增加的内容高度</span>
<span class="line">+        this.wrapper.current.scrollTop = curScrollTop + (this.wrapper.current.scrollHeight - prevScrollHeight);</span>
<span class="line">+    }</span>
<span class="line">+    render() {</span>
<span class="line">+        let style = {</span>
<span class="line">+            height: &#39;100px&#39;,</span>
<span class="line">+            width: &#39;200px&#39;,</span>
<span class="line">+            border: &#39;1px solid red&#39;,</span>
<span class="line">+            overflow: &#39;auto&#39;</span>
<span class="line">+        }</span>
<span class="line">+        return (</span>
<span class="line">+            &lt;div style={style} ref={this.wrapper} &gt;</span>
<span class="line">+                {this.state.messages.map((message, index) =&gt; (</span>
<span class="line">+                    &lt;div key={index}&gt;{message}&lt;/div&gt;</span>
<span class="line">+                ))}</span>
<span class="line">+            &lt;/div&gt;</span>
<span class="line">+        );</span>
<span class="line">+    }</span>
<span class="line">+}</span>
<span class="line"></span>
<span class="line">ReactDOM.render(</span>
<span class="line">    &lt;ScrollingList /&gt;,</span>
<span class="line">    document.getElementById(&#39;root&#39;)</span>
<span class="line">);</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_7-2-2-react-component-js" tabindex="-1"><a class="header-anchor" href="#_7-2-2-react-component-js"><span>7.2.2 react\\component.js</span></a></h4><p>src\\react\\component.js</p><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text"><pre><code class="language-text"><span class="line">import { isFunction } from &#39;./utils&#39;;</span>
<span class="line">import { compareTwoElements } from &#39;./vdom&#39;;</span>
<span class="line">export let updateQueue = {</span>
<span class="line">    updaters: [],</span>
<span class="line">    isPending: false,</span>
<span class="line">    add(updater) {</span>
<span class="line">        this.updaters.push(updater);</span>
<span class="line">    },</span>
<span class="line">    batchUpdate() {</span>
<span class="line">        if (this.isPending) {</span>
<span class="line">            return;</span>
<span class="line">        }</span>
<span class="line">        this.isPending = true;</span>
<span class="line">        let { updaters } = this;</span>
<span class="line">        let updater;</span>
<span class="line">        while ((updater = updaters.pop())) {</span>
<span class="line">            updater.updateComponent();</span>
<span class="line">        }</span>
<span class="line">        this.isPending = false;</span>
<span class="line">    },</span>
<span class="line">};</span>
<span class="line">class Updater {</span>
<span class="line">    constructor(instance) {</span>
<span class="line">        this.instance = instance;</span>
<span class="line">        this.pendingStates = [];</span>
<span class="line">        this.nextProps = null;</span>
<span class="line">    }</span>
<span class="line">    addState(partialState) {</span>
<span class="line">        this.pendingStates.push(partialState);</span>
<span class="line">        this.emitUpdate();</span>
<span class="line">    }</span>
<span class="line">    emitUpdate(nextProps) {</span>
<span class="line">        this.nextProps = nextProps;</span>
<span class="line">        nextProps || !updateQueue.isPending</span>
<span class="line">            ? this.updateComponent()</span>
<span class="line">            : updateQueue.add(this);</span>
<span class="line">    }</span>
<span class="line">    updateComponent() {</span>
<span class="line">        let { instance, pendingStates, nextProps } = this;</span>
<span class="line">        if (nextProps || pendingStates.length &gt; 0) {</span>
<span class="line">            shouldUpdate(</span>
<span class="line">                instance,</span>
<span class="line">                nextProps,</span>
<span class="line">                this.getState()</span>
<span class="line">            );</span>
<span class="line">        }</span>
<span class="line">    }</span>
<span class="line"></span>
<span class="line">    getState() {</span>
<span class="line">        let { instance, pendingStates } = this;</span>
<span class="line">        let { state } = instance;</span>
<span class="line">        if (pendingStates.length) {</span>
<span class="line">            pendingStates.forEach(nextState =&gt; {</span>
<span class="line">                if (isFunction(nextState)) {</span>
<span class="line">                    nextState = nextState.call(instance, state);</span>
<span class="line">                }</span>
<span class="line">                state = { ...state, ...nextState };</span>
<span class="line">            });</span>
<span class="line">            pendingStates.length = 0;</span>
<span class="line">        }</span>
<span class="line">        return state;</span>
<span class="line">    }</span>
<span class="line">}</span>
<span class="line">function shouldUpdate(component, nextProps, nextState) {</span>
<span class="line">    component.props = nextProps;</span>
<span class="line">    component.state = nextState;</span>
<span class="line">    if (component.shouldComponentUpdate &amp;&amp; !component.shouldComponentUpdate(nextProps, nextState)) {</span>
<span class="line">        return;</span>
<span class="line">    }</span>
<span class="line">    component.forceUpdate();</span>
<span class="line">}</span>
<span class="line"></span>
<span class="line">class Component {</span>
<span class="line">    constructor(props) {</span>
<span class="line">        this.props = props;</span>
<span class="line">        this.$updater = new Updater(this);</span>
<span class="line">        this.state = {};</span>
<span class="line">        this.nextProps = null;</span>
<span class="line">    }</span>
<span class="line">    setState(partialState) {</span>
<span class="line">        this.$updater.addState(partialState);</span>
<span class="line">    }</span>
<span class="line">    forceUpdate() {</span>
<span class="line">        let { props, state, renderElement: oldRenderElement } = this;</span>
<span class="line">        if (this.componentWillUpdate) {</span>
<span class="line">            this.componentWillUpdate(props, state);</span>
<span class="line">        }</span>
<span class="line">+        let { getSnapshotBeforeUpdate } = this;</span>
<span class="line">+        let extraArgs = getSnapshotBeforeUpdate &amp;&amp; getSnapshotBeforeUpdate();</span>
<span class="line">        let newRenderElement = this.render();</span>
<span class="line">        let currentElement = compareTwoElements(oldRenderElement, newRenderElement);</span>
<span class="line">        this.renderElement = currentElement;</span>
<span class="line">        if (this.componentDidUpdate) {</span>
<span class="line">+            this.componentDidUpdate(props, state, extraArgs);</span>
<span class="line">        }</span>
<span class="line">    }</span>
<span class="line">}</span>
<span class="line">Component.prototype.isReactComponent = {};</span>
<span class="line">export {</span>
<span class="line">    Component</span>
<span class="line">}</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_7-2-3-react-vdom-js" tabindex="-1"><a class="header-anchor" href="#_7-2-3-react-vdom-js"><span>7.2.3 react\\vdom.js</span></a></h4><p>src\\react\\vdom.js</p><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code class="language-javascript"><span class="line"><span class="token keyword">import</span> <span class="token punctuation">{</span> <span class="token constant">TEXT</span><span class="token punctuation">,</span> <span class="token constant">ELEMENT</span><span class="token punctuation">,</span> <span class="token constant">FUNCTION_COMPONENT</span><span class="token punctuation">,</span> <span class="token constant">CLASS_COMPONENT</span><span class="token punctuation">,</span> <span class="token constant">MOVE</span><span class="token punctuation">,</span> <span class="token constant">INSERT</span><span class="token punctuation">,</span> <span class="token constant">REMOVE</span> <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&#39;./constants&#39;</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">import</span> <span class="token punctuation">{</span> setProps<span class="token punctuation">,</span> onlyOne<span class="token punctuation">,</span> patchProps<span class="token punctuation">,</span> flatten <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&#39;./utils&#39;</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">const</span> diffQueue <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">let</span> updateDepth <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">createDOM</span><span class="token punctuation">(</span><span class="token parameter">element</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    element <span class="token operator">=</span> <span class="token function">onlyOne</span><span class="token punctuation">(</span>element<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">let</span> <span class="token punctuation">{</span> $$<span class="token keyword">typeof</span> <span class="token punctuation">}</span> <span class="token operator">=</span> element<span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">let</span> dom <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>$$<span class="token keyword">typeof</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        dom <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">createTextNode</span><span class="token punctuation">(</span>element<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>$$<span class="token keyword">typeof</span> <span class="token operator">===</span> <span class="token constant">TEXT</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        dom <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">createTextNode</span><span class="token punctuation">(</span>element<span class="token punctuation">.</span>content<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>$$<span class="token keyword">typeof</span> <span class="token operator">===</span> <span class="token constant">ELEMENT</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        dom <span class="token operator">=</span> <span class="token function">createNativeDOM</span><span class="token punctuation">(</span>element<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>$$<span class="token keyword">typeof</span> <span class="token operator">===</span> <span class="token constant">FUNCTION_COMPONENT</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        dom <span class="token operator">=</span> <span class="token function">createFunctionComponentDOM</span><span class="token punctuation">(</span>element<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>$$<span class="token keyword">typeof</span> <span class="token operator">===</span> <span class="token constant">CLASS_COMPONENT</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        dom <span class="token operator">=</span> <span class="token function">createClassComponentDOM</span><span class="token punctuation">(</span>element<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    element<span class="token punctuation">.</span>dom <span class="token operator">=</span> dom<span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">return</span> dom<span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">function</span> <span class="token function">createNativeDOM</span><span class="token punctuation">(</span><span class="token parameter">element</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">let</span> <span class="token punctuation">{</span> type<span class="token punctuation">,</span> props<span class="token punctuation">,</span> ref <span class="token punctuation">}</span> <span class="token operator">=</span> element<span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">let</span> dom <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span>type<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token function">createChildren</span><span class="token punctuation">(</span>element<span class="token punctuation">,</span> dom<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token function">setProps</span><span class="token punctuation">(</span>dom<span class="token punctuation">,</span> props<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token operator">+</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>ref<span class="token punctuation">)</span></span>
<span class="line"><span class="token operator">+</span>        ref<span class="token punctuation">.</span>current <span class="token operator">=</span> dom<span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">return</span> dom<span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">function</span> <span class="token function">createChildren</span><span class="token punctuation">(</span><span class="token parameter">element<span class="token punctuation">,</span> parentNode</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    element<span class="token punctuation">.</span>props<span class="token punctuation">.</span>children <span class="token operator">&amp;&amp;</span> <span class="token function">flatten</span><span class="token punctuation">(</span>element<span class="token punctuation">.</span>props<span class="token punctuation">.</span>children<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">childElement<span class="token punctuation">,</span> index</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></span>
<span class="line">        childElement<span class="token punctuation">.</span>_mountIndex <span class="token operator">=</span> index<span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">let</span> childDOM <span class="token operator">=</span> <span class="token function">createDOM</span><span class="token punctuation">(</span>childElement<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        parentNode<span class="token punctuation">.</span><span class="token function">appendChild</span><span class="token punctuation">(</span>childDOM<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"><span class="token keyword">function</span> <span class="token function">createFunctionComponentDOM</span><span class="token punctuation">(</span><span class="token parameter">element</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">let</span> <span class="token punctuation">{</span> type<span class="token punctuation">,</span> props <span class="token punctuation">}</span> <span class="token operator">=</span> element<span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">let</span> renderElement <span class="token operator">=</span> <span class="token function">type</span><span class="token punctuation">(</span>props<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    element<span class="token punctuation">.</span>renderElement <span class="token operator">=</span> renderElement<span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">let</span> newDOM <span class="token operator">=</span> <span class="token function">createDOM</span><span class="token punctuation">(</span>renderElement<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    renderElement<span class="token punctuation">.</span>dom <span class="token operator">=</span> newDOM<span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">return</span> newDOM<span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"><span class="token keyword">function</span> <span class="token function">createClassComponentDOM</span><span class="token punctuation">(</span><span class="token parameter">element</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">let</span> <span class="token punctuation">{</span> type<span class="token punctuation">,</span> props<span class="token punctuation">,</span> ref <span class="token punctuation">}</span> <span class="token operator">=</span> element<span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">let</span> componentInstance <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">type</span><span class="token punctuation">(</span>props<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token operator">+</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>ref<span class="token punctuation">)</span></span>
<span class="line"><span class="token operator">+</span>        ref<span class="token punctuation">.</span>current <span class="token operator">=</span> componentInstance<span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">if</span> <span class="token punctuation">(</span>componentInstance<span class="token punctuation">.</span>componentWillMount<span class="token punctuation">)</span></span>
<span class="line">        componentInstance<span class="token punctuation">.</span><span class="token function">componentWillMount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    element<span class="token punctuation">.</span>componentInstance <span class="token operator">=</span> componentInstance<span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">let</span> renderElement <span class="token operator">=</span> componentInstance<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    componentInstance<span class="token punctuation">.</span>renderElement <span class="token operator">=</span> renderElement<span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">let</span> newDOM <span class="token operator">=</span> <span class="token function">createDOM</span><span class="token punctuation">(</span>renderElement<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">if</span> <span class="token punctuation">(</span>componentInstance<span class="token punctuation">.</span>componentDidMount<span class="token punctuation">)</span></span>
<span class="line">        componentInstance<span class="token punctuation">.</span><span class="token function">componentDidMount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">return</span> newDOM<span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"><span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">compareTwoElements</span><span class="token punctuation">(</span><span class="token parameter">oldElement<span class="token punctuation">,</span> newElement</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    oldElement <span class="token operator">=</span> <span class="token function">onlyOne</span><span class="token punctuation">(</span>oldElement<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    newElement <span class="token operator">=</span> <span class="token function">onlyOne</span><span class="token punctuation">(</span>newElement<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">let</span> currentDOM <span class="token operator">=</span> oldElement<span class="token punctuation">.</span>dom<span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">let</span> currentElement <span class="token operator">=</span> oldElement<span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">if</span> <span class="token punctuation">(</span>newElement <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token comment">//如果新节点没有了，直接删除拉倒</span></span>
<span class="line">        currentDOM<span class="token punctuation">.</span>parentNode<span class="token punctuation">.</span><span class="token function">removeChild</span><span class="token punctuation">(</span>currentDOM<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        currentElement <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>oldElement<span class="token punctuation">.</span>type <span class="token operator">!==</span> newElement<span class="token punctuation">.</span>type<span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token comment">//如果类型不同</span></span>
<span class="line">        <span class="token keyword">let</span> newDOM <span class="token operator">=</span> <span class="token function">createDOM</span><span class="token punctuation">(</span>newElement<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        currentDOM<span class="token punctuation">.</span>parentNode<span class="token punctuation">.</span><span class="token function">replaceChild</span><span class="token punctuation">(</span>newDOM<span class="token punctuation">,</span> currentDOM<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        currentElement <span class="token operator">=</span> newElement<span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token function">updateElement</span><span class="token punctuation">(</span>oldElement<span class="token punctuation">,</span> newElement<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    <span class="token keyword">return</span> currentElement<span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">function</span> <span class="token function">updateElement</span><span class="token punctuation">(</span><span class="token parameter">oldElement<span class="token punctuation">,</span> newElement</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">let</span> currentDOM <span class="token operator">=</span> newElement<span class="token punctuation">.</span>dom <span class="token operator">=</span> oldElement<span class="token punctuation">.</span>dom<span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">if</span> <span class="token punctuation">(</span>oldElement<span class="token punctuation">.</span>$$<span class="token keyword">typeof</span> <span class="token operator">===</span> <span class="token constant">TEXT</span> <span class="token operator">&amp;&amp;</span> newElement<span class="token punctuation">.</span>$$<span class="token keyword">typeof</span> <span class="token operator">===</span> <span class="token constant">TEXT</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token comment">//如果都是文本类型，则直接改文本</span></span>
<span class="line">        <span class="token keyword">if</span> <span class="token punctuation">(</span>oldElement<span class="token punctuation">.</span>content <span class="token operator">!==</span> newElement<span class="token punctuation">.</span>content<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">            currentDOM<span class="token punctuation">.</span>textContent <span class="token operator">=</span> newElement<span class="token punctuation">.</span>content<span class="token punctuation">;</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>oldElement<span class="token punctuation">.</span>$$<span class="token keyword">typeof</span> <span class="token operator">===</span> <span class="token constant">ELEMENT</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token function">updateChildrenElements</span><span class="token punctuation">(</span>currentDOM<span class="token punctuation">,</span> oldElement<span class="token punctuation">.</span>props<span class="token punctuation">.</span>children<span class="token punctuation">,</span> newElement<span class="token punctuation">.</span>props<span class="token punctuation">.</span>children<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token function">updateDOMProps</span><span class="token punctuation">(</span>currentDOM<span class="token punctuation">,</span> oldElement<span class="token punctuation">.</span>props<span class="token punctuation">,</span> newElement<span class="token punctuation">.</span>props<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        oldElement<span class="token punctuation">.</span>props <span class="token operator">=</span> newElement<span class="token punctuation">.</span>props<span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>oldElement<span class="token punctuation">.</span>$$<span class="token keyword">typeof</span> <span class="token operator">===</span> <span class="token constant">CLASS_COMPONENT</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token function">updateClassComponent</span><span class="token punctuation">(</span>oldElement<span class="token punctuation">,</span> newElement<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        newElement<span class="token punctuation">.</span>componentInstance <span class="token operator">=</span> oldElement<span class="token punctuation">.</span>componentInstance<span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>oldElement<span class="token punctuation">.</span>$$<span class="token keyword">typeof</span> <span class="token operator">===</span> <span class="token constant">FUNCTION_COMPONENT</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token function">updateFunctionComponent</span><span class="token punctuation">(</span>oldElement<span class="token punctuation">,</span> newElement<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"><span class="token keyword">function</span> <span class="token function">updateChildrenElements</span><span class="token punctuation">(</span><span class="token parameter">dom<span class="token punctuation">,</span> oldChildrenElements<span class="token punctuation">,</span> newChildrenElement</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    updateDepth<span class="token operator">++</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token function">diff</span><span class="token punctuation">(</span>dom<span class="token punctuation">,</span> <span class="token function">flatten</span><span class="token punctuation">(</span>oldChildrenElements<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">flatten</span><span class="token punctuation">(</span>newChildrenElement<span class="token punctuation">)</span><span class="token punctuation">,</span> diffQueue<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    updateDepth<span class="token operator">--</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">if</span> <span class="token punctuation">(</span>updateDepth <span class="token operator">===</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token function">patch</span><span class="token punctuation">(</span>diffQueue<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        diffQueue<span class="token punctuation">.</span>length <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">function</span> <span class="token function">diff</span><span class="token punctuation">(</span><span class="token parameter">parentNode<span class="token punctuation">,</span> oldChildrenElements<span class="token punctuation">,</span> newChildrenElements<span class="token punctuation">,</span> diffQueue</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">let</span> oldChildrenElementMap <span class="token operator">=</span> <span class="token function">getChildrenElementMap</span><span class="token punctuation">(</span>oldChildrenElements<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">let</span> newChildrenElementMap <span class="token operator">=</span> <span class="token function">getNewChildren</span><span class="token punctuation">(</span>oldChildrenElementMap<span class="token punctuation">,</span> newChildrenElements<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">let</span> lastIndex <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> newChildrenElements<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">let</span> newElement <span class="token operator">=</span> newChildrenElements<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token comment">//取得新元素</span></span>
<span class="line">        <span class="token keyword">if</span> <span class="token punctuation">(</span>newElement<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token keyword">let</span> newKey <span class="token operator">=</span> <span class="token punctuation">(</span>newElement<span class="token punctuation">.</span>key<span class="token punctuation">)</span> <span class="token operator">||</span> i<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//取得新key</span></span>
<span class="line">            <span class="token keyword">let</span> oldElement <span class="token operator">=</span> oldChildrenElementMap<span class="token punctuation">[</span>newKey<span class="token punctuation">]</span><span class="token punctuation">;</span></span>
<span class="line">            <span class="token keyword">if</span> <span class="token punctuation">(</span>oldElement <span class="token operator">===</span> newElement<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">                <span class="token keyword">if</span> <span class="token punctuation">(</span>oldElement<span class="token punctuation">.</span>_mountIndex <span class="token operator">&lt;</span> lastIndex<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">                    diffQueue<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token punctuation">{</span></span>
<span class="line">                        parentNode<span class="token punctuation">,</span></span>
<span class="line">                        <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token constant">MOVE</span><span class="token punctuation">,</span></span>
<span class="line">                        <span class="token literal-property property">fromIndex</span><span class="token operator">:</span> oldElement<span class="token punctuation">.</span>_mountIndex<span class="token punctuation">,</span></span>
<span class="line">                        <span class="token literal-property property">toIndex</span><span class="token operator">:</span> i</span>
<span class="line">                    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">                <span class="token punctuation">}</span></span>
<span class="line">                lastIndex <span class="token operator">=</span> Math<span class="token punctuation">.</span><span class="token function">max</span><span class="token punctuation">(</span>oldElement<span class="token punctuation">.</span>_mountIndex<span class="token punctuation">,</span> lastIndex<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span></span>
<span class="line">                diffQueue<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token punctuation">{</span></span>
<span class="line">                    parentNode<span class="token punctuation">,</span></span>
<span class="line">                    <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token constant">INSERT</span><span class="token punctuation">,</span></span>
<span class="line">                    <span class="token literal-property property">toIndex</span><span class="token operator">:</span> i<span class="token punctuation">,</span></span>
<span class="line">                    <span class="token literal-property property">dom</span><span class="token operator">:</span> <span class="token function">createDOM</span><span class="token punctuation">(</span>newElement<span class="token punctuation">)</span></span>
<span class="line">                <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">            <span class="token punctuation">}</span></span>
<span class="line">            newElement<span class="token punctuation">.</span>_mountIndex <span class="token operator">=</span> i<span class="token punctuation">;</span></span>
<span class="line">        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token keyword">if</span> <span class="token punctuation">(</span>oldChildrenElements<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>componentInstance <span class="token operator">&amp;&amp;</span> oldChildrenElements<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>componentInstance<span class="token punctuation">.</span>componentWillUnmount<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">                oldChildrenElements<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>componentInstance<span class="token punctuation">.</span><span class="token function">componentWillUnmount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">            <span class="token punctuation">}</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> oldKey <span class="token keyword">in</span> oldChildrenElementMap<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>newChildrenElementMap<span class="token punctuation">.</span><span class="token function">hasOwnProperty</span><span class="token punctuation">(</span>oldKey<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token keyword">let</span> oldElement <span class="token operator">=</span> oldChildrenElementMap<span class="token punctuation">[</span>oldKey<span class="token punctuation">]</span><span class="token punctuation">;</span></span>
<span class="line">            diffQueue<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token punctuation">{</span></span>
<span class="line">                parentNode<span class="token punctuation">,</span></span>
<span class="line">                <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token constant">REMOVE</span><span class="token punctuation">,</span></span>
<span class="line">                <span class="token literal-property property">fromIndex</span><span class="token operator">:</span> oldElement<span class="token punctuation">.</span>_mountIndex</span>
<span class="line">            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"><span class="token keyword">function</span> <span class="token function">patch</span><span class="token punctuation">(</span><span class="token parameter">diffQueue</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">let</span> deleteChildren <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">let</span> deleteMap <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> diffQueue<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">let</span> difference <span class="token operator">=</span> diffQueue<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">if</span> <span class="token punctuation">(</span>difference<span class="token punctuation">.</span>type <span class="token operator">===</span> <span class="token constant">MOVE</span> <span class="token operator">||</span> difference<span class="token punctuation">.</span>type <span class="token operator">===</span> <span class="token constant">REMOVE</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token keyword">let</span> fromIndex <span class="token operator">=</span> difference<span class="token punctuation">.</span>fromIndex<span class="token punctuation">;</span></span>
<span class="line">            <span class="token keyword">let</span> oldChild <span class="token operator">=</span> difference<span class="token punctuation">.</span>parentNode<span class="token punctuation">.</span>children<span class="token punctuation">[</span>fromIndex<span class="token punctuation">]</span><span class="token punctuation">;</span></span>
<span class="line">            deleteMap<span class="token punctuation">[</span>fromIndex<span class="token punctuation">]</span> <span class="token operator">=</span> oldChild<span class="token punctuation">;</span></span>
<span class="line">            deleteChildren<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>oldChild<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    deleteChildren<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">child</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></span>
<span class="line">        child<span class="token punctuation">.</span>parentNode<span class="token punctuation">.</span><span class="token function">removeChild</span><span class="token punctuation">(</span>child<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> k <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> k <span class="token operator">&lt;</span> diffQueue<span class="token punctuation">.</span>length<span class="token punctuation">;</span> k<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">let</span> difference <span class="token operator">=</span> diffQueue<span class="token punctuation">[</span>k<span class="token punctuation">]</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">switch</span> <span class="token punctuation">(</span>difference<span class="token punctuation">.</span>type<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token keyword">case</span> <span class="token constant">INSERT</span><span class="token operator">:</span></span>
<span class="line">                <span class="token function">insertChildAt</span><span class="token punctuation">(</span>difference<span class="token punctuation">.</span>parentNode<span class="token punctuation">,</span> difference<span class="token punctuation">.</span>dom<span class="token punctuation">,</span> difference<span class="token punctuation">.</span>toIndex<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">                <span class="token keyword">break</span><span class="token punctuation">;</span></span>
<span class="line">            <span class="token keyword">case</span> <span class="token constant">MOVE</span><span class="token operator">:</span></span>
<span class="line">                <span class="token function">insertChildAt</span><span class="token punctuation">(</span>difference<span class="token punctuation">.</span>parentNode<span class="token punctuation">,</span> deleteMap<span class="token punctuation">[</span>difference<span class="token punctuation">.</span>fromIndex<span class="token punctuation">]</span><span class="token punctuation">,</span> difference<span class="token punctuation">.</span>toIndex<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">                <span class="token keyword">break</span><span class="token punctuation">;</span></span>
<span class="line">            <span class="token keyword">default</span><span class="token operator">:</span></span>
<span class="line">                <span class="token keyword">break</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">function</span> <span class="token function">insertChildAt</span><span class="token punctuation">(</span><span class="token parameter">parentNode<span class="token punctuation">,</span> childNode<span class="token punctuation">,</span> index</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">let</span> oldChild <span class="token operator">=</span> parentNode<span class="token punctuation">.</span>children<span class="token punctuation">[</span>index<span class="token punctuation">]</span></span>
<span class="line">    oldChild <span class="token operator">?</span> parentNode<span class="token punctuation">.</span><span class="token function">insertBefore</span><span class="token punctuation">(</span>childNode<span class="token punctuation">,</span> oldChild<span class="token punctuation">)</span> <span class="token operator">:</span> parentNode<span class="token punctuation">.</span><span class="token function">appendChild</span><span class="token punctuation">(</span>childNode<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">function</span> <span class="token function">getChildrenElementMap</span><span class="token punctuation">(</span><span class="token parameter">childrenElements</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">let</span> childrenElementMap <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> childrenElements<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">let</span> key <span class="token operator">=</span> childrenElements<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>key <span class="token operator">||</span> i<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        childrenElementMap<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">=</span> childrenElements<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    <span class="token keyword">return</span> childrenElementMap<span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">function</span> <span class="token function">getNewChildren</span><span class="token punctuation">(</span><span class="token parameter">oldChildrenElementMap<span class="token punctuation">,</span> newChildrenElements</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">let</span> newChildrenElementMap <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span></span>
<span class="line">    newChildrenElements<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">newChildElement<span class="token punctuation">,</span> index</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">if</span> <span class="token punctuation">(</span>newChildElement<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token keyword">let</span> newKey <span class="token operator">=</span> newChildElement<span class="token punctuation">.</span>key <span class="token operator">||</span> index<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">            <span class="token keyword">let</span> oldChildElement <span class="token operator">=</span> oldChildrenElementMap<span class="token punctuation">[</span>newKey<span class="token punctuation">]</span><span class="token punctuation">;</span></span>
<span class="line">            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">canDeepCompare</span><span class="token punctuation">(</span>oldChildElement<span class="token punctuation">,</span> newChildElement<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">                <span class="token function">updateElement</span><span class="token punctuation">(</span>oldChildElement<span class="token punctuation">,</span> newChildElement<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">                newChildrenElements<span class="token punctuation">[</span>index<span class="token punctuation">]</span> <span class="token operator">=</span> oldChildElement<span class="token punctuation">;</span></span>
<span class="line">            <span class="token punctuation">}</span></span>
<span class="line">            newChildrenElementMap<span class="token punctuation">[</span>newKey<span class="token punctuation">]</span> <span class="token operator">=</span> newChildrenElements<span class="token punctuation">[</span>index<span class="token punctuation">]</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">return</span> newChildrenElementMap<span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">function</span> <span class="token function">canDeepCompare</span><span class="token punctuation">(</span><span class="token parameter">oldChildElement<span class="token punctuation">,</span> newChildElement</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token operator">!</span>oldChildElement <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token operator">!</span>newChildElement<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">return</span> oldChildElement<span class="token punctuation">.</span>type <span class="token operator">===</span> newChildElement<span class="token punctuation">.</span>type<span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">function</span> <span class="token function">updateDOMProps</span><span class="token punctuation">(</span><span class="token parameter">dom<span class="token punctuation">,</span> oldProps<span class="token punctuation">,</span> newProps</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">return</span> <span class="token function">patchProps</span><span class="token punctuation">(</span>dom<span class="token punctuation">,</span> oldProps<span class="token punctuation">,</span> newProps<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">function</span> <span class="token function">updateClassComponent</span><span class="token punctuation">(</span><span class="token parameter">oldElement<span class="token punctuation">,</span> newElement</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">let</span> componentInstance <span class="token operator">=</span> oldElement<span class="token punctuation">.</span>componentInstance<span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">let</span> updater <span class="token operator">=</span> componentInstance<span class="token punctuation">.</span>$updater<span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">let</span> nextProps <span class="token operator">=</span> newElement<span class="token punctuation">.</span>props<span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">if</span> <span class="token punctuation">(</span>componentInstance<span class="token punctuation">.</span>componentWillReceiveProps<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        componentInstance<span class="token punctuation">.</span><span class="token function">componentWillReceiveProps</span><span class="token punctuation">(</span>nextProps<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    <span class="token keyword">if</span> <span class="token punctuation">(</span>newElement<span class="token punctuation">.</span>type<span class="token punctuation">.</span>getDerivedStateFromProps<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">let</span> newState <span class="token operator">=</span> newElement<span class="token punctuation">.</span>type<span class="token punctuation">.</span><span class="token function">getDerivedStateFromProps</span><span class="token punctuation">(</span>nextProps<span class="token punctuation">,</span> componentInstance<span class="token punctuation">.</span>state<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">if</span> <span class="token punctuation">(</span>newState<span class="token punctuation">)</span></span>
<span class="line">            componentInstance<span class="token punctuation">.</span>state <span class="token operator">=</span> newState<span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    updater<span class="token punctuation">.</span><span class="token function">emitUpdate</span><span class="token punctuation">(</span>nextProps<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">function</span> <span class="token function">updateFunctionComponent</span><span class="token punctuation">(</span><span class="token parameter">oldElement<span class="token punctuation">,</span> newElement</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">let</span> newRenderElement <span class="token operator">=</span> newElement<span class="token punctuation">.</span><span class="token function">type</span><span class="token punctuation">(</span>newElement<span class="token punctuation">.</span>props<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">var</span> oldRenderElement <span class="token operator">=</span> oldElement<span class="token punctuation">.</span>renderElement<span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">var</span> currentElement <span class="token operator">=</span> <span class="token function">compareTwoElements</span><span class="token punctuation">(</span>oldRenderElement<span class="token punctuation">,</span> newRenderElement<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    newElement<span class="token punctuation">.</span>renderElement <span class="token operator">=</span> currentElement<span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"><span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">ReactElement</span><span class="token punctuation">(</span><span class="token parameter">$$<span class="token keyword">typeof</span><span class="token punctuation">,</span> type<span class="token punctuation">,</span> key<span class="token punctuation">,</span> ref<span class="token punctuation">,</span> props</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">let</span> element <span class="token operator">=</span> <span class="token punctuation">{</span></span>
<span class="line">        $$<span class="token keyword">typeof</span><span class="token punctuation">,</span></span>
<span class="line">        type<span class="token punctuation">,</span></span>
<span class="line">        props<span class="token punctuation">,</span></span>
<span class="line">        key<span class="token punctuation">,</span></span>
<span class="line">        ref</span>
<span class="line">    <span class="token punctuation">}</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">return</span> element<span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="_8-context" tabindex="-1"><a class="header-anchor" href="#_8-context"><span>8. context</span></a></h2><h3 id="_8-1-src-index-js" tabindex="-1"><a class="header-anchor" href="#_8-1-src-index-js"><span>8.1 src\\index.js</span></a></h3><p>src\\index.js</p><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code class="language-javascript"><span class="line"><span class="token keyword">import</span> React<span class="token punctuation">,</span> <span class="token punctuation">{</span> Component <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&#39;./react&#39;</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">import</span> ReactDOM <span class="token keyword">from</span> <span class="token string">&#39;./react-dom&#39;</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">let</span> ThemeContext <span class="token operator">=</span> React<span class="token punctuation">.</span><span class="token function">createContext</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"> <span class="token keyword">let</span> root <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">querySelector</span><span class="token punctuation">(</span>&#39;</span>
<span class="line"><span class="token keyword">class</span> <span class="token class-name">Header</span> <span class="token keyword">extends</span> <span class="token class-name">Component</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">static</span> contextType <span class="token operator">=</span> ThemeContext<span class="token punctuation">;</span></span>
<span class="line">    <span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">return</span> <span class="token punctuation">(</span></span>
<span class="line">            <span class="token operator">&lt;</span>div style<span class="token operator">=</span><span class="token punctuation">{</span><span class="token punctuation">{</span> <span class="token literal-property property">border</span><span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">\`</span><span class="token string">5px solid </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">\${</span><span class="token keyword">this</span><span class="token punctuation">.</span>context<span class="token punctuation">.</span>color<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">\`</span></span><span class="token punctuation">,</span> <span class="token literal-property property">padding</span><span class="token operator">:</span> <span class="token string">&#39;5px&#39;</span> <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token operator">&gt;</span></span>
<span class="line">                header</span>
<span class="line">                <span class="token operator">&lt;</span>Title <span class="token operator">/</span><span class="token operator">&gt;</span></span>
<span class="line">            <span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">&gt;</span></span>
<span class="line">        <span class="token punctuation">)</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"><span class="token keyword">class</span> <span class="token class-name">Title</span> <span class="token keyword">extends</span> <span class="token class-name">Component</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">static</span> contextType <span class="token operator">=</span> ThemeContext<span class="token punctuation">;</span></span>
<span class="line">    <span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">return</span> <span class="token punctuation">(</span></span>
<span class="line">            <span class="token operator">&lt;</span>div style<span class="token operator">=</span><span class="token punctuation">{</span><span class="token punctuation">{</span> <span class="token literal-property property">border</span><span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">\`</span><span class="token string">5px solid </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">\${</span><span class="token keyword">this</span><span class="token punctuation">.</span>context<span class="token punctuation">.</span>color<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">\`</span></span> <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token operator">&gt;</span></span>
<span class="line">                title</span>
<span class="line">            <span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">&gt;</span></span>
<span class="line">        <span class="token punctuation">)</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"><span class="token keyword">class</span> <span class="token class-name">Main</span> <span class="token keyword">extends</span> <span class="token class-name">Component</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">static</span> contextType <span class="token operator">=</span> ThemeContext<span class="token punctuation">;</span></span>
<span class="line">    <span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">return</span> <span class="token punctuation">(</span></span>
<span class="line">            <span class="token operator">&lt;</span>div style<span class="token operator">=</span><span class="token punctuation">{</span><span class="token punctuation">{</span> <span class="token literal-property property">border</span><span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">\`</span><span class="token string">5px solid </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">\${</span><span class="token keyword">this</span><span class="token punctuation">.</span>context<span class="token punctuation">.</span>color<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">\`</span></span><span class="token punctuation">,</span> <span class="token literal-property property">margin</span><span class="token operator">:</span> <span class="token string">&#39;5px&#39;</span><span class="token punctuation">,</span> <span class="token literal-property property">padding</span><span class="token operator">:</span> <span class="token string">&#39;5px&#39;</span> <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token operator">&gt;</span></span>
<span class="line">                main</span>
<span class="line">                <span class="token operator">&lt;</span>Content <span class="token operator">/</span><span class="token operator">&gt;</span></span>
<span class="line">            <span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">&gt;</span></span>
<span class="line">        <span class="token punctuation">)</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"><span class="token keyword">class</span> <span class="token class-name">Content</span> <span class="token keyword">extends</span> <span class="token class-name">Component</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">static</span> contextType <span class="token operator">=</span> ThemeContext<span class="token punctuation">;</span></span>
<span class="line">    <span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">return</span> <span class="token punctuation">(</span></span>
<span class="line">            <span class="token operator">&lt;</span>div style<span class="token operator">=</span><span class="token punctuation">{</span><span class="token punctuation">{</span> <span class="token literal-property property">border</span><span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">\`</span><span class="token string">5px solid </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">\${</span><span class="token keyword">this</span><span class="token punctuation">.</span>context<span class="token punctuation">.</span>color<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">\`</span></span><span class="token punctuation">,</span> <span class="token literal-property property">padding</span><span class="token operator">:</span> <span class="token string">&#39;5px&#39;</span> <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token operator">&gt;</span></span>
<span class="line">                Content</span>
<span class="line">                <span class="token operator">&lt;</span>button onClick<span class="token operator">=</span><span class="token punctuation">{</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token keyword">this</span><span class="token punctuation">.</span>context<span class="token punctuation">.</span><span class="token function">changeColor</span><span class="token punctuation">(</span><span class="token string">&#39;red&#39;</span><span class="token punctuation">)</span><span class="token punctuation">}</span> style<span class="token operator">=</span><span class="token punctuation">{</span><span class="token punctuation">{</span> <span class="token literal-property property">color</span><span class="token operator">:</span> <span class="token string">&#39;red&#39;</span> <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token operator">&gt;</span>红色<span class="token operator">&lt;</span><span class="token operator">/</span>button<span class="token operator">&gt;</span></span>
<span class="line">                <span class="token operator">&lt;</span>button onClick<span class="token operator">=</span><span class="token punctuation">{</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token keyword">this</span><span class="token punctuation">.</span>context<span class="token punctuation">.</span><span class="token function">changeColor</span><span class="token punctuation">(</span><span class="token string">&#39;green&#39;</span><span class="token punctuation">)</span><span class="token punctuation">}</span> style<span class="token operator">=</span><span class="token punctuation">{</span><span class="token punctuation">{</span> <span class="token literal-property property">color</span><span class="token operator">:</span> <span class="token string">&#39;green&#39;</span> <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token operator">&gt;</span>绿色<span class="token operator">&lt;</span><span class="token operator">/</span>button<span class="token operator">&gt;</span></span>
<span class="line">            <span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">&gt;</span></span>
<span class="line">        <span class="token punctuation">)</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">class</span> <span class="token class-name">ClassPage</span> <span class="token keyword">extends</span> <span class="token class-name">Component</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter">props</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">super</span><span class="token punctuation">(</span>props<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">this</span><span class="token punctuation">.</span>state <span class="token operator">=</span> <span class="token punctuation">{</span> <span class="token literal-property property">color</span><span class="token operator">:</span> <span class="token string">&#39;red&#39;</span> <span class="token punctuation">}</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    <span class="token function-variable function">changeColor</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">color</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">setState</span><span class="token punctuation">(</span><span class="token punctuation">{</span> color <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    <span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">let</span> contextVal <span class="token operator">=</span> <span class="token punctuation">{</span> <span class="token literal-property property">changeColor</span><span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>changeColor<span class="token punctuation">,</span> <span class="token literal-property property">color</span><span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">.</span>color <span class="token punctuation">}</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">return</span> <span class="token punctuation">(</span></span>
<span class="line">            <span class="token operator">&lt;</span>ThemeContext<span class="token punctuation">.</span>Provider value<span class="token operator">=</span><span class="token punctuation">{</span>contextVal<span class="token punctuation">}</span><span class="token operator">&gt;</span></span>
<span class="line">                <span class="token operator">&lt;</span>div style<span class="token operator">=</span><span class="token punctuation">{</span><span class="token punctuation">{</span> <span class="token literal-property property">margin</span><span class="token operator">:</span> <span class="token string">&#39;10px&#39;</span><span class="token punctuation">,</span> <span class="token literal-property property">border</span><span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">\`</span><span class="token string">5px solid </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">\${</span><span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">.</span>color<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">\`</span></span><span class="token punctuation">,</span> <span class="token literal-property property">padding</span><span class="token operator">:</span> <span class="token string">&#39;5px&#39;</span><span class="token punctuation">,</span> <span class="token literal-property property">width</span><span class="token operator">:</span> <span class="token string">&#39;200px&#39;</span> <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token operator">&gt;</span></span>
<span class="line">                    page</span>
<span class="line">                    <span class="token operator">&lt;</span>Header <span class="token operator">/</span><span class="token operator">&gt;</span></span>
<span class="line">                    <span class="token operator">&lt;</span>Main <span class="token operator">/</span><span class="token operator">&gt;</span></span>
<span class="line">                <span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">&gt;</span></span>
<span class="line">            <span class="token operator">&lt;</span><span class="token operator">/</span>ThemeContext<span class="token punctuation">.</span>Provider<span class="token operator">&gt;</span></span>
<span class="line"></span>
<span class="line">        <span class="token punctuation">)</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"><span class="token keyword">class</span> <span class="token class-name">FunctionHeader</span> <span class="token keyword">extends</span> <span class="token class-name">Component</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">return</span> <span class="token punctuation">(</span></span>
<span class="line">            <span class="token operator">&lt;</span>ThemeContext<span class="token punctuation">.</span>Consumer<span class="token operator">&gt;</span></span>
<span class="line">                <span class="token punctuation">{</span></span>
<span class="line">                    <span class="token punctuation">(</span><span class="token parameter">value</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">(</span></span>
<span class="line">                        <span class="token operator">&lt;</span>div style<span class="token operator">=</span><span class="token punctuation">{</span><span class="token punctuation">{</span> <span class="token literal-property property">border</span><span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">\`</span><span class="token string">5px solid </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">\${</span>value<span class="token punctuation">.</span>color<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">\`</span></span><span class="token punctuation">,</span> <span class="token literal-property property">padding</span><span class="token operator">:</span> <span class="token string">&#39;5px&#39;</span> <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token operator">&gt;</span></span>
<span class="line">                            header</span>
<span class="line">                            <span class="token operator">&lt;</span>FunctionTitle <span class="token operator">/</span><span class="token operator">&gt;</span></span>
<span class="line">                        <span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">&gt;</span></span>
<span class="line">                    <span class="token punctuation">)</span></span>
<span class="line">                <span class="token punctuation">}</span></span>
<span class="line">            <span class="token operator">&lt;</span><span class="token operator">/</span>ThemeContext<span class="token punctuation">.</span>Consumer<span class="token operator">&gt;</span></span>
<span class="line">        <span class="token punctuation">)</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"><span class="token keyword">class</span> <span class="token class-name">FunctionTitle</span> <span class="token keyword">extends</span> <span class="token class-name">Component</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">return</span> <span class="token punctuation">(</span></span>
<span class="line">            <span class="token operator">&lt;</span>ThemeContext<span class="token punctuation">.</span>Consumer<span class="token operator">&gt;</span></span>
<span class="line">                <span class="token punctuation">{</span></span>
<span class="line">                    <span class="token punctuation">(</span><span class="token parameter">value</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">(</span></span>
<span class="line">                        <span class="token operator">&lt;</span>div style<span class="token operator">=</span><span class="token punctuation">{</span><span class="token punctuation">{</span> <span class="token literal-property property">border</span><span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">\`</span><span class="token string">5px solid </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">\${</span>value<span class="token punctuation">.</span>color<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">\`</span></span> <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token operator">&gt;</span></span>
<span class="line">                            title</span>
<span class="line">                        <span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">&gt;</span></span>
<span class="line">                    <span class="token punctuation">)</span></span>
<span class="line">                <span class="token punctuation">}</span></span>
<span class="line">            <span class="token operator">&lt;</span><span class="token operator">/</span>ThemeContext<span class="token punctuation">.</span>Consumer<span class="token operator">&gt;</span></span>
<span class="line">        <span class="token punctuation">)</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"><span class="token keyword">class</span> <span class="token class-name">FunctionMain</span> <span class="token keyword">extends</span> <span class="token class-name">Component</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">return</span> <span class="token punctuation">(</span></span>
<span class="line">            <span class="token operator">&lt;</span>ThemeContext<span class="token punctuation">.</span>Consumer<span class="token operator">&gt;</span></span>
<span class="line">                <span class="token punctuation">{</span></span>
<span class="line">                    <span class="token punctuation">(</span><span class="token parameter">value</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">(</span></span>
<span class="line">                        <span class="token operator">&lt;</span>div style<span class="token operator">=</span><span class="token punctuation">{</span><span class="token punctuation">{</span> <span class="token literal-property property">border</span><span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">\`</span><span class="token string">5px solid </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">\${</span>value<span class="token punctuation">.</span>color<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">\`</span></span><span class="token punctuation">,</span> <span class="token literal-property property">margin</span><span class="token operator">:</span> <span class="token string">&#39;5px&#39;</span><span class="token punctuation">,</span> <span class="token literal-property property">padding</span><span class="token operator">:</span> <span class="token string">&#39;5px&#39;</span> <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token operator">&gt;</span></span>
<span class="line">                            main</span>
<span class="line">                            <span class="token operator">&lt;</span>FunctionContent <span class="token operator">/</span><span class="token operator">&gt;</span></span>
<span class="line">                        <span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">&gt;</span></span>
<span class="line">                    <span class="token punctuation">)</span></span>
<span class="line">                <span class="token punctuation">}</span></span>
<span class="line">            <span class="token operator">&lt;</span><span class="token operator">/</span>ThemeContext<span class="token punctuation">.</span>Consumer<span class="token operator">&gt;</span></span>
<span class="line">        <span class="token punctuation">)</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"><span class="token keyword">class</span> <span class="token class-name">FunctionContent</span> <span class="token keyword">extends</span> <span class="token class-name">Component</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">return</span> <span class="token punctuation">(</span></span>
<span class="line">            <span class="token operator">&lt;</span>ThemeContext<span class="token punctuation">.</span>Consumer<span class="token operator">&gt;</span></span>
<span class="line">                <span class="token punctuation">{</span></span>
<span class="line">                    <span class="token punctuation">(</span><span class="token parameter">value</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">(</span></span>
<span class="line">                        <span class="token operator">&lt;</span>div style<span class="token operator">=</span><span class="token punctuation">{</span><span class="token punctuation">{</span> <span class="token literal-property property">border</span><span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">\`</span><span class="token string">5px solid </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">\${</span>value<span class="token punctuation">.</span>color<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">\`</span></span><span class="token punctuation">,</span> <span class="token literal-property property">padding</span><span class="token operator">:</span> <span class="token string">&#39;5px&#39;</span> <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token operator">&gt;</span></span>
<span class="line">                            Content</span>
<span class="line">                            <span class="token operator">&lt;</span>button onClick<span class="token operator">=</span><span class="token punctuation">{</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> value<span class="token punctuation">.</span><span class="token function">changeColor</span><span class="token punctuation">(</span><span class="token string">&#39;red&#39;</span><span class="token punctuation">)</span><span class="token punctuation">}</span> style<span class="token operator">=</span><span class="token punctuation">{</span><span class="token punctuation">{</span> <span class="token literal-property property">color</span><span class="token operator">:</span> <span class="token string">&#39;red&#39;</span> <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token operator">&gt;</span>红色<span class="token operator">&lt;</span><span class="token operator">/</span>button<span class="token operator">&gt;</span></span>
<span class="line">                            <span class="token operator">&lt;</span>button onClick<span class="token operator">=</span><span class="token punctuation">{</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> value<span class="token punctuation">.</span><span class="token function">changeColor</span><span class="token punctuation">(</span><span class="token string">&#39;green&#39;</span><span class="token punctuation">)</span><span class="token punctuation">}</span> style<span class="token operator">=</span><span class="token punctuation">{</span><span class="token punctuation">{</span> <span class="token literal-property property">color</span><span class="token operator">:</span> <span class="token string">&#39;green&#39;</span> <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token operator">&gt;</span>绿色<span class="token operator">&lt;</span><span class="token operator">/</span>button<span class="token operator">&gt;</span></span>
<span class="line">                        <span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">&gt;</span></span>
<span class="line">                    <span class="token punctuation">)</span></span>
<span class="line">                <span class="token punctuation">}</span></span>
<span class="line">            <span class="token operator">&lt;</span><span class="token operator">/</span>ThemeContext<span class="token punctuation">.</span>Consumer<span class="token operator">&gt;</span></span>
<span class="line">        <span class="token punctuation">)</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"><span class="token keyword">class</span> <span class="token class-name">FunctionPage</span> <span class="token keyword">extends</span> <span class="token class-name">Component</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter">props</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">super</span><span class="token punctuation">(</span>props<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">this</span><span class="token punctuation">.</span>state <span class="token operator">=</span> <span class="token punctuation">{</span> <span class="token literal-property property">color</span><span class="token operator">:</span> <span class="token string">&#39;red&#39;</span> <span class="token punctuation">}</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    <span class="token function-variable function">changeColor</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">color</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">setState</span><span class="token punctuation">(</span><span class="token punctuation">{</span> color <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    <span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">let</span> contextVal <span class="token operator">=</span> <span class="token punctuation">{</span> <span class="token literal-property property">changeColor</span><span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>changeColor<span class="token punctuation">,</span> <span class="token literal-property property">color</span><span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">.</span>color <span class="token punctuation">}</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">return</span> <span class="token punctuation">(</span></span>
<span class="line">            <span class="token operator">&lt;</span>ThemeContext<span class="token punctuation">.</span>Provider value<span class="token operator">=</span><span class="token punctuation">{</span>contextVal<span class="token punctuation">}</span><span class="token operator">&gt;</span></span>
<span class="line">                <span class="token operator">&lt;</span>div style<span class="token operator">=</span><span class="token punctuation">{</span><span class="token punctuation">{</span> <span class="token literal-property property">margin</span><span class="token operator">:</span> <span class="token string">&#39;10px&#39;</span><span class="token punctuation">,</span> <span class="token literal-property property">border</span><span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">\`</span><span class="token string">5px solid </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">\${</span><span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">.</span>color<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">\`</span></span><span class="token punctuation">,</span> <span class="token literal-property property">padding</span><span class="token operator">:</span> <span class="token string">&#39;5px&#39;</span><span class="token punctuation">,</span> <span class="token literal-property property">width</span><span class="token operator">:</span> <span class="token string">&#39;200px&#39;</span> <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token operator">&gt;</span></span>
<span class="line">                    page</span>
<span class="line">                    <span class="token operator">&lt;</span>FunctionHeader <span class="token operator">/</span><span class="token operator">&gt;</span></span>
<span class="line">                    <span class="token operator">&lt;</span>FunctionMain <span class="token operator">/</span><span class="token operator">&gt;</span></span>
<span class="line">                <span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">&gt;</span></span>
<span class="line">            <span class="token operator">&lt;</span><span class="token operator">/</span>ThemeContext<span class="token punctuation">.</span>Provider<span class="token operator">&gt;</span></span>
<span class="line"></span>
<span class="line">        <span class="token punctuation">)</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line">ReactDOM<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span><span class="token operator">&lt;</span>FunctionPage <span class="token operator">/</span><span class="token operator">&gt;</span><span class="token punctuation">,</span> root<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_8-2-react-index-js" tabindex="-1"><a class="header-anchor" href="#_8-2-react-index-js"><span>8.2 react\\index.js</span></a></h3><p>src\\react\\index.js</p><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code class="language-javascript"><span class="line"><span class="token keyword">import</span> <span class="token punctuation">{</span> <span class="token constant">TEXT</span><span class="token punctuation">,</span> <span class="token constant">ELEMENT</span><span class="token punctuation">,</span> <span class="token constant">FUNCTION_COMPONENT</span><span class="token punctuation">,</span> <span class="token constant">CLASS_COMPONENT</span> <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&#39;./constants&#39;</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">import</span> <span class="token punctuation">{</span> ReactElement <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&#39;./vdom&#39;</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">import</span> <span class="token punctuation">{</span> Component <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&#39;./component&#39;</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">import</span> <span class="token punctuation">{</span> onlyOne <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&#39;./utils&#39;</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">function</span> <span class="token function">createElement</span><span class="token punctuation">(</span><span class="token parameter">type<span class="token punctuation">,</span> config <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token operator">...</span>children</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">delete</span> config<span class="token punctuation">.</span>__source<span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">delete</span> config<span class="token punctuation">.</span>__self<span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">let</span> <span class="token punctuation">{</span> key<span class="token punctuation">,</span> ref<span class="token punctuation">,</span> <span class="token operator">...</span>props <span class="token punctuation">}</span> <span class="token operator">=</span> config<span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">let</span> $$<span class="token keyword">typeof</span> <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> type <span class="token operator">===</span> <span class="token string">&#39;string&#39;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        $$<span class="token keyword">typeof</span> <span class="token operator">=</span> <span class="token constant">ELEMENT</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> type <span class="token operator">===</span> <span class="token string">&#39;function&#39;</span> <span class="token operator">&amp;&amp;</span> type<span class="token punctuation">.</span>prototype<span class="token punctuation">.</span>isReactComponent<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        $$<span class="token keyword">typeof</span> <span class="token operator">=</span> <span class="token constant">CLASS_COMPONENT</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> type <span class="token operator">===</span> <span class="token string">&#39;function&#39;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        $$<span class="token keyword">typeof</span> <span class="token operator">=</span> <span class="token constant">FUNCTION_COMPONENT</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    props<span class="token punctuation">.</span>children <span class="token operator">=</span> children<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token parameter">item</span> <span class="token operator">=&gt;</span> <span class="token keyword">typeof</span> item <span class="token operator">===</span> <span class="token string">&#39;object&#39;</span> <span class="token operator">||</span> <span class="token keyword">typeof</span> item <span class="token operator">===</span> <span class="token string">&#39;function&#39;</span> <span class="token operator">?</span> item</span>
<span class="line">        <span class="token operator">:</span> <span class="token punctuation">{</span> $$<span class="token keyword">typeof</span><span class="token operator">:</span> <span class="token constant">TEXT</span><span class="token punctuation">,</span> <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token constant">TEXT</span><span class="token punctuation">,</span> <span class="token literal-property property">content</span><span class="token operator">:</span> item <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">return</span> <span class="token function">ReactElement</span><span class="token punctuation">(</span>$$<span class="token keyword">typeof</span><span class="token punctuation">,</span> type<span class="token punctuation">,</span> key<span class="token punctuation">,</span> ref<span class="token punctuation">,</span> props<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"><span class="token operator">+</span><span class="token keyword">function</span> <span class="token function">createContext</span><span class="token punctuation">(</span><span class="token parameter">defaultValue</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line"><span class="token operator">+</span>    Provider<span class="token punctuation">.</span>value <span class="token operator">=</span> defaultValue<span class="token punctuation">;</span></span>
<span class="line"><span class="token operator">+</span>    <span class="token keyword">function</span> <span class="token function">Provider</span><span class="token punctuation">(</span><span class="token parameter">props</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line"><span class="token operator">+</span>        Provider<span class="token punctuation">.</span>value <span class="token operator">=</span> props<span class="token punctuation">.</span>value<span class="token punctuation">;</span></span>
<span class="line"><span class="token operator">+</span>        <span class="token keyword">return</span> props<span class="token punctuation">.</span>children<span class="token punctuation">;</span></span>
<span class="line"><span class="token operator">+</span>    <span class="token punctuation">}</span></span>
<span class="line"><span class="token operator">+</span>    <span class="token keyword">function</span> <span class="token function">Consumer</span><span class="token punctuation">(</span><span class="token parameter">props</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line"><span class="token operator">+</span>        <span class="token keyword">return</span> <span class="token function">onlyOne</span><span class="token punctuation">(</span>props<span class="token punctuation">.</span>children<span class="token punctuation">)</span><span class="token punctuation">(</span>Provider<span class="token punctuation">.</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token operator">+</span>    <span class="token punctuation">}</span></span>
<span class="line"><span class="token operator">+</span>    <span class="token keyword">return</span> <span class="token punctuation">{</span></span>
<span class="line"><span class="token operator">+</span>        Provider<span class="token punctuation">,</span></span>
<span class="line"><span class="token operator">+</span>        Consumer</span>
<span class="line"><span class="token operator">+</span>    <span class="token punctuation">}</span></span>
<span class="line"><span class="token operator">+</span><span class="token punctuation">}</span></span>
<span class="line"><span class="token keyword">export</span> <span class="token punctuation">{</span></span>
<span class="line">    Component</span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"><span class="token keyword">const</span> React <span class="token operator">=</span> <span class="token punctuation">{</span></span>
<span class="line">    createElement<span class="token punctuation">,</span></span>
<span class="line">    Component<span class="token punctuation">,</span></span>
<span class="line"><span class="token operator">+</span>    createContext</span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"><span class="token keyword">export</span> <span class="token keyword">default</span> React<span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_8-3-react-vdom-js" tabindex="-1"><a class="header-anchor" href="#_8-3-react-vdom-js"><span>8.3 react\\vdom.js</span></a></h3><p>src\\react\\vdom.js</p><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code class="language-javascript"><span class="line"><span class="token keyword">import</span> <span class="token punctuation">{</span> <span class="token constant">TEXT</span><span class="token punctuation">,</span> <span class="token constant">ELEMENT</span><span class="token punctuation">,</span> <span class="token constant">FUNCTION_COMPONENT</span><span class="token punctuation">,</span> <span class="token constant">CLASS_COMPONENT</span><span class="token punctuation">,</span> <span class="token constant">MOVE</span><span class="token punctuation">,</span> <span class="token constant">INSERT</span><span class="token punctuation">,</span> <span class="token constant">REMOVE</span> <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&#39;./constants&#39;</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">import</span> <span class="token punctuation">{</span> setProps<span class="token punctuation">,</span> onlyOne<span class="token punctuation">,</span> patchProps<span class="token punctuation">,</span> flatten <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&#39;./utils&#39;</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">const</span> diffQueue <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">let</span> updateDepth <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">createDOM</span><span class="token punctuation">(</span><span class="token parameter">element</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    element <span class="token operator">=</span> <span class="token function">onlyOne</span><span class="token punctuation">(</span>element<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">let</span> <span class="token punctuation">{</span> $$<span class="token keyword">typeof</span> <span class="token punctuation">}</span> <span class="token operator">=</span> element<span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">let</span> dom <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>$$<span class="token keyword">typeof</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        dom <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">createTextNode</span><span class="token punctuation">(</span>element<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>$$<span class="token keyword">typeof</span> <span class="token operator">===</span> <span class="token constant">TEXT</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        dom <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">createTextNode</span><span class="token punctuation">(</span>element<span class="token punctuation">.</span>content<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>$$<span class="token keyword">typeof</span> <span class="token operator">===</span> <span class="token constant">ELEMENT</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        dom <span class="token operator">=</span> <span class="token function">createNativeDOM</span><span class="token punctuation">(</span>element<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>$$<span class="token keyword">typeof</span> <span class="token operator">===</span> <span class="token constant">FUNCTION_COMPONENT</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        dom <span class="token operator">=</span> <span class="token function">createFunctionComponentDOM</span><span class="token punctuation">(</span>element<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>$$<span class="token keyword">typeof</span> <span class="token operator">===</span> <span class="token constant">CLASS_COMPONENT</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        dom <span class="token operator">=</span> <span class="token function">createClassComponentDOM</span><span class="token punctuation">(</span>element<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    element<span class="token punctuation">.</span>dom <span class="token operator">=</span> dom<span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">return</span> dom<span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">function</span> <span class="token function">createNativeDOM</span><span class="token punctuation">(</span><span class="token parameter">element</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">let</span> <span class="token punctuation">{</span> type<span class="token punctuation">,</span> props<span class="token punctuation">,</span> ref <span class="token punctuation">}</span> <span class="token operator">=</span> element<span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">let</span> dom <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span>type<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token function">createChildren</span><span class="token punctuation">(</span>element<span class="token punctuation">,</span> dom<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token function">setProps</span><span class="token punctuation">(</span>dom<span class="token punctuation">,</span> props<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">if</span> <span class="token punctuation">(</span>ref<span class="token punctuation">)</span></span>
<span class="line">        ref<span class="token punctuation">.</span>current <span class="token operator">=</span> dom<span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">return</span> dom<span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">function</span> <span class="token function">createChildren</span><span class="token punctuation">(</span><span class="token parameter">element<span class="token punctuation">,</span> parentNode</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    element<span class="token punctuation">.</span>props<span class="token punctuation">.</span>children <span class="token operator">&amp;&amp;</span> <span class="token function">flatten</span><span class="token punctuation">(</span>element<span class="token punctuation">.</span>props<span class="token punctuation">.</span>children<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">childElement<span class="token punctuation">,</span> index</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></span>
<span class="line">        childElement<span class="token punctuation">.</span>_mountIndex <span class="token operator">=</span> index<span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">let</span> childDOM <span class="token operator">=</span> <span class="token function">createDOM</span><span class="token punctuation">(</span>childElement<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        parentNode<span class="token punctuation">.</span><span class="token function">appendChild</span><span class="token punctuation">(</span>childDOM<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"><span class="token keyword">function</span> <span class="token function">createFunctionComponentDOM</span><span class="token punctuation">(</span><span class="token parameter">element</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">let</span> <span class="token punctuation">{</span> type<span class="token punctuation">,</span> props <span class="token punctuation">}</span> <span class="token operator">=</span> element<span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">let</span> renderElement <span class="token operator">=</span> <span class="token function">type</span><span class="token punctuation">(</span>props<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    element<span class="token punctuation">.</span>renderElement <span class="token operator">=</span> renderElement<span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">let</span> newDOM <span class="token operator">=</span> <span class="token function">createDOM</span><span class="token punctuation">(</span>renderElement<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    renderElement<span class="token punctuation">.</span>dom <span class="token operator">=</span> newDOM<span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">return</span> newDOM<span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"><span class="token keyword">function</span> <span class="token function">createClassComponentDOM</span><span class="token punctuation">(</span><span class="token parameter">element</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">let</span> <span class="token punctuation">{</span> type<span class="token punctuation">,</span> props<span class="token punctuation">,</span> ref <span class="token punctuation">}</span> <span class="token operator">=</span> element<span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">let</span> componentInstance <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">type</span><span class="token punctuation">(</span>props<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token operator">+</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>element<span class="token punctuation">.</span>type<span class="token punctuation">.</span>contextType<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line"><span class="token operator">+</span>        componentInstance<span class="token punctuation">.</span>context <span class="token operator">=</span> element<span class="token punctuation">.</span>type<span class="token punctuation">.</span>contextType<span class="token punctuation">.</span>Provider<span class="token punctuation">.</span>value<span class="token punctuation">;</span></span>
<span class="line"><span class="token operator">+</span>    <span class="token punctuation">}</span></span>
<span class="line">    <span class="token keyword">if</span> <span class="token punctuation">(</span>ref<span class="token punctuation">)</span></span>
<span class="line">        ref<span class="token punctuation">.</span>current <span class="token operator">=</span> componentInstance<span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">if</span> <span class="token punctuation">(</span>componentInstance<span class="token punctuation">.</span>componentWillMount<span class="token punctuation">)</span></span>
<span class="line">        componentInstance<span class="token punctuation">.</span><span class="token function">componentWillMount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    element<span class="token punctuation">.</span>componentInstance <span class="token operator">=</span> componentInstance<span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">let</span> renderElement <span class="token operator">=</span> componentInstance<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    componentInstance<span class="token punctuation">.</span>renderElement <span class="token operator">=</span> renderElement<span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">let</span> newDOM <span class="token operator">=</span> <span class="token function">createDOM</span><span class="token punctuation">(</span>renderElement<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">if</span> <span class="token punctuation">(</span>componentInstance<span class="token punctuation">.</span>componentDidMount<span class="token punctuation">)</span></span>
<span class="line">        componentInstance<span class="token punctuation">.</span><span class="token function">componentDidMount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">return</span> newDOM<span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"><span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">compareTwoElements</span><span class="token punctuation">(</span><span class="token parameter">oldElement<span class="token punctuation">,</span> newElement</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    oldElement <span class="token operator">=</span> <span class="token function">onlyOne</span><span class="token punctuation">(</span>oldElement<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    newElement <span class="token operator">=</span> <span class="token function">onlyOne</span><span class="token punctuation">(</span>newElement<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">let</span> currentDOM <span class="token operator">=</span> oldElement<span class="token punctuation">.</span>dom<span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">let</span> currentElement <span class="token operator">=</span> oldElement<span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">if</span> <span class="token punctuation">(</span>newElement <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token comment">//如果新节点没有了，直接删除拉倒</span></span>
<span class="line">        currentDOM<span class="token punctuation">.</span>parentNode<span class="token punctuation">.</span><span class="token function">removeChild</span><span class="token punctuation">(</span>currentDOM<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        currentElement <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>oldElement<span class="token punctuation">.</span>type <span class="token operator">!==</span> newElement<span class="token punctuation">.</span>type<span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token comment">//如果类型不同</span></span>
<span class="line">        <span class="token keyword">let</span> newDOM <span class="token operator">=</span> <span class="token function">createDOM</span><span class="token punctuation">(</span>newElement<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        currentDOM<span class="token punctuation">.</span>parentNode<span class="token punctuation">.</span><span class="token function">replaceChild</span><span class="token punctuation">(</span>newDOM<span class="token punctuation">,</span> currentDOM<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        currentElement <span class="token operator">=</span> newElement<span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token function">updateElement</span><span class="token punctuation">(</span>oldElement<span class="token punctuation">,</span> newElement<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    <span class="token keyword">return</span> currentElement<span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">function</span> <span class="token function">updateElement</span><span class="token punctuation">(</span><span class="token parameter">oldElement<span class="token punctuation">,</span> newElement</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">let</span> currentDOM <span class="token operator">=</span> newElement<span class="token punctuation">.</span>dom <span class="token operator">=</span> oldElement<span class="token punctuation">.</span>dom<span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">if</span> <span class="token punctuation">(</span>oldElement<span class="token punctuation">.</span>$$<span class="token keyword">typeof</span> <span class="token operator">===</span> <span class="token constant">TEXT</span> <span class="token operator">&amp;&amp;</span> newElement<span class="token punctuation">.</span>$$<span class="token keyword">typeof</span> <span class="token operator">===</span> <span class="token constant">TEXT</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token comment">//如果都是文本类型，则直接改文本</span></span>
<span class="line">        <span class="token keyword">if</span> <span class="token punctuation">(</span>oldElement<span class="token punctuation">.</span>content <span class="token operator">!==</span> newElement<span class="token punctuation">.</span>content<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">            currentDOM<span class="token punctuation">.</span>textContent <span class="token operator">=</span> newElement<span class="token punctuation">.</span>content<span class="token punctuation">;</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>oldElement<span class="token punctuation">.</span>$$<span class="token keyword">typeof</span> <span class="token operator">===</span> <span class="token constant">ELEMENT</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token function">updateChildrenElements</span><span class="token punctuation">(</span>currentDOM<span class="token punctuation">,</span> oldElement<span class="token punctuation">.</span>props<span class="token punctuation">.</span>children<span class="token punctuation">,</span> newElement<span class="token punctuation">.</span>props<span class="token punctuation">.</span>children<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token function">updateDOMProps</span><span class="token punctuation">(</span>currentDOM<span class="token punctuation">,</span> oldElement<span class="token punctuation">.</span>props<span class="token punctuation">,</span> newElement<span class="token punctuation">.</span>props<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        oldElement<span class="token punctuation">.</span>props <span class="token operator">=</span> newElement<span class="token punctuation">.</span>props<span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>oldElement<span class="token punctuation">.</span>$$<span class="token keyword">typeof</span> <span class="token operator">===</span> <span class="token constant">CLASS_COMPONENT</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token function">updateClassComponent</span><span class="token punctuation">(</span>oldElement<span class="token punctuation">,</span> newElement<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        newElement<span class="token punctuation">.</span>componentInstance <span class="token operator">=</span> oldElement<span class="token punctuation">.</span>componentInstance<span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>oldElement<span class="token punctuation">.</span>$$<span class="token keyword">typeof</span> <span class="token operator">===</span> <span class="token constant">FUNCTION_COMPONENT</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token function">updateFunctionComponent</span><span class="token punctuation">(</span>oldElement<span class="token punctuation">,</span> newElement<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"><span class="token keyword">function</span> <span class="token function">updateChildrenElements</span><span class="token punctuation">(</span><span class="token parameter">dom<span class="token punctuation">,</span> oldChildrenElements<span class="token punctuation">,</span> newChildrenElement</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    updateDepth<span class="token operator">++</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token function">diff</span><span class="token punctuation">(</span>dom<span class="token punctuation">,</span> <span class="token function">flatten</span><span class="token punctuation">(</span>oldChildrenElements<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">flatten</span><span class="token punctuation">(</span>newChildrenElement<span class="token punctuation">)</span><span class="token punctuation">,</span> diffQueue<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    updateDepth<span class="token operator">--</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">if</span> <span class="token punctuation">(</span>updateDepth <span class="token operator">===</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token function">patch</span><span class="token punctuation">(</span>diffQueue<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        diffQueue<span class="token punctuation">.</span>length <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">function</span> <span class="token function">diff</span><span class="token punctuation">(</span><span class="token parameter">parentNode<span class="token punctuation">,</span> oldChildrenElements<span class="token punctuation">,</span> newChildrenElements<span class="token punctuation">,</span> diffQueue</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">let</span> oldChildrenElementMap <span class="token operator">=</span> <span class="token function">getChildrenElementMap</span><span class="token punctuation">(</span>oldChildrenElements<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">let</span> newChildrenElementMap <span class="token operator">=</span> <span class="token function">getNewChildren</span><span class="token punctuation">(</span>oldChildrenElementMap<span class="token punctuation">,</span> newChildrenElements<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">let</span> lastIndex <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> newChildrenElements<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">let</span> newElement <span class="token operator">=</span> newChildrenElements<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token comment">//取得新元素</span></span>
<span class="line">        <span class="token keyword">if</span> <span class="token punctuation">(</span>newElement<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token keyword">let</span> newKey <span class="token operator">=</span> <span class="token punctuation">(</span>newElement<span class="token punctuation">.</span>key<span class="token punctuation">)</span> <span class="token operator">||</span> i<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//取得新key</span></span>
<span class="line">            <span class="token keyword">let</span> oldElement <span class="token operator">=</span> oldChildrenElementMap<span class="token punctuation">[</span>newKey<span class="token punctuation">]</span><span class="token punctuation">;</span></span>
<span class="line">            <span class="token keyword">if</span> <span class="token punctuation">(</span>oldElement <span class="token operator">===</span> newElement<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">                <span class="token keyword">if</span> <span class="token punctuation">(</span>oldElement<span class="token punctuation">.</span>_mountIndex <span class="token operator">&lt;</span> lastIndex<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">                    diffQueue<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token punctuation">{</span></span>
<span class="line">                        parentNode<span class="token punctuation">,</span></span>
<span class="line">                        <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token constant">MOVE</span><span class="token punctuation">,</span></span>
<span class="line">                        <span class="token literal-property property">fromIndex</span><span class="token operator">:</span> oldElement<span class="token punctuation">.</span>_mountIndex<span class="token punctuation">,</span></span>
<span class="line">                        <span class="token literal-property property">toIndex</span><span class="token operator">:</span> i</span>
<span class="line">                    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">                <span class="token punctuation">}</span></span>
<span class="line">                lastIndex <span class="token operator">=</span> Math<span class="token punctuation">.</span><span class="token function">max</span><span class="token punctuation">(</span>oldElement<span class="token punctuation">.</span>_mountIndex<span class="token punctuation">,</span> lastIndex<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span></span>
<span class="line">                diffQueue<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token punctuation">{</span></span>
<span class="line">                    parentNode<span class="token punctuation">,</span></span>
<span class="line">                    <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token constant">INSERT</span><span class="token punctuation">,</span></span>
<span class="line">                    <span class="token literal-property property">toIndex</span><span class="token operator">:</span> i<span class="token punctuation">,</span></span>
<span class="line">                    <span class="token literal-property property">dom</span><span class="token operator">:</span> <span class="token function">createDOM</span><span class="token punctuation">(</span>newElement<span class="token punctuation">)</span></span>
<span class="line">                <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">            <span class="token punctuation">}</span></span>
<span class="line">            newElement<span class="token punctuation">.</span>_mountIndex <span class="token operator">=</span> i<span class="token punctuation">;</span></span>
<span class="line">        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token keyword">if</span> <span class="token punctuation">(</span>oldChildrenElements<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>componentInstance <span class="token operator">&amp;&amp;</span> oldChildrenElements<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>componentInstance<span class="token punctuation">.</span>componentWillUnmount<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">                oldChildrenElements<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>componentInstance<span class="token punctuation">.</span><span class="token function">componentWillUnmount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">            <span class="token punctuation">}</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> oldKey <span class="token keyword">in</span> oldChildrenElementMap<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>newChildrenElementMap<span class="token punctuation">.</span><span class="token function">hasOwnProperty</span><span class="token punctuation">(</span>oldKey<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token keyword">let</span> oldElement <span class="token operator">=</span> oldChildrenElementMap<span class="token punctuation">[</span>oldKey<span class="token punctuation">]</span><span class="token punctuation">;</span></span>
<span class="line">            diffQueue<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token punctuation">{</span></span>
<span class="line">                parentNode<span class="token punctuation">,</span></span>
<span class="line">                <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token constant">REMOVE</span><span class="token punctuation">,</span></span>
<span class="line">                <span class="token literal-property property">fromIndex</span><span class="token operator">:</span> oldElement<span class="token punctuation">.</span>_mountIndex</span>
<span class="line">            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"><span class="token keyword">function</span> <span class="token function">patch</span><span class="token punctuation">(</span><span class="token parameter">diffQueue</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">let</span> deleteChildren <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">let</span> deleteMap <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> diffQueue<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">let</span> difference <span class="token operator">=</span> diffQueue<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">if</span> <span class="token punctuation">(</span>difference<span class="token punctuation">.</span>type <span class="token operator">===</span> <span class="token constant">MOVE</span> <span class="token operator">||</span> difference<span class="token punctuation">.</span>type <span class="token operator">===</span> <span class="token constant">REMOVE</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token keyword">let</span> fromIndex <span class="token operator">=</span> difference<span class="token punctuation">.</span>fromIndex<span class="token punctuation">;</span></span>
<span class="line">            <span class="token keyword">let</span> oldChild <span class="token operator">=</span> difference<span class="token punctuation">.</span>parentNode<span class="token punctuation">.</span>children<span class="token punctuation">[</span>fromIndex<span class="token punctuation">]</span><span class="token punctuation">;</span></span>
<span class="line">            deleteMap<span class="token punctuation">[</span>fromIndex<span class="token punctuation">]</span> <span class="token operator">=</span> oldChild<span class="token punctuation">;</span></span>
<span class="line">            deleteChildren<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>oldChild<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    deleteChildren<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">child</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></span>
<span class="line">        child<span class="token punctuation">.</span>parentNode<span class="token punctuation">.</span><span class="token function">removeChild</span><span class="token punctuation">(</span>child<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> k <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> k <span class="token operator">&lt;</span> diffQueue<span class="token punctuation">.</span>length<span class="token punctuation">;</span> k<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">let</span> difference <span class="token operator">=</span> diffQueue<span class="token punctuation">[</span>k<span class="token punctuation">]</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">switch</span> <span class="token punctuation">(</span>difference<span class="token punctuation">.</span>type<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token keyword">case</span> <span class="token constant">INSERT</span><span class="token operator">:</span></span>
<span class="line">                <span class="token function">insertChildAt</span><span class="token punctuation">(</span>difference<span class="token punctuation">.</span>parentNode<span class="token punctuation">,</span> difference<span class="token punctuation">.</span>dom<span class="token punctuation">,</span> difference<span class="token punctuation">.</span>toIndex<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">                <span class="token keyword">break</span><span class="token punctuation">;</span></span>
<span class="line">            <span class="token keyword">case</span> <span class="token constant">MOVE</span><span class="token operator">:</span></span>
<span class="line">                <span class="token function">insertChildAt</span><span class="token punctuation">(</span>difference<span class="token punctuation">.</span>parentNode<span class="token punctuation">,</span> deleteMap<span class="token punctuation">[</span>difference<span class="token punctuation">.</span>fromIndex<span class="token punctuation">]</span><span class="token punctuation">,</span> difference<span class="token punctuation">.</span>toIndex<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">                <span class="token keyword">break</span><span class="token punctuation">;</span></span>
<span class="line">            <span class="token keyword">default</span><span class="token operator">:</span></span>
<span class="line">                <span class="token keyword">break</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">function</span> <span class="token function">insertChildAt</span><span class="token punctuation">(</span><span class="token parameter">parentNode<span class="token punctuation">,</span> childNode<span class="token punctuation">,</span> index</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">let</span> oldChild <span class="token operator">=</span> parentNode<span class="token punctuation">.</span>children<span class="token punctuation">[</span>index<span class="token punctuation">]</span></span>
<span class="line">    oldChild <span class="token operator">?</span> parentNode<span class="token punctuation">.</span><span class="token function">insertBefore</span><span class="token punctuation">(</span>childNode<span class="token punctuation">,</span> oldChild<span class="token punctuation">)</span> <span class="token operator">:</span> parentNode<span class="token punctuation">.</span><span class="token function">appendChild</span><span class="token punctuation">(</span>childNode<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">function</span> <span class="token function">getChildrenElementMap</span><span class="token punctuation">(</span><span class="token parameter">childrenElements</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">let</span> childrenElementMap <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> childrenElements<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">let</span> key <span class="token operator">=</span> childrenElements<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>key <span class="token operator">||</span> i<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        childrenElementMap<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">=</span> childrenElements<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    <span class="token keyword">return</span> childrenElementMap<span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">function</span> <span class="token function">getNewChildren</span><span class="token punctuation">(</span><span class="token parameter">oldChildrenElementMap<span class="token punctuation">,</span> newChildrenElements</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">let</span> newChildrenElementMap <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span></span>
<span class="line">    newChildrenElements<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">newChildElement<span class="token punctuation">,</span> index</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">if</span> <span class="token punctuation">(</span>newChildElement<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token keyword">let</span> newKey <span class="token operator">=</span> newChildElement<span class="token punctuation">.</span>key <span class="token operator">||</span> index<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">            <span class="token keyword">let</span> oldChildElement <span class="token operator">=</span> oldChildrenElementMap<span class="token punctuation">[</span>newKey<span class="token punctuation">]</span><span class="token punctuation">;</span></span>
<span class="line">            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">canDeepCompare</span><span class="token punctuation">(</span>oldChildElement<span class="token punctuation">,</span> newChildElement<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">                <span class="token function">updateElement</span><span class="token punctuation">(</span>oldChildElement<span class="token punctuation">,</span> newChildElement<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">                newChildrenElements<span class="token punctuation">[</span>index<span class="token punctuation">]</span> <span class="token operator">=</span> oldChildElement<span class="token punctuation">;</span></span>
<span class="line">            <span class="token punctuation">}</span></span>
<span class="line">            newChildrenElementMap<span class="token punctuation">[</span>newKey<span class="token punctuation">]</span> <span class="token operator">=</span> newChildrenElements<span class="token punctuation">[</span>index<span class="token punctuation">]</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">return</span> newChildrenElementMap<span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">function</span> <span class="token function">canDeepCompare</span><span class="token punctuation">(</span><span class="token parameter">oldChildElement<span class="token punctuation">,</span> newChildElement</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token operator">!</span>oldChildElement <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token operator">!</span>newChildElement<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">return</span> oldChildElement<span class="token punctuation">.</span>type <span class="token operator">===</span> newChildElement<span class="token punctuation">.</span>type<span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">function</span> <span class="token function">updateDOMProps</span><span class="token punctuation">(</span><span class="token parameter">dom<span class="token punctuation">,</span> oldProps<span class="token punctuation">,</span> newProps</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">return</span> <span class="token function">patchProps</span><span class="token punctuation">(</span>dom<span class="token punctuation">,</span> oldProps<span class="token punctuation">,</span> newProps<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">function</span> <span class="token function">updateClassComponent</span><span class="token punctuation">(</span><span class="token parameter">oldElement<span class="token punctuation">,</span> newElement</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">let</span> componentInstance <span class="token operator">=</span> oldElement<span class="token punctuation">.</span>componentInstance<span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">let</span> updater <span class="token operator">=</span> componentInstance<span class="token punctuation">.</span>$updater<span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">let</span> nextProps <span class="token operator">=</span> newElement<span class="token punctuation">.</span>props<span class="token punctuation">;</span></span>
<span class="line"><span class="token operator">+</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>oldElement<span class="token punctuation">.</span>type<span class="token punctuation">.</span>contextType<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line"><span class="token operator">+</span>        componentInstance<span class="token punctuation">.</span>context <span class="token operator">=</span> oldElement<span class="token punctuation">.</span>type<span class="token punctuation">.</span>contextType<span class="token punctuation">.</span>Provider<span class="token punctuation">.</span>value<span class="token punctuation">;</span></span>
<span class="line"><span class="token operator">+</span>    <span class="token punctuation">}</span></span>
<span class="line">    <span class="token keyword">if</span> <span class="token punctuation">(</span>componentInstance<span class="token punctuation">.</span>componentWillReceiveProps<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        componentInstance<span class="token punctuation">.</span><span class="token function">componentWillReceiveProps</span><span class="token punctuation">(</span>nextProps<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    <span class="token keyword">if</span> <span class="token punctuation">(</span>newElement<span class="token punctuation">.</span>type<span class="token punctuation">.</span>getDerivedStateFromProps<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">let</span> newState <span class="token operator">=</span> newElement<span class="token punctuation">.</span>type<span class="token punctuation">.</span><span class="token function">getDerivedStateFromProps</span><span class="token punctuation">(</span>nextProps<span class="token punctuation">,</span> componentInstance<span class="token punctuation">.</span>state<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">if</span> <span class="token punctuation">(</span>newState<span class="token punctuation">)</span></span>
<span class="line">            componentInstance<span class="token punctuation">.</span>state <span class="token operator">=</span> newState<span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    updater<span class="token punctuation">.</span><span class="token function">emitUpdate</span><span class="token punctuation">(</span>nextProps<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">function</span> <span class="token function">updateFunctionComponent</span><span class="token punctuation">(</span><span class="token parameter">oldElement<span class="token punctuation">,</span> newElement</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">let</span> newRenderElement <span class="token operator">=</span> newElement<span class="token punctuation">.</span><span class="token function">type</span><span class="token punctuation">(</span>newElement<span class="token punctuation">.</span>props<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">var</span> oldRenderElement <span class="token operator">=</span> oldElement<span class="token punctuation">.</span>renderElement<span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">var</span> currentElement <span class="token operator">=</span> <span class="token function">compareTwoElements</span><span class="token punctuation">(</span>oldRenderElement<span class="token punctuation">,</span> newRenderElement<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    newElement<span class="token punctuation">.</span>renderElement <span class="token operator">=</span> currentElement<span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"><span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">ReactElement</span><span class="token punctuation">(</span><span class="token parameter">$$<span class="token keyword">typeof</span><span class="token punctuation">,</span> type<span class="token punctuation">,</span> key<span class="token punctuation">,</span> ref<span class="token punctuation">,</span> props</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">let</span> element <span class="token operator">=</span> <span class="token punctuation">{</span></span>
<span class="line">        $$<span class="token keyword">typeof</span><span class="token punctuation">,</span></span>
<span class="line">        type<span class="token punctuation">,</span></span>
<span class="line">        props<span class="token punctuation">,</span></span>
<span class="line">        key<span class="token punctuation">,</span></span>
<span class="line">        ref</span>
<span class="line">    <span class="token punctuation">}</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">return</span> element<span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="_9-dom-diff" tabindex="-1"><a class="header-anchor" href="#_9-dom-diff"><span>9. DOM-DIFF</span></a></h2><ul><li>DOM 节点跨层级的移动操作特别少，可以忽略不计</li><li>拥有相同类的两个组件将会生成相似的树形结构，拥有不同类的两个组件将会生成不同的树形结构</li><li>对于同一层级的一组子节点，它们可以通过唯一<code>key</code>进行区分</li><li>DIFF算法在执行时有三个维度，分别是Tree DIFF、Component DIFF和Element DIFF，执行时按顺序依次执行，它们的差异仅仅因为DIFF粒度不同、执行先后顺序不同</li></ul><h3 id="_9-1-tree-diff" tabindex="-1"><a class="header-anchor" href="#_9-1-tree-diff"><span>9.1 Tree DIFF</span></a></h3><ul><li>Tree DIFF是对树的每一层进行遍历，如果某组件不存在了，则会直接销毁</li></ul><p><img src="http://img.zhufengpeixun.cn/sametree.png" alt="sametree"></p><ul><li>当出现节点跨层级移动时，并不会出现想象中的移动操作，而是以 A 为根节点的树被整个重新创建</li></ul><p><img src="http://img.zhufengpeixun.cn/movemytree.png" alt="movemytree"></p><h3 id="_9-2-component-diff" tabindex="-1"><a class="header-anchor" href="#_9-2-component-diff"><span>9.2 Component DIFF</span></a></h3><ul><li>如果是同一类型的组件，按照原策略继续比较</li><li>类型不同则直接替换</li></ul><p><img src="http://img.zhufengpeixun.cn/deleteall.png" alt="deleteall"></p><h3 id="_9-3-element-diff" tabindex="-1"><a class="header-anchor" href="#_9-3-element-diff"><span>9.3 Element DIFF</span></a></h3><ul><li>当节点处于同一层级时，React diff 提供了三种节点操作,分别为：INSERT(插入)、MOVE(移动)和 REMOVE(删除) <ul><li>INSERT: 新的 component 类型不在老集合里， 即是全新的节点，需要对新节点执行插入操作</li><li>MOVE: 在老集合有新 component 类型，就需要做更新和移动操作，可以复用以前的 DOM 节点</li><li>REMOVE: 老 component 不在新集合里的，也需要执行删除操作</li></ul></li></ul><p><img src="http://img.zhufengpeixun.cn/oldnewmove.png" alt="oldnewmove"></p><p><img src="http://img.zhufengpeixun.cn/oldnewmove2.png" alt="oldnewmove2"></p><p><img src="http://img.zhufengpeixun.cn/oldnewmove3.png" alt="oldnewmove3"></p>`,129)])])}const i=s(t,[["render",l]]),u=JSON.parse('{"path":"/strong/96.1.react16.html","title":"","lang":"en-US","frontmatter":{},"git":{"updatedTime":1681290319000,"contributors":[{"name":"yutao","username":"yutao","email":"642231346@qq.com","commits":1,"url":"https://github.com/yutao"}],"changelog":[{"hash":"f5ab8c9d34991ec274f7f652439afe5b2afb6147","time":1681290319000,"email":"642231346@qq.com","author":"yutao","message":"modify"}]},"filePathRelative":"strong/96.1.react16.md"}');export{i as comp,u as data};
