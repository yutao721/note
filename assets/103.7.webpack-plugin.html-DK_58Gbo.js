import{_ as n,c as s,a,o as e}from"./app-CD1YpnS1.js";const l={};function p(o,t){return e(),s("div",null,[...t[0]||(t[0]=[a(`<h2 id="_1-plugin" tabindex="-1"><a class="header-anchor" href="#_1-plugin"><span>1. plugin</span></a></h2><p>插件向第三方开发者提供了 webpack 引擎中完整的能力。使用阶段式的构建回调，开发者可以引入它们自己的行为到 webpack 构建流程中。创建插件比创建 loader 更加高级，因为你将需要理解一些 webpack 底层的内部特性来做相应的钩子</p><h3 id="_1-1-为什么需要一个插件" tabindex="-1"><a class="header-anchor" href="#_1-1-为什么需要一个插件"><span>1.1 为什么需要一个插件</span></a></h3><ul><li>webpack 基础配置无法满足需求</li><li>插件几乎能够任意更改 webpack 编译结果</li><li>webpack 内部也是通过大量内部插件实现的</li></ul><h3 id="_1-2-可以加载插件的常用对象" tabindex="-1"><a class="header-anchor" href="#_1-2-可以加载插件的常用对象"><span>1.2 可以加载插件的常用对象</span></a></h3><table><thead><tr><th style="text-align:left;">对象</th><th style="text-align:left;">钩子</th></tr></thead><tbody><tr><td style="text-align:left;"><a href="https://github.com/webpack/webpack/blob/v4.39.3/lib/Compiler.js" target="_blank" rel="noopener noreferrer">Compiler</a></td><td style="text-align:left;">run,compile,compilation,make,emit,done</td></tr><tr><td style="text-align:left;"><a href="https://github.com/webpack/webpack/blob/v4.39.3/lib/Compilation.js" target="_blank" rel="noopener noreferrer">Compilation</a></td><td style="text-align:left;">buildModule,normalModuleLoader,succeedModule,finishModules,seal,optimize,after-seal</td></tr><tr><td style="text-align:left;"><a href="https://github.com/webpack/webpack/blob/master/lib/ModuleFactory.js" target="_blank" rel="noopener noreferrer">Module Factory</a></td><td style="text-align:left;">beforeResolver,afterResolver,module,parser</td></tr><tr><td style="text-align:left;">Module</td><td style="text-align:left;"></td></tr><tr><td style="text-align:left;"><a href="https://github.com/webpack/webpack/blob/master/lib/Parser.js" target="_blank" rel="noopener noreferrer">Parser</a></td><td style="text-align:left;">program,statement,call,expression</td></tr><tr><td style="text-align:left;"><a href="https://github.com/webpack/webpack/blob/master/lib/Template.js" target="_blank" rel="noopener noreferrer">Template</a></td><td style="text-align:left;">hash,bootstrap,localVars,render</td></tr></tbody></table><h2 id="_2-创建插件" tabindex="-1"><a class="header-anchor" href="#_2-创建插件"><span>2. 创建插件</span></a></h2><ul><li>插件是一个类</li><li>类上有一个apply的实例方法</li><li>apply的参数是compiler</li></ul><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code class="language-javascript"><span class="line"><span class="token keyword">class</span> <span class="token class-name">DonePlugin</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter">options</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">this</span><span class="token punctuation">.</span>options <span class="token operator">=</span> options<span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    <span class="token function">apply</span><span class="token punctuation">(</span><span class="token parameter">compiler</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line"></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line">module<span class="token punctuation">.</span>exports <span class="token operator">=</span> DonePlugin<span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="_3-compiler-和-compilation" tabindex="-1"><a class="header-anchor" href="#_3-compiler-和-compilation"><span>3. Compiler 和 Compilation</span></a></h2><p>在插件开发中最重要的两个资源就是<code>compiler</code>和<code>compilation</code>对象。理解它们的角色是扩展 webpack 引擎重要的第一步。</p><ul><li><p>compiler 对象代表了完整的 webpack 环境配置。这个对象在启动 webpack 时被一次性建立，并配置好所有可操作的设置，包括 options，loader 和 plugin。当在 webpack 环境中应用一个插件时，插件将收到此 compiler 对象的引用。可以使用它来访问 webpack 的主环境。</p></li><li><p>compilation 对象代表了一次资源版本构建。当运行 webpack 开发环境中间件时，每当检测到一个文件变化，就会创建一个新的 compilation，从而生成一组新的编译资源。一个 compilation 对象表现了当前的模块资源、编译生成资源、变化的文件、以及被跟踪依赖的状态信息。compilation 对象也提供了很多关键时机的回调，以供插件做自定义处理时选择使用。</p></li></ul><h2 id="_4-基本插件架构" tabindex="-1"><a class="header-anchor" href="#_4-基本插件架构"><span>4. 基本插件架构</span></a></h2><ul><li>插件是由「具有 apply 方法的 prototype 对象」所实例化出来的</li><li>这个 apply 方法在安装插件时，会被 webpack compiler 调用一次</li><li>apply 方法可以接收一个 webpack compiler 对象的引用，从而可以在回调函数中访问到 compiler 对象</li></ul><h3 id="_4-1-使用插件代码" tabindex="-1"><a class="header-anchor" href="#_4-1-使用插件代码"><span>4.1 使用插件代码</span></a></h3><ul><li>[使用插件][https://github.com/webpack/webpack/blob/master/lib/webpack.js#L60-L69](https://github.com/webpack/webpack/blob/master/lib/webpack.js</li></ul><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code class="language-javascript"><span class="line"><span class="token keyword">if</span> <span class="token punctuation">(</span>options<span class="token punctuation">.</span>plugins <span class="token operator">&amp;&amp;</span> Array<span class="token punctuation">.</span><span class="token function">isArray</span><span class="token punctuation">(</span>options<span class="token punctuation">.</span>plugins<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> plugin <span class="token keyword">of</span> options<span class="token punctuation">.</span>plugins<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token function">plugin</span><span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span>compiler<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">  <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_4-2-compiler-插件" tabindex="-1"><a class="header-anchor" href="#_4-2-compiler-插件"><span>4.2 Compiler 插件</span></a></h3><ul><li>[done: new AsyncSeriesHook([&quot;stats&quot;])](https://github.com/webpack/webpack/blob/master/lib/Compiler.js</li></ul><h4 id="_4-2-1-同步" tabindex="-1"><a class="header-anchor" href="#_4-2-1-同步"><span>4.2.1 同步</span></a></h4><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code class="language-javascript"><span class="line"><span class="token keyword">class</span> <span class="token class-name">DonePlugin</span> <span class="token punctuation">{</span></span>
<span class="line">  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter">options</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">this</span><span class="token punctuation">.</span>options <span class="token operator">=</span> options<span class="token punctuation">;</span></span>
<span class="line">  <span class="token punctuation">}</span></span>
<span class="line">  <span class="token function">apply</span><span class="token punctuation">(</span><span class="token parameter">compiler</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    compiler<span class="token punctuation">.</span>hooks<span class="token punctuation">.</span>done<span class="token punctuation">.</span><span class="token function">tap</span><span class="token punctuation">(</span><span class="token string">&quot;DonePlugin&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">stats</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></span>
<span class="line">      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;Hello &quot;</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>options<span class="token punctuation">.</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">  <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line">module<span class="token punctuation">.</span>exports <span class="token operator">=</span> DonePlugin<span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_4-2-2-异步" tabindex="-1"><a class="header-anchor" href="#_4-2-2-异步"><span>4.2.2 异步</span></a></h4><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code class="language-javascript"><span class="line"><span class="token keyword">class</span> <span class="token class-name">DonePlugin</span> <span class="token punctuation">{</span></span>
<span class="line">  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter">options</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">this</span><span class="token punctuation">.</span>options <span class="token operator">=</span> options<span class="token punctuation">;</span></span>
<span class="line">  <span class="token punctuation">}</span></span>
<span class="line">  <span class="token function">apply</span><span class="token punctuation">(</span><span class="token parameter">compiler</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    compiler<span class="token punctuation">.</span>hooks<span class="token punctuation">.</span>done<span class="token punctuation">.</span><span class="token function">tapAsync</span><span class="token punctuation">(</span><span class="token string">&quot;DonePlugin&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">stats<span class="token punctuation">,</span> callback</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></span>
<span class="line">      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;Hello &quot;</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>options<span class="token punctuation">.</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">      <span class="token function">callback</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">  <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line">module<span class="token punctuation">.</span>exports <span class="token operator">=</span> DonePlugin<span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_4-3-使用插件" tabindex="-1"><a class="header-anchor" href="#_4-3-使用插件"><span>4.3 使用插件</span></a></h3><ul><li>要安装这个插件，只需要在你的 webpack 配置的 plugin 数组中添加一个实例</li></ul><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code class="language-javascript"><span class="line"><span class="token keyword">const</span> DonePlugin <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;./plugins/DonePlugin&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span></span>
<span class="line">  <span class="token literal-property property">entry</span><span class="token operator">:</span> <span class="token string">&quot;./src/index.js&quot;</span><span class="token punctuation">,</span></span>
<span class="line">  <span class="token literal-property property">output</span><span class="token operator">:</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token literal-property property">path</span><span class="token operator">:</span> path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token string">&quot;build&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token literal-property property">filename</span><span class="token operator">:</span> <span class="token string">&quot;bundle.js&quot;</span><span class="token punctuation">,</span></span>
<span class="line">  <span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">  <span class="token literal-property property">plugins</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token keyword">new</span> <span class="token class-name">DonePlugin</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">&quot;zhufeng&quot;</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">,</span></span>
<span class="line"><span class="token punctuation">}</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="_5-compilation-插件" tabindex="-1"><a class="header-anchor" href="#_5-compilation-插件"><span>5. compilation 插件</span></a></h2><ul><li>使用 compiler 对象时，你可以绑定提供了编译 compilation 引用的回调函数，然后拿到每次新的 compilation 对象。这些 compilation 对象提供了一些钩子函数，来钩入到构建流程的很多步骤中</li></ul><h3 id="_5-1-webpack-assets-plugin-js" tabindex="-1"><a class="header-anchor" href="#_5-1-webpack-assets-plugin-js"><span>5.1 webpack-assets-plugin.js</span></a></h3><p>plugins\\webpack-assets-plugin.js</p><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code class="language-javascript"><span class="line"></span>
<span class="line"><span class="token comment">//编写个Compilation插件，用来打印本次产出的代码块和文件</span></span>
<span class="line"><span class="token keyword">class</span> <span class="token class-name">WebpackAssetsPlugin</span> <span class="token punctuation">{</span></span>
<span class="line">  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter">options</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">this</span><span class="token punctuation">.</span>options <span class="token operator">=</span> options<span class="token punctuation">;</span></span>
<span class="line">  <span class="token punctuation">}</span></span>
<span class="line">  <span class="token function">apply</span><span class="token punctuation">(</span><span class="token parameter">compiler</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token comment">//每当webpack开启一次新的编译 ，就会创建一个新的compilation</span></span>
<span class="line">    compiler<span class="token punctuation">.</span>hooks<span class="token punctuation">.</span>compilation<span class="token punctuation">.</span><span class="token function">tap</span><span class="token punctuation">(</span><span class="token string">&#39;WebpackAssetsPlugin&#39;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">compilation</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></span>
<span class="line">      <span class="token comment">//每次根据chunk创建一个新的文件后会触发一次chunkAsset</span></span>
<span class="line">      compilation<span class="token punctuation">.</span>hooks<span class="token punctuation">.</span>chunkAsset<span class="token punctuation">.</span><span class="token function">tap</span><span class="token punctuation">(</span><span class="token string">&#39;WebpackAssetsPlugin&#39;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">chunk<span class="token punctuation">,</span> filename</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></span>
<span class="line">        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>chunk<span class="token punctuation">.</span>name <span class="token operator">||</span> chunk<span class="token punctuation">.</span>id<span class="token punctuation">,</span> filename<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">  <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line">module<span class="token punctuation">.</span>exports <span class="token operator">=</span> WebpackAssetsPlugin<span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="_6-打包-zip" tabindex="-1"><a class="header-anchor" href="#_6-打包-zip"><span>6. 打包 zip</span></a></h2><ul><li><a href="https://www.npmjs.com/package/webpack-sources" target="_blank" rel="noopener noreferrer">webpack-sources</a></li></ul><h3 id="_6-1-webpack-archive-plugin-js" tabindex="-1"><a class="header-anchor" href="#_6-1-webpack-archive-plugin-js"><span>6.1 webpack-archive-plugin.js</span></a></h3><p>plugins\\webpack-archive-plugin.js</p><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code class="language-javascript"><span class="line"><span class="token keyword">const</span> jszip <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&#39;jszip&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">const</span> <span class="token punctuation">{</span> RawSource <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&#39;webpack-sources&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">const</span> <span class="token punctuation">{</span> Compilation <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&#39;webpack&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token doc-comment comment">/**</span>
<span class="line"> * 1.如何获取打出后的文件名和文件内容</span>
<span class="line"> * 2.如何打压缩包 </span>
<span class="line"> * 3.如何向目标目录输出压缩包</span>
<span class="line"> */</span></span>
<span class="line"><span class="token keyword">class</span> <span class="token class-name">WebpackArchivePlugin</span> <span class="token punctuation">{</span></span>
<span class="line">  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter">options</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">this</span><span class="token punctuation">.</span>options <span class="token operator">=</span> options<span class="token punctuation">;</span></span>
<span class="line">  <span class="token punctuation">}</span></span>
<span class="line">  <span class="token function">apply</span><span class="token punctuation">(</span><span class="token parameter">compiler</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    compiler<span class="token punctuation">.</span>hooks<span class="token punctuation">.</span>compilation<span class="token punctuation">.</span><span class="token function">tap</span><span class="token punctuation">(</span><span class="token string">&#39;WebpackAssetsPlugin&#39;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">compilation</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></span>
<span class="line">      <span class="token comment">//当确定好文件，当你处理每个资源的时候处执行</span></span>
<span class="line">      compilation<span class="token punctuation">.</span>hooks<span class="token punctuation">.</span>processAssets<span class="token punctuation">.</span><span class="token function">tapPromise</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">&#39;WebpackArchivePlugin&#39;</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">assets</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">const</span> zip <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">jszip</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> filename <span class="token keyword">in</span> assets<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">          <span class="token keyword">const</span> sourceObj <span class="token operator">=</span> assets<span class="token punctuation">[</span>filename<span class="token punctuation">]</span><span class="token punctuation">;</span></span>
<span class="line">          <span class="token keyword">const</span> sourceCode <span class="token operator">=</span> sourceObj<span class="token punctuation">.</span><span class="token function">source</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">          zip<span class="token punctuation">.</span><span class="token function">file</span><span class="token punctuation">(</span>filename<span class="token punctuation">,</span> sourceCode<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">        <span class="token keyword">return</span> zip<span class="token punctuation">.</span><span class="token function">generateAsync</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token string">&#39;nodebuffer&#39;</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">zipContent</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></span>
<span class="line">          assets<span class="token punctuation">[</span><span class="token template-string"><span class="token template-punctuation string">\`</span><span class="token string">archive_</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">\${</span>Date<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">。zip</span><span class="token template-punctuation string">\`</span></span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">RawSource</span><span class="token punctuation">(</span>zipContent<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">  <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line">module<span class="token punctuation">.</span>exports <span class="token operator">=</span> WebpackArchivePlugin<span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_6-2-webpack-config-js" tabindex="-1"><a class="header-anchor" href="#_6-2-webpack-config-js"><span>6.2 webpack.config.js</span></a></h3><p>webpack.config.js</p><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text"><pre><code class="language-text"><span class="line">const WebpackArchivePlugin = require(&#39;./plugins/webpack-archive-plugin&#39;);</span>
<span class="line">  plugins: [</span>
<span class="line">+   new WebpackArchivePlugin({</span>
<span class="line">+     filename:&#39;[timestamp].zip&#39;</span>
<span class="line">+   })</span>
<span class="line">]</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="_7-自动外链" tabindex="-1"><a class="header-anchor" href="#_7-自动外链"><span>7.自动外链</span></a></h2><h2 id="_7-自动外链-1" tabindex="-1"><a class="header-anchor" href="#_7-自动外链-1"><span>7.自动外链</span></a></h2><h3 id="_7-1-使用外部类库" tabindex="-1"><a class="header-anchor" href="#_7-1-使用外部类库"><span>7.1 使用外部类库</span></a></h3><ul><li>手动指定 <code>external</code></li><li>手动引入 <code>script</code></li></ul><blockquote><p>能否检测代码中的 import 自动处理这个步骤?</p></blockquote><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code class="language-javascript"><span class="line"><span class="token punctuation">{</span></span>
<span class="line">  <span class="token literal-property property">externals</span><span class="token operator">:</span><span class="token punctuation">{</span></span>
<span class="line">    <span class="token comment">//key jquery是要require或import 的模块名,值 jQuery是一个全局变量名</span></span>
<span class="line">  <span class="token string-property property">&#39;jquery&#39;</span><span class="token operator">:</span><span class="token string">&#39;$&#39;</span></span>
<span class="line"><span class="token punctuation">}</span><span class="token punctuation">,</span> </span>
<span class="line">  <span class="token literal-property property">module</span><span class="token operator">:</span><span class="token punctuation">{</span><span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_7-2-思路" tabindex="-1"><a class="header-anchor" href="#_7-2-思路"><span>7.2 思路</span></a></h3><ul><li>解决 import 自动处理<code>external</code>和<code>script</code>的问题，需要怎么实现，该从哪方面开始考虑</li><li><code>依赖</code> 当检测到有<code>import</code>该<code>library</code>时，将其设置为不打包类似<code>exteral</code>,并在指定模版中加入 script,那么如何检测 import？这里就用<code>Parser</code></li><li><code>external依赖</code> 需要了解 external 是如何实现的，webpack 的 external 是通过插件<code>ExternalsPlugin</code>实现的，ExternalsPlugin 通过<code>tap\`\`NormalModuleFactory</code> 在每次创建 Module 的时候判断是否是<code>ExternalModule</code></li><li>webpack4 加入了模块类型之后，<code>Parser</code>获取需要指定类型 moduleType,一般使用<code>javascript/auto</code>即可</li></ul><h3 id="_7-3-使用-plugins" tabindex="-1"><a class="header-anchor" href="#_7-3-使用-plugins"><span>7.3 使用 plugins</span></a></h3><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code class="language-javascript"><span class="line"><span class="token literal-property property">plugins</span><span class="token operator">:</span> <span class="token punctuation">[</span></span>
<span class="line">  <span class="token keyword">new</span> <span class="token class-name">HtmlWebpackPlugin</span><span class="token punctuation">(</span><span class="token punctuation">{</span></span>
<span class="line">            <span class="token literal-property property">template</span><span class="token operator">:</span><span class="token string">&#39;./src/index.html&#39;</span></span>
<span class="line">  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line">  <span class="token keyword">new</span> <span class="token class-name">AutoExternalPlugin</span><span class="token punctuation">(</span><span class="token punctuation">{</span></span>
<span class="line">      <span class="token literal-property property">jquery</span><span class="token operator">:</span><span class="token punctuation">{</span><span class="token comment">//自动把jquery模块变成一个外部依赖模块</span></span>
<span class="line">          <span class="token literal-property property">variable</span><span class="token operator">:</span><span class="token string">&#39;jQuery&#39;</span><span class="token punctuation">,</span><span class="token comment">//不再打包，而是从window.jQuery变量上获取jquery对象</span></span>
<span class="line">          <span class="token literal-property property">url</span><span class="token operator">:</span><span class="token string">&#39;https://cdn.bootcss.com/jquery/3.1.0/jquery.js&#39;</span><span class="token comment">//CDN脚本</span></span>
<span class="line">      <span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">      <span class="token literal-property property">lodash</span><span class="token operator">:</span><span class="token punctuation">{</span><span class="token comment">//自动把jquery模块变成一个外部依赖模块</span></span>
<span class="line">          <span class="token literal-property property">variable</span><span class="token operator">:</span><span class="token string">&#39;_&#39;</span><span class="token punctuation">,</span><span class="token comment">//不再打包，而是从window.jQuery变量上获取jquery对象</span></span>
<span class="line">          <span class="token literal-property property">url</span><span class="token operator">:</span><span class="token string">&#39;https://cdn.bootcdn.net/ajax/libs/lodash.js/4.17.21/lodash.js&#39;</span><span class="token comment">//CDN脚本</span></span>
<span class="line">      <span class="token punctuation">}</span></span>
<span class="line">  <span class="token punctuation">}</span><span class="token punctuation">)</span></span>
<span class="line"><span class="token punctuation">]</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_7-4-autoexternalplugin" tabindex="-1"><a class="header-anchor" href="#_7-4-autoexternalplugin"><span>7.4 AutoExternalPlugin</span></a></h3><ul><li><a href="https://github.com/webpack/webpack/blob/0d4607c68e04a659fa58499e1332c97d5376368a/lib/ExternalsPlugin.js" target="_blank" rel="noopener noreferrer">ExternalsPlugin.js</a></li><li><a href="https://github.com/webpack/webpack/blob/eeafeee32ad5a1469e39ce66df671e3710332608/lib/ExternalModuleFactoryPlugin.js" target="_blank" rel="noopener noreferrer">ExternalModuleFactoryPlugin</a></li><li><a href="https://github.com/webpack/webpack/blob/eeafeee32ad5a1469e39ce66df671e3710332608/lib/ExternalModule.js" target="_blank" rel="noopener noreferrer">ExternalModule.js</a></li><li>[parser](https://github.com/zhufengnodejs/webpack-analysis/blob/master/node_modules/_webpack%404.20.2%40webpack/lib/NormalModuleFactory.js</li><li>[factory](https://github.com/zhufengnodejs/webpack-analysis/blob/master/node_modules/_webpack%404.20.2%40webpack/lib/NormalModuleFactory.js</li><li>[htmlWebpackPluginAlterAssetTags](https://github.com/jantimon/html-webpack-plugin/blob/v3.2.0/index.js</li></ul><p>AsyncSeriesBailHook factorize</p><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code class="language-javascript"><span class="line"><span class="token keyword">let</span> <span class="token punctuation">{</span> AsyncSeriesBailHook <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;tapable&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">let</span> factorize <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">AsyncSeriesBailHook</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">&#39;resolveData&#39;</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token comment">//最后总得返回一个模块吧 switch case default </span></span>
<span class="line">factorize<span class="token punctuation">.</span><span class="token function">tapAsync</span><span class="token punctuation">(</span><span class="token string">&#39;factory1&#39;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">resolveData<span class="token punctuation">,</span> callback</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></span>
<span class="line">  <span class="token keyword">if</span> <span class="token punctuation">(</span>resolveData <span class="token operator">===</span> <span class="token string">&#39;jquery&#39;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token function">callback</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token punctuation">{</span></span>
<span class="line">      <span class="token literal-property property">id</span><span class="token operator">:</span> resolveData<span class="token punctuation">,</span></span>
<span class="line">      <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token string">&#39;外部模块&#39;</span><span class="token punctuation">,</span></span>
<span class="line">      <span class="token literal-property property">source</span><span class="token operator">:</span> <span class="token string">&#39;window.jQuery&#39;</span></span>
<span class="line">    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token function">callback</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">  <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token comment">//生成正常模块的工厂函数最后一个工厂函数了，</span></span>
<span class="line">factorize<span class="token punctuation">.</span><span class="token function">tapAsync</span><span class="token punctuation">(</span><span class="token string">&#39;factory2&#39;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">resolveData<span class="token punctuation">,</span> callback</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></span>
<span class="line">  <span class="token function">callback</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> <span class="token literal-property property">id</span><span class="token operator">:</span> resolveData<span class="token punctuation">,</span> <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token string">&#39;正常模块&#39;</span><span class="token punctuation">,</span> <span class="token literal-property property">source</span><span class="token operator">:</span> <span class="token string">&#39;webpack打包后的内容&#39;</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">factorize<span class="token punctuation">.</span><span class="token function">callAsync</span><span class="token punctuation">(</span><span class="token string">&#39;jquery&#39;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">err<span class="token punctuation">,</span> module</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></span>
<span class="line">  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>module<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">factorize<span class="token punctuation">.</span><span class="token function">callAsync</span><span class="token punctuation">(</span><span class="token string">&#39;lodash&#39;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">err<span class="token punctuation">,</span> module</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></span>
<span class="line">  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>module<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>plugins\\auto-external-plugin.js</p><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code class="language-javascript"><span class="line"><span class="token keyword">const</span> <span class="token punctuation">{</span> ExternalModule <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;webpack&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">const</span> HtmlWebpackPlugin <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&#39;html-webpack-plugin&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token doc-comment comment">/**</span>
<span class="line"> * 1.需要向输出html文件中添加CDN脚本引用</span>
<span class="line"> * 2.在打包生产模块的时候，截断正常的打包逻辑，变成外部依赖模块</span>
<span class="line"> */</span></span>
<span class="line"><span class="token keyword">class</span> <span class="token class-name">AutoExternalPlugin</span><span class="token punctuation">{</span></span>
<span class="line">    <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter">options</span><span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">this</span><span class="token punctuation">.</span>options <span class="token operator">=</span> options<span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">this</span><span class="token punctuation">.</span>externalModules <span class="token operator">=</span> Object<span class="token punctuation">.</span><span class="token function">keys</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>options<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//[&#39;jquery&#39;] 进行自动外键的模块</span></span>
<span class="line">        <span class="token keyword">this</span><span class="token punctuation">.</span>importedModules <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Set</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//存放着所有的实际真正使用到的外部依赖模块</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    <span class="token function">apply</span><span class="token punctuation">(</span><span class="token parameter">compiler</span><span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line">        <span class="token comment">//每种模块会对应一个模块工厂 普通模块对应的就是普通模块工厂</span></span>
<span class="line">        <span class="token comment">//https://webpack.docschina.org/api/normalmodulefactory-hooks/</span></span>
<span class="line">        compiler<span class="token punctuation">.</span>hooks<span class="token punctuation">.</span>normalModuleFactory<span class="token punctuation">.</span><span class="token function">tap</span><span class="token punctuation">(</span><span class="token string">&#39;AutoExternalPlugin&#39;</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token parameter">normalModuleFactory</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span></span>
<span class="line">             <span class="token comment">//https://webpack.docschina.org/api/parser/</span></span>
<span class="line">            normalModuleFactory<span class="token punctuation">.</span>hooks<span class="token punctuation">.</span>parser</span>
<span class="line">            <span class="token punctuation">.</span><span class="token function">for</span><span class="token punctuation">(</span><span class="token string">&#39;javascript/auto&#39;</span><span class="token punctuation">)</span><span class="token comment">//普通 的JS文件对应的钩子就是&#39;javascript/auto&#39;</span></span>
<span class="line">            <span class="token punctuation">.</span><span class="token function">tap</span><span class="token punctuation">(</span><span class="token string">&#39;AutoExternalPlugin&#39;</span><span class="token punctuation">,</span><span class="token parameter">parser</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span></span>
<span class="line">                <span class="token comment">//在parser遍历语法的过程中，如果遍历到了import节点</span></span>
<span class="line">                 <span class="token comment">//https://webpack.docschina.org/api/parser/</span></span>
<span class="line">                parser<span class="token punctuation">.</span>hooks<span class="token punctuation">.</span>import<span class="token punctuation">.</span><span class="token function">tap</span><span class="token punctuation">(</span><span class="token string">&#39;AutoExternalPlugin&#39;</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token parameter">statement<span class="token punctuation">,</span>source</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span></span>
<span class="line">                    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>externalModules<span class="token punctuation">.</span><span class="token function">includes</span><span class="token punctuation">(</span>source<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line">                        <span class="token keyword">this</span><span class="token punctuation">.</span>importedModules<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>source<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">                    <span class="token punctuation">}</span></span>
<span class="line">                <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">                 <span class="token comment">//https://webpack.docschina.org/api/parser/</span></span>
<span class="line">                <span class="token comment">//call=HookMap key方法名 值是这个方法对应的钩子</span></span>
<span class="line">                parser<span class="token punctuation">.</span>hooks<span class="token punctuation">.</span>call<span class="token punctuation">.</span><span class="token function">for</span><span class="token punctuation">(</span><span class="token string">&#39;require&#39;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">tap</span><span class="token punctuation">(</span><span class="token string">&#39;AutoExternalPlugin&#39;</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token parameter">expression</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span></span>
<span class="line">                    <span class="token keyword">let</span> value <span class="token operator">=</span> expression<span class="token punctuation">.</span>arguments<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>value<span class="token punctuation">;</span></span>
<span class="line">                    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>externalModules<span class="token punctuation">.</span><span class="token function">includes</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line">                        <span class="token keyword">this</span><span class="token punctuation">.</span>importedModules<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">                    <span class="token punctuation">}</span></span>
<span class="line">                <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">            <span class="token punctuation">}</span><span class="token punctuation">)</span></span>
<span class="line">            <span class="token comment">//2.改造模块的生产过程，如果是外链模块，就直接生产一个外链模块返回</span></span>
<span class="line">            <span class="token comment">//https://webpack.docschina.org/api/normalmodulefactory-hooks/</span></span>
<span class="line">            normalModuleFactory<span class="token punctuation">.</span>hooks<span class="token punctuation">.</span>factorize<span class="token punctuation">.</span><span class="token function">tapAsync</span><span class="token punctuation">(</span><span class="token string">&#39;AutoExternalPlugin&#39;</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token parameter">resolveData<span class="token punctuation">,</span>callback</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span></span>
<span class="line">                <span class="token keyword">let</span> <span class="token punctuation">{</span>request<span class="token punctuation">}</span> <span class="token operator">=</span> resolveData<span class="token punctuation">;</span><span class="token comment">//模块名 jquery lodash</span></span>
<span class="line">                <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>externalModules<span class="token punctuation">.</span><span class="token function">includes</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line">                    <span class="token keyword">let</span> <span class="token punctuation">{</span>variable<span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>options<span class="token punctuation">[</span>request<span class="token punctuation">]</span><span class="token punctuation">;</span></span>
<span class="line">                    <span class="token comment">//request=jquery window.jQuery</span></span>
<span class="line">                    <span class="token function">callback</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span><span class="token keyword">new</span> <span class="token class-name">ExternalModule</span><span class="token punctuation">(</span>variable<span class="token punctuation">,</span><span class="token string">&#39;window&#39;</span><span class="token punctuation">,</span>request<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">                <span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{</span></span>
<span class="line">                    <span class="token function">callback</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//如果是正常模块，直接向后执行。走正常的打包模块的流程</span></span>
<span class="line">                <span class="token punctuation">}</span></span>
<span class="line">            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token comment">//是往输出的HTML中添加一个新的CDN Script标签</span></span>
<span class="line">        compiler<span class="token punctuation">.</span>hooks<span class="token punctuation">.</span>compilation<span class="token punctuation">.</span><span class="token function">tap</span><span class="token punctuation">(</span><span class="token string">&#39;AutoExternalPlugin&#39;</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token parameter">compilation</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span></span>
<span class="line">            HtmlWebpackPlugin<span class="token punctuation">.</span><span class="token function">getHooks</span><span class="token punctuation">(</span>compilation<span class="token punctuation">)</span><span class="token punctuation">.</span>alterAssetTags<span class="token punctuation">.</span><span class="token function">tapAsync</span><span class="token punctuation">(</span><span class="token string">&#39;AutoExternalPlugin&#39;</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token parameter">htmlData<span class="token punctuation">,</span>callback</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span></span>
<span class="line">                <span class="token comment">//console.log(JSON.stringify(htmlData,null,2));</span></span>
<span class="line">                Reflect<span class="token punctuation">.</span><span class="token function">ownKeys</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>options<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span><span class="token parameter">key</span><span class="token operator">=&gt;</span><span class="token keyword">this</span><span class="token punctuation">.</span>importedModules<span class="token punctuation">.</span><span class="token function">has</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">key</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span></span>
<span class="line">                    <span class="token comment">//jquery</span></span>
<span class="line">                    htmlData<span class="token punctuation">.</span>assetTags<span class="token punctuation">.</span>scripts<span class="token punctuation">.</span><span class="token function">unshift</span><span class="token punctuation">(</span><span class="token punctuation">{</span></span>
<span class="line">                        <span class="token literal-property property">tagName</span><span class="token operator">:</span><span class="token string">&#39;script&#39;</span><span class="token punctuation">,</span></span>
<span class="line">                        <span class="token literal-property property">voidTag</span><span class="token operator">:</span><span class="token boolean">false</span><span class="token punctuation">,</span></span>
<span class="line">                        <span class="token literal-property property">attributes</span><span class="token operator">:</span><span class="token punctuation">{</span></span>
<span class="line">                            <span class="token literal-property property">defer</span><span class="token operator">:</span><span class="token boolean">false</span><span class="token punctuation">,</span></span>
<span class="line">                            <span class="token literal-property property">src</span><span class="token operator">:</span><span class="token keyword">this</span><span class="token punctuation">.</span>options<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">.</span>url</span>
<span class="line">                        <span class="token punctuation">}</span></span>
<span class="line">                    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">                <span class="token punctuation">}</span><span class="token punctuation">)</span></span>
<span class="line">                <span class="token function">callback</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span>htmlData<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line">module<span class="token punctuation">.</span>exports <span class="token operator">=</span> AutoExternalPlugin<span class="token punctuation">;</span></span>
<span class="line"><span class="token doc-comment comment">/**</span>
<span class="line"> * Node <span class="token punctuation">{</span></span>
<span class="line">  type: &#39;ImportDeclaration&#39;,</span>
<span class="line">  start: 0,</span>
<span class="line">  end: 23,</span>
<span class="line">  loc: SourceLocation <span class="token punctuation">{</span></span>
<span class="line">    start: Position <span class="token punctuation">{</span> line: 1, column: 0 <span class="token punctuation">}</span>,</span>
<span class="line">    end: Position <span class="token punctuation">{</span> line: 1, column: 23 <span class="token punctuation">}</span></span>
<span class="line">  <span class="token punctuation">}</span>,</span>
<span class="line">  range: [ 0, 23 ],</span>
<span class="line">  specifiers: [</span>
<span class="line">    Node <span class="token punctuation">{</span></span>
<span class="line">      type: &#39;ImportDefaultSpecifier&#39;,</span>
<span class="line">      start: 7,</span>
<span class="line">      end: 8,</span>
<span class="line">      loc: [SourceLocation],</span>
<span class="line">      range: [Array],</span>
<span class="line">      local: [Node]</span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">  ],</span>
<span class="line">  source: Node <span class="token punctuation">{</span></span>
<span class="line">    type: &#39;Literal&#39;,</span>
<span class="line">    start: 14,</span>
<span class="line">    end: 22,</span>
<span class="line">    loc: SourceLocation <span class="token punctuation">{</span> start: [Position], end: [Position] <span class="token punctuation">}</span>,</span>
<span class="line">    range: [ 14, 22 ],</span>
<span class="line">    value: &#39;jquery&#39;,</span>
<span class="line">    raw: &quot;&#39;jquery&#39;&quot;</span>
<span class="line">  <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line">jquery</span>
<span class="line"> */</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="_8-asyncqueue" tabindex="-1"><a class="header-anchor" href="#_8-asyncqueue"><span>8.AsyncQueue</span></a></h2><h3 id="_8-1-asyncqueue" tabindex="-1"><a class="header-anchor" href="#_8-1-asyncqueue"><span>8.1 AsyncQueue</span></a></h3><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code class="language-javascript"><span class="line"><span class="token keyword">let</span> AsyncQueue <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&#39;webpack/lib/util/AsyncQueue&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">let</span> AsyncQueue <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&#39;./AsyncQueue&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">function</span> <span class="token function">processor</span><span class="token punctuation">(</span><span class="token parameter">item<span class="token punctuation">,</span> callback</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></span>
<span class="line">        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&#39;process&#39;</span><span class="token punctuation">,</span>item<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token function">callback</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> item<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">3000</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"><span class="token keyword">const</span> <span class="token function-variable function">getKey</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">item</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">return</span> item<span class="token punctuation">.</span>key<span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"><span class="token keyword">let</span> queue  <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">AsyncQueue</span><span class="token punctuation">(</span><span class="token punctuation">{</span></span>
<span class="line">    <span class="token literal-property property">name</span><span class="token operator">:</span><span class="token string">&#39;createModule&#39;</span><span class="token punctuation">,</span><span class="token literal-property property">parallelism</span><span class="token operator">:</span><span class="token number">3</span><span class="token punctuation">,</span>processor<span class="token punctuation">,</span>getKey</span>
<span class="line"><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">const</span> start <span class="token operator">=</span> Date<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">let</span> item1 <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token literal-property property">key</span><span class="token operator">:</span><span class="token string">&#39;module1&#39;</span><span class="token punctuation">}</span><span class="token punctuation">;</span></span>
<span class="line">queue<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>item1<span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token parameter">err<span class="token punctuation">,</span>result</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span></span>
<span class="line">    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>err<span class="token punctuation">,</span>result<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>Date<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> start<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">queue<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>item1<span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token parameter">err<span class="token punctuation">,</span>result</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span></span>
<span class="line">    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>err<span class="token punctuation">,</span>result<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>Date<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> start<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">queue<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token literal-property property">key</span><span class="token operator">:</span><span class="token string">&#39;module2&#39;</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token parameter">err<span class="token punctuation">,</span>result</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span></span>
<span class="line">    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>err<span class="token punctuation">,</span>result<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>Date<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> start<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">queue<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token literal-property property">key</span><span class="token operator">:</span><span class="token string">&#39;module3&#39;</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token parameter">err<span class="token punctuation">,</span>result</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span></span>
<span class="line">    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>err<span class="token punctuation">,</span>result<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>Date<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> start<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">queue<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token literal-property property">key</span><span class="token operator">:</span><span class="token string">&#39;module4&#39;</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token parameter">err<span class="token punctuation">,</span>result</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span></span>
<span class="line">    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>err<span class="token punctuation">,</span>result<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>Date<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> start<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_8-2-use-js" tabindex="-1"><a class="header-anchor" href="#_8-2-use-js"><span>8.2 use.js</span></a></h3><p>use.js</p><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code class="language-javascript"><span class="line"><span class="token keyword">const</span> <span class="token constant">QUEUED_STATE</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token comment">//已经 入队，待执行</span></span>
<span class="line"><span class="token keyword">const</span> <span class="token constant">PROCESSING_STATE</span> <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span><span class="token comment">//处理中</span></span>
<span class="line"><span class="token keyword">const</span> <span class="token constant">DONE_STATE</span> <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span><span class="token comment">//处理完成</span></span>
<span class="line"><span class="token keyword">class</span> <span class="token class-name">ArrayQueue</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">this</span><span class="token punctuation">.</span>_list <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    <span class="token function">enqueue</span><span class="token punctuation">(</span><span class="token parameter">item</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">this</span><span class="token punctuation">.</span>_list<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>item<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//[1,2,3]</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    <span class="token function">dequeue</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_list<span class="token punctuation">.</span><span class="token function">shift</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//移除并返回数组中的第一个元素</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"><span class="token keyword">class</span> <span class="token class-name">AsyncQueueEntry</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter">item<span class="token punctuation">,</span> callback</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">this</span><span class="token punctuation">.</span>item <span class="token operator">=</span> item<span class="token punctuation">;</span><span class="token comment">//任务的描述</span></span>
<span class="line">        <span class="token keyword">this</span><span class="token punctuation">.</span>state <span class="token operator">=</span> <span class="token constant">QUEUED_STATE</span><span class="token punctuation">;</span><span class="token comment">//这个条目当前的状态</span></span>
<span class="line">        <span class="token keyword">this</span><span class="token punctuation">.</span>callback <span class="token operator">=</span> callback<span class="token punctuation">;</span><span class="token comment">//任务完成的回调</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"><span class="token keyword">class</span> <span class="token class-name">AsyncQueue</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> name<span class="token punctuation">,</span> parallelism<span class="token punctuation">,</span> processor<span class="token punctuation">,</span> getKey <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">this</span><span class="token punctuation">.</span>_name <span class="token operator">=</span> name<span class="token punctuation">;</span><span class="token comment">//队列的名字</span></span>
<span class="line">        <span class="token keyword">this</span><span class="token punctuation">.</span>_parallelism <span class="token operator">=</span> parallelism<span class="token punctuation">;</span><span class="token comment">//并发执行的任务数</span></span>
<span class="line">        <span class="token keyword">this</span><span class="token punctuation">.</span>_processor <span class="token operator">=</span> processor<span class="token punctuation">;</span><span class="token comment">//针对队列中的每个条目执行什么操作</span></span>
<span class="line">        <span class="token keyword">this</span><span class="token punctuation">.</span>_getKey <span class="token operator">=</span> getKey<span class="token punctuation">;</span><span class="token comment">//函数，返回一个key用来唯一标识每个元素</span></span>
<span class="line">        <span class="token keyword">this</span><span class="token punctuation">.</span>_entries <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Map</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">this</span><span class="token punctuation">.</span>_queued <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayQueue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//将要执行的任务数组队列 </span></span>
<span class="line">        <span class="token keyword">this</span><span class="token punctuation">.</span>_activeTasks <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token comment">//当前正在执行的数，默认值1</span></span>
<span class="line">        <span class="token keyword">this</span><span class="token punctuation">.</span>_willEnsureProcessing <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span><span class="token comment">//是否将要开始处理</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    <span class="token function-variable function">add</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">item<span class="token punctuation">,</span> callback</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">const</span> key <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">_getKey</span><span class="token punctuation">(</span>item<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//获取这个条目对应的key</span></span>
<span class="line">        <span class="token keyword">const</span> entry <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_entries<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//获取 这个key对应的老的条目</span></span>
<span class="line">        <span class="token keyword">if</span> <span class="token punctuation">(</span>entry <span class="token operator">!==</span> <span class="token keyword">undefined</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token keyword">if</span> <span class="token punctuation">(</span>entry<span class="token punctuation">.</span>state <span class="token operator">===</span> <span class="token constant">DONE_STATE</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">                process<span class="token punctuation">.</span><span class="token function">nextTick</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token function">callback</span><span class="token punctuation">(</span>entry<span class="token punctuation">.</span>error<span class="token punctuation">,</span> entry<span class="token punctuation">.</span>result<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>entry<span class="token punctuation">.</span>callbacks <span class="token operator">===</span> <span class="token keyword">undefined</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">                entry<span class="token punctuation">.</span>callbacks <span class="token operator">=</span> <span class="token punctuation">[</span>callback<span class="token punctuation">]</span><span class="token punctuation">;</span></span>
<span class="line">            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span></span>
<span class="line">                entry<span class="token punctuation">.</span>callbacks<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>callback<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">            <span class="token punctuation">}</span></span>
<span class="line">            <span class="token keyword">return</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">        <span class="token keyword">const</span> newEntry <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">AsyncQueueEntry</span><span class="token punctuation">(</span>item<span class="token punctuation">,</span> callback<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//创建一个新的条目</span></span>
<span class="line">        <span class="token keyword">this</span><span class="token punctuation">.</span>_entries<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> newEntry<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//放到_entries</span></span>
<span class="line">        <span class="token keyword">this</span><span class="token punctuation">.</span>_queued<span class="token punctuation">.</span><span class="token function">enqueue</span><span class="token punctuation">(</span>newEntry<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//把这个新条目放放队列</span></span>
<span class="line">        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>_willEnsureProcessing <span class="token operator">===</span> <span class="token boolean">false</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token keyword">this</span><span class="token punctuation">.</span>_willEnsureProcessing <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span></span>
<span class="line">            <span class="token function">setImmediate</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>_ensureProcessing<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    <span class="token function-variable function">_ensureProcessing</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token comment">//如果当前的激活的或者 说正在执行任务数行小于并发数</span></span>
<span class="line">        <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>_activeTasks <span class="token operator">&lt;</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_parallelism<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token keyword">const</span> entry <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_queued<span class="token punctuation">.</span><span class="token function">dequeue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//出队 先入先出</span></span>
<span class="line">            <span class="token keyword">if</span> <span class="token punctuation">(</span>entry <span class="token operator">===</span> <span class="token keyword">undefined</span><span class="token punctuation">)</span> <span class="token keyword">break</span><span class="token punctuation">;</span></span>
<span class="line">            <span class="token keyword">this</span><span class="token punctuation">.</span>_activeTasks<span class="token operator">++</span><span class="token punctuation">;</span><span class="token comment">//先让正在执行的任务数++</span></span>
<span class="line">            entry<span class="token punctuation">.</span>state <span class="token operator">=</span> <span class="token constant">PROCESSING_STATE</span><span class="token punctuation">;</span><span class="token comment">//条目的状态设置为执行中</span></span>
<span class="line">            <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">_startProcessing</span><span class="token punctuation">(</span>entry<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">        <span class="token keyword">this</span><span class="token punctuation">.</span>_willEnsureProcessing <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    <span class="token function-variable function">_startProcessing</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">entry</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">_processor</span><span class="token punctuation">(</span>entry<span class="token punctuation">.</span>item<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">e<span class="token punctuation">,</span> r</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">_handleResult</span><span class="token punctuation">(</span>entry<span class="token punctuation">,</span> e<span class="token punctuation">,</span> r<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    <span class="token function-variable function">_handleResult</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">entry<span class="token punctuation">,</span> error<span class="token punctuation">,</span> result</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">const</span> callback <span class="token operator">=</span> entry<span class="token punctuation">.</span>callback<span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">const</span> callbacks <span class="token operator">=</span> entry<span class="token punctuation">.</span>callbacks<span class="token punctuation">;</span></span>
<span class="line">        entry<span class="token punctuation">.</span>state <span class="token operator">=</span> <span class="token constant">DONE_STATE</span><span class="token punctuation">;</span><span class="token comment">//把条目的状态设置为已经完成</span></span>
<span class="line">        entry<span class="token punctuation">.</span>callback <span class="token operator">=</span> <span class="token keyword">undefined</span><span class="token punctuation">;</span><span class="token comment">//把callback</span></span>
<span class="line">        entry<span class="token punctuation">.</span>callbacks <span class="token operator">=</span> <span class="token keyword">undefined</span><span class="token punctuation">;</span></span>
<span class="line">        entry<span class="token punctuation">.</span>result <span class="token operator">=</span> result<span class="token punctuation">;</span><span class="token comment">//把结果赋给entry</span></span>
<span class="line">        entry<span class="token punctuation">.</span>error <span class="token operator">=</span> error<span class="token punctuation">;</span><span class="token comment">//把错误对象赋给entry</span></span>
<span class="line">        <span class="token function">callback</span><span class="token punctuation">(</span>error<span class="token punctuation">,</span> result<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">if</span> <span class="token punctuation">(</span>callbacks <span class="token operator">!==</span> <span class="token keyword">undefined</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> callback <span class="token keyword">of</span> callbacks<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">                <span class="token function">callback</span><span class="token punctuation">(</span>error<span class="token punctuation">,</span> result<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">            <span class="token punctuation">}</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">        <span class="token keyword">this</span><span class="token punctuation">.</span>_activeTasks<span class="token operator">--</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>_willEnsureProcessing <span class="token operator">===</span> <span class="token boolean">false</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token keyword">this</span><span class="token punctuation">.</span>_willEnsureProcessing <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span></span>
<span class="line">            <span class="token function">setImmediate</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>_ensureProcessing<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line">module<span class="token punctuation">.</span>exports <span class="token operator">=</span> AsyncQueue<span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="_9-参考" tabindex="-1"><a class="header-anchor" href="#_9-参考"><span>9. 参考</span></a></h2><ul><li><a href="https://developer.qiniu.com/kodo/sdk/1289/nodejs" target="_blank" rel="noopener noreferrer">Node.js SDK</a></li><li><a href="https://webpack.js.org/contribute/writing-a-plugin/" target="_blank" rel="noopener noreferrer">writing-a-plugin</a></li><li><a href="https://webpack.js.org/api/plugins/" target="_blank" rel="noopener noreferrer">api/plugins</a></li></ul><h3 id="_9-1-钩子集合" tabindex="-1"><a class="header-anchor" href="#_9-1-钩子集合"><span>9.1 钩子集合</span></a></h3><ul><li><a href="https://www.npmjs.com/package/wepback-plugin-visualizer" target="_blank" rel="noopener noreferrer">wepback-plugin-visualizer</a></li></ul><h4 id="_9-1-1-收集" tabindex="-1"><a class="header-anchor" href="#_9-1-1-收集"><span>9.1.1 收集</span></a></h4><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code class="language-javascript"><span class="line">        Object<span class="token punctuation">.</span><span class="token function">keys</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>hooks<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">hookName</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token keyword">const</span> hook <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>hooks<span class="token punctuation">[</span>hookName<span class="token punctuation">]</span><span class="token punctuation">;</span></span>
<span class="line">            <span class="token keyword">if</span> <span class="token punctuation">(</span>hook <span class="token keyword">instanceof</span> <span class="token class-name">HookMap</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">                <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> key <span class="token keyword">of</span> hook<span class="token punctuation">.</span>_map<span class="token punctuation">.</span><span class="token function">keys</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">                    hook<span class="token punctuation">.</span><span class="token function">for</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">tap</span><span class="token punctuation">(</span><span class="token string">&#39;flow&#39;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></span>
<span class="line">                        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">\`</span><span class="token string">|JavascriptParser|</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">\${</span>hookName<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">|</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">\${</span>hook<span class="token punctuation">.</span><span class="token function">for</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">.</span>constructor<span class="token punctuation">.</span>name<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">|</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">\${</span>hook<span class="token punctuation">.</span>_args<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">|</span><span class="token template-punctuation string">\`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">                    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">                <span class="token punctuation">}</span></span>
<span class="line">            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span></span>
<span class="line">                hook<span class="token punctuation">.</span><span class="token function">tap</span><span class="token punctuation">(</span><span class="token string">&#39;flow&#39;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></span>
<span class="line">                    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">\`</span><span class="token string">|JavascriptParser|</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">\${</span>hookName<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">|</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">\${</span>hook<span class="token punctuation">.</span>constructor<span class="token punctuation">.</span>name<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">|</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">\${</span>hook<span class="token punctuation">.</span>_args<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">|</span><span class="token template-punctuation string">\`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">                <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">            <span class="token punctuation">}</span></span>
<span class="line">        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_9-1-2-触发时机" tabindex="-1"><a class="header-anchor" href="#_9-1-2-触发时机"><span>9.1.2 触发时机</span></a></h4><ul><li>[hooks](https://webpack.docschina.org/api/compiler-hooks/</li></ul><table><thead><tr><th style="text-align:left;">对象</th><th style="text-align:left;">钩子名称</th><th style="text-align:left;">类型</th><th style="text-align:left;">参数</th><th style="text-align:left;">含义</th></tr></thead><tbody><tr><td style="text-align:left;">Compiler</td><td style="text-align:left;">environment</td><td style="text-align:left;">SyncHook</td><td style="text-align:left;"></td><td style="text-align:left;">在编译器准备环境时调用，时机就在配置文件中初始化插件之后</td></tr><tr><td style="text-align:left;">Compiler</td><td style="text-align:left;">afterEnvironment</td><td style="text-align:left;">SyncHook</td><td style="text-align:left;"></td><td style="text-align:left;"></td></tr><tr><td style="text-align:left;">Compiler</td><td style="text-align:left;">entryOption</td><td style="text-align:left;">SyncBailHook</td><td style="text-align:left;">context,entry</td><td style="text-align:left;"></td></tr><tr><td style="text-align:left;">Compiler</td><td style="text-align:left;">afterPlugins</td><td style="text-align:left;">SyncHook</td><td style="text-align:left;">compiler</td><td style="text-align:left;"></td></tr><tr><td style="text-align:left;">Compiler</td><td style="text-align:left;">afterResolvers</td><td style="text-align:left;">SyncHook</td><td style="text-align:left;">compiler</td><td style="text-align:left;"></td></tr><tr><td style="text-align:left;">Compiler</td><td style="text-align:left;">initialize</td><td style="text-align:left;">SyncHook</td><td style="text-align:left;"></td><td style="text-align:left;"></td></tr><tr><td style="text-align:left;">Compiler</td><td style="text-align:left;">beforeRun</td><td style="text-align:left;">AsyncSeriesHook</td><td style="text-align:left;">compiler</td><td style="text-align:left;"></td></tr><tr><td style="text-align:left;">Compiler</td><td style="text-align:left;">run</td><td style="text-align:left;">AsyncSeriesHook</td><td style="text-align:left;">compiler</td><td style="text-align:left;"></td></tr><tr><td style="text-align:left;">Compiler</td><td style="text-align:left;">infrastructureLog</td><td style="text-align:left;">SyncBailHook</td><td style="text-align:left;">origin,type,args</td><td style="text-align:left;"></td></tr><tr><td style="text-align:left;">Compiler</td><td style="text-align:left;">readRecords</td><td style="text-align:left;">AsyncSeriesHook</td><td style="text-align:left;"></td><td style="text-align:left;"></td></tr><tr><td style="text-align:left;">Compiler</td><td style="text-align:left;">normalModuleFactory</td><td style="text-align:left;">SyncHook</td><td style="text-align:left;">normalModuleFactory</td><td style="text-align:left;"></td></tr><tr><td style="text-align:left;">Compiler</td><td style="text-align:left;">contextModuleFactory</td><td style="text-align:left;">SyncHook</td><td style="text-align:left;">contextModuleFactory</td><td style="text-align:left;"></td></tr><tr><td style="text-align:left;">Compiler</td><td style="text-align:left;">beforeCompile</td><td style="text-align:left;">AsyncSeriesHook</td><td style="text-align:left;">params</td><td style="text-align:left;"></td></tr><tr><td style="text-align:left;">Compiler</td><td style="text-align:left;">compile</td><td style="text-align:left;">SyncHook</td><td style="text-align:left;">params</td><td style="text-align:left;"></td></tr><tr><td style="text-align:left;">Compiler</td><td style="text-align:left;">thisCompilation</td><td style="text-align:left;">SyncHook</td><td style="text-align:left;">compilation,params</td><td style="text-align:left;"></td></tr><tr><td style="text-align:left;">Compiler</td><td style="text-align:left;">compilation</td><td style="text-align:left;">SyncHook</td><td style="text-align:left;">compilation,params</td><td style="text-align:left;"></td></tr><tr><td style="text-align:left;">Compiler</td><td style="text-align:left;">make</td><td style="text-align:left;">AsyncParallelHook</td><td style="text-align:left;">compilation</td><td style="text-align:left;"></td></tr><tr><td style="text-align:left;">Compilation</td><td style="text-align:left;">addEntry</td><td style="text-align:left;">SyncHook</td><td style="text-align:left;">entry,options</td><td style="text-align:left;"></td></tr><tr><td style="text-align:left;">NormalModuleFactory</td><td style="text-align:left;">beforeResolve</td><td style="text-align:left;">AsyncSeriesBailHook</td><td style="text-align:left;">resolveData</td><td style="text-align:left;"></td></tr><tr><td style="text-align:left;">NormalModuleFactory</td><td style="text-align:left;">factorize</td><td style="text-align:left;">AsyncSeriesBailHook</td><td style="text-align:left;">resolveData</td><td style="text-align:left;"></td></tr><tr><td style="text-align:left;">NormalModuleFactory</td><td style="text-align:left;">resolve</td><td style="text-align:left;">AsyncSeriesBailHook</td><td style="text-align:left;">resolveData</td><td style="text-align:left;"></td></tr><tr><td style="text-align:left;">NormalModuleFactory</td><td style="text-align:left;">afterResolve</td><td style="text-align:left;">AsyncSeriesBailHook</td><td style="text-align:left;">resolveData</td><td style="text-align:left;"></td></tr><tr><td style="text-align:left;">NormalModuleFactory</td><td style="text-align:left;">createModule</td><td style="text-align:left;">AsyncSeriesBailHook</td><td style="text-align:left;">createData,resolveData</td><td style="text-align:left;"></td></tr><tr><td style="text-align:left;">NormalModuleFactory</td><td style="text-align:left;">module</td><td style="text-align:left;">SyncWaterfallHook</td><td style="text-align:left;">module,createData,resolveData</td><td style="text-align:left;"></td></tr><tr><td style="text-align:left;">Compilation</td><td style="text-align:left;">buildModule</td><td style="text-align:left;">SyncHook</td><td style="text-align:left;">module</td><td style="text-align:left;"></td></tr><tr><td style="text-align:left;">Compilation</td><td style="text-align:left;">normalModuleLoader</td><td style="text-align:left;">SyncHook</td><td style="text-align:left;">loaderContext,module</td><td style="text-align:left;"></td></tr><tr><td style="text-align:left;">JavascriptParser</td><td style="text-align:left;">program</td><td style="text-align:left;">SyncBailHook</td><td style="text-align:left;">ast,comments</td><td style="text-align:left;"></td></tr><tr><td style="text-align:left;">JavascriptParser</td><td style="text-align:left;">preStatement</td><td style="text-align:left;">SyncBailHook</td><td style="text-align:left;">statement</td><td style="text-align:left;"></td></tr><tr><td style="text-align:left;">JavascriptParser</td><td style="text-align:left;">preStatement</td><td style="text-align:left;">SyncBailHook</td><td style="text-align:left;">statement</td><td style="text-align:left;"></td></tr><tr><td style="text-align:left;">JavascriptParser</td><td style="text-align:left;">blockPreStatement</td><td style="text-align:left;">SyncBailHook</td><td style="text-align:left;">declaration</td><td style="text-align:left;"></td></tr><tr><td style="text-align:left;">JavascriptParser</td><td style="text-align:left;">preDeclarator</td><td style="text-align:left;">SyncBailHook</td><td style="text-align:left;">declarator,statement</td><td style="text-align:left;"></td></tr><tr><td style="text-align:left;">JavascriptParser</td><td style="text-align:left;">blockPreStatement</td><td style="text-align:left;">SyncBailHook</td><td style="text-align:left;">declaration</td><td style="text-align:left;"></td></tr><tr><td style="text-align:left;">JavascriptParser</td><td style="text-align:left;">statement</td><td style="text-align:left;">SyncBailHook</td><td style="text-align:left;">statement</td><td style="text-align:left;"></td></tr><tr><td style="text-align:left;">JavascriptParser</td><td style="text-align:left;">declarator</td><td style="text-align:left;">SyncBailHook</td><td style="text-align:left;">declarator,statement</td><td style="text-align:left;"></td></tr><tr><td style="text-align:left;">JavascriptParser</td><td style="text-align:left;">statement</td><td style="text-align:left;">SyncBailHook</td><td style="text-align:left;">statement</td><td style="text-align:left;"></td></tr><tr><td style="text-align:left;">JavascriptParser</td><td style="text-align:left;">finish</td><td style="text-align:left;">SyncBailHook</td><td style="text-align:left;">ast,comments</td><td style="text-align:left;"></td></tr><tr><td style="text-align:left;">Compilation</td><td style="text-align:left;">succeedModule</td><td style="text-align:left;">SyncHook</td><td style="text-align:left;">module</td><td style="text-align:left;"></td></tr><tr><td style="text-align:left;">NormalModuleFactory</td><td style="text-align:left;">beforeResolve</td><td style="text-align:left;">AsyncSeriesBailHook</td><td style="text-align:left;">resolveData</td><td style="text-align:left;"></td></tr><tr><td style="text-align:left;">NormalModuleFactory</td><td style="text-align:left;">factorize</td><td style="text-align:left;">AsyncSeriesBailHook</td><td style="text-align:left;">resolveData</td><td style="text-align:left;"></td></tr><tr><td style="text-align:left;">NormalModuleFactory</td><td style="text-align:left;">resolve</td><td style="text-align:left;">AsyncSeriesBailHook</td><td style="text-align:left;">resolveData</td><td style="text-align:left;"></td></tr><tr><td style="text-align:left;">NormalModuleFactory</td><td style="text-align:left;">afterResolve</td><td style="text-align:left;">AsyncSeriesBailHook</td><td style="text-align:left;">resolveData</td><td style="text-align:left;"></td></tr><tr><td style="text-align:left;">NormalModuleFactory</td><td style="text-align:left;">createModule</td><td style="text-align:left;">AsyncSeriesBailHook</td><td style="text-align:left;">createData,resolveData</td><td style="text-align:left;"></td></tr><tr><td style="text-align:left;">NormalModuleFactory</td><td style="text-align:left;">module</td><td style="text-align:left;">SyncWaterfallHook</td><td style="text-align:left;">module,createData,resolveData</td><td style="text-align:left;"></td></tr><tr><td style="text-align:left;">Compilation</td><td style="text-align:left;">buildModule</td><td style="text-align:left;">SyncHook</td><td style="text-align:left;">module</td><td style="text-align:left;"></td></tr><tr><td style="text-align:left;">Compilation</td><td style="text-align:left;">normalModuleLoader</td><td style="text-align:left;">SyncHook</td><td style="text-align:left;">loaderContext,module</td><td style="text-align:left;"></td></tr><tr><td style="text-align:left;">JavascriptParser</td><td style="text-align:left;">program</td><td style="text-align:left;">SyncBailHook</td><td style="text-align:left;">ast,comments</td><td style="text-align:left;"></td></tr><tr><td style="text-align:left;">JavascriptParser</td><td style="text-align:left;">preStatement</td><td style="text-align:left;">SyncBailHook</td><td style="text-align:left;">statement</td><td style="text-align:left;"></td></tr><tr><td style="text-align:left;">JavascriptParser</td><td style="text-align:left;">blockPreStatement</td><td style="text-align:left;">SyncBailHook</td><td style="text-align:left;">declaration</td><td style="text-align:left;"></td></tr><tr><td style="text-align:left;">JavascriptParser</td><td style="text-align:left;">statement</td><td style="text-align:left;">SyncBailHook</td><td style="text-align:left;">statement</td><td style="text-align:left;"></td></tr><tr><td style="text-align:left;">JavascriptParser</td><td style="text-align:left;">finish</td><td style="text-align:left;">SyncBailHook</td><td style="text-align:left;">ast,comments</td><td style="text-align:left;"></td></tr><tr><td style="text-align:left;">Compilation</td><td style="text-align:left;">succeedModule</td><td style="text-align:left;">SyncHook</td><td style="text-align:left;">module</td><td style="text-align:left;"></td></tr><tr><td style="text-align:left;">Compilation</td><td style="text-align:left;">succeedEntry</td><td style="text-align:left;">SyncHook</td><td style="text-align:left;">entry,options,module</td><td style="text-align:left;"></td></tr><tr><td style="text-align:left;">Compilation</td><td style="text-align:left;">log</td><td style="text-align:left;">SyncBailHook</td><td style="text-align:left;">origin,logEntry</td><td style="text-align:left;"></td></tr><tr><td style="text-align:left;">Compiler</td><td style="text-align:left;">finishMake</td><td style="text-align:left;">AsyncSeriesHook</td><td style="text-align:left;">compilation</td><td style="text-align:left;"></td></tr><tr><td style="text-align:left;">Compilation</td><td style="text-align:left;">log</td><td style="text-align:left;">SyncBailHook</td><td style="text-align:left;">origin,logEntry</td><td style="text-align:left;"></td></tr><tr><td style="text-align:left;">Compilation</td><td style="text-align:left;">log</td><td style="text-align:left;">SyncBailHook</td><td style="text-align:left;">origin,logEntry</td><td style="text-align:left;"></td></tr><tr><td style="text-align:left;">Compilation</td><td style="text-align:left;">finishModules</td><td style="text-align:left;">AsyncSeriesHook</td><td style="text-align:left;">modules</td><td style="text-align:left;"></td></tr><tr><td style="text-align:left;">Compilation</td><td style="text-align:left;">log</td><td style="text-align:left;">SyncBailHook</td><td style="text-align:left;">origin,logEntry</td><td style="text-align:left;"></td></tr><tr><td style="text-align:left;">Compilation</td><td style="text-align:left;">log</td><td style="text-align:left;">SyncBailHook</td><td style="text-align:left;">origin,logEntry</td><td style="text-align:left;"></td></tr><tr><td style="text-align:left;">Compilation</td><td style="text-align:left;">log</td><td style="text-align:left;">SyncBailHook</td><td style="text-align:left;">origin,logEntry</td><td style="text-align:left;"></td></tr><tr><td style="text-align:left;">Compilation</td><td style="text-align:left;">log</td><td style="text-align:left;">SyncBailHook</td><td style="text-align:left;">origin,logEntry</td><td style="text-align:left;"></td></tr><tr><td style="text-align:left;">Compilation</td><td style="text-align:left;">log</td><td style="text-align:left;">SyncBailHook</td><td style="text-align:left;">origin,logEntry</td><td style="text-align:left;"></td></tr><tr><td style="text-align:left;">Compilation</td><td style="text-align:left;">log</td><td style="text-align:left;">SyncBailHook</td><td style="text-align:left;">origin,logEntry</td><td style="text-align:left;"></td></tr><tr><td style="text-align:left;">Compilation</td><td style="text-align:left;">log</td><td style="text-align:left;">SyncBailHook</td><td style="text-align:left;">origin,logEntry</td><td style="text-align:left;"></td></tr><tr><td style="text-align:left;">Compilation</td><td style="text-align:left;">log</td><td style="text-align:left;">SyncBailHook</td><td style="text-align:left;">origin,logEntry</td><td style="text-align:left;"></td></tr><tr><td style="text-align:left;">Compilation</td><td style="text-align:left;">seal</td><td style="text-align:left;">SyncHook</td><td style="text-align:left;"></td><td style="text-align:left;"></td></tr><tr><td style="text-align:left;">Compilation</td><td style="text-align:left;">optimizeDependencies</td><td style="text-align:left;">SyncBailHook</td><td style="text-align:left;">modules</td><td style="text-align:left;"></td></tr><tr><td style="text-align:left;">Compilation</td><td style="text-align:left;">log</td><td style="text-align:left;">SyncBailHook</td><td style="text-align:left;">origin,logEntry</td><td style="text-align:left;"></td></tr><tr><td style="text-align:left;">Compilation</td><td style="text-align:left;">afterOptimizeDependencies</td><td style="text-align:left;">SyncHook</td><td style="text-align:left;">modules</td><td style="text-align:left;"></td></tr><tr><td style="text-align:left;">Compilation</td><td style="text-align:left;">log</td><td style="text-align:left;">SyncBailHook</td><td style="text-align:left;">origin,logEntry</td><td style="text-align:left;"></td></tr><tr><td style="text-align:left;">Compilation</td><td style="text-align:left;">beforeChunks</td><td style="text-align:left;">SyncHook</td><td style="text-align:left;"></td><td style="text-align:left;"></td></tr><tr><td style="text-align:left;">Compilation</td><td style="text-align:left;">log</td><td style="text-align:left;">SyncBailHook</td><td style="text-align:left;">origin,logEntry</td><td style="text-align:left;"></td></tr><tr><td style="text-align:left;">Compilation</td><td style="text-align:left;">log</td><td style="text-align:left;">SyncBailHook</td><td style="text-align:left;">origin,logEntry</td><td style="text-align:left;"></td></tr><tr><td style="text-align:left;">Compilation</td><td style="text-align:left;">log</td><td style="text-align:left;">SyncBailHook</td><td style="text-align:left;">origin,logEntry</td><td style="text-align:left;"></td></tr><tr><td style="text-align:left;">Compilation</td><td style="text-align:left;">log</td><td style="text-align:left;">SyncBailHook</td><td style="text-align:left;">origin,logEntry</td><td style="text-align:left;"></td></tr><tr><td style="text-align:left;">Compilation</td><td style="text-align:left;">log</td><td style="text-align:left;">SyncBailHook</td><td style="text-align:left;">origin,logEntry</td><td style="text-align:left;"></td></tr><tr><td style="text-align:left;">Compilation</td><td style="text-align:left;">log</td><td style="text-align:left;">SyncBailHook</td><td style="text-align:left;">origin,logEntry</td><td style="text-align:left;"></td></tr><tr><td style="text-align:left;">Compilation</td><td style="text-align:left;">log</td><td style="text-align:left;">SyncBailHook</td><td style="text-align:left;">origin,logEntry</td><td style="text-align:left;"></td></tr><tr><td style="text-align:left;">Compilation</td><td style="text-align:left;">log</td><td style="text-align:left;">SyncBailHook</td><td style="text-align:left;">origin,logEntry</td><td style="text-align:left;"></td></tr><tr><td style="text-align:left;">Compilation</td><td style="text-align:left;">log</td><td style="text-align:left;">SyncBailHook</td><td style="text-align:left;">origin,logEntry</td><td style="text-align:left;"></td></tr><tr><td style="text-align:left;">Compilation</td><td style="text-align:left;">afterChunks</td><td style="text-align:left;">SyncHook</td><td style="text-align:left;">chunks</td><td style="text-align:left;"></td></tr><tr><td style="text-align:left;">Compilation</td><td style="text-align:left;">log</td><td style="text-align:left;">SyncBailHook</td><td style="text-align:left;">origin,logEntry</td><td style="text-align:left;"></td></tr><tr><td style="text-align:left;">Compilation</td><td style="text-align:left;">optimize</td><td style="text-align:left;">SyncHook</td><td style="text-align:left;"></td><td style="text-align:left;"></td></tr><tr><td style="text-align:left;">Compilation</td><td style="text-align:left;">optimizeModules</td><td style="text-align:left;">SyncBailHook</td><td style="text-align:left;">modules</td><td style="text-align:left;"></td></tr><tr><td style="text-align:left;">Compilation</td><td style="text-align:left;">afterOptimizeModules</td><td style="text-align:left;">SyncHook</td><td style="text-align:left;">modules</td><td style="text-align:left;"></td></tr><tr><td style="text-align:left;">Compilation</td><td style="text-align:left;">optimizeChunks</td><td style="text-align:left;">SyncBailHook</td><td style="text-align:left;">chunks,chunkGroups</td><td style="text-align:left;"></td></tr><tr><td style="text-align:left;">Compilation</td><td style="text-align:left;">log</td><td style="text-align:left;">SyncBailHook</td><td style="text-align:left;">origin,logEntry</td><td style="text-align:left;"></td></tr><tr><td style="text-align:left;">Compilation</td><td style="text-align:left;">log</td><td style="text-align:left;">SyncBailHook</td><td style="text-align:left;">origin,logEntry</td><td style="text-align:left;"></td></tr><tr><td style="text-align:left;">Compilation</td><td style="text-align:left;">log</td><td style="text-align:left;">SyncBailHook</td><td style="text-align:left;">origin,logEntry</td><td style="text-align:left;"></td></tr><tr><td style="text-align:left;">Compilation</td><td style="text-align:left;">log</td><td style="text-align:left;">SyncBailHook</td><td style="text-align:left;">origin,logEntry</td><td style="text-align:left;"></td></tr><tr><td style="text-align:left;">Compilation</td><td style="text-align:left;">afterOptimizeChunks</td><td style="text-align:left;">SyncHook</td><td style="text-align:left;">chunks,chunkGroups</td><td style="text-align:left;"></td></tr><tr><td style="text-align:left;">Compilation</td><td style="text-align:left;">optimizeTree</td><td style="text-align:left;">AsyncSeriesHook</td><td style="text-align:left;">chunks,modules</td><td style="text-align:left;"></td></tr><tr><td style="text-align:left;">Compilation</td><td style="text-align:left;">afterOptimizeTree</td><td style="text-align:left;">SyncHook</td><td style="text-align:left;">chunks,modules</td><td style="text-align:left;"></td></tr><tr><td style="text-align:left;">Compilation</td><td style="text-align:left;">optimizeChunkModules</td><td style="text-align:left;">AsyncSeriesBailHook</td><td style="text-align:left;">chunks,modules</td><td style="text-align:left;"></td></tr><tr><td style="text-align:left;">Compilation</td><td style="text-align:left;">afterOptimizeChunkModules</td><td style="text-align:left;">SyncHook</td><td style="text-align:left;">chunks,modules</td><td style="text-align:left;"></td></tr><tr><td style="text-align:left;">Compilation</td><td style="text-align:left;">shouldRecord</td><td style="text-align:left;">SyncBailHook</td><td style="text-align:left;"></td><td style="text-align:left;"></td></tr><tr><td style="text-align:left;">Compilation</td><td style="text-align:left;">reviveModules</td><td style="text-align:left;">SyncHook</td><td style="text-align:left;">modules,records</td><td style="text-align:left;"></td></tr><tr><td style="text-align:left;">Compilation</td><td style="text-align:left;">beforeModuleIds</td><td style="text-align:left;">SyncHook</td><td style="text-align:left;">modules</td><td style="text-align:left;"></td></tr><tr><td style="text-align:left;">Compilation</td><td style="text-align:left;">moduleIds</td><td style="text-align:left;">SyncHook</td><td style="text-align:left;">modules</td><td style="text-align:left;"></td></tr><tr><td style="text-align:left;">Compilation</td><td style="text-align:left;">optimizeModuleIds</td><td style="text-align:left;">SyncHook</td><td style="text-align:left;">modules</td><td style="text-align:left;"></td></tr><tr><td style="text-align:left;">Compilation</td><td style="text-align:left;">afterOptimizeModuleIds</td><td style="text-align:left;">SyncHook</td><td style="text-align:left;">modules</td><td style="text-align:left;"></td></tr><tr><td style="text-align:left;">Compilation</td><td style="text-align:left;">reviveChunks</td><td style="text-align:left;">SyncHook</td><td style="text-align:left;">chunks,records</td><td style="text-align:left;"></td></tr><tr><td style="text-align:left;">Compilation</td><td style="text-align:left;">beforeChunkIds</td><td style="text-align:left;">SyncHook</td><td style="text-align:left;">chunks</td><td style="text-align:left;"></td></tr><tr><td style="text-align:left;">Compilation</td><td style="text-align:left;">chunkIds</td><td style="text-align:left;">SyncHook</td><td style="text-align:left;">chunks</td><td style="text-align:left;"></td></tr><tr><td style="text-align:left;">Compilation</td><td style="text-align:left;">optimizeChunkIds</td><td style="text-align:left;">SyncHook</td><td style="text-align:left;">chunks</td><td style="text-align:left;"></td></tr><tr><td style="text-align:left;">Compilation</td><td style="text-align:left;">afterOptimizeChunkIds</td><td style="text-align:left;">SyncHook</td><td style="text-align:left;">chunks</td><td style="text-align:left;"></td></tr><tr><td style="text-align:left;">Compilation</td><td style="text-align:left;">log</td><td style="text-align:left;">SyncBailHook</td><td style="text-align:left;">origin,logEntry</td><td style="text-align:left;"></td></tr><tr><td style="text-align:left;">Compilation</td><td style="text-align:left;">recordModules</td><td style="text-align:left;">SyncHook</td><td style="text-align:left;">modules,records</td><td style="text-align:left;"></td></tr><tr><td style="text-align:left;">Compilation</td><td style="text-align:left;">recordChunks</td><td style="text-align:left;">SyncHook</td><td style="text-align:left;">chunks,records</td><td style="text-align:left;"></td></tr><tr><td style="text-align:left;">Compilation</td><td style="text-align:left;">optimizeCodeGeneration</td><td style="text-align:left;">SyncHook</td><td style="text-align:left;">modules</td><td style="text-align:left;"></td></tr><tr><td style="text-align:left;">Compilation</td><td style="text-align:left;">log</td><td style="text-align:left;">SyncBailHook</td><td style="text-align:left;">origin,logEntry</td><td style="text-align:left;"></td></tr><tr><td style="text-align:left;">Compilation</td><td style="text-align:left;">beforeModuleHash</td><td style="text-align:left;">SyncHook</td><td style="text-align:left;"></td><td style="text-align:left;"></td></tr><tr><td style="text-align:left;">Compilation</td><td style="text-align:left;">log</td><td style="text-align:left;">SyncBailHook</td><td style="text-align:left;">origin,logEntry</td><td style="text-align:left;"></td></tr><tr><td style="text-align:left;">Compilation</td><td style="text-align:left;">afterModuleHash</td><td style="text-align:left;">SyncHook</td><td style="text-align:left;"></td><td style="text-align:left;"></td></tr><tr><td style="text-align:left;">Compilation</td><td style="text-align:left;">log</td><td style="text-align:left;">SyncBailHook</td><td style="text-align:left;">origin,logEntry</td><td style="text-align:left;"></td></tr><tr><td style="text-align:left;">Compilation</td><td style="text-align:left;">beforeCodeGeneration</td><td style="text-align:left;">SyncHook</td><td style="text-align:left;"></td><td style="text-align:left;"></td></tr><tr><td style="text-align:left;">Compilation</td><td style="text-align:left;">log</td><td style="text-align:left;">SyncBailHook</td><td style="text-align:left;">origin,logEntry</td><td style="text-align:left;"></td></tr><tr><td style="text-align:left;">Compilation</td><td style="text-align:left;">afterCodeGeneration</td><td style="text-align:left;">SyncHook</td><td style="text-align:left;"></td><td style="text-align:left;"></td></tr><tr><td style="text-align:left;">Compilation</td><td style="text-align:left;">log</td><td style="text-align:left;">SyncBailHook</td><td style="text-align:left;">origin,logEntry</td><td style="text-align:left;"></td></tr><tr><td style="text-align:left;">Compilation</td><td style="text-align:left;">beforeRuntimeRequirements</td><td style="text-align:left;">SyncHook</td><td style="text-align:left;"></td><td style="text-align:left;"></td></tr><tr><td style="text-align:left;">Compilation</td><td style="text-align:left;">additionalModuleRuntimeRequirements</td><td style="text-align:left;">SyncHook</td><td style="text-align:left;">module,runtimeRequirements,context</td><td style="text-align:left;"></td></tr><tr><td style="text-align:left;">Compilation</td><td style="text-align:left;">additionalModuleRuntimeRequirements</td><td style="text-align:left;">SyncHook</td><td style="text-align:left;">module,runtimeRequirements,context</td><td style="text-align:left;"></td></tr><tr><td style="text-align:left;">Compilation</td><td style="text-align:left;">log</td><td style="text-align:left;">SyncBailHook</td><td style="text-align:left;">origin,logEntry</td><td style="text-align:left;"></td></tr><tr><td style="text-align:left;">Compilation</td><td style="text-align:left;">additionalChunkRuntimeRequirements</td><td style="text-align:left;">SyncHook</td><td style="text-align:left;">chunk,runtimeRequirements,context</td><td style="text-align:left;"></td></tr><tr><td style="text-align:left;">Compilation</td><td style="text-align:left;">log</td><td style="text-align:left;">SyncBailHook</td><td style="text-align:left;">origin,logEntry</td><td style="text-align:left;"></td></tr><tr><td style="text-align:left;">Compilation</td><td style="text-align:left;">additionalTreeRuntimeRequirements</td><td style="text-align:left;">SyncHook</td><td style="text-align:left;">chunk,runtimeRequirements,context</td><td style="text-align:left;"></td></tr><tr><td style="text-align:left;">Compilation</td><td style="text-align:left;">log</td><td style="text-align:left;">SyncBailHook</td><td style="text-align:left;">origin,logEntry</td><td style="text-align:left;"></td></tr><tr><td style="text-align:left;">Compilation</td><td style="text-align:left;">afterRuntimeRequirements</td><td style="text-align:left;">SyncHook</td><td style="text-align:left;"></td><td style="text-align:left;"></td></tr><tr><td style="text-align:left;">Compilation</td><td style="text-align:left;">log</td><td style="text-align:left;">SyncBailHook</td><td style="text-align:left;">origin,logEntry</td><td style="text-align:left;"></td></tr><tr><td style="text-align:left;">Compilation</td><td style="text-align:left;">beforeHash</td><td style="text-align:left;">SyncHook</td><td style="text-align:left;"></td><td style="text-align:left;"></td></tr><tr><td style="text-align:left;">Compilation</td><td style="text-align:left;">log</td><td style="text-align:left;">SyncBailHook</td><td style="text-align:left;">origin,logEntry</td><td style="text-align:left;"></td></tr><tr><td style="text-align:left;">Compilation</td><td style="text-align:left;">log</td><td style="text-align:left;">SyncBailHook</td><td style="text-align:left;">origin,logEntry</td><td style="text-align:left;"></td></tr><tr><td style="text-align:left;">Compilation</td><td style="text-align:left;">chunkHash</td><td style="text-align:left;">SyncHook</td><td style="text-align:left;">chunk,chunkHash,ChunkHashContext</td><td style="text-align:left;"></td></tr><tr><td style="text-align:left;">Compilation</td><td style="text-align:left;">contentHash</td><td style="text-align:left;">SyncHook</td><td style="text-align:left;">chunk</td><td style="text-align:left;"></td></tr><tr><td style="text-align:left;">Compilation</td><td style="text-align:left;">log</td><td style="text-align:left;">SyncBailHook</td><td style="text-align:left;">origin,logEntry</td><td style="text-align:left;"></td></tr><tr><td style="text-align:left;">Compilation</td><td style="text-align:left;">log</td><td style="text-align:left;">SyncBailHook</td><td style="text-align:left;">origin,logEntry</td><td style="text-align:left;"></td></tr><tr><td style="text-align:left;">Compilation</td><td style="text-align:left;">fullHash</td><td style="text-align:left;">SyncHook</td><td style="text-align:left;">hash</td><td style="text-align:left;"></td></tr><tr><td style="text-align:left;">Compilation</td><td style="text-align:left;">log</td><td style="text-align:left;">SyncBailHook</td><td style="text-align:left;">origin,logEntry</td><td style="text-align:left;"></td></tr><tr><td style="text-align:left;">Compilation</td><td style="text-align:left;">log</td><td style="text-align:left;">SyncBailHook</td><td style="text-align:left;">origin,logEntry</td><td style="text-align:left;"></td></tr><tr><td style="text-align:left;">Compilation</td><td style="text-align:left;">afterHash</td><td style="text-align:left;">SyncHook</td><td style="text-align:left;"></td><td style="text-align:left;"></td></tr><tr><td style="text-align:left;">Compilation</td><td style="text-align:left;">log</td><td style="text-align:left;">SyncBailHook</td><td style="text-align:left;">origin,logEntry</td><td style="text-align:left;"></td></tr><tr><td style="text-align:left;">Compilation</td><td style="text-align:left;">log</td><td style="text-align:left;">SyncBailHook</td><td style="text-align:left;">origin,logEntry</td><td style="text-align:left;"></td></tr><tr><td style="text-align:left;">Compilation</td><td style="text-align:left;">recordHash</td><td style="text-align:left;">SyncHook</td><td style="text-align:left;">records</td><td style="text-align:left;"></td></tr><tr><td style="text-align:left;">Compilation</td><td style="text-align:left;">log</td><td style="text-align:left;">SyncBailHook</td><td style="text-align:left;">origin,logEntry</td><td style="text-align:left;"></td></tr><tr><td style="text-align:left;">Compilation</td><td style="text-align:left;">beforeModuleAssets</td><td style="text-align:left;">SyncHook</td><td style="text-align:left;"></td><td style="text-align:left;"></td></tr><tr><td style="text-align:left;">Compilation</td><td style="text-align:left;">log</td><td style="text-align:left;">SyncBailHook</td><td style="text-align:left;">origin,logEntry</td><td style="text-align:left;"></td></tr><tr><td style="text-align:left;">Compilation</td><td style="text-align:left;">shouldGenerateChunkAssets</td><td style="text-align:left;">SyncBailHook</td><td style="text-align:left;"></td><td style="text-align:left;"></td></tr><tr><td style="text-align:left;">Compilation</td><td style="text-align:left;">beforeChunkAssets</td><td style="text-align:left;">SyncHook</td><td style="text-align:left;"></td><td style="text-align:left;"></td></tr><tr><td style="text-align:left;">Compilation</td><td style="text-align:left;">renderManifest</td><td style="text-align:left;">SyncWaterfallHook</td><td style="text-align:left;">result,options</td><td style="text-align:left;"></td></tr><tr><td style="text-align:left;">Compilation</td><td style="text-align:left;">assetPath</td><td style="text-align:left;">SyncWaterfallHook</td><td style="text-align:left;">path,options,assetInfo</td><td style="text-align:left;"></td></tr><tr><td style="text-align:left;">Compilation</td><td style="text-align:left;">chunkAsset</td><td style="text-align:left;">SyncHook</td><td style="text-align:left;">chunk,filename</td><td style="text-align:left;"></td></tr><tr><td style="text-align:left;">Compilation</td><td style="text-align:left;">log</td><td style="text-align:left;">SyncBailHook</td><td style="text-align:left;">origin,logEntry</td><td style="text-align:left;"></td></tr><tr><td style="text-align:left;">Compilation</td><td style="text-align:left;">additionalChunkAssets</td><td style="text-align:left;">Object</td><td style="text-align:left;">undefined</td><td style="text-align:left;"></td></tr><tr><td style="text-align:left;">Compilation</td><td style="text-align:left;">additionalAssets</td><td style="text-align:left;">Object</td><td style="text-align:left;">undefined</td><td style="text-align:left;"></td></tr><tr><td style="text-align:left;">Compilation</td><td style="text-align:left;">optimizeAssets</td><td style="text-align:left;">AsyncSeriesHook</td><td style="text-align:left;">assets</td><td style="text-align:left;"></td></tr><tr><td style="text-align:left;">Compilation</td><td style="text-align:left;">processAssets</td><td style="text-align:left;">AsyncSeriesHook</td><td style="text-align:left;">assets</td><td style="text-align:left;"></td></tr><tr><td style="text-align:left;">Compilation</td><td style="text-align:left;">optimizeChunkAssets</td><td style="text-align:left;">Object</td><td style="text-align:left;">undefined</td><td style="text-align:left;"></td></tr><tr><td style="text-align:left;">Compilation</td><td style="text-align:left;">afterOptimizeChunkAssets</td><td style="text-align:left;">Object</td><td style="text-align:left;">undefined</td><td style="text-align:left;"></td></tr><tr><td style="text-align:left;">Compilation</td><td style="text-align:left;">afterOptimizeAssets</td><td style="text-align:left;">SyncHook</td><td style="text-align:left;">assets</td><td style="text-align:left;"></td></tr><tr><td style="text-align:left;">Compilation</td><td style="text-align:left;">afterProcessAssets</td><td style="text-align:left;">SyncHook</td><td style="text-align:left;">assets</td><td style="text-align:left;"></td></tr><tr><td style="text-align:left;">Compilation</td><td style="text-align:left;">log</td><td style="text-align:left;">SyncBailHook</td><td style="text-align:left;">origin,logEntry</td><td style="text-align:left;"></td></tr><tr><td style="text-align:left;">Compilation</td><td style="text-align:left;">record</td><td style="text-align:left;">SyncHook</td><td style="text-align:left;">compilation,records</td><td style="text-align:left;"></td></tr><tr><td style="text-align:left;">Compilation</td><td style="text-align:left;">needAdditionalSeal</td><td style="text-align:left;">SyncBailHook</td><td style="text-align:left;"></td><td style="text-align:left;"></td></tr><tr><td style="text-align:left;">Compilation</td><td style="text-align:left;">afterSeal</td><td style="text-align:left;">AsyncSeriesHook</td><td style="text-align:left;"></td><td style="text-align:left;"></td></tr><tr><td style="text-align:left;">Compilation</td><td style="text-align:left;">log</td><td style="text-align:left;">SyncBailHook</td><td style="text-align:left;">origin,logEntry</td><td style="text-align:left;"></td></tr><tr><td style="text-align:left;">Compilation</td><td style="text-align:left;">log</td><td style="text-align:left;">SyncBailHook</td><td style="text-align:left;">origin,logEntry</td><td style="text-align:left;"></td></tr><tr><td style="text-align:left;">Compilation</td><td style="text-align:left;">log</td><td style="text-align:left;">SyncBailHook</td><td style="text-align:left;">origin,logEntry</td><td style="text-align:left;"></td></tr><tr><td style="text-align:left;">Compilation</td><td style="text-align:left;">log</td><td style="text-align:left;">SyncBailHook</td><td style="text-align:left;">origin,logEntry</td><td style="text-align:left;"></td></tr><tr><td style="text-align:left;">Compilation</td><td style="text-align:left;">log</td><td style="text-align:left;">SyncBailHook</td><td style="text-align:left;">origin,logEntry</td><td style="text-align:left;"></td></tr><tr><td style="text-align:left;">Compilation</td><td style="text-align:left;">log</td><td style="text-align:left;">SyncBailHook</td><td style="text-align:left;">origin,logEntry</td><td style="text-align:left;"></td></tr><tr><td style="text-align:left;">Compilation</td><td style="text-align:left;">log</td><td style="text-align:left;">SyncBailHook</td><td style="text-align:left;">origin,logEntry</td><td style="text-align:left;"></td></tr><tr><td style="text-align:left;">Compilation</td><td style="text-align:left;">log</td><td style="text-align:left;">SyncBailHook</td><td style="text-align:left;">origin,logEntry</td><td style="text-align:left;"></td></tr><tr><td style="text-align:left;">Compilation</td><td style="text-align:left;">log</td><td style="text-align:left;">SyncBailHook</td><td style="text-align:left;">origin,logEntry</td><td style="text-align:left;"></td></tr><tr><td style="text-align:left;">Compilation</td><td style="text-align:left;">log</td><td style="text-align:left;">SyncBailHook</td><td style="text-align:left;">origin,logEntry</td><td style="text-align:left;"></td></tr><tr><td style="text-align:left;">Compiler</td><td style="text-align:left;">afterCompile</td><td style="text-align:left;">AsyncSeriesHook</td><td style="text-align:left;">compilation</td><td style="text-align:left;"></td></tr><tr><td style="text-align:left;">Compilation</td><td style="text-align:left;">log</td><td style="text-align:left;">SyncBailHook</td><td style="text-align:left;">origin,logEntry</td><td style="text-align:left;"></td></tr><tr><td style="text-align:left;">Compiler</td><td style="text-align:left;">shouldEmit</td><td style="text-align:left;">SyncBailHook</td><td style="text-align:left;">compilation</td><td style="text-align:left;"></td></tr><tr><td style="text-align:left;">Compiler</td><td style="text-align:left;">emit</td><td style="text-align:left;">AsyncSeriesHook</td><td style="text-align:left;">compilation</td><td style="text-align:left;"></td></tr><tr><td style="text-align:left;">Compilation</td><td style="text-align:left;">assetPath</td><td style="text-align:left;">SyncWaterfallHook</td><td style="text-align:left;">path,options,assetInfo</td><td style="text-align:left;"></td></tr><tr><td style="text-align:left;">Compiler</td><td style="text-align:left;">assetEmitted</td><td style="text-align:left;">AsyncSeriesHook</td><td style="text-align:left;">file,info</td><td style="text-align:left;"></td></tr><tr><td style="text-align:left;">Compiler</td><td style="text-align:left;">afterEmit</td><td style="text-align:left;">AsyncSeriesHook</td><td style="text-align:left;">compilation</td><td style="text-align:left;"></td></tr><tr><td style="text-align:left;">Compilation</td><td style="text-align:left;">log</td><td style="text-align:left;">SyncBailHook</td><td style="text-align:left;">origin,logEntry</td><td style="text-align:left;"></td></tr><tr><td style="text-align:left;">Compilation</td><td style="text-align:left;">needAdditionalPass</td><td style="text-align:left;">SyncBailHook</td><td style="text-align:left;"></td><td style="text-align:left;"></td></tr><tr><td style="text-align:left;">Compiler</td><td style="text-align:left;">emitRecords</td><td style="text-align:left;">AsyncSeriesHook</td><td style="text-align:left;"></td><td style="text-align:left;"></td></tr><tr><td style="text-align:left;">Compilation</td><td style="text-align:left;">log</td><td style="text-align:left;">SyncBailHook</td><td style="text-align:left;">origin,logEntry</td><td style="text-align:left;"></td></tr><tr><td style="text-align:left;">Compiler</td><td style="text-align:left;">done</td><td style="text-align:left;">AsyncSeriesHook</td><td style="text-align:left;">stats</td><td style="text-align:left;"></td></tr><tr><td style="text-align:left;">Compilation</td><td style="text-align:left;">log</td><td style="text-align:left;">SyncBailHook</td><td style="text-align:left;">origin,logEntry</td><td style="text-align:left;"></td></tr><tr><td style="text-align:left;">Compilation</td><td style="text-align:left;">log</td><td style="text-align:left;">SyncBailHook</td><td style="text-align:left;">origin,logEntry</td><td style="text-align:left;"></td></tr><tr><td style="text-align:left;">Compiler</td><td style="text-align:left;">shutdown</td><td style="text-align:left;">AsyncSeriesHook</td><td style="text-align:left;"></td><td style="text-align:left;"></td></tr><tr><td style="text-align:left;">Compilation</td><td style="text-align:left;">statsNormalize</td><td style="text-align:left;">SyncHook</td><td style="text-align:left;">options,context</td><td style="text-align:left;"></td></tr><tr><td style="text-align:left;">Compilation</td><td style="text-align:left;">statsFactory</td><td style="text-align:left;">SyncHook</td><td style="text-align:left;">statsFactory,options</td><td style="text-align:left;"></td></tr><tr><td style="text-align:left;">Compilation</td><td style="text-align:left;">statsPrinter</td><td style="text-align:left;">SyncHook</td><td style="text-align:left;">statsPrinter,options</td><td style="text-align:left;"></td></tr><tr><td style="text-align:left;">Compilation</td><td style="text-align:left;">processErrors</td><td style="text-align:left;">SyncWaterfallHook</td><td style="text-align:left;">errors</td><td style="text-align:left;"></td></tr><tr><td style="text-align:left;">Compilation</td><td style="text-align:left;">processWarnings</td><td style="text-align:left;">SyncWaterfallHook</td><td style="text-align:left;">warnings</td><td style="text-align:left;"></td></tr><tr><td style="text-align:left;">Compiler</td><td style="text-align:left;">afterDone</td><td style="text-align:left;">SyncHook</td><td style="text-align:left;">stats</td><td style="text-align:left;"></td></tr><tr><td style="text-align:left;">Compiler</td><td style="text-align:left;">infrastructureLog</td><td style="text-align:left;">SyncBailHook</td><td style="text-align:left;">origin,type,args</td><td style="text-align:left;"></td></tr></tbody></table><h4 id="_9-1-3-工作流" tabindex="-1"><a class="header-anchor" href="#_9-1-3-工作流"><span>9.1.3 工作流</span></a></h4><p><img src="http://img.zhufengpeixun.cn/webpackcode.jpg" alt=""></p><h5 id="_9-1-3-1-初始化阶段" tabindex="-1"><a class="header-anchor" href="#_9-1-3-1-初始化阶段"><span>9.1.3.1 初始化阶段</span></a></h5><table><thead><tr><th style="text-align:left;">事件名</th><th style="text-align:left;">解释</th><th style="text-align:left;">代码位置</th></tr></thead><tbody><tr><td style="text-align:left;">读取命令行参数</td><td style="text-align:left;">从命令行中读取用户输入的参数</td><td style="text-align:left;">[require(&quot;./convert-argv&quot;)(argv)](https://github.com/zhufengnodejs/webpack-analysis/blob/master/node_modules/webpack-cli/bin/cli.js</td></tr><tr><td style="text-align:left;">实例化 Compiler</td><td style="text-align:left;">1.用上一步得到的参数初始化 Compiler 实例2.Compiler 负责文件监听和启动编译3.Compiler 实例中包含了完整的 Webpack 配置，全局只有一个 Compiler 实例。</td><td style="text-align:left;">[compiler = webpack(options);](https://github.com/zhufengnodejs/webpack-analysis/blob/master/node_modules/webpack-cli/bin/cli.js</td></tr><tr><td style="text-align:left;">加载插件</td><td style="text-align:left;">1.依次调用插件的 apply 方法，让插件可以监听后续的所有事件节点。同时给插件传入 compiler 实例的引用，以方便插件通过 compiler 调用 Webpack 提供的 API。</td><td style="text-align:left;">[plugin.apply(compiler)](https://github.com/zhufengnodejs/webpack-analysis/blob/master/node_modules/_webpack%404.20.2%40webpack/lib/webpack.js</td></tr><tr><td style="text-align:left;">处理入口</td><td style="text-align:left;">读取配置的 Entrys，为每个 Entry 实例化一个对应的 EntryPlugin，为后面该 Entry 的递归解析工作做准备</td><td style="text-align:left;"><a href="https://github.com/zhufengnodejs/webpack-analysis/blob/master/node_modules/_webpack%404.20.2%40webpack/lib/WebpackOptionsApply.js#L306" target="_blank" rel="noopener noreferrer">new EntryOptionPlugin().apply(compiler)</a><a href="https://github.com/zhufengnodejs/webpack-analysis/blob/master/node_modules/_webpack%404.20.2%40webpack/lib/EntryOptionPlugin.js#L24" target="_blank" rel="noopener noreferrer">new SingleEntryPlugin(context, item, name)</a>[compiler.hooks.make.tapAsync](https://github.com/zhufengnodejs/webpack-analysis/blob/master/node_modules/_webpack%404.20.2%40webpack/lib/SingleEntryPlugin.js</td></tr></tbody></table><h5 id="_9-1-3-2-编译阶段" tabindex="-1"><a class="header-anchor" href="#_9-1-3-2-编译阶段"><span>9.1.3.2 编译阶段</span></a></h5><table><thead><tr><th style="text-align:left;">事件名</th><th style="text-align:left;">解释</th><th style="text-align:left;">代码位置</th></tr></thead><tbody><tr><td style="text-align:left;">run</td><td style="text-align:left;">启动一次新的编译</td><td style="text-align:left;">[this.hooks.run.callAsync](https://github.com/zhufengnodejs/webpack-analysis/blob/master/node_modules/_webpack%404.20.2%40webpack/lib/Compiler.js</td></tr><tr><td style="text-align:left;">compile</td><td style="text-align:left;">该事件是为了告诉插件一次新的编译将要启动，同时会给插件传入compiler 对象。</td><td style="text-align:left;">[compile(callback)](https://github.com/zhufengnodejs/webpack-analysis/blob/master/node_modules/_webpack%404.20.2%40webpack/lib/Compiler.js</td></tr><tr><td style="text-align:left;">compilation</td><td style="text-align:left;">当 Webpack 以开发模式运行时，每当检测到文件变化，一次新的 Compilation 将被创建。一个 Compilation 对象包含了当前的模块资源、编译生成资源、变化的文件等。Compilation 对象也提供了很多事件回调供插件做扩展。</td><td style="text-align:left;">[newCompilation(params)](https://github.com/zhufengnodejs/webpack-analysis/blob/master/node_modules/_webpack%404.20.2%40webpack/lib/Compiler.js</td></tr><tr><td style="text-align:left;">make</td><td style="text-align:left;">一个新的 Compilation 创建完毕主开始编译</td><td style="text-align:left;">[this.hooks.make.callAsync](https://github.com/zhufengnodejs/webpack-analysis/blob/master/node_modules/_webpack%404.20.2%40webpack/lib/Compiler.js</td></tr><tr><td style="text-align:left;">addEntry</td><td style="text-align:left;">即将从 Entry 开始读取文件</td><td style="text-align:left;"><a href="https://github.com/zhufengnodejs/webpack-analysis/blob/master/node_modules/_webpack%404.20.2%40webpack/lib/Compilation.js#L1027" target="_blank" rel="noopener noreferrer">compilation.addEntry</a>[this._addModuleChain](https://github.com/zhufengnodejs/webpack-analysis/blob/master/node_modules/_webpack%404.20.2%40webpack/lib/Compilation.js</td></tr><tr><td style="text-align:left;">moduleFactory</td><td style="text-align:left;">创建模块工厂</td><td style="text-align:left;">[const moduleFactory = this.dependencyFactories.get(Dep)](https://github.com/zhufengnodejs/webpack-analysis/blob/master/node_modules/_webpack%404.20.2%40webpack/lib/Compilation.js</td></tr><tr><td style="text-align:left;">create</td><td style="text-align:left;">创建模块</td><td style="text-align:left;">[moduleFactory.create](https://github.com/zhufengnodejs/webpack-analysis/blob/master/node_modules/_webpack%404.20.2%40webpack/lib/NormalModuleFactory.js</td></tr><tr><td style="text-align:left;">factory</td><td style="text-align:left;">开始创建模块</td><td style="text-align:left;"><a href="https://github.com/zhufengnodejs/webpack-analysis/blob/master/node_modules/_webpack%404.20.2%40webpack/lib/NormalModuleFactory.js#L396-L406" target="_blank" rel="noopener noreferrer">factory(result, (err, module)</a><a href="https://github.com/zhufengnodejs/webpack-analysis/blob/master/node_modules/_webpack%404.20.2%40webpack/lib/NormalModuleFactory.js#L129" target="_blank" rel="noopener noreferrer">resolver(result</a>[this.hooks.resolver.tap(&quot;NormalModuleFactory&quot;](https://github.com/zhufengnodejs/webpack-analysis/blob/master/node_modules/_webpack%404.20.2%40webpack/lib/NormalModuleFactory.js</td></tr><tr><td style="text-align:left;">resolveRequestArray</td><td style="text-align:left;">解析loader路径</td><td style="text-align:left;">[resolveRequestArray](https://github.com/zhufengnodejs/webpack-analysis/blob/master/node_modules/_webpack%404.20.2%40webpack/lib/NormalModuleFactory.js</td></tr><tr><td style="text-align:left;">resolve</td><td style="text-align:left;">解析资源文件路径</td><td style="text-align:left;">[resolve](https://github.com/zhufengnodejs/webpack-analysis/blob/master/node_modules/_enhanced-resolve%404.1.0%40enhanced-resolve/lib/Resolver.js</td></tr><tr><td style="text-align:left;">userRequest</td><td style="text-align:left;">得到包括loader在内的资源文件的绝对路径用!拼起来的字符串</td><td style="text-align:left;">[userRequest](https://github.com/zhufengnodejs/webpack-analysis/blob/master/node_modules/_webpack%404.20.2%40webpack/lib/NormalModuleFactory.js</td></tr><tr><td style="text-align:left;">ruleSet.exec</td><td style="text-align:left;">它可以根据模块路径名，匹配出模块所需的loader</td><td style="text-align:left;">[this.ruleSet.exec](https://github.com/zhufengnodejs/webpack-analysis/blob/master/node_modules/_webpack%404.20.2%40webpack/lib/NormalModuleFactory.js</td></tr><tr><td style="text-align:left;">_run</td><td style="text-align:left;">它可以根据模块路径名，匹配出模块所需的loader</td><td style="text-align:left;">[_run](https://github.com/zhufengnodejs/webpack-analysis/blob/master/node_modules/_webpack%404.20.2%40webpack/lib/RuleSet.js</td></tr><tr><td style="text-align:left;">loaders</td><td style="text-align:left;">得到所有的loader数组</td><td style="text-align:left;">[results[0].concat(loaders, results[1], results[2])](https://github.com/zhufengnodejs/webpack-analysis/blob/master/node_modules/_webpack%404.20.2%40webpack/lib/NormalModuleFactory.js</td></tr><tr><td style="text-align:left;">getParser</td><td style="text-align:left;">获取AST解析器</td><td style="text-align:left;">[this.getParser(type, settings.parser)](https://github.com/zhufengnodejs/webpack-analysis/blob/master/node_modules/_webpack%404.20.2%40webpack/lib/NormalModuleFactory.js</td></tr><tr><td style="text-align:left;">buildModule</td><td style="text-align:left;">开始编译模块</td><td style="text-align:left;"><a href="https://github.com/zhufengnodejs/webpack-analysis/blob/master/node_modules/_webpack%404.20.2%40webpack/lib/Compilation.js#L996-L1009" target="_blank" rel="noopener noreferrer">this.buildModule(module</a>[buildModule(module, optional, origin, dependencies, thisCallback)](https://github.com/zhufengnodejs/webpack-analysis/blob/master/node_modules/_webpack%404.20.2%40webpack/lib/Compilation.js</td></tr><tr><td style="text-align:left;">build</td><td style="text-align:left;">开始真正编译入口模块</td><td style="text-align:left;">[build(options](https://github.com/zhufengnodejs/webpack-analysis/blob/master/node_modules/_webpack%404.20.2%40webpack/lib/NormalModule.js</td></tr><tr><td style="text-align:left;">doBuild</td><td style="text-align:left;">开始真正编译入口模块</td><td style="text-align:left;">[doBuild](https://github.com/zhufengnodejs/webpack-analysis/blob/master/node_modules/_webpack%404.20.2%40webpack/lib/NormalModule.js</td></tr><tr><td style="text-align:left;">执行loader</td><td style="text-align:left;">使用loader进行转换</td><td style="text-align:left;"><a href="https://github.com/zhufengnodejs/webpack-analysis/blob/master/node_modules/_webpack%404.20.2%40webpack/lib/NormalModule.js#L265" target="_blank" rel="noopener noreferrer">runLoaders</a>[runLoaders](https://github.com/zhufengnodejs/webpack-analysis/blob/master/node_modules/_loader-runner%402.3.1%40loader-runner/lib/LoaderRunner.js</td></tr><tr><td style="text-align:left;">iteratePitchingLoaders</td><td style="text-align:left;">开始递归执行pitch loader</td><td style="text-align:left;">[iteratePitchingLoaders](https://github.com/zhufengnodejs/webpack-analysis/blob/master/node_modules/_loader-runner%402.3.1%40loader-runner/lib/LoaderRunner.js</td></tr><tr><td style="text-align:left;">loadLoader</td><td style="text-align:left;">加载loader</td><td style="text-align:left;">[loadLoader](https://github.com/zhufengnodejs/webpack-analysis/blob/master/node_modules/_loader-runner%402.3.1%40loader-runner/lib/loadLoader.js</td></tr><tr><td style="text-align:left;">runSyncOrAsync</td><td style="text-align:left;">执行pitchLoader</td><td style="text-align:left;">[runSyncOrAsync](https://github.com/zhufengnodejs/webpack-analysis/blob/master/node_modules/_loader-runner%402.3.1%40loader-runner/lib/LoaderRunner.js</td></tr><tr><td style="text-align:left;">processResource</td><td style="text-align:left;">开始处理资源</td><td style="text-align:left;"><a href="https://github.com/zhufengnodejs/webpack-analysis/blob/master/node_modules/_loader-runner%402.3.1%40loader-runner/lib/LoaderRunner.js#L192" target="_blank" rel="noopener noreferrer">processResource</a><a href="https://github.com/zhufengnodejs/webpack-analysis/blob/master/node_modules/_loader-runner%402.3.1%40loader-runner/lib/LoaderRunner.js#L199" target="_blank" rel="noopener noreferrer">options.readResource</a><a href="https://github.com/zhufengnodejs/webpack-analysis/blob/master/node_modules/_loader-runner%402.3.1%40loader-runner/lib/LoaderRunner.js#L202" target="_blank" rel="noopener noreferrer">iterateNormalLoaders</a>[iterateNormalLoaders](https://github.com/zhufengnodejs/webpack-analysis/blob/master/node_modules/_loader-runner%402.3.1%40loader-runner/lib/LoaderRunner.js</td></tr><tr><td style="text-align:left;">createSource</td><td style="text-align:left;">创建源代码对象</td><td style="text-align:left;">[this.createSource](https://github.com/zhufengnodejs/webpack-analysis/blob/master/node_modules/_webpack%404.20.2%40webpack/lib/NormalModule.js</td></tr><tr><td style="text-align:left;">parse</td><td style="text-align:left;">使用parser转换抽象语法树</td><td style="text-align:left;">[this.parser.parse](https://github.com/zhufengnodejs/webpack-analysis/blob/master/node_modules/_webpack%404.20.2%40webpack/lib/NormalModule.js</td></tr><tr><td style="text-align:left;">parse</td><td style="text-align:left;">解析抽象语法树</td><td style="text-align:left;">[parse(source, initialState)](https://github.com/zhufengnodejs/webpack-analysis/blob/master/node_modules/_webpack%404.20.2%40webpack/lib/Parser.js</td></tr><tr><td style="text-align:left;">acorn.parse</td><td style="text-align:left;">解析语法树</td><td style="text-align:left;">[acorn.parse(code, parserOptions)](https://github.com/zhufengnodejs/webpack-analysis/blob/master/node_modules/_webpack%404.20.2%40webpack/lib/Parser.js</td></tr><tr><td style="text-align:left;">ImportDependency</td><td style="text-align:left;">遍历并添加添加依赖</td><td style="text-align:left;">[parser.state.module.addDependency(clearDep)](https://github.com/zhufengnodejs/webpack-analysis/blob/master/node_modules/_webpack%404.20.2%40webpack/lib/dependencies/HarmonyImportDependencyParserPlugin.js</td></tr><tr><td style="text-align:left;">succeedModule</td><td style="text-align:left;">生成语法树后就表示一个模块编译完成</td><td style="text-align:left;">[this.hooks.succeedModule.call(module)](https://github.com/zhufengnodejs/webpack-analysis/blob/master/node_modules/_webpack%404.20.2%40webpack/lib/Compilation.js</td></tr><tr><td style="text-align:left;">processModuleDependencies</td><td style="text-align:left;">递归编译依赖的模块</td><td style="text-align:left;"><a href="https://github.com/zhufengnodejs/webpack-analysis/blob/master/node_modules/_webpack%404.20.2%40webpack/lib/Compilation.js#L980" target="_blank" rel="noopener noreferrer">this.processModuleDependencies(module</a><a href="https://github.com/zhufengnodejs/webpack-analysis/blob/master/node_modules/_webpack%404.20.2%40webpack/lib/Compilation.js#L663" target="_blank" rel="noopener noreferrer">processModuleDependencies(module, callback)</a><a href="https://github.com/zhufengnodejs/webpack-analysis/blob/master/node_modules/_webpack%404.20.2%40webpack/lib/Compilation.js#L716" target="_blank" rel="noopener noreferrer">this.addModuleDependencies</a>[buildModule](https://github.com/zhufengnodejs/webpack-analysis/blob/master/node_modules/_webpack%404.20.2%40webpack/lib/Compilation.js</td></tr><tr><td style="text-align:left;">make后</td><td style="text-align:left;">结束make</td><td style="text-align:left;">[this.hooks.make.callAsync(compilation, err =&gt; {}](https://github.com/zhufengnodejs/webpack-analysis/blob/master/node_modules/_webpack%404.20.2%40webpack/lib/Compiler.js</td></tr><tr><td style="text-align:left;">finish</td><td style="text-align:left;">编译完成</td><td style="text-align:left;">[compilation.finish();](https://github.com/zhufengnodejs/webpack-analysis/blob/master/node_modules/_webpack%404.20.2%40webpack/lib/Compiler.js</td></tr></tbody></table><h5 id="_9-1-3-3-结束阶段" tabindex="-1"><a class="header-anchor" href="#_9-1-3-3-结束阶段"><span>9.1.3.3 结束阶段</span></a></h5><table><thead><tr><th style="text-align:left;">事件名</th><th style="text-align:left;">解释</th><th style="text-align:left;">代码位置</th></tr></thead><tbody><tr><td style="text-align:left;">seal</td><td style="text-align:left;">封装</td><td style="text-align:left;"><a href="https://github.com/zhufengnodejs/webpack-analysis/blob/master/node_modules/_webpack%404.20.2%40webpack/lib/Compiler.js#L549" target="_blank" rel="noopener noreferrer">compilation.seal</a>[seal(callback)](https://github.com/zhufengnodejs/webpack-analysis/blob/master/node_modules/_webpack%404.20.2%40webpack/lib/Compilation.js</td></tr><tr><td style="text-align:left;">addChunk</td><td style="text-align:left;">生成资源</td><td style="text-align:left;">[addChunk(name)](https://github.com/zhufengnodejs/webpack-analysis/blob/master/node_modules/_webpack%404.20.2%40webpack/lib/Compilation.js</td></tr><tr><td style="text-align:left;">createChunkAssets</td><td style="text-align:left;">创建资源</td><td style="text-align:left;">[this.createChunkAssets()](https://github.com/zhufengnodejs/webpack-analysis/blob/master/node_modules/_webpack%404.20.2%40webpack/lib/Compilation.js</td></tr><tr><td style="text-align:left;">getRenderManifest</td><td style="text-align:left;">获得要渲染的描述文件</td><td style="text-align:left;">[getRenderManifest(options)](https://github.com/zhufengnodejs/webpack-analysis/blob/master/node_modules/_webpack%404.20.2%40webpack/lib/MainTemplate.js</td></tr><tr><td style="text-align:left;">render</td><td style="text-align:left;">渲染源码</td><td style="text-align:left;">[source = fileManifest.render();](https://github.com/zhufengnodejs/webpack-analysis/blob/master/node_modules/_webpack%404.20.2%40webpack/lib/Compilation.js</td></tr><tr><td style="text-align:left;">afterCompile</td><td style="text-align:left;">编译结束</td><td style="text-align:left;">[this.hooks.afterCompile](https://github.com/zhufengnodejs/webpack-analysis/blob/master/node_modules/_webpack%404.20.2%40webpack/lib/Compiler.js#</td></tr><tr><td style="text-align:left;">shouldEmit</td><td style="text-align:left;">所有需要输出的文件已经生成好，询问插件哪些文件需要输出，哪些不需要。</td><td style="text-align:left;">[this.hooks.shouldEmit](https://github.com/zhufengnodejs/webpack-analysis/blob/master/node_modules/_webpack%404.20.2%40webpack/lib/Compiler.js#</td></tr><tr><td style="text-align:left;">emit</td><td style="text-align:left;">确定好要输出哪些文件后，执行文件输出，可以在这里获取和修改输出内容。</td><td style="text-align:left;"><a href="https://github.com/zhufengnodejs/webpack-analysis/blob/master/node_modules/_webpack%404.20.2%40webpack/lib/Compiler.js##L228" target="_blank" rel="noopener noreferrer">this.emitAssets(compilation</a><a href="https://github.com/zhufengnodejs/webpack-analysis/blob/master/node_modules/_webpack%404.20.2%40webpack/lib/Compiler.js##L363-L367" target="_blank" rel="noopener noreferrer">this.hooks.emit.callAsync</a><a href="https://github.com/zhufengnodejs/webpack-analysis/blob/master/node_modules/_webpack%404.20.2%40webpack/lib/Compiler.js##L308-L361" target="_blank" rel="noopener noreferrer">const emitFiles = err</a>[this.outputFileSystem.writeFile](https://github.com/zhufengnodejs/webpack-analysis/blob/master/node_modules/_webpack%404.20.2%40webpack/lib/Compiler.js#</td></tr><tr><td style="text-align:left;">this.emitRecords</td><td style="text-align:left;">写入记录</td><td style="text-align:left;">[this.emitRecords](https://github.com/zhufengnodejs/webpack-analysis/blob/master/node_modules/_webpack%404.20.2%40webpack/lib/Compiler.js#</td></tr><tr><td style="text-align:left;">done</td><td style="text-align:left;">全部完成</td><td style="text-align:left;">[this.hooks.done.callAsync](https://github.com/zhufengnodejs/webpack-analysis/blob/master/node_modules/_webpack%404.20.2%40webpack/lib/Compiler.js#</td></tr></tbody></table>`,78)])])}const c=n(l,[["render",p]]),d=JSON.parse('{"path":"/strong/103.7.webpack-plugin.html","title":"","lang":"en-US","frontmatter":{},"git":{"updatedTime":1681290319000,"contributors":[{"name":"yutao","username":"yutao","email":"642231346@qq.com","commits":1,"url":"https://github.com/yutao"}],"changelog":[{"hash":"f5ab8c9d34991ec274f7f652439afe5b2afb6147","time":1681290319000,"email":"642231346@qq.com","author":"yutao","message":"modify"}]},"filePathRelative":"strong/103.7.webpack-plugin.md"}');export{c as comp,d as data};
