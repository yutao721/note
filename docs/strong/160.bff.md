![](../C:\Users\zhangrenyang\Desktop\temp\ç å³°æ¶æ„.png)

 ## 1.è¯¾ç¨‹å¤§çº² 

* BFFæ¶æ„æ¼”è¿›
* RPCé«˜æ€§æ€§èƒ½BFFå®æˆ˜
* DDDå’ŒGraphQLå®æˆ˜BFF
* Serverlesså®æˆ˜BFF

 ## 2.BFFæ¶æ„æ¼”è¿› 

![](https://static.zhufengpeixun.com/ge_ren_zhong_xin_1673108734927.png)

 ### 2.1 å•ä½“æœåŠ¡ 

* å•ä½“æœåŠ¡æ˜¯æŒ‡ä¸€ä¸ªç‹¬ç«‹çš„åº”ç”¨ç¨‹åºï¼ŒåŒ…å«äº†æ‰€æœ‰çš„åŠŸèƒ½å’Œä¸šåŠ¡é€»è¾‘ã€‚è¿™ç§æ¶æ„æ–¹å¼åœ¨å°å‹åº”ç”¨ç¨‹åºä¸­å¾ˆå¸¸è§
* éšç€åº”ç”¨ç¨‹åºçš„åŠŸèƒ½è¶Šæ¥è¶Šå¤šï¼Œä»£ç åº“ä¹Ÿä¼šè¶Šæ¥è¶Šå¤§ï¼Œç»´æŠ¤èµ·æ¥ä¹Ÿä¼šå˜å¾—æ›´åŠ å›°éš¾ã€‚æ­¤å¤–ï¼Œå•ä½“æœåŠ¡çš„æ•´ä½“å¤æ‚åº¦ä¹Ÿä¼šå¢åŠ ï¼Œè¿™å¯èƒ½å¯¼è‡´è½¯ä»¶å¼€å‘å‘¨æœŸå˜é•¿ï¼Œè´¨é‡ä¸‹é™ï¼Œå¹¶ä¸”ç³»ç»Ÿçš„æ‰©å±•æ€§ä¹Ÿä¼šå—åˆ°é™åˆ¶

![](https://static.zhufengpeixun.com/web0_1673109441373.jpg)

 ### 2.2 å¾®æœåŠ¡ 

* ä¸ºäº†åº”å¯¹è¿™äº›é—®é¢˜ï¼Œè®¸å¤šå…¬å¸å¼€å§‹ä½¿ç”¨å¾®æœåŠ¡æ¶æ„ã€‚å¾®æœåŠ¡æ˜¯æŒ‡å°†ä¸€ä¸ªå¤§å‹åº”ç”¨ç¨‹åºæ‹†åˆ†æˆè‹¥å¹²ä¸ªå°å‹æœåŠ¡ï¼Œæ¯ä¸ªæœåŠ¡è´Ÿè´£æ‰§è¡Œç‰¹å®šçš„ä»»åŠ¡ã€‚è¿™ç§æ¶æ„æ–¹å¼å¯ä»¥å¸®åŠ©å…¬å¸æ›´å¿«åœ°å¼€å‘å’Œéƒ¨ç½²æ–°åŠŸèƒ½ï¼Œå¹¶æé«˜ç³»ç»Ÿçš„å¯æ‰©å±•æ€§å’Œå¯ç»´æŠ¤æ€§
* è¿™ç§æ–¹å¼ä¼šæœ‰ä»¥ä¸‹é—®é¢˜
  * åŸŸåå¼€é”€å¢åŠ 
    * å†…éƒ¨æœåŠ¡å™¨æš´éœ²åœ¨å…¬ç½‘ï¼Œæœ‰å®‰å…¨éšæ‚£
    * å„ä¸ªç«¯æœ‰å¤§é‡çš„ä¸ªæ€§åŒ–éœ€æ±‚
      * æ•°æ®èšåˆ æŸäº›åŠŸèƒ½å¯èƒ½éœ€è¦è°ƒç”¨å¤šä¸ªå¾®æœåŠ¡è¿›è¡Œç»„åˆ
        * æ•°æ®è£å‰ª åç«¯æœåŠ¡è¿”å›çš„æ•°æ®å¯èƒ½éœ€è¦è¿‡æ»¤æ‰ä¸€äº›æ•æ„Ÿæ•°æ®
        * æ•°æ®é€‚é… åç«¯è¿”å›çš„æ•°æ®å¯èƒ½éœ€è¦é’ˆå¯¹ä¸åŒç«¯è¿›è¡Œæ•°æ®ç»“æ„çš„é€‚é…ï¼Œåç«¯è¿”å›`XML`ï¼Œä½†å‰ç«¯éœ€è¦`JSON`
        * æ•°æ®é‰´æƒ ä¸åŒçš„å®¢æˆ·ç«¯æœ‰ä¸åŒçš„æƒé™è¦æ±‚

![](https://static.zhufengpeixun.com/web15_1673110992237.jpg)

 ### 2.3 BFF 

* BFFæ˜¯`Backend for Frontend`çš„ç¼©å†™ï¼ŒæŒ‡çš„æ˜¯ä¸“é—¨ä¸ºå‰ç«¯åº”ç”¨è®¾è®¡çš„åç«¯æœåŠ¡
* ä¸»è¦ç”¨æ¥ä¸ºå„ä¸ªç«¯æä¾›ä»£ç†æ•°æ®èšåˆã€è£å‰ªã€é€‚é…å’Œé‰´æƒæœåŠ¡ï¼Œæ–¹ä¾¿å„ä¸ªç«¯æ¥å…¥åç«¯æœåŠ¡
* BFFå¯ä»¥æŠŠå‰ç«¯å’Œå¾®æœåŠ¡è¿›è¡Œè§£è€¦ï¼Œå„è‡ªå¯ä»¥ç‹¬ç«‹æ¼”è¿›

![](https://static.zhufengpeixun.com/web23_1673111569390.jpg)

 ### 2.4 ç½‘å…³ 

* API ç½‘å…³æ˜¯ä¸€ç§ç”¨äºåœ¨åº”ç”¨ç¨‹åºå’Œ API ä¹‹é—´æä¾›å®‰å…¨è®¿é—®çš„ä¸­é—´å±‚
* API ç½‘å…³è¿˜å¯ä»¥ç”¨äºç›‘æ§ API è°ƒç”¨ï¼Œè·¯ç”±è¯·æ±‚ï¼Œä»¥åŠåœ¨è¯·æ±‚å’Œå“åº”ä¹‹é—´æ·»åŠ é™„åŠ åŠŸèƒ½ï¼ˆä¾‹å¦‚èº«ä»½éªŒè¯ï¼Œç¼“å­˜ï¼Œæ•°æ®è½¬æ¢ï¼Œå‹ç¼©ã€æµé‡æ§åˆ¶ã€é™æµç†”æ–­ã€é˜²çˆ¬è™«ç­‰ï¼‰
* ç½‘å…³å’ŒBFFå¯èƒ½åˆäºŒä¸ºä¸€

![](https://static.zhufengpeixun.com/web32_1673150436062.jpg)

 ### 2.5 é›†ç¾¤åŒ– 

* å•ç‚¹æœåŠ¡å™¨å¯èƒ½ä¼šå­˜åœ¨ä»¥ä¸‹å‡ ä¸ªé—®é¢˜ï¼š
  * å•ç‚¹æ•…éšœï¼šå•ç‚¹æœåŠ¡å™¨åªæœ‰ä¸€å°ï¼Œå¦‚æœè¿™å°æœåŠ¡å™¨å‡ºç°æ•…éšœï¼Œæ•´ä¸ªç³»ç»Ÿéƒ½ä¼šåœæ­¢å·¥ä½œï¼Œè¿™ä¼šå¯¼è‡´æœåŠ¡ä¸­æ–­
  * è®¡ç®—èƒ½åŠ›æœ‰é™ï¼šå•ç‚¹æœåŠ¡å™¨çš„è®¡ç®—èƒ½åŠ›æ˜¯æœ‰é™çš„ï¼Œæ— æ³•åº”å¯¹å¤§è§„æ¨¡çš„è®¡ç®—éœ€æ±‚
  * å¯æ‰©å±•æ€§å·®ï¼šå•ç‚¹æœåŠ¡å™¨çš„æ‰©å±•èƒ½åŠ›æœ‰é™ï¼Œå¦‚æœæƒ³è¦æå‡è®¡ç®—èƒ½åŠ›ï¼Œå°±å¿…é¡»æ”¹é€ æˆ–è€…æ›¿æ¢ç°æœ‰çš„æœåŠ¡å™¨
* è¿™äº›é—®é¢˜å¯ä»¥é€šè¿‡é‡‡ç”¨æœåŠ¡å™¨é›†ç¾¤çš„æ–¹å¼æ¥è§£å†³

![](https://static.zhufengpeixun.com/web4_1673152233154.jpg)

 ## 3.åˆ›å»ºç”¨æˆ·å¾®æœåŠ¡ 

 ### 3.1 å¾®æœåŠ¡ 

* å¾®æœåŠ¡æ˜¯ä¸€ç§æ¶æ„æ¨¡å¼ï¼Œå®ƒå°†å•ä¸ªåº”ç”¨ç¨‹åºåˆ’åˆ†ä¸ºå°çš„æœåŠ¡ï¼Œæ¯ä¸ªæœåŠ¡éƒ½ç‹¬ç«‹è¿è¡Œå¹¶ä¸”å¯ä»¥ä½¿ç”¨ä¸åŒçš„è¯­è¨€å¼€å‘ã€‚è¿™ç§æ¶æ„æ¨¡å¼ä½¿å¾—åº”ç”¨ç¨‹åºå˜å¾—æ›´å®¹æ˜“å¼€å‘ã€ç»´æŠ¤å’Œæ‰©å±•
* å¾®æœåŠ¡æ¶æ„é€šå¸¸ä¼šæœ‰è®¸å¤šä¸åŒçš„æœåŠ¡ï¼Œè¿™äº›æœåŠ¡å¯èƒ½ä½äºä¸åŒçš„æœºå™¨ä¸Šï¼Œå› æ­¤éœ€è¦ä½¿ç”¨æŸç§é€šä¿¡åè®®æ¥è¿›è¡Œé€šä¿¡
* å› ä¸º`RPC`åè®®æ¯”`HTTP`åè®®å…·æœ‰æ›´ä½çš„å»¶è¿Ÿå’Œæ›´é«˜çš„æ€§èƒ½ï¼Œæ‰€ä»¥ç”¨çš„æ›´å¤š

 ### 3.2 RPC 

* `RPCï¼ˆRemote Procedure Callï¼‰` æ˜¯è¿œç¨‹è¿‡ç¨‹è°ƒç”¨çš„ç¼©å†™ï¼Œæ˜¯ä¸€ç§é€šä¿¡åè®®ï¼Œå…è®¸ç¨‹åºåœ¨ä¸åŒçš„è®¡ç®—æœºä¸Šç›¸äº’è°ƒç”¨è¿œç¨‹è¿‡ç¨‹ï¼Œå°±åƒè°ƒç”¨æœ¬åœ°è¿‡ç¨‹ä¸€æ ·

 ### 3.3 sofa-rpc-node 

* `sofa-rpc-node` æ˜¯åŸºäº Node.js çš„ä¸€ä¸ª RPC æ¡†æ¶ï¼Œæ”¯æŒå¤šç§åè®®

 ### 3.4 Protocol Buffers 

* `Protocol Buffers`ï¼ˆç®€ç§° protobufï¼‰æ˜¯ Google å¼€å‘çš„ä¸€ç§æ•°æ®åºåˆ—åŒ–æ ¼å¼ï¼Œå¯ä»¥å°†ç»“æ„åŒ–æ•°æ®åºåˆ—åŒ–æˆäºŒè¿›åˆ¶æ ¼å¼ï¼Œå¹¶èƒ½å¤Ÿè·¨è¯­è¨€ä½¿ç”¨

 ### 3.5 Zookeeper 

 #### 3.5.1 ç®€ä»‹ 

* ZooKeeper æ˜¯ä¸€ä¸ªåˆ†å¸ƒå¼åè°ƒæœåŠ¡ï¼Œæä¾›äº†ä¸€äº›ç®€å•çš„åˆ†å¸ƒå¼æœåŠ¡ï¼Œå¦‚é…ç½®ç»´æŠ¤ã€åå­—æœåŠ¡ã€ç»„æœåŠ¡ç­‰ã€‚å®ƒå¯ä»¥ç”¨äºç®¡ç†åˆ†å¸ƒå¼ç³»ç»Ÿä¸­çš„æ•°æ®
* [Apache Zookeeper å®˜ç½‘](https://zookeeper.apache.org/releases.html)

 #### 3.5.2 å®‰è£…å¯åŠ¨ 

* 1. ä¸‹è½½ Zookeeper å®‰è£…åŒ…ï¼Œå¯ä»¥ä»[Apache Zookeeper å®˜ç½‘](https://zookeeper.apache.org/releases.html)ä¸‹è½½æœ€æ–°ç‰ˆæœ¬çš„å®‰è£…åŒ…
* 2. è§£å‹å®‰è£…åŒ…ï¼Œå°†ä¸‹è½½çš„å‹ç¼©åŒ…è§£å‹åˆ°æŒ‡å®šçš„ç›®å½•ã€‚
* 3. é…ç½®ç¯å¢ƒå˜é‡ï¼Œå°† Zookeeper å®‰è£…ç›®å½•æ·»åŠ åˆ°ç¯å¢ƒå˜é‡ä¸­
* 4. ä¿®æ”¹é…ç½®æ–‡ä»¶ï¼Œåœ¨å®‰è£…ç›®å½•ä¸‹çš„ `conf` ç›®å½•ä¸­æ‰¾åˆ° `zookeeper.properties` æ–‡ä»¶ï¼Œä¿®æ”¹ç›¸å…³é…ç½®
* 5. å¯åŠ¨ Zookeeperï¼Œåœ¨å®‰è£…ç›®å½•ä¸‹è¿è¡Œå‘½ä»¤ `bin\zkServer.cmd` å³å¯å¯åŠ¨ Zookeeper

zookeeper\\conf\\zoo.cfg

```
+dataDir=./data
```

 ### 3.6 å¯åŠ¨æœåŠ¡ 

* `logger` æ˜¯æ—¥å¿—è®°å½•å™¨ï¼Œç”¨äºè®°å½•æœåŠ¡å™¨è¿è¡Œæ—¶çš„æ—¥å¿—ä¿¡æ¯
* `registry` æ˜¯ä¸€ä¸ªæ³¨å†Œä¸­å¿ƒï¼Œç”¨äºç»´æŠ¤æœåŠ¡çš„æ³¨å†Œä¿¡æ¯ï¼Œå¸®åŠ©æœåŠ¡èŠ‚ç‚¹å’Œå®¢æˆ·ç«¯æ‰¾åˆ°å¯¹æ–¹ã€‚
* `server` è¡¨ç¤ºæœåŠ¡ç«¯ã€‚æœåŠ¡ç«¯æ˜¯æä¾›æœåŠ¡çš„èŠ‚ç‚¹ï¼Œå®ƒä¼šå°†è‡ªå·±æ‰€æä¾›çš„æœåŠ¡æ³¨å†Œåˆ°æ³¨å†Œä¸­å¿ƒï¼Œå¹¶ç­‰å¾…å®¢æˆ·ç«¯çš„è°ƒç”¨ã€‚æœåŠ¡ç«¯é€šå¸¸ä¼šå®ç°å…·ä½“çš„ä¸šåŠ¡é€»è¾‘ï¼Œå¹¶ä½¿ç”¨ `RPC` æˆ–å…¶ä»–é€šä¿¡åè®®ä¸å®¢æˆ·ç«¯è¿›è¡Œé€šä¿¡
* `server` çš„ `addService` æ–¹æ³•æ¥å—ä¸¤ä¸ªå‚æ•°ï¼šæœåŠ¡æ¥å£å’ŒæœåŠ¡å®ç°ã€‚æœåŠ¡æ¥å£æ˜¯ä¸€ä¸ªå¯¹è±¡ï¼Œå…¶ä¸­åŒ…å«äº†æœåŠ¡çš„åç§°ä¿¡æ¯ã€‚æœåŠ¡å®ç°æ˜¯ä¸€ä¸ªå¯¹è±¡ï¼Œå…¶ä¸­åŒ…å«äº†å…·ä½“å®ç°æœåŠ¡æ–¹æ³•çš„å‡½æ•°
* RPC æœåŠ¡å™¨çš„ `start` æ–¹æ³•ï¼Œç”¨äºå¯åŠ¨æœåŠ¡å™¨
* RPC æœåŠ¡å™¨çš„ `publish` æ–¹æ³•ï¼Œç”¨äºå‘æ³¨å†Œä¸­å¿ƒæ³¨å†ŒæœåŠ¡ã€‚è¿™æ ·ï¼Œå®¢æˆ·ç«¯å°±å¯ä»¥é€šè¿‡æ³¨å†Œä¸­å¿ƒè·å–æœåŠ¡çš„åœ°å€å’Œç«¯å£ï¼Œå¹¶ç›´æ¥å‘æœåŠ¡å™¨å‘èµ·è°ƒç”¨

 #### 3.6.1 å®‰è£… 

```
npm install mysql2 sofa-rpc-node --save
```

 #### 3.6.2 user\\package.json 

user\\package.json

```
{
    "name": "user",
    "version": "1.0.0",
    "description": "",
    "main": "index.js",
+ "scripts": {
+     "dev": "nodemon index.js"
+ },
    "keywords": [],
    "author": "",
    "license": "MIT",
    "dependencies": {
        "sofa-rpc-node": "^2.8.0"
    }
}
```

 #### 3.6.3 user\\index.js 

user\\index.js

```javascript
const { server: { RpcServer }, registry: { ZookeeperRegistry } } = require('sofa-rpc-node');
const mysql = require('mysql2/promise');
let connection;
// å¼•å…¥ console æ¨¡å—
const logger = console;
// åˆ›å»º Zookeeper æ³¨å†Œä¸­å¿ƒå®ä¾‹ï¼Œä¼ å…¥åœ°å€ä¸º '127.0.0.1:2181'
const registry = new ZookeeperRegistry({
    logger,
    address: '127.0.0.1:2181',
    connectTimeout: 1000 * 60 * 60 * 24,
});
// åˆ›å»º RPC æœåŠ¡å™¨å®ä¾‹ï¼Œä¼ å…¥æ³¨å†Œä¸­å¿ƒå’Œç«¯å£å·
const server = new RpcServer({
    logger,
    registry,
    port: 10000
});
// æ·»åŠ æœåŠ¡æ¥å£ï¼Œå®ç° getUserInfo æ–¹æ³•
server.addService({
    interfaceName: 'com.zhufeng.user'
}, {
    async getUserInfo(userId) {
        const [rows] = await connection.execute(`SELECT id,username,avatar,password,phone FROM user WHERE id=${userId} limit 1`);
        return rows[0];
    }
});
// å¯åŠ¨ RPC æœåŠ¡å™¨ï¼Œå¹¶å‘å¸ƒæœåŠ¡
(async function () {
    connection = await mysql.createConnection({
        host: 'localhost',
        user: 'root',
        password: 'root',
        database: 'bff'
    });
    await server.start();
    await server.publish();
     console.log(`ç”¨æˆ·å¾®æœåŠ¡å‘å¸ƒæˆåŠŸ`);
})();

```

 #### 3.6.4 client.js 

user\\client.js

```javascript
const { client: { RpcClient }, registry: { ZookeeperRegistry } } = require('sofa-rpc-node');
// è®¾ç½®æ—¥å¿—è®°å½•å™¨
const logger = console;
// åˆ›å»º Zookeeper æ³¨å†Œä¸­å¿ƒ
const registry = new ZookeeperRegistry({
    logger,
    address: '127.0.0.1:2181',
});
(async function () {
    // åˆ›å»º RPC å®¢æˆ·ç«¯
    const client = new RpcClient({ logger, registry });
    // åˆ›å»º RPC æœåŠ¡æ¶ˆè´¹è€…
    const userConsumer = client.createConsumer({
        // æŒ‡å®šæœåŠ¡æ¥å£åç§°
        interfaceName: 'com.zhufeng.user'
    });
    // ç­‰å¾…æœåŠ¡å°±ç»ª
    await userConsumer.ready();
    // è°ƒç”¨æœåŠ¡æ–¹æ³•
    const result = await userConsumer.invoke('getUserInfo', [1], { responseTimeout: 3000 });
    // è¾“å‡ºç»“æœ
    console.log(result);
    process.exit(0);
})()
```

 ## 4.åˆ›å»ºæ–‡ç« å¾®æœåŠ¡ 

 ### 4.1 å®‰è£… 

```
npm install mysql2 sofa-rpc-node --save
```

 ### 4.2 article\\package.json 

article\\package.json

```
{
    "name": "user",
    "version": "1.0.0",
    "description": "",
    "main": "index.js",
    "scripts": {
+    "dev": "nodemon index.js"
    },
    "keywords": [],
    "author": "",
    "license": "MIT",
    "dependencies": {
        "mysql2": "^2.3.3",
        "sofa-rpc-node": "^2.8.0"
    }
}
```

 ### 4.3 article\\index.js 

article\\index.js

```javascript
const { server: { RpcServer }, registry: { ZookeeperRegistry } } = require('sofa-rpc-node');
const mysql = require('mysql2/promise');
let connection;
// å¼•å…¥ console æ¨¡å—
const logger = console;
// åˆ›å»º Zookeeper æ³¨å†Œä¸­å¿ƒå®ä¾‹ï¼Œä¼ å…¥åœ°å€ä¸º '127.0.0.1:2181'
const registry = new ZookeeperRegistry({
    logger,
    address: '127.0.0.1:2181',
    connectTimeout: 1000 * 60 * 60 * 24,
});
// åˆ›å»º RPC æœåŠ¡å™¨å®ä¾‹ï¼Œä¼ å…¥æ³¨å†Œä¸­å¿ƒå’Œç«¯å£å·
const server = new RpcServer({
    logger,
    registry,
    port: 20000
});
// æ·»åŠ æœåŠ¡æ¥å£ï¼Œå®ç° getPostCount æ–¹æ³•
server.addService({
    interfaceName: 'com.zhufeng.post'
}, {
    async getPostCount(userId) {
        const [rows] = await connection.execute(`SELECT count(*) as postCount FROM post WHERE user_id=${userId} limit 1`);
        return rows[0].postCount;
    }
});
// å¯åŠ¨ RPC æœåŠ¡å™¨ï¼Œå¹¶å‘å¸ƒæœåŠ¡
(async function () {
    connection = await mysql.createConnection({
        host: 'localhost',
        user: 'root',
        password: 'root',
        database: 'bff'
    });
    await server.start();
    await server.publish();
    console.log(`æ–‡ç« å¾®æœåŠ¡å‘å¸ƒæˆåŠŸ`);
})();
```

 ### 4.4 client.js 

article\\client.js

```javascript
const { client: { RpcClient }, registry: { ZookeeperRegistry } } = require('sofa-rpc-node');
// è®¾ç½®æ—¥å¿—è®°å½•å™¨
const logger = console;
// åˆ›å»º Zookeeper æ³¨å†Œä¸­å¿ƒ
const registry = new ZookeeperRegistry({
    logger,
    address: '127.0.0.1:2181',
});
(async function () {
    // åˆ›å»º RPC å®¢æˆ·ç«¯
    const client = new RpcClient({ logger, registry });
    // åˆ›å»º RPC æœåŠ¡æ¶ˆè´¹è€…
    const consumer = client.createConsumer({
        // æŒ‡å®šæœåŠ¡æ¥å£åç§°
        interfaceName: 'com.zhufeng.post'
    });
    // ç­‰å¾…æœåŠ¡å°±ç»ª
    await consumer.ready();
    // è°ƒç”¨æœåŠ¡æ–¹æ³•
    const result = await consumer.invoke('getPostCount', [1], { responseTimeout: 3000 });
    // è¾“å‡ºç»“æœ
    console.log(result);
    process.exit(0);
})()
```

 ## 5.åˆ›å»ºBFF 

 ### 5.1 å®‰è£… 

```
npm install koa koa-router koa-logger sofa-rpc-node lru-cache ioredis amqplib fs-extra --save
```

è®¿é—®åœ°å€

```javascript
http://localhost:3000/?userId=1
```

 ### 5.2 bff\\package.json 

bff\\package.json

```
{
    "name": "bff",
    "version": "1.0.0",
    "description": "",
    "main": "index.js",
    "scripts": {
+    "dev": "nodemon index.js",
+    "start": "pm2 start index.js --name bff"
    },
    "keywords": [],
    "author": "",
    "license": "ISC",
    "dependencies": {
        "koa": "^2.14.1",
        "koa-logger": "^3.2.1",
        "koa-router": "^12.0.0",
        "sofa-rpc-node": "^2.8.0"
    }
}
```

 ### 5.3 bff\\index.js 

bff\\index.js

```javascript
const Koa = require('koa');
const router = require('koa-router')();
const logger = require('koa-logger');
const rpcMiddleware = require('./middleware/rpc');
const app = new Koa();
app.use(logger());
app.use(rpcMiddleware({
    //é…ç½® rpc ä¸­é—´ä»¶çš„å‚æ•°ï¼Œè¡¨ç¤ºè¦è°ƒç”¨çš„ rpc æ¥å£åç§°
    interfaceNames: [
        'com.zhufeng.user',
        'com.zhufeng.post'
    ]
}));
router.get('/', async ctx => {
    const userId = ctx.query.userId;
    const { rpcConsumers: { user, post } } = ctx;
    const [userInfo, postCount] = await Promise.all([
        user.invoke('getUserInfo', [userId]),
        post.invoke('getPostCount', [userId])
    ]);
    ctx.body = { userInfo, postCount }
});
app.use(router.routes()).use(router.allowedMethods());
app.listen(3000, () => {
    console.log('bff server is running at 3000');
});
```

 ### 5.4 rpc.js 

bff\\middleware\\rpc.js

```javascript
const { client: { RpcClient }, registry: { ZookeeperRegistry } } = require('sofa-rpc-node');
const rpcMiddleware = (options = {}) => {
    return async function (ctx, next) {
        const logger = options.logger || console;
        //åˆ›å»º ZookeeperRegistry ç±»çš„å®ä¾‹ï¼Œç”¨äºç®¡ç†æœåŠ¡å‘ç°å’Œæ³¨å†Œ
        const registry = new ZookeeperRegistry({
            logger,
            address: options.address || '127.0.0.1:2181',
        });
        //åˆ›å»º RpcClient ç±»çš„å®ä¾‹ï¼Œç”¨äºå‘é€ rpc è¯·æ±‚
        const client = new RpcClient({ logger, registry });
        const interfaceNames = options.interfaceNames || [];
        const rpcConsumers = {};
        for (let i = 0; i < interfaceNames.length; i++) {
            const interfaceName = interfaceNames[i];
            //ä½¿ç”¨ RpcClient çš„ createConsumer æ–¹æ³•åˆ›å»º rpc æ¶ˆè´¹è€…
            const consumer = client.createConsumer({
                interfaceName,
            });
            //ç­‰å¾… rpc æ¶ˆè´¹è€…å‡†å¤‡å®Œæ¯•
            await consumer.ready();
            rpcConsumers[interfaceName.split('.').pop()] = consumer;
        }
        ctx.rpcConsumers = rpcConsumers;
        await next();
    }
};
module.exports = rpcMiddleware;
```

 ### 5.5 bff\\index.js 

æ•°æ®å¤„ç†

```
const Koa = require('koa');
const router = require('koa-router')();
const logger = require('koa-logger');
const rpcMiddleware = require('./middleware/rpc');
const app = new Koa();
app.use(logger());
app.use(rpcMiddleware({
    interfaceNames: [
        'com.zhufeng.user',
        'com.zhufeng.post'
    ]
}));
router.get('/', async ctx => {
    const userId = ctx.query.userId;
    const { rpcConsumers: { user, post } } = ctx;
    const [userInfo, postCount] = await Promise.all([
        user.invoke('getUserInfo', [userId]),
        post.invoke('getPostCount', [userId])
    ]);
+ // è£å‰ªæ•°æ®
+ delete userInfo.password;
+ // æ•°æ®è„±æ•
+ userInfo.phone = userInfo.phone.replace(/(\d{3})\d{4}(\d{4})/, '$1****$2');
+ // æ•°æ®é€‚é…
+ userInfo.avatar = "http://www.zhufengpeixun.cn/"+userInfo.avatar,
    ctx.body = { userInfo, postCount }
});
app.use(router.routes()).use(router.allowedMethods());
app.listen(3000, () => {
    console.log('bff server is running at 3000');
});
```

 ## 6.ç¼“å­˜ 

* BFF ä½œä¸ºå‰ç«¯åº”ç”¨å’Œåç«¯ç³»ç»Ÿä¹‹é—´çš„æŠ½è±¡å±‚ï¼Œæ‰¿æ‹…äº†å¤§é‡çš„è¯·æ±‚è½¬å‘å’Œæ•°æ®è½¬æ¢å·¥ä½œã€‚ä½¿ç”¨å¤šçº§ç¼“å­˜å¯ä»¥å¸®åŠ© BFF å‡å°‘å¯¹åç«¯ç³»ç»Ÿçš„è®¿é—®ï¼Œä»è€Œæé«˜åº”ç”¨çš„å“åº”é€Ÿåº¦
* å½“ BFF æ”¶åˆ°ä¸€ä¸ªè¯·æ±‚æ—¶ï¼Œé¦–å…ˆä¼šæ£€æŸ¥å†…å­˜ç¼“å­˜ä¸­æ˜¯å¦å­˜åœ¨å¯¹åº”çš„æ•°æ®ï¼Œå¦‚æœæœ‰å°±ç›´æ¥è¿”å›æ•°æ®ã€‚å¦‚æœå†…å­˜ç¼“å­˜ä¸­æ²¡æœ‰æ•°æ®ï¼Œå°±ä¼šæ£€æŸ¥Redisç¼“å­˜ï¼Œå¦‚æœRedisç¼“å­˜ä¸­æœ‰æ•°æ®å°±è¿”å›æ•°æ®ï¼Œå¹¶å°†æ•°æ®å†™å…¥å†…å­˜ç¼“å­˜ã€‚å¦‚æœæœ¬åœ°ç¼“å­˜ä¸­ä¹Ÿæ²¡æœ‰æ•°æ®ï¼Œå°±ä¼šå‘åç«¯ç³»ç»Ÿå‘èµ·è¯·æ±‚ï¼Œå¹¶å°†æ•°æ®å†™å…¥Redisç¼“å­˜å’Œå†…å­˜ç¼“å­˜

 ### 6.1 å¤šçº§ç¼“å­˜ 

* å¤šçº§ç¼“å­˜ï¼ˆmulti-level cacheï¼‰æ˜¯æŒ‡ç³»ç»Ÿä¸­ä½¿ç”¨äº†å¤šä¸ªç¼“å­˜å±‚æ¥å­˜å‚¨æ•°æ®çš„æŠ€æœ¯ã€‚è¿™äº›ç¼“å­˜å±‚çš„ä¼˜å…ˆçº§é€šå¸¸æ˜¯ä¾æ¬¡é€’å‡çš„ï¼Œå³æœ€å¿«çš„ç¼“å­˜å±‚ä½äºæœ€é¡¶å±‚ï¼Œæœ€æ…¢çš„ç¼“å­˜å±‚ä½äºæœ€åº•å±‚

 ### 6.2 LRU 

* LRUï¼ˆLeast Recently Usedï¼‰æ˜¯ä¸€ç§å¸¸ç”¨çš„é«˜é€Ÿç¼“å­˜æ·˜æ±°ç®—æ³•ï¼Œå®ƒçš„åŸç†æ˜¯å°†æœ€è¿‘ä½¿ç”¨è¿‡çš„æ•°æ®æˆ–é¡µé¢ä¿ç•™åœ¨ç¼“å­˜ä¸­ï¼Œè€Œæœ€å°‘ä½¿ç”¨çš„æ•°æ®æˆ–é¡µé¢å°†è¢«æ·˜æ±°ã€‚è¿™æ ·åšçš„ç›®çš„æ˜¯ä¸ºäº†æœ€å¤§åŒ–ç¼“å­˜çš„å‘½ä¸­ç‡ï¼Œå³ä½¿ç”¨ç¼“å­˜å°½å¯èƒ½å¤šåœ°æ»¡è¶³ç”¨æˆ·çš„è¯·æ±‚

 ### 6.3 redis 

* Redis æ˜¯ä¸€ç§å¼€æºçš„å†…å­˜æ•°æ®å­˜å‚¨ç³»ç»Ÿï¼Œå¯ä»¥ä½œä¸ºæ•°æ®åº“ã€ç¼“å­˜å’Œæ¶ˆæ¯ä¸­é—´ä»¶ä½¿ç”¨
* Redis è¿è¡Œåœ¨å†…å­˜ä¸­ï¼Œå› æ­¤å®ƒçš„è¯»å†™é€Ÿåº¦éå¸¸å¿«
* `ioredis` æ˜¯ä¸€ä¸ªåŸºäº Node.js çš„ Redis å®¢æˆ·ç«¯ï¼Œæä¾›äº†å¯¹ Redis å‘½ä»¤çš„é«˜åº¦å°è£…å’Œæ”¯æŒ
* [redis](https://github.com/tporadowski/redis/releases)
* [Redis-x64-5.0.14.1](https://static.zhufengpeixun.com/Redisx6450141_1673102444438.zip)

 ### 6.4 ä½¿ç”¨ç¼“å­˜ 

 #### 6.4.1 bff\\index.js 

bff\\index.js

```
const Koa = require('koa');
const router = require('koa-router')();
const logger = require('koa-logger');
const rpcMiddleware = require('./middleware/rpc');
+const cacheMiddleware = require('./middleware/cache');
const app = new Koa();
app.use(logger());
app.use(rpcMiddleware({
    interfaceNames: [
        'com.zhufeng.user',
        'com.zhufeng.post'
    ]
}));
+app.use(cacheMiddleware({}));
router.get('/profile', async ctx => {
    const userId = ctx.query.userId;
    const { rpcConsumers: { user, post } } = ctx;
 + const cacheKey = `${ctx.method}#${ctx.path}
+ let cacheData = await ctx.cache.get(cacheKey);
+ if (cacheData) {
+     ctx.body = cacheData;
+     return;
+ }
    const [userInfo, postCount] = await Promise.all([
        user.invoke('getUserInfo', [userId]),
        post.invoke('getPostCount', [userId])
    ]);
  // è£å‰ªæ•°æ®
  delete userInfo.password;
  // æ•°æ®è„±æ•
  userInfo.phone = userInfo.phone.replace(/(\d{3})\d{4}(\d{4})/, '$1****$2');
  // æ•°æ®é€‚é…
  userInfo.avatar = "http://www.zhufengpeixun.cn/" + userInfo.avatar;
+ cacheData = { userInfo, postCount };
+ await ctx.cache.set(cacheKey, cacheData);// keys *
+ ctx.body = cacheData
});
app.use(router.routes()).use(router.allowedMethods());
app.listen(3000, () => {
    console.log('bff server is running at 3000');
});
```

 #### 6.4.2 cache.js 

bff\\middleware\\cache.js

```javascript
const LRUCache = require('lru-cache');
const Redis = require('ioredis');
class CacheStore {
    constructor() {
        this.stores = [];
    }
    add(store) {
        this.stores.push(store);
        return this;
    }
    async get(key) {
        for (const store of this.stores) {
            const value = await store.get(key);
            if (value !== undefined) {
                return value;
            }
        }
    }
    async set(key, value) {
        for (const store of this.stores) {
            await store.set(key, value);
        }
    }
}
class MemoryStore {
    constructor() {
        this.cache = new LRUCache({
            max: 100,
            ttl: 1000 * 60 * 60 * 24
        });
    }
    async get(key) {
        return this.cache.get(key);
    }
    async set(key, value) {
        this.cache.set(key, value);
    }
}
class RedisStore {
    constructor(options) {
        this.client = new Redis(options);
    }
    async get(key) {
        let value = await this.client.get(key);
        return value ? JSON.parse(value) : undefined;
    }
    async set(key, value) {
        await this.client.set(key, JSON.stringify(value));
    }
}
const cacheMiddleware = (options = {}) => {
    return async function (ctx, next) {
        const cacheStore = new CacheStore();
        cacheStore.add(new MemoryStore());
        const redisStore = new RedisStore(options);
        cacheStore.add(redisStore);
        ctx.cache = cacheStore;
        await next();
    };
};
module.exports = cacheMiddleware;
```

 ## 7.æ¶ˆæ¯é˜Ÿåˆ— 

* æ¶ˆæ¯é˜Ÿåˆ—ï¼ˆMessage Queueï¼‰ç”¨äºåœ¨åˆ†å¸ƒå¼ç³»ç»Ÿä¸­ä¼ é€’æ•°æ®ã€‚å®ƒçš„ç‰¹ç‚¹æ˜¯å¯ä»¥å°†æ¶ˆæ¯å‘é€è€…å’Œæ¥æ”¶è€…è§£è€¦ï¼Œä½¿å¾—æ¶ˆæ¯ç”Ÿäº§è€…å’Œæ¶ˆæ¯æ¶ˆè´¹è€…å¯ä»¥ç‹¬ç«‹çš„å¼€å‘å’Œéƒ¨ç½²

 ### 7.1 å¼•å…¥åŸå›  

* åœ¨ BFF ä¸­ä½¿ç”¨æ¶ˆæ¯é˜Ÿåˆ—ï¼ˆmessage queueï¼‰æœ‰å‡ ä¸ªåŸå› ï¼š
  * å¤§å¹¶å‘ï¼šæ¶ˆæ¯é˜Ÿåˆ—å¯ä»¥å¸®åŠ©åº”å¯¹å¤§å¹¶å‘çš„è¯·æ±‚ï¼ŒBFF å¯ä»¥å°†è¯·æ±‚å†™å…¥æ¶ˆæ¯é˜Ÿåˆ—ï¼Œç„¶ååç«¯æœåŠ¡å¯ä»¥ä»æ¶ˆæ¯é˜Ÿåˆ—ä¸­è¯»å–è¯·æ±‚å¹¶å¤„ç†
  * è§£è€¦ï¼šæ¶ˆæ¯é˜Ÿåˆ—å¯ä»¥å¸®åŠ©è§£è€¦ BFF å’Œåç«¯æœåŠ¡ï¼ŒBFF ä¸éœ€è¦å…³å¿ƒåç«¯æœåŠ¡çš„å…·ä½“å®ç°ï¼Œåªéœ€è¦å°†è¯·æ±‚å†™å…¥æ¶ˆæ¯é˜Ÿåˆ—ï¼Œåç«¯æœåŠ¡è´Ÿè´£ä»æ¶ˆæ¯é˜Ÿåˆ—ä¸­è¯»å–è¯·æ±‚å¹¶å¤„ç†
  * å¼‚æ­¥ï¼šæ¶ˆæ¯é˜Ÿåˆ—å¯ä»¥å¸®åŠ©å®ç°å¼‚æ­¥è°ƒç”¨ï¼ŒBFF å¯ä»¥å°†è¯·æ±‚å†™å…¥æ¶ˆæ¯é˜Ÿåˆ—ï¼Œç„¶åç«‹å³è¿”å›å“åº”ç»™å‰ç«¯åº”ç”¨ï¼Œåç«¯æœåŠ¡åœ¨åå°å¤„ç†è¯·æ±‚
    * æµé‡å‰Šå³°ï¼šæ¶ˆæ¯é˜Ÿåˆ—å¯ä»¥å¸®åŠ©æµé‡å‰Šå³°ï¼ŒBFF å¯ä»¥å°†è¯·æ±‚å†™å…¥æ¶ˆæ¯é˜Ÿåˆ—ï¼Œç„¶ååç«¯æœåŠ¡å¯ä»¥åœ¨åˆé€‚çš„æ—¶å€™å¤„ç†è¯·æ±‚ï¼Œä»è€Œç¼“è§£ç¬æ—¶é«˜å³°æµé‡å¸¦æ¥çš„å‹åŠ›

 ### 7.2 RabbitMQ 

* `RabbitMQ`æ˜¯ä¸€ä¸ªæ¶ˆæ¯ä»£ç†ï¼Œå®ƒå¯ä»¥ç”¨æ¥åœ¨æ¶ˆæ¯ç”Ÿäº§è€…å’Œæ¶ˆæ¯æ¶ˆè´¹è€…ä¹‹é—´ä¼ é€’æ¶ˆæ¯
* RabbitMQçš„å·¥ä½œæµç¨‹å¦‚ä¸‹ï¼š
  * æ¶ˆæ¯ç”Ÿäº§è€…å°†æ¶ˆæ¯å‘é€åˆ°`RabbitMQ`æœåŠ¡å™¨
  * `RabbitMQ`æœåŠ¡å™¨å°†æ¶ˆæ¯ä¿å­˜åˆ°é˜Ÿåˆ—ä¸­
  * æ¶ˆæ¯æ¶ˆè´¹è€…ä»é˜Ÿåˆ—ä¸­è¯»å–æ¶ˆæ¯
  * å½“æ¶ˆæ¯æ¶ˆè´¹è€…å¤„ç†å®Œæ¶ˆæ¯å`RabbitMQ`æœåŠ¡å™¨å°†æ¶ˆæ¯åˆ é™¤
* å®‰è£…å¯åŠ¨
   * åœ¨RabbitMQä¸‹è½½[å®˜ç½‘å®‰è£…åŒ…](https://www.rabbitmq.com/install-windows.html
  * åŒå‡»å®‰è£…åŒ…ï¼ŒæŒ‰ç…§æç¤ºè¿›è¡Œå®‰è£…,ç›´æ¥å°±å¯ä»¥å¯åŠ¨
    * å®‰è£…å‰è¿˜è¦å®‰è£…[Erlang](https://www.erlang.org/downloads),Erlangæ˜¯ä¸€ä¸ªç»“æ„åŒ–ï¼ŒåŠ¨æ€ç±»å‹ç¼–ç¨‹è¯­è¨€ï¼Œå†…å»ºå¹¶è¡Œè®¡ç®—æ”¯æŒ

 ### 7.3 å®ç° 

 #### 7.3.2 bff\\index.js 

bff\\index.js

```
const Koa = require('koa');
const router = require('koa-router')();
const logger = require('koa-logger');
const rpcMiddleware = require('./middleware/rpc');
const cacheMiddleware = require('./middleware/cache');
+const mqMiddleware = require('./middleware/mq');
const app = new Koa();
app.use(logger());
app.use(rpcMiddleware({
    interfaceNames: [
        'com.zhufeng.user',
        'com.zhufeng.post'
    ]
}));
app.use(cacheMiddleware({}));
+app.use(mqMiddleware({ url: 'amqp://localhost' }));
router.get('/profile', async ctx => {
    const userId = ctx.query.userId;
+    ctx.channels.logger.sendToQueue('logger', Buffer.from(JSON.stringify({
+        method: ctx.method,
+        path: ctx.path,
+        userId
+    })));
    const { rpcConsumers: { user, post } } = ctx;
     const cacheKey = `${ctx.method}#${ctx.path}
    let cacheData = await ctx.cache.get(cacheKey);
    if (cacheData) {
        ctx.body = cacheData;
        return;
    }
    const [userInfo, postCount] = await Promise.all([
        user.invoke('getUserInfo', [userId]),
        post.invoke('getPostCount', [userId])
    ]);
      // è£å‰ªæ•°æ®
  delete userInfo.password;
  // æ•°æ®è„±æ•
  userInfo.phone = userInfo.phone.replace(/(\d{3})\d{4}(\d{4})/, '$1****$2');
  // æ•°æ®é€‚é…
  userInfo.avatar = "http://www.zhufengpeixun.cn/" + userInfo.avatar,
    cacheData = { userInfo, postCount };
  await ctx.cache.set(cacheKey, cacheData);// keys *
  ctx.body = cacheData
});
app.use(router.routes()).use(router.allowedMethods());
app.listen(3000, () => {
    console.log('bff server is running at 3000');
});
```

 #### 7.3.2 mq.js 

bff\\middleware\\mq.js

```javascript
const amqp = require('amqplib');
const mqMiddleware = (options = {}) => {
    return async (ctx, next) => {
        //ä½¿ç”¨ amqp.connect æ–¹æ³•è¿æ¥ RabbitMQ æœåŠ¡å™¨
        const rabbitMQClient = await amqp.connect(options.url || 'amqp://localhost');
        //ä½¿ç”¨ rabbitMQClient çš„ createChannel æ–¹æ³•åˆ›å»º RabbitMQ é€šé“
        const logger = await rabbitMQClient.createChannel();
        //ä½¿ç”¨ logger çš„ assertQueue æ–¹æ³•åˆ›å»ºåä¸º "logger" çš„é˜Ÿåˆ—ï¼Œå¦‚æœé˜Ÿåˆ—å·²ç»å­˜åœ¨åˆ™ä¸ä¼šé‡å¤åˆ›å»º
        await logger.assertQueue('logger');
        ctx.channels = {
            logger
        };
        await next();
    };
};
module.exports = mqMiddleware;
```

 #### 7.3.3 bff\\logger.js 

bff\\logger.js

```javascript
const amqplib = require('amqplib');
const fs = require('fs-extra');
const path = require('path');
(async () => {
    const conn = await amqplib.connect('amqp://localhost');
    const loggerChannel = await conn.createChannel();
    await loggerChannel.assertQueue('logger');
    loggerChannel.consume('logger', async (event) => {
        const message = JSON.parse(event.content.toString());
        await fs.appendFile(path.join(__dirname, 'logger.txt'), JSON.stringify(message) + '\n');
    });
})();
```

 ## 8.Serverless 

 ### 8.1 BFFé—®é¢˜ 

* å¤æ‚æ€§å¢åŠ ï¼šæ·»åŠ  BFF å±‚ä¼šå¢åŠ ç³»ç»Ÿçš„å¤æ‚æ€§ï¼Œå› ä¸ºå®ƒéœ€è¦åœ¨åç«¯ API å’Œå‰ç«¯åº”ç”¨ç¨‹åºä¹‹é—´å¤„ç†è¯·æ±‚å’Œå“åº”
* æ€§èƒ½é—®é¢˜ï¼šå¦‚æœ BFF å±‚çš„å®ç°ä¸å½“ï¼Œå¯èƒ½ä¼šå¯¼è‡´æ€§èƒ½é—®é¢˜ï¼Œå› ä¸ºå®ƒéœ€è¦åœ¨åç«¯ API å’Œå‰ç«¯åº”ç”¨ç¨‹åºä¹‹é—´ä¼ è¾“å¤§é‡æ•°æ®
* å®‰å…¨é£é™©ï¼šå¦‚æœ BFF å±‚æœªå¾—åˆ°æ­£ç¡®ä¿æŠ¤ï¼Œå¯èƒ½ä¼šå¯¼è‡´å®‰å…¨é£é™©ï¼Œå› ä¸ºå®ƒå¯èƒ½ä¼šæš´éœ²æ•æ„Ÿæ•°æ®
* ç»´æŠ¤æˆæœ¬ï¼šBFF å±‚éœ€è¦ç»´æŠ¤å’Œæ›´æ–°ï¼Œè¿™ä¼šå¢åŠ ç»´æŠ¤æˆæœ¬
* æµ‹è¯•å¤æ‚æ€§ï¼šç”±äº BFF å±‚éœ€è¦åœ¨åç«¯ API å’Œå‰ç«¯åº”ç”¨ç¨‹åºä¹‹é—´è¿›è¡Œæµ‹è¯•ï¼Œå› æ­¤æµ‹è¯•å¯èƒ½ä¼šå˜å¾—æ›´åŠ å¤æ‚
* è¿ç»´é—®é¢˜ è¦æ±‚æœ‰å¼ºå¤§çš„æ—¥å¿—ã€æœåŠ¡å™¨ç›‘æ§ã€æ€§èƒ½ç›‘æ§ã€è´Ÿè½½å‡è¡¡ã€å¤‡ä»½å†—ç¾ã€ç›‘æ§æŠ¥è­¦å’Œå¼¹æ€§ä¼¸ç¼©æ‰©å®¹ç­‰

 ### 8.2 Serverless 

* è¿™äº›é—®é¢˜å¯ä»¥é€šè¿‡[Serverless](https://docs.cloudbase.net/)æ¥è§£å†³
* Serverless = Faas (Function as a service) + Baas (Backend as a service)
* FaaSï¼ˆFunction-as-a-Serviceï¼‰æ˜¯æœåŠ¡å•†æä¾›ä¸€ä¸ªå¹³å°ã€æä¾›ç»™ç”¨æˆ·å¼€å‘ã€è¿è¡Œç®¡ç†è¿™äº›å‡½æ•°çš„åŠŸèƒ½ï¼Œè€Œæ— éœ€æ­å»ºå’Œç»´æŠ¤åŸºç¡€æ¡†æ¶ï¼Œæ˜¯ä¸€ç§äº‹ä»¶é©±åŠ¨ç”±æ¶ˆæ¯è§¦å‘çš„å‡½æ•°æœåŠ¡
* BaaSï¼ˆBackend-as-a-Serviceï¼‰åç«¯å³æœåŠ¡ï¼ŒåŒ…å«äº†åç«¯æœåŠ¡ç»„ä»¶ï¼Œå®ƒæ˜¯åŸºäº API çš„ç¬¬ä¸‰æ–¹æœåŠ¡ï¼Œç”¨äºå®ç°åº”ç”¨ç¨‹åºä¸­çš„æ ¸å¿ƒåŠŸèƒ½ï¼ŒåŒ…å«å¸¸ç”¨çš„æ•°æ®åº“ã€å¯¹è±¡å­˜å‚¨ã€æ¶ˆæ¯é˜Ÿåˆ—ã€æ—¥å¿—æœåŠ¡ç­‰ç­‰

![](https://static.zhufengpeixun.com/fassbass_1673160507846.png)

![](https://static.zhufengpeixun.com/Serverless_1673160406503.png)

 ### 8.3 Serverlessçš„ä¼˜åŠ¿ 

* èŠ‚çœæˆæœ¬ï¼šåœ¨ä¼ ç»Ÿæ¶æ„ä¸­ï¼Œä½ éœ€è¦ä¸ºåº”ç”¨ç¨‹åºæ‰€ä½¿ç”¨çš„æœåŠ¡å™¨ä»˜è´¹ï¼Œå³ä½¿å®ƒä»¬æ²¡æœ‰è¢«ä½¿ç”¨ã€‚åœ¨ Serverless æ¶æ„ä¸­ï¼Œä½ ä»…éœ€ä¸ºå®é™…ä½¿ç”¨çš„èµ„æºä»˜è´¹ï¼Œè¿™å¯ä»¥èŠ‚çœå¤§é‡æˆæœ¬
* æ›´å¿«çš„å¼€å‘å‘¨æœŸï¼šServerless æ¶æ„å…è®¸å¼€å‘äººå‘˜æ›´å¿«åœ°æ„å»ºå’Œéƒ¨ç½²åº”ç”¨ç¨‹åºï¼Œå› ä¸ºå®ƒä»¬å¯ä»¥æ›´å¿«åœ°è·å¾—æ‰€éœ€çš„èµ„æº
* æ›´å¥½çš„å¯ä¼¸ç¼©æ€§ï¼šServerless æ¶æ„å¯ä»¥è‡ªåŠ¨æ‰©å±•æ¥æ»¡è¶³å¢é•¿çš„æµé‡éœ€æ±‚ï¼Œæ— éœ€äººå·¥å¹²é¢„
* æ›´å¥½çš„å¯ç»´æŠ¤æ€§ï¼šåœ¨ Serverless æ¶æ„ä¸­ï¼Œä½ æ— éœ€æ‹…å¿ƒåº•å±‚åŸºç¡€æ¶æ„çš„ç»´æŠ¤ï¼Œå› ä¸ºè¿™äº›å·¥ä½œç”±äº‘æœåŠ¡æä¾›å•†è´Ÿè´£
* æ›´é«˜çš„å¯ç”¨æ€§ï¼šç”±äº Serverless æ¶æ„å…·æœ‰è‡ªåŠ¨æ‰©å±•åŠŸèƒ½ï¼Œå› æ­¤å®ƒå¯ä»¥æ›´å¥½åœ°åº”å¯¹çªå‘æµé‡ï¼Œä»è€Œæé«˜åº”ç”¨ç¨‹åºçš„å¯ç”¨æ€§

 ### 8.4 Serverlessçš„ç¼ºç‚¹ 

* å¤æ‚æ€§ï¼šServerless æ¶æ„å¯èƒ½ä¼šä½¿åº”ç”¨ç¨‹åºçš„ä½“ç³»ç»“æ„å˜å¾—æ›´åŠ å¤æ‚ï¼Œå› ä¸ºå®ƒéœ€è¦å°†åº”ç”¨ç¨‹åºæ‹†åˆ†ä¸ºè®¸å¤šå°å‹å‡½æ•°
* æ€§èƒ½é—®é¢˜ï¼šåœ¨æŸäº›æƒ…å†µä¸‹ï¼ŒServerless æ¶æ„å¯èƒ½ä¼šå¯¼è‡´æ€§èƒ½é—®é¢˜ï¼Œå› ä¸ºå‡½æ•°æ‰§è¡Œéœ€è¦é¢å¤–çš„æ—¶é—´æ¥å¯åŠ¨å’Œç»ˆæ­¢
* é™åˆ¶ï¼šæ¯ä¸ªå‡½æ•°éƒ½æœ‰èµ„æºé™åˆ¶ï¼Œå› æ­¤éœ€è¦ä»”ç»†è§„åˆ’åº”ç”¨ç¨‹åºçš„ä½“ç³»ç»“æ„ï¼Œä»¥å…è¶…å‡ºè¿™äº›é™åˆ¶
* ä¾èµ–äº‘æœåŠ¡æä¾›å•†ï¼šä½¿ç”¨ Serverless æ¶æ„éœ€è¦ä¾èµ–äº‘æœåŠ¡æä¾›å•†ï¼Œå› æ­¤å¦‚æœè¿™äº›æœåŠ¡å‡ºç°æ•…éšœï¼Œå¯èƒ½ä¼šå¯¹åº”ç”¨ç¨‹åºé€ æˆå½±å“
* è°ƒè¯•å›°éš¾ï¼šç”±äº Serverless æ¶æ„ä½¿ç”¨è®¸å¤šå°å‹å‡½æ•°ï¼Œå› æ­¤è°ƒè¯•å¯èƒ½ä¼šå˜å¾—æ›´åŠ å›°éš¾

 ## 9.GraphQL 

* `GraphQL`æ˜¯ä¸€ç§ç”¨äºAPIçš„æŸ¥è¯¢è¯­è¨€ï¼Œå®ƒå…è®¸å®¢æˆ·ç«¯å‘æœåŠ¡ç«¯è¯·æ±‚ç‰¹å®šçš„æ•°æ®ï¼Œè€Œä¸æ˜¯æœåŠ¡ç«¯å°†æ‰€æœ‰å¯èƒ½çš„æ•°æ®å…¨éƒ¨è¿”å›ã€‚è¿™æ ·ï¼Œå®¢æˆ·ç«¯å¯ä»¥æ›´ç²¾ç¡®åœ°è·å–æ‰€éœ€çš„æ•°æ®ï¼Œå¹¶ä¸”æœåŠ¡ç«¯å¯ä»¥æ›´æœ‰æ•ˆåœ°æ»¡è¶³è¯·æ±‚
* `GraphQL`å¯ä»¥è®©å®¢æˆ·ç«¯è‡ªå·±å®šä¹‰æ‰€éœ€çš„æ•°æ®ç»“æ„ï¼Œå¯ä»¥çµæ´»åœ°è·å–æ‰€éœ€çš„æ•°æ®ã€‚è¿™å¯¹äºå¤šç«¯åº”ç”¨æ¥è¯´éå¸¸æ–¹ä¾¿ï¼Œå› ä¸ºæ¯ä¸€ä¸ªå®¢æˆ·ç«¯å¯èƒ½æœ‰ä¸åŒçš„æ•°æ®éœ€æ±‚ï¼Œä½¿ç”¨GraphQLå¯ä»¥è®©æ¯ä¸ªå®¢æˆ·ç«¯è‡ªå·±å®šä¹‰æ‰€éœ€çš„æ•°æ®ç»“æ„
* `GraphQL`å¯ä»¥è®©BFFæœåŠ¡å±‚ä»ä¸åŒçš„æ•°æ®æºè·å–æ•°æ®ï¼Œå¹¶å°†å®ƒä»¬ç»„åˆèµ·æ¥è¿”å›ç»™å®¢æˆ·ç«¯ã€‚è¿™å¯¹äºåœ¨BFFæ¶æ„ä¸­æ›´å¥½åœ°ç»„ç»‡æ•°æ®æ˜¯å¾ˆæœ‰å¸®åŠ©çš„ï¼Œå› ä¸ºä½ å¯ä»¥åœ¨BFFå±‚ä¸­ç»„åˆæ¥è‡ªä¸åŒæ•°æ®æºçš„æ•°æ®ï¼Œè€Œä¸ç”¨åœ¨å®¢æˆ·ç«¯ä¸­å†åšä¸€æ¬¡ç»„åˆ

 ### 9.1 Apollo Server 

* `Apollo Server`æ˜¯ä¸€ä¸ªç”¨äºæ„å»ºGraphQL APIçš„å¼€æºæœåŠ¡å™¨æ¡†æ¶ã€‚å®ƒæ”¯æŒå¤šç§ç¼–ç¨‹è¯­è¨€ï¼Œå…è®¸ä½ ä½¿ç”¨åŒä¸€ç§æ–¹å¼æ¥è®¿é—®ä¸åŒçš„åç«¯æ•°æ®æºï¼Œå¹¶ä¸”å…·æœ‰è‰¯å¥½çš„æ‰©å±•æ€§
* `Apollo Server`æ˜¯ä¸€ç§å®ç°GraphQLæœåŠ¡ç«¯çš„æ–¹æ³•ï¼Œå®ƒæä¾›äº†ä¸€äº›å·¥å…·å’ŒåŠŸèƒ½ï¼Œå¸®åŠ©ä½ æ›´è½»æ¾åœ°æ„å»ºå’Œéƒ¨ç½²GraphQL APIã€‚å®ƒè¿˜æä¾›äº†ä¸€äº›é¢å¤–çš„åŠŸèƒ½ï¼Œå¦‚ç¼“å­˜ã€èº«ä»½éªŒè¯å’Œæ¨¡æ‹Ÿæ•°æ®ï¼Œå¸®åŠ©ä½ æ›´å¿«é€Ÿåœ°å¼€å‘å’Œæµ‹è¯•ä½ çš„API

 ### 9.2 GraphQL schema language 

* [schema](https://graphql.org/learn/schema/)
* `GraphQL schema language`æ˜¯ä¸€ç§ç”¨æ¥å®šä¹‰GraphQL APIçš„è¯­è¨€ã€‚å®ƒå¯ä»¥ç”¨æ¥æè¿°APIä¸­å¯ç”¨çš„æ•°æ®å’Œæ“ä½œï¼ŒåŒ…æ‹¬æ”¯æŒçš„æŸ¥è¯¢ã€å˜æ›´ã€è®¢é˜…ç­‰åŠŸèƒ½
* `GraphQL schema`ç”±ä¸€ç³»åˆ—çš„ç±»å‹ç»„æˆï¼Œæ¯ç§ç±»å‹éƒ½æœ‰ä¸€ä¸ªåç§°å’Œä¸€äº›å­—æ®µã€‚æ¯ä¸ªå­—æ®µéƒ½æœ‰ä¸€ä¸ªåç§°å’Œç±»å‹ï¼Œå¹¶å¯èƒ½æœ‰ä¸€äº›é¢å¤–çš„é™åˆ¶ï¼Œæ¯”å¦‚æ˜¯å¦æ˜¯å¿…å¡«çš„æˆ–è€…æœ‰é»˜è®¤å€¼

 ### 9.3 resolvers 

* [resolvers](https://www.apollographql.com/docs/apollo-server/data/resolvers/)
* åœ¨GraphQLä¸­ï¼Œ`resolvers`æ˜¯è´Ÿè´£è§£ææ¯ä¸ªå­—æ®µçš„å‡½æ•°ã€‚åœ¨Apollo Serverä¸­ï¼Œä½ å¯ä»¥ä½¿ç”¨resolverså¯¹è±¡æ¥å®šä¹‰è¿™äº›å‡½æ•°
* `resolvers`å¯¹è±¡æ˜¯ä¸€ä¸ªåŒ…å«äº†æ‰€æœ‰è§£æå™¨å‡½æ•°çš„å¯¹è±¡ã€‚å®ƒçš„ç»“æ„ä¸ä½ åœ¨schemaä¸­å®šä¹‰çš„ç±»å‹çš„ç»“æ„æ˜¯ä¸€æ ·çš„
* é™¤äº†å®šä¹‰è§£æå™¨å‡½æ•°ä»¥å¤–ï¼Œä½ è¿˜å¯ä»¥åœ¨resolverså¯¹è±¡ä¸­å®šä¹‰è‡ªå®šä¹‰æ“ä½œï¼Œä¾‹å¦‚æŸ¥è¯¢ã€å˜æ›´ã€è®¢é˜…ç­‰ã€‚è¿™äº›æ“ä½œçš„è§£æå™¨å‡½æ•°ä¸å­—æ®µçš„è§£æå™¨å‡½æ•°çš„å®šä¹‰æ–¹å¼æ˜¯ä¸€æ ·çš„ï¼Œåªæ˜¯å‡½æ•°åç§°ä¸åŒè€Œå·²

 ### 9.4 ApolloServerç¤ºä¾‹ 

* `gql`å‡½æ•°æ˜¯ä¸€ä¸ª`template tag`ï¼Œä½ å¯ä»¥å°†å®ƒæ”¾åœ¨æ¨¡æ¿å­—ç¬¦ä¸²çš„å‰é¢ï¼Œç„¶ååœ¨æ¨¡æ¿å­—ç¬¦ä¸²ä¸­ç¼–å†™GraphQL schema languageçš„ä»£ç ,å¯ä»¥å®šä¹‰æŸ¥è¯¢å’Œå˜æ›´æ“ä½œ
* resolverså‡½æ•°å‚æ•°
  * objï¼šè¡¨ç¤ºå½“å‰æŸ¥è¯¢çš„çˆ¶å¯¹è±¡ã€‚ä¾‹å¦‚ï¼Œå¦‚æœä½ åœ¨æŸ¥è¯¢"user"ç±»å‹çš„å¯¹è±¡ï¼Œé‚£ä¹ˆobjå°±è¡¨ç¤ºå½“å‰æŸ¥è¯¢çš„"user"å¯¹è±¡
  * argsï¼šè¡¨ç¤ºå½“å‰æŸ¥è¯¢çš„å‚æ•°ã€‚ä¾‹å¦‚ï¼Œå¦‚æœä½ åœ¨æŸ¥è¯¢å¸¦æœ‰å‚æ•°çš„å­—æ®µï¼Œé‚£ä¹ˆargså°±è¡¨ç¤ºè¿™äº›å‚æ•°
  * contextï¼šè¡¨ç¤ºå½“å‰çš„ä¸Šä¸‹æ–‡å¯¹è±¡ï¼Œå¯ä»¥åœ¨æ•´ä¸ªæŸ¥è¯¢ä¸­ä¼ é€’ç»™æ‰€æœ‰çš„resolver
  * infoï¼šè¡¨ç¤ºå½“å‰çš„æŸ¥è¯¢ä¿¡æ¯ï¼ŒåŒ…æ‹¬æŸ¥è¯¢å­—ç¬¦ä¸²ã€æŸ¥è¯¢æ“ä½œï¼ˆquery/mutationï¼‰ã€æŸ¥è¯¢å­—æ®µç­‰

```javascript
const { ApolloServer, gql } = require('apollo-server');
const typeDefs = gql`
  type Query {
    users: [User]
    user(id: ID): User
  }
  type Mutation {
    createUser(username: String, age: Int): User
    updateUser(id: ID, username: String, age: Int): Boolean
    deleteUser(id: ID): Boolean
  }
  type User {
    id: ID
    username: String
    age: Int
  }
`;
let users = [
    { id: "1", username: "zhangsan", age: 25 },
    { id: "2", username: "lisi", age: 30 },
];
const resolvers = {
    Query: {
        users: (obj, args, context, info) => {
            return users;
        },
        user: (obj, args, context, info) => {
            return users.find(user => user.id === args.id);
        }
    },
    Mutation: {
        createUser: (obj, args, context, info) => {
            const newUser = { id: users.length + 1, username: args.username, age: args.age };
            users.push(newUser);
            return newUser;
        },
        updateUser: (obj, args, context, info) => {
            const updatedUser = { id: args.id, username: args.username, age: args.age };
            users = users.map(user => {
                if (user.id === args.id) {
                    return updatedUser;
                }
                return user;
            });
            return true;
        },
        deleteUser: (obj, args, context, info) => {
            users = users.filter(user => user.id !== args.id);
            return true;
        },
    },
};
const server = new ApolloServer({ typeDefs, resolvers });
server.listen().then(({ url }) => {
    console.log(`Server ready at ${url}`);
});
```

```javascript
query {
    users {
        id
        username
        age
    }
}
query {
    user(id: "1") {
        id
        username
        age
    }
}
mutation {
    createUser(username: "wangwu", age: 35) {
        id
        username
        age
    }
}
mutation {
    updateUser(id: "1", username: "zhangsan2", age: 26)
}
mutation {
    deleteUser(id: "1")
}
```

 ### 9.5 Apollo Server Koa 

* Apollo Server Koa æ˜¯ä¸€ä¸ªåŸºäº Koa çš„ä¸­é—´ä»¶ï¼Œå¯ä»¥å°† `GraphQL API` æ·»åŠ åˆ° Koa åº”ç”¨ç¨‹åºä¸­ã€‚å®ƒä½¿ç”¨ `Apollo Server` æ¥æ‰§è¡Œ `GraphQL` æœåŠ¡å™¨é€»è¾‘ï¼Œå¹¶å…è®¸ä½¿ç”¨ Koa çš„ä¼˜ç§€ç‰¹æ€§ï¼ˆå¦‚è·¯ç”±å’Œä¸­é—´ä»¶ï¼‰æ¥æ„å»ºåº”ç”¨ç¨‹åº

```javascript
const Koa = require('koa');
const { ApolloServer } = require('apollo-server-koa');

const typeDefs = `
  type Query {
    hello: String
  }
`;

const resolvers = {
    Query: {
        hello: () => 'Hello, world!',
    },
};

(async function () {
    const server = new ApolloServer({ typeDefs, resolvers });
    await server.start()
    const app = new Koa();
    server.applyMiddleware({ app });
    app.listen({ port: 4000 }, () =>
        console.log(`ğŸš€ Server ready at http://localhost:4000${server.graphqlPath}`)
    );
})()

```