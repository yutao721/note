<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>rollup 打包原理 | jiaHang的博客</title>
    <meta name="generator" content="VuePress 1.5.0">
    
    <meta name="description" content="专注前端技术栈分享，做一个爱折腾的前端">
    <link rel="preload" href="/note/assets/css/0.styles.725ed339.css" as="style"><link rel="preload" href="/note/assets/js/app.02190172.js" as="script"><link rel="preload" href="/note/assets/js/2.2dccd611.js" as="script"><link rel="preload" href="/note/assets/js/34.684f8bf3.js" as="script"><link rel="prefetch" href="/note/assets/js/10.a05513c9.js"><link rel="prefetch" href="/note/assets/js/11.7ceb6923.js"><link rel="prefetch" href="/note/assets/js/12.fb88bae4.js"><link rel="prefetch" href="/note/assets/js/13.4b17ba74.js"><link rel="prefetch" href="/note/assets/js/14.ce1cd100.js"><link rel="prefetch" href="/note/assets/js/15.6a480c60.js"><link rel="prefetch" href="/note/assets/js/16.6d6b8a6a.js"><link rel="prefetch" href="/note/assets/js/17.c36721ad.js"><link rel="prefetch" href="/note/assets/js/18.77bcea9f.js"><link rel="prefetch" href="/note/assets/js/19.f262839a.js"><link rel="prefetch" href="/note/assets/js/20.5b1b9830.js"><link rel="prefetch" href="/note/assets/js/21.76b74656.js"><link rel="prefetch" href="/note/assets/js/22.e663cec2.js"><link rel="prefetch" href="/note/assets/js/23.c1f1c7e7.js"><link rel="prefetch" href="/note/assets/js/24.5ddffc93.js"><link rel="prefetch" href="/note/assets/js/25.95b0061c.js"><link rel="prefetch" href="/note/assets/js/26.c4c127de.js"><link rel="prefetch" href="/note/assets/js/27.234a7f7e.js"><link rel="prefetch" href="/note/assets/js/28.3bb3b4b8.js"><link rel="prefetch" href="/note/assets/js/29.1339c108.js"><link rel="prefetch" href="/note/assets/js/3.6e8c2ef0.js"><link rel="prefetch" href="/note/assets/js/30.3235f9a2.js"><link rel="prefetch" href="/note/assets/js/31.2a4efe07.js"><link rel="prefetch" href="/note/assets/js/32.d3d3c893.js"><link rel="prefetch" href="/note/assets/js/33.eaca5eef.js"><link rel="prefetch" href="/note/assets/js/35.c486c7ec.js"><link rel="prefetch" href="/note/assets/js/36.2f90f872.js"><link rel="prefetch" href="/note/assets/js/37.92460be1.js"><link rel="prefetch" href="/note/assets/js/38.8532070d.js"><link rel="prefetch" href="/note/assets/js/39.9cc3b3d9.js"><link rel="prefetch" href="/note/assets/js/4.2b7fc900.js"><link rel="prefetch" href="/note/assets/js/40.3ec1b99e.js"><link rel="prefetch" href="/note/assets/js/41.d22f0de1.js"><link rel="prefetch" href="/note/assets/js/42.4796d96b.js"><link rel="prefetch" href="/note/assets/js/43.4c97d146.js"><link rel="prefetch" href="/note/assets/js/44.6e02569c.js"><link rel="prefetch" href="/note/assets/js/5.bb5b8508.js"><link rel="prefetch" href="/note/assets/js/6.ec170bea.js"><link rel="prefetch" href="/note/assets/js/7.12a33526.js"><link rel="prefetch" href="/note/assets/js/8.70ad78c1.js"><link rel="prefetch" href="/note/assets/js/9.b2f872fe.js">
    <link rel="stylesheet" href="/note/assets/css/0.styles.725ed339.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/note/" class="home-link router-link-active"><!----> <span class="site-name">jiaHang的博客</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/note/" class="nav-link">
  主页
</a></div><div class="nav-item"><a href="/note/web/" class="nav-link router-link-active">
  前端
</a></div><div class="nav-item"><a href="/note/node/" class="nav-link">
  node
</a></div><div class="nav-item"><a href="/note/interview/" class="nav-link">
  面试问题
</a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/note/" class="nav-link">
  主页
</a></div><div class="nav-item"><a href="/note/web/" class="nav-link router-link-active">
  前端
</a></div><div class="nav-item"><a href="/note/node/" class="nav-link">
  node
</a></div><div class="nav-item"><a href="/note/interview/" class="nav-link">
  面试问题
</a></div> <!----></nav>  <ul class="sidebar-links"><li><a href="/note/web/" aria-current="page" class="sidebar-link">前端</a></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>JavaScript</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>css</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>ES6</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>vue</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>react</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>webpack</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>rollup</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/note/web/rollup/" aria-current="page" class="sidebar-link">目录</a></li><li><a href="/note/web/rollup/rollupUse.html" class="sidebar-link">rollup使用教程</a></li><li><a href="/note/web/rollup/rollupTheory.html" aria-current="page" class="active sidebar-link">rollup打包原理</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/note/web/rollup/rollupTheory.html#前言" class="sidebar-link">前言</a></li><li class="sidebar-sub-header"><a href="/note/web/rollup/rollupTheory.html#前置知识" class="sidebar-link">前置知识</a></li></ul></li></ul></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>小程序</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>调试</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>其他</span> <span class="arrow right"></span></p> <!----></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="rollup-打包原理"><a href="#rollup-打包原理" class="header-anchor">#</a> rollup 打包原理</h1> <h2 id="前言"><a href="#前言" class="header-anchor">#</a> 前言</h2> <p>上一篇文章已对rollup具体使用做了详细的介绍，这篇文章学习下rollup原理。由于篇幅有限，拉取了rollup最初版本的代码（0.3.0版本）。我的目的是学习 rollup 怎么打包的，怎么做 tree-shaking 的。而初版源码已经实现了这两个功能（半成品），所以看初版源码已经足够了。</p> <h2 id="前置知识"><a href="#前置知识" class="header-anchor">#</a> 前置知识</h2> <p>rollup 使用了 <code>acorn</code> 和 <code>magic-string</code> 两个库。为了更好的阅读 rollup 源码，必须对它们有所了解。</p> <div class="language-json extra-class"><pre class="language-json"><code><span class="token property">&quot;dependencies&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
  <span class="token property">&quot;acorn&quot;</span><span class="token operator">:</span> <span class="token string">&quot;^1.1.0&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;magic-string&quot;</span><span class="token operator">:</span> <span class="token string">&quot;^0.5.1&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;sander&quot;</span><span class="token operator">:</span> <span class="token string">&quot;^0.3.3&quot;</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span>
</code></pre></div><h3 id="magic-string"><a href="#magic-string" class="header-anchor">#</a> magic-string</h3> <p><a href="https://www.npmjs.com/package/magic-string" target="_blank" rel="noopener noreferrer">magic-string<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>是一个操作字符串和生成source-map的工具。<code>magic-string</code> 是 rollup 作者写的一个关于字符串操作的库。下面是 github 上的示例：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">var</span> MagicString <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'magic-string'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> magicString <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MagicString</span><span class="token punctuation">(</span><span class="token string">'export var name = &quot;beijing&quot;'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//类似于截取字符串</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>magicString<span class="token punctuation">.</span><span class="token function">snip</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// export</span>
<span class="token comment">//从开始到结束删除字符串(索引永远是基于原始的字符串，而非改变后的)</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>magicString<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">7</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// var name = &quot;beijing&quot;</span>

<span class="token comment">//很多模块，把它们打包在一个文件里，需要把很多文件的源代码合并在一起</span>
<span class="token keyword">let</span> bundleString <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MagicString<span class="token punctuation">.</span>Bundle</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
bundleString<span class="token punctuation">.</span><span class="token function">addSource</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    content<span class="token operator">:</span><span class="token string">'var a = 1;'</span><span class="token punctuation">,</span>
    separator<span class="token operator">:</span><span class="token string">'\n'</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
bundleString<span class="token punctuation">.</span><span class="token function">addSource</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    content<span class="token operator">:</span><span class="token string">'var b = 2;'</span><span class="token punctuation">,</span>
    separator<span class="token operator">:</span><span class="token string">'\n'</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">/* let str = '';
str += 'var a = 1;\n'
str += 'var b = 2;\n'
console.log(str); */</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>bundleString<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// var a = 1;</span>
<span class="token comment">//var b = 2;</span>

</code></pre></div><h3 id="ast"><a href="#ast" class="header-anchor">#</a> AST</h3> <p>通过JavaScript Parser可以把代码转化为一颗抽象语法树AST,这颗树定义了代码的结构，通过操纵这颗树，我们可以精准的定位到声明语句、赋值语句、运算语句等等，实现对代码的分析、优化、变更等操作
<img src="https://gitee.com/yutao618/images/raw/master/images/ThirdPartyImage16214054459750.jpeg" alt=""></p> <h4 id="ast工作流"><a href="#ast工作流" class="header-anchor">#</a> AST工作流</h4> <ul><li>Parse(解析) 将源代码转换成抽象语法树，树上有很多的estree节点</li> <li>Transform(转换) 对抽象语法树进行转换</li> <li>Generate(代码生成) 将上一步经过转换过的抽象语法树生成新的代码</li></ul> <p><img src="https://gitee.com/yutao618/images/raw/master/images/ThirdPartyImage16214054459751.png" alt=""></p> <h3 id="acorn"><a href="#acorn" class="header-anchor">#</a> acorn</h3> <ul><li><p><a href="https://astexplorer.net/" target="_blank" rel="noopener noreferrer">astexplorer<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>可以把代码转成语法树</p></li> <li><p>acorn 解析结果符合The Estree Spec规范</p></li></ul> <p>import $ from 'jquery 的 ast 如下图
<img src="https://gitee.com/yutao618/images/raw/master/images/ThirdPartyImage16214054459752.jpeg" alt=""></p> <p>可以看到这个 AST 的类型为 <code>program</code>，表明这是一个程序。<code>body</code> 则包含了这个程序下面所有语句对应的 AST 子节点。</p> <p>每个节点都有一个 <code>type</code> 类型，例如 <code>Identifier</code>，说明这个节点是一个标识符；</p> <p>如果想了解更多详情 AST 节点的信息可以看一下这篇文章<a href="https://juejin.im/post/6844903450287800327" target="_blank" rel="noopener noreferrer">《使用 Acorn 来解析 JavaScript》<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>。</p> <h3 id="rollup如何打包的"><a href="#rollup如何打包的" class="header-anchor">#</a> rollup如何打包的</h3> <p>还是先来简单使用下，分析下打包结果</p> <p>目录结构如下：</p> <div class="language-markdown extra-class"><pre class="language-markdown"><code>rollup-demo
├── package.json
├── README.MD
├── rollup.config.js
├── src
│   ├── main.js
│   └── modules
│       └── myModule.js
</code></pre></div><p>安装rollup并配置执行脚本语句</p> <div class="language-sh extra-class"><pre class="language-sh"><code><span class="token function">npm</span> <span class="token function">install</span> rollup -S -D
</code></pre></div><p>package.json</p> <div class="language-json extra-class"><pre class="language-json"><code><span class="token punctuation">{</span>
  <span class="token property">&quot;name&quot;</span><span class="token operator">:</span> <span class="token string">&quot;rollup-demo&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;version&quot;</span><span class="token operator">:</span> <span class="token string">&quot;1.0.0&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;description&quot;</span><span class="token operator">:</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;main&quot;</span><span class="token operator">:</span> <span class="token string">&quot;index.js&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;scripts&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">&quot;build&quot;</span><span class="token operator">:</span> <span class="token string">&quot;rollup --config&quot;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>

  <span class="token property">&quot;keywords&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token property">&quot;author&quot;</span><span class="token operator">:</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;devDependencies&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">&quot;rollup&quot;</span><span class="token operator">:</span> <span class="token string">&quot;^2.46.0&quot;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>rollup.config.js</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token punctuation">{</span>
  input<span class="token operator">:</span> <span class="token string">'./src/main.js'</span><span class="token punctuation">,</span><span class="token comment">//入口文件</span>
  output<span class="token operator">:</span> <span class="token punctuation">{</span>
    file<span class="token operator">:</span> <span class="token string">'./dist/bundle.js'</span><span class="token punctuation">,</span><span class="token comment">//打包后的存放文件</span>
    format<span class="token operator">:</span> <span class="token string">'cjs'</span><span class="token punctuation">,</span><span class="token comment">//输出格式 amd es6 iife umd cjs</span>
    name<span class="token operator">:</span> <span class="token string">'bundleName'</span><span class="token comment">//如果iife,umd需要指定一个全局变量</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>src/mian.js</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">import</span> <span class="token punctuation">{</span> name<span class="token punctuation">,</span> age <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./modules/myModule'</span>

<span class="token keyword">function</span> <span class="token function">say</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">my name is </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>name<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>age<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">say</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

</code></pre></div><p>modules/myModule.js</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">export</span> <span class="token keyword">const</span> name <span class="token operator">=</span> <span class="token string">'jiahang'</span>
<span class="token keyword">export</span> <span class="token keyword">const</span> age <span class="token operator">=</span> <span class="token number">18</span>
<span class="token keyword">export</span> <span class="token keyword">const</span> height <span class="token operator">=</span> <span class="token number">180</span>
</code></pre></div><p>执行 <strong>npm run build</strong>， 打开dist目录，看到bundle.js文件打包内容如下：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token string">'use strict'</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> name <span class="token operator">=</span> <span class="token string">'jiahang'</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> age <span class="token operator">=</span> <span class="token number">18</span><span class="token punctuation">;</span>

<span class="token keyword">function</span> <span class="token function">say</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">my name is </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>name<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>age<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">say</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

</code></pre></div><blockquote><p>可以看到，rollup打包出来的代码非常之简洁，没有用到的变量以及方法都不会被打包进来，所以一般开发库之类的一般都会采用rollup来减小代码体积。</p></blockquote> <p>在 rollup 中，一个文件就是一个模块。每一个模块都会根据文件的代码生成一个 AST 语法抽象树，rollup 需要对每一个 AST 节点进行分析。分析 AST 节点，就是看看这个节点有没有调用函数或方法。如果有，就查看所调用的函数或方法是否在当前作用域，如果不在就往上找，直到找到模块顶级作用域为止。如果本模块都没找到，说明这个函数、方法依赖于其他模块，需要从其他模块引入。</p> <h3 id="简易版rollup实现"><a href="#简易版rollup实现" class="header-anchor">#</a> 简易版rollup实现</h3> <blockquote><p>简易版目前不考虑模块的依赖以及变量作用域</p></blockquote> <p>main.js入口文件</p> <div class="language-js extra-class"><pre class="language-js"><code>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'hello'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'world'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>lib/rollup.js</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">let</span> Bundle <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./bundle'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">function</span> <span class="token function">rollup</span><span class="token punctuation">(</span><span class="token parameter">entry<span class="token punctuation">,</span>outputFileName</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token comment">//Bundle就代表打包对象，里面会包含所有的模块信息</span>
    <span class="token keyword">const</span> bundle <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Bundle</span><span class="token punctuation">(</span><span class="token punctuation">{</span>entry<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//调用build方法开始进行编译</span>
    bundle<span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span>outputFileName<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
module<span class="token punctuation">.</span>exports <span class="token operator">=</span> rollup<span class="token punctuation">;</span>
</code></pre></div><p>这个是rollup打包工作的入口，接受入口路径和打包后的名字，接着是实例化一个Bundle，调用实例的build方法，那么其核心逻辑就是Bundle类。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> fs <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'fs'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> MagicString <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'magic-string'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> Module <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./module'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">class</span> <span class="token class-name">Bundle</span> <span class="token punctuation">{</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter">options</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">//入口文件的绝对路径，包括后缀</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>entryPath <span class="token operator">=</span> options<span class="token punctuation">.</span>entry<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token regex">/\.js$/</span><span class="token punctuation">,</span> <span class="token string">''</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">'.js'</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>modules <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span><span class="token comment">//存放着所有模块 入口文件和它依赖的模块</span>
  <span class="token punctuation">}</span>

  <span class="token function">build</span><span class="token punctuation">(</span><span class="token parameter">outputFileName</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">//从入口文件的绝对路径出发找到它的模块定义</span>
    <span class="token keyword">let</span> entryModule <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">fetchModule</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>entryPath<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//把这个入口模块所有的语句进行展开，返回所有的语句组成的数组</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>statements <span class="token operator">=</span> entryModule<span class="token punctuation">.</span><span class="token function">expandAllStatements</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> <span class="token punctuation">{</span> code <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">generate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    fs<span class="token punctuation">.</span><span class="token function">writeFileSync</span><span class="token punctuation">(</span>outputFileName<span class="token punctuation">,</span> code<span class="token punctuation">,</span> <span class="token string">'utf8'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">//获取模块信息</span>
  <span class="token function">fetchModule</span><span class="token punctuation">(</span><span class="token parameter">importee</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> route <span class="token operator">=</span> importee<span class="token punctuation">;</span><span class="token comment">//入口文件的绝对路径</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>route<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">//从硬盘上读出此模块的源代码</span>
      <span class="token keyword">let</span> code <span class="token operator">=</span> fs<span class="token punctuation">.</span><span class="token function">readFileSync</span><span class="token punctuation">(</span>route<span class="token punctuation">,</span> <span class="token string">'utf8'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">let</span> module <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Module</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
        code<span class="token punctuation">,</span><span class="token comment">//模块的源代码</span>
        path<span class="token operator">:</span> route<span class="token punctuation">,</span><span class="token comment">//模块的绝对路径</span>
        bundle<span class="token operator">:</span> <span class="token keyword">this</span><span class="token comment">//属于哪个Bundle</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span> module<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token comment">//把this.statements生成代码</span>
  <span class="token function">generate</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> magicString <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MagicString<span class="token punctuation">.</span>Bundle</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>statements<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">statement</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> source <span class="token operator">=</span> statement<span class="token punctuation">.</span>_source<span class="token punctuation">;</span>
      magicString<span class="token punctuation">.</span><span class="token function">addSource</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
        content<span class="token operator">:</span> source<span class="token punctuation">,</span>
        separator<span class="token operator">:</span> <span class="token string">'\n'</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token punctuation">{</span> code<span class="token operator">:</span> magicString<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

module<span class="token punctuation">.</span>exports <span class="token operator">=</span> Bundle<span class="token punctuation">;</span>

</code></pre></div><p>Bundle的实例在build的时候，会从入口出发，每一个文件会生成一个module实例，包含模块的源代码，模块的路径，模块的抽象语法树ast，然后将语法树语句进行展开，返回所有的语句组成的数组，最后调用generate生成最终的代码。</p> <p>Module类</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">let</span> MagicString <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'magic-string'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> <span class="token punctuation">{</span> parse <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'acorn'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> analyse <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./ast/analyse'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">/**
 * 每个文件都是一个模块，每个模块都会对应一个Module实例
 */</span>
<span class="token keyword">class</span> <span class="token class-name">Module</span> <span class="token punctuation">{</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> code<span class="token punctuation">,</span> path<span class="token punctuation">,</span> bundle <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>code <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MagicString</span><span class="token punctuation">(</span>code<span class="token punctuation">,</span> <span class="token punctuation">{</span> filename<span class="token operator">:</span> path <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>path <span class="token operator">=</span> path<span class="token punctuation">;</span><span class="token comment">//模块的路径</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>bundle <span class="token operator">=</span> bundle<span class="token punctuation">;</span><span class="token comment">//属于哪个bundle的实例</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>ast <span class="token operator">=</span> <span class="token function">parse</span><span class="token punctuation">(</span>code<span class="token punctuation">,</span> <span class="token punctuation">{</span><span class="token comment">//把源代码转成抽象语法树</span>
      ecmaVersion<span class="token operator">:</span> <span class="token number">7</span><span class="token punctuation">,</span>
      sourceType<span class="token operator">:</span> <span class="token string">'module'</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">analyse</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token function">analyse</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">analyse</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>ast<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>code<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">//展开这个模块里的语句，把些语句中定义的变量的语句都放到结果里</span>
  <span class="token function">expandAllStatements</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> allStatements <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>ast<span class="token punctuation">.</span>body<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">statement</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token keyword">let</span> statements <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">expandStatement</span><span class="token punctuation">(</span>statement<span class="token punctuation">)</span><span class="token punctuation">;</span>
      allStatements<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token operator">...</span>statements<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> allStatements<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">//展开一个节点</span>
  <span class="token comment">//找到当前节点依赖的变量，它访问的变量，找到这些变量的声明语句。</span>
  <span class="token comment">//这些语句可能是在当前模块声明的，也也可能是在导入的模块的声明的</span>
  <span class="token function">expandStatement</span><span class="token punctuation">(</span><span class="token parameter">statement</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> result <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>statement<span class="token punctuation">.</span>_included<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      statement<span class="token punctuation">.</span>_included <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span><span class="token comment">//表示这个节点已经确定被纳入结果 里了，以后就不需要重复添加了</span>
      <span class="token comment">//tree shaking核心在此处</span>
      result<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>statement<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">return</span> result<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

module<span class="token punctuation">.</span>exports <span class="token operator">=</span> Module<span class="token punctuation">;</span>
</code></pre></div><p>ast/analyse.js</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">analyse</span><span class="token punctuation">(</span><span class="token parameter">ast<span class="token punctuation">,</span> magicString<span class="token punctuation">,</span> module</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  ast<span class="token punctuation">.</span>body<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">statement</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span><span class="token comment">//body下面的顶级节点</span>
    Object<span class="token punctuation">.</span><span class="token function">defineProperties</span><span class="token punctuation">(</span>statement<span class="token punctuation">,</span> <span class="token punctuation">{</span>
      <span class="token comment">//start指的是此节点在源代码中的起始索引,end就是结束索引</span>
      <span class="token comment">//magicString.snip返回的还是magicString 实例clone</span>
      _source<span class="token operator">:</span> <span class="token punctuation">{</span> value<span class="token operator">:</span> magicString<span class="token punctuation">.</span><span class="token function">snip</span><span class="token punctuation">(</span>statement<span class="token punctuation">.</span>start<span class="token punctuation">,</span> statement<span class="token punctuation">.</span>end<span class="token punctuation">)</span> <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

module<span class="token punctuation">.</span>exports <span class="token operator">=</span> analyse<span class="token punctuation">;</span>
</code></pre></div><p>现在来测试一下该简易版的</p> <p>debugger.js</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> path <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'path'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> rollup <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./lib/rollup'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//入口文件的绝对路径</span>
<span class="token keyword">let</span> entry <span class="token operator">=</span> path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span><span class="token string">'src/main.js'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">rollup</span><span class="token punctuation">(</span>entry<span class="token punctuation">,</span><span class="token string">'bundle.js'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>打包出来的结果</p> <div class="language-js extra-class"><pre class="language-js"><code>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'hello'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'world'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>可以看到可以完整的输出打包结果。</p> <h3 id="完整版rollup实现"><a href="#完整版rollup实现" class="header-anchor">#</a> 完整版rollup实现</h3> <p>简易版本的rollup只是原封不动的将代码copy到了一起，并未对模块的变量方法做处理，接下来对这部分处理。</p> <p>从打包入口流程来看，在实例化build之后就调用了Bundle实例的build方法，而bundle.build(outputFileName)中最开始调用的就是该实例的fetchModule方法，那我们就从这个方法去一步步去做调整，先看下这个方法做了上面操作。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token function">fetchModule</span><span class="token punctuation">(</span><span class="token parameter">importee</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> route <span class="token operator">=</span> importee<span class="token punctuation">;</span><span class="token comment">//入口文件的绝对路径</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>route<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">//从硬盘上读出此模块的源代码</span>
    <span class="token keyword">let</span> code <span class="token operator">=</span> fs<span class="token punctuation">.</span><span class="token function">readFileSync</span><span class="token punctuation">(</span>route<span class="token punctuation">,</span> <span class="token string">'utf8'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> module <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Module</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      code<span class="token punctuation">,</span><span class="token comment">//模块的源代码</span>
      path<span class="token operator">:</span> route<span class="token punctuation">,</span><span class="token comment">//模块的绝对路径</span>
      bundle<span class="token operator">:</span> <span class="token keyword">this</span><span class="token comment">//属于哪个Bundle</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> module<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>就是从入口文件出发，每一个文件就生成一个Module实例，在实例化的时候就会去分析代码，这个时候是去分析的是ast树了，分析的时候就先找这个模块的导入和导出。</p> <h4 id="_1-ast导入和导出的处理"><a href="#_1-ast导入和导出的处理" class="header-anchor">#</a> 1.ast导入和导出的处理</h4> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">import</span> <span class="token punctuation">{</span>age<span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./title'</span><span class="token punctuation">;</span>
age<span class="token operator">++</span><span class="token punctuation">;</span>
<span class="token keyword">export</span> <span class="token punctuation">{</span>
    age
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><p>先来看下这个代码的ast长的什么样</p> <p><img src="https://gitee.com/yutao618/images/raw/master/images/20210526170045.png" alt=""></p> <p>Module类的方法就可以完善analyse方法了</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token function">analyse</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>imports <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span><span class="token comment">//存放着当前模块所有的导入</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span><span class="token comment">//存放着当前模块所有的导出</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>ast<span class="token punctuation">.</span>body<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">node</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>node<span class="token punctuation">.</span>type <span class="token operator">===</span> <span class="token string">'ImportDeclaration'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token comment">//说明这是一个导入语句</span>
      <span class="token keyword">let</span> source <span class="token operator">=</span> node<span class="token punctuation">.</span>source<span class="token punctuation">.</span>value<span class="token punctuation">;</span><span class="token comment">//./msg 从哪个模块进行的导入</span>
      <span class="token keyword">let</span> specifiers <span class="token operator">=</span> node<span class="token punctuation">.</span>specifiers<span class="token punctuation">;</span>
      specifiers<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">specifier</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token keyword">const</span> name <span class="token operator">=</span> specifier<span class="token punctuation">.</span>imported<span class="token punctuation">.</span>name<span class="token punctuation">;</span><span class="token comment">//name</span>
        <span class="token keyword">const</span> localName <span class="token operator">=</span> specifier<span class="token punctuation">.</span>local<span class="token punctuation">.</span>name<span class="token punctuation">;</span><span class="token comment">//name</span>
        <span class="token comment">//本地的哪个变量，是从哪个模块的的哪个变量导出的</span>
        <span class="token comment">//this.imports.age = {name:'age',localName:&quot;age&quot;,source:'./msg'};</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>imports<span class="token punctuation">[</span>localName<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span> name<span class="token punctuation">,</span> localName<span class="token punctuation">,</span> source <span class="token punctuation">}</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>node<span class="token punctuation">.</span>type <span class="token operator">===</span> <span class="token string">'ExportNamedDeclaration'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">let</span> declaration <span class="token operator">=</span> node<span class="token punctuation">.</span>declaration<span class="token punctuation">;</span><span class="token comment">//VariableDeclaration</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>declaration<span class="token punctuation">.</span>type <span class="token operator">===</span> <span class="token string">'VariableDeclaration'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">let</span> name <span class="token operator">=</span> declaration<span class="token punctuation">.</span>declarations<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>id<span class="token punctuation">.</span>name<span class="token punctuation">;</span><span class="token comment">//age</span>
        <span class="token comment">//记录一下当前模块的导出 这个age通过哪个表达式创建的</span>
        <span class="token comment">//this.exports['age']={node,localName:age,expression}</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>exports<span class="token punctuation">[</span>name<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span>
          node<span class="token punctuation">,</span> localName<span class="token operator">:</span> name<span class="token punctuation">,</span> expression<span class="token operator">:</span> declaration
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">analyse</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>ast<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>code<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>经过这样的一番处理后，每一个文件模块的导入导出都在imports和exports中了。</p> <h4 id="_2-作用域scope类"><a href="#_2-作用域scope类" class="header-anchor">#</a> 2.作用域Scope类</h4> <p>分析每个 AST 节点间的作用域，找出每个 AST 节点定义的变量，每遍历到一个 AST 节点，都会为它生成一个 <code>Scope</code> 实例。</p> <blockquote><p>作用域链是由当前执行环境与上层执行环境的一系列变量对象组成的，它保证了当前执行环境对符合访问权限的变量和函数的有序访问，<em>tree-shaking</em>原理的核心就是基于这样的一个scope chain。</p></blockquote> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">class</span> <span class="token class-name">Scope</span> <span class="token punctuation">{</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter">options <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>name <span class="token operator">=</span> options<span class="token punctuation">.</span>name<span class="token punctuation">;</span><span class="token comment">//作用域起个名字，没有什么用，只是帮助 大家认识的</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>parent <span class="token operator">=</span> options<span class="token punctuation">.</span>parent<span class="token punctuation">;</span><span class="token comment">//父作用域</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>depth <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>parent <span class="token operator">?</span> <span class="token keyword">this</span><span class="token punctuation">.</span>parent<span class="token punctuation">.</span>depth <span class="token operator">+</span> <span class="token number">1</span> <span class="token operator">:</span> <span class="token number">0</span> <span class="token comment">// 作用域层级</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>names <span class="token operator">=</span> options<span class="token punctuation">.</span>params <span class="token operator">||</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token comment">//此作用内有哪些变量</span>
  <span class="token punctuation">}</span>

  <span class="token function">add</span><span class="token punctuation">(</span><span class="token parameter">name<span class="token punctuation">,</span> isBlockDeclaration</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>isBlockDeclaration <span class="token operator">&amp;&amp;</span> <span class="token keyword">this</span><span class="token punctuation">.</span>isBlockScope<span class="token punctuation">)</span> <span class="token punctuation">{</span>
			<span class="token keyword">this</span><span class="token punctuation">.</span>parent<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> isBlockDeclaration<span class="token punctuation">)</span>
		<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
			<span class="token keyword">this</span><span class="token punctuation">.</span>names<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>

  <span class="token function">findDefiningScope</span><span class="token punctuation">(</span><span class="token parameter">name</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>names<span class="token punctuation">.</span><span class="token function">includes</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>parent<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>parent<span class="token punctuation">.</span><span class="token function">findDefiningScope</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

module<span class="token punctuation">.</span>exports <span class="token operator">=</span> Scope<span class="token punctuation">;</span>
</code></pre></div><p>来简单测试下，</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">let</span> Scope <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./scope'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">let</span> a <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>

<span class="token keyword">function</span> <span class="token function">one</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> b <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span>

  <span class="token keyword">function</span> <span class="token function">two</span><span class="token punctuation">(</span><span class="token parameter">age</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> c <span class="token operator">=</span> <span class="token number">3</span><span class="token punctuation">;</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span> b<span class="token punctuation">,</span> c<span class="token punctuation">,</span> age<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token function">two</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token function">one</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">let</span> globalScope <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Scope</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  name<span class="token operator">:</span> <span class="token string">'globalScope'</span><span class="token punctuation">,</span> params<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> parent<span class="token operator">:</span> <span class="token keyword">null</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
globalScope<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token string">'a'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">let</span> oneScope <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Scope</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  name<span class="token operator">:</span> <span class="token string">'oneScope'</span><span class="token punctuation">,</span> params<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> parent<span class="token operator">:</span> globalScope
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
oneScope<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token string">'b'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">let</span> twoScope <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Scope</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  name<span class="token operator">:</span> <span class="token string">'twoScope'</span><span class="token punctuation">,</span> params<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">'age'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> parent<span class="token operator">:</span> oneScope
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
twoScope<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token string">'c'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">let</span> aScope <span class="token operator">=</span> twoScope<span class="token punctuation">.</span><span class="token function">findDefiningScope</span><span class="token punctuation">(</span><span class="token string">'a'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>aScope<span class="token punctuation">.</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">let</span> bScope <span class="token operator">=</span> twoScope<span class="token punctuation">.</span><span class="token function">findDefiningScope</span><span class="token punctuation">(</span><span class="token string">'b'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>bScope<span class="token punctuation">.</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">let</span> cScope <span class="token operator">=</span> twoScope<span class="token punctuation">.</span><span class="token function">findDefiningScope</span><span class="token punctuation">(</span><span class="token string">'c'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>cScope<span class="token punctuation">.</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">let</span> ageScope <span class="token operator">=</span> twoScope<span class="token punctuation">.</span><span class="token function">findDefiningScope</span><span class="token punctuation">(</span><span class="token string">'age'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>ageScope<span class="token punctuation">.</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">let</span> xxxScope <span class="token operator">=</span> twoScope<span class="token punctuation">.</span><span class="token function">findDefiningScope</span><span class="token punctuation">(</span><span class="token string">'xxx'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>xxxScope<span class="token punctuation">)</span><span class="token punctuation">;</span>

</code></pre></div><p>打印结果如下：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 1 2 3 undefined</span>
<span class="token comment">// globalScope</span>
<span class="token comment">// oneScope</span>
<span class="token comment">// twoScope</span>
<span class="token comment">// twoScope</span>
<span class="token comment">// null</span>
</code></pre></div><p><code>Scope</code> 的作用很简单，它有一个 <code>names</code> 属性数组，用于保存这个 AST 节点内的变量。rollup根据这个<code>Scope</code>链构建出变量的作用域。</p> <h4 id="_3-walk方法的实现"><a href="#_3-walk方法的实现" class="header-anchor">#</a> 3.walk方法的实现</h4> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">/**
 *
 * @param {*} ast 要遍历的语法树
 * @param {*} param1 配置对象
 */</span>
<span class="token keyword">function</span> <span class="token function">walk</span><span class="token punctuation">(</span><span class="token parameter">ast<span class="token punctuation">,</span> <span class="token punctuation">{</span> enter<span class="token punctuation">,</span> leave <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token function">visit</span><span class="token punctuation">(</span>ast<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> enter<span class="token punctuation">,</span> leave<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">/**
 * 访问此node节点
 * @param {*} node
 * @param {*} parent
 * @param {*} enter
 * @param {*} leave
 */</span>
<span class="token keyword">function</span> <span class="token function">visit</span><span class="token punctuation">(</span><span class="token parameter">node<span class="token punctuation">,</span> parent<span class="token punctuation">,</span> enter<span class="token punctuation">,</span> leave</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>enter<span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token comment">//先执行此节点的enter方法</span>
    <span class="token function">enter</span><span class="token punctuation">(</span>node<span class="token punctuation">,</span> parent<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//不关心this就可以这么写</span>
    <span class="token comment">//enter.call(null,node,parent);//如果你想指定enter中的this</span>
  <span class="token punctuation">}</span>
  <span class="token comment">//再遍历子节点 找出那些是对象的子节点</span>
  <span class="token keyword">let</span> childKeys <span class="token operator">=</span> Object<span class="token punctuation">.</span><span class="token function">keys</span><span class="token punctuation">(</span>node<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span><span class="token parameter">key</span> <span class="token operator">=&gt;</span> <span class="token keyword">typeof</span> node<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">===</span> <span class="token string">'object'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  childKeys<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">childKey</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span><span class="token comment">//childKey=specifiers value=[]</span>
    <span class="token keyword">let</span> value <span class="token operator">=</span> node<span class="token punctuation">[</span>childKey<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>Array<span class="token punctuation">.</span><span class="token function">isArray</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      value<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">val</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token function">visit</span><span class="token punctuation">(</span>val<span class="token punctuation">,</span> node<span class="token punctuation">,</span> enter<span class="token punctuation">,</span> leave<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      <span class="token function">visit</span><span class="token punctuation">(</span>value<span class="token punctuation">,</span> node<span class="token punctuation">,</span> enter<span class="token punctuation">,</span> leave<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">//再执行离开方法</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>leave<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">leave</span><span class="token punctuation">(</span>node<span class="token punctuation">,</span> parent<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

module<span class="token punctuation">.</span>exports <span class="token operator">=</span> walk<span class="token punctuation">;</span>
</code></pre></div><p>测试下walk方法的使用</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">let</span> acorn <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'acorn'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">let</span> walk <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./walk'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//parse方法把源代码转成一个抽象语法树</span>
<span class="token keyword">let</span> astTree <span class="token operator">=</span> acorn<span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">import $ from 'jquery';</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
  locations<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span> ranges<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span> sourceType<span class="token operator">:</span> <span class="token string">'module'</span><span class="token punctuation">,</span> ecmaVersion<span class="token operator">:</span> <span class="token number">8</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">let</span> ident <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> <span class="token function-variable function">padding</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token string">' '</span><span class="token punctuation">.</span><span class="token function">repeat</span><span class="token punctuation">(</span>ident<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//console.log(astTree.body);</span>
<span class="token comment">//遍历语法树中每一条语句</span>
astTree<span class="token punctuation">.</span>body<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">statement</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token comment">//每一条语句传递给walk方法，由walk遍历这条语句子元素</span>
  <span class="token comment">//采用是深度优先的方法进行遍历</span>
  <span class="token function">walk</span><span class="token punctuation">(</span>statement<span class="token punctuation">,</span> <span class="token punctuation">{</span>
    <span class="token function">enter</span><span class="token punctuation">(</span><span class="token parameter">node</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>node<span class="token punctuation">.</span>type<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token function">padding</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> node<span class="token punctuation">.</span>type <span class="token operator">+</span> <span class="token string">'进入'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        ident <span class="token operator">+=</span> <span class="token number">2</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token function">leave</span><span class="token punctuation">(</span><span class="token parameter">node</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>node<span class="token punctuation">.</span>type<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        ident <span class="token operator">-=</span> <span class="token number">2</span><span class="token punctuation">;</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token function">padding</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> node<span class="token punctuation">.</span>type <span class="token operator">+</span> <span class="token string">'离开'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>使用的是深度遍历，如图</p> <p><img src="https://gitee.com/yutao618/images/raw/master/images/ThirdPartyImage16214054459753.jpeg" alt=""></p> <p>打印结果如下</p> <div class="language-js extra-class"><pre class="language-js"><code>ImportDeclaration进入
  ImportDefaultSpecifier进入
    Identifier进入
    Identifier离开
  ImportDefaultSpecifier离开
  Literal进入
  Literal离开
ImportDeclaration离开
</code></pre></div><h4 id="_4-分析标识符，并找出它们的依赖项"><a href="#_4-分析标识符，并找出它们的依赖项" class="header-anchor">#</a> 4.分析标识符，并找出它们的依赖项</h4> <blockquote><p>什么是标识符？如变量名，函数名，属性名，都归为标识符。当解析到一个标识符时，rollup 会遍历它当前的作用域，看看有没这个标识符。如果没有找到，就往它的父级作用域找。如果一直找到模块顶级作用域都没找到，就说明这个函数、方法依赖于其它模块，需要从其他模块引入。如果一个函数、方法需要被引入，就将它添加到 <code>Module</code> 的 <code>_dependsOn</code> 对象里。<strong>这就是 rollup 的 tree-shaking 原理</strong>，rollup 不看你引入了什么函数，而是看你调用了什么函数。如果调用的函数不在此模块中，就从其它模块引入。换句话说，如果你手动在模块顶部引入函数，但又没调用。</p></blockquote> <p>在Module实例化的时候，我们已经收集到了每个模块的导入和导出,执行了analyse(this.ast, this.code, this)。如此，在analyse我们就要去通过walk和scope去分析标识符，并找出它们的依赖项。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">let</span> Scope <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./scope'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">let</span> walk <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./walk'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">/**
 * 找出当前模块使用到了哪些变量
 * 还要知道哪些变量时当前模块声明的，哪些变量是导入别的模块的变量
 * @param {*} ast 语法树
 * @param {*} magicString 源代码
 * @param {*} module  属于哪个模块的
 */</span>
<span class="token keyword">function</span> <span class="token function">analyse</span><span class="token punctuation">(</span><span class="token parameter">ast<span class="token punctuation">,</span> magicString<span class="token punctuation">,</span> module</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> scope <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Scope</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//先创建一个模块内的全局作用域</span>
  <span class="token comment">//遍历当前的所有的语法树的所有的顶级节点</span>
  ast<span class="token punctuation">.</span>body<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">statement</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token comment">//给作用域添加变量 var function const let 变量声明</span>
    <span class="token keyword">function</span> <span class="token function">addToScope</span><span class="token punctuation">(</span><span class="token parameter">declaration</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">var</span> name <span class="token operator">=</span> declaration<span class="token punctuation">.</span>id<span class="token punctuation">.</span>name<span class="token punctuation">;</span><span class="token comment">//获得这个声明的变量</span>
      scope<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//把say这个变量添加到当前的全局作用域</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>scope<span class="token punctuation">.</span>parent<span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token comment">//如果当前是全局作用域的话</span>
        statement<span class="token punctuation">.</span>_defines<span class="token punctuation">[</span>name<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span><span class="token comment">//在全局作用域下声明一个全局的变量say</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    Object<span class="token punctuation">.</span><span class="token function">defineProperties</span><span class="token punctuation">(</span>statement<span class="token punctuation">,</span> <span class="token punctuation">{</span>
      _defines<span class="token operator">:</span> <span class="token punctuation">{</span> value<span class="token operator">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span> <span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token comment">//存放当前模块定义的所有的全局变量</span>
      _dependsOn<span class="token operator">:</span> <span class="token punctuation">{</span> value<span class="token operator">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span> <span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token comment">//当前模块没有定义但是使用到的变量，也就是依赖的外部变量</span>
      _included<span class="token operator">:</span> <span class="token punctuation">{</span> value<span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span> writable<span class="token operator">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token comment">//此语句是否已经 被包含到打包结果中了</span>
      <span class="token comment">//start指的是此节点在源代码中的起始索引,end就是结束索引</span>
      <span class="token comment">//magicString.snip返回的还是magicString 实例clone</span>
      _source<span class="token operator">:</span> <span class="token punctuation">{</span> value<span class="token operator">:</span> magicString<span class="token punctuation">.</span><span class="token function">snip</span><span class="token punctuation">(</span>statement<span class="token punctuation">.</span>start<span class="token punctuation">,</span> statement<span class="token punctuation">.</span>end<span class="token punctuation">)</span> <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//这一步在构建我们的作用域链</span>
    <span class="token function">walk</span><span class="token punctuation">(</span>statement<span class="token punctuation">,</span> <span class="token punctuation">{</span>
      <span class="token function">enter</span><span class="token punctuation">(</span><span class="token parameter">node</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">let</span> newScope<span class="token punctuation">;</span>
        <span class="token keyword">switch</span> <span class="token punctuation">(</span>node<span class="token punctuation">.</span>type<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token keyword">case</span> <span class="token string">'FunctionDeclaration'</span><span class="token operator">:</span>
            <span class="token keyword">const</span> params <span class="token operator">=</span> node<span class="token punctuation">.</span>params<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token parameter">x</span> <span class="token operator">=&gt;</span> x<span class="token punctuation">.</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>node<span class="token punctuation">.</span>type <span class="token operator">===</span> <span class="token string">'FunctionDeclaration'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
              <span class="token function">addToScope</span><span class="token punctuation">(</span>node<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token comment">//如果遍历到的是一个函数声明，我会创建一个新的作用域对象</span>
            newScope <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Scope</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
              parent<span class="token operator">:</span> scope<span class="token punctuation">,</span><span class="token comment">//父作用域就是当前的作用域</span>
              params
            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
          <span class="token keyword">case</span> <span class="token string">'VariableDeclaration'</span><span class="token operator">:</span> <span class="token comment">//并不会生成一个新的作用域</span>
            node<span class="token punctuation">.</span>declarations<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span>addToScope<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>newScope<span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token comment">//当前节点声明一个新的作用域</span>
          <span class="token comment">//如果此节点生成一个新的作用域，那么会在这个节点放一个_scope，指向新的作用域</span>
          Object<span class="token punctuation">.</span><span class="token function">defineProperty</span><span class="token punctuation">(</span>node<span class="token punctuation">,</span> <span class="token string">'_scope'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> value<span class="token operator">:</span> newScope <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          scope <span class="token operator">=</span> newScope<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token function">leave</span><span class="token punctuation">(</span><span class="token parameter">node</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>node<span class="token punctuation">.</span>_scope<span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token comment">//如果此节点产出了一个新的作用域，那等离开这个节点，scope回到父作用法域</span>
          scope <span class="token operator">=</span> scope<span class="token punctuation">.</span>parent<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'第一次遍历'</span><span class="token punctuation">,</span> scope<span class="token punctuation">)</span><span class="token punctuation">;</span>
  ast<span class="token punctuation">.</span>_scope <span class="token operator">=</span> scope<span class="token punctuation">;</span>
  <span class="token comment">//找出外部依赖_dependsOn</span>
  ast<span class="token punctuation">.</span>body<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">statement</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token function">walk</span><span class="token punctuation">(</span>statement<span class="token punctuation">,</span> <span class="token punctuation">{</span>
      <span class="token function">enter</span><span class="token punctuation">(</span><span class="token parameter">node</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>node<span class="token punctuation">.</span>_scope<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          scope <span class="token operator">=</span> node<span class="token punctuation">.</span>_scope<span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token comment">//如果这个节点放有一个scope属笥，说明这个节点产生了一个新的作用域  </span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>node<span class="token punctuation">.</span>type <span class="token operator">===</span> <span class="token string">'Identifier'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token comment">//从当前的作用域向上递归，找这个变量在哪个作用域中定义</span>
          <span class="token keyword">const</span> definingScope <span class="token operator">=</span> scope<span class="token punctuation">.</span><span class="token function">findDefiningScope</span><span class="token punctuation">(</span>node<span class="token punctuation">.</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>definingScope<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            statement<span class="token punctuation">.</span>_dependsOn<span class="token punctuation">[</span>node<span class="token punctuation">.</span>name<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span><span class="token comment">//表示这是一个外部依赖的变量</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token function">leave</span><span class="token punctuation">(</span><span class="token parameter">node</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>node<span class="token punctuation">.</span>_scope<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          scope <span class="token operator">=</span> scope<span class="token punctuation">.</span>parent<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token punctuation">}</span>

module<span class="token punctuation">.</span>exports <span class="token operator">=</span> analyse<span class="token punctuation">;</span>
</code></pre></div><p>分析完之后，还需要找出全局变量定义的语句</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">this</span><span class="token punctuation">.</span>definitions <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span><span class="token comment">//存放着所有的全局变量的定义语句</span>
<span class="token keyword">this</span><span class="token punctuation">.</span>ast<span class="token punctuation">.</span>body<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">statement</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  Object<span class="token punctuation">.</span><span class="token function">keys</span><span class="token punctuation">(</span>statement<span class="token punctuation">.</span>_defines<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">name</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token comment">//key是全局变量名，值是定义这个全局变量的语句</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>definitions<span class="token punctuation">[</span>name<span class="token punctuation">]</span> <span class="token operator">=</span> statement<span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>完整的analyse方法如下：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token function">analyse</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>imports <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span><span class="token comment">//存放着当前模块所有的导入</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span><span class="token comment">//存放着当前模块所有的导出</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>ast<span class="token punctuation">.</span>body<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">node</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>node<span class="token punctuation">.</span>type <span class="token operator">===</span> <span class="token string">'ImportDeclaration'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token comment">//说明这是一个导入语句</span>
      <span class="token keyword">let</span> source <span class="token operator">=</span> node<span class="token punctuation">.</span>source<span class="token punctuation">.</span>value<span class="token punctuation">;</span><span class="token comment">//./msg 从哪个模块进行的导入</span>
      <span class="token keyword">let</span> specifiers <span class="token operator">=</span> node<span class="token punctuation">.</span>specifiers<span class="token punctuation">;</span>
      specifiers<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">specifier</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token keyword">const</span> name <span class="token operator">=</span> specifier<span class="token punctuation">.</span>imported<span class="token punctuation">.</span>name<span class="token punctuation">;</span><span class="token comment">//name</span>
        <span class="token keyword">const</span> localName <span class="token operator">=</span> specifier<span class="token punctuation">.</span>local<span class="token punctuation">.</span>name<span class="token punctuation">;</span><span class="token comment">//name</span>
        <span class="token comment">//本地的哪个变量，是从哪个模块的的哪个变量导出的</span>
        <span class="token comment">//this.imports.age = {name:'age',localName:&quot;age&quot;,source:'./msg'};</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>imports<span class="token punctuation">[</span>localName<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span> name<span class="token punctuation">,</span> localName<span class="token punctuation">,</span> source <span class="token punctuation">}</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">//}else if(/^Export/.test(node.type)){</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>node<span class="token punctuation">.</span>type <span class="token operator">===</span> <span class="token string">'ExportNamedDeclaration'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">let</span> declaration <span class="token operator">=</span> node<span class="token punctuation">.</span>declaration<span class="token punctuation">;</span><span class="token comment">//VariableDeclaration</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>declaration<span class="token punctuation">.</span>type <span class="token operator">===</span> <span class="token string">'VariableDeclaration'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">let</span> name <span class="token operator">=</span> declaration<span class="token punctuation">.</span>declarations<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>id<span class="token punctuation">.</span>name<span class="token punctuation">;</span><span class="token comment">//age</span>
        <span class="token comment">//记录一下当前模块的导出 这个age通过哪个表达式创建的</span>
        <span class="token comment">//this.exports['age']={node,localName:age,expression}</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>exports<span class="token punctuation">[</span>name<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span>
          node<span class="token punctuation">,</span> localName<span class="token operator">:</span> name<span class="token punctuation">,</span> expression<span class="token operator">:</span> declaration
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">analyse</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>ast<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>code<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//找到了_defines 和 _dependsOn</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>definitions <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span><span class="token comment">//存放着所有的全局变量的定义语句</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>ast<span class="token punctuation">.</span>body<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">statement</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    Object<span class="token punctuation">.</span><span class="token function">keys</span><span class="token punctuation">(</span>statement<span class="token punctuation">.</span>_defines<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">name</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token comment">//key是全局变量名，值是定义这个全局变量的语句</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>definitions<span class="token punctuation">[</span>name<span class="token punctuation">]</span> <span class="token operator">=</span> statement<span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token punctuation">}</span>
</code></pre></div><h4 id="_5-优化其他方法"><a href="#_5-优化其他方法" class="header-anchor">#</a> 5.优化其他方法</h4> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">//展开这个模块里的语句，把些语句中定义的变量的语句都放到结果里</span>
<span class="token function">expandAllStatements</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> allStatements <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>ast<span class="token punctuation">.</span>body<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">statement</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>statement<span class="token punctuation">.</span>type <span class="token operator">===</span> <span class="token string">'ImportDeclaration'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token keyword">return</span><span class="token punctuation">}</span>
    <span class="token keyword">let</span> statements <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">expandStatement</span><span class="token punctuation">(</span>statement<span class="token punctuation">)</span><span class="token punctuation">;</span>
    allStatements<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token operator">...</span>statements<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> allStatements<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">//展开一个节点</span>
<span class="token comment">//找到当前节点依赖的变量，它访问的变量，找到这些变量的声明语句。</span>
<span class="token comment">//这些语句可能是在当前模块声明的，也也可能是在导入的模块的声明的</span>
<span class="token function">expandStatement</span><span class="token punctuation">(</span><span class="token parameter">statement</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> result <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> dependencies <span class="token operator">=</span> Object<span class="token punctuation">.</span><span class="token function">keys</span><span class="token punctuation">(</span>statement<span class="token punctuation">.</span>_dependsOn<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//外部依赖 [name]</span>
  dependencies<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">name</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token comment">//找到定义这个变量的声明节点，这个节点可以有在当前模块内，也可能在依赖的模块里</span>
    <span class="token keyword">let</span> definition <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">define</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
    result<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token operator">...</span>definition<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>statement<span class="token punctuation">.</span>_included<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    statement<span class="token punctuation">.</span>_included <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span><span class="token comment">//表示这个节点已经确定被纳入结果 里了，以后就不需要重复添加了</span>
    result<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>statement<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> result<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token function">define</span><span class="token punctuation">(</span><span class="token parameter">name</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">//查找一下导入变量里有没有name</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">hasOwnProperty</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>imports<span class="token punctuation">,</span> name<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">//this.imports.age = {name:'age',localName:&quot;age&quot;,source:'./msg'};</span>
    <span class="token keyword">const</span> importData <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>imports<span class="token punctuation">[</span>name<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token comment">//获取msg模块 exports imports msg模块</span>
    <span class="token keyword">const</span> module <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>bundle<span class="token punctuation">.</span><span class="token function">fetchModule</span><span class="token punctuation">(</span>importData<span class="token punctuation">.</span>source<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>path<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//this.exports['age']={node,localName:age,expression}</span>
    <span class="token keyword">const</span> exportData <span class="token operator">=</span> module<span class="token punctuation">.</span>exports<span class="token punctuation">[</span>importData<span class="token punctuation">.</span>name<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token comment">//调用msg模块的define方法，参数是msg模块的本地变量名age,目的是为了返回定义age变量的语句</span>
    <span class="token keyword">return</span> module<span class="token punctuation">.</span><span class="token function">define</span><span class="token punctuation">(</span>exportData<span class="token punctuation">.</span>localName<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token comment">//definitions是对象,key当前模块的变量名，值是定义这个变量的语句</span>
    <span class="token keyword">let</span> statement <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>definitions<span class="token punctuation">[</span>name<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>statement <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>statement<span class="token punctuation">.</span>_included<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">expandStatement</span><span class="token punctuation">(</span>statement<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h4 id="_6-生成代码"><a href="#_6-生成代码" class="header-anchor">#</a> 6.生成代码</h4> <p>这时需要调用 <code>Bundle</code> 的 <code>generate()</code> 方法生成代码。同时，在打包过程中，还需要对引入的函数做一些额外的操作,</p> <ul><li><strong>移除额外代码</strong></li></ul> <p>例如从 <code>foo.js</code> 中引入的 <code>foo1()</code> 函数代码是这样的：<code>export function foo1() {}</code>。rollup 会移除掉 <code>export</code>，变成 <code>function foo1() {}</code>。因为它们就要打包在一起了，所以就不需要 <code>export</code> 了。</p> <ul><li><strong>重命名</strong></li></ul> <p>例如两个模块中都有一个同名函数 <code>foo()</code>，打包到一起时，会对其中一个函数重命名，变成 <code>_foo()</code>，以避免冲突。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">//获取模块信息</span>
<span class="token function">fetchModule</span><span class="token punctuation">(</span><span class="token parameter">importee<span class="token punctuation">,</span> importer</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> route<span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>importer<span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token comment">//如果没有模块导入此模块，说是这就是入口模块</span>
    route <span class="token operator">=</span> importee<span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>path<span class="token punctuation">.</span><span class="token function">isAbsolute</span><span class="token punctuation">(</span>importee<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token comment">//如果是绝对路径</span>
      route <span class="token operator">=</span> importee<span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>importee<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token string">'.'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token comment">//如果相对路径</span>
      route <span class="token operator">=</span> path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>path<span class="token punctuation">.</span><span class="token function">dirname</span><span class="token punctuation">(</span>importer<span class="token punctuation">)</span><span class="token punctuation">,</span> importee<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token regex">/\.js$/</span><span class="token punctuation">,</span> <span class="token string">''</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">'.js'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>route<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">//从硬盘上读出此模块的源代码</span>
    <span class="token keyword">let</span> code <span class="token operator">=</span> fs<span class="token punctuation">.</span><span class="token function">readFileSync</span><span class="token punctuation">(</span>route<span class="token punctuation">,</span> <span class="token string">'utf8'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> module <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Module</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      code<span class="token punctuation">,</span><span class="token comment">//模块的源代码</span>
      path<span class="token operator">:</span> route<span class="token punctuation">,</span><span class="token comment">//模块的绝对路径</span>
      bundle<span class="token operator">:</span> <span class="token keyword">this</span><span class="token comment">//属于哪个Bundle</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> module<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">//把this.statements生成代码</span>
<span class="token function">generate</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> magicString <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MagicString<span class="token punctuation">.</span>Bundle</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>statements<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">statement</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> source <span class="token operator">=</span> statement<span class="token punctuation">.</span>_source<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>statement<span class="token punctuation">.</span>type <span class="token operator">===</span> <span class="token string">'ExportNamedDeclaration'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      source<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span>statement<span class="token punctuation">.</span>start<span class="token punctuation">,</span> statement<span class="token punctuation">.</span>declaration<span class="token punctuation">.</span>start<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    magicString<span class="token punctuation">.</span><span class="token function">addSource</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      content<span class="token operator">:</span> source<span class="token punctuation">,</span>
      separator<span class="token operator">:</span> <span class="token string">'\n'</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token punctuation">{</span> code<span class="token operator">:</span> magicString<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="完整代码"><a href="#完整代码" class="header-anchor">#</a> 完整代码</h3> <h4 id="module-js"><a href="#module-js" class="header-anchor">#</a> module.js</h4> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> fs <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'fs'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> path <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'path'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> MagicString <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'magic-string'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> Module <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./module'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">class</span> <span class="token class-name">Bundle</span> <span class="token punctuation">{</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter">options</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">//入口文件的绝对路径，包括后缀</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>entryPath <span class="token operator">=</span> options<span class="token punctuation">.</span>entry<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token regex">/\.js$/</span><span class="token punctuation">,</span> <span class="token string">''</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">'.js'</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>modules <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span><span class="token comment">//存放着所有模块 入口文件和它依赖的模块</span>
  <span class="token punctuation">}</span>

  <span class="token function">build</span><span class="token punctuation">(</span><span class="token parameter">outputFileName</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">//从入口文件的绝对路径出发找到它的模块定义</span>
    <span class="token keyword">let</span> entryModule <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">fetchModule</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>entryPath<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//把这个入口模块所有的语句进行展开，返回所有的语句组成的数组</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>statements <span class="token operator">=</span> entryModule<span class="token punctuation">.</span><span class="token function">expandAllStatements</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> <span class="token punctuation">{</span> code <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">generate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    fs<span class="token punctuation">.</span><span class="token function">writeFileSync</span><span class="token punctuation">(</span>outputFileName<span class="token punctuation">,</span> code<span class="token punctuation">,</span> <span class="token string">'utf8'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">//获取模块信息</span>
  <span class="token function">fetchModule</span><span class="token punctuation">(</span><span class="token parameter">importee<span class="token punctuation">,</span> importer</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> route<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>importer<span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token comment">//如果没有模块导入此模块，说是这就是入口模块</span>
      route <span class="token operator">=</span> importee<span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>path<span class="token punctuation">.</span><span class="token function">isAbsolute</span><span class="token punctuation">(</span>importee<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token comment">//如果是绝对路径</span>
        route <span class="token operator">=</span> importee<span class="token punctuation">;</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>importee<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token string">'.'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token comment">//如果相对路径</span>
        route <span class="token operator">=</span> path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>path<span class="token punctuation">.</span><span class="token function">dirname</span><span class="token punctuation">(</span>importer<span class="token punctuation">)</span><span class="token punctuation">,</span> importee<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token regex">/\.js$/</span><span class="token punctuation">,</span> <span class="token string">''</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">'.js'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>route<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">//从硬盘上读出此模块的源代码</span>
      <span class="token keyword">let</span> code <span class="token operator">=</span> fs<span class="token punctuation">.</span><span class="token function">readFileSync</span><span class="token punctuation">(</span>route<span class="token punctuation">,</span> <span class="token string">'utf8'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">let</span> module <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Module</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
        code<span class="token punctuation">,</span><span class="token comment">//模块的源代码</span>
        path<span class="token operator">:</span> route<span class="token punctuation">,</span><span class="token comment">//模块的绝对路径</span>
        bundle<span class="token operator">:</span> <span class="token keyword">this</span><span class="token comment">//属于哪个Bundle</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span> module<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token comment">//把this.statements生成代码</span>
  <span class="token function">generate</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> magicString <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MagicString<span class="token punctuation">.</span>Bundle</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>statements<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">statement</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> source <span class="token operator">=</span> statement<span class="token punctuation">.</span>_source<span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>statement<span class="token punctuation">.</span>type <span class="token operator">===</span> <span class="token string">'ExportNamedDeclaration'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        source<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span>statement<span class="token punctuation">.</span>start<span class="token punctuation">,</span> statement<span class="token punctuation">.</span>declaration<span class="token punctuation">.</span>start<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      magicString<span class="token punctuation">.</span><span class="token function">addSource</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
        content<span class="token operator">:</span> source<span class="token punctuation">,</span>
        separator<span class="token operator">:</span> <span class="token string">'\n'</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token punctuation">{</span> code<span class="token operator">:</span> magicString<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

module<span class="token punctuation">.</span>exports <span class="token operator">=</span> Bundle<span class="token punctuation">;</span>
</code></pre></div><h4 id="bundle-js"><a href="#bundle-js" class="header-anchor">#</a> bundle.js</h4> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">let</span> MagicString <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'magic-string'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> <span class="token punctuation">{</span> parse <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'acorn'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> analyse <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./ast/analyse'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">//判断一下obj对象上是否有prop属性</span>
<span class="token keyword">function</span> <span class="token function">hasOwnProperty</span><span class="token punctuation">(</span><span class="token parameter">obj<span class="token punctuation">,</span> prop</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token class-name">Object</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function">hasOwnProperty</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>obj<span class="token punctuation">,</span> prop<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">/**
 * 每个文件都是一个模块，每个模块都会对应一个Module实例
 */</span>
<span class="token keyword">class</span> <span class="token class-name">Module</span> <span class="token punctuation">{</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> code<span class="token punctuation">,</span> path<span class="token punctuation">,</span> bundle <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>code <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MagicString</span><span class="token punctuation">(</span>code<span class="token punctuation">,</span> <span class="token punctuation">{</span> filename<span class="token operator">:</span> path <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>path <span class="token operator">=</span> path<span class="token punctuation">;</span><span class="token comment">//模块的路径</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>bundle <span class="token operator">=</span> bundle<span class="token punctuation">;</span><span class="token comment">//属于哪个bundle的实例</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>ast <span class="token operator">=</span> <span class="token function">parse</span><span class="token punctuation">(</span>code<span class="token punctuation">,</span> <span class="token punctuation">{</span><span class="token comment">//把源代码转成抽象语法树</span>
      ecmaVersion<span class="token operator">:</span> <span class="token number">7</span><span class="token punctuation">,</span>
      sourceType<span class="token operator">:</span> <span class="token string">'module'</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">analyse</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token function">analyse</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>imports <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span><span class="token comment">//存放着当前模块所有的导入</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span><span class="token comment">//存放着当前模块所有的导出</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>ast<span class="token punctuation">.</span>body<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">node</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>node<span class="token punctuation">.</span>type <span class="token operator">===</span> <span class="token string">'ImportDeclaration'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token comment">//说明这是一个导入语句</span>
        <span class="token keyword">let</span> source <span class="token operator">=</span> node<span class="token punctuation">.</span>source<span class="token punctuation">.</span>value<span class="token punctuation">;</span><span class="token comment">//./msg 从哪个模块进行的导入</span>
        <span class="token keyword">let</span> specifiers <span class="token operator">=</span> node<span class="token punctuation">.</span>specifiers<span class="token punctuation">;</span>
        specifiers<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">specifier</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
          <span class="token keyword">const</span> name <span class="token operator">=</span> specifier<span class="token punctuation">.</span>imported<span class="token punctuation">.</span>name<span class="token punctuation">;</span><span class="token comment">//name</span>
          <span class="token keyword">const</span> localName <span class="token operator">=</span> specifier<span class="token punctuation">.</span>local<span class="token punctuation">.</span>name<span class="token punctuation">;</span><span class="token comment">//name</span>
          <span class="token comment">//本地的哪个变量，是从哪个模块的的哪个变量导出的</span>
          <span class="token comment">//this.imports.age = {name:'age',localName:&quot;age&quot;,source:'./msg'};</span>
          <span class="token keyword">this</span><span class="token punctuation">.</span>imports<span class="token punctuation">[</span>localName<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span> name<span class="token punctuation">,</span> localName<span class="token punctuation">,</span> source <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//}else if(/^Export/.test(node.type)){</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>node<span class="token punctuation">.</span>type <span class="token operator">===</span> <span class="token string">'ExportNamedDeclaration'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">let</span> declaration <span class="token operator">=</span> node<span class="token punctuation">.</span>declaration<span class="token punctuation">;</span><span class="token comment">//VariableDeclaration</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>declaration<span class="token punctuation">.</span>type <span class="token operator">===</span> <span class="token string">'VariableDeclaration'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token keyword">let</span> name <span class="token operator">=</span> declaration<span class="token punctuation">.</span>declarations<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>id<span class="token punctuation">.</span>name<span class="token punctuation">;</span><span class="token comment">//age</span>
          <span class="token comment">//记录一下当前模块的导出 这个age通过哪个表达式创建的</span>
          <span class="token comment">//this.exports['age']={node,localName:age,expression}</span>
          <span class="token keyword">this</span><span class="token punctuation">.</span>exports<span class="token punctuation">[</span>name<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span>
            node<span class="token punctuation">,</span> localName<span class="token operator">:</span> name<span class="token punctuation">,</span> expression<span class="token operator">:</span> declaration
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">analyse</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>ast<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>code<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//找到了_defines 和 _dependsOn</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>definitions <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span><span class="token comment">//存放着所有的全局变量的定义语句</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>ast<span class="token punctuation">.</span>body<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">statement</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      Object<span class="token punctuation">.</span><span class="token function">keys</span><span class="token punctuation">(</span>statement<span class="token punctuation">.</span>_defines<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">name</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token comment">//key是全局变量名，值是定义这个全局变量的语句</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>definitions<span class="token punctuation">[</span>name<span class="token punctuation">]</span> <span class="token operator">=</span> statement<span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token punctuation">}</span>

  <span class="token comment">//展开这个模块里的语句，把些语句中定义的变量的语句都放到结果里</span>
  <span class="token function">expandAllStatements</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> allStatements <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>ast<span class="token punctuation">.</span>body<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">statement</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>statement<span class="token punctuation">.</span>type <span class="token operator">===</span> <span class="token string">'ImportDeclaration'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token keyword">return</span><span class="token punctuation">}</span>
      <span class="token keyword">let</span> statements <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">expandStatement</span><span class="token punctuation">(</span>statement<span class="token punctuation">)</span><span class="token punctuation">;</span>
      allStatements<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token operator">...</span>statements<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> allStatements<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">//展开一个节点</span>
  <span class="token comment">//找到当前节点依赖的变量，它访问的变量，找到这些变量的声明语句。</span>
  <span class="token comment">//这些语句可能是在当前模块声明的，也也可能是在导入的模块的声明的</span>
  <span class="token function">expandStatement</span><span class="token punctuation">(</span><span class="token parameter">statement</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> result <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> dependencies <span class="token operator">=</span> Object<span class="token punctuation">.</span><span class="token function">keys</span><span class="token punctuation">(</span>statement<span class="token punctuation">.</span>_dependsOn<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//外部依赖 [name]</span>
    dependencies<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">name</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token comment">//找到定义这个变量的声明节点，这个节点可以有在当前模块内，也可能在依赖的模块里</span>
      <span class="token keyword">let</span> definition <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">define</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
      result<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token operator">...</span>definition<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>statement<span class="token punctuation">.</span>_included<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      statement<span class="token punctuation">.</span>_included <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span><span class="token comment">//表示这个节点已经确定被纳入结果 里了，以后就不需要重复添加了</span>
      result<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>statement<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> result<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token function">define</span><span class="token punctuation">(</span><span class="token parameter">name</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">//查找一下导入变量里有没有name</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">hasOwnProperty</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>imports<span class="token punctuation">,</span> name<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">//this.imports.age = {name:'age',localName:&quot;age&quot;,source:'./msg'};</span>
      <span class="token keyword">const</span> importData <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>imports<span class="token punctuation">[</span>name<span class="token punctuation">]</span><span class="token punctuation">;</span>
      <span class="token comment">//获取msg模块 exports imports msg模块</span>
      <span class="token keyword">const</span> module <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>bundle<span class="token punctuation">.</span><span class="token function">fetchModule</span><span class="token punctuation">(</span>importData<span class="token punctuation">.</span>source<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>path<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">//this.exports['age']={node,localName:age,expression}</span>
      <span class="token keyword">const</span> exportData <span class="token operator">=</span> module<span class="token punctuation">.</span>exports<span class="token punctuation">[</span>importData<span class="token punctuation">.</span>name<span class="token punctuation">]</span><span class="token punctuation">;</span>
      <span class="token comment">//调用msg模块的define方法，参数是msg模块的本地变量名age,目的是为了返回定义age变量的语句</span>
      <span class="token keyword">return</span> module<span class="token punctuation">.</span><span class="token function">define</span><span class="token punctuation">(</span>exportData<span class="token punctuation">.</span>localName<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      <span class="token comment">//definitions是对象,key当前模块的变量名，值是定义这个变量的语句</span>
      <span class="token keyword">let</span> statement <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>definitions<span class="token punctuation">[</span>name<span class="token punctuation">]</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>statement <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>statement<span class="token punctuation">.</span>_included<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">expandStatement</span><span class="token punctuation">(</span>statement<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

module<span class="token punctuation">.</span>exports <span class="token operator">=</span> Module<span class="token punctuation">;</span>
</code></pre></div><h4 id="annlyse-js"><a href="#annlyse-js" class="header-anchor">#</a> annlyse.js</h4> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">let</span> Scope <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./scope'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">let</span> walk <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./walk'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">/**
 * 找出当前模块使用到了哪些变量
 * 还要知道哪些变量时当前模块声明的，哪些变量是导入别的模块的变量
 * @param {*} ast 语法树
 * @param {*} magicString 源代码
 * @param {*} module  属于哪个模块的
 */</span>
<span class="token keyword">function</span> <span class="token function">analyse</span><span class="token punctuation">(</span><span class="token parameter">ast<span class="token punctuation">,</span> magicString<span class="token punctuation">,</span> module</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> scope <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Scope</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//先创建一个模块内的全局作用域</span>
  <span class="token comment">//遍历当前的所有的语法树的所有的顶级节点</span>
  ast<span class="token punctuation">.</span>body<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">statement</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token comment">//给作用域添加变量 var function const let 变量声明</span>
    <span class="token keyword">function</span> <span class="token function">addToScope</span><span class="token punctuation">(</span><span class="token parameter">declaration</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">var</span> name <span class="token operator">=</span> declaration<span class="token punctuation">.</span>id<span class="token punctuation">.</span>name<span class="token punctuation">;</span><span class="token comment">//获得这个声明的变量</span>
      scope<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//把say这个变量添加到当前的全局作用域</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>scope<span class="token punctuation">.</span>parent<span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token comment">//如果当前是全局作用域的话</span>
        statement<span class="token punctuation">.</span>_defines<span class="token punctuation">[</span>name<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span><span class="token comment">//在全局作用域下声明一个全局的变量say</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    Object<span class="token punctuation">.</span><span class="token function">defineProperties</span><span class="token punctuation">(</span>statement<span class="token punctuation">,</span> <span class="token punctuation">{</span>
      _defines<span class="token operator">:</span> <span class="token punctuation">{</span> value<span class="token operator">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span> <span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token comment">//存放当前模块定义的所有的全局变量</span>
      _dependsOn<span class="token operator">:</span> <span class="token punctuation">{</span> value<span class="token operator">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span> <span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token comment">//当前模块没有定义但是使用到的变量，也就是依赖的外部变量</span>
      _included<span class="token operator">:</span> <span class="token punctuation">{</span> value<span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span> writable<span class="token operator">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token comment">//此语句是否已经 被包含到打包结果中了</span>
      <span class="token comment">//start指的是此节点在源代码中的起始索引,end就是结束索引</span>
      <span class="token comment">//magicString.snip返回的还是magicString 实例clone</span>
      _source<span class="token operator">:</span> <span class="token punctuation">{</span> value<span class="token operator">:</span> magicString<span class="token punctuation">.</span><span class="token function">snip</span><span class="token punctuation">(</span>statement<span class="token punctuation">.</span>start<span class="token punctuation">,</span> statement<span class="token punctuation">.</span>end<span class="token punctuation">)</span> <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//这一步在构建我们的作用域链</span>
    <span class="token function">walk</span><span class="token punctuation">(</span>statement<span class="token punctuation">,</span> <span class="token punctuation">{</span>
      <span class="token function">enter</span><span class="token punctuation">(</span><span class="token parameter">node</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">let</span> newScope<span class="token punctuation">;</span>
        <span class="token keyword">switch</span> <span class="token punctuation">(</span>node<span class="token punctuation">.</span>type<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token keyword">case</span> <span class="token string">'FunctionDeclaration'</span><span class="token operator">:</span>
            <span class="token keyword">const</span> params <span class="token operator">=</span> node<span class="token punctuation">.</span>params<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token parameter">x</span> <span class="token operator">=&gt;</span> x<span class="token punctuation">.</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>node<span class="token punctuation">.</span>type <span class="token operator">===</span> <span class="token string">'FunctionDeclaration'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
              <span class="token function">addToScope</span><span class="token punctuation">(</span>node<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token comment">//如果遍历到的是一个函数声明，我会创建一个新的作用域对象</span>
            newScope <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Scope</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
              parent<span class="token operator">:</span> scope<span class="token punctuation">,</span><span class="token comment">//父作用域就是当前的作用域</span>
              params
            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
          <span class="token keyword">case</span> <span class="token string">'VariableDeclaration'</span><span class="token operator">:</span> <span class="token comment">//并不会生成一个新的作用域</span>
            node<span class="token punctuation">.</span>declarations<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span>addToScope<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>newScope<span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token comment">//当前节点声明一个新的作用域</span>
          <span class="token comment">//如果此节点生成一个新的作用域，那么会在这个节点放一个_scope，指向新的作用域</span>
          Object<span class="token punctuation">.</span><span class="token function">defineProperty</span><span class="token punctuation">(</span>node<span class="token punctuation">,</span> <span class="token string">'_scope'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> value<span class="token operator">:</span> newScope <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          scope <span class="token operator">=</span> newScope<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token function">leave</span><span class="token punctuation">(</span><span class="token parameter">node</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>node<span class="token punctuation">.</span>_scope<span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token comment">//如果此节点产出了一个新的作用域，那等离开这个节点，scope回到父作用法域</span>
          scope <span class="token operator">=</span> scope<span class="token punctuation">.</span>parent<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'第一次遍历'</span><span class="token punctuation">,</span> scope<span class="token punctuation">)</span><span class="token punctuation">;</span>
  ast<span class="token punctuation">.</span>_scope <span class="token operator">=</span> scope<span class="token punctuation">;</span>
  <span class="token comment">//找出外部依赖_dependsOn</span>
  ast<span class="token punctuation">.</span>body<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">statement</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token function">walk</span><span class="token punctuation">(</span>statement<span class="token punctuation">,</span> <span class="token punctuation">{</span>
      <span class="token function">enter</span><span class="token punctuation">(</span><span class="token parameter">node</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>node<span class="token punctuation">.</span>_scope<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          scope <span class="token operator">=</span> node<span class="token punctuation">.</span>_scope<span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token comment">//如果这个节点放有一个scope属笥，说明这个节点产生了一个新的作用域</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>node<span class="token punctuation">.</span>type <span class="token operator">===</span> <span class="token string">'Identifier'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token comment">//从当前的作用域向上递归，找这个变量在哪个作用域中定义</span>
          <span class="token keyword">const</span> definingScope <span class="token operator">=</span> scope<span class="token punctuation">.</span><span class="token function">findDefiningScope</span><span class="token punctuation">(</span>node<span class="token punctuation">.</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>definingScope<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            statement<span class="token punctuation">.</span>_dependsOn<span class="token punctuation">[</span>node<span class="token punctuation">.</span>name<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span><span class="token comment">//表示这是一个外部依赖的变量</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token function">leave</span><span class="token punctuation">(</span><span class="token parameter">node</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>node<span class="token punctuation">.</span>_scope<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          scope <span class="token operator">=</span> scope<span class="token punctuation">.</span>parent<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token punctuation">}</span>

module<span class="token punctuation">.</span>exports <span class="token operator">=</span> analyse<span class="token punctuation">;</span>
</code></pre></div><h4 id="rollup-js"><a href="#rollup-js" class="header-anchor">#</a> rollup.js</h4> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">let</span> Bundle <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./bundle'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">function</span> <span class="token function">rollup</span><span class="token punctuation">(</span><span class="token parameter">entry<span class="token punctuation">,</span> outputFileName</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">//Bundle就代表打包对象，里面会包含所有的模块信息</span>
  <span class="token keyword">const</span> bundle <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Bundle</span><span class="token punctuation">(</span><span class="token punctuation">{</span> entry <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">//调用build方法开始进行编译</span>
  bundle<span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span>outputFileName<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

module<span class="token punctuation">.</span>exports <span class="token operator">=</span> rollup<span class="token punctuation">;</span>
</code></pre></div><p>其他文件代码已有，就不再贴出了。</p> <h3 id="总结"><a href="#总结" class="header-anchor">#</a> 总结</h3> <p>本文只是从rollup如何打包和tree-shaking原理出发，可以知道rollup是如何工作的，有些细节并未处理，比如作用域那块，rollup命令行使用，rollup的watch使用，这些有兴趣的可以去看下rollup源码。</p> <h3 id="参考链接"><a href="#参考链接" class="header-anchor">#</a> 参考链接</h3> <ul><li><a href="https://juejin.cn/post/6844903450287800327" target="_blank" rel="noopener noreferrer">使用 Acorn 来解析 JavaScript<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li> <li><a href="https://github.com/Rich-Harris/magic-string" target="_blank" rel="noopener noreferrer">magic-string<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li> <li><a href="https://www.cnblogs.com/woai3c/p/13584453.html" target="_blank" rel="noopener noreferrer">从 rollup 初版源码学习打包原理<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li></ul></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/note/web/rollup/rollupUse.html" class="prev">
        rollup使用教程
      </a></span> <span class="next"><a href="/note/web/wxApp/">
        目录
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/note/assets/js/app.02190172.js" defer></script><script src="/note/assets/js/2.2dccd611.js" defer></script><script src="/note/assets/js/34.684f8bf3.js" defer></script>
  </body>
</html>
