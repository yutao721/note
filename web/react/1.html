<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>react Dom-diff之初次渲染 | jiaHang的博客</title>
    <meta name="generator" content="VuePress 1.5.0">
    
    <meta name="description" content="专注前端技术栈分享，做一个爱折腾的前端">
    <link rel="preload" href="/note/assets/css/0.styles.725ed339.css" as="style"><link rel="preload" href="/note/assets/js/app.02190172.js" as="script"><link rel="preload" href="/note/assets/js/2.2dccd611.js" as="script"><link rel="preload" href="/note/assets/js/26.c4c127de.js" as="script"><link rel="prefetch" href="/note/assets/js/10.a05513c9.js"><link rel="prefetch" href="/note/assets/js/11.7ceb6923.js"><link rel="prefetch" href="/note/assets/js/12.fb88bae4.js"><link rel="prefetch" href="/note/assets/js/13.4b17ba74.js"><link rel="prefetch" href="/note/assets/js/14.ce1cd100.js"><link rel="prefetch" href="/note/assets/js/15.6a480c60.js"><link rel="prefetch" href="/note/assets/js/16.6d6b8a6a.js"><link rel="prefetch" href="/note/assets/js/17.c36721ad.js"><link rel="prefetch" href="/note/assets/js/18.77bcea9f.js"><link rel="prefetch" href="/note/assets/js/19.f262839a.js"><link rel="prefetch" href="/note/assets/js/20.5b1b9830.js"><link rel="prefetch" href="/note/assets/js/21.76b74656.js"><link rel="prefetch" href="/note/assets/js/22.e663cec2.js"><link rel="prefetch" href="/note/assets/js/23.c1f1c7e7.js"><link rel="prefetch" href="/note/assets/js/24.5ddffc93.js"><link rel="prefetch" href="/note/assets/js/25.95b0061c.js"><link rel="prefetch" href="/note/assets/js/27.234a7f7e.js"><link rel="prefetch" href="/note/assets/js/28.3bb3b4b8.js"><link rel="prefetch" href="/note/assets/js/29.1339c108.js"><link rel="prefetch" href="/note/assets/js/3.6e8c2ef0.js"><link rel="prefetch" href="/note/assets/js/30.3235f9a2.js"><link rel="prefetch" href="/note/assets/js/31.2a4efe07.js"><link rel="prefetch" href="/note/assets/js/32.d3d3c893.js"><link rel="prefetch" href="/note/assets/js/33.eaca5eef.js"><link rel="prefetch" href="/note/assets/js/34.684f8bf3.js"><link rel="prefetch" href="/note/assets/js/35.c486c7ec.js"><link rel="prefetch" href="/note/assets/js/36.2f90f872.js"><link rel="prefetch" href="/note/assets/js/37.92460be1.js"><link rel="prefetch" href="/note/assets/js/38.8532070d.js"><link rel="prefetch" href="/note/assets/js/39.9cc3b3d9.js"><link rel="prefetch" href="/note/assets/js/4.2b7fc900.js"><link rel="prefetch" href="/note/assets/js/40.3ec1b99e.js"><link rel="prefetch" href="/note/assets/js/41.d22f0de1.js"><link rel="prefetch" href="/note/assets/js/42.4796d96b.js"><link rel="prefetch" href="/note/assets/js/43.4c97d146.js"><link rel="prefetch" href="/note/assets/js/44.6e02569c.js"><link rel="prefetch" href="/note/assets/js/5.bb5b8508.js"><link rel="prefetch" href="/note/assets/js/6.ec170bea.js"><link rel="prefetch" href="/note/assets/js/7.12a33526.js"><link rel="prefetch" href="/note/assets/js/8.70ad78c1.js"><link rel="prefetch" href="/note/assets/js/9.b2f872fe.js">
    <link rel="stylesheet" href="/note/assets/css/0.styles.725ed339.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/note/" class="home-link router-link-active"><!----> <span class="site-name">jiaHang的博客</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/note/" class="nav-link">
  主页
</a></div><div class="nav-item"><a href="/note/web/" class="nav-link router-link-active">
  前端
</a></div><div class="nav-item"><a href="/note/node/" class="nav-link">
  node
</a></div><div class="nav-item"><a href="/note/interview/" class="nav-link">
  面试问题
</a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/note/" class="nav-link">
  主页
</a></div><div class="nav-item"><a href="/note/web/" class="nav-link router-link-active">
  前端
</a></div><div class="nav-item"><a href="/note/node/" class="nav-link">
  node
</a></div><div class="nav-item"><a href="/note/interview/" class="nav-link">
  面试问题
</a></div> <!----></nav>  <ul class="sidebar-links"><li><a href="/note/web/" aria-current="page" class="sidebar-link">前端</a></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>JavaScript</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>css</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>ES6</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>vue</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>react</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/note/web/react/" aria-current="page" class="sidebar-link">目录</a></li><li><a href="/note/web/react/1.html" aria-current="page" class="active sidebar-link">react初次渲染</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/note/web/react/1.html#react-dom-diff之初次渲染" class="sidebar-link">react Dom-diff之初次渲染</a></li></ul></li><li><a href="/note/web/react/2.html" class="sidebar-link">react单节点diff</a></li><li><a href="/note/web/react/3.html" class="sidebar-link">react多节点diff</a></li></ul></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>webpack</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>rollup</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>小程序</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>调试</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>其他</span> <span class="arrow right"></span></p> <!----></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h2 id="react-dom-diff之初次渲染"><a href="#react-dom-diff之初次渲染" class="header-anchor">#</a> react Dom-diff之初次渲染</h2> <h3 id="创建项目，修改内容"><a href="#创建项目，修改内容" class="header-anchor">#</a> 创建项目，修改内容</h3> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token function">yarn</span> create react-app react-dom-diff
</code></pre></div><p>使用react官方脚手架create-react-app搭建处理的项目如下：</p> <div class="language- extra-class"><pre class="language-text"><code>react-dom-diff
├── README.md
├── node_modules
├── package.json
├── .gitignore
├── public
│   ├── favicon.ico
│   ├── index.html
│   └── manifest.json
└── src
    ├── App.css
    ├── App.js
    ├── App.test.js
    ├── index.css
    ├── index.js
    ├── logo.svg
    └── serviceWorker.js
</code></pre></div><p>将不需要的文件删除，src 保留index.js，并修改如下：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">import</span> React <span class="token keyword">from</span> <span class="token string">'react'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> ReactDOM <span class="token keyword">from</span> <span class="token string">'react-dom'</span><span class="token punctuation">;</span>

<span class="token keyword">let</span> element <span class="token operator">=</span> <span class="token operator">&lt;</span>div key<span class="token operator">=</span><span class="token string">&quot;title&quot;</span> id<span class="token operator">=</span><span class="token string">&quot;title&quot;</span><span class="token operator">&gt;</span>title<span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">&gt;</span>
ReactDOM<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span>element<span class="token punctuation">,</span> document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">'root'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

</code></pre></div><p>很显然，页面上会渲染出来一个div,内容是title,react是怎么实现这整个流程渲染的呢？</p> <h3 id="createelement方法的实现"><a href="#createelement方法的实现" class="header-anchor">#</a> createElement方法的实现</h3> <p>我们先来打印下element是什么内容，看下长什么样子？</p> <p><img src="https://gitee.com/yutao618/images/raw/master/images/20211123162034.png" alt=""></p> <p>为什么会长这样？首先是使用了jsx语法，</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">let</span> element <span class="token operator">=</span> <span class="token operator">&lt;</span>div key<span class="token operator">=</span><span class="token string">&quot;title&quot;</span> id<span class="token operator">=</span><span class="token string">&quot;title&quot;</span><span class="token operator">&gt;</span>title<span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">&gt;</span>
</code></pre></div><p>这个有趣的标签语法既不是字符串也不是 HTML。</p> <p>它被称为 JSX，是一个 JavaScript 的语法扩展。我们建议在 React 中配合使用 JSX，JSX 可以很好地描述 UI 应该呈现出它应有交互的本质形式。JSX 可能会使人联想到模版语言，但它具有 JavaScript 的全部功能。</p> <p><a href="https://react.docschina.org/docs/introducing-jsx.html" target="_blank" rel="noopener noreferrer">react中jsx<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>介绍了为什么要使用jsx以及jsx的优点，还有如何使用，这里就不在介绍了，来解释一下为啥长这个样子，Babel 会把 JSX 转译成一个名为 <code>React.createElement()</code> 函数调用。</p> <p>以下两种示例代码完全等效：</p> <div class="language- extra-class"><pre class="language-text"><code>const element = (
  &lt;h1 className=&quot;greeting&quot;&gt;
    Hello, world!
  &lt;/h1&gt;
);
</code></pre></div><div class="language- extra-class"><pre class="language-text"><code>const element = React.createElement(
  'h1',
  {className: 'greeting'},
  'Hello, world!'
);
</code></pre></div><p>使用babel<a href="https://www.babeljs.cn/repl#?browsers=defaults%2C%20not%20ie%2011%2C%20not%20ie_mob%2011&amp;build=&amp;builtIns=false&amp;corejs=3.6&amp;spec=false&amp;loose=false&amp;code_lz=DYUwLgBCoLYgdpAvBAPAEwJYDcIGsQBPJAIjEzFBIk3VPMpBID4HRUB6LbZoA&amp;debug=false&amp;forceAllTransforms=false&amp;shippedProposals=false&amp;circleciRepo=&amp;evaluate=false&amp;fileSize=false&amp;timeTravel=false&amp;sourceType=module&amp;lineWrap=true&amp;presets=env%2Creact%2Cstage-2&amp;prettier=false&amp;targets=&amp;version=7.16.4&amp;externalPlugins=&amp;assumptions=%7B%7D" target="_blank" rel="noopener noreferrer">在线工具<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>能看到babel解析的结果：</p> <p><img src="https://gitee.com/yutao618/images/raw/master/images/20211123163200.png" alt=""></p> <p>那就说明react中有createElement这个方法，来实现下：</p> <p>react.js</p> <div class="language-js extra-class"><pre class="language-js"><code>mport <span class="token punctuation">{</span> <span class="token constant">REACT_ELEMENT_TYPE</span> <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./ReactSymbols'</span>
<span class="token keyword">const</span> <span class="token constant">RESERVED_PROPS</span> <span class="token operator">=</span> <span class="token punctuation">{</span>
    key<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
    ref<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
    __self<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
    __source<span class="token operator">:</span> <span class="token boolean">true</span>
<span class="token punctuation">}</span>
<span class="token comment">/**
 * 创建虚拟DOM
 * @param {*} type 元素的类型
 * @param {*} config 配置对象
 * @param {*} children 第一个儿子，如果有多个儿子的话会依次放在后面
 */</span>
<span class="token keyword">function</span> <span class="token function">createElement</span><span class="token punctuation">(</span><span class="token parameter">type<span class="token punctuation">,</span> config<span class="token punctuation">,</span> children</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> propName<span class="token punctuation">;</span>
    <span class="token keyword">const</span> props <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> key <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> ref <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>config<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>config<span class="token punctuation">.</span>key<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            key <span class="token operator">=</span> config<span class="token punctuation">.</span>key<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>config<span class="token punctuation">.</span>ref<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            ref <span class="token operator">=</span> config<span class="token punctuation">.</span>ref<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span>propName <span class="token keyword">in</span> config<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token constant">RESERVED_PROPS</span><span class="token punctuation">.</span><span class="token function">hasOwnProperty</span><span class="token punctuation">(</span>propName<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                props<span class="token punctuation">[</span>propName<span class="token punctuation">]</span> <span class="token operator">=</span> config<span class="token punctuation">[</span>propName<span class="token punctuation">]</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">const</span> childrenLength <span class="token operator">=</span> arguments<span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token number">2</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>childrenLength <span class="token operator">===</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        props<span class="token punctuation">.</span>children <span class="token operator">=</span> children<span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>childrenLength <span class="token operator">&gt;</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">const</span> childArray <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Array</span><span class="token punctuation">(</span>childrenLength<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> childrenLength<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            childArray<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> arguments<span class="token punctuation">[</span>i <span class="token operator">+</span> <span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        props<span class="token punctuation">.</span>children <span class="token operator">=</span> childArray<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token punctuation">{</span>
        $$<span class="token keyword">typeof</span><span class="token operator">:</span> <span class="token constant">REACT_ELEMENT_TYPE</span><span class="token punctuation">,</span><span class="token comment">//类型是一个React元素</span>
        type<span class="token punctuation">,</span>
        ref<span class="token punctuation">,</span>
        key<span class="token punctuation">,</span>
        props
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token keyword">const</span> React <span class="token operator">=</span> <span class="token punctuation">{</span>
    createElement
<span class="token punctuation">}</span>
<span class="token keyword">export</span> <span class="token keyword">default</span> React<span class="token punctuation">;</span>
</code></pre></div><p>ReactSymbols.js</p> <div class="language- extra-class"><pre class="language-text"><code>export const REACT_ELEMENT_TYPE = Symbol.for('react.element');
</code></pre></div><p>配置下启动脚本，package.json中修改如下：</p> <div class="language-json extra-class"><pre class="language-json"><code><span class="token property">&quot;scripts&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
  <span class="token property">&quot;start&quot;</span><span class="token operator">:</span> <span class="token string">&quot;set DISABLE_NEW_JSX_TRANSFORM=true&amp;&amp;react-scripts start&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;build&quot;</span><span class="token operator">:</span> <span class="token string">&quot;set DISABLE_NEW_JSX_TRANSFORM=true&amp;&amp;react-scripts build&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;test&quot;</span><span class="token operator">:</span> <span class="token string">&quot;set DISABLE_NEW_JSX_TRANSFORM=true&amp;&amp;react-scripts test&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;eject&quot;</span><span class="token operator">:</span> <span class="token string">&quot;set DISABLE_NEW_JSX_TRANSFORM=true&amp;&amp;react-scripts eject&quot;</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span>
</code></pre></div><blockquote><p>修改这个原因是新版本react换了jsx的编译器，目的是为了使用我们自己写的createElement</p></blockquote> <p>修改React的引入路径, ReactDOM暂时还使用官方的。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">import</span> React <span class="token keyword">from</span> <span class="token string">'./react'</span><span class="token punctuation">;</span>
</code></pre></div><p>重新启动编译下，可以看到打印log如下：</p> <p><img src="https://gitee.com/yutao618/images/raw/master/images/20211206165139.png" alt=""></p> <p>这个结果跟使用官方的基本一致，某些属性我们暂时没有做添加。</p> <h3 id="reactdom-render的实现"><a href="#reactdom-render的实现" class="header-anchor">#</a> ReactDOM.render的实现</h3> <div class="language-js extra-class"><pre class="language-js"><code>ReactDOM<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span>element<span class="token punctuation">,</span> container<span class="token punctuation">[</span><span class="token punctuation">,</span> callback<span class="token punctuation">]</span><span class="token punctuation">)</span>
</code></pre></div><blockquote><p>在提供的 <code>container</code> 里渲染一个 React 元素，并返回对该组件的引用（或者针对无状态组件返回 <code>null</code>）。如果 React 元素之前已经在 <code>container</code> 里渲染过，这将会对其执行更新操作，并仅会在必要时改变 DOM 以映射最新的 React 元素。如果提供了可选的回调函数，该回调将在组件被渲染或更新之后被执行。</p></blockquote> <h3 id="react-dom-js"><a href="#react-dom-js" class="header-anchor">#</a> react-dom.js</h3> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">import</span> <span class="token punctuation">{</span> createFiberRoot <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./ReactFiberRoot'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> updateContainer <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./ReactFiberReconciler'</span><span class="token punctuation">;</span>
<span class="token keyword">function</span> <span class="token function">render</span><span class="token punctuation">(</span><span class="token parameter">element<span class="token punctuation">,</span> container</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> fiberRoot <span class="token operator">=</span> <span class="token function">createFiberRoot</span><span class="token punctuation">(</span>container<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">updateContainer</span><span class="token punctuation">(</span>element<span class="token punctuation">,</span> fiberRoot<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">const</span> ReactDOM <span class="token operator">=</span> <span class="token punctuation">{</span>
    render
<span class="token punctuation">}</span>
<span class="token keyword">export</span> <span class="token keyword">default</span> ReactDOM<span class="token punctuation">;</span>
</code></pre></div><div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">let</span> fiberRoot <span class="token operator">=</span> <span class="token function">createFiberRoot</span><span class="token punctuation">(</span>container<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">updateContainer</span><span class="token punctuation">(</span>element<span class="token punctuation">,</span> fiberRoot<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>其中，这2行代码是比较核心的，createFiberRoot函数就是根据容器对象（ div#root）来生成一个根fiber。</p> <p>关于fiber架构以及调度我会单独再用文章去做阐述，我们这里只简单了解下fiber。</p> <h3 id="fiber是什么？"><a href="#fiber是什么？" class="header-anchor">#</a> fiber是什么？</h3> <ul><li>为了让渲染的过程可以不断，我们可以把整个渲染任务分成若干个task(工作单元)，每个工作单元就是一个fiber</li> <li>每个虚拟DOM节点内部表示为一个fiber对象</li> <li>render阶段会根据虚拟DOM以深度优先的方式构建fiber</li></ul> <h3 id="fiber数据结构"><a href="#fiber数据结构" class="header-anchor">#</a> fiber数据结构</h3> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">FiberNode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>tag <span class="token operator">=</span> tag<span class="token punctuation">;</span>                  <span class="token comment">// fiber 标签 证明是什么类型fiber。</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>key <span class="token operator">=</span> key<span class="token punctuation">;</span>                  <span class="token comment">// key调和子节点时候用到。 </span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>type <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>                <span class="token comment">// dom元素是对应的元素类型，比如div，组件指向组件对应的类或者函数。  </span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>stateNode <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>           <span class="token comment">// 指向对应的真实dom元素，类组件指向组件实例，可以被ref获取。</span>
 
  <span class="token keyword">this</span><span class="token punctuation">.</span>return <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>              <span class="token comment">// 指向父级fiber</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>child <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>               <span class="token comment">// 指向子级fiber</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>sibling <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>             <span class="token comment">// 指向兄弟fiber </span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>index <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>                  <span class="token comment">// 索引</span>

  <span class="token keyword">this</span><span class="token punctuation">.</span>ref <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>                 <span class="token comment">// ref指向，ref函数，或者ref对象。</span>

  <span class="token keyword">this</span><span class="token punctuation">.</span>pendingProps <span class="token operator">=</span> pendingProps<span class="token punctuation">;</span><span class="token comment">// 在一次更新中，代表element创建</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>memoizedProps <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>       <span class="token comment">// 记录上一次更新完毕后的props</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>updateQueue <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>         <span class="token comment">// 类组件存放setState更新队列，函数组件存放</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>memoizedState <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>       <span class="token comment">// 类组件保存state信息，函数组件保存hooks信息，dom元素为null</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>dependencies <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>        <span class="token comment">// context或是时间的依赖项</span>

  <span class="token keyword">this</span><span class="token punctuation">.</span>mode <span class="token operator">=</span> mode<span class="token punctuation">;</span>                <span class="token comment">//描述fiber树的模式，比如 ConcurrentMode 模式</span>

  <span class="token keyword">this</span><span class="token punctuation">.</span>effectTag <span class="token operator">=</span> NoEffect<span class="token punctuation">;</span>       <span class="token comment">// effect标签，用于收集effectList</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>nextEffect <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>          <span class="token comment">// 指向下一个effect</span>

  <span class="token keyword">this</span><span class="token punctuation">.</span>firstEffect <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>         <span class="token comment">// 第一个effect</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>lastEffect <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>          <span class="token comment">// 最后一个effect</span>

  <span class="token keyword">this</span><span class="token punctuation">.</span>expirationTime <span class="token operator">=</span> NoWork<span class="token punctuation">;</span>    <span class="token comment">// 通过不同过期时间，判断任务是否过期， 在v17版本用lane表示。</span>

  <span class="token keyword">this</span><span class="token punctuation">.</span>alternate <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>           <span class="token comment">//双缓存树，指向缓存的fiber。更新阶段，两颗树互相交替。</span>
<span class="token punctuation">}</span>

</code></pre></div><p>type 就是react的元素类型</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">export</span> <span class="token keyword">const</span> FunctionComponent <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>       <span class="token comment">// 对应函数组件</span>
<span class="token keyword">export</span> <span class="token keyword">const</span> ClassComponent <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>          <span class="token comment">// 对应的类组件</span>
<span class="token keyword">export</span> <span class="token keyword">const</span> IndeterminateComponent <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span>  <span class="token comment">// 初始化的时候不知道是函数组件还是类组件 </span>
<span class="token keyword">export</span> <span class="token keyword">const</span> HostRoot <span class="token operator">=</span> <span class="token number">3</span><span class="token punctuation">;</span>                <span class="token comment">// Root Fiber 可以理解为跟元素 ， 通过reactDom.render()产生的根元素</span>
<span class="token keyword">export</span> <span class="token keyword">const</span> HostPortal <span class="token operator">=</span> <span class="token number">4</span><span class="token punctuation">;</span>              <span class="token comment">// 对应  ReactDOM.createPortal 产生的 Portal </span>
<span class="token keyword">export</span> <span class="token keyword">const</span> HostComponent <span class="token operator">=</span> <span class="token number">5</span><span class="token punctuation">;</span>           <span class="token comment">// dom 元素 比如 &lt;div&gt;</span>
<span class="token keyword">export</span> <span class="token keyword">const</span> HostText <span class="token operator">=</span> <span class="token number">6</span><span class="token punctuation">;</span>                <span class="token comment">// 文本节点</span>
<span class="token keyword">export</span> <span class="token keyword">const</span> Fragment <span class="token operator">=</span> <span class="token number">7</span><span class="token punctuation">;</span>                <span class="token comment">// 对应 &lt;React.Fragment&gt; </span>
<span class="token keyword">export</span> <span class="token keyword">const</span> Mode <span class="token operator">=</span> <span class="token number">8</span><span class="token punctuation">;</span>                    <span class="token comment">// 对应 &lt;React.StrictMode&gt;   </span>
<span class="token keyword">export</span> <span class="token keyword">const</span> ContextConsumer <span class="token operator">=</span> <span class="token number">9</span><span class="token punctuation">;</span>         <span class="token comment">// 对应 &lt;Context.Consumer&gt;</span>
<span class="token keyword">export</span> <span class="token keyword">const</span> ContextProvider <span class="token operator">=</span> <span class="token number">10</span><span class="token punctuation">;</span>        <span class="token comment">// 对应 &lt;Context.Provider&gt;</span>
<span class="token keyword">export</span> <span class="token keyword">const</span> ForwardRef <span class="token operator">=</span> <span class="token number">11</span><span class="token punctuation">;</span>             <span class="token comment">// 对应 React.ForwardRef</span>
<span class="token keyword">export</span> <span class="token keyword">const</span> Profiler <span class="token operator">=</span> <span class="token number">12</span><span class="token punctuation">;</span>               <span class="token comment">// 对应 &lt;Profiler/ &gt;</span>
<span class="token keyword">export</span> <span class="token keyword">const</span> SuspenseComponent <span class="token operator">=</span> <span class="token number">13</span><span class="token punctuation">;</span>      <span class="token comment">// 对应 &lt;Suspense&gt;</span>
<span class="token keyword">export</span> <span class="token keyword">const</span> MemoComponent <span class="token operator">=</span> <span class="token number">14</span><span class="token punctuation">;</span>          <span class="token comment">// 对应 React.memo 返回的组件</span>

</code></pre></div><p>再回来看下createFiberRoot的实现</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">createFiberRoot</span><span class="token punctuation">(</span><span class="token parameter">containerInfo</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> fiberRoot <span class="token operator">=</span> <span class="token punctuation">{</span> containerInfo <span class="token punctuation">}</span><span class="token punctuation">;</span><span class="token comment">//fiberRoot指的就是容器对象containerInfo div#root</span>
  <span class="token comment">//创建fiber树的根节点 </span>
  <span class="token keyword">const</span> hostRootFiber <span class="token operator">=</span> <span class="token function">createHostRootFiber</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">//当前的fiberRoot的current指向这个根fiber</span>
  <span class="token comment">//current当前的意思，它指的当前跟我们页面中真实DOM相同的fiber树</span>
  fiberRoot<span class="token punctuation">.</span>current <span class="token operator">=</span> hostRootFiber<span class="token punctuation">;</span>
  <span class="token comment">//让此根fiber的真实DOM节点指向fiberRoot  div#root   stateNode就是指的真实DOM的意思</span>
  hostRootFiber<span class="token punctuation">.</span>stateNode <span class="token operator">=</span> fiberRoot<span class="token punctuation">;</span>
  <span class="token keyword">return</span> fiberRoot<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>createHostRootFiber的实现如下</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">import</span> <span class="token punctuation">{</span> HostComponent<span class="token punctuation">,</span> HostRoot <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./ReactWorkTags'</span><span class="token punctuation">;</span>
<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">createHostRootFiber</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token function">createFiber</span><span class="token punctuation">(</span>HostRoot<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>HostRoot其实就是对应的3，也就是对应的根元素</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">/**
 * 创建fiber节点
 * @param {*} tag fiber的标签 HostRoot指的是根节点 div span HostComponent
 * @param {*} pendingProps 等待生效的属性对象
 * @param {*} key 
 */</span>
<span class="token keyword">function</span> <span class="token function">createFiber</span><span class="token punctuation">(</span><span class="token parameter">tag<span class="token punctuation">,</span> pendingProps<span class="token punctuation">,</span> key</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">FiberNode</span><span class="token punctuation">(</span>tag<span class="token punctuation">,</span> pendingProps<span class="token punctuation">,</span> key<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>FiberNode是一个构造函数，createFiber就是根据不同类型，生成不同的fiber节点</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">FiberNode</span><span class="token punctuation">(</span><span class="token parameter">tag<span class="token punctuation">,</span> pendingProps<span class="token punctuation">,</span> key</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>tag <span class="token operator">=</span> tag<span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>pendingProps <span class="token operator">=</span> pendingProps<span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>key <span class="token operator">=</span> key<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>FiberNode其实有很多属性，暂且只添加这3个，updateContainer(element, fiberRoot)这个暂时没有实现，先注释掉，打印下fiberRoot看下长什么样:</p> <div class="language-diff extra-class"><pre class="language-diff"><code>function render(element, container) {
<span class="token unchanged">  let fiberRoot = createFiberRoot(container);
</span><span class="token inserted-sign inserted">+  console.log(fiberRoot);
+  // updateContainer(element, fiberRoot);
</span>}
</code></pre></div><p><img src="https://gitee.com/yutao618/images/raw/master/images/20211207095802.png" alt=""></p> <p>用下图可以表示出fiberRoot与hostRootFiber的关系：</p> <p><img src="https://gitee.com/yutao618/images/raw/master/images/20211207102812.png" alt=""></p> <p>到此，我们只是描述出了一个节点对应的fiber，渲染或者更新的时候fiber内部是如何知道怎么更新的呢？</p> <div class="language-diff extra-class"><pre class="language-diff"><code>export function createFiberRoot(containerInfo) {
<span class="token unchanged">  const fiberRoot = { containerInfo };//fiberRoot指的就是容器对象containerInfo div#root
  //创建fiber树的根节点
  const hostRootFiber = createHostRootFiber();
  //当前的fiberRoot的curent指向这个根fiber
  //current当前的意思，它指的当前跟我们页面中真实DOM相同的fiber树
  fiberRoot.current = hostRootFiber;
  //让此根fiber的真实DOM节点指向fiberRoot  div#root   stateNode就是指的真实DOM的意思
  hostRootFiber.stateNode = fiberRoot;
</span><span class="token inserted-sign inserted">+  initializeUpdateQueue(hostRootFiber);
</span><span class="token unchanged">  return fiberRoot;
</span>}
</code></pre></div><p>实际上在==createFiberRoot()==的时候会有一个<strong>initializeUpdateQueue(hostRootFiber)<strong>的操作,初始化更新队列,所有的fiber都会等待理更新内容放在更新队列中,来看下</strong>initializeUpdateQueue</strong>的实现：</p> <h3 id="initializeupdatequeue"><a href="#initializeupdatequeue" class="header-anchor">#</a> initializeUpdateQueue()</h3> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">initializeUpdateQueue</span><span class="token punctuation">(</span><span class="token parameter">fiber</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> updateQueue <span class="token operator">=</span> <span class="token punctuation">{</span>
    shared<span class="token operator">:</span> <span class="token punctuation">{</span>
      pending<span class="token operator">:</span> <span class="token keyword">null</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  fiber<span class="token punctuation">.</span>updateQueue <span class="token operator">=</span> updateQueue<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">createUpdate</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>这个其实就很简单，给fiber添加了一个updateQueue的属性，形成一个环状链表，如下图：</p> <p><img src="https://gitee.com/yutao618/images/raw/master/images/20211207110703.png" alt=""></p> <p>initializeUpdateQueue不仅有createUpdate方法还有enqueueUpdate方法，enqueueUpdate的操作就是向当前的fiber的更新队列中添加一个更新，来实现下：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">/**
 * 向当前的fiber的更新队列中添加一个更新
 * @param {*} fiber
 * @param {*} update
 */</span>
<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">enqueueUpdate</span><span class="token punctuation">(</span><span class="token parameter">fiber<span class="token punctuation">,</span> update</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> updateQueue <span class="token operator">=</span> fiber<span class="token punctuation">.</span>updateQueue<span class="token punctuation">;</span>
  <span class="token keyword">const</span> sharedQueue <span class="token operator">=</span> updateQueue<span class="token punctuation">.</span>shared<span class="token punctuation">;</span>
  <span class="token keyword">const</span> pending <span class="token operator">=</span> sharedQueue<span class="token punctuation">.</span>pending<span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>pending<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    update<span class="token punctuation">.</span>next <span class="token operator">=</span> update<span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    update<span class="token punctuation">.</span>next <span class="token operator">=</span> pending<span class="token punctuation">.</span>next<span class="token punctuation">;</span>
    pending<span class="token punctuation">.</span>next <span class="token operator">=</span> update<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  sharedQueue<span class="token punctuation">.</span>pending <span class="token operator">=</span> update<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>怎么理解这个呢，首先在initializeUpdateQueue的时候，fiber添加了一个updateQueue，而updateQueue中有shared，shared中有个pending，这些都很好理解。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>pending<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	update<span class="token punctuation">.</span>next <span class="token operator">=</span> update<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>pending为null的时候，把这个更新的next指向自己，什么意思呢，假如现在有个update1，它的指向如下图：</p> <p><img src="https://gitee.com/yutao618/images/raw/master/images/20211207112237.png" alt=""></p> <div class="language-js extra-class"><pre class="language-js"><code>sharedQueue<span class="token punctuation">.</span>pending <span class="token operator">=</span> update<span class="token punctuation">;</span>
</code></pre></div><p>在最后面有这样的一个执行，执行完之后就可以用下图来表示：</p> <p><img src="https://gitee.com/yutao618/images/raw/master/images/20211207113020.png" alt=""></p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">else</span> <span class="token punctuation">{</span>
	update<span class="token punctuation">.</span>next <span class="token operator">=</span> pending<span class="token punctuation">.</span>next<span class="token punctuation">;</span>
	pending<span class="token punctuation">.</span>next <span class="token operator">=</span> update<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>如果还有下次更新那么就会走到else分支，如果还有个update2,通过update.next = pending.next操作之后就相当于update2.next = update1.next，然后把pending的next指向这次更新，如下2图所示：</p> <p><img src="https://gitee.com/yutao618/images/raw/master/images/20211207133138.png" alt=""></p> <p>上图为update.next = pending.next;</p> <p><img src="https://gitee.com/yutao618/images/raw/master/images/20211207133138.png" alt=""></p> <p>上图为pending.next = update;</p> <p>如果有更多，那就像下图一样，依次往下：</p> <p><img src="https://gitee.com/yutao618/images/raw/master/images/20211207134256.png" alt=""></p> <p><strong>pending永远都指向最新的更新，pending.next永远指向第一个更新</strong></p> <h3 id="initializeupdatequeue-测试"><a href="#initializeupdatequeue-测试" class="header-anchor">#</a> initializeUpdateQueue()测试</h3> <p>initializeUpdateQueue.test.js</p> <div class="language-js extra-class"><pre class="language-js"><code>
<span class="token keyword">function</span> <span class="token function">initializeUpdateQueue</span><span class="token punctuation">(</span><span class="token parameter">fiber</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> updateQueue <span class="token operator">=</span> <span class="token punctuation">{</span>
    shared<span class="token operator">:</span> <span class="token punctuation">{</span>
      pending<span class="token operator">:</span> <span class="token keyword">null</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  fiber<span class="token punctuation">.</span>updateQueue <span class="token operator">=</span> updateQueue<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">createUpdate</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>


<span class="token keyword">function</span> <span class="token function">enqueueUpdate</span><span class="token punctuation">(</span><span class="token parameter">fiber<span class="token punctuation">,</span> update</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> updateQueue <span class="token operator">=</span> fiber<span class="token punctuation">.</span>updateQueue<span class="token punctuation">;</span>
  <span class="token keyword">const</span> sharedQueue <span class="token operator">=</span> updateQueue<span class="token punctuation">.</span>shared<span class="token punctuation">;</span>
  <span class="token keyword">const</span> pending <span class="token operator">=</span> sharedQueue<span class="token punctuation">.</span>pending<span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>pending<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    update<span class="token punctuation">.</span>next <span class="token operator">=</span> update<span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    update<span class="token punctuation">.</span>next <span class="token operator">=</span> pending<span class="token punctuation">.</span>next<span class="token punctuation">;</span>
    pending<span class="token punctuation">.</span>next <span class="token operator">=</span> update<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  sharedQueue<span class="token punctuation">.</span>pending <span class="token operator">=</span> update<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">let</span> fiber <span class="token operator">=</span> <span class="token punctuation">{</span> baseState<span class="token operator">:</span> <span class="token punctuation">{</span> number<span class="token operator">:</span> <span class="token number">0</span> <span class="token punctuation">}</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token function">initializeUpdateQueue</span><span class="token punctuation">(</span>fiber<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> update1 <span class="token operator">=</span> <span class="token function">createUpdate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
update1<span class="token punctuation">.</span>payload <span class="token operator">=</span> <span class="token punctuation">{</span> number<span class="token operator">:</span> <span class="token number">1</span> <span class="token punctuation">}</span><span class="token punctuation">;</span><span class="token comment">//update1 = {payload:{number:1}}</span>
<span class="token comment">//把update1添加到更新队列链表里</span>
<span class="token function">enqueueUpdate</span><span class="token punctuation">(</span>fiber<span class="token punctuation">,</span> update1<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> update2 <span class="token operator">=</span> <span class="token function">createUpdate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
update2<span class="token punctuation">.</span>payload <span class="token operator">=</span> <span class="token punctuation">{</span> number<span class="token operator">:</span> <span class="token number">2</span> <span class="token punctuation">}</span><span class="token punctuation">;</span><span class="token comment">//update2 = {payload:{number:2}}</span>
<span class="token comment">//把update2添加到更新队列链表里</span>
<span class="token function">enqueueUpdate</span><span class="token punctuation">(</span>fiber<span class="token punctuation">,</span> update2<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> update3 <span class="token operator">=</span> <span class="token function">createUpdate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
update3<span class="token punctuation">.</span>payload <span class="token operator">=</span> <span class="token punctuation">{</span> number<span class="token operator">:</span> <span class="token number">3</span> <span class="token punctuation">}</span><span class="token punctuation">;</span><span class="token comment">//update3 = {payload:{number:3}}</span>
<span class="token comment">//把update1添加到更新队列链表里</span>
<span class="token function">enqueueUpdate</span><span class="token punctuation">(</span>fiber<span class="token punctuation">,</span> update3<span class="token punctuation">)</span><span class="token punctuation">;</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>fiber<span class="token punctuation">.</span>updateQueue<span class="token punctuation">.</span>shared<span class="token punctuation">.</span>pending<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p><img src="https://gitee.com/yutao618/images/raw/master/images/20211207140846.png" alt=""></p> <p>可以看到结果是pending指向{number:3}，它的next指向{number:1}，是一个循环链表的结构。</p> <p><img src="https://gitee.com/yutao618/images/raw/master/images/20211207141604.png" alt=""></p> <p>再看看fiberRoot的打印结果，fiberRoot.current中就增加了一个updateQuene,现在还没有更新，所以它的pending就是null。那接下来，我们需要处理什么呢，没错就是在render注释掉的updateContainer()方法。</p> <h3 id="updatecontainer"><a href="#updatecontainer" class="header-anchor">#</a> updateContainer()</h3> <blockquote><p>updateContainer的作用就是把虚拟DOM element变成真实DOM插入或者说渲染到container容器中</p></blockquote> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">import</span> <span class="token punctuation">{</span> createUpdate<span class="token punctuation">,</span> enqueueUpdate <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./ReactUpdateQueue'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> scheduleUpdateOnFiber <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./ReactFiberWorkLoop'</span><span class="token punctuation">;</span>

<span class="token comment">/**
 * 把虚拟DOM element变成真实DOM插入或者说渲染到container容器中
 * @param {*} element
 * @param {*} container
 */</span>
<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">updateContainer</span><span class="token punctuation">(</span><span class="token parameter">element<span class="token punctuation">,</span> container</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">//获取hostRootFiber fiber根的根节点</span>
  <span class="token comment">//正常来说一个fiber节点会对应一个真实DOM节点，hostRootFiber对应的DOM节点就是containerInfo div#root</span>
  <span class="token keyword">const</span> current <span class="token operator">=</span> container<span class="token punctuation">.</span>current<span class="token punctuation">;</span>
  <span class="token keyword">const</span> update <span class="token operator">=</span> <span class="token function">createUpdate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  update<span class="token punctuation">.</span>payload <span class="token operator">=</span> <span class="token punctuation">{</span> element <span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token function">enqueueUpdate</span><span class="token punctuation">(</span>current<span class="token punctuation">,</span> update<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">scheduleUpdateOnFiber</span><span class="token punctuation">(</span>current<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p><strong>createUpdate</strong>和<strong>enqueueUpdate</strong>在之前已经实现过验证过了，scheduleUpdateOnFiber顾名思义就是调度fiber的更新队列，接下来我们实现<strong>scheduleUpdateOnFiber</strong>这个方法。</p> <h3 id="scheduleupdateonfiber-的实现"><a href="#scheduleupdateonfiber-的实现" class="header-anchor">#</a> scheduleUpdateOnFiber()的实现</h3> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">scheduleUpdateOnFiber</span><span class="token punctuation">(</span><span class="token parameter">fiber</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> fiberRoot <span class="token operator">=</span> <span class="token function">markUpdateLaneFromFiberToRoot</span><span class="token punctuation">(</span>fiber<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">performSyncWorkOnRoot</span><span class="token punctuation">(</span>fiberRoot<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>这个方法，不管如何更新，不管谁来更新，都会调度到这个方法里，<strong>markUpdateLaneFromFiberToRoot</strong>就是根据当前fiber节点找到根fiber,并且返回了根fiber对应的真实DOM节点，来实现下：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">markUpdateLaneFromFiberToRoot</span><span class="token punctuation">(</span><span class="token parameter">sourceFiber</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> node <span class="token operator">=</span> sourceFiber<span class="token punctuation">;</span>
  <span class="token keyword">let</span> parent <span class="token operator">=</span> node<span class="token punctuation">.</span>return<span class="token punctuation">;</span>
  <span class="token keyword">while</span> <span class="token punctuation">(</span>parent<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    node <span class="token operator">=</span> parent<span class="token punctuation">;</span>
    parent <span class="token operator">=</span> parent<span class="token punctuation">.</span>return<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token comment">//node其实肯定fiber树的根节点，其实就是 hostRootFiber .stateNode div#root</span>
  <span class="token keyword">return</span> node<span class="token punctuation">.</span>stateNode<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>在拿到根节点之后，执行performSyncWorkOnRoot(fiberRoot),它的主要用途就是根据老的fiber树和更新对象创建新的fiber树，然后根据新的fiber树更新真实DOM。具体如下：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 当前正在更新的根</span>
<span class="token keyword">let</span> workInProgressRoot <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
<span class="token comment">// 当前正在更新fiber节点</span>
<span class="token keyword">let</span> workInProgress <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
<span class="token comment">/**
 * 根据老的fiber树和更新对象创建新的fiber树，然后根据新的fiber树更新真实DOM
 * @param {*} fiberRoot
 */</span>
<span class="token keyword">function</span> <span class="token function">performSyncWorkOnRoot</span><span class="token punctuation">(</span><span class="token parameter">fiberRoot</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  workInProgressRoot <span class="token operator">=</span> fiberRoot<span class="token punctuation">;</span>
  workInProgress <span class="token operator">=</span> <span class="token function">createWorkInProgress</span><span class="token punctuation">(</span>workInProgressRoot<span class="token punctuation">.</span>current<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>创建了2个变量，workInProgressRoot和workInProgress，分别是当前正在更新的根和当前正在更新fiber节点。</p> <h3 id="双缓冲"><a href="#双缓冲" class="header-anchor">#</a> 双缓冲</h3> <p><a href="https://link.juejin.cn?target=https%3A%2F%2Fbaike.baidu.com%2Fitem%2F%E5%8F%8C%E7%BC%93%E5%86%B2" target="_blank" rel="noopener noreferrer">双缓存<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>机制是一种在内存中构建并直接替换的技术。React在协调的过程中就使用了这种技术。</p> <p>在React中同时存在着两棵fiber tree。一棵是在屏幕上显示的dom对应的fiber tree，称为current fiber tree，而还有一棵是当触发新的更新任务时，React在内存中构建的fiber tree，称为workInProgress fiber tree。</p> <p>current fiber tree和workInProgress fiber tree中的fiber节点通过alternate属性进行连接。</p> <div class="language-js extra-class"><pre class="language-js"><code>currentFiber<span class="token punctuation">.</span>alternate <span class="token operator">===</span> workInProgressFiber<span class="token punctuation">;</span>
workInProgressFiber<span class="token punctuation">.</span>alternate <span class="token operator">===</span> currentFiber<span class="token punctuation">;</span>

</code></pre></div><p>React应用的根节点中也存在current属性，利用current属性在不同fiber tree的根节点之间进行切换的操作，就能够完成current fiber tree与workInProgress fiber tree之间的切换。</p> <p>在协调阶段，React利用<code>diff算法</code>，将产生update的<code>React element</code>与<code>current fiber tree</code>中的节点进行比较，并最终在内存中生成workInProgress fiber tree。此时Renderer会依据workInProgress fiber tree将update渲染到页面上。同时根节点的current属性会指向workInProgress fiber tree，此时workInProgress fiber tree就变为current fiber tree。</p> <h3 id="createworkinprogress"><a href="#createworkinprogress" class="header-anchor">#</a> createWorkInProgress</h3> <p>createWorkInProgress就是根据老fiber创建新的fiber，具体实现如下：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">/**
 * 根据老fiber创建新的fiber
 * @param {*} current 老fiber
 * @param {*} pendingProps 等待生效的属性对象
 */</span>
<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">createWorkInProgress</span><span class="token punctuation">(</span><span class="token parameter">current<span class="token punctuation">,</span> pendingProps</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> workInProgress <span class="token operator">=</span> current<span class="token punctuation">.</span>alternate<span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>workInProgress<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    workInProgress <span class="token operator">=</span> <span class="token function">createFiber</span><span class="token punctuation">(</span>current<span class="token punctuation">.</span>tag<span class="token punctuation">,</span> pendingProps<span class="token punctuation">,</span> current<span class="token punctuation">.</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>
    workInProgress<span class="token punctuation">.</span>type <span class="token operator">=</span> current<span class="token punctuation">.</span>type<span class="token punctuation">;</span>
    workInProgress<span class="token punctuation">.</span>stateNode <span class="token operator">=</span> current<span class="token punctuation">.</span>stateNode<span class="token punctuation">;</span>
    workInProgress<span class="token punctuation">.</span>alternate <span class="token operator">=</span> current<span class="token punctuation">;</span>
    current<span class="token punctuation">.</span>alternate <span class="token operator">=</span> workInProgress<span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    workInProgress<span class="token punctuation">.</span>pendingProps <span class="token operator">=</span> pendingProps<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  workInProgress<span class="token punctuation">.</span>flags <span class="token operator">=</span> NoFlags<span class="token punctuation">;</span>
  workInProgress<span class="token punctuation">.</span>child <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
  workInProgress<span class="token punctuation">.</span>sibling <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
  workInProgress<span class="token punctuation">.</span>updateQueue <span class="token operator">=</span> current<span class="token punctuation">.</span>updateQueue<span class="token punctuation">;</span>
  <span class="token comment">//在dom diff的过程会给fiber添加副作用</span>
  workInProgress<span class="token punctuation">.</span>firstEffect <span class="token operator">=</span> workInProgress<span class="token punctuation">.</span>lastEffect <span class="token operator">=</span> workInProgress<span class="token punctuation">.</span>nextEffect <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> workInProgress<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p><img src="https://gitee.com/yutao618/images/raw/master/images/20211207152405.png" alt=""></p> <p>createWorkInProgress在执行的时候，先去拿current.alternate，此时肯定是没有的，那我们就根据这个创建一个新的fiber，并且通过</p> <div class="language-js extra-class"><pre class="language-js"><code>workInProgress<span class="token punctuation">.</span>alternate <span class="token operator">=</span> current<span class="token punctuation">;</span>
current<span class="token punctuation">.</span>alternate <span class="token operator">=</span> workInProgress<span class="token punctuation">;</span>
</code></pre></div><p>workInProgress和current的alternate互相指向，这个也就是在react中的双缓冲使用了。</p> <p><img src="https://gitee.com/yutao618/images/raw/master/images/20211208102908.png" alt=""></p> <p>current和workInProgress就会在后面跟新的时候来回切换，workInProgress就是当前正在构建的fiber树，current代表的是和当前页面中真实DOM完全一样的fiber树，在后面dom-diff的时候会比较他们的区别。</p> <p><img src="https://gitee.com/yutao618/images/raw/master/images/20211208103704.png" alt=""></p> <p>可以从打印的日志中可以看到，current中多了alternate。到此render阶段根据vdom生成fiber树就此完成，接下来就是fiber树的工作了。</p> <h3 id="workloopsync工作循环"><a href="#workloopsync工作循环" class="header-anchor">#</a> workLoopSync工作循环</h3> <div class="language-diff extra-class"><pre class="language-diff"><code>function performSyncWorkOnRoot(fiberRoot) {
<span class="token unchanged">  workInProgressRoot = fiberRoot;
  workInProgress = createWorkInProgress(workInProgressRoot.current);
</span><span class="token inserted-sign inserted">+	workLoopSync();//执行工作循环，构建副作用链
</span>}
</code></pre></div><div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">/**
 * 开始自上而下构建新的fiber树
 */</span>
<span class="token keyword">function</span> <span class="token function">workLoopSync</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">while</span> <span class="token punctuation">(</span>workInProgress<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">performUnitOfWork</span><span class="token punctuation">(</span>workInProgress<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>workLoopSync的时候，react是有一个调度任务的，根据浏览器以及程序的优先级来判断是否药中断fibre的render。performUnitOfWork为处理每一个fiber，可以看到每个节点都会走<strong>beginWork</strong>和<strong>completeUnitOfWork</strong>，对应的就是fiber的开始和结束。unitOfWork.alternate前面也说过了对应的就是和当前页面中真实DOM完全一样的fiber树。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">/**
 * 执行单个工作单元
 * unitOfWork 要处理的fiber
 */</span>
<span class="token keyword">function</span> <span class="token function">performUnitOfWork</span><span class="token punctuation">(</span><span class="token parameter">unitOfWork</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">//获取当前正在构建的fiber的替身</span>
  <span class="token keyword">const</span> current <span class="token operator">=</span> unitOfWork<span class="token punctuation">.</span>alternate<span class="token punctuation">;</span>
  <span class="token comment">//开始构建当前fiber的子fiber链表</span>
  <span class="token comment">//它会返回下一个要处理的fiber,一般都是unitOfWork的大儿子</span>
  <span class="token comment">//div#title这个fiber 它的返回值是一个null</span>
  <span class="token keyword">let</span> next <span class="token operator">=</span> <span class="token function">beginWork</span><span class="token punctuation">(</span>current<span class="token punctuation">,</span> unitOfWork<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">//在beginWork后，需要把新属性同步到老属性上</span>
  <span class="token comment">//div id =1 memoizedProps={id:2}   pendingProps ={id:2}</span>
  unitOfWork<span class="token punctuation">.</span>memoizedProps <span class="token operator">=</span> unitOfWork<span class="token punctuation">.</span>pendingProps<span class="token punctuation">;</span>
  <span class="token comment">//当前的fiber还有子节点</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>next<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    workInProgress <span class="token operator">=</span> next<span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token comment">//如果当前fiber没有子fiber,那么当前的fiber就算完成</span>
    <span class="token function">completeUnitOfWork</span><span class="token punctuation">(</span>unitOfWork<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>beginWork就是构建当前fiber的子fiber链表，并且返回下一个要处理的fiber。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">/**
 * 创建当前fiber的子fiber
 * @param current
 * @param workInProgress
 * @returns {*} 下一个fiber
 */</span>
<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">beginWork</span><span class="token punctuation">(</span><span class="token parameter">current<span class="token punctuation">,</span> workInProgress</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">switch</span> <span class="token punctuation">(</span>workInProgress<span class="token punctuation">.</span>tag<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">case</span> HostRoot<span class="token operator">:</span>
      <span class="token keyword">return</span> <span class="token function">updateHostRoot</span><span class="token punctuation">(</span>current<span class="token punctuation">,</span> workInProgress<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">case</span> HostComponent<span class="token operator">:</span>
      <span class="token keyword">return</span> <span class="token function">updateHostComponent</span><span class="token punctuation">(</span>current<span class="token punctuation">,</span> workInProgress<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">default</span><span class="token operator">:</span>
      <span class="token keyword">break</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="fiber-执行阶段"><a href="#fiber-执行阶段" class="header-anchor">#</a> Fiber 执行阶段</h3> <ul><li>每次渲染有两个阶段：Reconciliation(协调\render 阶段)和 Commit(提交阶段)</li> <li>协调阶段: 可以认为是 Diff 阶段, 这个阶段可以被中断, 这个阶段会找出所有节点变更，例如节点新增、删除、属性变更等等, 这些变更 React 称之为副作用(Effect)</li> <li>提交阶段: 将上一个阶段计算出来的需要处理的副作用(Effects)一次性执行了。这个阶段必须同步执行，不能被打断</li></ul> <h3 id="render-阶段遍历规则"><a href="#render-阶段遍历规则" class="header-anchor">#</a> render 阶段遍历规则</h3> <ul><li>render 阶段会构建 fiber 树</li></ul> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">let</span> <span class="token constant">A1</span> <span class="token operator">=</span> <span class="token punctuation">{</span> type<span class="token operator">:</span> <span class="token string">&quot;div&quot;</span><span class="token punctuation">,</span> key<span class="token operator">:</span> <span class="token string">&quot;A1&quot;</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token keyword">let</span> <span class="token constant">B1</span> <span class="token operator">=</span> <span class="token punctuation">{</span> type<span class="token operator">:</span> <span class="token string">&quot;div&quot;</span><span class="token punctuation">,</span> key<span class="token operator">:</span> <span class="token string">&quot;B1&quot;</span><span class="token punctuation">,</span> <span class="token keyword">return</span><span class="token operator">:</span> <span class="token constant">A1</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token keyword">let</span> <span class="token constant">B2</span> <span class="token operator">=</span> <span class="token punctuation">{</span> type<span class="token operator">:</span> <span class="token string">&quot;div&quot;</span><span class="token punctuation">,</span> key<span class="token operator">:</span> <span class="token string">&quot;B2&quot;</span><span class="token punctuation">,</span> <span class="token keyword">return</span><span class="token operator">:</span> <span class="token constant">A1</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token keyword">let</span> <span class="token constant">C1</span> <span class="token operator">=</span> <span class="token punctuation">{</span> type<span class="token operator">:</span> <span class="token string">&quot;div&quot;</span><span class="token punctuation">,</span> key<span class="token operator">:</span> <span class="token string">&quot;C1&quot;</span><span class="token punctuation">,</span> <span class="token keyword">return</span><span class="token operator">:</span> <span class="token constant">B1</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token keyword">let</span> <span class="token constant">C2</span> <span class="token operator">=</span> <span class="token punctuation">{</span> type<span class="token operator">:</span> <span class="token string">&quot;div&quot;</span><span class="token punctuation">,</span> key<span class="token operator">:</span> <span class="token string">&quot;C2&quot;</span><span class="token punctuation">,</span> <span class="token keyword">return</span><span class="token operator">:</span> <span class="token constant">B1</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token constant">A1</span><span class="token punctuation">.</span>child <span class="token operator">=</span> <span class="token constant">B1</span><span class="token punctuation">;</span>
<span class="token constant">B1</span><span class="token punctuation">.</span>sibling <span class="token operator">=</span> <span class="token constant">B2</span><span class="token punctuation">;</span>
<span class="token constant">B1</span><span class="token punctuation">.</span>child <span class="token operator">=</span> <span class="token constant">C1</span><span class="token punctuation">;</span>
<span class="token constant">C1</span><span class="token punctuation">.</span>sibling <span class="token operator">=</span> <span class="token constant">C2</span><span class="token punctuation">;</span>
module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token constant">A1</span><span class="token punctuation">;</span>
</code></pre></div><ul><li><p>从顶点开始遍历</p></li> <li><p>如果有第一个儿子，先遍历第一个儿子</p></li> <li><p>如果没有第一个儿子，标志着此节点遍历完成</p></li> <li><p>如果有弟弟遍历弟弟</p></li> <li><p>如果有没有下一个弟弟，返回父节点标识完成父节点遍历，如果有叔叔遍历叔叔</p></li> <li><p>没有父节点遍历结束</p></li> <li><p>遍历规则</p></li> <li><p>1.下一个节点:先ル子,后弟弟,再叔叔</p></li> <li><p>2.自己所有子节点完成后自己完成</p></li> <li><p>先儿子，后弟弟，再叔叔,辈份越小越优先</p></li> <li><p>什么时候一个节点遍历完成? 没有子节点，或者所有子节点都遍历完成了</p></li> <li><p>没爹了就表示全部遍历完成了</p></li></ul> <p><img src="https://gitee.com/yutao618/images/raw/master/images/d795292a1cab444db45adfee57aac806_tplv-k3u1fbpfcp-watermark.jpg" alt=""></p> <p>上图就是对应节点的fiber树，下图是节点遍历的顺序</p> <p><img src="https://gitee.com/yutao618/images/raw/master/images/76db89de8cec487fa3e7dd2c82dfd55d_tplv-k3u1fbpfcp-watermark.jpg" alt=""></p> <p>beginWork的时候根据fiber的tag（类型）进行不同节点的更新。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">/**
 * 更新或者说挂载根节点
 * 依据什么构建fiber树？ 虚拟DOM
 * @param {*} current 老fiber
 * @param {*} workInProgress 构建中的新fiber
 */</span>
<span class="token keyword">function</span> <span class="token function">updateHostRoot</span><span class="token punctuation">(</span><span class="token parameter">current<span class="token punctuation">,</span> workInProgress</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> updateQueue <span class="token operator">=</span> workInProgress<span class="token punctuation">.</span>updateQueue<span class="token punctuation">;</span>
  <span class="token comment">//获取要渲染的虚拟DOM &lt;div key=&quot;title&quot; id=&quot;title&quot;&gt;title&lt;/div&gt;</span>
  <span class="token keyword">const</span> nextChildren <span class="token operator">=</span> updateQueue<span class="token punctuation">.</span>shared<span class="token punctuation">.</span>pending<span class="token punctuation">.</span>payload<span class="token punctuation">.</span>element<span class="token punctuation">;</span><span class="token comment">//element</span>
  <span class="token comment">//处理子节点，根据老fiber和新的虚拟DOM进行对比，创建新的fiber树</span>
  <span class="token function">reconcileChildren</span><span class="token punctuation">(</span>current<span class="token punctuation">,</span> workInProgress<span class="token punctuation">,</span> nextChildren<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">//返回第一个子fiber</span>
  <span class="token keyword">return</span> workInProgress<span class="token punctuation">.</span>child<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">updateHostComponent</span><span class="token punctuation">(</span><span class="token parameter">current<span class="token punctuation">,</span> workInProgress</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">//获取 此原生组件的类型 span p</span>
  <span class="token keyword">const</span> type <span class="token operator">=</span> workInProgress<span class="token punctuation">.</span>type<span class="token punctuation">;</span>
  <span class="token comment">//新属性</span>
  <span class="token keyword">const</span> nextProps <span class="token operator">=</span> workInProgress<span class="token punctuation">.</span>pendingProps<span class="token punctuation">;</span><span class="token comment">//props.children</span>
  <span class="token keyword">let</span> nextChildren <span class="token operator">=</span> nextProps<span class="token punctuation">.</span>children<span class="token punctuation">;</span>
  <span class="token comment">//在react对于如果一个原生组件，它只有一个儿子，并且这个儿子是一个字符串的话，有一个优化</span>
  <span class="token comment">//不会对此儿子创建一个fiber节点，而是把它当成一个属性来处理</span>
  <span class="token keyword">let</span> isDirectTextChild <span class="token operator">=</span> <span class="token function">shouldSetTextContent</span><span class="token punctuation">(</span>type<span class="token punctuation">,</span> nextProps<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>isDirectTextChild<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    nextChildren <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token comment">//处理子节点，根据老fiber和新的虚拟DOM进行对比，创建新的fiber树</span>
  <span class="token function">reconcileChildren</span><span class="token punctuation">(</span>current<span class="token punctuation">,</span> workInProgress<span class="token punctuation">,</span> nextChildren<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">//返回第一个子fiber</span>
  <span class="token keyword">return</span> workInProgress<span class="token punctuation">.</span>child<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>不管是什么样类型的fiber(根fiber,类组件，函数组件，原生DOM..)都会走到<strong>reconcileChildren</strong>这个方法中，这个地方才是dom-diff真正执行的阶段。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">reconcileChildren</span><span class="token punctuation">(</span><span class="token parameter">current<span class="token punctuation">,</span> workInProgress<span class="token punctuation">,</span> nextChildren</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">//如果current有值，说明这是一类似于更新的作品</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>current<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">//进行比较 新老内容，得到差异进行更新</span>
    workInProgress<span class="token punctuation">.</span>child <span class="token operator">=</span> <span class="token function">reconcileChildFibers</span><span class="token punctuation">(</span>
      workInProgress<span class="token punctuation">,</span><span class="token comment">//新fiber</span>
      current<span class="token punctuation">.</span>child<span class="token punctuation">,</span><span class="token comment">//老fiber的第一个子fiber节点</span>
      nextChildren <span class="token comment">//新的虚拟DOM</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token comment">///初次渲染，不需要比较 ，全是新的</span>
    workInProgress<span class="token punctuation">.</span>child <span class="token operator">=</span> <span class="token function">mountChildFibers</span><span class="token punctuation">(</span>
      workInProgress<span class="token punctuation">,</span><span class="token comment">//新fiber</span>
      current <span class="token operator">&amp;&amp;</span> current<span class="token punctuation">.</span>child<span class="token punctuation">,</span><span class="token comment">//老fiber的第一个子fiber节点</span>
      nextChildren <span class="token comment">//新的虚拟DOM</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p><strong>reconcileChildFibers</strong>和<strong>mountChildFibers</strong>一个是更新，一个是初次渲染，所需要的参数都是一样，新建一个childReconciler函数：</p> <h3 id="childreconciler"><a href="#childreconciler" class="header-anchor">#</a> childReconciler</h3> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">childReconciler</span><span class="token punctuation">(</span><span class="token parameter">shouldTrackSideEffects</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">function</span> <span class="token function">reconcileChildFibers</span><span class="token punctuation">(</span><span class="token parameter">returnFiber<span class="token punctuation">,</span> currentFirstChild<span class="token punctuation">,</span> newChild</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> reconcileChildFibers<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">export</span> <span class="token keyword">const</span> reconcileChildFibers <span class="token operator">=</span> <span class="token function">childReconciler</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">export</span> <span class="token keyword">const</span> mountChildFibers <span class="token operator">=</span> <span class="token function">childReconciler</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>通过shouldTrackSideEffects参数来控制是更新还是渲染操作。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">/**
 * @param {*} returnFiber 新的父fiber
 * @param {*} currentFirstChild current就是老的意思，老的第一个子fiber
 * @param {*} newChild 新的虚拟DOM
 */</span>
<span class="token keyword">function</span> <span class="token function">reconcileChildFibers</span><span class="token punctuation">(</span><span class="token parameter">returnFiber<span class="token punctuation">,</span> currentFirstChild<span class="token punctuation">,</span> newChild</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">//判断newChild是不是一个对象,如果是的话说明新的虚拟DOM只有一个React元素节点</span>
  <span class="token keyword">const</span> isObject <span class="token operator">=</span> <span class="token keyword">typeof</span> newChild <span class="token operator">===</span> <span class="token string">'object'</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span> newChild <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">//说明新的虚拟DOM是单节点</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>isObject<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">switch</span> <span class="token punctuation">(</span>newChild<span class="token punctuation">.</span>$$<span class="token keyword">typeof</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">case</span> <span class="token constant">REACT_ELEMENT_TYPE</span><span class="token operator">:</span>
        <span class="token keyword">return</span> <span class="token function">placeSingleChild</span><span class="token punctuation">(</span><span class="token function">reconcileSingleElement</span><span class="token punctuation">(</span>
          returnFiber<span class="token punctuation">,</span> currentFirstChild<span class="token punctuation">,</span> newChild
        <span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>reconcileSingleElement协调单元素节点</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">reconcileSingleElement</span><span class="token punctuation">(</span><span class="token parameter">returnFiber<span class="token punctuation">,</span> currentFirstChild<span class="token punctuation">,</span> element</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> created <span class="token operator">=</span> <span class="token function">createFiberFromElement</span><span class="token punctuation">(</span>element<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//div#title</span>
  created<span class="token punctuation">.</span>return <span class="token operator">=</span> returnFiber<span class="token punctuation">;</span>
  <span class="token keyword">return</span> created<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">/**
 * 根据虚拟DOM元素创建fiber节点
 * @param {*} element 虚拟节点
 */</span>
<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">createFiberFromElement</span><span class="token punctuation">(</span><span class="token parameter">element</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> <span class="token punctuation">{</span> key<span class="token punctuation">,</span> type<span class="token punctuation">,</span> props <span class="token punctuation">}</span> <span class="token operator">=</span> element<span class="token punctuation">;</span>
  <span class="token keyword">let</span> tag<span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> type <span class="token operator">===</span> <span class="token string">'string'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token comment">// span div p</span>
    tag <span class="token operator">=</span> HostComponent<span class="token punctuation">;</span><span class="token comment">//标签等于原生组件</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">const</span> fiber <span class="token operator">=</span> <span class="token function">createFiber</span><span class="token punctuation">(</span>tag<span class="token punctuation">,</span> props<span class="token punctuation">,</span> key<span class="token punctuation">)</span><span class="token punctuation">;</span>
  fiber<span class="token punctuation">.</span>type <span class="token operator">=</span> type<span class="token punctuation">;</span>
  <span class="token keyword">return</span> fiber<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">placeSingleChild</span><span class="token punctuation">(</span><span class="token parameter">newFiber</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 如果当前需要跟踪副作用，并且当前这个新的fiber它的替身不存在</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>shouldTrackSideEffects <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>newFiber<span class="token punctuation">.</span>alternate<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">//给这个新fiber添加一个副作用，表示在未来提前阶段的DOM操作中会向真实DOM树中添加此节点</span>
    newFiber<span class="token punctuation">.</span>flags <span class="token operator">=</span> Placement<span class="token punctuation">;</span> <span class="token comment">// Placement创建或者挂载</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> newFiber<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="completeunitofwork"><a href="#completeunitofwork" class="header-anchor">#</a> completeUnitOfWork</h3> <p>performUnitOfWork中已经处理了beginWork,接下来就是处理<strong>completeUnitOfWork</strong></p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">completeUnitOfWork</span><span class="token punctuation">(</span><span class="token parameter">unitOfWork</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> completedWork <span class="token operator">=</span> unitOfWork<span class="token punctuation">;</span>
  <span class="token keyword">do</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> current <span class="token operator">=</span> completedWork<span class="token punctuation">.</span>alternate<span class="token punctuation">;</span>
    <span class="token keyword">const</span> returnFiber <span class="token operator">=</span> completedWork<span class="token punctuation">.</span>return<span class="token punctuation">;</span>
    <span class="token comment">// 完成此fiber对应的真实DOM节点创建和属性赋值的功能</span>
    <span class="token function">completeWork</span><span class="token punctuation">(</span>current<span class="token punctuation">,</span> completedWork<span class="token punctuation">)</span><span class="token punctuation">;</span>
    
  <span class="token punctuation">}</span> <span class="token keyword">while</span> <span class="token punctuation">(</span>workInProgress<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">completeWork</span><span class="token punctuation">(</span><span class="token parameter">current<span class="token punctuation">,</span> workInProgress</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> newProps <span class="token operator">=</span> workInProgress<span class="token punctuation">.</span>pendingProps<span class="token punctuation">;</span>
  <span class="token keyword">switch</span> <span class="token punctuation">(</span>workInProgress<span class="token punctuation">.</span>tag<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">case</span> HostComponent<span class="token operator">:</span>
      <span class="token comment">//创建真实的DOM节点</span>
      <span class="token keyword">const</span> type <span class="token operator">=</span> workInProgress<span class="token punctuation">.</span>type<span class="token punctuation">;</span><span class="token comment">//div p span</span>
      <span class="token comment">//创建此fiber的真实DOM</span>
      <span class="token keyword">const</span> instance <span class="token operator">=</span> <span class="token function">createInstance</span><span class="token punctuation">(</span>type<span class="token punctuation">,</span> newProps<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">//让此Fiber的真实DOM属性指向instance</span>
      workInProgress<span class="token punctuation">.</span>stateNode <span class="token operator">=</span> instance<span class="token punctuation">;</span>
      <span class="token comment">//给真实DOM添加属性 包括如果独生子是字符串或数字的情况</span>
      <span class="token function">finalizeInitialChildren</span><span class="token punctuation">(</span>instance<span class="token punctuation">,</span> type<span class="token punctuation">,</span> newProps<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token keyword">default</span><span class="token operator">:</span>
      <span class="token keyword">break</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p><strong>createInstance</strong>和<strong>finalizeInitialChildren</strong>都是react封装的根据虚拟Dom的一些DOM操作，但是为了抹平平台的差异性，都会有对应平台的操作dom的方法，比如在浏览器环境createInstance就对应了document.createElement(type)方法。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">createInstance</span><span class="token punctuation">(</span><span class="token parameter">type</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token function">createElement</span><span class="token punctuation">(</span>type<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">finalizeInitialChildren</span><span class="token punctuation">(</span><span class="token parameter">domElement<span class="token punctuation">,</span> type<span class="token punctuation">,</span> props</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token function">setInitialProperties</span><span class="token punctuation">(</span>domElement<span class="token punctuation">,</span> type<span class="token punctuation">,</span> props<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">createElement</span><span class="token punctuation">(</span><span class="token parameter">type</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> document<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span>type<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">setInitialProperties</span><span class="token punctuation">(</span><span class="token parameter">domElement<span class="token punctuation">,</span> type<span class="token punctuation">,</span> props</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> propKey <span class="token keyword">in</span> props<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> nextProp <span class="token operator">=</span> props<span class="token punctuation">[</span>propKey<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>propKey <span class="token operator">===</span> <span class="token string">'children'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> nextProp <span class="token operator">===</span> <span class="token string">'string'</span> <span class="token operator">||</span> <span class="token keyword">typeof</span> nextProp <span class="token operator">===</span> <span class="token string">'number'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        domElement<span class="token punctuation">.</span>textContent <span class="token operator">=</span> nextProp<span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>propKey <span class="token operator">===</span> <span class="token string">'style'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> stylePropKey <span class="token keyword">in</span> nextProp<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        domElement<span class="token punctuation">.</span>style<span class="token punctuation">[</span>stylePropKey<span class="token punctuation">]</span> <span class="token operator">=</span> nextProp<span class="token punctuation">[</span>stylePropKey<span class="token punctuation">]</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      domElement<span class="token punctuation">[</span>propKey<span class="token punctuation">]</span> <span class="token operator">=</span> nextProp<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>completeUnitOfWork 在完成此fiber对应的真实DOM节点创建和属性赋值的功能之后，我们还需要收集当前fiber的副作用到父fiber上。</p> <div class="language-diff extra-class"><pre class="language-diff"><code>function completeUnitOfWork(unitOfWork) {
<span class="token unchanged">  let completedWork = unitOfWork;
  do {
    const current = completedWork.alternate;
    const returnFiber = completedWork.return;
    // 完成此fiber对应的真实DOM节点创建和属性赋值的功能
    completeWork(current, completedWork);
</span><span class="token inserted-sign inserted">+    collectEffectList(returnFiber, completedWork);
</span><span class="token unchanged">  } while (workInProgress);
</span>}
</code></pre></div><h3 id="collecteffectlist"><a href="#collecteffectlist" class="header-anchor">#</a> collectEffectList</h3> <ul><li>为了避免遍历fiber树寻找有副作用的节点，所有才有了effectList</li> <li>在fiber树构建过程中，每当一个fiber节点的flags的字段不为noFlags时代表需要执行副作用，fiber节点添加到effectList中去</li> <li>effectList是一个单向链表，lastEffect代表链表中的第一个节点，lastEffect代表链表中最后一个节点</li> <li>fiber树的构建是<strong>深度优先</strong>遍历的，也就是先向下构建子级fiber节点，子级节点构建完成后，再向上构建父级fiber节点，所以effectList中总是子级fiber节点在最前面</li> <li>fiber节点构建完成的操作执行在<strong>completeUnitOfWork</strong>方法，在这个方法里，不仅会对节点完成构建，也会将有flag的fiber节点添加到effectList中去</li></ul> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">let</span> rootFiber <span class="token operator">=</span> <span class="token punctuation">{</span> key<span class="token operator">:</span> <span class="token string">'rootFiber'</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token keyword">let</span> fiberA <span class="token operator">=</span> <span class="token punctuation">{</span> key<span class="token operator">:</span> <span class="token string">'A'</span><span class="token punctuation">,</span> flags<span class="token operator">:</span> Placement <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token keyword">let</span> fiberB <span class="token operator">=</span> <span class="token punctuation">{</span> key<span class="token operator">:</span> <span class="token string">'B'</span><span class="token punctuation">,</span> flags<span class="token operator">:</span> Placement <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token keyword">let</span> fiberC <span class="token operator">=</span> <span class="token punctuation">{</span> key<span class="token operator">:</span> <span class="token string">'C'</span><span class="token punctuation">,</span> flags<span class="token operator">:</span> Placement <span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><p>假设有这样的一个fiber树，对应的图如下：</p> <p><img src="https://gitee.com/yutao618/images/raw/master/images/20211208162024.png" alt=""></p> <p>对于这样的一个结构，按照fiber节点的遍历顺序，应该就是rootFiber-&gt;A-B-C</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">collectEffectList</span><span class="token punctuation">(</span><span class="token parameter">returnFiber<span class="token punctuation">,</span> completedWork</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> flags <span class="token operator">=</span> completedWork<span class="token punctuation">.</span>flags<span class="token punctuation">;</span>
  <span class="token comment">//如果此完成的fiber有副使用，那么就需要添加到effectList里</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>flags<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    returnFiber<span class="token punctuation">.</span>firstEffect <span class="token operator">=</span> completedWork<span class="token punctuation">;</span>
    returnFiber<span class="token punctuation">.</span>lastEffect <span class="token operator">=</span> completedWork<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>第一步：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token function">collectEffectList</span><span class="token punctuation">(</span>fiberA<span class="token punctuation">,</span> fiberB<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>B把自己的fiber给A，那么用图表示就如下：</p> <p><img src="https://gitee.com/yutao618/images/raw/master/images/20211208163048.png" alt=""></p> <p>第二步：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token function">collectEffectList</span><span class="token punctuation">(</span>fiberA<span class="token punctuation">,</span> fiberC<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>C把自己的fiber给A，C应该是在B的后面，也就是B应该有个nextEffect指向C ，所以collectEffectList就修改如下:</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">collectEffectList</span><span class="token punctuation">(</span><span class="token parameter">returnFiber<span class="token punctuation">,</span> completedWork</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> flags <span class="token operator">=</span> completedWork<span class="token punctuation">.</span>flags<span class="token punctuation">;</span>
  <span class="token comment">//如果此完成的fiber有副使用，那么就需要添加到effectList里</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>flags<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">//如果父fiber有lastEffect的话，说明父fiber已经有effect链表</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>returnFiber<span class="token punctuation">.</span>lastEffect<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      returnFiber<span class="token punctuation">.</span>lastEffect<span class="token punctuation">.</span>nextEffect <span class="token operator">=</span> completedWork<span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      returnFiber<span class="token punctuation">.</span>firstEffect <span class="token operator">=</span> completedWork<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    returnFiber<span class="token punctuation">.</span>lastEffect <span class="token operator">=</span> completedWork<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>可以用下图来表示第二步的操作结果：</p> <p><img src="https://gitee.com/yutao618/images/raw/master/images/20211208164159.png" alt=""></p> <p>第三步：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token function">collectEffectList</span><span class="token punctuation">(</span>rootFiber<span class="token punctuation">,</span> fiberA<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>这个时候就需要把A收集好的给到rootFiber，靠目前这个逻辑是实现不了，只能把A给到rootFiber，A收集的BC都丢失了，再来继续改造下collectEffectList方法：</p> <div class="language-diff extra-class"><pre class="language-diff"><code>function collectEffectList(returnFiber, completedWork) {
<span class="token inserted-sign inserted">+  //如果父亲 没有effectList,那就让父亲 的firstEffect链表头指向自己的头
+  if (!returnFiber.firstEffect) {
+    returnFiber.firstEffect = completedWork.firstEffect;
+  }
</span><span class="token unchanged">  const flags = completedWork.flags;
  //如果此完成的fiber有副使用，那么就需要添加到effectList里
  if (flags) {
    //如果父fiber有lastEffect的话，说明父fiber已经有effect链表
    if (returnFiber.lastEffect) {
      returnFiber.lastEffect.nextEffect = completedWork;
    } else {
      returnFiber.firstEffect = completedWork;
    }
    returnFiber.lastEffect = completedWork;
  }
</span>}
</code></pre></div><p>returnFiber没有firstEffect，说明没有effectList，那就让父亲 的firstEffect链表头指向自己的头，A的firstEffect不就是B么，可以用下图表示：</p> <p><img src="https://gitee.com/yutao618/images/raw/master/images/20211208165611.png" alt=""></p> <p>collectEffectList还要继续改造下：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">collectEffectList</span><span class="token punctuation">(</span><span class="token parameter">returnFiber<span class="token punctuation">,</span> completedWork</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">//如果父亲 没有effectList,那就让父亲 的firstEffect链表头指向自己的头</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>returnFiber<span class="token punctuation">.</span>firstEffect<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    returnFiber<span class="token punctuation">.</span>firstEffect <span class="token operator">=</span> completedWork<span class="token punctuation">.</span>firstEffect<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token comment">//如果自己有链表尾,说明自己身上是有链的</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>completedWork<span class="token punctuation">.</span>lastEffect<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">//并且父亲也有链表尾，说明父亲身上也是有链的</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>returnFiber<span class="token punctuation">.</span>lastEffect<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">//把自己身上的effectList挂接到父亲的链表尾部</span>
      returnFiber<span class="token punctuation">.</span>lastEffect<span class="token punctuation">.</span>nextEffect <span class="token operator">=</span> completedWork<span class="token punctuation">.</span>firstEffect<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    returnFiber<span class="token punctuation">.</span>lastEffect <span class="token operator">=</span> completedWork<span class="token punctuation">.</span>lastEffect<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">const</span> flags <span class="token operator">=</span> completedWork<span class="token punctuation">.</span>flags<span class="token punctuation">;</span>
  <span class="token comment">//如果此完成的fiber有副使用，那么就需要添加到effectList里</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>flags<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">//如果父fiber有lastEffect的话，说明父fiber已经有effect链表</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>returnFiber<span class="token punctuation">.</span>lastEffect<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      returnFiber<span class="token punctuation">.</span>lastEffect<span class="token punctuation">.</span>nextEffect <span class="token operator">=</span> completedWork<span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      returnFiber<span class="token punctuation">.</span>firstEffect <span class="token operator">=</span> completedWork<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    returnFiber<span class="token punctuation">.</span>lastEffect <span class="token operator">=</span> completedWork<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>第三步完成之后整个链表如下：</p> <p><img src="https://gitee.com/yutao618/images/raw/master/images/20211208171728.png" alt=""></p> <p>完整的代码逻辑如下：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">collectEffectList</span><span class="token punctuation">(</span><span class="token parameter">returnFiber<span class="token punctuation">,</span> completedWork</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">//如果父亲 没有effectList,那就让父亲 的firstEffect链表头指向自己的头</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>returnFiber<span class="token punctuation">.</span>firstEffect<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    returnFiber<span class="token punctuation">.</span>firstEffect <span class="token operator">=</span> completedWork<span class="token punctuation">.</span>firstEffect<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token comment">//如果自己有链表尾</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>completedWork<span class="token punctuation">.</span>lastEffect<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">//并且父亲也有链表尾</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>returnFiber<span class="token punctuation">.</span>lastEffect<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">//把自己身上的effectList挂接到父亲的链表尾部</span>
      returnFiber<span class="token punctuation">.</span>lastEffect<span class="token punctuation">.</span>nextEffect <span class="token operator">=</span> completedWork<span class="token punctuation">.</span>firstEffect<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    returnFiber<span class="token punctuation">.</span>lastEffect <span class="token operator">=</span> completedWork<span class="token punctuation">.</span>lastEffect<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">const</span> flags <span class="token operator">=</span> completedWork<span class="token punctuation">.</span>flags<span class="token punctuation">;</span>
  <span class="token comment">//如果此完成的fiber有副使用，那么就需要添加到effectList里</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>flags<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">//如果父fiber有lastEffect的话，说明父fiber已经有effect链表</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>returnFiber<span class="token punctuation">.</span>lastEffect<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      returnFiber<span class="token punctuation">.</span>lastEffect<span class="token punctuation">.</span>nextEffect <span class="token operator">=</span> completedWork<span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      returnFiber<span class="token punctuation">.</span>firstEffect <span class="token operator">=</span> completedWork<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    returnFiber<span class="token punctuation">.</span>lastEffect <span class="token operator">=</span> completedWork<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>测试下collectEffectList的结果</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">let</span> rootFiber <span class="token operator">=</span> <span class="token punctuation">{</span> key<span class="token operator">:</span> <span class="token string">'rootFiber'</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token keyword">let</span> fiberA <span class="token operator">=</span> <span class="token punctuation">{</span> key<span class="token operator">:</span> <span class="token string">'A'</span><span class="token punctuation">,</span> flags<span class="token operator">:</span> Placement <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token keyword">let</span> fiberB <span class="token operator">=</span> <span class="token punctuation">{</span> key<span class="token operator">:</span> <span class="token string">'B'</span><span class="token punctuation">,</span> flags<span class="token operator">:</span> Placement <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token keyword">let</span> fiberC <span class="token operator">=</span> <span class="token punctuation">{</span> key<span class="token operator">:</span> <span class="token string">'C'</span><span class="token punctuation">,</span> flags<span class="token operator">:</span> Placement <span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token function">collectEffectList</span><span class="token punctuation">(</span>fiberA<span class="token punctuation">,</span> fiberB<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">collectEffectList</span><span class="token punctuation">(</span>fiberA<span class="token punctuation">,</span> fiberC<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">collectEffectList</span><span class="token punctuation">(</span>rootFiber<span class="token punctuation">,</span> fiberA<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">let</span> effectList <span class="token operator">=</span> <span class="token string">''</span><span class="token punctuation">;</span>
<span class="token keyword">let</span> nextEffect <span class="token operator">=</span> rootFiber<span class="token punctuation">.</span>firstEffect<span class="token punctuation">;</span>
<span class="token keyword">while</span> <span class="token punctuation">(</span>nextEffect<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  effectList <span class="token operator">+=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>nextEffect<span class="token punctuation">.</span>key<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">=&gt;</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>
  nextEffect <span class="token operator">=</span> nextEffect<span class="token punctuation">.</span>nextEffect<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
effectList <span class="token operator">+=</span> <span class="token string">'null'</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>effectList<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>结果就如下：</p> <div class="language- extra-class"><pre class="language-text"><code>B=&gt;C=&gt;A=&gt;null
</code></pre></div><h3 id="commitroot"><a href="#commitroot" class="header-anchor">#</a> commitRoot</h3> <p>接下来就是fiber的commit提交阶段</p> <div class="language-diff extra-class"><pre class="language-diff"><code>function performSyncWorkOnRoot(fiberRoot) {
<span class="token unchanged">  workInProgressRoot = fiberRoot;
  workInProgress = createWorkInProgress(workInProgressRoot.current);
  workLoopSync();//执行工作循环，构建副作用链
</span><span class="token inserted-sign inserted">+  commitRoot();//提交，修改DOM
</span>}
</code></pre></div><div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">commitRoot</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">//指向新构建的fiber树</span>
  <span class="token keyword">const</span> finishedWork <span class="token operator">=</span> workInProgressRoot<span class="token punctuation">.</span>current<span class="token punctuation">.</span>alternate<span class="token punctuation">;</span>
  workInProgressRoot<span class="token punctuation">.</span>finishedWork <span class="token operator">=</span> finishedWork<span class="token punctuation">;</span>
  <span class="token function">commitMutationEffects</span><span class="token punctuation">(</span>workInProgressRoot<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">commitMutationEffects</span><span class="token punctuation">(</span><span class="token parameter">root</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> finishedWork <span class="token operator">=</span> root<span class="token punctuation">.</span>finishedWork<span class="token punctuation">;</span>
  <span class="token keyword">let</span> nextEffect <span class="token operator">=</span> finishedWork<span class="token punctuation">.</span>firstEffect<span class="token punctuation">;</span>
  <span class="token keyword">let</span> effectsList <span class="token operator">=</span> <span class="token string">''</span><span class="token punctuation">;</span>
  <span class="token keyword">while</span> <span class="token punctuation">(</span>nextEffect<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    effectsList <span class="token operator">+=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">(</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token function">getFlags</span><span class="token punctuation">(</span>nextEffect<span class="token punctuation">.</span>flags<span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">#</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>nextEffect<span class="token punctuation">.</span>type<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">#</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>nextEffect<span class="token punctuation">.</span>key<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">)</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>
    nextEffect <span class="token operator">=</span> nextEffect<span class="token punctuation">.</span>nextEffect<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  effectsList <span class="token operator">+=</span> <span class="token string">'null'</span><span class="token punctuation">;</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>effectsList<span class="token punctuation">)</span><span class="token punctuation">;</span>
  root<span class="token punctuation">.</span>current <span class="token operator">=</span> finishedWork<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p><img src="https://gitee.com/yutao618/images/raw/master/images/20211208175912.png" alt=""></p> <p>接下来就是要把真正的节点给插入</p> <div class="language-diff extra-class"><pre class="language-diff"><code>function commitMutationEffects(root) {
<span class="token unchanged">  const finishedWork = root.finishedWork;
  let nextEffect = finishedWork.firstEffect;
  let effectsList = '';
  while (nextEffect) {
    effectsList += `(${getFlags(nextEffect.flags)}#${nextEffect.type}#${nextEffect.key})`;
</span><span class="token inserted-sign inserted">+    const flags = nextEffect.flags;
+    if (flags === Placement) {
+      commitPlacement(nextEffect);
+    }
</span><span class="token unchanged">    nextEffect = nextEffect.nextEffect;
  }
  effectsList += 'null';
  console.log(effectsList);
  root.current = finishedWork;
</span>}
</code></pre></div><div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">commitPlacement</span><span class="token punctuation">(</span><span class="token parameter">nextEffect</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> stateNode <span class="token operator">=</span> nextEffect<span class="token punctuation">.</span>stateNode<span class="token punctuation">;</span>
  <span class="token keyword">let</span> parentStateNode <span class="token operator">=</span> <span class="token function">getParentStateNode</span><span class="token punctuation">(</span>nextEffect<span class="token punctuation">)</span><span class="token punctuation">;</span>
  parentStateNode<span class="token punctuation">.</span><span class="token function">appendChild</span><span class="token punctuation">(</span>stateNode<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">getParentStateNode</span><span class="token punctuation">(</span><span class="token parameter">fiber</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> parent <span class="token operator">=</span> fiber<span class="token punctuation">.</span>return<span class="token punctuation">;</span>
  <span class="token keyword">do</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>parent<span class="token punctuation">.</span>tag <span class="token operator">===</span> HostComponent<span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token comment">//原生元素</span>
      <span class="token keyword">return</span> parent<span class="token punctuation">.</span>stateNode<span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>parent<span class="token punctuation">.</span>tag <span class="token operator">===</span> HostRoot<span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token comment">//根</span>
      <span class="token keyword">return</span> parent<span class="token punctuation">.</span>stateNode<span class="token punctuation">.</span>containerInfo<span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      <span class="token comment">//函数组件或类组件</span>
      parent <span class="token operator">=</span> parent<span class="token punctuation">.</span>return<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span> <span class="token keyword">while</span> <span class="token punctuation">(</span>parent<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p><img src="https://gitee.com/yutao618/images/raw/master/images/20211208181026.png" alt=""></p> <p>到此，节点在页面上显示出来，完成了react的初次渲染。下一节来正真的看下react中的dom-diff。</p> <ul><li><a href="https://gitee.com/yutao618/react-dom-diff/tree/render/" target="_blank" rel="noopener noreferrer">git地址<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li></ul></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/note/web/react/" class="prev router-link-active">
        目录
      </a></span> <span class="next"><a href="/note/web/react/2.html">
        react单节点diff
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/note/assets/js/app.02190172.js" defer></script><script src="/note/assets/js/2.2dccd611.js" defer></script><script src="/note/assets/js/26.c4c127de.js" defer></script>
  </body>
</html>
