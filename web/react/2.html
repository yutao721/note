<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>react Dom-diff之单节点diff | jiaHang的博客</title>
    <meta name="generator" content="VuePress 1.5.0">
    
    <meta name="description" content="专注前端技术栈分享，做一个爱折腾的前端">
    <link rel="preload" href="/note/assets/css/0.styles.725ed339.css" as="style"><link rel="preload" href="/note/assets/js/app.02190172.js" as="script"><link rel="preload" href="/note/assets/js/2.2dccd611.js" as="script"><link rel="preload" href="/note/assets/js/27.234a7f7e.js" as="script"><link rel="prefetch" href="/note/assets/js/10.a05513c9.js"><link rel="prefetch" href="/note/assets/js/11.7ceb6923.js"><link rel="prefetch" href="/note/assets/js/12.fb88bae4.js"><link rel="prefetch" href="/note/assets/js/13.4b17ba74.js"><link rel="prefetch" href="/note/assets/js/14.ce1cd100.js"><link rel="prefetch" href="/note/assets/js/15.6a480c60.js"><link rel="prefetch" href="/note/assets/js/16.6d6b8a6a.js"><link rel="prefetch" href="/note/assets/js/17.c36721ad.js"><link rel="prefetch" href="/note/assets/js/18.77bcea9f.js"><link rel="prefetch" href="/note/assets/js/19.f262839a.js"><link rel="prefetch" href="/note/assets/js/20.5b1b9830.js"><link rel="prefetch" href="/note/assets/js/21.76b74656.js"><link rel="prefetch" href="/note/assets/js/22.e663cec2.js"><link rel="prefetch" href="/note/assets/js/23.c1f1c7e7.js"><link rel="prefetch" href="/note/assets/js/24.5ddffc93.js"><link rel="prefetch" href="/note/assets/js/25.95b0061c.js"><link rel="prefetch" href="/note/assets/js/26.c4c127de.js"><link rel="prefetch" href="/note/assets/js/28.3bb3b4b8.js"><link rel="prefetch" href="/note/assets/js/29.1339c108.js"><link rel="prefetch" href="/note/assets/js/3.6e8c2ef0.js"><link rel="prefetch" href="/note/assets/js/30.3235f9a2.js"><link rel="prefetch" href="/note/assets/js/31.2a4efe07.js"><link rel="prefetch" href="/note/assets/js/32.d3d3c893.js"><link rel="prefetch" href="/note/assets/js/33.eaca5eef.js"><link rel="prefetch" href="/note/assets/js/34.684f8bf3.js"><link rel="prefetch" href="/note/assets/js/35.c486c7ec.js"><link rel="prefetch" href="/note/assets/js/36.2f90f872.js"><link rel="prefetch" href="/note/assets/js/37.92460be1.js"><link rel="prefetch" href="/note/assets/js/38.8532070d.js"><link rel="prefetch" href="/note/assets/js/39.9cc3b3d9.js"><link rel="prefetch" href="/note/assets/js/4.2b7fc900.js"><link rel="prefetch" href="/note/assets/js/40.3ec1b99e.js"><link rel="prefetch" href="/note/assets/js/41.d22f0de1.js"><link rel="prefetch" href="/note/assets/js/42.4796d96b.js"><link rel="prefetch" href="/note/assets/js/43.4c97d146.js"><link rel="prefetch" href="/note/assets/js/44.6e02569c.js"><link rel="prefetch" href="/note/assets/js/5.bb5b8508.js"><link rel="prefetch" href="/note/assets/js/6.ec170bea.js"><link rel="prefetch" href="/note/assets/js/7.12a33526.js"><link rel="prefetch" href="/note/assets/js/8.70ad78c1.js"><link rel="prefetch" href="/note/assets/js/9.b2f872fe.js">
    <link rel="stylesheet" href="/note/assets/css/0.styles.725ed339.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/note/" class="home-link router-link-active"><!----> <span class="site-name">jiaHang的博客</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/note/" class="nav-link">
  主页
</a></div><div class="nav-item"><a href="/note/web/" class="nav-link router-link-active">
  前端
</a></div><div class="nav-item"><a href="/note/node/" class="nav-link">
  node
</a></div><div class="nav-item"><a href="/note/interview/" class="nav-link">
  面试问题
</a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/note/" class="nav-link">
  主页
</a></div><div class="nav-item"><a href="/note/web/" class="nav-link router-link-active">
  前端
</a></div><div class="nav-item"><a href="/note/node/" class="nav-link">
  node
</a></div><div class="nav-item"><a href="/note/interview/" class="nav-link">
  面试问题
</a></div> <!----></nav>  <ul class="sidebar-links"><li><a href="/note/web/" aria-current="page" class="sidebar-link">前端</a></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>JavaScript</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>css</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>ES6</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>vue</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>react</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/note/web/react/" aria-current="page" class="sidebar-link">目录</a></li><li><a href="/note/web/react/1.html" class="sidebar-link">react初次渲染</a></li><li><a href="/note/web/react/2.html" aria-current="page" class="active sidebar-link">react单节点diff</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/note/web/react/2.html#react-dom-diff之单节点diff" class="sidebar-link">react Dom-diff之单节点diff</a></li></ul></li><li><a href="/note/web/react/3.html" class="sidebar-link">react多节点diff</a></li></ul></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>webpack</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>rollup</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>小程序</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>调试</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>其他</span> <span class="arrow right"></span></p> <!----></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h2 id="react-dom-diff之单节点diff"><a href="#react-dom-diff之单节点diff" class="header-anchor">#</a> react Dom-diff之单节点diff</h2> <blockquote><p>上篇文章已经了解到了react 的初次渲染，这篇文章来看下react中的单节点Dom-diff</p></blockquote> <h3 id="render改造"><a href="#render改造" class="header-anchor">#</a> render改造</h3> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">import</span> <span class="token punctuation">{</span> createFiberRoot <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./ReactFiberRoot'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> updateContainer <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./ReactFiberReconciler'</span><span class="token punctuation">;</span>

<span class="token keyword">function</span> <span class="token function">render</span><span class="token punctuation">(</span><span class="token parameter">element<span class="token punctuation">,</span> container</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">//1.创建一个fiberRoot, 它其实指向是我们的div#root这个容器</span>
  <span class="token keyword">let</span> fiberRoot <span class="token operator">=</span> container<span class="token punctuation">.</span>_reactRootContainer<span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>fiberRoot<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    fiberRoot <span class="token operator">=</span> container<span class="token punctuation">.</span>_reactRootContainer <span class="token operator">=</span> <span class="token function">createFiberRoot</span><span class="token punctuation">(</span>container<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token comment">//把element这个虚拟DOM变成真实DOM插入容器中</span>
  <span class="token function">updateContainer</span><span class="token punctuation">(</span>element<span class="token punctuation">,</span> fiberRoot<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">const</span> ReactDOM <span class="token operator">=</span> <span class="token punctuation">{</span>
  render
<span class="token punctuation">}</span>
<span class="token keyword">export</span> <span class="token keyword">default</span> ReactDOM<span class="token punctuation">;</span>
</code></pre></div><div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>fiberRoot<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	fiberRoot <span class="token operator">=</span> container<span class="token punctuation">.</span>_reactRootContainer <span class="token operator">=</span> <span class="token function">createFiberRoot</span><span class="token punctuation">(</span>container<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>这个就确保了渲染的时候赋值，更新的时候取值，确保操作的是同一个fiberRoot</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">commitRoot</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">//指向新构建的fiber树</span>
  <span class="token keyword">const</span> finishedWork <span class="token operator">=</span> workInProgressRoot<span class="token punctuation">.</span>current<span class="token punctuation">.</span>alternate<span class="token punctuation">;</span>
  workInProgressRoot<span class="token punctuation">.</span>finishedWork <span class="token operator">=</span> finishedWork<span class="token punctuation">;</span>
  <span class="token function">commitMutationEffects</span><span class="token punctuation">(</span>workInProgressRoot<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>commitRoot就是提交fiber,修改dom的阶段，dom-diff就在这个阶段。<strong>commitMutationEffects</strong>中有个分支，就是当fiber的flags是Placement（添加 或者说创建 挂载），会有个commitPlacement的操作，看下之前的代码。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">commitMutationEffects</span><span class="token punctuation">(</span><span class="token parameter">root</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> finishedWork <span class="token operator">=</span> root<span class="token punctuation">.</span>finishedWork<span class="token punctuation">;</span>
  <span class="token keyword">let</span> nextEffect <span class="token operator">=</span> finishedWork<span class="token punctuation">.</span>firstEffect<span class="token punctuation">;</span>
  <span class="token keyword">let</span> effectsList <span class="token operator">=</span> <span class="token string">''</span><span class="token punctuation">;</span>
  <span class="token keyword">while</span> <span class="token punctuation">(</span>nextEffect<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    effectsList <span class="token operator">+=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">(</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token function">getFlags</span><span class="token punctuation">(</span>nextEffect<span class="token punctuation">.</span>flags<span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">#</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>nextEffect<span class="token punctuation">.</span>type<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">#</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>nextEffect<span class="token punctuation">.</span>key<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">)</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> flags <span class="token operator">=</span> nextEffect<span class="token punctuation">.</span>flags<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>flags <span class="token operator">===</span> Placement<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">commitPlacement</span><span class="token punctuation">(</span>nextEffect<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    nextEffect <span class="token operator">=</span> nextEffect<span class="token punctuation">.</span>nextEffect<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  effectsList <span class="token operator">+=</span> <span class="token string">'null'</span><span class="token punctuation">;</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>effectsList<span class="token punctuation">)</span><span class="token punctuation">;</span>
  root<span class="token punctuation">.</span>current <span class="token operator">=</span> finishedWork<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="reactfibercommitwork-js"><a href="#reactfibercommitwork-js" class="header-anchor">#</a> ReactFiberCommitWork.js</h3> <p>commitPlacement只是其中的一个节点的操作，我们将commitPlacement等相关方法提取到ReactFiberCommitWork.js中去。并且稍作改造。</p> <div class="language-diff extra-class"><pre class="language-diff"><code>export function commitPlacement(nextEffect) {
<span class="token unchanged">  let stateNode = nextEffect.stateNode;
  let parentStateNode = getParentStateNode(nextEffect);
</span><span class="token deleted-sign deleted">-  parentStateNode.appendChild(stateNode);
</span><span class="token inserted-sign inserted">+  appendChild(parentStateNode, stateNode);
</span>}
</code></pre></div><p>也是用来抹平平台差异性的操作。appendChild方法也来自ReactDOMComponent.js(真实dom操作)</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">appendChild</span><span class="token punctuation">(</span><span class="token parameter">parentInstance<span class="token punctuation">,</span> child</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    parentInstance<span class="token punctuation">.</span><span class="token function">appendChild</span><span class="token punctuation">(</span>child<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>结果也是一样的，页面上也是渲染出来了title。接下来看下单节点dom-diff是如何实现的。</p> <p>在beginWork(current, workInProgress)的时候，传入了当前的fiber树和正在构建的fiber树，而且在reconcileChildren的时候，并且是更新操作的时候就会进行比较。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">reconcileChildren</span><span class="token punctuation">(</span><span class="token parameter">current<span class="token punctuation">,</span> workInProgress<span class="token punctuation">,</span> nextChildren</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">//如果current有值，说明这是一类似于更新的作品</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>current<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">//进行比较 新老内容，得到差异进行更新</span>
    workInProgress<span class="token punctuation">.</span>child <span class="token operator">=</span> <span class="token function">reconcileChildFibers</span><span class="token punctuation">(</span>
      workInProgress<span class="token punctuation">,</span><span class="token comment">//新fiber</span>
      current<span class="token punctuation">.</span>child<span class="token punctuation">,</span><span class="token comment">//老fiber的第一个子fiber节点</span>
      nextChildren <span class="token comment">//新的虚拟DOM</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token comment">///初次渲染，不需要比较 ，全是新的</span>
    workInProgress<span class="token punctuation">.</span>child <span class="token operator">=</span> <span class="token function">mountChildFibers</span><span class="token punctuation">(</span>
      workInProgress<span class="token punctuation">,</span><span class="token comment">//新fiber</span>
      <span class="token keyword">null</span><span class="token punctuation">,</span><span class="token comment">//老fiber的第一个子fiber节点</span>
      nextChildren <span class="token comment">//新的虚拟DOM</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">/**
   *
   * @param {*} returnFiber 新的父fiber
   * @param {*} currentFirstChild current就是老的意思，老的第一个子fiber
   * @param {*} newChild 新的虚拟DOM
   */</span>
  <span class="token keyword">function</span> <span class="token function">reconcileChildFibers</span><span class="token punctuation">(</span><span class="token parameter">returnFiber<span class="token punctuation">,</span> currentFirstChild<span class="token punctuation">,</span> newChild</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">//判断newChild是不是一个对象,如果是的话说明新的虚拟DOM只有一个React元素节点</span>
    <span class="token keyword">const</span> isObject <span class="token operator">=</span> <span class="token keyword">typeof</span> newChild <span class="token operator">===</span> <span class="token string">'object'</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span> newChild <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//说明新的虚拟DOM是单节点</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>isObject<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">switch</span> <span class="token punctuation">(</span>newChild<span class="token punctuation">.</span>$$<span class="token keyword">typeof</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">case</span> <span class="token constant">REACT_ELEMENT_TYPE</span><span class="token operator">:</span>
          <span class="token keyword">return</span> <span class="token function">placeSingleChild</span><span class="token punctuation">(</span><span class="token function">reconcileSingleElement</span><span class="token punctuation">(</span>
            returnFiber<span class="token punctuation">,</span> currentFirstChild<span class="token punctuation">,</span> newChild
          <span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
</code></pre></div><p>单节点的diff会走到reconcileSingleElement中去，目前reconcileSingleElement还只是直接创建一个fiber节点，并没有对比的过程。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">reconcileSingleElement</span><span class="token punctuation">(</span><span class="token parameter">returnFiber<span class="token punctuation">,</span> currentFirstChild<span class="token punctuation">,</span> element</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> created <span class="token operator">=</span> <span class="token function">createFiberFromElement</span><span class="token punctuation">(</span>element<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//div#title</span>
  created<span class="token punctuation">.</span>return <span class="token operator">=</span> returnFiber<span class="token punctuation">;</span>
  <span class="token keyword">return</span> created<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>先来看下更新情况下，当前current和正在构建的workInProgress的关系图：</p> <p><img src="https://gitee.com/yutao618/images/raw/master/images/cong_render_dao_zhi_xing_gong_zuo_xun_huan_de_fiber_jia_gou_4_1636817909854.jpg" alt=""></p> <blockquote><p>current永远是老的fiber树，就是当前页面视图对应的fiber树，workInProgress是当前正在构建的fiber树，他们相互指向，相互引用，就是之前说的双缓冲。</p></blockquote> <h3 id=""><a href="#" class="header-anchor">#</a></h3> <p><img src="https://gitee.com/yutao618/images/raw/master/images/dan_jie_dian_diff_1636818669377.jpg" alt=""></p> <p>上图是单节点的diff流程图，按这个，我们就分为以下几种情况：</p> <h3 id="单节点dom-diff"><a href="#单节点dom-diff" class="header-anchor">#</a> 单节点dom-diff</h3> <ul><li>key相同,类型相同,复用老节点，只更新属性</li> <li>key相同,类型不同，删除老节点，添加新节点</li> <li>类型相同,key不同,删除老节点，添加新节点</li> <li>原来多个节点，现在只有一个节点,删除多余节点</li></ul> <p>1.原来多个节点，现在只有一个节点,删除多余节点</p> <p>具体代码实现：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">reconcileSingleElement</span><span class="token punctuation">(</span><span class="token parameter">returnFiber<span class="token punctuation">,</span> currentFirstChild<span class="token punctuation">,</span> element</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">//获取新的虚拟DOM的key</span>
  <span class="token keyword">let</span> key <span class="token operator">=</span> element<span class="token punctuation">.</span>key<span class="token punctuation">;</span>
  <span class="token comment">//获取第一个老的fiber节点</span>
  <span class="token keyword">let</span> child <span class="token operator">=</span> currentFirstChild<span class="token punctuation">;</span>
  <span class="token keyword">while</span> <span class="token punctuation">(</span>child<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">//老fiber的ekey和新的虚拟DOM的key相同</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>child<span class="token punctuation">.</span>key <span class="token operator">===</span> key<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      <span class="token comment">//如果不相同说明当前这个老fiber不是对应于新的虚拟DOM节点 把此老fiber标记为删除</span>
      <span class="token function">deleteChild</span><span class="token punctuation">(</span>returnFiber<span class="token punctuation">,</span> child<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">const</span> created <span class="token operator">=</span> <span class="token function">createFiberFromElement</span><span class="token punctuation">(</span>element<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//div#title</span>
  created<span class="token punctuation">.</span>return <span class="token operator">=</span> returnFiber<span class="token punctuation">;</span>
  <span class="token keyword">return</span> created<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p><img src="https://gitee.com/yutao618/images/raw/master/images/20211213171923.png" alt=""></p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">/**
 * 因为这个老的子fiber在新的虚拟DOM树不存在了，则标记为删除
 * @param {*} returnFiber
 * @param {*} childToDelete
 */</span>
<span class="token keyword">function</span> <span class="token function">deleteChild</span><span class="token punctuation">(</span><span class="token parameter">returnFiber<span class="token punctuation">,</span> childToDelete</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">//如果不需要跟踪副作用，直接返回</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>shouldTrackSideEffects<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token comment">//把自己这个副作用添加到父effectList中</span>
  <span class="token comment">//删除类型的副作用一般放在父fiber副作用链表的前面，在进行DOM操作时候先执行删除操作</span>
  <span class="token keyword">const</span> lastEffect <span class="token operator">=</span> returnFiber<span class="token punctuation">.</span>lastEffect<span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>lastEffect<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    lastEffect<span class="token punctuation">.</span>nextEffect <span class="token operator">=</span> childToDelete<span class="token punctuation">;</span>
    returnFiber<span class="token punctuation">.</span>lastEffect <span class="token operator">=</span> childToDelete<span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token comment">//父fiber节点effectList是空</span>
    returnFiber<span class="token punctuation">.</span>firstEffect <span class="token operator">=</span> returnFiber<span class="token punctuation">.</span>lastEffect <span class="token operator">=</span> childToDelete<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token comment">//清空下一个副作用指向</span>
  childToDelete<span class="token punctuation">.</span>nextEffect <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
  <span class="token comment">//标记为删除</span>
  childToDelete<span class="token punctuation">.</span>flags <span class="token operator">=</span> Deletion<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>接下来就是处理下一个fiber,也就是它的sibling。</p> <p><img src="https://gitee.com/yutao618/images/raw/master/images/20211213174410.png" alt=""></p> <div class="language-diff extra-class"><pre class="language-diff"><code>function reconcileSingleElement(returnFiber, currentFirstChild, element) {
<span class="token unchanged">  //获取新的虚拟DOM的key
  let key = element.key;
  //获取第一个老的fiber节点
  let child = currentFirstChild;
  while (child) {
    //老fiber的ekey和新的虚拟DOM的key相同说明
    if (child.key === key) {
    
    } else {
      //如果相同说明当前这个老fiber不是对应于新的虚拟DOM节点 把此老fiber标记为删除，并且继续弟弟
      deleteChild(returnFiber, child);
    }
</span><span class="token inserted-sign inserted">+   // 继续匹配弟弟们
+   child = child.sibling;
</span><span class="token unchanged">  }
  const created = createFiberFromElement(element);//div#title
  created.return = returnFiber;
  return created;
</span>}
</code></pre></div><p>2.key相同,类型不同，删除老节点，添加新节点</p> <p>那此时key相同，按照流程图，就看下type是否相同，如果不相同，则删除包括当前的老fiber在内所所有后续的老fibe</p> <div class="language-diff extra-class"><pre class="language-diff"><code>while (child) {
<span class="token unchanged">  //老fiber的ekey和新的虚拟DOM的key相同说明
  if (child.key === key) {
    //判断老的fiber的type和新的虚拟DOMtype是否相同
    if (child.type == element.type) {
</span>
<span class="token unchanged">    } else {
</span><span class="token inserted-sign inserted">+      //已经配上key了，但是type不同，则删除包括当前的老fiber在内所所有后续的老fibe
+      deleteRemainingChildren(returnFiber, child);
+      break;
</span><span class="token unchanged">    }
  } else {
    //如果不相同说明当前这个老fiber不是对应于新的虚拟DOM节点 把此老fiber标记为删除
    deleteChild(returnFiber, child);
    child = child.sibling;
  }
</span>}
</code></pre></div><p>复用child老fiber节点，删除剩下的其它fiber</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">deleteRemainingChildren</span><span class="token punctuation">(</span><span class="token parameter">returnFiber<span class="token punctuation">,</span> childToDelete</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">while</span> <span class="token punctuation">(</span>childToDelete<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">deleteChild</span><span class="token punctuation">(</span>returnFiber<span class="token punctuation">,</span> childToDelete<span class="token punctuation">)</span><span class="token punctuation">;</span>
    childToDelete <span class="token operator">=</span> childToDelete<span class="token punctuation">.</span>sibling<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>3.key相同,类型相同,复用老节点，只更新属性</p> <p>type如果是相同的，那就可以直接使用原来的fiber,并且更新属性</p> <div class="language-diff extra-class"><pre class="language-diff"><code>while (child) {
<span class="token unchanged">  //老fiber的ekey和新的虚拟DOM的key相同说明
  if (child.key === key) {
    //判断老的fiber的type和新的虚拟DOMtype是否相同
    if (child.type == element.type) {
</span><span class="token inserted-sign inserted">+      //准备复用child老fiber节点，删除剩下的其它fiber
+      deleteRemainingChildren(returnFiber, child.sibling);
+      //在复用老fiber的时候，会传递新的虚拟DOM的属性对象到新fiber的pendingProps上
+      const existing = useFiber(child, element.props);
+      existing.return = returnFiber;
+      return existing;
</span><span class="token unchanged">    } else {
      //已经配上key了，但是type不同，则删除包括当前的老fiber在内所所有后续的老fibe
      deleteRemainingChildren(returnFiber, child);
      break;
    }
  } else {
    //如果相同说明当前这个老fiber不是对应于新的虚拟DOM节点 把此老fiber标记为删除，并且继续弟弟
    deleteChild(returnFiber, child);
  }
  //继续匹配弟弟们
  child = child.sibling;
</span>}
</code></pre></div><p>复用老fiber,并清空弟弟</p> <div class="language- extra-class"><pre class="language-text"><code>function useFiber(oldFiber, pendingProps) {
  let clone = createWorkInProgress(oldFiber, pendingProps);
  clone.sibling = null;//清空弟弟
  return clone;
}
</code></pre></div><blockquote><p>这些操作是执行在beginWork中，并没有正真的去删除掉，只是在这个地方做了标记，在commit阶段才会正真的去处理。</p></blockquote> <h3 id="completework重构"><a href="#completework重构" class="header-anchor">#</a> completeWork重构</h3> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">completeWork</span><span class="token punctuation">(</span><span class="token parameter">current<span class="token punctuation">,</span> workInProgress</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> newProps <span class="token operator">=</span> workInProgress<span class="token punctuation">.</span>pendingProps<span class="token punctuation">;</span>
  <span class="token keyword">switch</span> <span class="token punctuation">(</span>workInProgress<span class="token punctuation">.</span>tag<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">case</span> HostComponent<span class="token operator">:</span>
      <span class="token comment">// 在新的fiber构建完成的时候，收集更新并且标识 更新副作用</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>current <span class="token operator">&amp;&amp;</span> workInProgress<span class="token punctuation">.</span>stateNode<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">updateHostComponent</span><span class="token punctuation">(</span>current<span class="token punctuation">,</span> workInProgress<span class="token punctuation">,</span> workInProgress<span class="token punctuation">.</span>tag<span class="token punctuation">,</span> newProps<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token comment">//创建真实的DOM节点</span>
        <span class="token keyword">const</span> type <span class="token operator">=</span> workInProgress<span class="token punctuation">.</span>type<span class="token punctuation">;</span><span class="token comment">//div p span</span>
        <span class="token comment">//创建此fiber的真实DOM</span>
        <span class="token keyword">const</span> instance <span class="token operator">=</span> <span class="token function">createInstance</span><span class="token punctuation">(</span>type<span class="token punctuation">,</span> newProps<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//让此Fiber的真实DOM属性指向instance</span>
        workInProgress<span class="token punctuation">.</span>stateNode <span class="token operator">=</span> instance<span class="token punctuation">;</span>
        <span class="token comment">//给真实DOM添加属性 包括如果独生子是字符串或数字的情况</span>
        <span class="token function">finalizeInitialChildren</span><span class="token punctuation">(</span>instance<span class="token punctuation">,</span> type<span class="token punctuation">,</span> newProps<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token keyword">default</span><span class="token operator">:</span>
      <span class="token keyword">break</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>current &amp;&amp; workInProgress.stateNode 就说明是更新操作了，在更新阶段，执行updateHostComponent</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">/**
 *
 * @param {*} current 老fiber
 * @param {*} workInProgress 新fiber
 * @param {*} tag
 * @param {*} newProps 新的虚拟DOM上的新属性
 */</span>
<span class="token keyword">function</span> <span class="token function">updateHostComponent</span><span class="token punctuation">(</span><span class="token parameter">current<span class="token punctuation">,</span> workInProgress<span class="token punctuation">,</span> tag<span class="token punctuation">,</span> newProps</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">//老fiber上的老属性</span>
  <span class="token keyword">let</span> oldProps <span class="token operator">=</span> current<span class="token punctuation">.</span>memoizedProps<span class="token punctuation">;</span>
  <span class="token comment">//可复用真实的DOM节点</span>
  <span class="token keyword">const</span> instance <span class="token operator">=</span> workInProgress<span class="token punctuation">.</span>stateNode<span class="token punctuation">;</span>
  <span class="token keyword">const</span> updatePayload <span class="token operator">=</span> <span class="token function">prepareUpdate</span><span class="token punctuation">(</span>instance<span class="token punctuation">,</span> tag<span class="token punctuation">,</span> oldProps<span class="token punctuation">,</span> newProps<span class="token punctuation">)</span><span class="token punctuation">;</span>
  workInProgress<span class="token punctuation">.</span>updateQueue <span class="token operator">=</span> updatePayload<span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>updatePayload<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    workInProgress<span class="token punctuation">.</span>flags <span class="token operator">|=</span> Update<span class="token punctuation">;</span>
    <span class="token comment">//当flags=6的话，就是既要插入新位置 ，又要更新，针对移动 节点的情况</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>prepareUpdate方法,主要是用来更新属性。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">prepareUpdate</span><span class="token punctuation">(</span><span class="token parameter">domElement<span class="token punctuation">,</span> type<span class="token punctuation">,</span> oldProps<span class="token punctuation">,</span> newProps</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token function">diffProperties</span><span class="token punctuation">(</span>
    domElement<span class="token punctuation">,</span>
    type<span class="token punctuation">,</span>
    oldProps<span class="token punctuation">,</span>
    newProps
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">diffProperties</span><span class="token punctuation">(</span><span class="token parameter">domElement<span class="token punctuation">,</span> tag<span class="token punctuation">,</span> lastProps<span class="token punctuation">,</span> nextProps</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> updatePayload <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
  <span class="token keyword">let</span> propKey<span class="token punctuation">;</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span>propKey <span class="token keyword">in</span> lastProps<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>lastProps<span class="token punctuation">.</span><span class="token function">hasOwnProperty</span><span class="token punctuation">(</span>propKey<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span> <span class="token operator">!</span>nextProps<span class="token punctuation">.</span><span class="token function">hasOwnProperty</span><span class="token punctuation">(</span>propKey<span class="token punctuation">)</span> <span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">//updatePayload更新数组 [更新的key1,更新的值1,更新的key2,更新的值2]</span>
      <span class="token punctuation">(</span> updatePayload <span class="token operator">=</span> updatePayload <span class="token operator">||</span> <span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>propKey<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span>propKey <span class="token keyword">in</span> nextProps<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> nextProp <span class="token operator">=</span> nextProps<span class="token punctuation">[</span>propKey<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>propKey <span class="token operator">==</span> <span class="token string">'children'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> nextProp <span class="token operator">===</span> <span class="token string">'string'</span> <span class="token operator">||</span> <span class="token keyword">typeof</span> nextProp <span class="token operator">===</span> <span class="token string">'number'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>nextProp <span class="token operator">!==</span> lastProps<span class="token punctuation">[</span>propKey<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token punctuation">(</span> updatePayload <span class="token operator">=</span> updatePayload <span class="token operator">||</span> <span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>propKey<span class="token punctuation">,</span> nextProp<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      <span class="token comment">//如果新的属性和老的属性不一样</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>nextProp <span class="token operator">!==</span> lastProps<span class="token punctuation">[</span>propKey<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token punctuation">(</span> updatePayload <span class="token operator">=</span> updatePayload <span class="token operator">||</span> <span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>propKey<span class="token punctuation">,</span> nextProp<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> updatePayload<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>接下来，还需要处理commitMutationEffects，这个是commitRoot中执行的，之前只处理了Placement的情况，其他情况也需要处理。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">commitMutationEffects</span><span class="token punctuation">(</span><span class="token parameter">root</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> finishedWork <span class="token operator">=</span> root<span class="token punctuation">.</span>finishedWork<span class="token punctuation">;</span>
  <span class="token keyword">let</span> nextEffect <span class="token operator">=</span> finishedWork<span class="token punctuation">.</span>firstEffect<span class="token punctuation">;</span>
  <span class="token keyword">let</span> effectsList <span class="token operator">=</span> <span class="token string">''</span><span class="token punctuation">;</span>
  <span class="token keyword">while</span> <span class="token punctuation">(</span>nextEffect<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    effectsList <span class="token operator">+=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">(</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token function">getFlags</span><span class="token punctuation">(</span>nextEffect<span class="token punctuation">.</span>flags<span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">#</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>nextEffect<span class="token punctuation">.</span>type<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">#</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>nextEffect<span class="token punctuation">.</span>key<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">)=&gt;</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> flags <span class="token operator">=</span> nextEffect<span class="token punctuation">.</span>flags<span class="token punctuation">;</span>
    <span class="token keyword">let</span> current <span class="token operator">=</span> nextEffect<span class="token punctuation">.</span>alternate<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>flags <span class="token operator">===</span> Placement<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">commitPlacement</span><span class="token punctuation">(</span>nextEffect<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>flags <span class="token operator">===</span> PlacementAndUpdate<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">commitPlacement</span><span class="token punctuation">(</span>nextEffect<span class="token punctuation">)</span><span class="token punctuation">;</span>
      nextEffect<span class="token punctuation">.</span>flags <span class="token operator">=</span> Update<span class="token punctuation">;</span>
      <span class="token function">commitWork</span><span class="token punctuation">(</span>current<span class="token punctuation">,</span> nextEffect<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>flags <span class="token operator">===</span> Update<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">commitWork</span><span class="token punctuation">(</span>current<span class="token punctuation">,</span> nextEffect<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>flags <span class="token operator">===</span> Deletion<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">commitDeletion</span><span class="token punctuation">(</span>nextEffect<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    nextEffect <span class="token operator">=</span> nextEffect<span class="token punctuation">.</span>nextEffect<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  effectsList <span class="token operator">+=</span> <span class="token string">'null'</span><span class="token punctuation">;</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>effectsList<span class="token punctuation">)</span><span class="token punctuation">;</span>
  root<span class="token punctuation">.</span>current <span class="token operator">=</span> finishedWork<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>commitDeletion 删除操作</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">commitDeletion</span><span class="token punctuation">(</span><span class="token parameter">fiber</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>fiber<span class="token punctuation">)</span> <span class="token keyword">return</span><span class="token punctuation">;</span>
  <span class="token keyword">let</span> parentStateNode <span class="token operator">=</span> <span class="token function">getParentStateNode</span><span class="token punctuation">(</span>fiber<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">removeChild</span><span class="token punctuation">(</span>parentStateNode<span class="token punctuation">,</span> fiber<span class="token punctuation">.</span>stateNode<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">removeChild</span><span class="token punctuation">(</span><span class="token parameter">parentInstance<span class="token punctuation">,</span> child</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    parentInstance<span class="token punctuation">.</span><span class="token function">removeChild</span><span class="token punctuation">(</span>child<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>commitWork提交DOM更新操作</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">/**
 * 提交DOM更新操作
 * @param {*} current
 * @param {*} finishedWork
 */</span>
<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">commitWork</span><span class="token punctuation">(</span><span class="token parameter">current<span class="token punctuation">,</span> finishedWork</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> updatePayload <span class="token operator">=</span> finishedWork<span class="token punctuation">.</span>updateQueue<span class="token punctuation">;</span>
  finishedWork<span class="token punctuation">.</span>updateQueue <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>updatePayload<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">updateProperties</span><span class="token punctuation">(</span>finishedWork<span class="token punctuation">.</span>stateNode<span class="token punctuation">,</span> updatePayload<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>updateProperties更新属性</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">updateProperties</span><span class="token punctuation">(</span><span class="token parameter">domElement<span class="token punctuation">,</span> updatePayload</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> updatePayload<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i <span class="token operator">+=</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> propKey <span class="token operator">=</span> updatePayload<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> propValue <span class="token operator">=</span> updatePayload<span class="token punctuation">[</span>i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>propKey <span class="token operator">===</span> <span class="token string">'children'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      domElement<span class="token punctuation">.</span>textContent <span class="token operator">=</span> propValue<span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      domElement<span class="token punctuation">.</span><span class="token function">setAttribute</span><span class="token punctuation">(</span>propKey<span class="token punctuation">,</span> propValue<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// id</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>这个地方i+=2是因为updatePayload更新数组是 [更新的key1,更新的值1,更新的key2,更新的值2]这样的存储数据格式；</p> <p>测试1:</p> <p>index.html</p> <div class="language-html extra-class"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>button</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>single1<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>1.key相同,类型相同,数量相同<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>button</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>br</span><span class="token punctuation">/&gt;</span></span>
  <span class="token entity" title="&lt;">&amp;lt;</span>div key=<span class="token entity" title="&quot;">&amp;quot;</span>title<span class="token entity" title="&quot;">&amp;quot;</span> id=<span class="token entity" title="&quot;">&amp;quot;</span>title<span class="token entity" title="&quot;">&amp;quot;</span><span class="token entity" title="&gt;">&amp;gt;</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>br</span><span class="token punctuation">/&gt;</span></span>
    <span class="token entity" title="&amp;nbsp;">&amp;nbsp;</span><span class="token entity" title="&amp;nbsp;">&amp;nbsp;</span>div<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>br</span><span class="token punctuation">/&gt;</span></span>
  <span class="token entity" title="&lt;">&amp;lt;</span>/div<span class="token entity" title="&gt;">&amp;gt;</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>br</span><span class="token punctuation">/&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>button</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>single1Update<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>复用老节点，只更新属性<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>button</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>br</span><span class="token punctuation">/&gt;</span></span>
  <span class="token entity" title="&lt;">&amp;lt;</span>div key=<span class="token entity" title="&quot;">&amp;quot;</span>title<span class="token entity" title="&quot;">&amp;quot;</span> id=<span class="token entity" title="&quot;">&amp;quot;</span>title2<span class="token entity" title="&quot;">&amp;quot;</span><span class="token entity" title="&gt;">&amp;gt;</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>br</span><span class="token punctuation">/&gt;</span></span>
    <span class="token entity" title="&amp;nbsp;">&amp;nbsp;</span><span class="token entity" title="&amp;nbsp;">&amp;nbsp;</span>div2<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>br</span><span class="token punctuation">/&gt;</span></span>
  <span class="token entity" title="&lt;">&amp;lt;</span>/div<span class="token entity" title="&gt;">&amp;gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>hr</span><span class="token punctuation">/&gt;</span></span>
</code></pre></div><p>index.js</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">//1. key相同,类型相同,复用老节点，只更新属性</span>
single1<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'click'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> element <span class="token operator">=</span> <span class="token punctuation">(</span>
        <span class="token operator">&lt;</span>div key<span class="token operator">=</span><span class="token string">&quot;title&quot;</span> id<span class="token operator">=</span><span class="token string">&quot;title&quot;</span><span class="token operator">&gt;</span>title<span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">&gt;</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
    ReactDOM<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span>element<span class="token punctuation">,</span> root<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
single1Update<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'click'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> element <span class="token operator">=</span> <span class="token punctuation">(</span>
        <span class="token operator">&lt;</span>div key<span class="token operator">=</span><span class="token string">&quot;title&quot;</span> id<span class="token operator">=</span><span class="token string">&quot;title2&quot;</span><span class="token operator">&gt;</span>title2<span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">&gt;</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
    ReactDOM<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span>element<span class="token punctuation">,</span> root<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>页面结果：</p> <p><img src="https://gitee.com/yutao618/images/raw/master/images/20211214153615.png" alt=""></p> <p><img src="https://gitee.com/yutao618/images/raw/master/images/case1.gif" alt=""></p> <p>控制台也可以清楚的看到插入和更新的操作。</p> <p>测试2：</p> <div class="language-html extra-class"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>button</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>single2<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>2.key相同,类型不同<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>button</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>br</span><span class="token punctuation">/&gt;</span></span>
  <span class="token entity" title="&lt;">&amp;lt;</span>div key=<span class="token entity" title="&quot;">&amp;quot;</span>title<span class="token entity" title="&quot;">&amp;quot;</span> id=<span class="token entity" title="&quot;">&amp;quot;</span>title<span class="token entity" title="&quot;">&amp;quot;</span><span class="token entity" title="&gt;">&amp;gt;</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>br</span><span class="token punctuation">/&gt;</span></span>
  <span class="token entity" title="&amp;nbsp;">&amp;nbsp;</span><span class="token entity" title="&amp;nbsp;">&amp;nbsp;</span>div<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>br</span><span class="token punctuation">/&gt;</span></span>
  <span class="token entity" title="&lt;">&amp;lt;</span>/div<span class="token entity" title="&gt;">&amp;gt;</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>br</span><span class="token punctuation">/&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>button</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>single2Update<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>删除老节点，添加新节点<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>button</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>br</span><span class="token punctuation">/&gt;</span></span>
  <span class="token entity" title="&lt;">&amp;lt;</span>p key=<span class="token entity" title="&quot;">&amp;quot;</span>title<span class="token entity" title="&quot;">&amp;quot;</span> id=<span class="token entity" title="&quot;">&amp;quot;</span>title<span class="token entity" title="&quot;">&amp;quot;</span><span class="token entity" title="&gt;">&amp;gt;</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>br</span><span class="token punctuation">/&gt;</span></span>
  <span class="token entity" title="&amp;nbsp;">&amp;nbsp;</span><span class="token entity" title="&amp;nbsp;">&amp;nbsp;</span>p<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>br</span><span class="token punctuation">/&gt;</span></span>
  <span class="token entity" title="&lt;">&amp;lt;</span>/p<span class="token entity" title="&gt;">&amp;gt;</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>br</span><span class="token punctuation">/&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>hr</span><span class="token punctuation">/&gt;</span></span>
</code></pre></div><div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">//2.key相同,类型不同，删除老节点，添加新节点</span>
single2<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'click'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> element <span class="token operator">=</span> <span class="token punctuation">(</span>
    <span class="token operator">&lt;</span>div key<span class="token operator">=</span><span class="token string">&quot;title&quot;</span> id<span class="token operator">=</span><span class="token string">&quot;title&quot;</span><span class="token operator">&gt;</span>title<span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">&gt;</span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
  ReactDOM<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span>element<span class="token punctuation">,</span> root<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
single2Update<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'click'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> element <span class="token operator">=</span> <span class="token punctuation">(</span>
    <span class="token operator">&lt;</span>p key<span class="token operator">=</span><span class="token string">&quot;title&quot;</span> id<span class="token operator">=</span><span class="token string">&quot;title&quot;</span><span class="token operator">&gt;</span>title<span class="token operator">&lt;</span><span class="token operator">/</span>p<span class="token operator">&gt;</span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
  ReactDOM<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span>element<span class="token punctuation">,</span> root<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p><img src="https://gitee.com/yutao618/images/raw/master/images/20211214154740.png" alt=""></p> <p>可以看到先执行了删除div的操作，并且执行了插入P标签的操作。</p> <p>测试3：</p> <div class="language-html extra-class"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>button</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>single3<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>3.类型相同,key不同<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>button</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>br</span><span class="token punctuation">/&gt;</span></span>
  <span class="token entity" title="&lt;">&amp;lt;</span>div key=<span class="token entity" title="&quot;">&amp;quot;</span>title1<span class="token entity" title="&quot;">&amp;quot;</span> id=<span class="token entity" title="&quot;">&amp;quot;</span>title<span class="token entity" title="&quot;">&amp;quot;</span><span class="token entity" title="&gt;">&amp;gt;</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>br</span><span class="token punctuation">/&gt;</span></span>
  <span class="token entity" title="&amp;nbsp;">&amp;nbsp;</span><span class="token entity" title="&amp;nbsp;">&amp;nbsp;</span>title<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>br</span><span class="token punctuation">/&gt;</span></span>
  <span class="token entity" title="&lt;">&amp;lt;</span>/div<span class="token entity" title="&gt;">&amp;gt;</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>br</span><span class="token punctuation">/&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>button</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>single3Update<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>删除老节点，添加新节点<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>button</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>br</span><span class="token punctuation">/&gt;</span></span>
  <span class="token entity" title="&lt;">&amp;lt;</span>div key=<span class="token entity" title="&quot;">&amp;quot;</span>title2<span class="token entity" title="&quot;">&amp;quot;</span> id=<span class="token entity" title="&quot;">&amp;quot;</span>title<span class="token entity" title="&quot;">&amp;quot;</span><span class="token entity" title="&gt;">&amp;gt;</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>br</span><span class="token punctuation">/&gt;</span></span>
  <span class="token entity" title="&amp;nbsp;">&amp;nbsp;</span><span class="token entity" title="&amp;nbsp;">&amp;nbsp;</span>title<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>br</span><span class="token punctuation">/&gt;</span></span>
  <span class="token entity" title="&lt;">&amp;lt;</span>/div<span class="token entity" title="&gt;">&amp;gt;</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>br</span><span class="token punctuation">/&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>hr</span><span class="token punctuation">/&gt;</span></span>
</code></pre></div><div class="language-js extra-class"><pre class="language-js"><code>single3<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'click'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> element <span class="token operator">=</span> <span class="token punctuation">(</span>
    <span class="token operator">&lt;</span>div key<span class="token operator">=</span><span class="token string">&quot;title1&quot;</span> id<span class="token operator">=</span><span class="token string">&quot;title&quot;</span><span class="token operator">&gt;</span>title<span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">&gt;</span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
  ReactDOM<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span>element<span class="token punctuation">,</span> root<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
single3Update<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'click'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> element <span class="token operator">=</span> <span class="token punctuation">(</span>
    <span class="token operator">&lt;</span>div key<span class="token operator">=</span><span class="token string">&quot;title2&quot;</span> id<span class="token operator">=</span><span class="token string">&quot;title&quot;</span><span class="token operator">&gt;</span>title<span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">&gt;</span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
  ReactDOM<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span>element<span class="token punctuation">,</span> root<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p><img src="https://gitee.com/yutao618/images/raw/master/images/20211214155023.png" alt=""></p> <p>类型相同,key不同,删除老节点，添加新节点，先执行了删除div的操作，并且执行了插入div标签的操作。</p> <p>测试4：</p> <div class="language-html extra-class"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>button</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>single4<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>4.原来多个节点，现在只有一个节点<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>button</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>br</span><span class="token punctuation">/&gt;</span></span>
  <span class="token entity" title="&lt;">&amp;lt;</span>ul key=<span class="token entity" title="&quot;">&amp;quot;</span>ul<span class="token entity" title="&quot;">&amp;quot;</span><span class="token entity" title="&gt;">&amp;gt;</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>br</span><span class="token punctuation">/&gt;</span></span>
  <span class="token entity" title="&amp;nbsp;">&amp;nbsp;</span><span class="token entity" title="&amp;nbsp;">&amp;nbsp;</span><span class="token entity" title="&lt;">&amp;lt;</span>li key=<span class="token entity" title="&quot;">&amp;quot;</span>A<span class="token entity" title="&quot;">&amp;quot;</span><span class="token entity" title="&gt;">&amp;gt;</span>A<span class="token entity" title="&lt;">&amp;lt;</span>/li<span class="token entity" title="&gt;">&amp;gt;</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>br</span><span class="token punctuation">/&gt;</span></span>
  <span class="token entity" title="&amp;nbsp;">&amp;nbsp;</span><span class="token entity" title="&amp;nbsp;">&amp;nbsp;</span><span class="token entity" title="&lt;">&amp;lt;</span>li key=<span class="token entity" title="&quot;">&amp;quot;</span>B<span class="token entity" title="&quot;">&amp;quot;</span> id=<span class="token entity" title="&quot;">&amp;quot;</span>B<span class="token entity" title="&quot;">&amp;quot;</span><span class="token entity" title="&gt;">&amp;gt;</span>B<span class="token entity" title="&lt;">&amp;lt;</span>/li<span class="token entity" title="&gt;">&amp;gt;</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>br</span><span class="token punctuation">/&gt;</span></span>
  <span class="token entity" title="&amp;nbsp;">&amp;nbsp;</span><span class="token entity" title="&amp;nbsp;">&amp;nbsp;</span><span class="token entity" title="&lt;">&amp;lt;</span>li key=<span class="token entity" title="&quot;">&amp;quot;</span>C<span class="token entity" title="&quot;">&amp;quot;</span><span class="token entity" title="&gt;">&amp;gt;</span>C<span class="token entity" title="&lt;">&amp;lt;</span>/li<span class="token entity" title="&gt;">&amp;gt;</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>br</span><span class="token punctuation">/&gt;</span></span>
  <span class="token entity" title="&lt;">&amp;lt;</span>/ul<span class="token entity" title="&gt;">&amp;gt;</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>br</span><span class="token punctuation">/&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>button</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>single4Update<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>保留并更新这一个节点，删除其它节点<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>button</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>br</span><span class="token punctuation">/&gt;</span></span>
  <span class="token entity" title="&lt;">&amp;lt;</span>ul key=<span class="token entity" title="&quot;">&amp;quot;</span>ul<span class="token entity" title="&quot;">&amp;quot;</span><span class="token entity" title="&gt;">&amp;gt;</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>br</span><span class="token punctuation">/&gt;</span></span>
  <span class="token entity" title="&amp;nbsp;">&amp;nbsp;</span><span class="token entity" title="&amp;nbsp;">&amp;nbsp;</span><span class="token entity" title="&lt;">&amp;lt;</span>li key=<span class="token entity" title="&quot;">&amp;quot;</span>B<span class="token entity" title="&quot;">&amp;quot;</span> id=<span class="token entity" title="&quot;">&amp;quot;</span>B2<span class="token entity" title="&quot;">&amp;quot;</span><span class="token entity" title="&gt;">&amp;gt;</span>B2<span class="token entity" title="&lt;">&amp;lt;</span>/li<span class="token entity" title="&gt;">&amp;gt;</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>br</span><span class="token punctuation">/&gt;</span></span>
  <span class="token entity" title="&lt;">&amp;lt;</span>/ul<span class="token entity" title="&gt;">&amp;gt;</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>br</span><span class="token punctuation">/&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>hr</span><span class="token punctuation">/&gt;</span></span>
</code></pre></div><div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">//4.原来多个节点，现在只有一个节点,删除多余节点</span>
single4<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'click'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> element <span class="token operator">=</span> <span class="token punctuation">(</span>
        <span class="token operator">&lt;</span>ul key<span class="token operator">=</span><span class="token string">&quot;ul&quot;</span><span class="token operator">&gt;</span>
            <span class="token operator">&lt;</span>li key<span class="token operator">=</span><span class="token string">&quot;A&quot;</span><span class="token operator">&gt;</span><span class="token constant">A</span><span class="token operator">&lt;</span><span class="token operator">/</span>li<span class="token operator">&gt;</span>
            <span class="token operator">&lt;</span>li key<span class="token operator">=</span><span class="token string">&quot;B&quot;</span> id<span class="token operator">=</span><span class="token string">&quot;B&quot;</span><span class="token operator">&gt;</span><span class="token constant">B</span><span class="token operator">&lt;</span><span class="token operator">/</span>li<span class="token operator">&gt;</span>
            <span class="token operator">&lt;</span>li key<span class="token operator">=</span><span class="token string">&quot;C&quot;</span><span class="token operator">&gt;</span><span class="token constant">C</span><span class="token operator">&lt;</span><span class="token operator">/</span>li<span class="token operator">&gt;</span>
        <span class="token operator">&lt;</span><span class="token operator">/</span>ul<span class="token operator">&gt;</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
    ReactDOM<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span>element<span class="token punctuation">,</span> root<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
single4Update<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'click'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> element <span class="token operator">=</span> <span class="token punctuation">(</span>
        <span class="token operator">&lt;</span>ul key<span class="token operator">=</span><span class="token string">&quot;ul&quot;</span><span class="token operator">&gt;</span>
            <span class="token operator">&lt;</span>li key<span class="token operator">=</span><span class="token string">&quot;B&quot;</span> id<span class="token operator">=</span><span class="token string">&quot;B2&quot;</span><span class="token operator">&gt;</span><span class="token constant">B2</span><span class="token operator">&lt;</span><span class="token operator">/</span>li<span class="token operator">&gt;</span>
        <span class="token operator">&lt;</span><span class="token operator">/</span>ul<span class="token operator">&gt;</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
    ReactDOM<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span>element<span class="token punctuation">,</span> root<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>测试发现，第一次渲染都没出来结果：</p> <p><img src="https://gitee.com/yutao618/images/raw/master/images/20211214155841.png" alt=""></p> <p>4.原来多个节点，现在只有一个节点,删除多余节点</p> <p>这个是因为reconcileChildFibers的时候，目前只处理了单节点的情况，看代码：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">reconcileChildFibers</span><span class="token punctuation">(</span><span class="token parameter">returnFiber<span class="token punctuation">,</span> currentFirstChild<span class="token punctuation">,</span> newChild</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">//判断newChild是不是一个对象,如果是的话说明新的虚拟DOM只有一个React元素节点</span>
  <span class="token keyword">const</span> isObject <span class="token operator">=</span> <span class="token keyword">typeof</span> newChild <span class="token operator">===</span> <span class="token string">'object'</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span> newChild <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">//说明新的虚拟DOM是单节点</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>isObject<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">switch</span> <span class="token punctuation">(</span>newChild<span class="token punctuation">.</span>$$<span class="token keyword">typeof</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">case</span> <span class="token constant">REACT_ELEMENT_TYPE</span><span class="token operator">:</span>
        <span class="token keyword">return</span> <span class="token function">placeSingleChild</span><span class="token punctuation">(</span><span class="token function">reconcileSingleElement</span><span class="token punctuation">(</span>
          returnFiber<span class="token punctuation">,</span> currentFirstChild<span class="token punctuation">,</span> newChild
        <span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>如果newChild是数组的话，是没有处理的，接下来处理这个</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">reconcileChildFibers</span><span class="token punctuation">(</span><span class="token parameter">returnFiber<span class="token punctuation">,</span> currentFirstChild<span class="token punctuation">,</span> newChild</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">//判断newChild是不是一个对象,如果是的话说明新的虚拟DOM只有一个React元素节点</span>
  <span class="token keyword">const</span> isObject <span class="token operator">=</span> <span class="token keyword">typeof</span> newChild <span class="token operator">===</span> <span class="token string">'object'</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span> newChild <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">//说明新的虚拟DOM是单节点</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>isObject<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">switch</span> <span class="token punctuation">(</span>newChild<span class="token punctuation">.</span>$$<span class="token keyword">typeof</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">case</span> <span class="token constant">REACT_ELEMENT_TYPE</span><span class="token operator">:</span>
        <span class="token keyword">return</span> <span class="token function">placeSingleChild</span><span class="token punctuation">(</span><span class="token function">reconcileSingleElement</span><span class="token punctuation">(</span>
          returnFiber<span class="token punctuation">,</span> currentFirstChild<span class="token punctuation">,</span> newChild
        <span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// 处理多个虚拟DOM</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>Array<span class="token punctuation">.</span><span class="token function">isArray</span><span class="token punctuation">(</span>newChild<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token function">reconcileChildrenArray</span><span class="token punctuation">(</span>returnFiber<span class="token punctuation">,</span> currentFirstChild<span class="token punctuation">,</span> newChild<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="reconcilechildrenarray"><a href="#reconcilechildrenarray" class="header-anchor">#</a> reconcileChildrenArray</h3> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">/**
 * 如果新的虚拟DOM是一个数组的话， 也就是说有多个儿子的话
 * @param {*} returnFiber ui
 * @param {*} currentFirstChild null
 * @param {*} newChild [liA,liB,liC]
 */</span>
<span class="token keyword">function</span> <span class="token function">reconcileChildrenArray</span><span class="token punctuation">(</span><span class="token parameter">returnFiber<span class="token punctuation">,</span> currentFirstChild<span class="token punctuation">,</span> newChildren</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">//将要返回的第一个新fiber</span>
  <span class="token keyword">let</span> resultingFirstChild <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
  <span class="token comment">//上一个新fiber</span>
  <span class="token keyword">let</span> previousNewFiber <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
  <span class="token comment">//当前的老fiber</span>
  <span class="token keyword">let</span> oldFiber <span class="token operator">=</span> currentFirstChild<span class="token punctuation">;</span>
  <span class="token comment">//新的虚拟DOM的索引</span>
  <span class="token keyword">let</span> newIdx <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
  <span class="token comment">// 如果没有老fiber,也就是初次挂载的时候</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>oldFiber<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 循环虚拟DOM数组， 为每个虚拟DOM创建一个新的fiber</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token punctuation">;</span> newIdx <span class="token operator">&lt;</span> newChildren<span class="token punctuation">.</span>length<span class="token punctuation">;</span> newIdx<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> newFiber <span class="token operator">=</span> <span class="token function">createChild</span><span class="token punctuation">(</span>returnFiber<span class="token punctuation">,</span> newChildren<span class="token punctuation">[</span>newIdx<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//li(A) =&gt;li(B)=&gt; li(C)</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>previousNewFiber<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        resultingFirstChild <span class="token operator">=</span> newFiber<span class="token punctuation">;</span><span class="token comment">//resultingFirstChild=&gt;li(A)</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        previousNewFiber<span class="token punctuation">.</span>sibling <span class="token operator">=</span> newFiber<span class="token punctuation">;</span><span class="token comment">//liA.sibling=li(B) =&gt; liB.sibling=li(C)</span>
      <span class="token punctuation">}</span>
      previousNewFiber <span class="token operator">=</span> newFiber<span class="token punctuation">;</span><span class="token comment">//previousNewFiber=&gt;li(A)=&gt;li(B) =&gt; li(C)</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> resultingFirstChild<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">createChild</span><span class="token punctuation">(</span><span class="token parameter">returnFiber<span class="token punctuation">,</span> newChild</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> created <span class="token operator">=</span> <span class="token function">createFiberFromElement</span><span class="token punctuation">(</span>newChild<span class="token punctuation">)</span><span class="token punctuation">;</span>
  created<span class="token punctuation">.</span>return <span class="token operator">=</span> returnFiber<span class="token punctuation">;</span>
  <span class="token keyword">return</span> created<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>createChild是根据新的虚拟dom创建一个fiber(created),并将它的return（父亲）指向传进来的returnFiber，并返回。</p> <p><img src="https://gitee.com/yutao618/images/raw/master/images/20211213171923.png" alt=""></p> <p>按照上图的fiber新旧节点来看，第一轮循环就是创建A,previousNewFiber肯定不存在，resultingFirstChild（将要返回的第一个新fiber）就指向了A,previousNewFiber也指向了A;第二轮的时候previousNewFiber有值，指向的是A,那就是liA.sibling=li(B),previousNewFiber指向了li(B);第三轮的时候，以此内推，liB.sibling=li(C)，previousNewFiber指向li(C)。</p> <p><img src="https://gitee.com/yutao618/images/raw/master/images/20211214171325.png" alt=""></p> <p>执行之后，可以看到有ul插入，但是没有li,这个是为啥呢？原因是在第一次reconcileChildren的时候，也就是在mountChildFibers的时候,current是null，current.child自然也不存在，应该是null，是null的话，export const mountChildFibers = childReconciler(false);shouldTrackSideEffects这个值就是false,没有给新的fiber添加flags，li自然是没有操作的。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">placeSingleChild</span><span class="token punctuation">(</span><span class="token parameter">newFiber</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">//如果当前需要跟踪副作用，并且当前这个新的fiber它的替身不存在</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>shouldTrackSideEffects <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>newFiber<span class="token punctuation">.</span>alternate<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">//给这个新fiber添加一个副作用，表示在未来提前阶段的DOM操作中会向真实DOM树中添加此节点</span>
    newFiber<span class="token punctuation">.</span>flags <span class="token operator">=</span> Placement<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> newFiber<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>下面是修改前后的对比：</p> <div class="language-diff extra-class"><pre class="language-diff"><code>export function reconcileChildren(current, workInProgress, nextChildren) {
<span class="token unchanged">  //如果current有值，说明这是一类似于更新的作品
  if (current) {
    //进行比较 新老内容，得到差异进行更新
    workInProgress.child = reconcileChildFibers(
      workInProgress,//新fiber
      current.child,//老fiber的第一个子fiber节点
      nextChildren //新的虚拟DOM
    );
  } else {
    ///初次渲染，不需要比较 ，全是新的
    workInProgress.child = mountChildFibers(
      workInProgress,//新fiber
</span><span class="token deleted-sign deleted">-      current &amp;&amp; current.child,//老fiber的第一个子fiber节点 
</span><span class="token inserted-sign inserted">+      null,//老fiber的第一个子fiber节点
</span><span class="token unchanged">      nextChildren //新的虚拟DOM
    );
  }
</span>}
</code></pre></div><p>我们可以在reconcileChildrenArray循环newChildren的时候，手动加上newFiber.flags = Placement</p> <div class="language-diff extra-class"><pre class="language-diff"><code>function reconcileChildrenArray(returnFiber, currentFirstChild, newChildren) {
<span class="token unchanged">  //将要返回的第一个新fiber
  let resultingFirstChild = null;
  //上一个新fiber
  let previousNewFiber = null;
  //当前的老fiber
  let oldFiber = currentFirstChild;
  //新的虚拟DOM的索引
  let newIdx = 0;
  // 如果没有老fiber,也就是初次挂载的时候
  if (!oldFiber) {
    // 循环虚拟DOM数组， 为每个虚拟DOM创建一个新的fiber
    for (; newIdx &lt; newChildren.length; newIdx++) {
      const newFiber = createChild(returnFiber, newChildren[newIdx]);//li(A) =&gt;li(B)=&gt; li(C)
</span><span class="token inserted-sign inserted">+      newFiber.flags = Placement
</span><span class="token unchanged">      if (!previousNewFiber) {
        resultingFirstChild = newFiber;//resultingFirstChild=&gt;li(A)
      } else {
        previousNewFiber.sibling = newFiber;//liA.sibling=li(B) =&gt; liB.sibling=li(C)
      }
      previousNewFiber = newFiber;//previousNewFiber=&gt;li(A)=&gt;li(B) =&gt; li(C)
    }
    return resultingFirstChild;
  }
</span>}
</code></pre></div><p>然后再来看下结果：</p> <p><img src="https://gitee.com/yutao618/images/raw/master/images/20211214172714.png" alt=""></p> <p>可以看到插入的顺序和结果，但是源码中初次渲染的并没有搜集副作用，而是在完成的时候（completeWork）的时候调用appendAllChildren(instance, workInProgress);</p> <div class="language-diff extra-class"><pre class="language-diff"><code>export function completeWork(current, workInProgress) {
<span class="token unchanged">  const newProps = workInProgress.pendingProps;
  switch (workInProgress.tag) {
    case HostComponent:
      //在新的fiber构建完成的时候，收集更新并且标识 更新副作用
      if (current &amp;&amp; workInProgress.stateNode) {
        updateHostComponent(current, workInProgress, workInProgress.tag, newProps);
      } else {
        //创建真实的DOM节点
        const type = workInProgress.type;//div p span
        //创建此fiber的真实DOM
        const instance = createInstance(type, newProps);
</span><span class="token inserted-sign inserted">+        appendAllChildren(instance, workInProgress);
</span><span class="token unchanged">        //让此Fiber的真实DOM属性指向instance
        workInProgress.stateNode = instance;
        //给真实DOM添加属性 包括如果独生子是字符串或数字的情况
        finalizeInitialChildren(instance, type, newProps);
      }
      break;
    default:
      break;
  }
</span>}
</code></pre></div><div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">appendAllChildren</span><span class="token punctuation">(</span><span class="token parameter">parent<span class="token punctuation">,</span> workInProgress</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> node <span class="token operator">=</span> workInProgress<span class="token punctuation">.</span>child<span class="token punctuation">;</span>
  <span class="token keyword">while</span> <span class="token punctuation">(</span>node<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>node<span class="token punctuation">.</span>tag <span class="token operator">===</span> HostComponent<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">//把大儿子的真实DOM节点添加到父真实DOM上</span>
      <span class="token function">appendChild</span><span class="token punctuation">(</span>parent<span class="token punctuation">,</span> node<span class="token punctuation">.</span>stateNode<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>node <span class="token operator">===</span> workInProgress<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token punctuation">(</span> node<span class="token punctuation">.</span>sibling <span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token punctuation">(</span> node<span class="token punctuation">.</span>return <span class="token punctuation">)</span> <span class="token operator">||</span> node<span class="token punctuation">.</span>return <span class="token operator">===</span> workInProgress<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      node <span class="token operator">=</span> node<span class="token punctuation">.</span>return<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    node <span class="token operator">=</span> node<span class="token punctuation">.</span>sibling<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>正真的DOM操作appendChild</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">appendChild</span><span class="token punctuation">(</span><span class="token parameter">parentInstance<span class="token punctuation">,</span> child</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  parentInstance<span class="token punctuation">.</span><span class="token function">appendChild</span><span class="token punctuation">(</span>child<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>然后去掉newFiber.flags = Placement这个，再来看下结果：</p> <p><img src="https://gitee.com/yutao618/images/raw/master/images/20211214173427.png" alt=""></p> <p>最后看下更新的操作结果：</p> <p><img src="https://gitee.com/yutao618/images/raw/master/images/20211214174011.png" alt=""></p> <p>到这里，单节点的dom-diff已经是实现，测试也是ok的。</p> <ul><li><a href="https://gitee.com/yutao618/react-dom-diff/tree/single/" target="_blank" rel="noopener noreferrer">git地址<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li></ul></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/note/web/react/1.html" class="prev">
        react初次渲染
      </a></span> <span class="next"><a href="/note/web/react/3.html">
        react多节点diff
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/note/assets/js/app.02190172.js" defer></script><script src="/note/assets/js/2.2dccd611.js" defer></script><script src="/note/assets/js/27.234a7f7e.js" defer></script>
  </body>
</html>
