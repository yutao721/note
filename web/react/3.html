<!doctype html>
<html lang="en-US">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <meta name="generator" content="VuePress 2.0.0-rc.24" />
    <style>
      :root {
        --vp-c-bg: #fff;
      }

      [data-theme='dark'] {
        --vp-c-bg: #1b1b1f;
      }

      html,
      body {
        background-color: var(--vp-c-bg);
      }
    </style>
    <script>
      const useChoice = localStorage.getItem('vuepress-color-scheme')
      const systemStatus =
        'matchMedia' in window
          ? window.matchMedia('(prefers-color-scheme: dark)').matches
          : false

      if (useChoice === 'light') {
        document.documentElement.dataset.theme = 'light'
      } else if (useChoice === 'dark' || systemStatus) {
        document.documentElement.dataset.theme = 'dark'
      }
    </script>
    <title>jiaHang前端学习笔记</title><meta name="description" content="专注前端技术栈分享，做一个爱折腾的前端">
    <link rel="preload" href="/note/assets/style-C2JCxPSn.css" as="style"><link rel="stylesheet" href="/note/assets/style-C2JCxPSn.css">
    <link rel="modulepreload" href="/note/assets/app-CD1YpnS1.js"><link rel="modulepreload" href="/note/assets/3.html-CJlcCiJm.js">
    <link rel="prefetch" href="/note/assets/index.html-RprxaRdQ.js" as="script"><link rel="prefetch" href="/note/assets/01_what.html-DXoe1Mvz.js" as="script"><link rel="prefetch" href="/note/assets/02_module.html-CqTa0EK7.js" as="script"><link rel="prefetch" href="/note/assets/fs.html-BT8eVpTw.js" as="script"><link rel="prefetch" href="/note/assets/path.html-C0J4PgTW.js" as="script"><link rel="prefetch" href="/note/assets/index.html-CSzzjsys.js" as="script"><link rel="prefetch" href="/note/assets/index.html-DHVzh_gw.js" as="script"><link rel="prefetch" href="/note/assets/index.html-DZ4eJucx.js" as="script"><link rel="prefetch" href="/note/assets/0.Async.html-CS_47M_6.js" as="script"><link rel="prefetch" href="/note/assets/0.module.html-CAs_Aayz.js" as="script"><link rel="prefetch" href="/note/assets/1.ES2015.html-D6LTmgg5.js" as="script"><link rel="prefetch" href="/note/assets/10.fs.html-BYKD_AEa.js" as="script"><link rel="prefetch" href="/note/assets/100.1.react-basic.html-q2RiM9xv.js" as="script"><link rel="prefetch" href="/note/assets/101.1.monitor.html-DpZ4wH2t.js" as="script"><link rel="prefetch" href="/note/assets/101.2.monitor.html-BN8957Km.js" as="script"><link rel="prefetch" href="/note/assets/102.java.html-7mArHl0O.js" as="script"><link rel="prefetch" href="/note/assets/103.1.webpack-usage.html-D-0_AYGw.js" as="script"><link rel="prefetch" href="/note/assets/103.10.webpack-hand.html-Df0SchBX.js" as="script"><link rel="prefetch" href="/note/assets/103.11.mf.html-Dt36jvCX.js" as="script"><link rel="prefetch" href="/note/assets/103.11.webpack-hmr.html-BcDUilKE.js" as="script"><link rel="prefetch" href="/note/assets/103.11.webpack5.html-CkHWZbwZ.js" as="script"><link rel="prefetch" href="/note/assets/103.13.splitChunks.html-DZ0KN3Q8.js" as="script"><link rel="prefetch" href="/note/assets/103.14.webpack-sourcemap.html-0OJ-CWuz.js" as="script"><link rel="prefetch" href="/note/assets/103.15.webpack-compiler1.html-CmhWGMMz.js" as="script"><link rel="prefetch" href="/note/assets/103.15.webpack-compiler2.html-CijkiRGH.js" as="script"><link rel="prefetch" href="/note/assets/103.16.rollup.1.html-DWJd7hwg.js" as="script"><link rel="prefetch" href="/note/assets/103.16.rollup.2.html-CITUKKRb.js" as="script"><link rel="prefetch" href="/note/assets/103.16.rollup.3.html-BINfdDwz.js" as="script"><link rel="prefetch" href="/note/assets/103.16.vite.1.html-d7O6-EDT.js" as="script"><link rel="prefetch" href="/note/assets/103.16.vite.2.html-DQ6m4iKt.js" as="script"><link rel="prefetch" href="/note/assets/103.16.vite.basic.html-CHh2HSME.js" as="script"><link rel="prefetch" href="/note/assets/103.16.vite.plugin.html-CeENg64B.js" as="script"><link rel="prefetch" href="/note/assets/103.16.vite.source.html-BKfwXurq.js" as="script"><link rel="prefetch" href="/note/assets/103.17.polyfill.html-Dc0xxdv7.js" as="script"><link rel="prefetch" href="/note/assets/103.2.webpack-bundle.html-BLXhNWzS.js" as="script"><link rel="prefetch" href="/note/assets/103.3.webpack-ast.html-Sf6Nd_VI.js" as="script"><link rel="prefetch" href="/note/assets/103.4.webpack-flow.html-VYLDicns.js" as="script"><link rel="prefetch" href="/note/assets/103.5.webpack-loader.html-CP0tEx4h.js" as="script"><link rel="prefetch" href="/note/assets/103.6.webpack-tapable.html-ciWZVUlU.js" as="script"><link rel="prefetch" href="/note/assets/103.7.webpack-plugin.html-DK_58Gbo.js" as="script"><link rel="prefetch" href="/note/assets/103.8.webpack-optimize1.html-CDrVz0Dj.js" as="script"><link rel="prefetch" href="/note/assets/103.9.webpack-optimize2.html-DGmohvoc.js" as="script"><link rel="prefetch" href="/note/assets/104.1.binary.html-DNqWlBCF.js" as="script"><link rel="prefetch" href="/note/assets/104.2.binary.html-C_vrUJE4.js" as="script"><link rel="prefetch" href="/note/assets/105.skeleton.html-C8J5DFeq.js" as="script"><link rel="prefetch" href="/note/assets/106.1.react.html--wjnewZu.js" as="script"><link rel="prefetch" href="/note/assets/106.10.ketang.html-CKs_UzGp.js" as="script"><link rel="prefetch" href="/note/assets/106.11.antdesign.html-Di48OSO0.js" as="script"><link rel="prefetch" href="/note/assets/106.12.antpro.html-D3g50nUD.js" as="script"><link rel="prefetch" href="/note/assets/106.13.router-6.html-C3utpwal.js" as="script"><link rel="prefetch" href="/note/assets/106.14.ssr.html-DD62ZXCB.js" as="script"><link rel="prefetch" href="/note/assets/106.15.nextjs.html-CvLnboBO.js" as="script"><link rel="prefetch" href="/note/assets/106.16.1.cms.html-BzMU7O9i.js" as="script"><link rel="prefetch" href="/note/assets/106.16.2.cms.html-DUqxUXwJ.js" as="script"><link rel="prefetch" href="/note/assets/106.16.3.cms.html-BX5E0jiR.js" as="script"><link rel="prefetch" href="/note/assets/106.16.4.cms.html-BNo0R89r.js" as="script"><link rel="prefetch" href="/note/assets/106.16.mobx.html-DOcjU8cP.js" as="script"><link rel="prefetch" href="/note/assets/106.17.fomily.html-B3l_VGg6.js" as="script"><link rel="prefetch" href="/note/assets/106.2.react_hooks.html-CPbqmmHB.js" as="script"><link rel="prefetch" href="/note/assets/106.3.react_router.html-DZ1JjvG-.js" as="script"><link rel="prefetch" href="/note/assets/106.4.redux.html-DUy5hcTX.js" as="script"><link rel="prefetch" href="/note/assets/106.5.redux_middleware.html-DYOR8gEV.js" as="script"><link rel="prefetch" href="/note/assets/106.6.connected-react-router.html-48b3IcxF.js" as="script"><link rel="prefetch" href="/note/assets/106.6.redux-first-history.html-JPVkAkj4.js" as="script"><link rel="prefetch" href="/note/assets/106.7.redux-saga.html-BcD09XG-.js" as="script"><link rel="prefetch" href="/note/assets/106.8.dva.html-Bt9qGgfc.js" as="script"><link rel="prefetch" href="/note/assets/106.9.umi.html-DMoz7Izf.js" as="script"><link rel="prefetch" href="/note/assets/107.fiber.html-CkgmPq5X.js" as="script"><link rel="prefetch" href="/note/assets/108.http.html-ByLAjW6M.js" as="script"><link rel="prefetch" href="/note/assets/109.1.webpack_usage.html-01H2ymR7.js" as="script"><link rel="prefetch" href="/note/assets/109.2.webpack_source.html-BW3X0FOx.js" as="script"><link rel="prefetch" href="/note/assets/109.3.dll.html-B1yyWSQT.js" as="script"><link rel="prefetch" href="/note/assets/11.Stream-1.html-xlJx2BBS.js" as="script"><link rel="prefetch" href="/note/assets/11.Stream-2.html-DfFJBy_H.js" as="script"><link rel="prefetch" href="/note/assets/11.Stream-3.html-BlfCzHUZ.js" as="script"><link rel="prefetch" href="/note/assets/11.Stream-4.html-S20wpBH6.js" as="script"><link rel="prefetch" href="/note/assets/110.nest.js.html-Cw06a8sN.js" as="script"><link rel="prefetch" href="/note/assets/111.xstate.html-CZi7pJFL.js" as="script"><link rel="prefetch" href="/note/assets/112.Form.html-BShMZ1gY.js" as="script"><link rel="prefetch" href="/note/assets/113.redux-saga.html-Ckl17EUg.js" as="script"><link rel="prefetch" href="/note/assets/114.react_typescript.html-CKbJiTZs.js" as="script"><link rel="prefetch" href="/note/assets/115.immer.html-BMiZpeG3.js" as="script"><link rel="prefetch" href="/note/assets/116.pro5.html-B_gZbSMB.js" as="script"><link rel="prefetch" href="/note/assets/117.css-loader.html-De6hgq8K.js" as="script"><link rel="prefetch" href="/note/assets/118.1.umi-core.html-DEIs2agx.js" as="script"><link rel="prefetch" href="/note/assets/119.1.module-federation.html-DG_IyLJ5.js" as="script"><link rel="prefetch" href="/note/assets/119.2.module-federation.html-D--d52wk.js" as="script"><link rel="prefetch" href="/note/assets/12-Network-2.html-D35_EoPi.js" as="script"><link rel="prefetch" href="/note/assets/12.Network-1.html-DbBYPgui.js" as="script"><link rel="prefetch" href="/note/assets/12.NetWork-3.html-DeFFqX4j.js" as="script"><link rel="prefetch" href="/note/assets/120.create-react-app.html-B14_1r_n.js" as="script"><link rel="prefetch" href="/note/assets/121.react-scripts.html-CyRuqNMU.js" as="script"><link rel="prefetch" href="/note/assets/122.react-optimize.html-Bsv3k7_b.js" as="script"><link rel="prefetch" href="/note/assets/123.jsx-runtime.html-wDUGZSn2.js" as="script"><link rel="prefetch" href="/note/assets/124.next.js.html-DW_eKHwE.js" as="script"><link rel="prefetch" href="/note/assets/125.1.linux.html-DnyqbVfM.js" as="script"><link rel="prefetch" href="/note/assets/125.10.nginx.html-bQhX_0JB.js" as="script"><link rel="prefetch" href="/note/assets/125.11.docker.html-DKj07d-Q.js" as="script"><link rel="prefetch" href="/note/assets/125.12.ci.html-D5Om8qjf.js" as="script"><link rel="prefetch" href="/note/assets/125.13.k8s.html-BUrcs6xD.js" as="script"><link rel="prefetch" href="/note/assets/125.14.k8s.html-r5pk7qpt.js" as="script"><link rel="prefetch" href="/note/assets/125.15.k8s.html-D_26v2x8.js" as="script"><link rel="prefetch" href="/note/assets/125.16.k8s.html-BJCS2_mW.js" as="script"><link rel="prefetch" href="/note/assets/125.2.linux-vi.html-CcqiaP81.js" as="script"><link rel="prefetch" href="/note/assets/125.3.linux-user.html-CXSx_0Rm.js" as="script"><link rel="prefetch" href="/note/assets/125.4.linux-auth.html-BuGIteZC.js" as="script"><link rel="prefetch" href="/note/assets/125.5.linux-shell.html-1ZpdzlQL.js" as="script"><link rel="prefetch" href="/note/assets/125.6.linux-install.html-uuXTZG6p.js" as="script"><link rel="prefetch" href="/note/assets/125.7.linux-system.html-Cv6Urtun.js" as="script"><link rel="prefetch" href="/note/assets/125.8.linux-service.html-C0aH0zIU.js" as="script"><link rel="prefetch" href="/note/assets/125.9.linux-network.html-CsMcYFtu.js" as="script"><link rel="prefetch" href="/note/assets/126.11.react-1.html-BeiGY4MK.js" as="script"><link rel="prefetch" href="/note/assets/126.12.react-2.html-DUzinTwV.js" as="script"><link rel="prefetch" href="/note/assets/126.12.react-3.html-Ce2PKxxk.js" as="script"><link rel="prefetch" href="/note/assets/126.12.react-4.html-C0M-m5NW.js" as="script"><link rel="prefetch" href="/note/assets/126.12.react-5.html-Ck8H7xW5.js" as="script"><link rel="prefetch" href="/note/assets/126.12.react-6.html-DB1Bqmfo.js" as="script"><link rel="prefetch" href="/note/assets/126.12.react-7.html-rjQInsWF.js" as="script"><link rel="prefetch" href="/note/assets/126.12.react-8.html-DQi7O5Va.js" as="script"><link rel="prefetch" href="/note/assets/127.frontend.html-P8T9DO-t.js" as="script"><link rel="prefetch" href="/note/assets/128.rollup.html-CAFKp2v9.js" as="script"><link rel="prefetch" href="/note/assets/129.px2rem-loader.html-DdXIOc3_.js" as="script"><link rel="prefetch" href="/note/assets/13.tcp.html-CKYBMSJc.js" as="script"><link rel="prefetch" href="/note/assets/130.health.html-D-c3Olku.js" as="script"><link rel="prefetch" href="/note/assets/131.hooks.html-DCj-HV7v.js" as="script"><link rel="prefetch" href="/note/assets/132.keepalive.html-rH6Muw4_.js" as="script"><link rel="prefetch" href="/note/assets/133.vue-cli.html-CpJ2Gsou.js" as="script"><link rel="prefetch" href="/note/assets/134.2.react18.html-BbUx_G2e.js" as="script"><link rel="prefetch" href="/note/assets/134.3.react18.html-kGAha0i-.js" as="script"><link rel="prefetch" href="/note/assets/134.react18.html-BVgn-2C1.js" as="script"><link rel="prefetch" href="/note/assets/135.function.html-WClr4Q0d.js" as="script"><link rel="prefetch" href="/note/assets/136.toolkit.html-BiLwmmb-.js" as="script"><link rel="prefetch" href="/note/assets/137.lerna.html-B-TPy1AR.js" as="script"><link rel="prefetch" href="/note/assets/138.create-vite.html-DFrKdLZU.js" as="script"><link rel="prefetch" href="/note/assets/139.cli.html-CdBHXEQp.js" as="script"><link rel="prefetch" href="/note/assets/14.http-1.html-BAGLlsTG.js" as="script"><link rel="prefetch" href="/note/assets/14.http-2.html-DoHJVDkV.js" as="script"><link rel="prefetch" href="/note/assets/140.antd.html-LB3FSlgi.js" as="script"><link rel="prefetch" href="/note/assets/141.react-dnd.html-8oGaRwhj.js" as="script"><link rel="prefetch" href="/note/assets/142.1.link.html-lZCvcEqM.js" as="script"><link rel="prefetch" href="/note/assets/143.1.gulp.html-lQ8BiOQ6.js" as="script"><link rel="prefetch" href="/note/assets/143.2.stream.html-529FgUgt.js" as="script"><link rel="prefetch" href="/note/assets/143.3.gulp.html-Jn_Cj5Yr.js" as="script"><link rel="prefetch" href="/note/assets/144.1.closure.html-BLaGEv9j.js" as="script"><link rel="prefetch" href="/note/assets/144.2.v8.html-DzkaEYZj.js" as="script"><link rel="prefetch" href="/note/assets/144.3.gc.html-Biwh9QyL.js" as="script"><link rel="prefetch" href="/note/assets/145.react-router-v6.html-BsXCWrPu.js" as="script"><link rel="prefetch" href="/note/assets/146.browser.html-67IGbESG.js" as="script"><link rel="prefetch" href="/note/assets/147.lighthouse.html-CmBlr3uk.js" as="script"><link rel="prefetch" href="/note/assets/148.1.basic.html-aE39oEmi.js" as="script"><link rel="prefetch" href="/note/assets/148.2.basic.html-BSD2Xi61.js" as="script"><link rel="prefetch" href="/note/assets/148.3.basic.html-hPG5Ncoc.js" as="script"><link rel="prefetch" href="/note/assets/148.4.basic.html-2tjqdY0U.js" as="script"><link rel="prefetch" href="/note/assets/148.5.basic.html-Be3j8eYi.js" as="script"><link rel="prefetch" href="/note/assets/149.1.vite.html-DLt3GVgC.js" as="script"><link rel="prefetch" href="/note/assets/149.2.vite.html-BIhiVz3X.js" as="script"><link rel="prefetch" href="/note/assets/149.3.vite.html-DJIY2PsB.js" as="script"><link rel="prefetch" href="/note/assets/149.4.vite.html-w8lfNBfD.js" as="script"><link rel="prefetch" href="/note/assets/15.compress.html-DFqbXS6X.js" as="script"><link rel="prefetch" href="/note/assets/150.react-window.html-DxHvNqZM.js" as="script"><link rel="prefetch" href="/note/assets/151.react-query.html-BLw-GOjK.js" as="script"><link rel="prefetch" href="/note/assets/152.useRequest.html-BA0fd0wj.js" as="script"><link rel="prefetch" href="/note/assets/153.transition.html-BezMBHJw.js" as="script"><link rel="prefetch" href="/note/assets/154.emotion.html-DLYkCeII.js" as="script"><link rel="prefetch" href="/note/assets/155.1.formily.html-iyHhsAjb.js" as="script"><link rel="prefetch" href="/note/assets/155.2.formily.html-BPB_6ZsZ.js" as="script"><link rel="prefetch" href="/note/assets/155.3.1.mobx.usage.html-BNyXEbcX.js" as="script"><link rel="prefetch" href="/note/assets/155.3.2.mobx.source.html-DVifKbCi.js" as="script"><link rel="prefetch" href="/note/assets/155.3.formily.html-FT7AihqZ.js" as="script"><link rel="prefetch" href="/note/assets/156.vue-loader.html-BHdP6j39.js" as="script"><link rel="prefetch" href="/note/assets/157.1.react18.html-C6j0EeEp.js" as="script"><link rel="prefetch" href="/note/assets/158.umi4.html-DdlGpN-0.js" as="script"><link rel="prefetch" href="/note/assets/159.rxjs.html-BZf7sv7n.js" as="script"><link rel="prefetch" href="/note/assets/159.rxjs2.html-gy3xMihA.js" as="script"><link rel="prefetch" href="/note/assets/16.crypto.html-Daa-CKUW.js" as="script"><link rel="prefetch" href="/note/assets/160.bff.html-DJLO7FEP.js" as="script"><link rel="prefetch" href="/note/assets/161.zustand.html-DXR_yWga.js" as="script"><link rel="prefetch" href="/note/assets/162.vscode.html-C0B-rdGZ.js" as="script"><link rel="prefetch" href="/note/assets/163.emp.html-Cm1W6tdE.js" as="script"><link rel="prefetch" href="/note/assets/17.process.html-Do6Auoi0.js" as="script"><link rel="prefetch" href="/note/assets/18.yargs.html-CXf2EHeb.js" as="script"><link rel="prefetch" href="/note/assets/19.cache.html-6yn9hKqf.js" as="script"><link rel="prefetch" href="/note/assets/2.Promise.html-B8LhZWVO.js" as="script"><link rel="prefetch" href="/note/assets/20.action.html-DZ3xrGPW.js" as="script"><link rel="prefetch" href="/note/assets/21.https.html-B5eCdY0A.js" as="script"><link rel="prefetch" href="/note/assets/22.cookie.html-xY3JpYsE.js" as="script"><link rel="prefetch" href="/note/assets/23.session.html-CXLSdItY.js" as="script"><link rel="prefetch" href="/note/assets/24.express-1.html-Dik9h2zC.js" as="script"><link rel="prefetch" href="/note/assets/24.express-2.html-CpmjTlIA.js" as="script"><link rel="prefetch" href="/note/assets/24.express-3.html-gfTYvrHG.js" as="script"><link rel="prefetch" href="/note/assets/24.express-4.html-CMdPxeLd.js" as="script"><link rel="prefetch" href="/note/assets/25.koa-1.html-Dd7bFhL_.js" as="script"><link rel="prefetch" href="/note/assets/26.webpack-1-basic.html-znj8iGmt.js" as="script"><link rel="prefetch" href="/note/assets/26.webpack-10-prepare.html-CF9o-dA-.js" as="script"><link rel="prefetch" href="/note/assets/26.webpack-2-optimize.html-0YxeEICF.js" as="script"><link rel="prefetch" href="/note/assets/26.webpack-3-file.html-CpWVZnXH.js" as="script"><link rel="prefetch" href="/note/assets/26.webpack-4.tapable.html-CXayT76l.js" as="script"><link rel="prefetch" href="/note/assets/26.webpack-5-AST.html-DOB4bi9e.js" as="script"><link rel="prefetch" href="/note/assets/26.webpack-6-sources.html-JS7RqYJs.js" as="script"><link rel="prefetch" href="/note/assets/26.webpack-7-loader.html-BHVl2-u5.js" as="script"><link rel="prefetch" href="/note/assets/26.webpack-8-plugin.html-DOv5hu42.js" as="script"><link rel="prefetch" href="/note/assets/26.webpack-9-hand.html-BLpwsVpf.js" as="script"><link rel="prefetch" href="/note/assets/28.redux-jwt-back.html-CL8YJY_s.js" as="script"><link rel="prefetch" href="/note/assets/28.redux-jwt-front.html-CPktPfR-.js" as="script"><link rel="prefetch" href="/note/assets/28.redux.html-D0zQn9Wv.js" as="script"><link rel="prefetch" href="/note/assets/29.mongodb-1.html-Pv4Xfpbl.js" as="script"><link rel="prefetch" href="/note/assets/29.mongodb-2.html-BGO5Ubcx.js" as="script"><link rel="prefetch" href="/note/assets/29.mongodb-3.html-0dz0yFne.js" as="script"><link rel="prefetch" href="/note/assets/29.mongodb-4.html-DiX5l9J5.js" as="script"><link rel="prefetch" href="/note/assets/29.mongodb-5.html-_ZCVvFb-.js" as="script"><link rel="prefetch" href="/note/assets/29.mongodb-6.html-8F2tnaGU.js" as="script"><link rel="prefetch" href="/note/assets/3.Node.html-CVJyRsh4.js" as="script"><link rel="prefetch" href="/note/assets/30.cms-1-mysql.html-w36ZEDbJ.js" as="script"><link rel="prefetch" href="/note/assets/30.cms-10-umi.html-DHDTw8AX.js" as="script"><link rel="prefetch" href="/note/assets/30.cms-12-dva.html-Yw135a91.js" as="script"><link rel="prefetch" href="/note/assets/30.cms-13-dva-ant.html-D41sMENc.js" as="script"><link rel="prefetch" href="/note/assets/30.cms-14-front.html-C9aHidR4.js" as="script"><link rel="prefetch" href="/note/assets/30.cms-15-deploy.html-DPDln-oU.js" as="script"><link rel="prefetch" href="/note/assets/30.cms-2-mysql.html-BnZ-m3An.js" as="script"><link rel="prefetch" href="/note/assets/30.cms-3-mysql.html-TbnQgFPh.js" as="script"><link rel="prefetch" href="/note/assets/30.cms-4-nunjucks.html-Cu_Zc4HX.js" as="script"><link rel="prefetch" href="/note/assets/30.cms-5-mock.html-7To8e7Ru.js" as="script"><link rel="prefetch" href="/note/assets/30.cms-6-egg.html-DzLVtg_b.js" as="script"><link rel="prefetch" href="/note/assets/30.cms-7-api.html-QGrMEANV.js" as="script"><link rel="prefetch" href="/note/assets/30.cms-8-roadhog.html-3-zdR5Lr.js" as="script"><link rel="prefetch" href="/note/assets/30.cms-9-yaml.html-DD-nZIwX.js" as="script"><link rel="prefetch" href="/note/assets/31.cms-13-dva-antdesign.html-5-PCj57e.js" as="script"><link rel="prefetch" href="/note/assets/31.dva.html-Y8ngVAuC.js" as="script"><link rel="prefetch" href="/note/assets/33.redis.html-D6Wcj_s9.js" as="script"><link rel="prefetch" href="/note/assets/34.unittest.html-BaDLiBXX.js" as="script"><link rel="prefetch" href="/note/assets/35.jwt.html-DuYpdM4t.js" as="script"><link rel="prefetch" href="/note/assets/36.websocket-1.html-Dh_pvB1k.js" as="script"><link rel="prefetch" href="/note/assets/36.websocket-2.html-BHNY3_tg.js" as="script"><link rel="prefetch" href="/note/assets/38.chat-3.html-Y_6ssF3A.js" as="script"><link rel="prefetch" href="/note/assets/38.chat-api-1.html-WUy2xLmo.js" as="script"><link rel="prefetch" href="/note/assets/38.chat-api-2.html-DcQ-EIHA.js" as="script"><link rel="prefetch" href="/note/assets/38.chat-api-3.html-Czq6328j.js" as="script"><link rel="prefetch" href="/note/assets/38.chat.html-BkFQ31vA.js" as="script"><link rel="prefetch" href="/note/assets/38.chat2.html-XaQVBou5.js" as="script"><link rel="prefetch" href="/note/assets/39.crawl-0.html-D1TZxDBn.js" as="script"><link rel="prefetch" href="/note/assets/39.crawl-1.html-CGwUmSD7.js" as="script"><link rel="prefetch" href="/note/assets/39.crawl-2.html-Cu4GTjUx.js" as="script"><link rel="prefetch" href="/note/assets/4.NodeInstall.html-C-NfBq9c.js" as="script"><link rel="prefetch" href="/note/assets/40.deploy.html-CQB2GYlg.js" as="script"><link rel="prefetch" href="/note/assets/41.safe.html-b-BgwqdM.js" as="script"><link rel="prefetch" href="/note/assets/42.test.html-DmJVyrzO.js" as="script"><link rel="prefetch" href="/note/assets/43.nginx.html-BCrGDtkC.js" as="script"><link rel="prefetch" href="/note/assets/44.enzyme.html-BUJ1Wsim.js" as="script"><link rel="prefetch" href="/note/assets/45.docker.html-meGnuTH1.js" as="script"><link rel="prefetch" href="/note/assets/46.elastic.html-C-NDCKEz.js" as="script"><link rel="prefetch" href="/note/assets/47.oauth.html-DXmQ7ZQS.js" as="script"><link rel="prefetch" href="/note/assets/48.wxpay.html-CXf5f1yr.js" as="script"><link rel="prefetch" href="/note/assets/5.REPL.html-CidfaD5i.js" as="script"><link rel="prefetch" href="/note/assets/52.UML.html-B4BJ5E6y.js" as="script"><link rel="prefetch" href="/note/assets/53.design.html-CsWAmvKx.js" as="script"><link rel="prefetch" href="/note/assets/54.linux.html-DQD5B8JZ.js" as="script"><link rel="prefetch" href="/note/assets/56.react-ssr.html-Big-WwSz.js" as="script"><link rel="prefetch" href="/note/assets/57.ts.html-B0fpuqZL.js" as="script"><link rel="prefetch" href="/note/assets/58.ts_react.html-BeGwgw7E.js" as="script"><link rel="prefetch" href="/note/assets/59.ketang.html-CjA_yYZ8.js" as="script"><link rel="prefetch" href="/note/assets/59.ketang2.html-D8EeOV2Y.js" as="script"><link rel="prefetch" href="/note/assets/6.NodeCore.html-CRzOkTZQ.js" as="script"><link rel="prefetch" href="/note/assets/61.1.devops-linux.html-DiRUS3_s.js" as="script"><link rel="prefetch" href="/note/assets/61.10.devops-nginx.html-BcoL58si.js" as="script"><link rel="prefetch" href="/note/assets/61.11.devops-docker.html-BMPEFLzq.js" as="script"><link rel="prefetch" href="/note/assets/61.12.devops-jekins.html-CJiYE71H.js" as="script"><link rel="prefetch" href="/note/assets/61.13.devops-groovy.html-Cjb5NlUb.js" as="script"><link rel="prefetch" href="/note/assets/61.14.devops-php.html-CWCYNr_h.js" as="script"><link rel="prefetch" href="/note/assets/61.15.devops-java.html-BRCqDJv9.js" as="script"><link rel="prefetch" href="/note/assets/61.16.devops-node.html-ByV7Uo9i.js" as="script"><link rel="prefetch" href="/note/assets/61.17.devops-k8s.html-DcwykEXE.js" as="script"><link rel="prefetch" href="/note/assets/61.2.devops-vi.html-C1TYrlgl.js" as="script"><link rel="prefetch" href="/note/assets/61.3.devops-user.html-DItpj1rP.js" as="script"><link rel="prefetch" href="/note/assets/61.4.devops-auth.html-DX-L8AbS.js" as="script"><link rel="prefetch" href="/note/assets/61.5.devops-shell.html-zHp5a36b.js" as="script"><link rel="prefetch" href="/note/assets/61.6.devops-install.html-UmiLCNn6.js" as="script"><link rel="prefetch" href="/note/assets/61.7.devops-system.html-BjQl5TmD.js" as="script"><link rel="prefetch" href="/note/assets/61.8.devops-service.html-CbHIm2Eh.js" as="script"><link rel="prefetch" href="/note/assets/61.9.devops-network.html-BBkto6Vx.js" as="script"><link rel="prefetch" href="/note/assets/62.1.react-basic.html-C1AC_GYX.js" as="script"><link rel="prefetch" href="/note/assets/62.2.react-state.html-GELRAxzi.js" as="script"><link rel="prefetch" href="/note/assets/62.3.react-high.html-Bi39MyFS.js" as="script"><link rel="prefetch" href="/note/assets/62.4.react-optimize.html-DP4SDDAR.js" as="script"><link rel="prefetch" href="/note/assets/62.5.react-hooks.html-DP6z1cjn.js" as="script"><link rel="prefetch" href="/note/assets/62.6.react-immutable.html-DXYWRyDF.js" as="script"><link rel="prefetch" href="/note/assets/62.7.react-mobx.html-DZK8b3nG.js" as="script"><link rel="prefetch" href="/note/assets/62.8.react-source.html-Bk2zCjrs.js" as="script"><link rel="prefetch" href="/note/assets/63.1.redux.html-B_DaXZCQ.js" as="script"><link rel="prefetch" href="/note/assets/63.2.redux-middleware.html-B73-lzR-.js" as="script"><link rel="prefetch" href="/note/assets/63.3.redux-hooks.html-BgFXUVhK.js" as="script"><link rel="prefetch" href="/note/assets/63.4.redux-saga.html-4l2ai-_h.js" as="script"><link rel="prefetch" href="/note/assets/63.5.redux-saga-hand.html-xnDUYDD1.js" as="script"><link rel="prefetch" href="/note/assets/64.1.router.html-ChPDT8zr.js" as="script"><link rel="prefetch" href="/note/assets/64.2.router-connected.html-BAEZ6gOl.js" as="script"><link rel="prefetch" href="/note/assets/65.1.typescript.html-NwSS2aVb.js" as="script"><link rel="prefetch" href="/note/assets/65.2.typescript.html-DxW7kfkC.js" as="script"><link rel="prefetch" href="/note/assets/65.3.typescript.html-lZ4WmoLH.js" as="script"><link rel="prefetch" href="/note/assets/65.4.antd.html-D5_DbOIn.js" as="script"><link rel="prefetch" href="/note/assets/65.4.definition.html-By4Gwcky.js" as="script"><link rel="prefetch" href="/note/assets/66-1.vue-base.html-Cs0Mldhe.js" as="script"><link rel="prefetch" href="/note/assets/66-10.jwt-vue.html-BUYZLpvc.js" as="script"><link rel="prefetch" href="/note/assets/66-11.vue-ssr.html-Bck9BA3W.js" as="script"><link rel="prefetch" href="/note/assets/66-12.nuxt-apply.html-koOovbJK.js" as="script"><link rel="prefetch" href="/note/assets/66-13.pwa.html-DDDnpOX-.js" as="script"><link rel="prefetch" href="/note/assets/66-14.vue单元测试.html-CQyEZ1lk.js" as="script"><link rel="prefetch" href="/note/assets/66-15.权限校验.html-CgZJ-Yss.js" as="script"><link rel="prefetch" href="/note/assets/66-2.vue-component.html-CrG2RBS9.js" as="script"><link rel="prefetch" href="/note/assets/66-3.vue-cli3.0.html-CbNNx9H5.js" as="script"><link rel="prefetch" href="/note/assets/66-4._message组件.html-BicEbrSC.js" as="script"><link rel="prefetch" href="/note/assets/66-5.Form组件.html-pFNJNwCK.js" as="script"><link rel="prefetch" href="/note/assets/66-6.tree.html-Bsr9nZwB.js" as="script"><link rel="prefetch" href="/note/assets/66-7.vue-router-apply.html-8LBFY5WK.js" as="script"><link rel="prefetch" href="/note/assets/66-8.axios-apply.html-YQeN4QTJ.js" as="script"><link rel="prefetch" href="/note/assets/66-9.vuex-apply.html-v2_RWOM0.js" as="script"><link rel="prefetch" href="/note/assets/67-1-network.html-Dx1uws72.js" as="script"><link rel="prefetch" href="/note/assets/68-2-wireshark.html-D4Lwj2PL.js" as="script"><link rel="prefetch" href="/note/assets/69-hooks.html-sqeAhpDb.js" as="script"><link rel="prefetch" href="/note/assets/7.module_NPM.html-Bq0cNwq7.js" as="script"><link rel="prefetch" href="/note/assets/7.npm2.html-aBEKb3-O.js" as="script"><link rel="prefetch" href="/note/assets/70-deploy.html-CIWv98y3.js" as="script"><link rel="prefetch" href="/note/assets/71-hmr.html-315SEmSJ.js" as="script"><link rel="prefetch" href="/note/assets/72.deploy.html-CeCpz1EH.js" as="script"><link rel="prefetch" href="/note/assets/73.import.html-BnyRH8c9.js" as="script"><link rel="prefetch" href="/note/assets/74.mobile.html-BVxyEJYa.js" as="script"><link rel="prefetch" href="/note/assets/75.webpack-1.文件分析.html-BvaSxQe5.js" as="script"><link rel="prefetch" href="/note/assets/75.webpack-10.asset.html-C5Z_5OD3.js" as="script"><link rel="prefetch" href="/note/assets/75.webpack-11.实现.html-BxAEupDO.js" as="script"><link rel="prefetch" href="/note/assets/75.webpack-2.loader.html-Dng06hmy.js" as="script"><link rel="prefetch" href="/note/assets/75.webpack-3.源码流程.html-CaxsZEx7.js" as="script"><link rel="prefetch" href="/note/assets/75.webpack-4.tapable.html-204X7UbF.js" as="script"><link rel="prefetch" href="/note/assets/75.webpack-5.prepare.html-C6OdCMl-.js" as="script"><link rel="prefetch" href="/note/assets/75.webpack-6.resolve.html-lMogTd0D.js" as="script"><link rel="prefetch" href="/note/assets/75.webpack-7.loader.html-C3h86V-P.js" as="script"><link rel="prefetch" href="/note/assets/75.webpack-8.module.html-KsZZDNZn.js" as="script"><link rel="prefetch" href="/note/assets/75.webpack-9.chunk.html-DKlDQH90.js" as="script"><link rel="prefetch" href="/note/assets/76.react_optimize.html-5cE5jMzO.js" as="script"><link rel="prefetch" href="/note/assets/77.ts_ketang_back.html-COVkFkPH.js" as="script"><link rel="prefetch" href="/note/assets/77.ts_ketang_front.html-1Zg_tl6y.js" as="script"><link rel="prefetch" href="/note/assets/78.vue-domdiff.html-DwaONqLz.js" as="script"><link rel="prefetch" href="/note/assets/79.grammar.html-CHD7JMW2.js" as="script"><link rel="prefetch" href="/note/assets/8.Encoding.html-CwYVjDX-.js" as="script"><link rel="prefetch" href="/note/assets/80.tree.html-BEA1J-MN.js" as="script"><link rel="prefetch" href="/note/assets/81.axios.html-D_u3QJtp.js" as="script"><link rel="prefetch" href="/note/assets/82.1.react.html-C859j5Qh.js" as="script"><link rel="prefetch" href="/note/assets/82.10.umi.html-DUWhggeY.js" as="script"><link rel="prefetch" href="/note/assets/82.11.antdesign.html-BCUzxPKa.js" as="script"><link rel="prefetch" href="/note/assets/82.12.ketang-back.html-BZFDb-gx.js" as="script"><link rel="prefetch" href="/note/assets/82.12.ketang-front.html-CFR-E9pC.js" as="script"><link rel="prefetch" href="/note/assets/82.2.react-high.html-DXZ88EMF.js" as="script"><link rel="prefetch" href="/note/assets/82.3.react-router.html-JaVD-S0h.js" as="script"><link rel="prefetch" href="/note/assets/82.4.redux.html-BMacB3xu.js" as="script"><link rel="prefetch" href="/note/assets/82.5.redux_middleware.html-sCquQ6nz.js" as="script"><link rel="prefetch" href="/note/assets/82.6.connected.html-DJreh3yo.js" as="script"><link rel="prefetch" href="/note/assets/82.7.saga.html-CPww91q6.js" as="script"><link rel="prefetch" href="/note/assets/82.8.dva-source.html-B2pXSv81.js" as="script"><link rel="prefetch" href="/note/assets/82.8.dva.html-Dek2mSed.js" as="script"><link rel="prefetch" href="/note/assets/82.9.roadhog.html-BGOGtbKC.js" as="script"><link rel="prefetch" href="/note/assets/83.upload.html-D30u-X4G.js" as="script"><link rel="prefetch" href="/note/assets/84.graphql.html-C6ToeUUv.js" as="script"><link rel="prefetch" href="/note/assets/85.antpro.html-DJSjwFre.js" as="script"><link rel="prefetch" href="/note/assets/86.1.uml.html-nb1n8-iZ.js" as="script"><link rel="prefetch" href="/note/assets/86.2.design.html-CcCJ8ePJ.js" as="script"><link rel="prefetch" href="/note/assets/87.postcss.html-893Jxzrm.js" as="script"><link rel="prefetch" href="/note/assets/88.react16-1.html-DrSSvnrv.js" as="script"><link rel="prefetch" href="/note/assets/89.nextjs.html-omDXcCS8.js" as="script"><link rel="prefetch" href="/note/assets/9.Buffer.html-CwKXxXfM.js" as="script"><link rel="prefetch" href="/note/assets/90.react-test.html-CwQ_3FNa.js" as="script"><link rel="prefetch" href="/note/assets/91.react-ts.html-CGUrs4vK.js" as="script"><link rel="prefetch" href="/note/assets/92.rbac.html-CuZARq4Q.js" as="script"><link rel="prefetch" href="/note/assets/93.tsnode.html-gr-ptkzc.js" as="script"><link rel="prefetch" href="/note/assets/94.1.JavaScript.html-ChEglBco.js" as="script"><link rel="prefetch" href="/note/assets/94.2.JavaScript.html-B0SwMGdF.js" as="script"><link rel="prefetch" href="/note/assets/94.3.MODULE.html-D9V1tkUk.js" as="script"><link rel="prefetch" href="/note/assets/94.4.EventLoop.html-D0RjtZ44.js" as="script"><link rel="prefetch" href="/note/assets/94.5.文件上传.html-DakrCw0c.js" as="script"><link rel="prefetch" href="/note/assets/94.6.https.html-CuWtyXSk.js" as="script"><link rel="prefetch" href="/note/assets/94.7.nginx.html-CAZENShj.js" as="script"><link rel="prefetch" href="/note/assets/95.1.react.html-CqBF7tpf.js" as="script"><link rel="prefetch" href="/note/assets/95.2.react.html-CUk8cDSQ.js" as="script"><link rel="prefetch" href="/note/assets/96.1.react16.html-BfS7RUtO.js" as="script"><link rel="prefetch" href="/note/assets/96.2.fiber.html-DXjUrRus.js" as="script"><link rel="prefetch" href="/note/assets/96.3.fiber.html-DKHFnbqL.js" as="script"><link rel="prefetch" href="/note/assets/97.serverless.html-BYjw02n-.js" as="script"><link rel="prefetch" href="/note/assets/98.websocket.html-CE6iPMnD.js" as="script"><link rel="prefetch" href="/note/assets/index.html--6LDt1ZF.js" as="script"><link rel="prefetch" href="/note/assets/index.html--6LDt1ZF.js" as="script"><link rel="prefetch" href="/note/assets/index.html-ChFan0vw.js" as="script"><link rel="prefetch" href="/note/assets/微信公众号本地如何调试.html-BtrBI-wE.js" as="script"><link rel="prefetch" href="/note/assets/微信公众号本地调试.html-CdOT045J.js" as="script"><link rel="prefetch" href="/note/assets/bind.html-CAxNlpzh.js" as="script"><link rel="prefetch" href="/note/assets/call.html-DIkkzauW.js" as="script"><link rel="prefetch" href="/note/assets/dataStructure.html-DGyBeQ3m.js" as="script"><link rel="prefetch" href="/note/assets/deepClone.html-E0vW27Sm.js" as="script"><link rel="prefetch" href="/note/assets/new.html-BVvYm1kZ.js" as="script"><link rel="prefetch" href="/note/assets/Promise.html-B2UowpHm.js" as="script"><link rel="prefetch" href="/note/assets/index.html-BbR5xT9u.js" as="script"><link rel="prefetch" href="/note/assets/githubAccess.html-Dc4rZygR.js" as="script"><link rel="prefetch" href="/note/assets/index.html-CrcnlmH_.js" as="script"><link rel="prefetch" href="/note/assets/typora_picgo_gitee图床使用教程.html-CdKzUlmX.js" as="script"><link rel="prefetch" href="/note/assets/1.html-CNMc12Zg.js" as="script"><link rel="prefetch" href="/note/assets/2.html-BBVhgp_x.js" as="script"><link rel="prefetch" href="/note/assets/4.html-BxMnqVA4.js" as="script"><link rel="prefetch" href="/note/assets/index.html-e7vFfhGy.js" as="script"><link rel="prefetch" href="/note/assets/index.html-DfTJGcK9.js" as="script"><link rel="prefetch" href="/note/assets/RTK.html-BK8KxSjb.js" as="script"><link rel="prefetch" href="/note/assets/index.html-DLKzP1lY.js" as="script"><link rel="prefetch" href="/note/assets/rollupTheory.html-BgvcXvbE.js" as="script"><link rel="prefetch" href="/note/assets/rollupUse.html-KKthNPfb.js" as="script"><link rel="prefetch" href="/note/assets/index.html-BI_fbqPy.js" as="script"><link rel="prefetch" href="/note/assets/vueRouter.html-CBVyHeKm.js" as="script"><link rel="prefetch" href="/note/assets/vuex.html-CX-WOScx.js" as="script"><link rel="prefetch" href="/note/assets/devServer.html-BJm70vo5.js" as="script"><link rel="prefetch" href="/note/assets/dllPlugin.html-ZXhdEud7.js" as="script"><link rel="prefetch" href="/note/assets/index.html-B2qVhzIo.js" as="script"><link rel="prefetch" href="/note/assets/IntersectionObserver.html-BOkHOytH.js" as="script"><link rel="prefetch" href="/note/assets/index.html-BqYxTk0_.js" as="script"><link rel="prefetch" href="/note/assets/request.html-Dfj3GaDw.js" as="script"><link rel="prefetch" href="/note/assets/swiper.html-rC6uYTme.js" as="script"><link rel="prefetch" href="/note/assets/404.html-DP3XF6FV.js" as="script">
  </head>
  <body>
    <div id="app"><!--[--><div class="vp-theme-container external-link-icon" vp-container><!--[--><header class="vp-navbar" vp-navbar><div class="vp-toggle-sidebar-button" title="toggle sidebar" aria-expanded="false" role="button" tabindex="0"><div class="icon" aria-hidden="true"><span></span><span></span><span></span></div></div><span><a class="route-link" href="/note/"><!----><span class="vp-site-name" aria-hidden="true">jiaHang前端学习笔记</span></a></span><div class="vp-navbar-items-wrapper" style=""><!--[--><!--]--><nav class="vp-navbar-items vp-hide-mobile" aria-label="site navigation"><!--[--><div class="vp-navbar-item"><a class="route-link auto-link" href="/note/" aria-label="主页"><!--[--><!--[--><!--]--><!--]-->主页<!--[--><!--[--><!--]--><!--]--></a></div><div class="vp-navbar-item"><a class="route-link route-link-active auto-link" href="/note/web/" aria-label="前端"><!--[--><!--[--><!--]--><!--]-->前端<!--[--><!--[--><!--]--><!--]--></a></div><div class="vp-navbar-item"><a class="route-link auto-link" href="/note/node/" aria-label="node"><!--[--><!--[--><!--]--><!--]-->node<!--[--><!--[--><!--]--><!--]--></a></div><div class="vp-navbar-item"><a class="route-link auto-link" href="/note/strong/" aria-label="前端架构"><!--[--><!--[--><!--]--><!--]-->前端架构<!--[--><!--[--><!--]--><!--]--></a></div><div class="vp-navbar-item"><a class="auto-link external-link" href="https://github.com/yutao721/note" aria-label="GitHub" rel="noopener noreferrer" target="_blank"><!--[--><!--[--><!--]--><!--]-->GitHub<!--[--><!--[--><!--]--><!--]--></a></div><!--]--></nav><!--[--><!--]--><button type="button" class="vp-toggle-color-mode-button" title="toggle color mode"><svg class="light-icon" viewbox="0 0 32 32" style=""><path d="M16 12.005a4 4 0 1 1-4 4a4.005 4.005 0 0 1 4-4m0-2a6 6 0 1 0 6 6a6 6 0 0 0-6-6z" fill="currentColor"></path><path d="M5.394 6.813l1.414-1.415l3.506 3.506L8.9 10.318z" fill="currentColor"></path><path d="M2 15.005h5v2H2z" fill="currentColor"></path><path d="M5.394 25.197L8.9 21.691l1.414 1.415l-3.506 3.505z" fill="currentColor"></path><path d="M15 25.005h2v5h-2z" fill="currentColor"></path><path d="M21.687 23.106l1.414-1.415l3.506 3.506l-1.414 1.414z" fill="currentColor"></path><path d="M25 15.005h5v2h-5z" fill="currentColor"></path><path d="M21.687 8.904l3.506-3.506l1.414 1.415l-3.506 3.505z" fill="currentColor"></path><path d="M15 2.005h2v5h-2z" fill="currentColor"></path></svg><svg class="dark-icon" viewbox="0 0 32 32" style="display:none;"><path d="M13.502 5.414a15.075 15.075 0 0 0 11.594 18.194a11.113 11.113 0 0 1-7.975 3.39c-.138 0-.278.005-.418 0a11.094 11.094 0 0 1-3.2-21.584M14.98 3a1.002 1.002 0 0 0-.175.016a13.096 13.096 0 0 0 1.825 25.981c.164.006.328 0 .49 0a13.072 13.072 0 0 0 10.703-5.555a1.01 1.01 0 0 0-.783-1.565A13.08 13.08 0 0 1 15.89 4.38A1.015 1.015 0 0 0 14.98 3z" fill="currentColor"></path></svg></button><!----></div></header><!--]--><div class="vp-sidebar-mask"></div><!--[--><aside class="vp-sidebar" vp-sidebar><nav class="vp-navbar-items" aria-label="site navigation"><!--[--><div class="vp-navbar-item"><a class="route-link auto-link" href="/note/" aria-label="主页"><!--[--><!--[--><!--]--><!--]-->主页<!--[--><!--[--><!--]--><!--]--></a></div><div class="vp-navbar-item"><a class="route-link route-link-active auto-link" href="/note/web/" aria-label="前端"><!--[--><!--[--><!--]--><!--]-->前端<!--[--><!--[--><!--]--><!--]--></a></div><div class="vp-navbar-item"><a class="route-link auto-link" href="/note/node/" aria-label="node"><!--[--><!--[--><!--]--><!--]-->node<!--[--><!--[--><!--]--><!--]--></a></div><div class="vp-navbar-item"><a class="route-link auto-link" href="/note/strong/" aria-label="前端架构"><!--[--><!--[--><!--]--><!--]-->前端架构<!--[--><!--[--><!--]--><!--]--></a></div><div class="vp-navbar-item"><a class="auto-link external-link" href="https://github.com/yutao721/note" aria-label="GitHub" rel="noopener noreferrer" target="_blank"><!--[--><!--[--><!--]--><!--]-->GitHub<!--[--><!--[--><!--]--><!--]--></a></div><!--]--></nav><!--[--><!--]--><ul class="vp-sidebar-items"><!--[--><li><a class="route-link auto-link vp-sidebar-item vp-sidebar-heading collapsible" href="/note/web/js/" aria-label="JavaScript"><!--[--><!--[--><!--]--><!--]-->JavaScript<!--[--><!--[--><span class="arrow right"></span><!--]--><!--]--></a><ul class="vp-sidebar-children" style="display:none;"><!--[--><li><a class="route-link auto-link vp-sidebar-item" href="/note/web/js/new.html" aria-label="手写实现New"><!--[--><!--[--><!--]--><!--]-->手写实现New<!--[--><!--[--><!--]--><!--]--></a><!----></li><li><a class="route-link auto-link vp-sidebar-item" href="/note/web/js/bind.html" aria-label="手写实现bind"><!--[--><!--[--><!--]--><!--]-->手写实现bind<!--[--><!--[--><!--]--><!--]--></a><!----></li><li><a class="route-link auto-link vp-sidebar-item" href="/note/web/js/call.html" aria-label="手写实现call"><!--[--><!--[--><!--]--><!--]-->手写实现call<!--[--><!--[--><!--]--><!--]--></a><!----></li><li><a class="route-link auto-link vp-sidebar-item" href="/note/web/js/Promise.html" aria-label="Promise实现"><!--[--><!--[--><!--]--><!--]-->Promise实现<!--[--><!--[--><!--]--><!--]--></a><!----></li><li><a class="route-link auto-link vp-sidebar-item" href="/note/web/js/dataStructure.html" aria-label="数据结构与算法"><!--[--><!--[--><!--]--><!--]-->数据结构与算法<!--[--><!--[--><!--]--><!--]--></a><!----></li><!--]--></ul></li><li><a class="route-link auto-link vp-sidebar-item vp-sidebar-heading collapsible" href="/note/web/vue/" aria-label="vue"><!--[--><!--[--><!--]--><!--]-->vue<!--[--><!--[--><span class="arrow right"></span><!--]--><!--]--></a><ul class="vp-sidebar-children" style="display:none;"><!--[--><li><a class="route-link auto-link vp-sidebar-item" href="/note/web/vue/vuex.html" aria-label="vuex实现"><!--[--><!--[--><!--]--><!--]-->vuex实现<!--[--><!--[--><!--]--><!--]--></a><!----></li><li><a class="route-link auto-link vp-sidebar-item" href="/note/web/vue/vueRouter.html" aria-label="vue-router实现"><!--[--><!--[--><!--]--><!--]-->vue-router实现<!--[--><!--[--><!--]--><!--]--></a><!----></li><!--]--></ul></li><li><a class="route-link route-link-active auto-link vp-sidebar-item vp-sidebar-heading active collapsible" href="/note/web/react/" aria-label="react"><!--[--><!--[--><!--]--><!--]-->react<!--[--><!--[--><span class="arrow down"></span><!--]--><!--]--></a><ul class="vp-sidebar-children" style=""><!--[--><li><a class="route-link auto-link vp-sidebar-item" href="/note/web/react/1.html" aria-label="react初次渲染"><!--[--><!--[--><!--]--><!--]-->react初次渲染<!--[--><!--[--><!--]--><!--]--></a><!----></li><li><a class="route-link auto-link vp-sidebar-item" href="/note/web/react/2.html" aria-label="react单节点diff"><!--[--><!--[--><!--]--><!--]-->react单节点diff<!--[--><!--[--><!--]--><!--]--></a><!----></li><li><a class="route-link route-link-active auto-link vp-sidebar-item active" href="/note/web/react/3.html" aria-label="react多节点diff"><!--[--><!--[--><!--]--><!--]-->react多节点diff<!--[--><!--[--><!--]--><!--]--></a><!----></li><!--]--></ul></li><li><a class="route-link auto-link vp-sidebar-item vp-sidebar-heading collapsible" href="/note/web/webpack/" aria-label="webpack"><!--[--><!--[--><!--]--><!--]-->webpack<!--[--><!--[--><span class="arrow right"></span><!--]--><!--]--></a><ul class="vp-sidebar-children" style="display:none;"><!--[--><li><a class="route-link auto-link vp-sidebar-item" href="/note/web/webpack/devServer.html" aria-label="devServer开发配置"><!--[--><!--[--><!--]--><!--]-->devServer开发配置<!--[--><!--[--><!--]--><!--]--></a><!----></li><li><a class="route-link auto-link vp-sidebar-item" href="/note/web/webpack/dllPlugin.html" aria-label="webpack性能优化之dllPlugin"><!--[--><!--[--><!--]--><!--]-->webpack性能优化之dllPlugin<!--[--><!--[--><!--]--><!--]--></a><!----></li><!--]--></ul></li><li><a class="route-link auto-link vp-sidebar-item vp-sidebar-heading collapsible" href="/note/web/rollup/" aria-label="rollup"><!--[--><!--[--><!--]--><!--]-->rollup<!--[--><!--[--><span class="arrow right"></span><!--]--><!--]--></a><ul class="vp-sidebar-children" style="display:none;"><!--[--><li><a class="route-link auto-link vp-sidebar-item" href="/note/web/rollup/rollupUse.html" aria-label="rollup使用教程"><!--[--><!--[--><!--]--><!--]-->rollup使用教程<!--[--><!--[--><!--]--><!--]--></a><!----></li><li><a class="route-link auto-link vp-sidebar-item" href="/note/web/rollup/rollupTheory.html" aria-label="rollup打包原理"><!--[--><!--[--><!--]--><!--]-->rollup打包原理<!--[--><!--[--><!--]--><!--]--></a><!----></li><!--]--></ul></li><li><a class="route-link auto-link vp-sidebar-item vp-sidebar-heading collapsible" href="/note/web/wxApp/" aria-label="小程序"><!--[--><!--[--><!--]--><!--]-->小程序<!--[--><!--[--><span class="arrow right"></span><!--]--><!--]--></a><ul class="vp-sidebar-children" style="display:none;"><!--[--><li><a class="route-link auto-link vp-sidebar-item" href="/note/web/wxApp/swiper.html" aria-label="swiper自定义样式"><!--[--><!--[--><!--]--><!--]-->swiper自定义样式<!--[--><!--[--><!--]--><!--]--></a><!----></li><li><a class="route-link auto-link vp-sidebar-item" href="/note/web/wxApp/request.html" aria-label="小程序中实现token过期重新登录再重新请求业务接口"><!--[--><!--[--><!--]--><!--]-->小程序中实现token过期重新登录再重新请求业务接口<!--[--><!--[--><!--]--><!--]--></a><!----></li><li><a class="route-link auto-link vp-sidebar-item" href="/note/web/wxApp/IntersectionObserver.html" aria-label="小程序中实现Observer监听元素进入视口"><!--[--><!--[--><!--]--><!--]-->小程序中实现Observer监听元素进入视口<!--[--><!--[--><!--]--><!--]--></a><!----></li><!--]--></ul></li><li><a class="route-link auto-link vp-sidebar-item vp-sidebar-heading collapsible" href="/note/web/debug/" aria-label="调试"><!--[--><!--[--><!--]--><!--]-->调试<!--[--><!--[--><span class="arrow right"></span><!--]--><!--]--></a><ul class="vp-sidebar-children" style="display:none;"><!--[--><li><a class="route-link auto-link vp-sidebar-item" href="/note/web/debug/%E5%BE%AE%E4%BF%A1%E5%85%AC%E4%BC%97%E5%8F%B7%E6%9C%AC%E5%9C%B0%E8%B0%83%E8%AF%95.html" aria-label="charles代理本地调试微信公众号"><!--[--><!--[--><!--]--><!--]-->charles代理本地调试微信公众号<!--[--><!--[--><!--]--><!--]--></a><!----></li><li><a class="route-link auto-link vp-sidebar-item" href="/note/web/debug/%E5%BE%AE%E4%BF%A1%E5%85%AC%E4%BC%97%E5%8F%B7%E6%9C%AC%E5%9C%B0%E5%A6%82%E4%BD%95%E8%B0%83%E8%AF%95.html" aria-label="微信公众号本地如何调试"><!--[--><!--[--><!--]--><!--]-->微信公众号本地如何调试<!--[--><!--[--><!--]--><!--]--></a><!----></li><!--]--></ul></li><li><a class="route-link auto-link vp-sidebar-item vp-sidebar-heading collapsible" href="/note/web/other/" aria-label="其他"><!--[--><!--[--><!--]--><!--]-->其他<!--[--><!--[--><span class="arrow right"></span><!--]--><!--]--></a><ul class="vp-sidebar-children" style="display:none;"><!--[--><li><a class="route-link auto-link vp-sidebar-item" href="/note/web/other/typora_picgo_gitee%E5%9B%BE%E5%BA%8A%E4%BD%BF%E7%94%A8%E6%95%99%E7%A8%8B.html" aria-label="typora+picgo+gitee图床使用教程"><!--[--><!--[--><!--]--><!--]-->typora+picgo+gitee图床使用教程<!--[--><!--[--><!--]--><!--]--></a><!----></li><!--]--></ul></li><!--]--></ul><!--[--><!--]--></aside><!--]--><!--[--><main class="vp-page"><!--[--><!--]--><div vp-content><!--[--><!--]--><div id="content"><h2 id="react-dom-diff之多节点" tabindex="-1"><a class="header-anchor" href="#react-dom-diff之多节点"><span>react Dom-diff之多节点</span></a></h2><p>react中DOM DIFF的三个规则</p><ul><li>只对同级元素进行比较，不同层级不比较</li><li>不同的类型对应不同的元素</li><li>可以通过key来标识同一个节点</li></ul><p>react中DOM DIFF的遍历规则</p><ul><li><p>第一轮</p><ul><li>如果key不同，则直接结束本轮循环</li><li>newChildren和oldFiber遍历完，结束本轮循环</li><li>key相同而type不同，标记老的oldFiber为删除，继续循环</li><li>key相同type相同，则可以复用老节点（oldFiber）,继续循环</li></ul></li><li><p>第二轮</p><ul><li>newChildren遍历完而oldFiber还有，遍历剩下的所有oldFiber标记为删除，DIFF结束</li><li>oldFiber遍历完了，而newChildren还有，将剩下的newChildren标记为插入，DIFF结束</li><li>newChildren和oldFiber都同时遍历完，DIFF结束</li><li>newChildren和oldFiber都没有完成，则进行节点移动的逻辑</li></ul></li><li><p>第三轮</p><ul><li>处理节点移动的情况</li></ul></li></ul><h3 id="多个节点的数量和key相同-有的type不同" tabindex="-1"><a class="header-anchor" href="#多个节点的数量和key相同-有的type不同"><span>多个节点的数量和key相同，有的type不同</span></a></h3><p><img src="https://gitee.com/yutao618/images/raw/master/images/20211215104611.png" alt=""></p><p>如上图所示，多个节点的数量和key相同，有的type不同。</p><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code class="language-javascript"><span class="line"><span class="token doc-comment comment">/**</span>
<span class="line"> * 如果新的虚拟DOM是一个数组的话， 也就是说有多个儿子的话</span>
<span class="line"> * <span class="token keyword">@param</span> <span class="token class-name"><span class="token punctuation">{</span><span class="token operator">*</span><span class="token punctuation">}</span></span> <span class="token parameter">returnFiber</span> ui</span>
<span class="line"> * <span class="token keyword">@param</span> <span class="token class-name"><span class="token punctuation">{</span><span class="token operator">*</span><span class="token punctuation">}</span></span> <span class="token parameter">currentFirstChild</span> null</span>
<span class="line"> * <span class="token keyword">@param</span> <span class="token class-name"><span class="token punctuation">{</span><span class="token operator">*</span><span class="token punctuation">}</span></span> <span class="token parameter">newChild</span> [liA,liB,liC]</span>
<span class="line"> */</span></span>
<span class="line"><span class="token keyword">function</span> <span class="token function">reconcileChildrenArray</span><span class="token punctuation">(</span><span class="token parameter">returnFiber<span class="token punctuation">,</span> currentFirstChild<span class="token punctuation">,</span> newChildren</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">  <span class="token comment">//将要返回的第一个新fiber</span></span>
<span class="line">  <span class="token keyword">let</span> resultingFirstChild <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span></span>
<span class="line">  <span class="token comment">//上一个新fiber</span></span>
<span class="line">  <span class="token keyword">let</span> previousNewFiber <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span></span>
<span class="line">  <span class="token comment">//当前的老fiber</span></span>
<span class="line">  <span class="token keyword">let</span> oldFiber <span class="token operator">=</span> currentFirstChild<span class="token punctuation">;</span></span>
<span class="line">  <span class="token comment">//新的虚拟DOM的索引</span></span>
<span class="line">  <span class="token keyword">let</span> newIdx <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span></span>
<span class="line">  <span class="token comment">// 如果没有老fiber,也就是初次挂载的时候</span></span>
<span class="line">  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>oldFiber<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token comment">// 循环虚拟DOM数组， 为每个虚拟DOM创建一个新的fiber</span></span>
<span class="line">    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token punctuation">;</span> newIdx <span class="token operator">&lt;</span> newChildren<span class="token punctuation">.</span>length<span class="token punctuation">;</span> newIdx<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">      <span class="token keyword">const</span> newFiber <span class="token operator">=</span> <span class="token function">createChild</span><span class="token punctuation">(</span>returnFiber<span class="token punctuation">,</span> newChildren<span class="token punctuation">[</span>newIdx<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//li(A) =&gt;li(B)=&gt; li(C)</span></span>
<span class="line">      <span class="token comment">// newFiber.flags = Placement</span></span>
<span class="line">      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>previousNewFiber<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        resultingFirstChild <span class="token operator">=</span> newFiber<span class="token punctuation">;</span><span class="token comment">//resultingFirstChild=&gt;li(A)</span></span>
<span class="line">      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span></span>
<span class="line">        previousNewFiber<span class="token punctuation">.</span>sibling <span class="token operator">=</span> newFiber<span class="token punctuation">;</span><span class="token comment">//liA.sibling=li(B) =&gt; liB.sibling=li(C)</span></span>
<span class="line">      <span class="token punctuation">}</span></span>
<span class="line">      previousNewFiber <span class="token operator">=</span> newFiber<span class="token punctuation">;</span><span class="token comment">//previousNewFiber=&gt;li(A)=&gt;li(B) =&gt; li(C)</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    <span class="token keyword">return</span> resultingFirstChild<span class="token punctuation">;</span></span>
<span class="line">  <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>这个是之前reconcileChildrenArray处理没有oldFiber的情况，现在做其他情况的处理</p><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code class="language-javascript"><span class="line"><span class="token keyword">function</span> <span class="token function">reconcileChildrenArray</span><span class="token punctuation">(</span><span class="token parameter">returnFiber<span class="token punctuation">,</span> currentFirstChild<span class="token punctuation">,</span> newChildren</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">  <span class="token comment">//将要返回的第一个新fiber</span></span>
<span class="line">  <span class="token keyword">let</span> resultingFirstChild <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span></span>
<span class="line">  <span class="token comment">//上一个新fiber</span></span>
<span class="line">  <span class="token keyword">let</span> previousNewFiber <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span></span>
<span class="line">  <span class="token comment">//当前的老fiber</span></span>
<span class="line">  <span class="token keyword">let</span> oldFiber <span class="token operator">=</span> currentFirstChild<span class="token punctuation">;</span></span>
<span class="line">  <span class="token comment">//新的虚拟DOM的索引</span></span>
<span class="line">  <span class="token keyword">let</span> newIdx <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span></span>
<span class="line">  </span>
<span class="line">  <span class="token comment">// +++++++++++++++++++++++++++++++++++++++++++++++++</span></span>
<span class="line">  </span>
<span class="line">  <span class="token comment">//下一个老fiber</span></span>
<span class="line">  <span class="token keyword">let</span> nextOldFiber <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span></span>
<span class="line">  <span class="token comment">//处理更新的情况 老fiber和新fiber都存在</span></span>
<span class="line">    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token punctuation">;</span> oldFiber <span class="token operator">&amp;&amp;</span> newIdx <span class="token operator">&lt;</span> newChildren<span class="token punctuation">.</span>length<span class="token punctuation">;</span> newIdx<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">      <span class="token comment">//先缓存下一个老fiber</span></span>
<span class="line">      nextOldFiber <span class="token operator">=</span> oldFiber<span class="token punctuation">.</span>sibling<span class="token punctuation">;</span></span>
<span class="line">      <span class="token comment">//试图复用老fiber</span></span>
<span class="line">      <span class="token keyword">const</span> newFiber <span class="token operator">=</span> <span class="token function">updateSlot</span><span class="token punctuation">(</span>returnFiber<span class="token punctuation">,</span> oldFiber<span class="token punctuation">,</span> newChildren<span class="token punctuation">[</span>newIdx<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">      <span class="token comment">//如果key 不一样，直接跳出第一轮循环</span></span>
<span class="line">      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>newFiber<span class="token punctuation">)</span></span>
<span class="line">        <span class="token keyword">break</span><span class="token punctuation">;</span> <span class="token comment">// 跳出第一轮循环</span></span>
<span class="line">      <span class="token comment">//老fiber存在，但是新的fiber并没有复用老fiber</span></span>
<span class="line">      <span class="token keyword">if</span> <span class="token punctuation">(</span>oldFiber <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>newFiber<span class="token punctuation">.</span>alternate<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token function">deleteChild</span><span class="token punctuation">(</span>returnFiber<span class="token punctuation">,</span> oldFiber<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">      <span class="token punctuation">}</span></span>
<span class="line">      <span class="token comment">//核心是给当前的newFiber添加一个副作用flags 叫新增</span></span>
<span class="line">      <span class="token function">placeChild</span><span class="token punctuation">(</span>newFiber<span class="token punctuation">,</span> lastPlacedIndex<span class="token punctuation">,</span> newIdx<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>previousNewFiber<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        resultingFirstChild <span class="token operator">=</span> newFiber<span class="token punctuation">;</span></span>
<span class="line">      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span></span>
<span class="line">        previousNewFiber<span class="token punctuation">.</span>sibling <span class="token operator">=</span> newFiber<span class="token punctuation">;</span></span>
<span class="line">      <span class="token punctuation">}</span></span>
<span class="line">      previousNewFiber <span class="token operator">=</span> newFiber<span class="token punctuation">;</span></span>
<span class="line">      oldFiber <span class="token operator">=</span> nextOldFiber<span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">  </span>
<span class="line">  <span class="token comment">// +++++++++++++++++++++++++++++++++++++++++++++++++</span></span>
<span class="line">  </span>
<span class="line">  <span class="token comment">// 如果没有老fiber,也就是初次挂载的时候</span></span>
<span class="line">  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>oldFiber<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token comment">// 循环虚拟DOM数组， 为每个虚拟DOM创建一个新的fiber</span></span>
<span class="line">    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token punctuation">;</span> newIdx <span class="token operator">&lt;</span> newChildren<span class="token punctuation">.</span>length<span class="token punctuation">;</span> newIdx<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">      <span class="token keyword">const</span> newFiber <span class="token operator">=</span> <span class="token function">createChild</span><span class="token punctuation">(</span>returnFiber<span class="token punctuation">,</span> newChildren<span class="token punctuation">[</span>newIdx<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//li(A) =&gt;li(B)=&gt; li(C)</span></span>
<span class="line">      <span class="token comment">// newFiber.flags = Placement</span></span>
<span class="line">      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>previousNewFiber<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        resultingFirstChild <span class="token operator">=</span> newFiber<span class="token punctuation">;</span><span class="token comment">//resultingFirstChild=&gt;li(A)</span></span>
<span class="line">      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span></span>
<span class="line">        previousNewFiber<span class="token punctuation">.</span>sibling <span class="token operator">=</span> newFiber<span class="token punctuation">;</span><span class="token comment">//liA.sibling=li(B) =&gt; liB.sibling=li(C)</span></span>
<span class="line">      <span class="token punctuation">}</span></span>
<span class="line">      previousNewFiber <span class="token operator">=</span> newFiber<span class="token punctuation">;</span><span class="token comment">//previousNewFiber=&gt;li(A)=&gt;li(B) =&gt; li(C)</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    <span class="token keyword">return</span> resultingFirstChild<span class="token punctuation">;</span></span>
<span class="line">  <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>updateSlot试图复用老fiber</p><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code class="language-javascript"><span class="line"><span class="token keyword">function</span> <span class="token function">updateSlot</span><span class="token punctuation">(</span><span class="token parameter">returnFiber<span class="token punctuation">,</span> oldFiber<span class="token punctuation">,</span> newChild</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">  <span class="token keyword">const</span> key <span class="token operator">=</span> oldFiber <span class="token operator">?</span> oldFiber<span class="token punctuation">.</span>key <span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">;</span></span>
<span class="line">  <span class="token comment">//如果新的虚拟DOM的key和老fiber的key一样</span></span>
<span class="line">  <span class="token keyword">if</span> <span class="token punctuation">(</span>newChild<span class="token punctuation">.</span>key <span class="token operator">===</span> key<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">return</span> <span class="token function">updateElement</span><span class="token punctuation">(</span>returnFiber<span class="token punctuation">,</span> oldFiber<span class="token punctuation">,</span> newChild<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token comment">//如果key不一样，直接结束返回null</span></span>
<span class="line">    <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span></span>
<span class="line">  <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>更新元素</p><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code class="language-javascript"><span class="line"><span class="token keyword">function</span> <span class="token function">updateElement</span><span class="token punctuation">(</span><span class="token parameter">returnFiber<span class="token punctuation">,</span> oldFiber<span class="token punctuation">,</span> newChild</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">  <span class="token keyword">if</span> <span class="token punctuation">(</span>oldFiber<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">if</span> <span class="token punctuation">(</span>oldFiber<span class="token punctuation">.</span>type <span class="token operator">===</span> newChild<span class="token punctuation">.</span>type<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">      <span class="token keyword">const</span> existing <span class="token operator">=</span> <span class="token function">useFiber</span><span class="token punctuation">(</span>oldFiber<span class="token punctuation">,</span> newChild<span class="token punctuation">.</span>props<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">      existing<span class="token punctuation">.</span>return <span class="token operator">=</span> returnFiber<span class="token punctuation">;</span></span>
<span class="line">      <span class="token keyword">return</span> existing<span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">  <span class="token punctuation">}</span></span>
<span class="line">  <span class="token comment">//如果没有老fiber</span></span>
<span class="line">  <span class="token keyword">const</span> created <span class="token operator">=</span> <span class="token function">createFiberFromElement</span><span class="token punctuation">(</span>newChild<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">  created<span class="token punctuation">.</span>return <span class="token operator">=</span> returnFiber<span class="token punctuation">;</span></span>
<span class="line">  <span class="token keyword">return</span> created<span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code class="language-javascript"><span class="line"><span class="token keyword">function</span> <span class="token function">placeChild</span><span class="token punctuation">(</span><span class="token parameter">newFiber<span class="token punctuation">,</span> lastPlacedIndex<span class="token punctuation">,</span> newIdx</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">  newFiber<span class="token punctuation">.</span>index <span class="token operator">=</span> newIdx<span class="token punctuation">;</span></span>
<span class="line">  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>shouldTrackSideEffects<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">return</span><span class="token punctuation">;</span></span>
<span class="line">  <span class="token punctuation">}</span></span>
<span class="line">  <span class="token keyword">const</span> current <span class="token operator">=</span> newFiber<span class="token punctuation">.</span>alternate<span class="token punctuation">;</span></span>
<span class="line">  <span class="token comment">//如果有current说是更新，复用老节点的更新，不会添加Placement</span></span>
<span class="line">  <span class="token keyword">if</span> <span class="token punctuation">(</span>current<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token comment">// TODO</span></span>
<span class="line">  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span></span>
<span class="line">    newFiber<span class="token punctuation">.</span>flags <span class="token operator">=</span> Placement<span class="token punctuation">;</span></span>
<span class="line">  <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>目前完整的reconcileChildrenArray代码逻辑如下，加了老fiber和新fiber都存在的处理逻辑，按照li(A),li(B),li(C)到li(A),p(B),li(C)的更新逻辑，li(A)通过updateSlot的处理，是可以复用的，updateElement就是处理更新或者创建fiber;li(B)的时候updateSlot返回了新创建的p(B)，并且需要删除li(B),oldFiber &amp;&amp; !newFiber.alternate这种情况就符合了li(B)的情况，placeChild就是把p(B)标记为插入；li(C)的情况和li(A)一样。</p><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code class="language-javascript"><span class="line"><span class="token keyword">function</span> <span class="token function">reconcileChildrenArray</span><span class="token punctuation">(</span><span class="token parameter">returnFiber<span class="token punctuation">,</span> currentFirstChild<span class="token punctuation">,</span> newChildren</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">  <span class="token comment">//将要返回的第一个新fiber</span></span>
<span class="line">  <span class="token keyword">let</span> resultingFirstChild <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span></span>
<span class="line">  <span class="token comment">//上一个新fiber</span></span>
<span class="line">  <span class="token keyword">let</span> previousNewFiber <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span></span>
<span class="line">  <span class="token comment">//当前的老fiber</span></span>
<span class="line">  <span class="token keyword">let</span> oldFiber <span class="token operator">=</span> currentFirstChild<span class="token punctuation">;</span></span>
<span class="line">  <span class="token comment">//新的虚拟DOM的索引</span></span>
<span class="line">  <span class="token keyword">let</span> newIdx <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span></span>
<span class="line">  <span class="token comment">// 下一个老fiber</span></span>
<span class="line">  <span class="token keyword">let</span> nextOldFiber <span class="token operator">=</span> <span class="token keyword">null</span></span>
<span class="line">  <span class="token comment">//处理更新的情况 老fiber和新fiber都存在</span></span>
<span class="line">  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token punctuation">;</span> oldFiber <span class="token operator">&amp;&amp;</span> newIdx <span class="token operator">&lt;</span> newChildren<span class="token punctuation">.</span>length<span class="token punctuation">;</span> newIdx<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token comment">//先缓存下一个老fiber</span></span>
<span class="line">    nextOldFiber <span class="token operator">=</span> oldFiber<span class="token punctuation">.</span>sibling<span class="token punctuation">;</span></span>
<span class="line">    <span class="token comment">//试图复用才fiber</span></span>
<span class="line">    <span class="token keyword">const</span> newFiber <span class="token operator">=</span> <span class="token function">updateSlot</span><span class="token punctuation">(</span>returnFiber<span class="token punctuation">,</span> oldFiber<span class="token punctuation">,</span> newChildren<span class="token punctuation">[</span>newIdx<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token comment">//如果key 不一样，直接跳出第一轮循环</span></span>
<span class="line">    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>newFiber<span class="token punctuation">)</span></span>
<span class="line">      <span class="token keyword">break</span><span class="token punctuation">;</span> <span class="token comment">//跳出第一轮循环</span></span>
<span class="line">    <span class="token comment">//老fiber存在，但是新的fiber并没有复用老fiber</span></span>
<span class="line">    <span class="token keyword">if</span> <span class="token punctuation">(</span>oldFiber <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>newFiber<span class="token punctuation">.</span>alternate<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">      <span class="token function">deleteChild</span><span class="token punctuation">(</span>returnFiber<span class="token punctuation">,</span> oldFiber<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    <span class="token comment">//核心是给当前的newFiber添加一个副作用flags 叫新增</span></span>
<span class="line">    <span class="token function">placeChild</span><span class="token punctuation">(</span>newFiber<span class="token punctuation">,</span>newIdx<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>previousNewFiber<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">      resultingFirstChild <span class="token operator">=</span> newFiber<span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span></span>
<span class="line">      previousNewFiber<span class="token punctuation">.</span>sibling <span class="token operator">=</span> newFiber<span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    previousNewFiber <span class="token operator">=</span> newFiber<span class="token punctuation">;</span></span>
<span class="line">    oldFiber <span class="token operator">=</span> nextOldFiber<span class="token punctuation">;</span></span>
<span class="line">  <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">  <span class="token comment">// 如果没有老fiber,也就是初次挂载的时候</span></span>
<span class="line">  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>oldFiber<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token comment">// 循环虚拟DOM数组， 为每个虚拟DOM创建一个新的fiber</span></span>
<span class="line">    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token punctuation">;</span> newIdx <span class="token operator">&lt;</span> newChildren<span class="token punctuation">.</span>length<span class="token punctuation">;</span> newIdx<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">      <span class="token keyword">const</span> newFiber <span class="token operator">=</span> <span class="token function">createChild</span><span class="token punctuation">(</span>returnFiber<span class="token punctuation">,</span> newChildren<span class="token punctuation">[</span>newIdx<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//li(A) =&gt;li(B)=&gt; li(C)</span></span>
<span class="line">      <span class="token comment">// newFiber.flags = Placement</span></span>
<span class="line">      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>previousNewFiber<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        resultingFirstChild <span class="token operator">=</span> newFiber<span class="token punctuation">;</span><span class="token comment">//resultingFirstChild=&gt;li(A)</span></span>
<span class="line">      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span></span>
<span class="line">        previousNewFiber<span class="token punctuation">.</span>sibling <span class="token operator">=</span> newFiber<span class="token punctuation">;</span><span class="token comment">//liA.sibling=li(B) =&gt; liB.sibling=li(C)</span></span>
<span class="line">      <span class="token punctuation">}</span></span>
<span class="line">      previousNewFiber <span class="token operator">=</span> newFiber<span class="token punctuation">;</span><span class="token comment">//previousNewFiber=&gt;li(A)=&gt;li(B) =&gt; li(C)</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    <span class="token keyword">return</span> resultingFirstChild<span class="token punctuation">;</span></span>
<span class="line">  <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>来简单测试下：</p><div class="language-html line-numbers-mode" data-highlighter="prismjs" data-ext="html"><pre><code class="language-html"><span class="line"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>button</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>multi1<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>5.多个节点的数量和key相同，有的type不同<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>button</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>br</span><span class="token punctuation">/&gt;</span></span></span>
<span class="line">  <span class="token entity named-entity" title="&lt;">&amp;lt;</span>ul key=<span class="token entity named-entity" title="&quot;">&amp;quot;</span>ul<span class="token entity named-entity" title="&quot;">&amp;quot;</span><span class="token entity named-entity" title="&gt;">&amp;gt;</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>br</span><span class="token punctuation">/&gt;</span></span></span>
<span class="line">  <span class="token entity named-entity" title=" ">&amp;nbsp;</span><span class="token entity named-entity" title=" ">&amp;nbsp;</span><span class="token entity named-entity" title="&lt;">&amp;lt;</span>li key=<span class="token entity named-entity" title="&quot;">&amp;quot;</span>A<span class="token entity named-entity" title="&quot;">&amp;quot;</span><span class="token entity named-entity" title="&gt;">&amp;gt;</span>A<span class="token entity named-entity" title="&lt;">&amp;lt;</span>/li<span class="token entity named-entity" title="&gt;">&amp;gt;</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>br</span><span class="token punctuation">/&gt;</span></span></span>
<span class="line">  <span class="token entity named-entity" title=" ">&amp;nbsp;</span><span class="token entity named-entity" title=" ">&amp;nbsp;</span><span class="token entity named-entity" title="&lt;">&amp;lt;</span>li key=<span class="token entity named-entity" title="&quot;">&amp;quot;</span>B<span class="token entity named-entity" title="&quot;">&amp;quot;</span> id=<span class="token entity named-entity" title="&quot;">&amp;quot;</span>B<span class="token entity named-entity" title="&quot;">&amp;quot;</span><span class="token entity named-entity" title="&gt;">&amp;gt;</span>B<span class="token entity named-entity" title="&lt;">&amp;lt;</span>/li<span class="token entity named-entity" title="&gt;">&amp;gt;</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>br</span><span class="token punctuation">/&gt;</span></span></span>
<span class="line">  <span class="token entity named-entity" title=" ">&amp;nbsp;</span><span class="token entity named-entity" title=" ">&amp;nbsp;</span><span class="token entity named-entity" title="&lt;">&amp;lt;</span>li key=<span class="token entity named-entity" title="&quot;">&amp;quot;</span>C<span class="token entity named-entity" title="&quot;">&amp;quot;</span>id=<span class="token entity named-entity" title="&quot;">&amp;quot;</span>C<span class="token entity named-entity" title="&quot;">&amp;quot;</span><span class="token entity named-entity" title="&gt;">&amp;gt;</span>C<span class="token entity named-entity" title="&lt;">&amp;lt;</span>/li<span class="token entity named-entity" title="&gt;">&amp;gt;</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>br</span><span class="token punctuation">/&gt;</span></span></span>
<span class="line">  <span class="token entity named-entity" title="&lt;">&amp;lt;</span>/ul<span class="token entity named-entity" title="&gt;">&amp;gt;</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>br</span><span class="token punctuation">/&gt;</span></span></span>
<span class="line">  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>button</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>multi1Update<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>更新属性，type不同的删除老节点，删除新节点<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>button</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>br</span><span class="token punctuation">/&gt;</span></span></span>
<span class="line">  <span class="token entity named-entity" title="&lt;">&amp;lt;</span>ul key=<span class="token entity named-entity" title="&quot;">&amp;quot;</span>ul<span class="token entity named-entity" title="&quot;">&amp;quot;</span><span class="token entity named-entity" title="&gt;">&amp;gt;</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>br</span><span class="token punctuation">/&gt;</span></span></span>
<span class="line">  <span class="token entity named-entity" title=" ">&amp;nbsp;</span><span class="token entity named-entity" title=" ">&amp;nbsp;</span><span class="token entity named-entity" title="&lt;">&amp;lt;</span>li key=<span class="token entity named-entity" title="&quot;">&amp;quot;</span>A<span class="token entity named-entity" title="&quot;">&amp;quot;</span><span class="token entity named-entity" title="&gt;">&amp;gt;</span>A<span class="token entity named-entity" title="&lt;">&amp;lt;</span>/li<span class="token entity named-entity" title="&gt;">&amp;gt;</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>br</span><span class="token punctuation">/&gt;</span></span></span>
<span class="line">  <span class="token entity named-entity" title=" ">&amp;nbsp;</span><span class="token entity named-entity" title=" ">&amp;nbsp;</span><span class="token entity named-entity" title="&lt;">&amp;lt;</span>p key=<span class="token entity named-entity" title="&quot;">&amp;quot;</span>B<span class="token entity named-entity" title="&quot;">&amp;quot;</span> id=<span class="token entity named-entity" title="&quot;">&amp;quot;</span>B2<span class="token entity named-entity" title="&quot;">&amp;quot;</span><span class="token entity named-entity" title="&gt;">&amp;gt;</span>B2<span class="token entity named-entity" title="&lt;">&amp;lt;</span>/p<span class="token entity named-entity" title="&gt;">&amp;gt;</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>br</span><span class="token punctuation">/&gt;</span></span></span>
<span class="line">  <span class="token entity named-entity" title=" ">&amp;nbsp;</span><span class="token entity named-entity" title=" ">&amp;nbsp;</span><span class="token entity named-entity" title="&lt;">&amp;lt;</span>li key=<span class="token entity named-entity" title="&quot;">&amp;quot;</span>C<span class="token entity named-entity" title="&quot;">&amp;quot;</span> id=<span class="token entity named-entity" title="&quot;">&amp;quot;</span>C2<span class="token entity named-entity" title="&quot;">&amp;quot;</span> <span class="token entity named-entity" title="&gt;">&amp;gt;</span>C2<span class="token entity named-entity" title="&lt;">&amp;lt;</span>/li<span class="token entity named-entity" title="&gt;">&amp;gt;</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>br</span><span class="token punctuation">/&gt;</span></span></span>
<span class="line">  <span class="token entity named-entity" title="&lt;">&amp;lt;</span>/ul<span class="token entity named-entity" title="&gt;">&amp;gt;</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>br</span><span class="token punctuation">/&gt;</span></span></span>
<span class="line"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span></span>
<span class="line"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>hr</span><span class="token punctuation">/&gt;</span></span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code class="language-javascript"><span class="line">multi1<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">&#39;click&#39;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></span>
<span class="line">  <span class="token keyword">let</span> element <span class="token operator">=</span> <span class="token punctuation">(</span></span>
<span class="line">    <span class="token operator">&lt;</span>ul key<span class="token operator">=</span><span class="token string">&quot;ul&quot;</span><span class="token operator">&gt;</span></span>
<span class="line">      <span class="token operator">&lt;</span>li key<span class="token operator">=</span><span class="token string">&quot;A&quot;</span><span class="token operator">&gt;</span><span class="token constant">A</span><span class="token operator">&lt;</span><span class="token operator">/</span>li<span class="token operator">&gt;</span></span>
<span class="line">      <span class="token operator">&lt;</span>li key<span class="token operator">=</span><span class="token string">&quot;B&quot;</span> id<span class="token operator">=</span><span class="token string">&quot;B&quot;</span><span class="token operator">&gt;</span><span class="token constant">B</span><span class="token operator">&lt;</span><span class="token operator">/</span>li<span class="token operator">&gt;</span></span>
<span class="line">      <span class="token operator">&lt;</span>li key<span class="token operator">=</span><span class="token string">&quot;C&quot;</span> id<span class="token operator">=</span><span class="token string">&quot;C&quot;</span><span class="token operator">&gt;</span><span class="token constant">C</span><span class="token operator">&lt;</span><span class="token operator">/</span>li<span class="token operator">&gt;</span></span>
<span class="line">    <span class="token operator">&lt;</span><span class="token operator">/</span>ul<span class="token operator">&gt;</span></span>
<span class="line">  <span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">  ReactDOM<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span>element<span class="token punctuation">,</span> root<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">multi1Update<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">&#39;click&#39;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></span>
<span class="line">  <span class="token keyword">let</span> element <span class="token operator">=</span> <span class="token punctuation">(</span></span>
<span class="line">    <span class="token operator">&lt;</span>ul key<span class="token operator">=</span><span class="token string">&quot;ul&quot;</span><span class="token operator">&gt;</span></span>
<span class="line">      <span class="token operator">&lt;</span>li key<span class="token operator">=</span><span class="token string">&quot;A&quot;</span><span class="token operator">&gt;</span><span class="token constant">A</span><span class="token operator">&lt;</span><span class="token operator">/</span>li<span class="token operator">&gt;</span></span>
<span class="line">      <span class="token operator">&lt;</span>p key<span class="token operator">=</span><span class="token string">&quot;B&quot;</span> id<span class="token operator">=</span><span class="token string">&quot;B2&quot;</span><span class="token operator">&gt;</span><span class="token constant">B2</span><span class="token operator">&lt;</span><span class="token operator">/</span>p<span class="token operator">&gt;</span></span>
<span class="line">      <span class="token operator">&lt;</span>li key<span class="token operator">=</span><span class="token string">&quot;C&quot;</span> id<span class="token operator">=</span><span class="token string">&quot;C2&quot;</span><span class="token operator">&gt;</span><span class="token constant">C2</span><span class="token operator">&lt;</span><span class="token operator">/</span>li<span class="token operator">&gt;</span></span>
<span class="line">    <span class="token operator">&lt;</span><span class="token operator">/</span>ul<span class="token operator">&gt;</span></span>
<span class="line">  <span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">  ReactDOM<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span>element<span class="token punctuation">,</span> root<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><img src="https://gitee.com/yutao618/images/raw/master/images/20211215144251.png" alt=""></p><p><img src="https://gitee.com/yutao618/images/raw/master/images/20211215144417.png" alt=""></p><p>可以看到搜集的effectList是正确的，但实际上DOM插入的顺序不太对，是因为在之前提交的时候，也就是commitWork阶段commitPlacement插入节点的时候有问题，看原来代码如下：</p><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code class="language-javascript"><span class="line"><span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">commitPlacement</span><span class="token punctuation">(</span><span class="token parameter">nextEffect</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">  <span class="token keyword">let</span> stateNode <span class="token operator">=</span> nextEffect<span class="token punctuation">.</span>stateNode<span class="token punctuation">;</span></span>
<span class="line">  <span class="token keyword">let</span> parentStateNode <span class="token operator">=</span> <span class="token function">getParentStateNode</span><span class="token punctuation">(</span>nextEffect<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">  <span class="token function">appendChild</span><span class="token punctuation">(</span>parentStateNode<span class="token punctuation">,</span> stateNode<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>问题就是出在appendChild的这个时候，做下调整：</p><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code class="language-javascript"><span class="line"><span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">commitPlacement</span><span class="token punctuation">(</span><span class="token parameter">nextEffect</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">  <span class="token keyword">let</span> stateNode <span class="token operator">=</span> nextEffect<span class="token punctuation">.</span>stateNode<span class="token punctuation">;</span></span>
<span class="line">  <span class="token keyword">let</span> parentStateNode <span class="token operator">=</span> <span class="token function">getParentStateNode</span><span class="token punctuation">(</span>nextEffect<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">  <span class="token function">appendChild</span><span class="token punctuation">(</span>parentStateNode<span class="token punctuation">,</span> stateNode<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">  <span class="token keyword">let</span> before <span class="token operator">=</span> <span class="token function">getHostSibling</span><span class="token punctuation">(</span>nextEffect<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">  <span class="token keyword">if</span> <span class="token punctuation">(</span>before<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token function">insertBefore</span><span class="token punctuation">(</span>parentStateNode<span class="token punctuation">,</span> stateNode<span class="token punctuation">,</span> before<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token function">appendChild</span><span class="token punctuation">(</span>parentStateNode<span class="token punctuation">,</span> stateNode<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">  <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code class="language-javascript"><span class="line"><span class="token comment">//当前fiber后面一个离它最近的真实的DOM节点</span></span>
<span class="line"><span class="token keyword">function</span> <span class="token function">getHostSibling</span><span class="token punctuation">(</span><span class="token parameter">fiber</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">  <span class="token keyword">let</span> node <span class="token operator">=</span> fiber<span class="token punctuation">.</span>sibling<span class="token punctuation">;</span></span>
<span class="line">  <span class="token keyword">while</span> <span class="token punctuation">(</span>node<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token comment">//找它的弟弟们，找到最近一个并且不是插入的节点，返回。。没有更新，更新</span></span>
<span class="line">    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token punctuation">(</span> node<span class="token punctuation">.</span>flags <span class="token operator">&amp;</span> Placement <span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">      <span class="token keyword">return</span> node<span class="token punctuation">.</span>stateNode<span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    node <span class="token operator">=</span> node<span class="token punctuation">.</span>sibling<span class="token punctuation">;</span></span>
<span class="line">  <span class="token punctuation">}</span></span>
<span class="line">  <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code class="language-javascript"><span class="line"><span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">insertBefore</span><span class="token punctuation">(</span><span class="token parameter">parentInstance<span class="token punctuation">,</span> child<span class="token punctuation">,</span> before</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">  parentInstance<span class="token punctuation">.</span><span class="token function">insertBefore</span><span class="token punctuation">(</span>child<span class="token punctuation">,</span> before<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>再来测试下：</p><p><img src="https://gitee.com/yutao618/images/raw/master/images/20211215145208.png" alt=""></p><p>可以看到effectList和DOM都是正确的。</p><h3 id="多个节点的类型和key全部相同-有新增元素" tabindex="-1"><a class="header-anchor" href="#多个节点的类型和key全部相同-有新增元素"><span>多个节点的类型和key全部相同，有新增元素</span></a></h3><div class="language-html line-numbers-mode" data-highlighter="prismjs" data-ext="html"><pre><code class="language-html"><span class="line"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>button</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>multi2<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>6.多个节点的类型和key全部相同，有新增元素<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>button</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>br</span><span class="token punctuation">/&gt;</span></span></span>
<span class="line">  <span class="token entity named-entity" title="&lt;">&amp;lt;</span>ul key=<span class="token entity named-entity" title="&quot;">&amp;quot;</span>ul<span class="token entity named-entity" title="&quot;">&amp;quot;</span><span class="token entity named-entity" title="&gt;">&amp;gt;</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>br</span><span class="token punctuation">/&gt;</span></span></span>
<span class="line">  <span class="token entity named-entity" title=" ">&amp;nbsp;</span><span class="token entity named-entity" title=" ">&amp;nbsp;</span><span class="token entity named-entity" title="&lt;">&amp;lt;</span>li key=<span class="token entity named-entity" title="&quot;">&amp;quot;</span>A<span class="token entity named-entity" title="&quot;">&amp;quot;</span><span class="token entity named-entity" title="&gt;">&amp;gt;</span>A<span class="token entity named-entity" title="&lt;">&amp;lt;</span>/li<span class="token entity named-entity" title="&gt;">&amp;gt;</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>br</span><span class="token punctuation">/&gt;</span></span></span>
<span class="line">  <span class="token entity named-entity" title=" ">&amp;nbsp;</span><span class="token entity named-entity" title=" ">&amp;nbsp;</span><span class="token entity named-entity" title="&lt;">&amp;lt;</span>li key=<span class="token entity named-entity" title="&quot;">&amp;quot;</span>B<span class="token entity named-entity" title="&quot;">&amp;quot;</span> id=<span class="token entity named-entity" title="&quot;">&amp;quot;</span>B<span class="token entity named-entity" title="&quot;">&amp;quot;</span><span class="token entity named-entity" title="&gt;">&amp;gt;</span>B<span class="token entity named-entity" title="&lt;">&amp;lt;</span>/li<span class="token entity named-entity" title="&gt;">&amp;gt;</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>br</span><span class="token punctuation">/&gt;</span></span></span>
<span class="line">  <span class="token entity named-entity" title=" ">&amp;nbsp;</span><span class="token entity named-entity" title=" ">&amp;nbsp;</span><span class="token entity named-entity" title="&lt;">&amp;lt;</span>li key=<span class="token entity named-entity" title="&quot;">&amp;quot;</span>C<span class="token entity named-entity" title="&quot;">&amp;quot;</span><span class="token entity named-entity" title="&gt;">&amp;gt;</span>C<span class="token entity named-entity" title="&lt;">&amp;lt;</span>/li<span class="token entity named-entity" title="&gt;">&amp;gt;</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>br</span><span class="token punctuation">/&gt;</span></span></span>
<span class="line">  <span class="token entity named-entity" title="&lt;">&amp;lt;</span>/ul<span class="token entity named-entity" title="&gt;">&amp;gt;</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>br</span><span class="token punctuation">/&gt;</span></span></span>
<span class="line">  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>button</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>multi2Update<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>增加新元素并更新老元素<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>button</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>br</span><span class="token punctuation">/&gt;</span></span></span>
<span class="line">  <span class="token entity named-entity" title="&lt;">&amp;lt;</span>ul key=<span class="token entity named-entity" title="&quot;">&amp;quot;</span>ul<span class="token entity named-entity" title="&quot;">&amp;quot;</span><span class="token entity named-entity" title="&gt;">&amp;gt;</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>br</span><span class="token punctuation">/&gt;</span></span></span>
<span class="line">  <span class="token entity named-entity" title=" ">&amp;nbsp;</span><span class="token entity named-entity" title=" ">&amp;nbsp;</span><span class="token entity named-entity" title="&lt;">&amp;lt;</span>li key=<span class="token entity named-entity" title="&quot;">&amp;quot;</span>A<span class="token entity named-entity" title="&quot;">&amp;quot;</span><span class="token entity named-entity" title="&gt;">&amp;gt;</span>A<span class="token entity named-entity" title="&lt;">&amp;lt;</span>/li<span class="token entity named-entity" title="&gt;">&amp;gt;</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>br</span><span class="token punctuation">/&gt;</span></span></span>
<span class="line">  <span class="token entity named-entity" title=" ">&amp;nbsp;</span><span class="token entity named-entity" title=" ">&amp;nbsp;</span><span class="token entity named-entity" title="&lt;">&amp;lt;</span>li key=<span class="token entity named-entity" title="&quot;">&amp;quot;</span>B<span class="token entity named-entity" title="&quot;">&amp;quot;</span> id=<span class="token entity named-entity" title="&quot;">&amp;quot;</span>B2<span class="token entity named-entity" title="&quot;">&amp;quot;</span><span class="token entity named-entity" title="&gt;">&amp;gt;</span>B2<span class="token entity named-entity" title="&lt;">&amp;lt;</span>/li<span class="token entity named-entity" title="&gt;">&amp;gt;</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>br</span><span class="token punctuation">/&gt;</span></span></span>
<span class="line">  <span class="token entity named-entity" title=" ">&amp;nbsp;</span><span class="token entity named-entity" title=" ">&amp;nbsp;</span><span class="token entity named-entity" title="&lt;">&amp;lt;</span>li key=<span class="token entity named-entity" title="&quot;">&amp;quot;</span>C<span class="token entity named-entity" title="&quot;">&amp;quot;</span><span class="token entity named-entity" title="&gt;">&amp;gt;</span>C<span class="token entity named-entity" title="&lt;">&amp;lt;</span>/li<span class="token entity named-entity" title="&gt;">&amp;gt;</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>br</span><span class="token punctuation">/&gt;</span></span></span>
<span class="line">  <span class="token entity named-entity" title=" ">&amp;nbsp;</span><span class="token entity named-entity" title=" ">&amp;nbsp;</span><span class="token entity named-entity" title="&lt;">&amp;lt;</span>li key=<span class="token entity named-entity" title="&quot;">&amp;quot;</span>D<span class="token entity named-entity" title="&quot;">&amp;quot;</span><span class="token entity named-entity" title="&gt;">&amp;gt;</span>D<span class="token entity named-entity" title="&lt;">&amp;lt;</span>/li<span class="token entity named-entity" title="&gt;">&amp;gt;</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>br</span><span class="token punctuation">/&gt;</span></span></span>
<span class="line">  <span class="token entity named-entity" title="&lt;">&amp;lt;</span>/ul<span class="token entity named-entity" title="&gt;">&amp;gt;</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>br</span><span class="token punctuation">/&gt;</span></span></span>
<span class="line"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span></span>
<span class="line"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>hr</span><span class="token punctuation">/&gt;</span></span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code class="language-javascript"><span class="line">multi2<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">&#39;click&#39;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></span>
<span class="line">  <span class="token keyword">let</span> element <span class="token operator">=</span> <span class="token punctuation">(</span></span>
<span class="line">    <span class="token operator">&lt;</span>ul key<span class="token operator">=</span><span class="token string">&quot;ul&quot;</span><span class="token operator">&gt;</span></span>
<span class="line">      <span class="token operator">&lt;</span>li key<span class="token operator">=</span><span class="token string">&quot;A&quot;</span><span class="token operator">&gt;</span><span class="token constant">A</span><span class="token operator">&lt;</span><span class="token operator">/</span>li<span class="token operator">&gt;</span></span>
<span class="line">      <span class="token operator">&lt;</span>li key<span class="token operator">=</span><span class="token string">&quot;B&quot;</span> id<span class="token operator">=</span><span class="token string">&quot;B&quot;</span><span class="token operator">&gt;</span><span class="token constant">B</span><span class="token operator">&lt;</span><span class="token operator">/</span>li<span class="token operator">&gt;</span></span>
<span class="line">      <span class="token operator">&lt;</span>li key<span class="token operator">=</span><span class="token string">&quot;C&quot;</span><span class="token operator">&gt;</span><span class="token constant">C</span><span class="token operator">&lt;</span><span class="token operator">/</span>li<span class="token operator">&gt;</span></span>
<span class="line">    <span class="token operator">&lt;</span><span class="token operator">/</span>ul<span class="token operator">&gt;</span></span>
<span class="line">  <span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">  ReactDOM<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span>element<span class="token punctuation">,</span> root<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token comment">//增加新元素并更新老元素</span></span>
<span class="line">multi2Update<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">&#39;click&#39;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></span>
<span class="line">  <span class="token keyword">let</span> element <span class="token operator">=</span> <span class="token punctuation">(</span></span>
<span class="line">    <span class="token operator">&lt;</span>ul key<span class="token operator">=</span><span class="token string">&quot;ul&quot;</span><span class="token operator">&gt;</span></span>
<span class="line">      <span class="token operator">&lt;</span>li key<span class="token operator">=</span><span class="token string">&quot;A&quot;</span><span class="token operator">&gt;</span><span class="token constant">A</span><span class="token operator">&lt;</span><span class="token operator">/</span>li<span class="token operator">&gt;</span></span>
<span class="line">      <span class="token operator">&lt;</span>li key<span class="token operator">=</span><span class="token string">&quot;B&quot;</span> id<span class="token operator">=</span><span class="token string">&quot;B2&quot;</span><span class="token operator">&gt;</span><span class="token constant">B2</span><span class="token operator">&lt;</span><span class="token operator">/</span>li<span class="token operator">&gt;</span></span>
<span class="line">      <span class="token operator">&lt;</span>li key<span class="token operator">=</span><span class="token string">&quot;C&quot;</span><span class="token operator">&gt;</span><span class="token constant">C</span><span class="token operator">&lt;</span><span class="token operator">/</span>li<span class="token operator">&gt;</span></span>
<span class="line">      <span class="token operator">&lt;</span>li key<span class="token operator">=</span><span class="token string">&quot;D&quot;</span><span class="token operator">&gt;</span><span class="token constant">D</span><span class="token operator">&lt;</span><span class="token operator">/</span>li<span class="token operator">&gt;</span></span>
<span class="line">    <span class="token operator">&lt;</span><span class="token operator">/</span>ul<span class="token operator">&gt;</span></span>
<span class="line">  <span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">  ReactDOM<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span>element<span class="token punctuation">,</span> root<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><img src="https://gitee.com/yutao618/images/raw/master/images/20211215150150.png" alt=""></p><p>对于这种情况，就说明oldFiber没有了，新的fiber还有，就会走到if(!oldFiber)的分支去，在里面放置下新fiber就可以了，具体代码就是加一行placeChild(newFiber, newIdx)。</p><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code class="language-javascript"><span class="line"><span class="token keyword">function</span> <span class="token function">reconcileChildrenArray</span><span class="token punctuation">(</span><span class="token parameter">returnFiber<span class="token punctuation">,</span> currentFirstChild<span class="token punctuation">,</span> newChildren</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">  <span class="token comment">//将要返回的第一个新fiber</span></span>
<span class="line">  <span class="token keyword">let</span> resultingFirstChild <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span></span>
<span class="line">  <span class="token comment">//上一个新fiber</span></span>
<span class="line">  <span class="token keyword">let</span> previousNewFiber <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span></span>
<span class="line">  <span class="token comment">//当前的老fiber</span></span>
<span class="line">  <span class="token keyword">let</span> oldFiber <span class="token operator">=</span> currentFirstChild<span class="token punctuation">;</span></span>
<span class="line">  <span class="token comment">//新的虚拟DOM的索引</span></span>
<span class="line">  <span class="token keyword">let</span> newIdx <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span></span>
<span class="line">  <span class="token comment">// 下一个老fiber</span></span>
<span class="line">  <span class="token keyword">let</span> nextOldFiber <span class="token operator">=</span> <span class="token keyword">null</span></span>
<span class="line">  <span class="token comment">//处理更新的情况 老fiber和新fiber都存在</span></span>
<span class="line">  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token punctuation">;</span> oldFiber <span class="token operator">&amp;&amp;</span> newIdx <span class="token operator">&lt;</span> newChildren<span class="token punctuation">.</span>length<span class="token punctuation">;</span> newIdx<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">debugger</span></span>
<span class="line">    <span class="token comment">//先缓存下一个老fiber</span></span>
<span class="line">    nextOldFiber <span class="token operator">=</span> oldFiber<span class="token punctuation">.</span>sibling<span class="token punctuation">;</span></span>
<span class="line">    <span class="token comment">//试图复用才fiber</span></span>
<span class="line">    <span class="token keyword">const</span> newFiber <span class="token operator">=</span> <span class="token function">updateSlot</span><span class="token punctuation">(</span>returnFiber<span class="token punctuation">,</span> oldFiber<span class="token punctuation">,</span> newChildren<span class="token punctuation">[</span>newIdx<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token comment">//如果key 不一样，直接跳出第一轮循环</span></span>
<span class="line">    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>newFiber<span class="token punctuation">)</span></span>
<span class="line">      <span class="token keyword">break</span><span class="token punctuation">;</span> <span class="token comment">//跳出第一轮循环</span></span>
<span class="line">    <span class="token comment">//老fiber存在，但是新的fiber并没有复用老fiber</span></span>
<span class="line">    <span class="token keyword">if</span> <span class="token punctuation">(</span>oldFiber <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>newFiber<span class="token punctuation">.</span>alternate<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">      <span class="token function">deleteChild</span><span class="token punctuation">(</span>returnFiber<span class="token punctuation">,</span> oldFiber<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    <span class="token comment">//核心是给当前的newFiber添加一个副作用flags 叫新增</span></span>
<span class="line">    <span class="token function">placeChild</span><span class="token punctuation">(</span>newFiber<span class="token punctuation">,</span>newIdx<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>previousNewFiber<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">      resultingFirstChild <span class="token operator">=</span> newFiber<span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span></span>
<span class="line">      previousNewFiber<span class="token punctuation">.</span>sibling <span class="token operator">=</span> newFiber<span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    previousNewFiber <span class="token operator">=</span> newFiber<span class="token punctuation">;</span></span>
<span class="line">    oldFiber <span class="token operator">=</span> nextOldFiber<span class="token punctuation">;</span></span>
<span class="line">  <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">  <span class="token comment">// 如果没有老fiber</span></span>
<span class="line">  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>oldFiber<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token comment">// 循环虚拟DOM数组， 为每个虚拟DOM创建一个新的fiber</span></span>
<span class="line">    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token punctuation">;</span> newIdx <span class="token operator">&lt;</span> newChildren<span class="token punctuation">.</span>length<span class="token punctuation">;</span> newIdx<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">      <span class="token keyword">const</span> newFiber <span class="token operator">=</span> <span class="token function">createChild</span><span class="token punctuation">(</span>returnFiber<span class="token punctuation">,</span> newChildren<span class="token punctuation">[</span>newIdx<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//li(A) =&gt;li(B)=&gt; li(C)</span></span>
<span class="line">      <span class="token comment">// newFiber.flags = Placement</span></span>
<span class="line">      <span class="token function">placeChild</span><span class="token punctuation">(</span>newFiber<span class="token punctuation">,</span> newIdx<span class="token punctuation">)</span> </span>
<span class="line">      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>previousNewFiber<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        resultingFirstChild <span class="token operator">=</span> newFiber<span class="token punctuation">;</span><span class="token comment">//resultingFirstChild=&gt;li(A)</span></span>
<span class="line">      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span></span>
<span class="line">        previousNewFiber<span class="token punctuation">.</span>sibling <span class="token operator">=</span> newFiber<span class="token punctuation">;</span><span class="token comment">//liA.sibling=li(B) =&gt; liB.sibling=li(C)</span></span>
<span class="line">      <span class="token punctuation">}</span></span>
<span class="line">      previousNewFiber <span class="token operator">=</span> newFiber<span class="token punctuation">;</span><span class="token comment">//previousNewFiber=&gt;li(A)=&gt;li(B) =&gt; li(C)</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    <span class="token keyword">return</span> resultingFirstChild<span class="token punctuation">;</span></span>
<span class="line">  <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><img src="https://gitee.com/yutao618/images/raw/master/images/20211215150806.png" alt=""></p><p>可以看到是更新了B,插入新的D。</p><h3 id="多个节点的类型和key全部相同-有删除老元素" tabindex="-1"><a class="header-anchor" href="#多个节点的类型和key全部相同-有删除老元素"><span>多个节点的类型和key全部相同，有删除老元素</span></a></h3><div class="language-html line-numbers-mode" data-highlighter="prismjs" data-ext="html"><pre><code class="language-html"><span class="line"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">   <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>button</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>multi3<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>7.多个节点的类型和key全部相同，有删除老元素<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>button</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>br</span><span class="token punctuation">/&gt;</span></span></span>
<span class="line">   <span class="token entity named-entity" title="&lt;">&amp;lt;</span>ul key=<span class="token entity named-entity" title="&quot;">&amp;quot;</span>ul<span class="token entity named-entity" title="&quot;">&amp;quot;</span><span class="token entity named-entity" title="&gt;">&amp;gt;</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>br</span><span class="token punctuation">/&gt;</span></span></span>
<span class="line">     <span class="token entity named-entity" title=" ">&amp;nbsp;</span><span class="token entity named-entity" title=" ">&amp;nbsp;</span><span class="token entity named-entity" title="&lt;">&amp;lt;</span>li key=<span class="token entity named-entity" title="&quot;">&amp;quot;</span>A<span class="token entity named-entity" title="&quot;">&amp;quot;</span><span class="token entity named-entity" title="&gt;">&amp;gt;</span>A<span class="token entity named-entity" title="&lt;">&amp;lt;</span>/li<span class="token entity named-entity" title="&gt;">&amp;gt;</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>br</span><span class="token punctuation">/&gt;</span></span></span>
<span class="line">     <span class="token entity named-entity" title=" ">&amp;nbsp;</span><span class="token entity named-entity" title=" ">&amp;nbsp;</span><span class="token entity named-entity" title="&lt;">&amp;lt;</span>li key=<span class="token entity named-entity" title="&quot;">&amp;quot;</span>B<span class="token entity named-entity" title="&quot;">&amp;quot;</span> id=<span class="token entity named-entity" title="&quot;">&amp;quot;</span>B<span class="token entity named-entity" title="&quot;">&amp;quot;</span><span class="token entity named-entity" title="&gt;">&amp;gt;</span>B<span class="token entity named-entity" title="&lt;">&amp;lt;</span>/li<span class="token entity named-entity" title="&gt;">&amp;gt;</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>br</span><span class="token punctuation">/&gt;</span></span></span>
<span class="line">     <span class="token entity named-entity" title=" ">&amp;nbsp;</span><span class="token entity named-entity" title=" ">&amp;nbsp;</span><span class="token entity named-entity" title="&lt;">&amp;lt;</span>li key=<span class="token entity named-entity" title="&quot;">&amp;quot;</span>C<span class="token entity named-entity" title="&quot;">&amp;quot;</span><span class="token entity named-entity" title="&gt;">&amp;gt;</span>C<span class="token entity named-entity" title="&lt;">&amp;lt;</span>/li<span class="token entity named-entity" title="&gt;">&amp;gt;</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>br</span><span class="token punctuation">/&gt;</span></span></span>
<span class="line">   <span class="token entity named-entity" title="&lt;">&amp;lt;</span>/ul<span class="token entity named-entity" title="&gt;">&amp;gt;</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>br</span><span class="token punctuation">/&gt;</span></span></span>
<span class="line">   <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>button</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>multi3Update<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>删除老元素并更新老元素<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>button</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>br</span><span class="token punctuation">/&gt;</span></span></span>
<span class="line">   <span class="token entity named-entity" title="&lt;">&amp;lt;</span>ul key=<span class="token entity named-entity" title="&quot;">&amp;quot;</span>ul<span class="token entity named-entity" title="&quot;">&amp;quot;</span><span class="token entity named-entity" title="&gt;">&amp;gt;</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>br</span><span class="token punctuation">/&gt;</span></span></span>
<span class="line">     <span class="token entity named-entity" title=" ">&amp;nbsp;</span><span class="token entity named-entity" title=" ">&amp;nbsp;</span><span class="token entity named-entity" title="&lt;">&amp;lt;</span>li key=<span class="token entity named-entity" title="&quot;">&amp;quot;</span>A<span class="token entity named-entity" title="&quot;">&amp;quot;</span><span class="token entity named-entity" title="&gt;">&amp;gt;</span>A<span class="token entity named-entity" title="&lt;">&amp;lt;</span>/li<span class="token entity named-entity" title="&gt;">&amp;gt;</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>br</span><span class="token punctuation">/&gt;</span></span></span>
<span class="line">     <span class="token entity named-entity" title=" ">&amp;nbsp;</span><span class="token entity named-entity" title=" ">&amp;nbsp;</span><span class="token entity named-entity" title="&lt;">&amp;lt;</span>li key=<span class="token entity named-entity" title="&quot;">&amp;quot;</span>B<span class="token entity named-entity" title="&quot;">&amp;quot;</span> id=<span class="token entity named-entity" title="&quot;">&amp;quot;</span>B2<span class="token entity named-entity" title="&quot;">&amp;quot;</span><span class="token entity named-entity" title="&gt;">&amp;gt;</span>B2<span class="token entity named-entity" title="&lt;">&amp;lt;</span>/li<span class="token entity named-entity" title="&gt;">&amp;gt;</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>br</span><span class="token punctuation">/&gt;</span></span></span>
<span class="line">   <span class="token entity named-entity" title="&lt;">&amp;lt;</span>/ul<span class="token entity named-entity" title="&gt;">&amp;gt;</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>br</span><span class="token punctuation">/&gt;</span></span></span>
<span class="line"> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span></span>
<span class="line"> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>hr</span><span class="token punctuation">/&gt;</span></span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code class="language-javascript"><span class="line">multi3<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">&#39;click&#39;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">let</span> element <span class="token operator">=</span> <span class="token punctuation">(</span></span>
<span class="line">        <span class="token operator">&lt;</span>ul key<span class="token operator">=</span><span class="token string">&quot;ul&quot;</span><span class="token operator">&gt;</span></span>
<span class="line">            <span class="token operator">&lt;</span>li key<span class="token operator">=</span><span class="token string">&quot;A&quot;</span><span class="token operator">&gt;</span><span class="token constant">A</span><span class="token operator">&lt;</span><span class="token operator">/</span>li<span class="token operator">&gt;</span></span>
<span class="line">            <span class="token operator">&lt;</span>li key<span class="token operator">=</span><span class="token string">&quot;B&quot;</span> id<span class="token operator">=</span><span class="token string">&quot;B&quot;</span><span class="token operator">&gt;</span><span class="token constant">B</span><span class="token operator">&lt;</span><span class="token operator">/</span>li<span class="token operator">&gt;</span></span>
<span class="line">            <span class="token operator">&lt;</span>li key<span class="token operator">=</span><span class="token string">&quot;C&quot;</span><span class="token operator">&gt;</span><span class="token constant">C</span><span class="token operator">&lt;</span><span class="token operator">/</span>li<span class="token operator">&gt;</span></span>
<span class="line">        <span class="token operator">&lt;</span><span class="token operator">/</span>ul<span class="token operator">&gt;</span></span>
<span class="line">    <span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    ReactDOM<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span>element<span class="token punctuation">,</span> root<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">multi3Update<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">&#39;click&#39;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">let</span> element <span class="token operator">=</span> <span class="token punctuation">(</span></span>
<span class="line">        <span class="token operator">&lt;</span>ul key<span class="token operator">=</span><span class="token string">&quot;ul&quot;</span><span class="token operator">&gt;</span></span>
<span class="line">            <span class="token operator">&lt;</span>li key<span class="token operator">=</span><span class="token string">&quot;A&quot;</span><span class="token operator">&gt;</span><span class="token constant">A</span><span class="token operator">&lt;</span><span class="token operator">/</span>li<span class="token operator">&gt;</span></span>
<span class="line">            <span class="token operator">&lt;</span>li key<span class="token operator">=</span><span class="token string">&quot;B&quot;</span> id<span class="token operator">=</span><span class="token string">&quot;B2&quot;</span><span class="token operator">&gt;</span><span class="token constant">B2</span><span class="token operator">&lt;</span><span class="token operator">/</span>li<span class="token operator">&gt;</span></span>
<span class="line">        <span class="token operator">&lt;</span><span class="token operator">/</span>ul<span class="token operator">&gt;</span></span>
<span class="line">    <span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    ReactDOM<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span>element<span class="token punctuation">,</span> root<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><img src="https://gitee.com/yutao618/images/raw/master/images/20211215151138.png" alt=""></p><p>这个就是从ABC都AB的操作，操作如下：</p><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code class="language-javascript"><span class="line"><span class="token keyword">if</span> <span class="token punctuation">(</span>newIdx <span class="token operator">===</span> newChildren<span class="token punctuation">.</span>length<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">  <span class="token function">deleteRemainingChildren</span><span class="token punctuation">(</span>returnFiber<span class="token punctuation">,</span> oldFiber<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">  <span class="token keyword">return</span> resultingFirstChild<span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>newIdx和newChildren.length相等，就说明新的已经完成了，那就删除所有的之后的老fiber。完整代码如下：</p><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code class="language-javascript"><span class="line"><span class="token keyword">function</span> <span class="token function">reconcileChildrenArray</span><span class="token punctuation">(</span><span class="token parameter">returnFiber<span class="token punctuation">,</span> currentFirstChild<span class="token punctuation">,</span> newChildren</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">  <span class="token comment">//将要返回的第一个新fiber</span></span>
<span class="line">  <span class="token keyword">let</span> resultingFirstChild <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span></span>
<span class="line">  <span class="token comment">//上一个新fiber</span></span>
<span class="line">  <span class="token keyword">let</span> previousNewFiber <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span></span>
<span class="line">  <span class="token comment">//当前的老fiber</span></span>
<span class="line">  <span class="token keyword">let</span> oldFiber <span class="token operator">=</span> currentFirstChild<span class="token punctuation">;</span></span>
<span class="line">  <span class="token comment">//新的虚拟DOM的索引</span></span>
<span class="line">  <span class="token keyword">let</span> newIdx <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span></span>
<span class="line">  <span class="token comment">// 下一个老fiber</span></span>
<span class="line">  <span class="token keyword">let</span> nextOldFiber <span class="token operator">=</span> <span class="token keyword">null</span></span>
<span class="line">  <span class="token comment">//处理更新的情况 老fiber和新fiber都存在</span></span>
<span class="line">  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token punctuation">;</span> oldFiber <span class="token operator">&amp;&amp;</span> newIdx <span class="token operator">&lt;</span> newChildren<span class="token punctuation">.</span>length<span class="token punctuation">;</span> newIdx<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token comment">//先缓存下一个老fiber</span></span>
<span class="line">    nextOldFiber <span class="token operator">=</span> oldFiber<span class="token punctuation">.</span>sibling<span class="token punctuation">;</span></span>
<span class="line">    <span class="token comment">//试图复用才fiber</span></span>
<span class="line">    <span class="token keyword">const</span> newFiber <span class="token operator">=</span> <span class="token function">updateSlot</span><span class="token punctuation">(</span>returnFiber<span class="token punctuation">,</span> oldFiber<span class="token punctuation">,</span> newChildren<span class="token punctuation">[</span>newIdx<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token comment">//如果key 不一样，直接跳出第一轮循环</span></span>
<span class="line">    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>newFiber<span class="token punctuation">)</span></span>
<span class="line">      <span class="token keyword">break</span><span class="token punctuation">;</span> <span class="token comment">//跳出第一轮循环</span></span>
<span class="line">    <span class="token comment">//老fiber存在，但是新的fiber并没有复用老fiber</span></span>
<span class="line">    <span class="token keyword">if</span> <span class="token punctuation">(</span>oldFiber <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>newFiber<span class="token punctuation">.</span>alternate<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">      <span class="token function">deleteChild</span><span class="token punctuation">(</span>returnFiber<span class="token punctuation">,</span> oldFiber<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    <span class="token comment">//核心是给当前的newFiber添加一个副作用flags 叫新增</span></span>
<span class="line">    <span class="token function">placeChild</span><span class="token punctuation">(</span>newFiber<span class="token punctuation">,</span> newIdx<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>previousNewFiber<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">      resultingFirstChild <span class="token operator">=</span> newFiber<span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span></span>
<span class="line">      previousNewFiber<span class="token punctuation">.</span>sibling <span class="token operator">=</span> newFiber<span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    previousNewFiber <span class="token operator">=</span> newFiber<span class="token punctuation">;</span></span>
<span class="line">    oldFiber <span class="token operator">=</span> nextOldFiber<span class="token punctuation">;</span></span>
<span class="line">  <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">  <span class="token keyword">if</span> <span class="token punctuation">(</span>newIdx <span class="token operator">===</span> newChildren<span class="token punctuation">.</span>length<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token function">deleteRemainingChildren</span><span class="token punctuation">(</span>returnFiber<span class="token punctuation">,</span> oldFiber<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">return</span> resultingFirstChild<span class="token punctuation">;</span></span>
<span class="line">  <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">  <span class="token comment">// 如果没有老fiber</span></span>
<span class="line">  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>oldFiber<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token comment">// 循环虚拟DOM数组， 为每个虚拟DOM创建一个新的fiber</span></span>
<span class="line">    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token punctuation">;</span> newIdx <span class="token operator">&lt;</span> newChildren<span class="token punctuation">.</span>length<span class="token punctuation">;</span> newIdx<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">      <span class="token keyword">const</span> newFiber <span class="token operator">=</span> <span class="token function">createChild</span><span class="token punctuation">(</span>returnFiber<span class="token punctuation">,</span> newChildren<span class="token punctuation">[</span>newIdx<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//li(A) =&gt;li(B)=&gt; li(C)</span></span>
<span class="line">      <span class="token comment">// newFiber.flags = Placement</span></span>
<span class="line">      <span class="token function">placeChild</span><span class="token punctuation">(</span>newFiber<span class="token punctuation">,</span> newIdx<span class="token punctuation">)</span></span>
<span class="line">      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>previousNewFiber<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        resultingFirstChild <span class="token operator">=</span> newFiber<span class="token punctuation">;</span><span class="token comment">//resultingFirstChild=&gt;li(A)</span></span>
<span class="line">      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span></span>
<span class="line">        previousNewFiber<span class="token punctuation">.</span>sibling <span class="token operator">=</span> newFiber<span class="token punctuation">;</span><span class="token comment">//liA.sibling=li(B) =&gt; liB.sibling=li(C)</span></span>
<span class="line">      <span class="token punctuation">}</span></span>
<span class="line">      previousNewFiber <span class="token operator">=</span> newFiber<span class="token punctuation">;</span><span class="token comment">//previousNewFiber=&gt;li(A)=&gt;li(B) =&gt; li(C)</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    <span class="token keyword">return</span> resultingFirstChild<span class="token punctuation">;</span></span>
<span class="line">  <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><img src="https://gitee.com/yutao618/images/raw/master/images/20211215152026.png" alt=""></p><p>可以看到删除了C,并且更新了B。接下来看最复杂的一个。</p><h3 id="多个节点数量不同、key不同" tabindex="-1"><a class="header-anchor" href="#多个节点数量不同、key不同"><span>多个节点数量不同、key不同</span></a></h3><div class="language-html line-numbers-mode" data-highlighter="prismjs" data-ext="html"><pre><code class="language-html"><span class="line"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span><span class="token punctuation">&gt;</span></span></span>
<span class="line"> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>button</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>multi5<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>9.多个节点数量不同、key不同<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>button</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>br</span><span class="token punctuation">/&gt;</span></span></span>
<span class="line">   <span class="token entity named-entity" title="&lt;">&amp;lt;</span>ul key=<span class="token entity named-entity" title="&quot;">&amp;quot;</span>ul<span class="token entity named-entity" title="&quot;">&amp;quot;</span><span class="token entity named-entity" title="&gt;">&amp;gt;</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>br</span><span class="token punctuation">/&gt;</span></span></span>
<span class="line">    <span class="token entity named-entity" title=" ">&amp;nbsp;</span><span class="token entity named-entity" title=" ">&amp;nbsp;</span><span class="token entity named-entity" title="&lt;">&amp;lt;</span>li key=<span class="token entity named-entity" title="&quot;">&amp;quot;</span>A<span class="token entity named-entity" title="&quot;">&amp;quot;</span><span class="token entity named-entity" title="&gt;">&amp;gt;</span>A<span class="token entity named-entity" title="&lt;">&amp;lt;</span>/li<span class="token entity named-entity" title="&gt;">&amp;gt;</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>br</span><span class="token punctuation">/&gt;</span></span></span>
<span class="line">    <span class="token entity named-entity" title=" ">&amp;nbsp;</span><span class="token entity named-entity" title=" ">&amp;nbsp;</span><span class="token entity named-entity" title="&lt;">&amp;lt;</span>li key=<span class="token entity named-entity" title="&quot;">&amp;quot;</span>B<span class="token entity named-entity" title="&quot;">&amp;quot;</span> id=<span class="token entity named-entity" title="&quot;">&amp;quot;</span>b<span class="token entity named-entity" title="&quot;">&amp;quot;</span><span class="token entity named-entity" title="&gt;">&amp;gt;</span>B<span class="token entity named-entity" title="&lt;">&amp;lt;</span>/li<span class="token entity named-entity" title="&gt;">&amp;gt;</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>br</span><span class="token punctuation">/&gt;</span></span></span>
<span class="line">    <span class="token entity named-entity" title=" ">&amp;nbsp;</span><span class="token entity named-entity" title=" ">&amp;nbsp;</span><span class="token entity named-entity" title="&lt;">&amp;lt;</span>li key=<span class="token entity named-entity" title="&quot;">&amp;quot;</span>C<span class="token entity named-entity" title="&quot;">&amp;quot;</span><span class="token entity named-entity" title="&gt;">&amp;gt;</span>C<span class="token entity named-entity" title="&lt;">&amp;lt;</span>/li<span class="token entity named-entity" title="&gt;">&amp;gt;</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>br</span><span class="token punctuation">/&gt;</span></span></span>
<span class="line">    <span class="token entity named-entity" title=" ">&amp;nbsp;</span><span class="token entity named-entity" title=" ">&amp;nbsp;</span><span class="token entity named-entity" title="&lt;">&amp;lt;</span>li key=<span class="token entity named-entity" title="&quot;">&amp;quot;</span>D<span class="token entity named-entity" title="&quot;">&amp;quot;</span><span class="token entity named-entity" title="&gt;">&amp;gt;</span>D<span class="token entity named-entity" title="&lt;">&amp;lt;</span>/li<span class="token entity named-entity" title="&gt;">&amp;gt;</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>br</span><span class="token punctuation">/&gt;</span></span></span>
<span class="line">    <span class="token entity named-entity" title=" ">&amp;nbsp;</span><span class="token entity named-entity" title=" ">&amp;nbsp;</span><span class="token entity named-entity" title="&lt;">&amp;lt;</span>li key=<span class="token entity named-entity" title="&quot;">&amp;quot;</span>E<span class="token entity named-entity" title="&quot;">&amp;quot;</span><span class="token entity named-entity" title="&gt;">&amp;gt;</span>E<span class="token entity named-entity" title="&lt;">&amp;lt;</span>/li<span class="token entity named-entity" title="&gt;">&amp;gt;</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>br</span><span class="token punctuation">/&gt;</span></span></span>
<span class="line">    <span class="token entity named-entity" title=" ">&amp;nbsp;</span><span class="token entity named-entity" title=" ">&amp;nbsp;</span><span class="token entity named-entity" title="&lt;">&amp;lt;</span>li key=<span class="token entity named-entity" title="&quot;">&amp;quot;</span>F<span class="token entity named-entity" title="&quot;">&amp;quot;</span><span class="token entity named-entity" title="&gt;">&amp;gt;</span>F<span class="token entity named-entity" title="&lt;">&amp;lt;</span>/li<span class="token entity named-entity" title="&gt;">&amp;gt;</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>br</span><span class="token punctuation">/&gt;</span></span></span>
<span class="line">    <span class="token entity named-entity" title="&lt;">&amp;lt;</span>/ul<span class="token entity named-entity" title="&gt;">&amp;gt;</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>br</span><span class="token punctuation">/&gt;</span></span></span>
<span class="line">  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>button</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>multi5Update<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>处理节点移动的情况<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>button</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>br</span><span class="token punctuation">/&gt;</span></span></span>
<span class="line">    <span class="token entity named-entity" title="&lt;">&amp;lt;</span>ul key=<span class="token entity named-entity" title="&quot;">&amp;quot;</span>ul<span class="token entity named-entity" title="&quot;">&amp;quot;</span><span class="token entity named-entity" title="&gt;">&amp;gt;</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>br</span><span class="token punctuation">/&gt;</span></span></span>
<span class="line">    <span class="token entity named-entity" title=" ">&amp;nbsp;</span><span class="token entity named-entity" title=" ">&amp;nbsp;</span><span class="token entity named-entity" title="&lt;">&amp;lt;</span>li key=<span class="token entity named-entity" title="&quot;">&amp;quot;</span>A<span class="token entity named-entity" title="&quot;">&amp;quot;</span><span class="token entity named-entity" title="&gt;">&amp;gt;</span>A<span class="token entity named-entity" title="&lt;">&amp;lt;</span>/li<span class="token entity named-entity" title="&gt;">&amp;gt;</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>br</span><span class="token punctuation">/&gt;</span></span></span>
<span class="line">    <span class="token entity named-entity" title=" ">&amp;nbsp;</span><span class="token entity named-entity" title=" ">&amp;nbsp;</span><span class="token entity named-entity" title="&lt;">&amp;lt;</span>li key=<span class="token entity named-entity" title="&quot;">&amp;quot;</span>C<span class="token entity named-entity" title="&quot;">&amp;quot;</span><span class="token entity named-entity" title="&gt;">&amp;gt;</span>C<span class="token entity named-entity" title="&lt;">&amp;lt;</span>/li<span class="token entity named-entity" title="&gt;">&amp;gt;</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>br</span><span class="token punctuation">/&gt;</span></span></span>
<span class="line">    <span class="token entity named-entity" title=" ">&amp;nbsp;</span><span class="token entity named-entity" title=" ">&amp;nbsp;</span><span class="token entity named-entity" title="&lt;">&amp;lt;</span>li key=<span class="token entity named-entity" title="&quot;">&amp;quot;</span>E<span class="token entity named-entity" title="&quot;">&amp;quot;</span><span class="token entity named-entity" title="&gt;">&amp;gt;</span>E<span class="token entity named-entity" title="&lt;">&amp;lt;</span>/li<span class="token entity named-entity" title="&gt;">&amp;gt;</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>br</span><span class="token punctuation">/&gt;</span></span></span>
<span class="line">    <span class="token entity named-entity" title=" ">&amp;nbsp;</span><span class="token entity named-entity" title=" ">&amp;nbsp;</span><span class="token entity named-entity" title="&lt;">&amp;lt;</span>li key=<span class="token entity named-entity" title="&quot;">&amp;quot;</span>B<span class="token entity named-entity" title="&quot;">&amp;quot;</span> id=<span class="token entity named-entity" title="&quot;">&amp;quot;</span>b2<span class="token entity named-entity" title="&quot;">&amp;quot;</span><span class="token entity named-entity" title="&gt;">&amp;gt;</span>B2<span class="token entity named-entity" title="&lt;">&amp;lt;</span>/li<span class="token entity named-entity" title="&gt;">&amp;gt;</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>br</span><span class="token punctuation">/&gt;</span></span></span>
<span class="line">    <span class="token entity named-entity" title=" ">&amp;nbsp;</span><span class="token entity named-entity" title=" ">&amp;nbsp;</span><span class="token entity named-entity" title="&lt;">&amp;lt;</span>li key=<span class="token entity named-entity" title="&quot;">&amp;quot;</span>G<span class="token entity named-entity" title="&quot;">&amp;quot;</span><span class="token entity named-entity" title="&gt;">&amp;gt;</span>G<span class="token entity named-entity" title="&lt;">&amp;lt;</span>/li<span class="token entity named-entity" title="&gt;">&amp;gt;</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>br</span><span class="token punctuation">/&gt;</span></span></span>
<span class="line">    <span class="token entity named-entity" title=" ">&amp;nbsp;</span><span class="token entity named-entity" title=" ">&amp;nbsp;</span><span class="token entity named-entity" title="&lt;">&amp;lt;</span>li key=<span class="token entity named-entity" title="&quot;">&amp;quot;</span>D<span class="token entity named-entity" title="&quot;">&amp;quot;</span><span class="token entity named-entity" title="&gt;">&amp;gt;</span>D<span class="token entity named-entity" title="&lt;">&amp;lt;</span>/li<span class="token entity named-entity" title="&gt;">&amp;gt;</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>br</span><span class="token punctuation">/&gt;</span></span></span>
<span class="line">    <span class="token entity named-entity" title="&lt;">&amp;lt;</span>/ul<span class="token entity named-entity" title="&gt;">&amp;gt;</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>br</span><span class="token punctuation">/&gt;</span></span></span>
<span class="line"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span></span>
<span class="line"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>hr</span><span class="token punctuation">/&gt;</span></span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code class="language-javascript"><span class="line">multi5<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">&#39;click&#39;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">let</span> element <span class="token operator">=</span> <span class="token punctuation">(</span></span>
<span class="line">        <span class="token operator">&lt;</span>ul key<span class="token operator">=</span><span class="token string">&quot;ul&quot;</span><span class="token operator">&gt;</span></span>
<span class="line">            <span class="token operator">&lt;</span>li key<span class="token operator">=</span><span class="token string">&quot;A&quot;</span><span class="token operator">&gt;</span><span class="token constant">A</span><span class="token operator">&lt;</span><span class="token operator">/</span>li<span class="token operator">&gt;</span></span>
<span class="line">            <span class="token operator">&lt;</span>li key<span class="token operator">=</span><span class="token string">&quot;B&quot;</span> id<span class="token operator">=</span><span class="token string">&quot;b&quot;</span><span class="token operator">&gt;</span><span class="token constant">B</span><span class="token operator">&lt;</span><span class="token operator">/</span>li<span class="token operator">&gt;</span></span>
<span class="line">            <span class="token operator">&lt;</span>li key<span class="token operator">=</span><span class="token string">&quot;C&quot;</span><span class="token operator">&gt;</span><span class="token constant">C</span><span class="token operator">&lt;</span><span class="token operator">/</span>li<span class="token operator">&gt;</span></span>
<span class="line">            <span class="token operator">&lt;</span>li key<span class="token operator">=</span><span class="token string">&quot;D&quot;</span><span class="token operator">&gt;</span><span class="token constant">D</span><span class="token operator">&lt;</span><span class="token operator">/</span>li<span class="token operator">&gt;</span></span>
<span class="line">            <span class="token operator">&lt;</span>li key<span class="token operator">=</span><span class="token string">&quot;E&quot;</span><span class="token operator">&gt;</span><span class="token constant">E</span><span class="token operator">&lt;</span><span class="token operator">/</span>li<span class="token operator">&gt;</span></span>
<span class="line">            <span class="token operator">&lt;</span>li key<span class="token operator">=</span><span class="token string">&quot;F&quot;</span><span class="token operator">&gt;</span><span class="token constant">F</span><span class="token operator">&lt;</span><span class="token operator">/</span>li<span class="token operator">&gt;</span></span>
<span class="line">        <span class="token operator">&lt;</span><span class="token operator">/</span>ul<span class="token operator">&gt;</span></span>
<span class="line">    <span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    ReactDOM<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span>element<span class="token punctuation">,</span> root<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">multi5Update<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">&#39;click&#39;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">let</span> element <span class="token operator">=</span> <span class="token punctuation">(</span></span>
<span class="line">        <span class="token operator">&lt;</span>ul key<span class="token operator">=</span><span class="token string">&quot;ul&quot;</span><span class="token operator">&gt;</span></span>
<span class="line">            <span class="token operator">&lt;</span>li key<span class="token operator">=</span><span class="token string">&quot;A&quot;</span><span class="token operator">&gt;</span><span class="token constant">A</span><span class="token operator">&lt;</span><span class="token operator">/</span>li<span class="token operator">&gt;</span></span>
<span class="line">            <span class="token operator">&lt;</span>li key<span class="token operator">=</span><span class="token string">&quot;C&quot;</span><span class="token operator">&gt;</span><span class="token constant">C</span><span class="token operator">&lt;</span><span class="token operator">/</span>li<span class="token operator">&gt;</span></span>
<span class="line">            <span class="token operator">&lt;</span>li key<span class="token operator">=</span><span class="token string">&quot;E&quot;</span><span class="token operator">&gt;</span><span class="token constant">E</span><span class="token operator">&lt;</span><span class="token operator">/</span>li<span class="token operator">&gt;</span></span>
<span class="line">            <span class="token operator">&lt;</span>li key<span class="token operator">=</span><span class="token string">&quot;B&quot;</span> id<span class="token operator">=</span><span class="token string">&quot;b2&quot;</span><span class="token operator">&gt;</span><span class="token constant">B2</span><span class="token operator">&lt;</span><span class="token operator">/</span>li<span class="token operator">&gt;</span></span>
<span class="line">            <span class="token operator">&lt;</span>li key<span class="token operator">=</span><span class="token string">&quot;G&quot;</span><span class="token operator">&gt;</span><span class="token constant">G</span><span class="token operator">&lt;</span><span class="token operator">/</span>li<span class="token operator">&gt;</span></span>
<span class="line">            <span class="token operator">&lt;</span>li key<span class="token operator">=</span><span class="token string">&quot;D&quot;</span><span class="token operator">&gt;</span><span class="token constant">D</span><span class="token operator">&lt;</span><span class="token operator">/</span>li<span class="token operator">&gt;</span></span>
<span class="line">        <span class="token operator">&lt;</span><span class="token operator">/</span>ul<span class="token operator">&gt;</span></span>
<span class="line">    <span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    ReactDOM<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span>element<span class="token punctuation">,</span> root<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><img src="https://gitee.com/yutao618/images/raw/master/images/20211215152507.png" alt=""></p><p>这种是最复杂的情况，也是DOM DIFF的精华所在，先来梳理下上图的更新逻辑。</p><p><img src="https://gitee.com/yutao618/images/raw/master/images/duo_ge_jie_dian_shu_liang_bu_tong_key_bu_tong_1_1637057627706.jpg" alt=""></p><p>先来看下之前的reconcileChildrenArray的逻辑，按照上图的顺序梳理下。</p><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code class="language-javascript"><span class="line"><span class="token keyword">function</span> <span class="token function">reconcileChildrenArray</span><span class="token punctuation">(</span><span class="token parameter">returnFiber<span class="token punctuation">,</span> currentFirstChild<span class="token punctuation">,</span> newChildren</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">  <span class="token comment">//将要返回的第一个新fiber</span></span>
<span class="line">  <span class="token keyword">let</span> resultingFirstChild <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span></span>
<span class="line">  <span class="token comment">//上一个新fiber</span></span>
<span class="line">  <span class="token keyword">let</span> previousNewFiber <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span></span>
<span class="line">  <span class="token comment">//当前的老fiber</span></span>
<span class="line">  <span class="token keyword">let</span> oldFiber <span class="token operator">=</span> currentFirstChild<span class="token punctuation">;</span></span>
<span class="line">  <span class="token comment">//新的虚拟DOM的索引</span></span>
<span class="line">  <span class="token keyword">let</span> newIdx <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span></span>
<span class="line">  <span class="token comment">// 下一个老fiber</span></span>
<span class="line">  <span class="token keyword">let</span> nextOldFiber <span class="token operator">=</span> <span class="token keyword">null</span></span>
<span class="line">  <span class="token comment">//处理更新的情况 老fiber和新fiber都存在</span></span>
<span class="line">  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token punctuation">;</span> oldFiber <span class="token operator">&amp;&amp;</span> newIdx <span class="token operator">&lt;</span> newChildren<span class="token punctuation">.</span>length<span class="token punctuation">;</span> newIdx<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token comment">//先缓存下一个老fiber</span></span>
<span class="line">    nextOldFiber <span class="token operator">=</span> oldFiber<span class="token punctuation">.</span>sibling<span class="token punctuation">;</span></span>
<span class="line">    <span class="token comment">//试图复用才fiber</span></span>
<span class="line">    <span class="token keyword">const</span> newFiber <span class="token operator">=</span> <span class="token function">updateSlot</span><span class="token punctuation">(</span>returnFiber<span class="token punctuation">,</span> oldFiber<span class="token punctuation">,</span> newChildren<span class="token punctuation">[</span>newIdx<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token comment">//如果key 不一样，直接跳出第一轮循环</span></span>
<span class="line">    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>newFiber<span class="token punctuation">)</span></span>
<span class="line">      <span class="token keyword">break</span><span class="token punctuation">;</span> <span class="token comment">//跳出第一轮循环</span></span>
<span class="line">    <span class="token comment">//老fiber存在，但是新的fiber并没有复用老fiber</span></span>
<span class="line">    <span class="token keyword">if</span> <span class="token punctuation">(</span>oldFiber <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>newFiber<span class="token punctuation">.</span>alternate<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">      <span class="token function">deleteChild</span><span class="token punctuation">(</span>returnFiber<span class="token punctuation">,</span> oldFiber<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    <span class="token comment">//核心是给当前的newFiber添加一个副作用flags 叫新增</span></span>
<span class="line">    <span class="token function">placeChild</span><span class="token punctuation">(</span>newFiber<span class="token punctuation">,</span> newIdx<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>previousNewFiber<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">      resultingFirstChild <span class="token operator">=</span> newFiber<span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span></span>
<span class="line">      previousNewFiber<span class="token punctuation">.</span>sibling <span class="token operator">=</span> newFiber<span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    previousNewFiber <span class="token operator">=</span> newFiber<span class="token punctuation">;</span></span>
<span class="line">    oldFiber <span class="token operator">=</span> nextOldFiber<span class="token punctuation">;</span></span>
<span class="line">  <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">  <span class="token keyword">if</span> <span class="token punctuation">(</span>newIdx <span class="token operator">===</span> newChildren<span class="token punctuation">.</span>length<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token function">deleteRemainingChildren</span><span class="token punctuation">(</span>returnFiber<span class="token punctuation">,</span> oldFiber<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">return</span> resultingFirstChild<span class="token punctuation">;</span></span>
<span class="line">  <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">  <span class="token comment">// 如果没有老fiber</span></span>
<span class="line">  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>oldFiber<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token comment">// 循环虚拟DOM数组， 为每个虚拟DOM创建一个新的fiber</span></span>
<span class="line">    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token punctuation">;</span> newIdx <span class="token operator">&lt;</span> newChildren<span class="token punctuation">.</span>length<span class="token punctuation">;</span> newIdx<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">      <span class="token keyword">const</span> newFiber <span class="token operator">=</span> <span class="token function">createChild</span><span class="token punctuation">(</span>returnFiber<span class="token punctuation">,</span> newChildren<span class="token punctuation">[</span>newIdx<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//li(A) =&gt;li(B)=&gt; li(C)</span></span>
<span class="line">      <span class="token comment">// newFiber.flags = Placement</span></span>
<span class="line">      <span class="token function">placeChild</span><span class="token punctuation">(</span>newFiber<span class="token punctuation">,</span> newIdx<span class="token punctuation">)</span></span>
<span class="line">      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>previousNewFiber<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        resultingFirstChild <span class="token operator">=</span> newFiber<span class="token punctuation">;</span><span class="token comment">//resultingFirstChild=&gt;li(A)</span></span>
<span class="line">      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span></span>
<span class="line">        previousNewFiber<span class="token punctuation">.</span>sibling <span class="token operator">=</span> newFiber<span class="token punctuation">;</span><span class="token comment">//liA.sibling=li(B) =&gt; liB.sibling=li(C)</span></span>
<span class="line">      <span class="token punctuation">}</span></span>
<span class="line">      previousNewFiber <span class="token operator">=</span> newFiber<span class="token punctuation">;</span><span class="token comment">//previousNewFiber=&gt;li(A)=&gt;li(B) =&gt; li(C)</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    <span class="token keyword">return</span> resultingFirstChild<span class="token punctuation">;</span></span>
<span class="line">  <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>A和A做比较，可以复用；然后比较B和C,key不一样，updateSlot之后返回的null,跳出第一轮循环，newIdx为1，newChildren.length为6，而且oldFiber指向的是B,所以，下面2个判断是进不去的。</p><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code class="language-javascript"><span class="line"><span class="token keyword">if</span> <span class="token punctuation">(</span>newIdx <span class="token operator">===</span> newChildren<span class="token punctuation">.</span>length<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token function">deleteRemainingChildren</span><span class="token punctuation">(</span>returnFiber<span class="token punctuation">,</span> oldFiber<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">return</span> resultingFirstChild<span class="token punctuation">;</span></span>
<span class="line">  <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">  <span class="token comment">// 如果没有老fiber</span></span>
<span class="line">  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>oldFiber<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token comment">// 循环虚拟DOM数组， 为每个虚拟DOM创建一个新的fiber</span></span>
<span class="line">    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token punctuation">;</span> newIdx <span class="token operator">&lt;</span> newChildren<span class="token punctuation">.</span>length<span class="token punctuation">;</span> newIdx<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">      <span class="token keyword">const</span> newFiber <span class="token operator">=</span> <span class="token function">createChild</span><span class="token punctuation">(</span>returnFiber<span class="token punctuation">,</span> newChildren<span class="token punctuation">[</span>newIdx<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//li(A) =&gt;li(B)=&gt; li(C)</span></span>
<span class="line">      <span class="token comment">// newFiber.flags = Placement</span></span>
<span class="line">      <span class="token function">placeChild</span><span class="token punctuation">(</span>newFiber<span class="token punctuation">,</span> newIdx<span class="token punctuation">)</span></span>
<span class="line">      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>previousNewFiber<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        resultingFirstChild <span class="token operator">=</span> newFiber<span class="token punctuation">;</span><span class="token comment">//resultingFirstChild=&gt;li(A)</span></span>
<span class="line">      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span></span>
<span class="line">        previousNewFiber<span class="token punctuation">.</span>sibling <span class="token operator">=</span> newFiber<span class="token punctuation">;</span><span class="token comment">//liA.sibling=li(B) =&gt; liB.sibling=li(C)</span></span>
<span class="line">      <span class="token punctuation">}</span></span>
<span class="line">      previousNewFiber <span class="token operator">=</span> newFiber<span class="token punctuation">;</span><span class="token comment">//previousNewFiber=&gt;li(A)=&gt;li(B) =&gt; li(C)</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    <span class="token keyword">return</span> resultingFirstChild<span class="token punctuation">;</span></span>
<span class="line">  <span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>这个时候就按照上面的流程，把剩下的oldFiber放到existingChildren这个map中去，对应的代码如下：</p><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code class="language-javascript"><span class="line"><span class="token comment">// 将剩下的老fiber放入map中</span></span>
<span class="line"><span class="token keyword">const</span> existingChildren <span class="token operator">=</span> <span class="token function">mapRemainingChildren</span><span class="token punctuation">(</span>returnFiber<span class="token punctuation">,</span> oldFiber<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code class="language-javascript"><span class="line"><span class="token keyword">function</span> <span class="token function">mapRemainingChildren</span><span class="token punctuation">(</span><span class="token parameter">returnFiber<span class="token punctuation">,</span> currentFirstChild</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">  <span class="token keyword">const</span> existingChildren <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Map</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">  <span class="token keyword">let</span> existingChild <span class="token operator">=</span> currentFirstChild<span class="token punctuation">;</span></span>
<span class="line">  <span class="token keyword">while</span> <span class="token punctuation">(</span>existingChild<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">let</span> key <span class="token operator">=</span> existingChild<span class="token punctuation">.</span>key <span class="token operator">||</span> existingChild<span class="token punctuation">.</span>index<span class="token punctuation">;</span></span>
<span class="line">    existingChildren<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> existingChild<span class="token punctuation">)</span></span>
<span class="line">    existingChild <span class="token operator">=</span> existingChild<span class="token punctuation">.</span>sibling<span class="token punctuation">;</span></span>
<span class="line">  <span class="token punctuation">}</span></span>
<span class="line">  <span class="token keyword">return</span> existingChildren<span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>这个map目前大概张这样map={B:bFiber,C:cFiber,D:dFiber,E:eFiber,F:fFiber}，然后声明一个变量lastPlacedIndex变量，表示不需要移动的老节点的索引，默认为0，接着循环剩下的虚拟dom节点，从C开始。如果能在map中能找到相同key相同type的节点则可以复用老fiber,并把老fiber从map中删除。具体代码如下</p><div class="language-diff line-numbers-mode" data-highlighter="prismjs" data-ext="diff"><pre><code class="language-diff"><span class="line">function reconcileChildrenArray(returnFiber, currentFirstChild, newChildren) {</span>
<span class="line"><span class="token unchanged"><span class="token prefix unchanged"> </span><span class="token line"> //将要返回的第一个新fiber</span>
<span class="line"></span><span class="token prefix unchanged"> </span><span class="token line"> let resultingFirstChild = null;</span>
<span class="line"></span><span class="token prefix unchanged"> </span><span class="token line"> //上一个新fiber</span>
<span class="line"></span><span class="token prefix unchanged"> </span><span class="token line"> let previousNewFiber = null;</span>
<span class="line"></span><span class="token prefix unchanged"> </span><span class="token line"> //当前的老fiber</span>
<span class="line"></span><span class="token prefix unchanged"> </span><span class="token line"> let oldFiber = currentFirstChild;</span>
<span class="line"></span><span class="token prefix unchanged"> </span><span class="token line"> //新的虚拟DOM的索引</span>
<span class="line"></span><span class="token prefix unchanged"> </span><span class="token line"> let newIdx = 0;</span>
<span class="line"></span><span class="token prefix unchanged"> </span><span class="token line"> // 下一个老fiber</span>
<span class="line"></span><span class="token prefix unchanged"> </span><span class="token line"> let nextOldFiber = null</span>
<span class="line"></span></span><span class="token inserted-sign inserted"><span class="token prefix inserted">+</span><span class="token line">  // 指的上一个可以复用的，不需要移动的节点的老索引</span>
<span class="line"></span><span class="token prefix inserted">+</span><span class="token line">  let lastPlacedIndex = 0;</span>
<span class="line"></span></span><span class="token unchanged"><span class="token prefix unchanged"> </span><span class="token line"> //处理更新的情况 老fiber和新fiber都存在</span>
<span class="line"></span><span class="token prefix unchanged"> </span><span class="token line"> for (; oldFiber &amp;&amp; newIdx &lt; newChildren.length; newIdx++) {</span>
<span class="line"></span><span class="token prefix unchanged"> </span><span class="token line">   //先缓存下一个老fiber</span>
<span class="line"></span><span class="token prefix unchanged"> </span><span class="token line">   nextOldFiber = oldFiber.sibling;</span>
<span class="line"></span><span class="token prefix unchanged"> </span><span class="token line">   //试图复用才fiber</span>
<span class="line"></span><span class="token prefix unchanged"> </span><span class="token line">   const newFiber = updateSlot(returnFiber, oldFiber, newChildren[newIdx]);</span>
<span class="line"></span><span class="token prefix unchanged"> </span><span class="token line">   //如果key 不一样，直接跳出第一轮循环</span>
<span class="line"></span><span class="token prefix unchanged"> </span><span class="token line">   if (!newFiber)</span>
<span class="line"></span><span class="token prefix unchanged"> </span><span class="token line">     break; //跳出第一轮循环</span>
<span class="line"></span><span class="token prefix unchanged"> </span><span class="token line">   //老fiber存在，但是新的fiber并没有复用老fiber</span>
<span class="line"></span><span class="token prefix unchanged"> </span><span class="token line">   if (oldFiber &amp;&amp; !newFiber.alternate) {</span>
<span class="line"></span><span class="token prefix unchanged"> </span><span class="token line">     deleteChild(returnFiber, oldFiber);</span>
<span class="line"></span><span class="token prefix unchanged"> </span><span class="token line">   }</span>
<span class="line"></span><span class="token prefix unchanged"> </span><span class="token line">   //核心是给当前的newFiber添加一个副作用flags 叫新增</span>
<span class="line"></span><span class="token prefix unchanged"> </span><span class="token line">   placeChild(newFiber, newIdx);</span>
<span class="line"></span><span class="token prefix unchanged"> </span><span class="token line">   if (!previousNewFiber) {</span>
<span class="line"></span><span class="token prefix unchanged"> </span><span class="token line">     resultingFirstChild = newFiber;</span>
<span class="line"></span><span class="token prefix unchanged"> </span><span class="token line">   } else {</span>
<span class="line"></span><span class="token prefix unchanged"> </span><span class="token line">     previousNewFiber.sibling = newFiber;</span>
<span class="line"></span><span class="token prefix unchanged"> </span><span class="token line">   }</span>
<span class="line"></span><span class="token prefix unchanged"> </span><span class="token line">   previousNewFiber = newFiber;</span>
<span class="line"></span><span class="token prefix unchanged"> </span><span class="token line">   oldFiber = nextOldFiber;</span>
<span class="line"></span><span class="token prefix unchanged"> </span><span class="token line"> }</span>
<span class="line"></span></span></span>
<span class="line"><span class="token unchanged"><span class="token prefix unchanged"> </span><span class="token line"> if (newIdx === newChildren.length) {</span>
<span class="line"></span><span class="token prefix unchanged"> </span><span class="token line">   deleteRemainingChildren(returnFiber, oldFiber);</span>
<span class="line"></span><span class="token prefix unchanged"> </span><span class="token line">   return resultingFirstChild;</span>
<span class="line"></span><span class="token prefix unchanged"> </span><span class="token line"> }</span>
<span class="line"></span></span></span>
<span class="line"><span class="token unchanged"><span class="token prefix unchanged"> </span><span class="token line"> // 如果没有老fiber</span>
<span class="line"></span><span class="token prefix unchanged"> </span><span class="token line"> if (!oldFiber) {</span>
<span class="line"></span><span class="token prefix unchanged"> </span><span class="token line">   // 循环虚拟DOM数组， 为每个虚拟DOM创建一个新的fiber</span>
<span class="line"></span><span class="token prefix unchanged"> </span><span class="token line">   for (; newIdx &lt; newChildren.length; newIdx++) {</span>
<span class="line"></span><span class="token prefix unchanged"> </span><span class="token line">     const newFiber = createChild(returnFiber, newChildren[newIdx]);//li(A) =&gt;li(B)=&gt; li(C)</span>
<span class="line"></span><span class="token prefix unchanged"> </span><span class="token line">     // newFiber.flags = Placement</span>
<span class="line"></span><span class="token prefix unchanged"> </span><span class="token line">     placeChild(newFiber, newIdx)</span>
<span class="line"></span><span class="token prefix unchanged"> </span><span class="token line">     if (!previousNewFiber) {</span>
<span class="line"></span><span class="token prefix unchanged"> </span><span class="token line">       resultingFirstChild = newFiber;</span>
<span class="line"></span><span class="token prefix unchanged"> </span><span class="token line">     } else {</span>
<span class="line"></span><span class="token prefix unchanged"> </span><span class="token line">       previousNewFiber.sibling = newFiber;</span>
<span class="line"></span><span class="token prefix unchanged"> </span><span class="token line">     }</span>
<span class="line"></span><span class="token prefix unchanged"> </span><span class="token line">     previousNewFiber = newFiber;</span>
<span class="line"></span><span class="token prefix unchanged"> </span><span class="token line">   }</span>
<span class="line"></span><span class="token prefix unchanged"> </span><span class="token line">   return resultingFirstChild;</span>
<span class="line"></span><span class="token prefix unchanged"> </span><span class="token line"> }</span>
<span class="line"></span></span></span>
<span class="line"><span class="token inserted-sign inserted"><span class="token prefix inserted">+</span><span class="token line">  //将剩下的老fiber放入map中</span>
<span class="line"></span><span class="token prefix inserted">+</span><span class="token line">  const existingChildren = mapRemainingChildren(returnFiber, oldFiber);</span>
<span class="line"></span><span class="token prefix inserted">+</span><span class="token line">  for (; newIdx &lt; newChildren.length; newIdx++) {</span>
<span class="line"></span><span class="token prefix inserted">+</span><span class="token line">    //去map中找找有没key相同并且类型相同可以复用的老fiber 老真实DOM</span>
<span class="line"></span><span class="token prefix inserted">+</span><span class="token line">    const newFiber = updateFromMap(existingChildren, returnFiber, newIdx, newChildren[newIdx]);</span>
<span class="line"></span><span class="token prefix inserted">+</span><span class="token line">  }</span>
<span class="line"></span></span>}</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>生成map</p><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code class="language-javascript"><span class="line"><span class="token keyword">function</span> <span class="token function">mapRemainingChildren</span><span class="token punctuation">(</span><span class="token parameter">returnFiber<span class="token punctuation">,</span> currentFirstChild</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">  <span class="token keyword">const</span> existingChildren <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Map</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">  <span class="token keyword">let</span> existingChild <span class="token operator">=</span> currentFirstChild<span class="token punctuation">;</span></span>
<span class="line">  <span class="token keyword">while</span> <span class="token punctuation">(</span>existingChild<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">let</span> key <span class="token operator">=</span> existingChild<span class="token punctuation">.</span>key <span class="token operator">||</span> existingChild<span class="token punctuation">.</span>index<span class="token punctuation">;</span></span>
<span class="line">    existingChildren<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> existingChild<span class="token punctuation">)</span></span>
<span class="line">    existingChild <span class="token operator">=</span> existingChild<span class="token punctuation">.</span>sibling<span class="token punctuation">;</span></span>
<span class="line">  <span class="token punctuation">}</span></span>
<span class="line">  <span class="token keyword">return</span> existingChildren<span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>从map中去找到可以复用的fiber</p><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code class="language-javascript"><span class="line"><span class="token keyword">function</span> <span class="token function">updateFromMap</span><span class="token punctuation">(</span><span class="token parameter">existingChildren<span class="token punctuation">,</span> returnFiber<span class="token punctuation">,</span> newIdx<span class="token punctuation">,</span> newChild</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">  <span class="token keyword">const</span> matchedFiber <span class="token operator">=</span> existingChildren<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>newChild<span class="token punctuation">.</span>key <span class="token operator">||</span> newIdx<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">  <span class="token keyword">return</span> <span class="token function">updateElement</span><span class="token punctuation">(</span>returnFiber<span class="token punctuation">,</span> matchedFiber<span class="token punctuation">,</span> newChild<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>接着就看下是否能在map中找到可以复用的，把老fiber从map中删除，找不到的话则创建新的fiber节点。</p><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code class="language-javascript"><span class="line"><span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token punctuation">;</span> newIdx <span class="token operator">&lt;</span> newChildren<span class="token punctuation">.</span>length<span class="token punctuation">;</span> newIdx<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">  <span class="token comment">//去map中找找有没key相同并且类型相同可以复用的老fiber 老真实DOM</span></span>
<span class="line">  <span class="token keyword">const</span> newFiber <span class="token operator">=</span> <span class="token function">updateFromMap</span><span class="token punctuation">(</span>existingChildren<span class="token punctuation">,</span> returnFiber<span class="token punctuation">,</span> newIdx<span class="token punctuation">,</span> newChildren<span class="token punctuation">[</span>newIdx<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">  <span class="token keyword">if</span> <span class="token punctuation">(</span>newFiber<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token comment">//说明是复用的老fiber</span></span>
<span class="line">    <span class="token keyword">if</span> <span class="token punctuation">(</span>newFiber<span class="token punctuation">.</span>alternate<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">      existingChildren<span class="token punctuation">.</span><span class="token function">delete</span><span class="token punctuation">(</span>newFiber<span class="token punctuation">.</span>key <span class="token operator">||</span> newIdx<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    lastPlacedIndex <span class="token operator">=</span> <span class="token function">placeChild</span><span class="token punctuation">(</span>newFiber<span class="token punctuation">,</span> lastPlacedIndex<span class="token punctuation">,</span> newIdx<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>previousNewFiber<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">      resultingFirstChild <span class="token operator">=</span> newFiber<span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span></span>
<span class="line">      previousNewFiber<span class="token punctuation">.</span>sibling <span class="token operator">=</span> newFiber<span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    previousNewFiber <span class="token operator">=</span> newFiber<span class="token punctuation">;</span></span>
<span class="line">  <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>lastPlacedIndex = placeChild(newFiber, lastPlacedIndex, newIdx);这个是比较关键的，newFiber.alternate有值，说明是可以复用的老fiber,需要放置该fiber节点，改造下placeChild方法，之前的代码是这样的：</p><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code class="language-javascript"><span class="line"><span class="token keyword">function</span> <span class="token function">placeChild</span><span class="token punctuation">(</span><span class="token parameter">newFiber<span class="token punctuation">,</span> newIdx</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">  newFiber<span class="token punctuation">.</span>index <span class="token operator">=</span> newIdx<span class="token punctuation">;</span></span>
<span class="line">  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>shouldTrackSideEffects<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">return</span><span class="token punctuation">;</span></span>
<span class="line">  <span class="token punctuation">}</span></span>
<span class="line">  <span class="token keyword">const</span> current <span class="token operator">=</span> newFiber<span class="token punctuation">.</span>alternate<span class="token punctuation">;</span></span>
<span class="line">  <span class="token comment">//如果有current说是更新，复用老节点的更新，不会添加Placement</span></span>
<span class="line">  <span class="token keyword">if</span> <span class="token punctuation">(</span>current<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token comment">// TODO</span></span>
<span class="line">  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span></span>
<span class="line">    newFiber<span class="token punctuation">.</span>flags <span class="token operator">=</span> Placement<span class="token punctuation">;</span></span>
<span class="line">  <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>改造后的逻辑如下：</p><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code class="language-javascript"><span class="line"><span class="token keyword">function</span> <span class="token function">placeChild</span><span class="token punctuation">(</span><span class="token parameter">newFiber<span class="token punctuation">,</span> lastPlacedIndex<span class="token punctuation">,</span> newIdx</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">  newFiber<span class="token punctuation">.</span>index <span class="token operator">=</span> newIdx<span class="token punctuation">;</span></span>
<span class="line">  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>shouldTrackSideEffects<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">return</span> lastPlacedIndex<span class="token punctuation">;</span></span>
<span class="line">  <span class="token punctuation">}</span></span>
<span class="line">  <span class="token keyword">const</span> current <span class="token operator">=</span> newFiber<span class="token punctuation">.</span>alternate<span class="token punctuation">;</span></span>
<span class="line">  <span class="token comment">//如果有current说是更新，复用老节点的更新，不会添加Placement</span></span>
<span class="line">  <span class="token keyword">if</span> <span class="token punctuation">(</span>current<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">const</span> oldIndex <span class="token operator">=</span> current<span class="token punctuation">.</span>index<span class="token punctuation">;</span></span>
<span class="line">    <span class="token comment">//如果老fiber它对应的真实DOM挂载的索引比lastPlacedIndex小</span></span>
<span class="line">    <span class="token keyword">if</span> <span class="token punctuation">(</span>oldIndex <span class="token operator">&lt;</span> lastPlacedIndex<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">      <span class="token comment">//老fiber对应的真实DOM就需要移动了</span></span>
<span class="line">      newFiber<span class="token punctuation">.</span>flags <span class="token operator">|=</span> Placement<span class="token punctuation">;</span></span>
<span class="line">      <span class="token keyword">return</span> lastPlacedIndex<span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span></span>
<span class="line">      <span class="token comment">//否则 不需要移动 并且把老fiber它的原来的挂载索引返回成为新的lastPlacedIndex</span></span>
<span class="line">      <span class="token keyword">return</span> oldIndex<span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span></span>
<span class="line">    newFiber<span class="token punctuation">.</span>flags <span class="token operator">=</span> Placement<span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">return</span> lastPlacedIndex<span class="token punctuation">;</span></span>
<span class="line">  <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>之前placeChild用到的地方也做出相应的修改；在复用老的fiber的时候，要老fiber节点的索引与lastPlacedIndex做比较：</p><ul><li>如果小于lastPlacedIndex则需要移动老的fiber, lastPlacedIndex不变</li><li>如果大于lastPlacedIndex则不需要移动老的fiber，更新lastPlacedIndex为老fiber的index</li></ul><p>C在map中能找到，C的索引是2，lastPlacedIndex默认是0，则C是不用移动的，更新lastPlacedIndex为2；同理E也是能在map中找到，也不用移动，E的老索引是4，则更新lastPlacedIndex为4；到B的时候，B的老fiber索引为1，此时lastPlacedIndex为4，那就标记B为移动，lastPlacedIndex不变；到G的时候，在map中找不到可以复用的节点，那就标记为插入；到D的时候，D的老fiber索引为3，lastPlacedIndex为4，标记D为移动，lastPlacedIndex不变,仍然为4。</p><p>到这里，新fiber遍历结束了，但是老fiber中的F是没用到的，那就需要把F给删除。那就是在虚拟DOM循环结束后把Map中的所有的剩下的fiber全部标记为删除。</p><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code class="language-javascript"><span class="line"><span class="token comment">//map中剩下是没有被 复用的，全部删除</span></span>
<span class="line">existingChildren<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">child</span> <span class="token operator">=&gt;</span> <span class="token function">deleteChild</span><span class="token punctuation">(</span>returnFiber<span class="token punctuation">,</span> child<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div></div></div><p>完整的代码如下：</p><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code class="language-javascript"><span class="line"><span class="token keyword">function</span> <span class="token function">reconcileChildrenArray</span><span class="token punctuation">(</span><span class="token parameter">returnFiber<span class="token punctuation">,</span> currentFirstChild<span class="token punctuation">,</span> newChildren</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">  <span class="token comment">//将要返回的第一个新fiber</span></span>
<span class="line">  <span class="token keyword">let</span> resultingFirstChild <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span></span>
<span class="line">  <span class="token comment">//上一个新fiber</span></span>
<span class="line">  <span class="token keyword">let</span> previousNewFiber <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span></span>
<span class="line">  <span class="token comment">//当前的老fiber</span></span>
<span class="line">  <span class="token keyword">let</span> oldFiber <span class="token operator">=</span> currentFirstChild<span class="token punctuation">;</span></span>
<span class="line">  <span class="token comment">//新的虚拟DOM的索引</span></span>
<span class="line">  <span class="token keyword">let</span> newIdx <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span></span>
<span class="line">  <span class="token comment">// 下一个老fiber</span></span>
<span class="line">  <span class="token keyword">let</span> nextOldFiber <span class="token operator">=</span> <span class="token keyword">null</span></span>
<span class="line">  <span class="token comment">// 指的上一个可以复用的，不需要移动的节点的老索引</span></span>
<span class="line">  <span class="token keyword">let</span> lastPlacedIndex <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span></span>
<span class="line">  <span class="token comment">//处理更新的情况 老fiber和新fiber都存在</span></span>
<span class="line">  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token punctuation">;</span> oldFiber <span class="token operator">&amp;&amp;</span> newIdx <span class="token operator">&lt;</span> newChildren<span class="token punctuation">.</span>length<span class="token punctuation">;</span> newIdx<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token comment">//先缓存下一个老fiber</span></span>
<span class="line">    nextOldFiber <span class="token operator">=</span> oldFiber<span class="token punctuation">.</span>sibling<span class="token punctuation">;</span></span>
<span class="line">    <span class="token comment">//试图复用才fiber</span></span>
<span class="line">    <span class="token keyword">const</span> newFiber <span class="token operator">=</span> <span class="token function">updateSlot</span><span class="token punctuation">(</span>returnFiber<span class="token punctuation">,</span> oldFiber<span class="token punctuation">,</span> newChildren<span class="token punctuation">[</span>newIdx<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token comment">//如果key 不一样，直接跳出第一轮循环</span></span>
<span class="line">    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>newFiber<span class="token punctuation">)</span></span>
<span class="line">      <span class="token keyword">break</span><span class="token punctuation">;</span> <span class="token comment">//跳出第一轮循环</span></span>
<span class="line">    <span class="token comment">//老fiber存在，但是新的fiber并没有复用老fiber</span></span>
<span class="line">    <span class="token keyword">if</span> <span class="token punctuation">(</span>oldFiber <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>newFiber<span class="token punctuation">.</span>alternate<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">      <span class="token function">deleteChild</span><span class="token punctuation">(</span>returnFiber<span class="token punctuation">,</span> oldFiber<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    <span class="token comment">//核心是给当前的newFiber添加一个副作用flags 叫新增</span></span>
<span class="line">    lastPlacedIndex <span class="token operator">=</span> <span class="token function">placeChild</span><span class="token punctuation">(</span>newFiber<span class="token punctuation">,</span> lastPlacedIndex<span class="token punctuation">,</span> newIdx<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>previousNewFiber<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">      resultingFirstChild <span class="token operator">=</span> newFiber<span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span></span>
<span class="line">      previousNewFiber<span class="token punctuation">.</span>sibling <span class="token operator">=</span> newFiber<span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    previousNewFiber <span class="token operator">=</span> newFiber<span class="token punctuation">;</span></span>
<span class="line">    oldFiber <span class="token operator">=</span> nextOldFiber<span class="token punctuation">;</span></span>
<span class="line">  <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">  <span class="token keyword">if</span> <span class="token punctuation">(</span>newIdx <span class="token operator">===</span> newChildren<span class="token punctuation">.</span>length<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token function">deleteRemainingChildren</span><span class="token punctuation">(</span>returnFiber<span class="token punctuation">,</span> oldFiber<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">return</span> resultingFirstChild<span class="token punctuation">;</span></span>
<span class="line">  <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">  <span class="token comment">// 如果没有老fiber</span></span>
<span class="line">  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>oldFiber<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token comment">// 循环虚拟DOM数组， 为每个虚拟DOM创建一个新的fiber</span></span>
<span class="line">    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token punctuation">;</span> newIdx <span class="token operator">&lt;</span> newChildren<span class="token punctuation">.</span>length<span class="token punctuation">;</span> newIdx<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">      <span class="token keyword">const</span> newFiber <span class="token operator">=</span> <span class="token function">createChild</span><span class="token punctuation">(</span>returnFiber<span class="token punctuation">,</span> newChildren<span class="token punctuation">[</span>newIdx<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//li(A) =&gt;li(B)=&gt; li(C)</span></span>
<span class="line">      <span class="token comment">// newFiber.flags = Placement</span></span>
<span class="line">      lastPlacedIndex <span class="token operator">=</span> <span class="token function">placeChild</span><span class="token punctuation">(</span>newFiber<span class="token punctuation">,</span> lastPlacedIndex<span class="token punctuation">,</span> newIdx<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>previousNewFiber<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        resultingFirstChild <span class="token operator">=</span> newFiber<span class="token punctuation">;</span><span class="token comment">//resultingFirstChild=&gt;li(A)</span></span>
<span class="line">      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span></span>
<span class="line">        previousNewFiber<span class="token punctuation">.</span>sibling <span class="token operator">=</span> newFiber<span class="token punctuation">;</span><span class="token comment">//liA.sibling=li(B) =&gt; liB.sibling=li(C)</span></span>
<span class="line">      <span class="token punctuation">}</span></span>
<span class="line">      previousNewFiber <span class="token operator">=</span> newFiber<span class="token punctuation">;</span><span class="token comment">//previousNewFiber=&gt;li(A)=&gt;li(B) =&gt; li(C)</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    <span class="token keyword">return</span> resultingFirstChild<span class="token punctuation">;</span></span>
<span class="line">  <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">  <span class="token comment">//将剩下的老fiber放入map中</span></span>
<span class="line">  <span class="token keyword">const</span> existingChildren <span class="token operator">=</span> <span class="token function">mapRemainingChildren</span><span class="token punctuation">(</span>returnFiber<span class="token punctuation">,</span> oldFiber<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token punctuation">;</span> newIdx <span class="token operator">&lt;</span> newChildren<span class="token punctuation">.</span>length<span class="token punctuation">;</span> newIdx<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token comment">//去map中找找有没key相同并且类型相同可以复用的老fiber 老真实DOM</span></span>
<span class="line">    <span class="token keyword">const</span> newFiber <span class="token operator">=</span> <span class="token function">updateFromMap</span><span class="token punctuation">(</span>existingChildren<span class="token punctuation">,</span> returnFiber<span class="token punctuation">,</span> newIdx<span class="token punctuation">,</span> newChildren<span class="token punctuation">[</span>newIdx<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">if</span> <span class="token punctuation">(</span>newFiber<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">      <span class="token comment">//说明是复用的老fiber</span></span>
<span class="line">      <span class="token keyword">if</span> <span class="token punctuation">(</span>newFiber<span class="token punctuation">.</span>alternate<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        existingChildren<span class="token punctuation">.</span><span class="token function">delete</span><span class="token punctuation">(</span>newFiber<span class="token punctuation">.</span>key <span class="token operator">||</span> newIdx<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">      <span class="token punctuation">}</span></span>
<span class="line">      lastPlacedIndex <span class="token operator">=</span> <span class="token function">placeChild</span><span class="token punctuation">(</span>newFiber<span class="token punctuation">,</span> lastPlacedIndex<span class="token punctuation">,</span> newIdx<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>previousNewFiber<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        resultingFirstChild <span class="token operator">=</span> newFiber<span class="token punctuation">;</span><span class="token comment">//resultingFirstChild=&gt;li(A)</span></span>
<span class="line">      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span></span>
<span class="line">        previousNewFiber<span class="token punctuation">.</span>sibling <span class="token operator">=</span> newFiber<span class="token punctuation">;</span><span class="token comment">//liB.sibling=li(C)</span></span>
<span class="line">      <span class="token punctuation">}</span></span>
<span class="line">      previousNewFiber <span class="token operator">=</span> newFiber<span class="token punctuation">;</span><span class="token comment">//previousNewFiber=&gt;li(C)</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">  <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">  <span class="token comment">//map中剩下是没有被 复用的，全部删除</span></span>
<span class="line">  existingChildren<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">child</span> <span class="token operator">=&gt;</span> <span class="token function">deleteChild</span><span class="token punctuation">(</span>returnFiber<span class="token punctuation">,</span> child<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">  <span class="token keyword">return</span> resultingFirstChild<span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>reconcileChildrenArray这个方法是DOM DIFF的核心所在，看下运行结果：</p><p><img src="https://gitee.com/yutao618/images/raw/master/images/20211215184014.png" alt=""></p><ul><li><a href="https://gitee.com/yutao618/react-dom-diff" target="_blank" rel="noopener noreferrer">git地址</a></li></ul><p>到此，DOM DIFF基本结束，其实fiber中有一个调度的过程，根据渲染更新优先级，根据浏览器的响应速度来调度fiber,后面会从这个角度再来看下fiber。</p></div><!--[--><!--]--></div><footer class="vp-page-meta"><div class="vp-meta-item edit-link"><a class="auto-link external-link label" href="https://github.com/yutao721/note/edit/main/web/react/3.md" aria-label="Edit this page" rel="noopener noreferrer" target="_blank"><!--[--><!--[--><svg class="edit-icon" viewbox="0 0 1024 1024"><g fill="currentColor"><path d="M430.818 653.65a60.46 60.46 0 0 1-50.96-93.281l71.69-114.012 7.773-10.365L816.038 80.138A60.46 60.46 0 0 1 859.225 62a60.46 60.46 0 0 1 43.186 18.138l43.186 43.186a60.46 60.46 0 0 1 0 86.373L588.879 565.55l-8.637 8.637-117.466 68.234a60.46 60.46 0 0 1-31.958 11.229z"></path><path d="M728.802 962H252.891A190.883 190.883 0 0 1 62.008 771.98V296.934a190.883 190.883 0 0 1 190.883-192.61h267.754a60.46 60.46 0 0 1 0 120.92H252.891a69.962 69.962 0 0 0-69.098 69.099V771.98a69.962 69.962 0 0 0 69.098 69.098h475.911A69.962 69.962 0 0 0 797.9 771.98V503.363a60.46 60.46 0 1 1 120.922 0V771.98A190.883 190.883 0 0 1 728.802 962z"></path></g></svg><!--]--><!--]-->Edit this page<!--[--><!--[--><!--]--><!--]--></a></div><div class="vp-meta-item git-info"><div class="vp-meta-item last-updated"><span class="meta-item-label">Last Updated: </span><time class="meta-item-info" datetime="2021-12-17T01:43:03.000Z" data-allow-mismatch>12/17/21, 9:43 AM</time></div><div class="vp-meta-item contributors"><span class="meta-item-label">Contributors: </span><span class="meta-item-info"><!--[--><!--[--><span class="contributor" title="email: 642231346@qq.com">yutao</span><!----><!--]--><!--]--></span></div></div></footer><nav class="vp-page-nav" aria-label="page navigation"><a class="route-link auto-link prev" href="/note/web/react/2.html" aria-label="react单节点diff"><!--[--><div class="hint"><span class="arrow left"></span> Prev</div><div class="link"><span class="external-link">react单节点diff</span></div><!--]--></a><!----></nav><!--[--><!--]--></main><!--]--></div><!--[--><!----><!--]--><!--]--></div>
    <script type="module" src="/note/assets/app-CD1YpnS1.js" defer></script>
  </body>
</html>
