<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>react Dom-diff之多节点 | jiaHang的博客</title>
    <meta name="generator" content="VuePress 1.5.0">
    
    <meta name="description" content="专注前端技术栈分享，做一个爱折腾的前端">
    <link rel="preload" href="/note/assets/css/0.styles.725ed339.css" as="style"><link rel="preload" href="/note/assets/js/app.02190172.js" as="script"><link rel="preload" href="/note/assets/js/2.2dccd611.js" as="script"><link rel="preload" href="/note/assets/js/28.3bb3b4b8.js" as="script"><link rel="prefetch" href="/note/assets/js/10.a05513c9.js"><link rel="prefetch" href="/note/assets/js/11.7ceb6923.js"><link rel="prefetch" href="/note/assets/js/12.fb88bae4.js"><link rel="prefetch" href="/note/assets/js/13.4b17ba74.js"><link rel="prefetch" href="/note/assets/js/14.ce1cd100.js"><link rel="prefetch" href="/note/assets/js/15.6a480c60.js"><link rel="prefetch" href="/note/assets/js/16.6d6b8a6a.js"><link rel="prefetch" href="/note/assets/js/17.c36721ad.js"><link rel="prefetch" href="/note/assets/js/18.77bcea9f.js"><link rel="prefetch" href="/note/assets/js/19.f262839a.js"><link rel="prefetch" href="/note/assets/js/20.5b1b9830.js"><link rel="prefetch" href="/note/assets/js/21.76b74656.js"><link rel="prefetch" href="/note/assets/js/22.e663cec2.js"><link rel="prefetch" href="/note/assets/js/23.c1f1c7e7.js"><link rel="prefetch" href="/note/assets/js/24.5ddffc93.js"><link rel="prefetch" href="/note/assets/js/25.95b0061c.js"><link rel="prefetch" href="/note/assets/js/26.c4c127de.js"><link rel="prefetch" href="/note/assets/js/27.234a7f7e.js"><link rel="prefetch" href="/note/assets/js/29.1339c108.js"><link rel="prefetch" href="/note/assets/js/3.6e8c2ef0.js"><link rel="prefetch" href="/note/assets/js/30.3235f9a2.js"><link rel="prefetch" href="/note/assets/js/31.2a4efe07.js"><link rel="prefetch" href="/note/assets/js/32.d3d3c893.js"><link rel="prefetch" href="/note/assets/js/33.eaca5eef.js"><link rel="prefetch" href="/note/assets/js/34.684f8bf3.js"><link rel="prefetch" href="/note/assets/js/35.c486c7ec.js"><link rel="prefetch" href="/note/assets/js/36.2f90f872.js"><link rel="prefetch" href="/note/assets/js/37.92460be1.js"><link rel="prefetch" href="/note/assets/js/38.8532070d.js"><link rel="prefetch" href="/note/assets/js/39.9cc3b3d9.js"><link rel="prefetch" href="/note/assets/js/4.2b7fc900.js"><link rel="prefetch" href="/note/assets/js/40.3ec1b99e.js"><link rel="prefetch" href="/note/assets/js/41.d22f0de1.js"><link rel="prefetch" href="/note/assets/js/42.4796d96b.js"><link rel="prefetch" href="/note/assets/js/43.4c97d146.js"><link rel="prefetch" href="/note/assets/js/44.6e02569c.js"><link rel="prefetch" href="/note/assets/js/5.bb5b8508.js"><link rel="prefetch" href="/note/assets/js/6.ec170bea.js"><link rel="prefetch" href="/note/assets/js/7.12a33526.js"><link rel="prefetch" href="/note/assets/js/8.70ad78c1.js"><link rel="prefetch" href="/note/assets/js/9.b2f872fe.js">
    <link rel="stylesheet" href="/note/assets/css/0.styles.725ed339.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/note/" class="home-link router-link-active"><!----> <span class="site-name">jiaHang的博客</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/note/" class="nav-link">
  主页
</a></div><div class="nav-item"><a href="/note/web/" class="nav-link router-link-active">
  前端
</a></div><div class="nav-item"><a href="/note/node/" class="nav-link">
  node
</a></div><div class="nav-item"><a href="/note/interview/" class="nav-link">
  面试问题
</a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/note/" class="nav-link">
  主页
</a></div><div class="nav-item"><a href="/note/web/" class="nav-link router-link-active">
  前端
</a></div><div class="nav-item"><a href="/note/node/" class="nav-link">
  node
</a></div><div class="nav-item"><a href="/note/interview/" class="nav-link">
  面试问题
</a></div> <!----></nav>  <ul class="sidebar-links"><li><a href="/note/web/" aria-current="page" class="sidebar-link">前端</a></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>JavaScript</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>css</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>ES6</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>vue</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>react</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/note/web/react/" aria-current="page" class="sidebar-link">目录</a></li><li><a href="/note/web/react/1.html" class="sidebar-link">react初次渲染</a></li><li><a href="/note/web/react/2.html" class="sidebar-link">react单节点diff</a></li><li><a href="/note/web/react/3.html" aria-current="page" class="active sidebar-link">react多节点diff</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/note/web/react/3.html#react-dom-diff之多节点" class="sidebar-link">react Dom-diff之多节点</a></li></ul></li></ul></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>webpack</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>rollup</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>小程序</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>调试</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>其他</span> <span class="arrow right"></span></p> <!----></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h2 id="react-dom-diff之多节点"><a href="#react-dom-diff之多节点" class="header-anchor">#</a> react Dom-diff之多节点</h2> <p>react中DOM DIFF的三个规则</p> <ul><li>只对同级元素进行比较，不同层级不比较</li> <li>不同的类型对应不同的元素</li> <li>可以通过key来标识同一个节点</li></ul> <p>react中DOM DIFF的遍历规则</p> <ul><li><p>第一轮</p> <ul><li>如果key不同，则直接结束本轮循环</li> <li>newChildren和oldFiber遍历完，结束本轮循环</li> <li>key相同而type不同，标记老的oldFiber为删除，继续循环</li> <li>key相同type相同，则可以复用老节点（oldFiber）,继续循环</li></ul></li> <li><p>第二轮</p> <ul><li>newChildren遍历完而oldFiber还有，遍历剩下的所有oldFiber标记为删除，DIFF结束</li> <li>oldFiber遍历完了，而newChildren还有，将剩下的newChildren标记为插入，DIFF结束</li> <li>newChildren和oldFiber都同时遍历完，DIFF结束</li> <li>newChildren和oldFiber都没有完成，则进行节点移动的逻辑</li></ul></li> <li><p>第三轮</p> <ul><li>处理节点移动的情况</li></ul></li></ul> <h3 id="多个节点的数量和key相同，有的type不同"><a href="#多个节点的数量和key相同，有的type不同" class="header-anchor">#</a> 多个节点的数量和key相同，有的type不同</h3> <p><img src="https://gitee.com/yutao618/images/raw/master/images/20211215104611.png" alt=""></p> <p>如上图所示，多个节点的数量和key相同，有的type不同。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">/**
 * 如果新的虚拟DOM是一个数组的话， 也就是说有多个儿子的话
 * @param {*} returnFiber ui
 * @param {*} currentFirstChild null
 * @param {*} newChild [liA,liB,liC]
 */</span>
<span class="token keyword">function</span> <span class="token function">reconcileChildrenArray</span><span class="token punctuation">(</span><span class="token parameter">returnFiber<span class="token punctuation">,</span> currentFirstChild<span class="token punctuation">,</span> newChildren</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">//将要返回的第一个新fiber</span>
  <span class="token keyword">let</span> resultingFirstChild <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
  <span class="token comment">//上一个新fiber</span>
  <span class="token keyword">let</span> previousNewFiber <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
  <span class="token comment">//当前的老fiber</span>
  <span class="token keyword">let</span> oldFiber <span class="token operator">=</span> currentFirstChild<span class="token punctuation">;</span>
  <span class="token comment">//新的虚拟DOM的索引</span>
  <span class="token keyword">let</span> newIdx <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
  <span class="token comment">// 如果没有老fiber,也就是初次挂载的时候</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>oldFiber<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 循环虚拟DOM数组， 为每个虚拟DOM创建一个新的fiber</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token punctuation">;</span> newIdx <span class="token operator">&lt;</span> newChildren<span class="token punctuation">.</span>length<span class="token punctuation">;</span> newIdx<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> newFiber <span class="token operator">=</span> <span class="token function">createChild</span><span class="token punctuation">(</span>returnFiber<span class="token punctuation">,</span> newChildren<span class="token punctuation">[</span>newIdx<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//li(A) =&gt;li(B)=&gt; li(C)</span>
      <span class="token comment">// newFiber.flags = Placement</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>previousNewFiber<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        resultingFirstChild <span class="token operator">=</span> newFiber<span class="token punctuation">;</span><span class="token comment">//resultingFirstChild=&gt;li(A)</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        previousNewFiber<span class="token punctuation">.</span>sibling <span class="token operator">=</span> newFiber<span class="token punctuation">;</span><span class="token comment">//liA.sibling=li(B) =&gt; liB.sibling=li(C)</span>
      <span class="token punctuation">}</span>
      previousNewFiber <span class="token operator">=</span> newFiber<span class="token punctuation">;</span><span class="token comment">//previousNewFiber=&gt;li(A)=&gt;li(B) =&gt; li(C)</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> resultingFirstChild<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>这个是之前reconcileChildrenArray处理没有oldFiber的情况，现在做其他情况的处理</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">reconcileChildrenArray</span><span class="token punctuation">(</span><span class="token parameter">returnFiber<span class="token punctuation">,</span> currentFirstChild<span class="token punctuation">,</span> newChildren</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">//将要返回的第一个新fiber</span>
  <span class="token keyword">let</span> resultingFirstChild <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
  <span class="token comment">//上一个新fiber</span>
  <span class="token keyword">let</span> previousNewFiber <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
  <span class="token comment">//当前的老fiber</span>
  <span class="token keyword">let</span> oldFiber <span class="token operator">=</span> currentFirstChild<span class="token punctuation">;</span>
  <span class="token comment">//新的虚拟DOM的索引</span>
  <span class="token keyword">let</span> newIdx <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
  
  <span class="token comment">// +++++++++++++++++++++++++++++++++++++++++++++++++</span>
  
  <span class="token comment">//下一个老fiber</span>
  <span class="token keyword">let</span> nextOldFiber <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
  <span class="token comment">//处理更新的情况 老fiber和新fiber都存在</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token punctuation">;</span> oldFiber <span class="token operator">&amp;&amp;</span> newIdx <span class="token operator">&lt;</span> newChildren<span class="token punctuation">.</span>length<span class="token punctuation">;</span> newIdx<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">//先缓存下一个老fiber</span>
      nextOldFiber <span class="token operator">=</span> oldFiber<span class="token punctuation">.</span>sibling<span class="token punctuation">;</span>
      <span class="token comment">//试图复用老fiber</span>
      <span class="token keyword">const</span> newFiber <span class="token operator">=</span> <span class="token function">updateSlot</span><span class="token punctuation">(</span>returnFiber<span class="token punctuation">,</span> oldFiber<span class="token punctuation">,</span> newChildren<span class="token punctuation">[</span>newIdx<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">//如果key 不一样，直接跳出第一轮循环</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>newFiber<span class="token punctuation">)</span>
        <span class="token keyword">break</span><span class="token punctuation">;</span> <span class="token comment">// 跳出第一轮循环</span>
      <span class="token comment">//老fiber存在，但是新的fiber并没有复用老fiber</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>oldFiber <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>newFiber<span class="token punctuation">.</span>alternate<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">deleteChild</span><span class="token punctuation">(</span>returnFiber<span class="token punctuation">,</span> oldFiber<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token comment">//核心是给当前的newFiber添加一个副作用flags 叫新增</span>
      <span class="token function">placeChild</span><span class="token punctuation">(</span>newFiber<span class="token punctuation">,</span> lastPlacedIndex<span class="token punctuation">,</span> newIdx<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>previousNewFiber<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        resultingFirstChild <span class="token operator">=</span> newFiber<span class="token punctuation">;</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        previousNewFiber<span class="token punctuation">.</span>sibling <span class="token operator">=</span> newFiber<span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      previousNewFiber <span class="token operator">=</span> newFiber<span class="token punctuation">;</span>
      oldFiber <span class="token operator">=</span> nextOldFiber<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  
  <span class="token comment">// +++++++++++++++++++++++++++++++++++++++++++++++++</span>
  
  <span class="token comment">// 如果没有老fiber,也就是初次挂载的时候</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>oldFiber<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 循环虚拟DOM数组， 为每个虚拟DOM创建一个新的fiber</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token punctuation">;</span> newIdx <span class="token operator">&lt;</span> newChildren<span class="token punctuation">.</span>length<span class="token punctuation">;</span> newIdx<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> newFiber <span class="token operator">=</span> <span class="token function">createChild</span><span class="token punctuation">(</span>returnFiber<span class="token punctuation">,</span> newChildren<span class="token punctuation">[</span>newIdx<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//li(A) =&gt;li(B)=&gt; li(C)</span>
      <span class="token comment">// newFiber.flags = Placement</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>previousNewFiber<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        resultingFirstChild <span class="token operator">=</span> newFiber<span class="token punctuation">;</span><span class="token comment">//resultingFirstChild=&gt;li(A)</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        previousNewFiber<span class="token punctuation">.</span>sibling <span class="token operator">=</span> newFiber<span class="token punctuation">;</span><span class="token comment">//liA.sibling=li(B) =&gt; liB.sibling=li(C)</span>
      <span class="token punctuation">}</span>
      previousNewFiber <span class="token operator">=</span> newFiber<span class="token punctuation">;</span><span class="token comment">//previousNewFiber=&gt;li(A)=&gt;li(B) =&gt; li(C)</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> resultingFirstChild<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>updateSlot试图复用老fiber</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">updateSlot</span><span class="token punctuation">(</span><span class="token parameter">returnFiber<span class="token punctuation">,</span> oldFiber<span class="token punctuation">,</span> newChild</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> key <span class="token operator">=</span> oldFiber <span class="token operator">?</span> oldFiber<span class="token punctuation">.</span>key <span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
  <span class="token comment">//如果新的虚拟DOM的key和老fiber的key一样</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>newChild<span class="token punctuation">.</span>key <span class="token operator">===</span> key<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token function">updateElement</span><span class="token punctuation">(</span>returnFiber<span class="token punctuation">,</span> oldFiber<span class="token punctuation">,</span> newChild<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token comment">//如果key不一样，直接结束返回null</span>
    <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>更新元素</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">updateElement</span><span class="token punctuation">(</span><span class="token parameter">returnFiber<span class="token punctuation">,</span> oldFiber<span class="token punctuation">,</span> newChild</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>oldFiber<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>oldFiber<span class="token punctuation">.</span>type <span class="token operator">===</span> newChild<span class="token punctuation">.</span>type<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> existing <span class="token operator">=</span> <span class="token function">useFiber</span><span class="token punctuation">(</span>oldFiber<span class="token punctuation">,</span> newChild<span class="token punctuation">.</span>props<span class="token punctuation">)</span><span class="token punctuation">;</span>
      existing<span class="token punctuation">.</span>return <span class="token operator">=</span> returnFiber<span class="token punctuation">;</span>
      <span class="token keyword">return</span> existing<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  <span class="token comment">//如果没有老fiber</span>
  <span class="token keyword">const</span> created <span class="token operator">=</span> <span class="token function">createFiberFromElement</span><span class="token punctuation">(</span>newChild<span class="token punctuation">)</span><span class="token punctuation">;</span>
  created<span class="token punctuation">.</span>return <span class="token operator">=</span> returnFiber<span class="token punctuation">;</span>
  <span class="token keyword">return</span> created<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">placeChild</span><span class="token punctuation">(</span><span class="token parameter">newFiber<span class="token punctuation">,</span> lastPlacedIndex<span class="token punctuation">,</span> newIdx</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  newFiber<span class="token punctuation">.</span>index <span class="token operator">=</span> newIdx<span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>shouldTrackSideEffects<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">const</span> current <span class="token operator">=</span> newFiber<span class="token punctuation">.</span>alternate<span class="token punctuation">;</span>
  <span class="token comment">//如果有current说是更新，复用老节点的更新，不会添加Placement</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>current<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// TODO</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    newFiber<span class="token punctuation">.</span>flags <span class="token operator">=</span> Placement<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>目前完整的reconcileChildrenArray代码逻辑如下，加了老fiber和新fiber都存在的处理逻辑，按照li(A),li(B),li(C)到li(A),p(B),li(C)的更新逻辑，li(A)通过updateSlot的处理，是可以复用的，updateElement就是处理更新或者创建fiber;li(B)的时候updateSlot返回了新创建的p(B)，并且需要删除li(B),oldFiber &amp;&amp; !newFiber.alternate这种情况就符合了li(B)的情况，placeChild就是把p(B)标记为插入；li(C)的情况和li(A)一样。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">reconcileChildrenArray</span><span class="token punctuation">(</span><span class="token parameter">returnFiber<span class="token punctuation">,</span> currentFirstChild<span class="token punctuation">,</span> newChildren</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">//将要返回的第一个新fiber</span>
  <span class="token keyword">let</span> resultingFirstChild <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
  <span class="token comment">//上一个新fiber</span>
  <span class="token keyword">let</span> previousNewFiber <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
  <span class="token comment">//当前的老fiber</span>
  <span class="token keyword">let</span> oldFiber <span class="token operator">=</span> currentFirstChild<span class="token punctuation">;</span>
  <span class="token comment">//新的虚拟DOM的索引</span>
  <span class="token keyword">let</span> newIdx <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
  <span class="token comment">// 下一个老fiber</span>
  <span class="token keyword">let</span> nextOldFiber <span class="token operator">=</span> <span class="token keyword">null</span>
  <span class="token comment">//处理更新的情况 老fiber和新fiber都存在</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token punctuation">;</span> oldFiber <span class="token operator">&amp;&amp;</span> newIdx <span class="token operator">&lt;</span> newChildren<span class="token punctuation">.</span>length<span class="token punctuation">;</span> newIdx<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">//先缓存下一个老fiber</span>
    nextOldFiber <span class="token operator">=</span> oldFiber<span class="token punctuation">.</span>sibling<span class="token punctuation">;</span>
    <span class="token comment">//试图复用才fiber</span>
    <span class="token keyword">const</span> newFiber <span class="token operator">=</span> <span class="token function">updateSlot</span><span class="token punctuation">(</span>returnFiber<span class="token punctuation">,</span> oldFiber<span class="token punctuation">,</span> newChildren<span class="token punctuation">[</span>newIdx<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//如果key 不一样，直接跳出第一轮循环</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>newFiber<span class="token punctuation">)</span>
      <span class="token keyword">break</span><span class="token punctuation">;</span> <span class="token comment">//跳出第一轮循环</span>
    <span class="token comment">//老fiber存在，但是新的fiber并没有复用老fiber</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>oldFiber <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>newFiber<span class="token punctuation">.</span>alternate<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">deleteChild</span><span class="token punctuation">(</span>returnFiber<span class="token punctuation">,</span> oldFiber<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">//核心是给当前的newFiber添加一个副作用flags 叫新增</span>
    <span class="token function">placeChild</span><span class="token punctuation">(</span>newFiber<span class="token punctuation">,</span>newIdx<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>previousNewFiber<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      resultingFirstChild <span class="token operator">=</span> newFiber<span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      previousNewFiber<span class="token punctuation">.</span>sibling <span class="token operator">=</span> newFiber<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    previousNewFiber <span class="token operator">=</span> newFiber<span class="token punctuation">;</span>
    oldFiber <span class="token operator">=</span> nextOldFiber<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// 如果没有老fiber,也就是初次挂载的时候</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>oldFiber<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 循环虚拟DOM数组， 为每个虚拟DOM创建一个新的fiber</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token punctuation">;</span> newIdx <span class="token operator">&lt;</span> newChildren<span class="token punctuation">.</span>length<span class="token punctuation">;</span> newIdx<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> newFiber <span class="token operator">=</span> <span class="token function">createChild</span><span class="token punctuation">(</span>returnFiber<span class="token punctuation">,</span> newChildren<span class="token punctuation">[</span>newIdx<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//li(A) =&gt;li(B)=&gt; li(C)</span>
      <span class="token comment">// newFiber.flags = Placement</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>previousNewFiber<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        resultingFirstChild <span class="token operator">=</span> newFiber<span class="token punctuation">;</span><span class="token comment">//resultingFirstChild=&gt;li(A)</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        previousNewFiber<span class="token punctuation">.</span>sibling <span class="token operator">=</span> newFiber<span class="token punctuation">;</span><span class="token comment">//liA.sibling=li(B) =&gt; liB.sibling=li(C)</span>
      <span class="token punctuation">}</span>
      previousNewFiber <span class="token operator">=</span> newFiber<span class="token punctuation">;</span><span class="token comment">//previousNewFiber=&gt;li(A)=&gt;li(B) =&gt; li(C)</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> resultingFirstChild<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>来简单测试下：</p> <div class="language-html extra-class"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>button</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>multi1<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>5.多个节点的数量和key相同，有的type不同<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>button</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>br</span><span class="token punctuation">/&gt;</span></span>
  <span class="token entity" title="&lt;">&amp;lt;</span>ul key=<span class="token entity" title="&quot;">&amp;quot;</span>ul<span class="token entity" title="&quot;">&amp;quot;</span><span class="token entity" title="&gt;">&amp;gt;</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>br</span><span class="token punctuation">/&gt;</span></span>
  <span class="token entity" title="&amp;nbsp;">&amp;nbsp;</span><span class="token entity" title="&amp;nbsp;">&amp;nbsp;</span><span class="token entity" title="&lt;">&amp;lt;</span>li key=<span class="token entity" title="&quot;">&amp;quot;</span>A<span class="token entity" title="&quot;">&amp;quot;</span><span class="token entity" title="&gt;">&amp;gt;</span>A<span class="token entity" title="&lt;">&amp;lt;</span>/li<span class="token entity" title="&gt;">&amp;gt;</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>br</span><span class="token punctuation">/&gt;</span></span>
  <span class="token entity" title="&amp;nbsp;">&amp;nbsp;</span><span class="token entity" title="&amp;nbsp;">&amp;nbsp;</span><span class="token entity" title="&lt;">&amp;lt;</span>li key=<span class="token entity" title="&quot;">&amp;quot;</span>B<span class="token entity" title="&quot;">&amp;quot;</span> id=<span class="token entity" title="&quot;">&amp;quot;</span>B<span class="token entity" title="&quot;">&amp;quot;</span><span class="token entity" title="&gt;">&amp;gt;</span>B<span class="token entity" title="&lt;">&amp;lt;</span>/li<span class="token entity" title="&gt;">&amp;gt;</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>br</span><span class="token punctuation">/&gt;</span></span>
  <span class="token entity" title="&amp;nbsp;">&amp;nbsp;</span><span class="token entity" title="&amp;nbsp;">&amp;nbsp;</span><span class="token entity" title="&lt;">&amp;lt;</span>li key=<span class="token entity" title="&quot;">&amp;quot;</span>C<span class="token entity" title="&quot;">&amp;quot;</span>id=<span class="token entity" title="&quot;">&amp;quot;</span>C<span class="token entity" title="&quot;">&amp;quot;</span><span class="token entity" title="&gt;">&amp;gt;</span>C<span class="token entity" title="&lt;">&amp;lt;</span>/li<span class="token entity" title="&gt;">&amp;gt;</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>br</span><span class="token punctuation">/&gt;</span></span>
  <span class="token entity" title="&lt;">&amp;lt;</span>/ul<span class="token entity" title="&gt;">&amp;gt;</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>br</span><span class="token punctuation">/&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>button</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>multi1Update<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>更新属性，type不同的删除老节点，删除新节点<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>button</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>br</span><span class="token punctuation">/&gt;</span></span>
  <span class="token entity" title="&lt;">&amp;lt;</span>ul key=<span class="token entity" title="&quot;">&amp;quot;</span>ul<span class="token entity" title="&quot;">&amp;quot;</span><span class="token entity" title="&gt;">&amp;gt;</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>br</span><span class="token punctuation">/&gt;</span></span>
  <span class="token entity" title="&amp;nbsp;">&amp;nbsp;</span><span class="token entity" title="&amp;nbsp;">&amp;nbsp;</span><span class="token entity" title="&lt;">&amp;lt;</span>li key=<span class="token entity" title="&quot;">&amp;quot;</span>A<span class="token entity" title="&quot;">&amp;quot;</span><span class="token entity" title="&gt;">&amp;gt;</span>A<span class="token entity" title="&lt;">&amp;lt;</span>/li<span class="token entity" title="&gt;">&amp;gt;</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>br</span><span class="token punctuation">/&gt;</span></span>
  <span class="token entity" title="&amp;nbsp;">&amp;nbsp;</span><span class="token entity" title="&amp;nbsp;">&amp;nbsp;</span><span class="token entity" title="&lt;">&amp;lt;</span>p key=<span class="token entity" title="&quot;">&amp;quot;</span>B<span class="token entity" title="&quot;">&amp;quot;</span> id=<span class="token entity" title="&quot;">&amp;quot;</span>B2<span class="token entity" title="&quot;">&amp;quot;</span><span class="token entity" title="&gt;">&amp;gt;</span>B2<span class="token entity" title="&lt;">&amp;lt;</span>/p<span class="token entity" title="&gt;">&amp;gt;</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>br</span><span class="token punctuation">/&gt;</span></span>
  <span class="token entity" title="&amp;nbsp;">&amp;nbsp;</span><span class="token entity" title="&amp;nbsp;">&amp;nbsp;</span><span class="token entity" title="&lt;">&amp;lt;</span>li key=<span class="token entity" title="&quot;">&amp;quot;</span>C<span class="token entity" title="&quot;">&amp;quot;</span> id=<span class="token entity" title="&quot;">&amp;quot;</span>C2<span class="token entity" title="&quot;">&amp;quot;</span> <span class="token entity" title="&gt;">&amp;gt;</span>C2<span class="token entity" title="&lt;">&amp;lt;</span>/li<span class="token entity" title="&gt;">&amp;gt;</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>br</span><span class="token punctuation">/&gt;</span></span>
  <span class="token entity" title="&lt;">&amp;lt;</span>/ul<span class="token entity" title="&gt;">&amp;gt;</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>br</span><span class="token punctuation">/&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>hr</span><span class="token punctuation">/&gt;</span></span>
</code></pre></div><div class="language-js extra-class"><pre class="language-js"><code>multi1<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'click'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> element <span class="token operator">=</span> <span class="token punctuation">(</span>
    <span class="token operator">&lt;</span>ul key<span class="token operator">=</span><span class="token string">&quot;ul&quot;</span><span class="token operator">&gt;</span>
      <span class="token operator">&lt;</span>li key<span class="token operator">=</span><span class="token string">&quot;A&quot;</span><span class="token operator">&gt;</span><span class="token constant">A</span><span class="token operator">&lt;</span><span class="token operator">/</span>li<span class="token operator">&gt;</span>
      <span class="token operator">&lt;</span>li key<span class="token operator">=</span><span class="token string">&quot;B&quot;</span> id<span class="token operator">=</span><span class="token string">&quot;B&quot;</span><span class="token operator">&gt;</span><span class="token constant">B</span><span class="token operator">&lt;</span><span class="token operator">/</span>li<span class="token operator">&gt;</span>
      <span class="token operator">&lt;</span>li key<span class="token operator">=</span><span class="token string">&quot;C&quot;</span> id<span class="token operator">=</span><span class="token string">&quot;C&quot;</span><span class="token operator">&gt;</span><span class="token constant">C</span><span class="token operator">&lt;</span><span class="token operator">/</span>li<span class="token operator">&gt;</span>
    <span class="token operator">&lt;</span><span class="token operator">/</span>ul<span class="token operator">&gt;</span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
  ReactDOM<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span>element<span class="token punctuation">,</span> root<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
multi1Update<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'click'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> element <span class="token operator">=</span> <span class="token punctuation">(</span>
    <span class="token operator">&lt;</span>ul key<span class="token operator">=</span><span class="token string">&quot;ul&quot;</span><span class="token operator">&gt;</span>
      <span class="token operator">&lt;</span>li key<span class="token operator">=</span><span class="token string">&quot;A&quot;</span><span class="token operator">&gt;</span><span class="token constant">A</span><span class="token operator">&lt;</span><span class="token operator">/</span>li<span class="token operator">&gt;</span>
      <span class="token operator">&lt;</span>p key<span class="token operator">=</span><span class="token string">&quot;B&quot;</span> id<span class="token operator">=</span><span class="token string">&quot;B2&quot;</span><span class="token operator">&gt;</span><span class="token constant">B2</span><span class="token operator">&lt;</span><span class="token operator">/</span>p<span class="token operator">&gt;</span>
      <span class="token operator">&lt;</span>li key<span class="token operator">=</span><span class="token string">&quot;C&quot;</span> id<span class="token operator">=</span><span class="token string">&quot;C2&quot;</span><span class="token operator">&gt;</span><span class="token constant">C2</span><span class="token operator">&lt;</span><span class="token operator">/</span>li<span class="token operator">&gt;</span>
    <span class="token operator">&lt;</span><span class="token operator">/</span>ul<span class="token operator">&gt;</span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
  ReactDOM<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span>element<span class="token punctuation">,</span> root<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p><img src="https://gitee.com/yutao618/images/raw/master/images/20211215144251.png" alt=""></p> <p><img src="https://gitee.com/yutao618/images/raw/master/images/20211215144417.png" alt=""></p> <p>可以看到搜集的effectList是正确的，但实际上DOM插入的顺序不太对，是因为在之前提交的时候，也就是commitWork阶段commitPlacement插入节点的时候有问题，看原来代码如下：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">commitPlacement</span><span class="token punctuation">(</span><span class="token parameter">nextEffect</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> stateNode <span class="token operator">=</span> nextEffect<span class="token punctuation">.</span>stateNode<span class="token punctuation">;</span>
  <span class="token keyword">let</span> parentStateNode <span class="token operator">=</span> <span class="token function">getParentStateNode</span><span class="token punctuation">(</span>nextEffect<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">appendChild</span><span class="token punctuation">(</span>parentStateNode<span class="token punctuation">,</span> stateNode<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>问题就是出在appendChild的这个时候，做下调整：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">commitPlacement</span><span class="token punctuation">(</span><span class="token parameter">nextEffect</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> stateNode <span class="token operator">=</span> nextEffect<span class="token punctuation">.</span>stateNode<span class="token punctuation">;</span>
  <span class="token keyword">let</span> parentStateNode <span class="token operator">=</span> <span class="token function">getParentStateNode</span><span class="token punctuation">(</span>nextEffect<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">appendChild</span><span class="token punctuation">(</span>parentStateNode<span class="token punctuation">,</span> stateNode<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">let</span> before <span class="token operator">=</span> <span class="token function">getHostSibling</span><span class="token punctuation">(</span>nextEffect<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>before<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">insertBefore</span><span class="token punctuation">(</span>parentStateNode<span class="token punctuation">,</span> stateNode<span class="token punctuation">,</span> before<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token function">appendChild</span><span class="token punctuation">(</span>parentStateNode<span class="token punctuation">,</span> stateNode<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">//当前fiber后面一个离它最近的真实的DOM节点</span>
<span class="token keyword">function</span> <span class="token function">getHostSibling</span><span class="token punctuation">(</span><span class="token parameter">fiber</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> node <span class="token operator">=</span> fiber<span class="token punctuation">.</span>sibling<span class="token punctuation">;</span>
  <span class="token keyword">while</span> <span class="token punctuation">(</span>node<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">//找它的弟弟们，找到最近一个并且不是插入的节点，返回。。没有更新，更新</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token punctuation">(</span> node<span class="token punctuation">.</span>flags <span class="token operator">&amp;</span> Placement <span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> node<span class="token punctuation">.</span>stateNode<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    node <span class="token operator">=</span> node<span class="token punctuation">.</span>sibling<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">insertBefore</span><span class="token punctuation">(</span><span class="token parameter">parentInstance<span class="token punctuation">,</span> child<span class="token punctuation">,</span> before</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  parentInstance<span class="token punctuation">.</span><span class="token function">insertBefore</span><span class="token punctuation">(</span>child<span class="token punctuation">,</span> before<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>再来测试下：</p> <p><img src="https://gitee.com/yutao618/images/raw/master/images/20211215145208.png" alt=""></p> <p>可以看到effectList和DOM都是正确的。</p> <h3 id="多个节点的类型和key全部相同，有新增元素"><a href="#多个节点的类型和key全部相同，有新增元素" class="header-anchor">#</a> 多个节点的类型和key全部相同，有新增元素</h3> <div class="language-html extra-class"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>button</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>multi2<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>6.多个节点的类型和key全部相同，有新增元素<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>button</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>br</span><span class="token punctuation">/&gt;</span></span>
  <span class="token entity" title="&lt;">&amp;lt;</span>ul key=<span class="token entity" title="&quot;">&amp;quot;</span>ul<span class="token entity" title="&quot;">&amp;quot;</span><span class="token entity" title="&gt;">&amp;gt;</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>br</span><span class="token punctuation">/&gt;</span></span>
  <span class="token entity" title="&amp;nbsp;">&amp;nbsp;</span><span class="token entity" title="&amp;nbsp;">&amp;nbsp;</span><span class="token entity" title="&lt;">&amp;lt;</span>li key=<span class="token entity" title="&quot;">&amp;quot;</span>A<span class="token entity" title="&quot;">&amp;quot;</span><span class="token entity" title="&gt;">&amp;gt;</span>A<span class="token entity" title="&lt;">&amp;lt;</span>/li<span class="token entity" title="&gt;">&amp;gt;</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>br</span><span class="token punctuation">/&gt;</span></span>
  <span class="token entity" title="&amp;nbsp;">&amp;nbsp;</span><span class="token entity" title="&amp;nbsp;">&amp;nbsp;</span><span class="token entity" title="&lt;">&amp;lt;</span>li key=<span class="token entity" title="&quot;">&amp;quot;</span>B<span class="token entity" title="&quot;">&amp;quot;</span> id=<span class="token entity" title="&quot;">&amp;quot;</span>B<span class="token entity" title="&quot;">&amp;quot;</span><span class="token entity" title="&gt;">&amp;gt;</span>B<span class="token entity" title="&lt;">&amp;lt;</span>/li<span class="token entity" title="&gt;">&amp;gt;</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>br</span><span class="token punctuation">/&gt;</span></span>
  <span class="token entity" title="&amp;nbsp;">&amp;nbsp;</span><span class="token entity" title="&amp;nbsp;">&amp;nbsp;</span><span class="token entity" title="&lt;">&amp;lt;</span>li key=<span class="token entity" title="&quot;">&amp;quot;</span>C<span class="token entity" title="&quot;">&amp;quot;</span><span class="token entity" title="&gt;">&amp;gt;</span>C<span class="token entity" title="&lt;">&amp;lt;</span>/li<span class="token entity" title="&gt;">&amp;gt;</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>br</span><span class="token punctuation">/&gt;</span></span>
  <span class="token entity" title="&lt;">&amp;lt;</span>/ul<span class="token entity" title="&gt;">&amp;gt;</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>br</span><span class="token punctuation">/&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>button</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>multi2Update<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>增加新元素并更新老元素<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>button</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>br</span><span class="token punctuation">/&gt;</span></span>
  <span class="token entity" title="&lt;">&amp;lt;</span>ul key=<span class="token entity" title="&quot;">&amp;quot;</span>ul<span class="token entity" title="&quot;">&amp;quot;</span><span class="token entity" title="&gt;">&amp;gt;</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>br</span><span class="token punctuation">/&gt;</span></span>
  <span class="token entity" title="&amp;nbsp;">&amp;nbsp;</span><span class="token entity" title="&amp;nbsp;">&amp;nbsp;</span><span class="token entity" title="&lt;">&amp;lt;</span>li key=<span class="token entity" title="&quot;">&amp;quot;</span>A<span class="token entity" title="&quot;">&amp;quot;</span><span class="token entity" title="&gt;">&amp;gt;</span>A<span class="token entity" title="&lt;">&amp;lt;</span>/li<span class="token entity" title="&gt;">&amp;gt;</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>br</span><span class="token punctuation">/&gt;</span></span>
  <span class="token entity" title="&amp;nbsp;">&amp;nbsp;</span><span class="token entity" title="&amp;nbsp;">&amp;nbsp;</span><span class="token entity" title="&lt;">&amp;lt;</span>li key=<span class="token entity" title="&quot;">&amp;quot;</span>B<span class="token entity" title="&quot;">&amp;quot;</span> id=<span class="token entity" title="&quot;">&amp;quot;</span>B2<span class="token entity" title="&quot;">&amp;quot;</span><span class="token entity" title="&gt;">&amp;gt;</span>B2<span class="token entity" title="&lt;">&amp;lt;</span>/li<span class="token entity" title="&gt;">&amp;gt;</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>br</span><span class="token punctuation">/&gt;</span></span>
  <span class="token entity" title="&amp;nbsp;">&amp;nbsp;</span><span class="token entity" title="&amp;nbsp;">&amp;nbsp;</span><span class="token entity" title="&lt;">&amp;lt;</span>li key=<span class="token entity" title="&quot;">&amp;quot;</span>C<span class="token entity" title="&quot;">&amp;quot;</span><span class="token entity" title="&gt;">&amp;gt;</span>C<span class="token entity" title="&lt;">&amp;lt;</span>/li<span class="token entity" title="&gt;">&amp;gt;</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>br</span><span class="token punctuation">/&gt;</span></span>
  <span class="token entity" title="&amp;nbsp;">&amp;nbsp;</span><span class="token entity" title="&amp;nbsp;">&amp;nbsp;</span><span class="token entity" title="&lt;">&amp;lt;</span>li key=<span class="token entity" title="&quot;">&amp;quot;</span>D<span class="token entity" title="&quot;">&amp;quot;</span><span class="token entity" title="&gt;">&amp;gt;</span>D<span class="token entity" title="&lt;">&amp;lt;</span>/li<span class="token entity" title="&gt;">&amp;gt;</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>br</span><span class="token punctuation">/&gt;</span></span>
  <span class="token entity" title="&lt;">&amp;lt;</span>/ul<span class="token entity" title="&gt;">&amp;gt;</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>br</span><span class="token punctuation">/&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>hr</span><span class="token punctuation">/&gt;</span></span>
</code></pre></div><div class="language-js extra-class"><pre class="language-js"><code>multi2<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'click'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> element <span class="token operator">=</span> <span class="token punctuation">(</span>
    <span class="token operator">&lt;</span>ul key<span class="token operator">=</span><span class="token string">&quot;ul&quot;</span><span class="token operator">&gt;</span>
      <span class="token operator">&lt;</span>li key<span class="token operator">=</span><span class="token string">&quot;A&quot;</span><span class="token operator">&gt;</span><span class="token constant">A</span><span class="token operator">&lt;</span><span class="token operator">/</span>li<span class="token operator">&gt;</span>
      <span class="token operator">&lt;</span>li key<span class="token operator">=</span><span class="token string">&quot;B&quot;</span> id<span class="token operator">=</span><span class="token string">&quot;B&quot;</span><span class="token operator">&gt;</span><span class="token constant">B</span><span class="token operator">&lt;</span><span class="token operator">/</span>li<span class="token operator">&gt;</span>
      <span class="token operator">&lt;</span>li key<span class="token operator">=</span><span class="token string">&quot;C&quot;</span><span class="token operator">&gt;</span><span class="token constant">C</span><span class="token operator">&lt;</span><span class="token operator">/</span>li<span class="token operator">&gt;</span>
    <span class="token operator">&lt;</span><span class="token operator">/</span>ul<span class="token operator">&gt;</span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
  ReactDOM<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span>element<span class="token punctuation">,</span> root<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//增加新元素并更新老元素</span>
multi2Update<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'click'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> element <span class="token operator">=</span> <span class="token punctuation">(</span>
    <span class="token operator">&lt;</span>ul key<span class="token operator">=</span><span class="token string">&quot;ul&quot;</span><span class="token operator">&gt;</span>
      <span class="token operator">&lt;</span>li key<span class="token operator">=</span><span class="token string">&quot;A&quot;</span><span class="token operator">&gt;</span><span class="token constant">A</span><span class="token operator">&lt;</span><span class="token operator">/</span>li<span class="token operator">&gt;</span>
      <span class="token operator">&lt;</span>li key<span class="token operator">=</span><span class="token string">&quot;B&quot;</span> id<span class="token operator">=</span><span class="token string">&quot;B2&quot;</span><span class="token operator">&gt;</span><span class="token constant">B2</span><span class="token operator">&lt;</span><span class="token operator">/</span>li<span class="token operator">&gt;</span>
      <span class="token operator">&lt;</span>li key<span class="token operator">=</span><span class="token string">&quot;C&quot;</span><span class="token operator">&gt;</span><span class="token constant">C</span><span class="token operator">&lt;</span><span class="token operator">/</span>li<span class="token operator">&gt;</span>
      <span class="token operator">&lt;</span>li key<span class="token operator">=</span><span class="token string">&quot;D&quot;</span><span class="token operator">&gt;</span><span class="token constant">D</span><span class="token operator">&lt;</span><span class="token operator">/</span>li<span class="token operator">&gt;</span>
    <span class="token operator">&lt;</span><span class="token operator">/</span>ul<span class="token operator">&gt;</span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
  ReactDOM<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span>element<span class="token punctuation">,</span> root<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p><img src="https://gitee.com/yutao618/images/raw/master/images/20211215150150.png" alt=""></p> <p>对于这种情况，就说明oldFiber没有了，新的fiber还有，就会走到if(!oldFiber)的分支去，在里面放置下新fiber就可以了，具体代码就是加一行placeChild(newFiber, newIdx)。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">reconcileChildrenArray</span><span class="token punctuation">(</span><span class="token parameter">returnFiber<span class="token punctuation">,</span> currentFirstChild<span class="token punctuation">,</span> newChildren</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">//将要返回的第一个新fiber</span>
  <span class="token keyword">let</span> resultingFirstChild <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
  <span class="token comment">//上一个新fiber</span>
  <span class="token keyword">let</span> previousNewFiber <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
  <span class="token comment">//当前的老fiber</span>
  <span class="token keyword">let</span> oldFiber <span class="token operator">=</span> currentFirstChild<span class="token punctuation">;</span>
  <span class="token comment">//新的虚拟DOM的索引</span>
  <span class="token keyword">let</span> newIdx <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
  <span class="token comment">// 下一个老fiber</span>
  <span class="token keyword">let</span> nextOldFiber <span class="token operator">=</span> <span class="token keyword">null</span>
  <span class="token comment">//处理更新的情况 老fiber和新fiber都存在</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token punctuation">;</span> oldFiber <span class="token operator">&amp;&amp;</span> newIdx <span class="token operator">&lt;</span> newChildren<span class="token punctuation">.</span>length<span class="token punctuation">;</span> newIdx<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">debugger</span>
    <span class="token comment">//先缓存下一个老fiber</span>
    nextOldFiber <span class="token operator">=</span> oldFiber<span class="token punctuation">.</span>sibling<span class="token punctuation">;</span>
    <span class="token comment">//试图复用才fiber</span>
    <span class="token keyword">const</span> newFiber <span class="token operator">=</span> <span class="token function">updateSlot</span><span class="token punctuation">(</span>returnFiber<span class="token punctuation">,</span> oldFiber<span class="token punctuation">,</span> newChildren<span class="token punctuation">[</span>newIdx<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//如果key 不一样，直接跳出第一轮循环</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>newFiber<span class="token punctuation">)</span>
      <span class="token keyword">break</span><span class="token punctuation">;</span> <span class="token comment">//跳出第一轮循环</span>
    <span class="token comment">//老fiber存在，但是新的fiber并没有复用老fiber</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>oldFiber <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>newFiber<span class="token punctuation">.</span>alternate<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">deleteChild</span><span class="token punctuation">(</span>returnFiber<span class="token punctuation">,</span> oldFiber<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">//核心是给当前的newFiber添加一个副作用flags 叫新增</span>
    <span class="token function">placeChild</span><span class="token punctuation">(</span>newFiber<span class="token punctuation">,</span>newIdx<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>previousNewFiber<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      resultingFirstChild <span class="token operator">=</span> newFiber<span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      previousNewFiber<span class="token punctuation">.</span>sibling <span class="token operator">=</span> newFiber<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    previousNewFiber <span class="token operator">=</span> newFiber<span class="token punctuation">;</span>
    oldFiber <span class="token operator">=</span> nextOldFiber<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// 如果没有老fiber</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>oldFiber<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 循环虚拟DOM数组， 为每个虚拟DOM创建一个新的fiber</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token punctuation">;</span> newIdx <span class="token operator">&lt;</span> newChildren<span class="token punctuation">.</span>length<span class="token punctuation">;</span> newIdx<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> newFiber <span class="token operator">=</span> <span class="token function">createChild</span><span class="token punctuation">(</span>returnFiber<span class="token punctuation">,</span> newChildren<span class="token punctuation">[</span>newIdx<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//li(A) =&gt;li(B)=&gt; li(C)</span>
      <span class="token comment">// newFiber.flags = Placement</span>
      <span class="token function">placeChild</span><span class="token punctuation">(</span>newFiber<span class="token punctuation">,</span> newIdx<span class="token punctuation">)</span> 
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>previousNewFiber<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        resultingFirstChild <span class="token operator">=</span> newFiber<span class="token punctuation">;</span><span class="token comment">//resultingFirstChild=&gt;li(A)</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        previousNewFiber<span class="token punctuation">.</span>sibling <span class="token operator">=</span> newFiber<span class="token punctuation">;</span><span class="token comment">//liA.sibling=li(B) =&gt; liB.sibling=li(C)</span>
      <span class="token punctuation">}</span>
      previousNewFiber <span class="token operator">=</span> newFiber<span class="token punctuation">;</span><span class="token comment">//previousNewFiber=&gt;li(A)=&gt;li(B) =&gt; li(C)</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> resultingFirstChild<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p><img src="https://gitee.com/yutao618/images/raw/master/images/20211215150806.png" alt=""></p> <p>可以看到是更新了B,插入新的D。</p> <h3 id="多个节点的类型和key全部相同，有删除老元素"><a href="#多个节点的类型和key全部相同，有删除老元素" class="header-anchor">#</a> 多个节点的类型和key全部相同，有删除老元素</h3> <div class="language-html extra-class"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span><span class="token punctuation">&gt;</span></span>
   <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>button</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>multi3<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>7.多个节点的类型和key全部相同，有删除老元素<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>button</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>br</span><span class="token punctuation">/&gt;</span></span>
   <span class="token entity" title="&lt;">&amp;lt;</span>ul key=<span class="token entity" title="&quot;">&amp;quot;</span>ul<span class="token entity" title="&quot;">&amp;quot;</span><span class="token entity" title="&gt;">&amp;gt;</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>br</span><span class="token punctuation">/&gt;</span></span>
     <span class="token entity" title="&amp;nbsp;">&amp;nbsp;</span><span class="token entity" title="&amp;nbsp;">&amp;nbsp;</span><span class="token entity" title="&lt;">&amp;lt;</span>li key=<span class="token entity" title="&quot;">&amp;quot;</span>A<span class="token entity" title="&quot;">&amp;quot;</span><span class="token entity" title="&gt;">&amp;gt;</span>A<span class="token entity" title="&lt;">&amp;lt;</span>/li<span class="token entity" title="&gt;">&amp;gt;</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>br</span><span class="token punctuation">/&gt;</span></span>
     <span class="token entity" title="&amp;nbsp;">&amp;nbsp;</span><span class="token entity" title="&amp;nbsp;">&amp;nbsp;</span><span class="token entity" title="&lt;">&amp;lt;</span>li key=<span class="token entity" title="&quot;">&amp;quot;</span>B<span class="token entity" title="&quot;">&amp;quot;</span> id=<span class="token entity" title="&quot;">&amp;quot;</span>B<span class="token entity" title="&quot;">&amp;quot;</span><span class="token entity" title="&gt;">&amp;gt;</span>B<span class="token entity" title="&lt;">&amp;lt;</span>/li<span class="token entity" title="&gt;">&amp;gt;</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>br</span><span class="token punctuation">/&gt;</span></span>
     <span class="token entity" title="&amp;nbsp;">&amp;nbsp;</span><span class="token entity" title="&amp;nbsp;">&amp;nbsp;</span><span class="token entity" title="&lt;">&amp;lt;</span>li key=<span class="token entity" title="&quot;">&amp;quot;</span>C<span class="token entity" title="&quot;">&amp;quot;</span><span class="token entity" title="&gt;">&amp;gt;</span>C<span class="token entity" title="&lt;">&amp;lt;</span>/li<span class="token entity" title="&gt;">&amp;gt;</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>br</span><span class="token punctuation">/&gt;</span></span>
   <span class="token entity" title="&lt;">&amp;lt;</span>/ul<span class="token entity" title="&gt;">&amp;gt;</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>br</span><span class="token punctuation">/&gt;</span></span>
   <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>button</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>multi3Update<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>删除老元素并更新老元素<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>button</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>br</span><span class="token punctuation">/&gt;</span></span>
   <span class="token entity" title="&lt;">&amp;lt;</span>ul key=<span class="token entity" title="&quot;">&amp;quot;</span>ul<span class="token entity" title="&quot;">&amp;quot;</span><span class="token entity" title="&gt;">&amp;gt;</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>br</span><span class="token punctuation">/&gt;</span></span>
     <span class="token entity" title="&amp;nbsp;">&amp;nbsp;</span><span class="token entity" title="&amp;nbsp;">&amp;nbsp;</span><span class="token entity" title="&lt;">&amp;lt;</span>li key=<span class="token entity" title="&quot;">&amp;quot;</span>A<span class="token entity" title="&quot;">&amp;quot;</span><span class="token entity" title="&gt;">&amp;gt;</span>A<span class="token entity" title="&lt;">&amp;lt;</span>/li<span class="token entity" title="&gt;">&amp;gt;</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>br</span><span class="token punctuation">/&gt;</span></span>
     <span class="token entity" title="&amp;nbsp;">&amp;nbsp;</span><span class="token entity" title="&amp;nbsp;">&amp;nbsp;</span><span class="token entity" title="&lt;">&amp;lt;</span>li key=<span class="token entity" title="&quot;">&amp;quot;</span>B<span class="token entity" title="&quot;">&amp;quot;</span> id=<span class="token entity" title="&quot;">&amp;quot;</span>B2<span class="token entity" title="&quot;">&amp;quot;</span><span class="token entity" title="&gt;">&amp;gt;</span>B2<span class="token entity" title="&lt;">&amp;lt;</span>/li<span class="token entity" title="&gt;">&amp;gt;</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>br</span><span class="token punctuation">/&gt;</span></span>
   <span class="token entity" title="&lt;">&amp;lt;</span>/ul<span class="token entity" title="&gt;">&amp;gt;</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>br</span><span class="token punctuation">/&gt;</span></span>
 <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
 <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>hr</span><span class="token punctuation">/&gt;</span></span>
</code></pre></div><div class="language-js extra-class"><pre class="language-js"><code>multi3<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'click'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> element <span class="token operator">=</span> <span class="token punctuation">(</span>
        <span class="token operator">&lt;</span>ul key<span class="token operator">=</span><span class="token string">&quot;ul&quot;</span><span class="token operator">&gt;</span>
            <span class="token operator">&lt;</span>li key<span class="token operator">=</span><span class="token string">&quot;A&quot;</span><span class="token operator">&gt;</span><span class="token constant">A</span><span class="token operator">&lt;</span><span class="token operator">/</span>li<span class="token operator">&gt;</span>
            <span class="token operator">&lt;</span>li key<span class="token operator">=</span><span class="token string">&quot;B&quot;</span> id<span class="token operator">=</span><span class="token string">&quot;B&quot;</span><span class="token operator">&gt;</span><span class="token constant">B</span><span class="token operator">&lt;</span><span class="token operator">/</span>li<span class="token operator">&gt;</span>
            <span class="token operator">&lt;</span>li key<span class="token operator">=</span><span class="token string">&quot;C&quot;</span><span class="token operator">&gt;</span><span class="token constant">C</span><span class="token operator">&lt;</span><span class="token operator">/</span>li<span class="token operator">&gt;</span>
        <span class="token operator">&lt;</span><span class="token operator">/</span>ul<span class="token operator">&gt;</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
    ReactDOM<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span>element<span class="token punctuation">,</span> root<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
multi3Update<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'click'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> element <span class="token operator">=</span> <span class="token punctuation">(</span>
        <span class="token operator">&lt;</span>ul key<span class="token operator">=</span><span class="token string">&quot;ul&quot;</span><span class="token operator">&gt;</span>
            <span class="token operator">&lt;</span>li key<span class="token operator">=</span><span class="token string">&quot;A&quot;</span><span class="token operator">&gt;</span><span class="token constant">A</span><span class="token operator">&lt;</span><span class="token operator">/</span>li<span class="token operator">&gt;</span>
            <span class="token operator">&lt;</span>li key<span class="token operator">=</span><span class="token string">&quot;B&quot;</span> id<span class="token operator">=</span><span class="token string">&quot;B2&quot;</span><span class="token operator">&gt;</span><span class="token constant">B2</span><span class="token operator">&lt;</span><span class="token operator">/</span>li<span class="token operator">&gt;</span>
        <span class="token operator">&lt;</span><span class="token operator">/</span>ul<span class="token operator">&gt;</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
    ReactDOM<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span>element<span class="token punctuation">,</span> root<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p><img src="https://gitee.com/yutao618/images/raw/master/images/20211215151138.png" alt=""></p> <p>这个就是从ABC都AB的操作，操作如下：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">if</span> <span class="token punctuation">(</span>newIdx <span class="token operator">===</span> newChildren<span class="token punctuation">.</span>length<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token function">deleteRemainingChildren</span><span class="token punctuation">(</span>returnFiber<span class="token punctuation">,</span> oldFiber<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> resultingFirstChild<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>newIdx和newChildren.length相等，就说明新的已经完成了，那就删除所有的之后的老fiber。完整代码如下：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">reconcileChildrenArray</span><span class="token punctuation">(</span><span class="token parameter">returnFiber<span class="token punctuation">,</span> currentFirstChild<span class="token punctuation">,</span> newChildren</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">//将要返回的第一个新fiber</span>
  <span class="token keyword">let</span> resultingFirstChild <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
  <span class="token comment">//上一个新fiber</span>
  <span class="token keyword">let</span> previousNewFiber <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
  <span class="token comment">//当前的老fiber</span>
  <span class="token keyword">let</span> oldFiber <span class="token operator">=</span> currentFirstChild<span class="token punctuation">;</span>
  <span class="token comment">//新的虚拟DOM的索引</span>
  <span class="token keyword">let</span> newIdx <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
  <span class="token comment">// 下一个老fiber</span>
  <span class="token keyword">let</span> nextOldFiber <span class="token operator">=</span> <span class="token keyword">null</span>
  <span class="token comment">//处理更新的情况 老fiber和新fiber都存在</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token punctuation">;</span> oldFiber <span class="token operator">&amp;&amp;</span> newIdx <span class="token operator">&lt;</span> newChildren<span class="token punctuation">.</span>length<span class="token punctuation">;</span> newIdx<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">//先缓存下一个老fiber</span>
    nextOldFiber <span class="token operator">=</span> oldFiber<span class="token punctuation">.</span>sibling<span class="token punctuation">;</span>
    <span class="token comment">//试图复用才fiber</span>
    <span class="token keyword">const</span> newFiber <span class="token operator">=</span> <span class="token function">updateSlot</span><span class="token punctuation">(</span>returnFiber<span class="token punctuation">,</span> oldFiber<span class="token punctuation">,</span> newChildren<span class="token punctuation">[</span>newIdx<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//如果key 不一样，直接跳出第一轮循环</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>newFiber<span class="token punctuation">)</span>
      <span class="token keyword">break</span><span class="token punctuation">;</span> <span class="token comment">//跳出第一轮循环</span>
    <span class="token comment">//老fiber存在，但是新的fiber并没有复用老fiber</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>oldFiber <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>newFiber<span class="token punctuation">.</span>alternate<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">deleteChild</span><span class="token punctuation">(</span>returnFiber<span class="token punctuation">,</span> oldFiber<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">//核心是给当前的newFiber添加一个副作用flags 叫新增</span>
    <span class="token function">placeChild</span><span class="token punctuation">(</span>newFiber<span class="token punctuation">,</span> newIdx<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>previousNewFiber<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      resultingFirstChild <span class="token operator">=</span> newFiber<span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      previousNewFiber<span class="token punctuation">.</span>sibling <span class="token operator">=</span> newFiber<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    previousNewFiber <span class="token operator">=</span> newFiber<span class="token punctuation">;</span>
    oldFiber <span class="token operator">=</span> nextOldFiber<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>newIdx <span class="token operator">===</span> newChildren<span class="token punctuation">.</span>length<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">deleteRemainingChildren</span><span class="token punctuation">(</span>returnFiber<span class="token punctuation">,</span> oldFiber<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> resultingFirstChild<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// 如果没有老fiber</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>oldFiber<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 循环虚拟DOM数组， 为每个虚拟DOM创建一个新的fiber</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token punctuation">;</span> newIdx <span class="token operator">&lt;</span> newChildren<span class="token punctuation">.</span>length<span class="token punctuation">;</span> newIdx<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> newFiber <span class="token operator">=</span> <span class="token function">createChild</span><span class="token punctuation">(</span>returnFiber<span class="token punctuation">,</span> newChildren<span class="token punctuation">[</span>newIdx<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//li(A) =&gt;li(B)=&gt; li(C)</span>
      <span class="token comment">// newFiber.flags = Placement</span>
      <span class="token function">placeChild</span><span class="token punctuation">(</span>newFiber<span class="token punctuation">,</span> newIdx<span class="token punctuation">)</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>previousNewFiber<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        resultingFirstChild <span class="token operator">=</span> newFiber<span class="token punctuation">;</span><span class="token comment">//resultingFirstChild=&gt;li(A)</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        previousNewFiber<span class="token punctuation">.</span>sibling <span class="token operator">=</span> newFiber<span class="token punctuation">;</span><span class="token comment">//liA.sibling=li(B) =&gt; liB.sibling=li(C)</span>
      <span class="token punctuation">}</span>
      previousNewFiber <span class="token operator">=</span> newFiber<span class="token punctuation">;</span><span class="token comment">//previousNewFiber=&gt;li(A)=&gt;li(B) =&gt; li(C)</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> resultingFirstChild<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p><img src="https://gitee.com/yutao618/images/raw/master/images/20211215152026.png" alt=""></p> <p>可以看到删除了C,并且更新了B。接下来看最复杂的一个。</p> <h3 id="多个节点数量不同、key不同"><a href="#多个节点数量不同、key不同" class="header-anchor">#</a> 多个节点数量不同、key不同</h3> <div class="language-html extra-class"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span><span class="token punctuation">&gt;</span></span>
 <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>button</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>multi5<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>9.多个节点数量不同、key不同<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>button</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>br</span><span class="token punctuation">/&gt;</span></span>
   <span class="token entity" title="&lt;">&amp;lt;</span>ul key=<span class="token entity" title="&quot;">&amp;quot;</span>ul<span class="token entity" title="&quot;">&amp;quot;</span><span class="token entity" title="&gt;">&amp;gt;</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>br</span><span class="token punctuation">/&gt;</span></span>
    <span class="token entity" title="&amp;nbsp;">&amp;nbsp;</span><span class="token entity" title="&amp;nbsp;">&amp;nbsp;</span><span class="token entity" title="&lt;">&amp;lt;</span>li key=<span class="token entity" title="&quot;">&amp;quot;</span>A<span class="token entity" title="&quot;">&amp;quot;</span><span class="token entity" title="&gt;">&amp;gt;</span>A<span class="token entity" title="&lt;">&amp;lt;</span>/li<span class="token entity" title="&gt;">&amp;gt;</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>br</span><span class="token punctuation">/&gt;</span></span>
    <span class="token entity" title="&amp;nbsp;">&amp;nbsp;</span><span class="token entity" title="&amp;nbsp;">&amp;nbsp;</span><span class="token entity" title="&lt;">&amp;lt;</span>li key=<span class="token entity" title="&quot;">&amp;quot;</span>B<span class="token entity" title="&quot;">&amp;quot;</span> id=<span class="token entity" title="&quot;">&amp;quot;</span>b<span class="token entity" title="&quot;">&amp;quot;</span><span class="token entity" title="&gt;">&amp;gt;</span>B<span class="token entity" title="&lt;">&amp;lt;</span>/li<span class="token entity" title="&gt;">&amp;gt;</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>br</span><span class="token punctuation">/&gt;</span></span>
    <span class="token entity" title="&amp;nbsp;">&amp;nbsp;</span><span class="token entity" title="&amp;nbsp;">&amp;nbsp;</span><span class="token entity" title="&lt;">&amp;lt;</span>li key=<span class="token entity" title="&quot;">&amp;quot;</span>C<span class="token entity" title="&quot;">&amp;quot;</span><span class="token entity" title="&gt;">&amp;gt;</span>C<span class="token entity" title="&lt;">&amp;lt;</span>/li<span class="token entity" title="&gt;">&amp;gt;</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>br</span><span class="token punctuation">/&gt;</span></span>
    <span class="token entity" title="&amp;nbsp;">&amp;nbsp;</span><span class="token entity" title="&amp;nbsp;">&amp;nbsp;</span><span class="token entity" title="&lt;">&amp;lt;</span>li key=<span class="token entity" title="&quot;">&amp;quot;</span>D<span class="token entity" title="&quot;">&amp;quot;</span><span class="token entity" title="&gt;">&amp;gt;</span>D<span class="token entity" title="&lt;">&amp;lt;</span>/li<span class="token entity" title="&gt;">&amp;gt;</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>br</span><span class="token punctuation">/&gt;</span></span>
    <span class="token entity" title="&amp;nbsp;">&amp;nbsp;</span><span class="token entity" title="&amp;nbsp;">&amp;nbsp;</span><span class="token entity" title="&lt;">&amp;lt;</span>li key=<span class="token entity" title="&quot;">&amp;quot;</span>E<span class="token entity" title="&quot;">&amp;quot;</span><span class="token entity" title="&gt;">&amp;gt;</span>E<span class="token entity" title="&lt;">&amp;lt;</span>/li<span class="token entity" title="&gt;">&amp;gt;</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>br</span><span class="token punctuation">/&gt;</span></span>
    <span class="token entity" title="&amp;nbsp;">&amp;nbsp;</span><span class="token entity" title="&amp;nbsp;">&amp;nbsp;</span><span class="token entity" title="&lt;">&amp;lt;</span>li key=<span class="token entity" title="&quot;">&amp;quot;</span>F<span class="token entity" title="&quot;">&amp;quot;</span><span class="token entity" title="&gt;">&amp;gt;</span>F<span class="token entity" title="&lt;">&amp;lt;</span>/li<span class="token entity" title="&gt;">&amp;gt;</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>br</span><span class="token punctuation">/&gt;</span></span>
    <span class="token entity" title="&lt;">&amp;lt;</span>/ul<span class="token entity" title="&gt;">&amp;gt;</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>br</span><span class="token punctuation">/&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>button</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>multi5Update<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>处理节点移动的情况<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>button</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>br</span><span class="token punctuation">/&gt;</span></span>
    <span class="token entity" title="&lt;">&amp;lt;</span>ul key=<span class="token entity" title="&quot;">&amp;quot;</span>ul<span class="token entity" title="&quot;">&amp;quot;</span><span class="token entity" title="&gt;">&amp;gt;</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>br</span><span class="token punctuation">/&gt;</span></span>
    <span class="token entity" title="&amp;nbsp;">&amp;nbsp;</span><span class="token entity" title="&amp;nbsp;">&amp;nbsp;</span><span class="token entity" title="&lt;">&amp;lt;</span>li key=<span class="token entity" title="&quot;">&amp;quot;</span>A<span class="token entity" title="&quot;">&amp;quot;</span><span class="token entity" title="&gt;">&amp;gt;</span>A<span class="token entity" title="&lt;">&amp;lt;</span>/li<span class="token entity" title="&gt;">&amp;gt;</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>br</span><span class="token punctuation">/&gt;</span></span>
    <span class="token entity" title="&amp;nbsp;">&amp;nbsp;</span><span class="token entity" title="&amp;nbsp;">&amp;nbsp;</span><span class="token entity" title="&lt;">&amp;lt;</span>li key=<span class="token entity" title="&quot;">&amp;quot;</span>C<span class="token entity" title="&quot;">&amp;quot;</span><span class="token entity" title="&gt;">&amp;gt;</span>C<span class="token entity" title="&lt;">&amp;lt;</span>/li<span class="token entity" title="&gt;">&amp;gt;</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>br</span><span class="token punctuation">/&gt;</span></span>
    <span class="token entity" title="&amp;nbsp;">&amp;nbsp;</span><span class="token entity" title="&amp;nbsp;">&amp;nbsp;</span><span class="token entity" title="&lt;">&amp;lt;</span>li key=<span class="token entity" title="&quot;">&amp;quot;</span>E<span class="token entity" title="&quot;">&amp;quot;</span><span class="token entity" title="&gt;">&amp;gt;</span>E<span class="token entity" title="&lt;">&amp;lt;</span>/li<span class="token entity" title="&gt;">&amp;gt;</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>br</span><span class="token punctuation">/&gt;</span></span>
    <span class="token entity" title="&amp;nbsp;">&amp;nbsp;</span><span class="token entity" title="&amp;nbsp;">&amp;nbsp;</span><span class="token entity" title="&lt;">&amp;lt;</span>li key=<span class="token entity" title="&quot;">&amp;quot;</span>B<span class="token entity" title="&quot;">&amp;quot;</span> id=<span class="token entity" title="&quot;">&amp;quot;</span>b2<span class="token entity" title="&quot;">&amp;quot;</span><span class="token entity" title="&gt;">&amp;gt;</span>B2<span class="token entity" title="&lt;">&amp;lt;</span>/li<span class="token entity" title="&gt;">&amp;gt;</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>br</span><span class="token punctuation">/&gt;</span></span>
    <span class="token entity" title="&amp;nbsp;">&amp;nbsp;</span><span class="token entity" title="&amp;nbsp;">&amp;nbsp;</span><span class="token entity" title="&lt;">&amp;lt;</span>li key=<span class="token entity" title="&quot;">&amp;quot;</span>G<span class="token entity" title="&quot;">&amp;quot;</span><span class="token entity" title="&gt;">&amp;gt;</span>G<span class="token entity" title="&lt;">&amp;lt;</span>/li<span class="token entity" title="&gt;">&amp;gt;</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>br</span><span class="token punctuation">/&gt;</span></span>
    <span class="token entity" title="&amp;nbsp;">&amp;nbsp;</span><span class="token entity" title="&amp;nbsp;">&amp;nbsp;</span><span class="token entity" title="&lt;">&amp;lt;</span>li key=<span class="token entity" title="&quot;">&amp;quot;</span>D<span class="token entity" title="&quot;">&amp;quot;</span><span class="token entity" title="&gt;">&amp;gt;</span>D<span class="token entity" title="&lt;">&amp;lt;</span>/li<span class="token entity" title="&gt;">&amp;gt;</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>br</span><span class="token punctuation">/&gt;</span></span>
    <span class="token entity" title="&lt;">&amp;lt;</span>/ul<span class="token entity" title="&gt;">&amp;gt;</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>br</span><span class="token punctuation">/&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>hr</span><span class="token punctuation">/&gt;</span></span>
</code></pre></div><div class="language-js extra-class"><pre class="language-js"><code>multi5<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'click'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> element <span class="token operator">=</span> <span class="token punctuation">(</span>
        <span class="token operator">&lt;</span>ul key<span class="token operator">=</span><span class="token string">&quot;ul&quot;</span><span class="token operator">&gt;</span>
            <span class="token operator">&lt;</span>li key<span class="token operator">=</span><span class="token string">&quot;A&quot;</span><span class="token operator">&gt;</span><span class="token constant">A</span><span class="token operator">&lt;</span><span class="token operator">/</span>li<span class="token operator">&gt;</span>
            <span class="token operator">&lt;</span>li key<span class="token operator">=</span><span class="token string">&quot;B&quot;</span> id<span class="token operator">=</span><span class="token string">&quot;b&quot;</span><span class="token operator">&gt;</span><span class="token constant">B</span><span class="token operator">&lt;</span><span class="token operator">/</span>li<span class="token operator">&gt;</span>
            <span class="token operator">&lt;</span>li key<span class="token operator">=</span><span class="token string">&quot;C&quot;</span><span class="token operator">&gt;</span><span class="token constant">C</span><span class="token operator">&lt;</span><span class="token operator">/</span>li<span class="token operator">&gt;</span>
            <span class="token operator">&lt;</span>li key<span class="token operator">=</span><span class="token string">&quot;D&quot;</span><span class="token operator">&gt;</span><span class="token constant">D</span><span class="token operator">&lt;</span><span class="token operator">/</span>li<span class="token operator">&gt;</span>
            <span class="token operator">&lt;</span>li key<span class="token operator">=</span><span class="token string">&quot;E&quot;</span><span class="token operator">&gt;</span><span class="token constant">E</span><span class="token operator">&lt;</span><span class="token operator">/</span>li<span class="token operator">&gt;</span>
            <span class="token operator">&lt;</span>li key<span class="token operator">=</span><span class="token string">&quot;F&quot;</span><span class="token operator">&gt;</span><span class="token constant">F</span><span class="token operator">&lt;</span><span class="token operator">/</span>li<span class="token operator">&gt;</span>
        <span class="token operator">&lt;</span><span class="token operator">/</span>ul<span class="token operator">&gt;</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
    ReactDOM<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span>element<span class="token punctuation">,</span> root<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
multi5Update<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'click'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> element <span class="token operator">=</span> <span class="token punctuation">(</span>
        <span class="token operator">&lt;</span>ul key<span class="token operator">=</span><span class="token string">&quot;ul&quot;</span><span class="token operator">&gt;</span>
            <span class="token operator">&lt;</span>li key<span class="token operator">=</span><span class="token string">&quot;A&quot;</span><span class="token operator">&gt;</span><span class="token constant">A</span><span class="token operator">&lt;</span><span class="token operator">/</span>li<span class="token operator">&gt;</span>
            <span class="token operator">&lt;</span>li key<span class="token operator">=</span><span class="token string">&quot;C&quot;</span><span class="token operator">&gt;</span><span class="token constant">C</span><span class="token operator">&lt;</span><span class="token operator">/</span>li<span class="token operator">&gt;</span>
            <span class="token operator">&lt;</span>li key<span class="token operator">=</span><span class="token string">&quot;E&quot;</span><span class="token operator">&gt;</span><span class="token constant">E</span><span class="token operator">&lt;</span><span class="token operator">/</span>li<span class="token operator">&gt;</span>
            <span class="token operator">&lt;</span>li key<span class="token operator">=</span><span class="token string">&quot;B&quot;</span> id<span class="token operator">=</span><span class="token string">&quot;b2&quot;</span><span class="token operator">&gt;</span><span class="token constant">B2</span><span class="token operator">&lt;</span><span class="token operator">/</span>li<span class="token operator">&gt;</span>
            <span class="token operator">&lt;</span>li key<span class="token operator">=</span><span class="token string">&quot;G&quot;</span><span class="token operator">&gt;</span><span class="token constant">G</span><span class="token operator">&lt;</span><span class="token operator">/</span>li<span class="token operator">&gt;</span>
            <span class="token operator">&lt;</span>li key<span class="token operator">=</span><span class="token string">&quot;D&quot;</span><span class="token operator">&gt;</span><span class="token constant">D</span><span class="token operator">&lt;</span><span class="token operator">/</span>li<span class="token operator">&gt;</span>
        <span class="token operator">&lt;</span><span class="token operator">/</span>ul<span class="token operator">&gt;</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
    ReactDOM<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span>element<span class="token punctuation">,</span> root<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p><img src="https://gitee.com/yutao618/images/raw/master/images/20211215152507.png" alt=""></p> <p>这种是最复杂的情况，也是DOM DIFF的精华所在，先来梳理下上图的更新逻辑。</p> <p><img src="https://gitee.com/yutao618/images/raw/master/images/duo_ge_jie_dian_shu_liang_bu_tong_key_bu_tong_1_1637057627706.jpg" alt=""></p> <p>先来看下之前的reconcileChildrenArray的逻辑，按照上图的顺序梳理下。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">reconcileChildrenArray</span><span class="token punctuation">(</span><span class="token parameter">returnFiber<span class="token punctuation">,</span> currentFirstChild<span class="token punctuation">,</span> newChildren</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">//将要返回的第一个新fiber</span>
  <span class="token keyword">let</span> resultingFirstChild <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
  <span class="token comment">//上一个新fiber</span>
  <span class="token keyword">let</span> previousNewFiber <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
  <span class="token comment">//当前的老fiber</span>
  <span class="token keyword">let</span> oldFiber <span class="token operator">=</span> currentFirstChild<span class="token punctuation">;</span>
  <span class="token comment">//新的虚拟DOM的索引</span>
  <span class="token keyword">let</span> newIdx <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
  <span class="token comment">// 下一个老fiber</span>
  <span class="token keyword">let</span> nextOldFiber <span class="token operator">=</span> <span class="token keyword">null</span>
  <span class="token comment">//处理更新的情况 老fiber和新fiber都存在</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token punctuation">;</span> oldFiber <span class="token operator">&amp;&amp;</span> newIdx <span class="token operator">&lt;</span> newChildren<span class="token punctuation">.</span>length<span class="token punctuation">;</span> newIdx<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">//先缓存下一个老fiber</span>
    nextOldFiber <span class="token operator">=</span> oldFiber<span class="token punctuation">.</span>sibling<span class="token punctuation">;</span>
    <span class="token comment">//试图复用才fiber</span>
    <span class="token keyword">const</span> newFiber <span class="token operator">=</span> <span class="token function">updateSlot</span><span class="token punctuation">(</span>returnFiber<span class="token punctuation">,</span> oldFiber<span class="token punctuation">,</span> newChildren<span class="token punctuation">[</span>newIdx<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//如果key 不一样，直接跳出第一轮循环</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>newFiber<span class="token punctuation">)</span>
      <span class="token keyword">break</span><span class="token punctuation">;</span> <span class="token comment">//跳出第一轮循环</span>
    <span class="token comment">//老fiber存在，但是新的fiber并没有复用老fiber</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>oldFiber <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>newFiber<span class="token punctuation">.</span>alternate<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">deleteChild</span><span class="token punctuation">(</span>returnFiber<span class="token punctuation">,</span> oldFiber<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">//核心是给当前的newFiber添加一个副作用flags 叫新增</span>
    <span class="token function">placeChild</span><span class="token punctuation">(</span>newFiber<span class="token punctuation">,</span> newIdx<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>previousNewFiber<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      resultingFirstChild <span class="token operator">=</span> newFiber<span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      previousNewFiber<span class="token punctuation">.</span>sibling <span class="token operator">=</span> newFiber<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    previousNewFiber <span class="token operator">=</span> newFiber<span class="token punctuation">;</span>
    oldFiber <span class="token operator">=</span> nextOldFiber<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>newIdx <span class="token operator">===</span> newChildren<span class="token punctuation">.</span>length<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">deleteRemainingChildren</span><span class="token punctuation">(</span>returnFiber<span class="token punctuation">,</span> oldFiber<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> resultingFirstChild<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// 如果没有老fiber</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>oldFiber<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 循环虚拟DOM数组， 为每个虚拟DOM创建一个新的fiber</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token punctuation">;</span> newIdx <span class="token operator">&lt;</span> newChildren<span class="token punctuation">.</span>length<span class="token punctuation">;</span> newIdx<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> newFiber <span class="token operator">=</span> <span class="token function">createChild</span><span class="token punctuation">(</span>returnFiber<span class="token punctuation">,</span> newChildren<span class="token punctuation">[</span>newIdx<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//li(A) =&gt;li(B)=&gt; li(C)</span>
      <span class="token comment">// newFiber.flags = Placement</span>
      <span class="token function">placeChild</span><span class="token punctuation">(</span>newFiber<span class="token punctuation">,</span> newIdx<span class="token punctuation">)</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>previousNewFiber<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        resultingFirstChild <span class="token operator">=</span> newFiber<span class="token punctuation">;</span><span class="token comment">//resultingFirstChild=&gt;li(A)</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        previousNewFiber<span class="token punctuation">.</span>sibling <span class="token operator">=</span> newFiber<span class="token punctuation">;</span><span class="token comment">//liA.sibling=li(B) =&gt; liB.sibling=li(C)</span>
      <span class="token punctuation">}</span>
      previousNewFiber <span class="token operator">=</span> newFiber<span class="token punctuation">;</span><span class="token comment">//previousNewFiber=&gt;li(A)=&gt;li(B) =&gt; li(C)</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> resultingFirstChild<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>A和A做比较，可以复用；然后比较B和C,key不一样，updateSlot之后返回的null,跳出第一轮循环，newIdx为1，newChildren.length为6，而且oldFiber指向的是B,所以，下面2个判断是进不去的。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">if</span> <span class="token punctuation">(</span>newIdx <span class="token operator">===</span> newChildren<span class="token punctuation">.</span>length<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">deleteRemainingChildren</span><span class="token punctuation">(</span>returnFiber<span class="token punctuation">,</span> oldFiber<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> resultingFirstChild<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// 如果没有老fiber</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>oldFiber<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 循环虚拟DOM数组， 为每个虚拟DOM创建一个新的fiber</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token punctuation">;</span> newIdx <span class="token operator">&lt;</span> newChildren<span class="token punctuation">.</span>length<span class="token punctuation">;</span> newIdx<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> newFiber <span class="token operator">=</span> <span class="token function">createChild</span><span class="token punctuation">(</span>returnFiber<span class="token punctuation">,</span> newChildren<span class="token punctuation">[</span>newIdx<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//li(A) =&gt;li(B)=&gt; li(C)</span>
      <span class="token comment">// newFiber.flags = Placement</span>
      <span class="token function">placeChild</span><span class="token punctuation">(</span>newFiber<span class="token punctuation">,</span> newIdx<span class="token punctuation">)</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>previousNewFiber<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        resultingFirstChild <span class="token operator">=</span> newFiber<span class="token punctuation">;</span><span class="token comment">//resultingFirstChild=&gt;li(A)</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        previousNewFiber<span class="token punctuation">.</span>sibling <span class="token operator">=</span> newFiber<span class="token punctuation">;</span><span class="token comment">//liA.sibling=li(B) =&gt; liB.sibling=li(C)</span>
      <span class="token punctuation">}</span>
      previousNewFiber <span class="token operator">=</span> newFiber<span class="token punctuation">;</span><span class="token comment">//previousNewFiber=&gt;li(A)=&gt;li(B) =&gt; li(C)</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> resultingFirstChild<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
</code></pre></div><p>这个时候就按照上面的流程，把剩下的oldFiber放到existingChildren这个map中去，对应的代码如下：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 将剩下的老fiber放入map中</span>
<span class="token keyword">const</span> existingChildren <span class="token operator">=</span> <span class="token function">mapRemainingChildren</span><span class="token punctuation">(</span>returnFiber<span class="token punctuation">,</span> oldFiber<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">mapRemainingChildren</span><span class="token punctuation">(</span><span class="token parameter">returnFiber<span class="token punctuation">,</span> currentFirstChild</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> existingChildren <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Map</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">let</span> existingChild <span class="token operator">=</span> currentFirstChild<span class="token punctuation">;</span>
  <span class="token keyword">while</span> <span class="token punctuation">(</span>existingChild<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> key <span class="token operator">=</span> existingChild<span class="token punctuation">.</span>key <span class="token operator">||</span> existingChild<span class="token punctuation">.</span>index<span class="token punctuation">;</span>
    existingChildren<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> existingChild<span class="token punctuation">)</span>
    existingChild <span class="token operator">=</span> existingChild<span class="token punctuation">.</span>sibling<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> existingChildren<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>这个map目前大概张这样map={B:bFiber,C:cFiber,D:dFiber,E:eFiber,F:fFiber}，然后声明一个变量lastPlacedIndex变量，表示不需要移动的老节点的索引，默认为0，接着循环剩下的虚拟dom节点，从C开始。如果能在map中能找到相同key相同type的节点则可以复用老fiber,并把老fiber从map中删除。具体代码如下</p> <div class="language-diff extra-class"><pre class="language-diff"><code>function reconcileChildrenArray(returnFiber, currentFirstChild, newChildren) {
<span class="token unchanged">  //将要返回的第一个新fiber
  let resultingFirstChild = null;
  //上一个新fiber
  let previousNewFiber = null;
  //当前的老fiber
  let oldFiber = currentFirstChild;
  //新的虚拟DOM的索引
  let newIdx = 0;
  // 下一个老fiber
  let nextOldFiber = null
</span><span class="token inserted-sign inserted">+  // 指的上一个可以复用的，不需要移动的节点的老索引
+  let lastPlacedIndex = 0;
</span><span class="token unchanged">  //处理更新的情况 老fiber和新fiber都存在
  for (; oldFiber &amp;&amp; newIdx &lt; newChildren.length; newIdx++) {
    //先缓存下一个老fiber
    nextOldFiber = oldFiber.sibling;
    //试图复用才fiber
    const newFiber = updateSlot(returnFiber, oldFiber, newChildren[newIdx]);
    //如果key 不一样，直接跳出第一轮循环
    if (!newFiber)
      break; //跳出第一轮循环
    //老fiber存在，但是新的fiber并没有复用老fiber
    if (oldFiber &amp;&amp; !newFiber.alternate) {
      deleteChild(returnFiber, oldFiber);
    }
    //核心是给当前的newFiber添加一个副作用flags 叫新增
    placeChild(newFiber, newIdx);
    if (!previousNewFiber) {
      resultingFirstChild = newFiber;
    } else {
      previousNewFiber.sibling = newFiber;
    }
    previousNewFiber = newFiber;
    oldFiber = nextOldFiber;
  }
</span>
<span class="token unchanged">  if (newIdx === newChildren.length) {
    deleteRemainingChildren(returnFiber, oldFiber);
    return resultingFirstChild;
  }
</span>
<span class="token unchanged">  // 如果没有老fiber
  if (!oldFiber) {
    // 循环虚拟DOM数组， 为每个虚拟DOM创建一个新的fiber
    for (; newIdx &lt; newChildren.length; newIdx++) {
      const newFiber = createChild(returnFiber, newChildren[newIdx]);//li(A) =&gt;li(B)=&gt; li(C)
      // newFiber.flags = Placement
      placeChild(newFiber, newIdx)
      if (!previousNewFiber) {
        resultingFirstChild = newFiber;
      } else {
        previousNewFiber.sibling = newFiber;
      }
      previousNewFiber = newFiber;
    }
    return resultingFirstChild;
  }
</span>
<span class="token inserted-sign inserted">+  //将剩下的老fiber放入map中
+  const existingChildren = mapRemainingChildren(returnFiber, oldFiber);
+  for (; newIdx &lt; newChildren.length; newIdx++) {
+    //去map中找找有没key相同并且类型相同可以复用的老fiber 老真实DOM
+    const newFiber = updateFromMap(existingChildren, returnFiber, newIdx, newChildren[newIdx]);
+  }
</span>}
</code></pre></div><p>生成map</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">mapRemainingChildren</span><span class="token punctuation">(</span><span class="token parameter">returnFiber<span class="token punctuation">,</span> currentFirstChild</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> existingChildren <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Map</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">let</span> existingChild <span class="token operator">=</span> currentFirstChild<span class="token punctuation">;</span>
  <span class="token keyword">while</span> <span class="token punctuation">(</span>existingChild<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> key <span class="token operator">=</span> existingChild<span class="token punctuation">.</span>key <span class="token operator">||</span> existingChild<span class="token punctuation">.</span>index<span class="token punctuation">;</span>
    existingChildren<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> existingChild<span class="token punctuation">)</span>
    existingChild <span class="token operator">=</span> existingChild<span class="token punctuation">.</span>sibling<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> existingChildren<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>从map中去找到可以复用的fiber</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">updateFromMap</span><span class="token punctuation">(</span><span class="token parameter">existingChildren<span class="token punctuation">,</span> returnFiber<span class="token punctuation">,</span> newIdx<span class="token punctuation">,</span> newChild</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> matchedFiber <span class="token operator">=</span> existingChildren<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>newChild<span class="token punctuation">.</span>key <span class="token operator">||</span> newIdx<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token function">updateElement</span><span class="token punctuation">(</span>returnFiber<span class="token punctuation">,</span> matchedFiber<span class="token punctuation">,</span> newChild<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>接着就看下是否能在map中找到可以复用的，把老fiber从map中删除，找不到的话则创建新的fiber节点。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token punctuation">;</span> newIdx <span class="token operator">&lt;</span> newChildren<span class="token punctuation">.</span>length<span class="token punctuation">;</span> newIdx<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">//去map中找找有没key相同并且类型相同可以复用的老fiber 老真实DOM</span>
  <span class="token keyword">const</span> newFiber <span class="token operator">=</span> <span class="token function">updateFromMap</span><span class="token punctuation">(</span>existingChildren<span class="token punctuation">,</span> returnFiber<span class="token punctuation">,</span> newIdx<span class="token punctuation">,</span> newChildren<span class="token punctuation">[</span>newIdx<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>newFiber<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">//说明是复用的老fiber</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>newFiber<span class="token punctuation">.</span>alternate<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      existingChildren<span class="token punctuation">.</span><span class="token function">delete</span><span class="token punctuation">(</span>newFiber<span class="token punctuation">.</span>key <span class="token operator">||</span> newIdx<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    lastPlacedIndex <span class="token operator">=</span> <span class="token function">placeChild</span><span class="token punctuation">(</span>newFiber<span class="token punctuation">,</span> lastPlacedIndex<span class="token punctuation">,</span> newIdx<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>previousNewFiber<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      resultingFirstChild <span class="token operator">=</span> newFiber<span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      previousNewFiber<span class="token punctuation">.</span>sibling <span class="token operator">=</span> newFiber<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    previousNewFiber <span class="token operator">=</span> newFiber<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>lastPlacedIndex = placeChild(newFiber, lastPlacedIndex, newIdx);这个是比较关键的，newFiber.alternate有值，说明是可以复用的老fiber,需要放置该fiber节点，改造下placeChild方法，之前的代码是这样的：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">placeChild</span><span class="token punctuation">(</span><span class="token parameter">newFiber<span class="token punctuation">,</span> newIdx</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  newFiber<span class="token punctuation">.</span>index <span class="token operator">=</span> newIdx<span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>shouldTrackSideEffects<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">const</span> current <span class="token operator">=</span> newFiber<span class="token punctuation">.</span>alternate<span class="token punctuation">;</span>
  <span class="token comment">//如果有current说是更新，复用老节点的更新，不会添加Placement</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>current<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// TODO</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    newFiber<span class="token punctuation">.</span>flags <span class="token operator">=</span> Placement<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>改造后的逻辑如下：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">placeChild</span><span class="token punctuation">(</span><span class="token parameter">newFiber<span class="token punctuation">,</span> lastPlacedIndex<span class="token punctuation">,</span> newIdx</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  newFiber<span class="token punctuation">.</span>index <span class="token operator">=</span> newIdx<span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>shouldTrackSideEffects<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> lastPlacedIndex<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">const</span> current <span class="token operator">=</span> newFiber<span class="token punctuation">.</span>alternate<span class="token punctuation">;</span>
  <span class="token comment">//如果有current说是更新，复用老节点的更新，不会添加Placement</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>current<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> oldIndex <span class="token operator">=</span> current<span class="token punctuation">.</span>index<span class="token punctuation">;</span>
    <span class="token comment">//如果老fiber它对应的真实DOM挂载的索引比lastPlacedIndex小</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>oldIndex <span class="token operator">&lt;</span> lastPlacedIndex<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">//老fiber对应的真实DOM就需要移动了</span>
      newFiber<span class="token punctuation">.</span>flags <span class="token operator">|=</span> Placement<span class="token punctuation">;</span>
      <span class="token keyword">return</span> lastPlacedIndex<span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      <span class="token comment">//否则 不需要移动 并且把老fiber它的原来的挂载索引返回成为新的lastPlacedIndex</span>
      <span class="token keyword">return</span> oldIndex<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    newFiber<span class="token punctuation">.</span>flags <span class="token operator">=</span> Placement<span class="token punctuation">;</span>
    <span class="token keyword">return</span> lastPlacedIndex<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>之前placeChild用到的地方也做出相应的修改；在复用老的fiber的时候，要老fiber节点的索引与lastPlacedIndex做比较：</p> <ul><li>如果小于lastPlacedIndex则需要移动老的fiber, lastPlacedIndex不变</li> <li>如果大于lastPlacedIndex则不需要移动老的fiber，更新lastPlacedIndex为老fiber的index</li></ul> <p>C在map中能找到，C的索引是2，lastPlacedIndex默认是0，则C是不用移动的，更新lastPlacedIndex为2；同理E也是能在map中找到，也不用移动，E的老索引是4，则更新lastPlacedIndex为4；到B的时候，B的老fiber索引为1，此时lastPlacedIndex为4，那就标记B为移动，lastPlacedIndex不变；到G的时候，在map中找不到可以复用的节点，那就标记为插入；到D的时候，D的老fiber索引为3，lastPlacedIndex为4，标记D为移动，lastPlacedIndex不变,仍然为4。</p> <p>到这里，新fiber遍历结束了，但是老fiber中的F是没用到的，那就需要把F给删除。那就是在虚拟DOM循环结束后把Map中的所有的剩下的fiber全部标记为删除。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">//map中剩下是没有被 复用的，全部删除</span>
existingChildren<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">child</span> <span class="token operator">=&gt;</span> <span class="token function">deleteChild</span><span class="token punctuation">(</span>returnFiber<span class="token punctuation">,</span> child<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>完整的代码如下：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">reconcileChildrenArray</span><span class="token punctuation">(</span><span class="token parameter">returnFiber<span class="token punctuation">,</span> currentFirstChild<span class="token punctuation">,</span> newChildren</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">//将要返回的第一个新fiber</span>
  <span class="token keyword">let</span> resultingFirstChild <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
  <span class="token comment">//上一个新fiber</span>
  <span class="token keyword">let</span> previousNewFiber <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
  <span class="token comment">//当前的老fiber</span>
  <span class="token keyword">let</span> oldFiber <span class="token operator">=</span> currentFirstChild<span class="token punctuation">;</span>
  <span class="token comment">//新的虚拟DOM的索引</span>
  <span class="token keyword">let</span> newIdx <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
  <span class="token comment">// 下一个老fiber</span>
  <span class="token keyword">let</span> nextOldFiber <span class="token operator">=</span> <span class="token keyword">null</span>
  <span class="token comment">// 指的上一个可以复用的，不需要移动的节点的老索引</span>
  <span class="token keyword">let</span> lastPlacedIndex <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
  <span class="token comment">//处理更新的情况 老fiber和新fiber都存在</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token punctuation">;</span> oldFiber <span class="token operator">&amp;&amp;</span> newIdx <span class="token operator">&lt;</span> newChildren<span class="token punctuation">.</span>length<span class="token punctuation">;</span> newIdx<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">//先缓存下一个老fiber</span>
    nextOldFiber <span class="token operator">=</span> oldFiber<span class="token punctuation">.</span>sibling<span class="token punctuation">;</span>
    <span class="token comment">//试图复用才fiber</span>
    <span class="token keyword">const</span> newFiber <span class="token operator">=</span> <span class="token function">updateSlot</span><span class="token punctuation">(</span>returnFiber<span class="token punctuation">,</span> oldFiber<span class="token punctuation">,</span> newChildren<span class="token punctuation">[</span>newIdx<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//如果key 不一样，直接跳出第一轮循环</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>newFiber<span class="token punctuation">)</span>
      <span class="token keyword">break</span><span class="token punctuation">;</span> <span class="token comment">//跳出第一轮循环</span>
    <span class="token comment">//老fiber存在，但是新的fiber并没有复用老fiber</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>oldFiber <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>newFiber<span class="token punctuation">.</span>alternate<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">deleteChild</span><span class="token punctuation">(</span>returnFiber<span class="token punctuation">,</span> oldFiber<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">//核心是给当前的newFiber添加一个副作用flags 叫新增</span>
    lastPlacedIndex <span class="token operator">=</span> <span class="token function">placeChild</span><span class="token punctuation">(</span>newFiber<span class="token punctuation">,</span> lastPlacedIndex<span class="token punctuation">,</span> newIdx<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>previousNewFiber<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      resultingFirstChild <span class="token operator">=</span> newFiber<span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      previousNewFiber<span class="token punctuation">.</span>sibling <span class="token operator">=</span> newFiber<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    previousNewFiber <span class="token operator">=</span> newFiber<span class="token punctuation">;</span>
    oldFiber <span class="token operator">=</span> nextOldFiber<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>newIdx <span class="token operator">===</span> newChildren<span class="token punctuation">.</span>length<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">deleteRemainingChildren</span><span class="token punctuation">(</span>returnFiber<span class="token punctuation">,</span> oldFiber<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> resultingFirstChild<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// 如果没有老fiber</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>oldFiber<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 循环虚拟DOM数组， 为每个虚拟DOM创建一个新的fiber</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token punctuation">;</span> newIdx <span class="token operator">&lt;</span> newChildren<span class="token punctuation">.</span>length<span class="token punctuation">;</span> newIdx<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> newFiber <span class="token operator">=</span> <span class="token function">createChild</span><span class="token punctuation">(</span>returnFiber<span class="token punctuation">,</span> newChildren<span class="token punctuation">[</span>newIdx<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//li(A) =&gt;li(B)=&gt; li(C)</span>
      <span class="token comment">// newFiber.flags = Placement</span>
      lastPlacedIndex <span class="token operator">=</span> <span class="token function">placeChild</span><span class="token punctuation">(</span>newFiber<span class="token punctuation">,</span> lastPlacedIndex<span class="token punctuation">,</span> newIdx<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>previousNewFiber<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        resultingFirstChild <span class="token operator">=</span> newFiber<span class="token punctuation">;</span><span class="token comment">//resultingFirstChild=&gt;li(A)</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        previousNewFiber<span class="token punctuation">.</span>sibling <span class="token operator">=</span> newFiber<span class="token punctuation">;</span><span class="token comment">//liA.sibling=li(B) =&gt; liB.sibling=li(C)</span>
      <span class="token punctuation">}</span>
      previousNewFiber <span class="token operator">=</span> newFiber<span class="token punctuation">;</span><span class="token comment">//previousNewFiber=&gt;li(A)=&gt;li(B) =&gt; li(C)</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> resultingFirstChild<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">//将剩下的老fiber放入map中</span>
  <span class="token keyword">const</span> existingChildren <span class="token operator">=</span> <span class="token function">mapRemainingChildren</span><span class="token punctuation">(</span>returnFiber<span class="token punctuation">,</span> oldFiber<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token punctuation">;</span> newIdx <span class="token operator">&lt;</span> newChildren<span class="token punctuation">.</span>length<span class="token punctuation">;</span> newIdx<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">//去map中找找有没key相同并且类型相同可以复用的老fiber 老真实DOM</span>
    <span class="token keyword">const</span> newFiber <span class="token operator">=</span> <span class="token function">updateFromMap</span><span class="token punctuation">(</span>existingChildren<span class="token punctuation">,</span> returnFiber<span class="token punctuation">,</span> newIdx<span class="token punctuation">,</span> newChildren<span class="token punctuation">[</span>newIdx<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>newFiber<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">//说明是复用的老fiber</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>newFiber<span class="token punctuation">.</span>alternate<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        existingChildren<span class="token punctuation">.</span><span class="token function">delete</span><span class="token punctuation">(</span>newFiber<span class="token punctuation">.</span>key <span class="token operator">||</span> newIdx<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      lastPlacedIndex <span class="token operator">=</span> <span class="token function">placeChild</span><span class="token punctuation">(</span>newFiber<span class="token punctuation">,</span> lastPlacedIndex<span class="token punctuation">,</span> newIdx<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>previousNewFiber<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        resultingFirstChild <span class="token operator">=</span> newFiber<span class="token punctuation">;</span><span class="token comment">//resultingFirstChild=&gt;li(A)</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        previousNewFiber<span class="token punctuation">.</span>sibling <span class="token operator">=</span> newFiber<span class="token punctuation">;</span><span class="token comment">//liB.sibling=li(C)</span>
      <span class="token punctuation">}</span>
      previousNewFiber <span class="token operator">=</span> newFiber<span class="token punctuation">;</span><span class="token comment">//previousNewFiber=&gt;li(C)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token comment">//map中剩下是没有被 复用的，全部删除</span>
  existingChildren<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">child</span> <span class="token operator">=&gt;</span> <span class="token function">deleteChild</span><span class="token punctuation">(</span>returnFiber<span class="token punctuation">,</span> child<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">return</span> resultingFirstChild<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>reconcileChildrenArray这个方法是DOM DIFF的核心所在，看下运行结果：</p> <p><img src="https://gitee.com/yutao618/images/raw/master/images/20211215184014.png" alt=""></p> <ul><li><a href="https://gitee.com/yutao618/react-dom-diff" target="_blank" rel="noopener noreferrer">git地址<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li></ul> <p>到此，DOM DIFF基本结束，其实fiber中有一个调度的过程，根据渲染更新优先级，根据浏览器的响应速度来调度fiber,后面会从这个角度再来看下fiber。</p></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/note/web/react/2.html" class="prev">
        react单节点diff
      </a></span> <span class="next"><a href="/note/web/webpack/">
        目录
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/note/assets/js/app.02190172.js" defer></script><script src="/note/assets/js/2.2dccd611.js" defer></script><script src="/note/assets/js/28.3bb3b4b8.js" defer></script>
  </body>
</html>
